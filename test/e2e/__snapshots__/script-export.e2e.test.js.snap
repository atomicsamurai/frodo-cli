// Jest Snapshot v1, https://goo.gl/fbAQLP

exports[`frodo script export "frodo script export --all": should export all scripts to a single file 1`] = `""`;

exports[`frodo script export "frodo script export --all": should export all scripts to a single file: ./allAlphaScripts.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "01e1a3c0-038b-4c16-956a-6c9d89328cff": {
      "_id": "01e1a3c0-038b-4c16-956a-6c9d89328cff",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Default global script for a scripted decision node",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Authentication Tree Decision Node Script",
      "script": [
        "/*",
        "  - Data made available by nodes that have already executed are available in the sharedState variable.",
        "  - The script should set outcome to either "true" or "false".",
        " */",
        "",
        "outcome = "true";",
      ],
    },
    "021e434f-89b6-45fb-9d67-5147bc1650c3": {
      "_id": "021e434f-89b6-45fb-9d67-5147bc1650c3",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Show Password Policy",
      "script": [
        "var output = true;",
        "var anchor = "anchor-".concat(generateNumericToken('xxx'));",
        "var halign = "left";",
        "var message = "<ul><li>Must be at least 8 characters long</li>".concat(",
        "    "<li>Must be less than 64 characters long</li>").concat(",
        "    "<li>Must not share characters with email, username, first name, last name</li>").concat(",
        "    "<li>Must have at least 1 lowercase letter(s)</li>").concat(",
        "    "<li>Must have at least 1 capital letter(s)</li>").concat(",
        "    "<li>Must have at least 1 number(s)</li>").concat(",
        "    "<li>Must have at least 1 symbol(s)</li></ul>")",
        "var script = "Array.prototype.slice.call(\\n".concat(",
        "  "document.getElementsByClassName('callback-component')).forEach(\\n").concat(",
        "  "function (e) {\\n").concat(",
        "  "  var message = e.firstElementChild;\\n").concat(",
        "  "  if (message.firstChild && message.firstChild.nodeName == '#text' && message.firstChild.nodeValue.trim() == '").concat(anchor).concat("') {\\n").concat(",
        "  "    message.className = \\"text-left\\";\\n").concat(",
        "  "    message.align = \\"").concat(halign).concat("\\";\\n").concat(",
        "  "    message.innerHTML = '").concat(message).concat("';\\n").concat(",
        "  "  }\\n").concat(",
        "  "})")",
        "var fr = JavaImporter(",
        "    org.forgerock.openam.auth.node.api.Action,",
        "    javax.security.auth.callback.TextOutputCallback,",
        "    com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        ")",
        "if (message.length && callbacks.isEmpty()) {",
        "    action = fr.Action.send(",
        "        new fr.TextOutputCallback(",
        "            fr.TextOutputCallback.INFORMATION,",
        "            anchor",
        "        ),",
        "        new fr.ScriptTextOutputCallback(script)",
        "    ).build()",
        "}",
        "else {",
        "  action = fr.Action.goTo("true").build();",
        "}",
        "",
        " /*",
        "  * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "  * ",
        "  * Example:",
        "  * 'xxxxx' produces '28535'",
        "  * 'xxx-xxx' produces '432-521'",
        "  */",
        "function generateNumericToken(format) {",
        "    return format.replace(/[x]/g, function(c) {",
        "        var r = Math.random()*10|0;",
        "        var v = r;",
        "        return v.toString(10);",
        "    });",
        "}",
      ],
    },
    "073a64d4-37c9-486d-8c59-6583494644b9": {
      "_id": "073a64d4-37c9-486d-8c59-6583494644b9",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "FRAAS-7955 Transient State Only",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "FRAAS-7955 Transient State Only",
      "script": [
        "outcome = "true";",
        "",
        "setTransientObjectAttribute("userName", "FRAAS-7955");",
        "setTransientObjectAttribute("givenName", "First-transient");",
        "setTransientObjectAttribute("sn", "Last-transient");",
        "setTransientObjectAttribute("mail", "first.last-transient@company.com");",
        "",
        "/*",
        " * Store attributes in transient state for use with the Create/Patch Object nodes.",
        " */",
        "function setTransientObjectAttribute(name, value) {",
        "    var transientStorage = transientState.get("objectAttributes");",
        "    if (transientStorage && value) {",
        "          if (transientStorage.put) {",
        "            transientStorage.put(name, value);",
        "        }",
        "          else {",
        "            transientStorage[name] = value;",
        "        }",
        "    }",
        "    else if (value) {",
        "    transientState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "    }",
        "}",
      ],
    },
    "0ab1dd57-eafd-4063-8e60-65bfac8108b7": {
      "_id": "0ab1dd57-eafd-4063-8e60-65bfac8108b7",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Check existing session and set username",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Check Existing Session",
      "script": [
        "if (typeof existingSession !== 'undefined')",
        "{",
        "  outcome = "hasSession";",
        "  sharedState.put("username", existingSession.get("UserId"));",
        "  sharedState.put("_id", existingSession.get("UserId"));",
        "  if (sharedState.get("objectAttributes")) {",
        "    sharedState.get("objectAttributes").put("userName", existingSession.get("UserId"));",
        "  }",
        "  else {",
        "    sharedState.put("objectAttributes", {userName: existingSession.get("UserId")});",
        "  }",
        "}",
        "else",
        "{",
        "  outcome = "noSession";",
        "}",
      ],
    },
    "0d471aff-81f3-41ce-8bf9-35c27cdc0a26": {
      "_id": "0d471aff-81f3-41ce-8bf9-35c27cdc0a26",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_CanBeInvited",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "(function() {",
        "  var fr = new JavaImporter(",
        "    org.forgerock.openam.auth.nodes,",
        "    org.forgerock.guice.core",
        "  );",
        "",
        "  with (fr) {",
        "    try {",
        "",
        "      outcome = 'False';",
        "",
        "      var realm = sharedState.get('realm');",
        "      var uuid = sharedState.get('username');",
        "      var identityProvider = InjectorHolder.getInstance(IdentityProvider);",
        "      var identity = identityProvider.getIdentity(uuid, realm);",
        "      var attrs = identity.getAttributes();",
        "",
        "      if (!attrs.containsKey('fr-idm-inviteDate')) {",
        "        logger.message('Admin cannot be invited: no invite date');",
        "        return;",
        "      }",
        "",
        "      if (attrs.containsKey('fr-idm-onboardDate')) {",
        "        logger.message('Admin cannot be invited: already onboarded');",
        "        return;",
        "      }",
        "",
        "      var email = attrs.get('mail').iterator().next();",
        "      var objAttrs = {",
        "        mail: email,",
        "        userName: email,",
        "      };",
        "      sharedState.put('objectAttributes', objAttrs);",
        "",
        "      logger.message('Admin can be invited');",
        "      outcome = 'True';",
        "",
        "    } catch (e) {",
        "",
        "      logger.error('Failed to determine if admin can be invited: {}', e);",
        "",
        "    }",
        "  }",
        "}());",
      ],
    },
    "123725a9-2119-4efd-a6b0-456f3ccd34b7": {
      "_id": "123725a9-2119-4efd-a6b0-456f3ccd34b7",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "deviceprofile_to_attribute",
      "script": [
        "var objectAttributes = sharedState.get("objectAttributes");",
        "var deviceHash = sharedState.get("deviceHash");",
        "",
        "sharedState.put("frIndexedString1" , deviceHash );",
        "",
        "",
        "",
        "if(objectAttributes === null || objectAttributes === undefined)",
        "{",
        "",
        "",
        " objectAttributes = {",
        "                        "userName" : "anon-".concat(deviceHash),",
        "                     "givenName" : " ",",
        "                     "sn" : " ",",
        "                     "mail" : "anon-".concat(deviceHash).concat("@mytestrun.com"),",
        "                     "frIndexedString1" : deviceHash",
        "                    }",
        "}",
        "else",
        "{",
        "",
        "    objectAttributes.put("userName",  "anon-".concat(deviceHash));",
        "    objectAttributes.put("givenName", " ");",
        "    objectAttributes.put("sn", " ");",
        "    objectAttributes.put("mail", "anon-".concat(deviceHash).concat("@mytestrun.com"));",
        "    objectAttributes.put("frIndexedString1", deviceHash);",
        "   ",
        "}",
        "",
        "",
        "sharedState.put("objectAttributes",objectAttributes);",
        "    ",
        "outcome = "true";",
      ],
    },
    "1244e639-4a31-401d-ab61-d75133d8dc9e": {
      "_id": "1244e639-4a31-401d-ab61-d75133d8dc9e",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from Instagram",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Instagram Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "return json(object(",
        "        field("id", rawProfile.id),",
        "        field("username", rawProfile.username)))",
      ],
    },
    "13b6a418-4ccc-41b6-86ce-0a13f352da22": {
      "_id": "13b6a418-4ccc-41b6-86ce-0a13f352da22",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_HasOnboarded",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "(function() {",
        "  var fr = new JavaImporter(",
        "    org.forgerock.openam.auth.nodes,",
        "    org.forgerock.guice.core",
        "  );",
        "",
        "  with (fr) {",
        "    try {",
        "",
        "      outcome = 'False';",
        "",
        "      var realm = sharedState.get('realm');",
        "      var uuid = sharedState.get('_id');",
        "      var identityProvider = InjectorHolder.getInstance(IdentityProvider);",
        "      var identity = identityProvider.getIdentity(uuid, realm);",
        "      var attrs = identity.getAttributes();",
        "",
        "      if (attrs.containsKey('fr-idm-onboardDate')) {",
        "        logger.message('Admin has onboard date');",
        "        outcome = 'True';",
        "      }",
        "",
        "    } catch (e) {",
        "",
        "      logger.error('Failed to determine if admin has onboarded: {}', e);",
        "      outcome = 'Error';",
        "",
        "    }",
        "  }",
        "}());",
      ],
    },
    "13cd3c60-a04b-4455-b028-fbfd01ed88b1": {
      "_id": "13cd3c60-a04b-4455-b028-fbfd01ed88b1",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Azure AD pass through authentication using Resource Owner Password Credential flow",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "AAD Passthru ROPC",
      "script": [
        "/* AAD Passthru ROPC",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Azure AD pass through authentication using Resource Owner Password Credential flow",
        " * ",
        " * This script needs to be parametrized. It will not work properly as is. ",
        " * It requires the Platform Username and Platform Password collector nodes",
        " * before it can operate.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - Valid",
        " * - Invalid",
        " * - Expired",
        " * - Disabled",
        " * - Error",
        " */",
        "logger.message("AAD Passthru ROPC: start");",
        "",
        "if (sharedState.get("username") && transientState.get("password")) {",
        "      /*",
        "     * BEGIN SCRIPT CONFIGURATION",
        "     *",
        "     * REPLACE WITH YOUR OWN AZURE AD SETTINGS",
        "     *",
        "     * AAD_TENANT_ID is your tenant ID: https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/active-directory-how-to-find-tenant",
        "     * AAD_CLIENT_ID is your registered app ID: https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-register-app",
        "     */",
        "    var AAD_TENANT_ID = "711ffa9c-5972-4713-ace3-688c9732614a";",
        "    var AAD_CLIENT_ID = "51f130ec-d29d-4419-a492-0011d09c1a16";",
        "    /*",
        "     * END SCRIPT CONFIGURATION",
        "     */",
        "      ",
        "    // Azure AD ROPC Configuration",
        "    var AAD_SCOPE = "profile";",
        "      var AAD_RESOURCE = "https://graph.microsoft.com/"",
        "    var AAD_OAUTH2_TOKEN_URI = "https://login.windows.net/".concat(AAD_TENANT_ID).concat("/oauth2/token");",
        "",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setMethod('POST');",
        "    request.setUri(AAD_OAUTH2_TOKEN_URI);",
        "    request.getHeaders().add("Content-Type", "application/x-www-form-urlencoded");",
        "    var params = request.getForm();",
        "    params.add("resource", AAD_RESOURCE);",
        "    params.add("client_id", AAD_CLIENT_ID);",
        "    params.add("grant_type", "password");",
        "    params.add("scope", AAD_SCOPE);",
        "    params.add("username", sharedState.get("username"));",
        "    params.add("password", transientState.get("password"));",
        "    request.getEntity().setString(params.toString());",
        "",
        "    var response = httpClient.send(request).get();",
        "    var result = JSON.parse(response.getEntity().getString());",
        "    //logger.message("AAD Passthru ROPC: JSON result: " + JSON.stringify(result));",
        "",
        "      if (response.getStatus().getCode() === 200) {",
        "          outcome = "Valid"",
        "        transientState.put("aadAccessToken", result.access_token);",
        "    } else {",
        "        /* Outcomes:",
        "         * - Valid",
        "         * - Invalid",
        "         * - Expired",
        "         * - Disabled",
        "         * - Error",
        "         *",
        "         * Expected Error Codes:",
        "         * 50126 - Error validating credentials due to invalid username or password.",
        "         * 50055 - The password is expired.",
        "         * 50057 - The user account is disabled.",
        "         * 50196 - The server terminated an operation because it encountered a client request loop. Please contact your app vendor.",
        "         */",
        "        if (result.error_codes.includes(50126)) {",
        "            outcome = "Invalid";",
        "        } else if (result.error_codes.includes(50055)) {",
        "            outcome = "Expired";",
        "        } else if (result.error_codes.includes(50057)) {",
        "            outcome = "Disabled";",
        "        } else {",
        "            outcome = "Error";",
        "        }",
        "        logger.message("AAD Passthru ROPC: error = ".concat(result.error));",
        "        logger.message("AAD Passthru ROPC: error_description = ".concat(result.error_description));",
        "        logger.message("AAD Passthru ROPC: error_codes = ".concat(result.error_codes));",
        "    }",
        "} else {",
        "      outcome = "Error";",
        "      logger.message("AAD Passthru ROPC: No user or password found in shared state! Use username and password collector nodes before this script to populate shared and transient states!'");",
        "}",
        "logger.message("AAD Passthru ROPC: End (outcome=".concat(outcome).concat(")"));",
      ],
    },
    "14f14ad3-f35f-455b-a7ba-d7cd939c6921": {
      "_id": "14f14ad3-f35f-455b-a7ba-d7cd939c6921",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Dropdown selector",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Choice inner1, inner2",
      "script": [
        "/* Choice inner1, inner2",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Render a dropdown selector",
        " * ",
        " * This script must be parametrized. It will not work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "(function () {",
        "  outcome = "true";",
        "  var choices = ["inner1", "inner2"];",
        "  ",
        "  var fr = JavaImporter(",
        "    org.forgerock.openam.auth.node.api.Action,",
        "    javax.security.auth.callback.ChoiceCallback",
        "  )",
        "",
        "  if (callbacks.isEmpty()) {",
        "    action = fr.Action.send([",
        "      new fr.ChoiceCallback("Select a journey", choices, 0, false)",
        "    ]).build();",
        "  } else {",
        "    var choice = parseInt(callbacks.get(0).getSelectedIndexes()[0]);",
        "    nodeState.putShared("nodeConfig", {tree: choices[choice]});",
        "    action = fr.Action.goTo(outcome).build();",
        "  }",
        "}());",
      ],
    },
    "157298c0-7d31-4059-a95b-eeb08473b7e5": {
      "_id": "157298c0-7d31-4059-a95b-eeb08473b7e5",
      "context": "AUTHENTICATION_CLIENT_SIDE",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Default global script for client side Device Id (Match) Authentication Module",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Device Id (Match) - Client Side",
      "script": [
        "var fontDetector = (function () {",
        "    /**",
        "     * JavaScript code to detect available availability of a",
        "     * particular font in a browser using JavaScript and CSS.",
        "     *",
        "     * Author : Lalit Patel",
        "     * Website: http://www.lalit.org/lab/javascript-css-font-detect/",
        "     * License: Apache Software License 2.0",
        "     *          http://www.apache.org/licenses/LICENSE-2.0",
        "     * Version: 0.15 (21 Sep 2009)",
        "     *          Changed comparision font to default from sans-default-default,",
        "     *          as in FF3.0 font of child element didn't fallback",
        "     *          to parent element if the font is missing.",
        "     * Version: 0.2 (04 Mar 2012)",
        "     *          Comparing font against all the 3 generic font families ie,",
        "     *          'monospace', 'sans-serif' and 'sans'. If it doesn't match all 3",
        "     *          then that font is 100% not available in the system",
        "     * Version: 0.3 (24 Mar 2012)",
        "     *          Replaced sans with serif in the list of baseFonts",
        "     */",
        "    /*",
        "     * Portions Copyrighted 2013 ForgeRock AS.",
        "     */",
        "    var detector = {}, baseFonts, testString, testSize, h, s, defaultWidth = {}, defaultHeight = {}, index;",
        "",
        "    // a font will be compared against all the three default fonts.",
        "    // and if it doesn't match all 3 then that font is not available.",
        "    baseFonts = ['monospace', 'sans-serif', 'serif'];",
        "",
        "    //we use m or w because these two characters take up the maximum width.",
        "    // And we use a LLi so that the same matching fonts can get separated",
        "    testString = "mmmmmmmmmmlli";",
        "",
        "    //we test using 72px font size, we may use any size. I guess larger the better.",
        "    testSize = '72px';",
        "",
        "    h = document.getElementsByTagName("body")[0];",
        "",
        "    // create a SPAN in the document to get the width of the text we use to test",
        "    s = document.createElement("span");",
        "    s.style.fontSize = testSize;",
        "    s.innerHTML = testString;",
        "    for (index in baseFonts) {",
        "        //get the default width for the three base fonts",
        "        s.style.fontFamily = baseFonts[index];",
        "        h.appendChild(s);",
        "        defaultWidth[baseFonts[index]] = s.offsetWidth; //width for the default font",
        "        defaultHeight[baseFonts[index]] = s.offsetHeight; //height for the defualt font",
        "        h.removeChild(s);",
        "    }",
        "",
        "    detector.detect = function(font) {",
        "        var detected = false, index, matched;",
        "        for (index in baseFonts) {",
        "            s.style.fontFamily = font + ',' + baseFonts[index]; // name of the font along with the base font for fallback.",
        "            h.appendChild(s);",
        "            matched = (s.offsetWidth !== defaultWidth[baseFonts[index]] || s.offsetHeight !== defaultHeight[baseFonts[index]]);",
        "            h.removeChild(s);",
        "            detected = detected || matched;",
        "        }",
        "        return detected;",
        "    };",
        "",
        "    return detector;",
        "}());",
        "/*",
        " * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS HEADER.",
        " *",
        " * Copyright (c) 2009 Sun Microsystems Inc. All Rights Reserved",
        " *",
        " * The contents of this file are subject to the terms",
        " * of the Common Development and Distribution License",
        " * (the License). You may not use this file except in",
        " * compliance with the License.",
        " *",
        " * You can obtain a copy of the License at",
        " * https://opensso.dev.java.net/public/CDDLv1.0.html or",
        " * opensso/legal/CDDLv1.0.txt",
        " * See the License for the specific language governing",
        " * permission and limitations under the License.",
        " *",
        " * When distributing Covered Code, include this CDDL",
        " * Header Notice in each file and include the License file",
        " * at opensso/legal/CDDLv1.0.txt.",
        " * If applicable, add the following below the CDDL Header,",
        " * with the fields enclosed by brackets [] replaced by",
        " * your own identifying information:",
        " * "Portions Copyrighted [year] [name of copyright owner]"",
        " *",
        " */",
        "/*",
        " * Portions Copyrighted 2013 Syntegrity.",
        " * Portions Copyrighted 2013-2014 ForgeRock AS.",
        " */",
        "",
        "var collectScreenInfo = function () {",
        "        var screenInfo = {};",
        "        if (screen) {",
        "            if (screen.width) {",
        "                screenInfo.screenWidth = screen.width;",
        "            }",
        "",
        "            if (screen.height) {",
        "                screenInfo.screenHeight = screen.height;",
        "            }",
        "",
        "            if (screen.pixelDepth) {",
        "                screenInfo.screenColourDepth = screen.pixelDepth;",
        "            }",
        "        } else {",
        "            console.warn("Cannot collect screen information. screen is not defined.");",
        "        }",
        "        return screenInfo;",
        "    },",
        "    collectTimezoneInfo = function () {",
        "        var timezoneInfo =  {}, offset = new Date().getTimezoneOffset();",
        "",
        "        if (offset) {",
        "            timezoneInfo.timezone = offset;",
        "        } else {",
        "            console.warn("Cannot collect timezone information. timezone is not defined.");",
        "        }",
        "",
        "        return timezoneInfo;",
        "    },",
        "    collectBrowserPluginsInfo = function () {",
        "",
        "        if (navigator && navigator.plugins) {",
        "            var pluginsInfo = {}, i, plugins = navigator.plugins;",
        "            pluginsInfo.installedPlugins = "";",
        "",
        "            for (i = 0; i < plugins.length; i++) {",
        "                pluginsInfo.installedPlugins = pluginsInfo.installedPlugins + plugins[i].filename + ";";",
        "            }",
        "",
        "            return pluginsInfo;",
        "        } else {",
        "            console.warn("Cannot collect browser plugin information. navigator.plugins is not defined.");",
        "            return {};",
        "        }",
        "",
        "    },",
        "// Getting geolocation takes some time and is done asynchronously, hence need a callback which is called once geolocation is retrieved.",
        "    collectGeolocationInfo = function (callback) {",
        "        var geolocationInfo = {},",
        "            successCallback = function(position) {",
        "                geolocationInfo.longitude = position.coords.longitude;",
        "                geolocationInfo.latitude = position.coords.latitude;",
        "                callback(geolocationInfo);",
        "            }, errorCallback = function(error) {",
        "                console.warn("Cannot collect geolocation information. " + error.code + ": " + error.message);",
        "                callback(geolocationInfo);",
        "            };",
        "        if (navigator && navigator.geolocation) {",
        "            // NB: If user chooses 'Not now' on Firefox neither callback gets called",
        "            //     https://bugzilla.mozilla.org/show_bug.cgi?id=675533",
        "            navigator.geolocation.getCurrentPosition(successCallback, errorCallback);",
        "        } else {",
        "            console.warn("Cannot collect geolocation information. navigator.geolocation is not defined.");",
        "            callback(geolocationInfo);",
        "        }",
        "    },",
        "    collectBrowserFontsInfo = function () {",
        "        var fontsInfo = {}, i, fontsList = ["cursive","monospace","serif","sans-serif","fantasy","default","Arial","Arial Black",",
        "            "Arial Narrow","Arial Rounded MT Bold","Bookman Old Style","Bradley Hand ITC","Century","Century Gothic",",
        "            "Comic Sans MS","Courier","Courier New","Georgia","Gentium","Impact","King","Lucida Console","Lalit",",
        "            "Modena","Monotype Corsiva","Papyrus","Tahoma","TeX","Times","Times New Roman","Trebuchet MS","Verdana",",
        "            "Verona"];",
        "        fontsInfo.installedFonts = "";",
        "",
        "        for (i = 0; i < fontsList.length; i++) {",
        "            if (fontDetector.detect(fontsList[i])) {",
        "                fontsInfo.installedFonts = fontsInfo.installedFonts + fontsList[i] + ";";",
        "            }",
        "        }",
        "        return fontsInfo;",
        "    },",
        "    devicePrint = {};",
        "",
        "devicePrint.screen = collectScreenInfo();",
        "devicePrint.timezone = collectTimezoneInfo();",
        "devicePrint.plugins = collectBrowserPluginsInfo();",
        "devicePrint.fonts = collectBrowserFontsInfo();",
        "",
        "if (navigator.userAgent) {",
        "    devicePrint.userAgent = navigator.userAgent;",
        "}",
        "if (navigator.appName) {",
        "    devicePrint.appName = navigator.appName;",
        "}",
        "if (navigator.appCodeName) {",
        "    devicePrint.appCodeName = navigator.appCodeName;",
        "}",
        "if (navigator.appVersion) {",
        "    devicePrint.appVersion = navigator.appVersion;",
        "}",
        "if (navigator.appMinorVersion) {",
        "    devicePrint.appMinorVersion = navigator.appMinorVersion;",
        "}",
        "if (navigator.buildID) {",
        "    devicePrint.buildID = navigator.buildID;",
        "}",
        "if (navigator.platform) {",
        "    devicePrint.platform = navigator.platform;",
        "}",
        "if (navigator.cpuClass) {",
        "    devicePrint.cpuClass = navigator.cpuClass;",
        "}",
        "if (navigator.oscpu) {",
        "    devicePrint.oscpu = navigator.oscpu;",
        "}",
        "if (navigator.product) {",
        "    devicePrint.product = navigator.product;",
        "}",
        "if (navigator.productSub) {",
        "    devicePrint.productSub = navigator.productSub;",
        "}",
        "if (navigator.vendor) {",
        "    devicePrint.vendor = navigator.vendor;",
        "}",
        "if (navigator.vendorSub) {",
        "    devicePrint.vendorSub = navigator.vendorSub;",
        "}",
        "if (navigator.language) {",
        "    devicePrint.language = navigator.language;",
        "}",
        "if (navigator.userLanguage) {",
        "    devicePrint.userLanguage = navigator.userLanguage;",
        "}",
        "if (navigator.browserLanguage) {",
        "    devicePrint.browserLanguage = navigator.browserLanguage;",
        "}",
        "if (navigator.systemLanguage) {",
        "    devicePrint.systemLanguage = navigator.systemLanguage;",
        "}",
        "",
        "// Attempt to collect geo-location information and return this with the data collected so far.",
        "// Otherwise, if geo-location fails or takes longer than 30 seconds, auto-submit the data collected so far.",
        "autoSubmitDelay = 30000;",
        "output.value = JSON.stringify(devicePrint);",
        "collectGeolocationInfo(function(geolocationInfo) {",
        "    devicePrint.geolocation = geolocationInfo;",
        "    output.value = JSON.stringify(devicePrint);",
        "    submit();",
        "});",
      ],
    },
    "158e500b-8180-4641-ad48-23577fe9d976": {
      "_id": "158e500b-8180-4641-ad48-23577fe9d976",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_MfaOptIn",
      "script": [
        "/*",
        "This creates the following callbacks:",
        "- TextOutputCallback: Display the step title and description",
        "- ConfirmationCallback: Display a list of buttons for choices",
        "- HiddenValueCallback: Captures the "skip" option, if selected",
        "- ScriptTextOutputCallback: Creates a "Skip for now" link button and positions it below the buttons ",
        "*/",
        "",
        "var token = generateNumericToken('xxx');",
        "var loadingMessage = 'Loading...';",
        "var linkButton = "<button id='skip-link-".concat(token).concat("' class='btn btn-block btn-link' type=submit>Skip for now</button>");",
        "var message = "<h2 class=h2>Set up 2-step verification</h2><div style='margin-bottom:1em'>Protect your account by adding a second step after entering your password to verify it's you signing in.</div>";",
        "var choices = ['Set up'];",
        "var defaultChoice = 0;",
        "var skipValue = 'Skip';",
        "",
        "// This will run recursively in the browser until references can be obtained to key DOM elements, at which point.",
        "// it will customize the DOM.  This is to avoid race conditions with the UI rendering callbacks.",
        "var setupPageScript =",
        "  'var setupPage = function() {'.concat(",
        "  '  var skipInputElem = document.getElementById("skip-input-').concat(token).concat('");').concat(",
        "  '  var messageElem;').concat(",
        "  '  document.getElementsByClassName("callback-component").forEach(').concat(",
        "  '    function (e) {').concat(",
        "  '      var m = e.firstElementChild;').concat(",
        "  '      if (m.firstChild && m.firstChild.nodeName == "#text" && m.firstChild.nodeValue.trim() == "').concat(loadingMessage).concat('") {').concat(",
        "  '        messageElem = m;').concat(",
        "  '      }').concat(",
        "  '    }').concat(",
        "  '  );').concat(",
        "  '  if (!skipInputElem || !messageElem) {').concat(",
        "  '    return setTimeout(setupPage, 50);').concat(",
        "  '  }').concat(",
        "  '  var skipContainer = document.createElement("div");').concat(",
        "  '  skipContainer.style = "width:100%";').concat(",
        "  '  skipContainer.innerHTML = "').concat(linkButton).concat('";').concat(",
        "  '  skipInputElem.parentNode.append(skipContainer);').concat(",
        "  '  messageElem.align = "center";').concat(",
        "  '  messageElem.innerHTML = "').concat(message).concat('";').concat(",
        "  '  var bindSkipLink = function() {').concat(",
        "  '    document.getElementById("skip-link-').concat(token).concat('").onclick = function() {').concat(",
        "  '      skipInputElem.value = "').concat(skipValue).concat('";').concat(",
        "  '      document.getElementById("loginButton_0").click();').concat(",
        "  '      return false;').concat(",
        "  '    };').concat(",
        "  '  };').concat(",
        "  '  setTimeout(bindSkipLink, 100);').concat(",
        "  '};').concat(",
        "  'setupPage();');",
        "",
        "var fr = JavaImporter(",
        "  org.forgerock.openam.auth.node.api.Action,",
        "  javax.security.auth.callback.ConfirmationCallback,",
        "  javax.security.auth.callback.TextOutputCallback,",
        "  com.sun.identity.authentication.callbacks.HiddenValueCallback,",
        "  com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        ")",
        "",
        "with (fr) {",
        "  if (callbacks.isEmpty()) {",
        "    action = Action.send(",
        "      new TextOutputCallback(",
        "          TextOutputCallback.INFORMATION,",
        "          loadingMessage",
        "      ),",
        "      new ConfirmationCallback(",
        "          ConfirmationCallback.INFORMATION,",
        "          choices,",
        "          defaultChoice",
        "      ),",
        "      new HiddenValueCallback('skip-input-'.concat(token), 'false'),",
        "      new ScriptTextOutputCallback(setupPageScript)",
        "    ).build()",
        "  } else {",
        "    if (callbacks.get(2).getValue() == skipValue) {",
        "      action = Action.goTo(skipValue).build();",
        "    } else {",
        "      action = Action.goTo(choices[callbacks.get(1).getSelectedIndex()]).build();",
        "    }",
        "  }",
        "}",
        "",
        " /*",
        "  * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "  * ",
        "  * Example:",
        "  * 'xxxxx' produces '28535'",
        "  * 'xxx-xxx' produces '432-521'",
        "  */",
        "function generateNumericToken(format) {",
        "  return format.replace(/[x]/g, function(c) {",
        "    var r = Math.random()*10|0;",
        "    var v = r;",
        "    return v.toString(10);",
        "  });",
        "}",
      ],
    },
    "164fe425-01e7-4b0b-9f60-fb41f6bf362b": {
      "_id": "164fe425-01e7-4b0b-9f60-fb41f6bf362b",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "FRAAS-7955 Display sharedState and transientState.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "FRAAS-7955 Display States",
      "script": [
        "/* debug",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Display sharedState and transientState.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "var output = true;",
        "",
        "var anchor = "anchor-".concat(generateNumericToken('xxx'));",
        "var halign = "left";",
        "var message = "<h4>Current State Values</h4>".concat(",
        "    "<p><b>Shared State</b>:<br/>").concat(",
        "      sharedState.toString()).concat("</p>").concat(",
        "    "<p><b>Transient State</b>:<br/>").concat(",
        "      transientState.toString()).concat("</p>")",
        "var script = "Array.prototype.slice.call(\\n".concat(",
        "  "document.getElementsByClassName('callback-component')).forEach(\\n").concat(",
        "  "function (e) {\\n").concat(",
        "  "  var message = e.firstElementChild;\\n").concat(",
        "  "  if (message.firstChild && message.firstChild.nodeName == '#text' && message.firstChild.nodeValue.trim() == '").concat(anchor).concat("') {\\n").concat(",
        "  "    message.className = \\"\\";\\n").concat(",
        "  "    message.style = \\"text-align: left; inline-size: 430px; overflow-wrap: break-word;\\";\\n").concat(",
        "  "    message.align = \\"").concat(halign).concat("\\";\\n").concat(",
        "  "    message.innerHTML = '").concat(message).concat("';\\n").concat(",
        "  "  }\\n").concat(",
        "  "})")",
        "var fr = JavaImporter(",
        "    org.forgerock.openam.auth.node.api.Action,",
        "    javax.security.auth.callback.TextOutputCallback,",
        "    com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        ")",
        "if (message.length && callbacks.isEmpty()) {",
        "    action = fr.Action.send(",
        "        new fr.TextOutputCallback(",
        "            fr.TextOutputCallback.INFORMATION,",
        "            anchor",
        "        ),",
        "        new fr.ScriptTextOutputCallback(script)",
        "    ).build()",
        "}",
        "else {",
        "  action = fr.Action.goTo("true").build();",
        "}",
        "",
        " /*",
        "  * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "  * ",
        "  * Example:",
        "  * 'xxxxx' produces '28535'",
        "  * 'xxx-xxx' produces '432-521'",
        "  */",
        "function generateNumericToken(format) {",
        "    return format.replace(/[x]/g, function(c) {",
        "        var r = Math.random()*10|0;",
        "        var v = r;",
        "        return v.toString(10);",
        "    });",
        "}",
      ],
    },
    "169150da-0bd1-4866-8095-eae0bbc269e4": {
      "_id": "169150da-0bd1-4866-8095-eae0bbc269e4",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Collect all the configuration items required for the Message Node to function properly.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Collect Message Node Config",
      "script": [
        "/* Collect Message Node Config",
        " * ",
        " * Collect all the configuration items required for the Message Node to function properly.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    outcome = "true";",
        "      var config = {",
        "        "message": {"en": "I believe I can fly!"},",
        "        "messageYes": {"en": "Glorious!"},",
        "        "messageNo": {"en": "Inconceivable!"}",
        "    };",
        "      var script = "";",
        "    script += "Array.prototype.slice.call(";",
        "    script += "    document.getElementsByTagName('input')";",
        "    script += ").forEach(";",
        "    script += "    function (input,i) {";",
        "    script += "        console.log('input '+i);"",
        "    script += "        var config = JSON.parse('"+JSON.stringify(config)+"');";",
        "    script += "        var keys = Object.keys(config);";",
        "    script += "        if (input.type === 'text') {";",
        "    script += "            input.setAttribute('value', config[keys[i]].en);";",
        "    script += "            input.dispatchEvent(new KeyboardEvent( 'input' , {'key':'Enter'} ));";",
        "    script += "        }";",
        "    script += "    }";",
        "    script += ");";",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "          javax.security.auth.callback.NameCallback,",
        "        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        "    )",
        "    if (callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "            new fr.NameCallback("message", config.message.en),",
        "            new fr.NameCallback("messageYes", config.messageYes.en),",
        "            new fr.NameCallback("messageNo", config.messageNo.en),",
        "              new fr.ScriptTextOutputCallback(script)",
        "        ).build();",
        "    }",
        "    else {",
        "          config[callbacks.get(0).getPrompt()].en = callbacks.get(0).getName();",
        "          config[callbacks.get(1).getPrompt()].en = callbacks.get(1).getName();",
        "          config[callbacks.get(2).getPrompt()].en = callbacks.get(2).getName();",
        "          nodeState.putShared("nodeConfig", config);",
        "        action = fr.Action.goTo(outcome).build();",
        "    }",
        "}());",
      ],
    },
    "199405e4-050e-4f2a-87d1-d9125f74a8df": {
      "_id": "199405e4-050e-4f2a-87d1-d9125f74a8df",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Reset theme to what's preserved in shared state variable "theme-id" or to default theme.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Reset Theme",
      "script": [
        "/* Reset Theme",
        " * ",
        " * Reset theme to what's preserved in shared state variable "themeId" or to default theme.",
        " * ",
        " * This script needs to be parametrized!",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "      /* Begin Script Configuration */",
        "      var defaultTheme = "Expanse";",
        "      /* End Script Configuration */",
        "      ",
        "      outcome = "true";",
        "      ",
        "      var theme = defaultTheme;",
        "      if (sharedState.get("themeId") && ""+sharedState.get("themeId") !== "") {",
        "          theme = sharedState.get("themeId");",
        "    }",
        "",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "        org.forgerock.openam.authentication.callbacks.PollingWaitCallback",
        "    )",
        "    if (callbacks.isEmpty()) {",
        "        var stage = "themeId="+theme;",
        "        action = fr.Action.send(",
        "              new fr.PollingWaitCallback("100", "Please wait ...")",
        "        ).withStage(stage).build();",
        "    } else {",
        "          action = fr.Action.goTo(outcome).build();",
        "    }",
        "}());",
      ],
    },
    "1acc5535-13e2-4ed8-83e1-f4fefd86d243": {
      "_id": "1acc5535-13e2-4ed8-83e1-f4fefd86d243",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Readiness probe response",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Ready Response",
      "script": [
        "/* Ready Response",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Return READY in a TextOutputCallback indicating that the journey layer is operational.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "outcome = "true";",
        "var fr = JavaImporter(",
        "    org.forgerock.openam.auth.node.api.Action,",
        "    javax.security.auth.callback.TextOutputCallback",
        ")",
        "if (callbacks.isEmpty()) {",
        "    action = fr.Action.send(",
        "        new fr.TextOutputCallback(",
        "            fr.TextOutputCallback.INFORMATION,",
        "            "READY"",
        "        )",
        "    ).build()",
        "}",
        "else {",
        "  action = fr.Action.goTo(outcome).build();",
        "}",
      ],
    },
    "1b52a7e0-4019-40fa-958a-15a49870e901": {
      "_id": "1b52a7e0-4019-40fa-958a-15a49870e901",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "set the same shared state variable",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "shared",
      "script": [
        "(function () {",
        "  outcome = 'true';",
        "  var level = nodeState.get('level').asInteger();",
        "  sharedState.put('sharedValue', 'Level ' + level + ': This is a longer string value shared across all nested journeys. It contains an indicator in which level it was last set.');",
        "}());",
      ],
    },
    "1c0c73e8-2be1-41ce-b042-3c39694346b5": {
      "_id": "1c0c73e8-2be1-41ce-b042-3c39694346b5",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Verify unknown caller by account number",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Twilio IVR: Verify Unknown Caller",
      "script": [
        "/* Twilio IVR: Verify Unknown Caller",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * ",
        " * Depending on the amount of data collected through callbacks and how many of the callParams",
        " * you activate below, you will need to change your authentication session from JWT to CTS or",
        " * Memory.",
        " */",
        "logger.warning("Twilio IVR: Verify Unknown Caller: start");",
        "outcome = "true";",
        "",
        "/* Begin Configuration",
        " */",
        "",
        "// Build out the verification prompt",
        "var prompt = "To lookup your account, please enter or say your account number.";",
        "",
        "/* End Configuration",
        " */",
        "",
        "var fr = JavaImporter(",
        "      org.forgerock.openam.auth.node.api,",
        "      javax.security.auth.callback.TextInputCallback",
        ");",
        "  ",
        "with (fr) {",
        "      if (callbacks.isEmpty()) {",
        "        var input = new TextInputCallback(prompt);",
        "        action = Action.send(input).build();",
        "      } ",
        "      else {",
        "          var answer = new String(callbacks.get(0).getText()).replace(/[^0-9]/g, "");",
        "        logger.warning("Twilio IVR: Verify Unknown Caller: callbacks received: answer=".concat(answer));",
        "          setSharedObjectAttribute("frIndexedInteger5", answer);",
        "        logger.warning("Twilio IVR: Verify Unknown Caller: finish [outcome=".concat(outcome).concat("]"));",
        "        action = Action.goTo(outcome).build();",
        "      }",
        "}",
        "",
        "/*",
        " * Store attributes in shared state for use with the Create/Patch Object nodes.",
        " */",
        "function setSharedObjectAttribute(name, value) {",
        "       var storage = sharedState.get("objectAttributes");",
        "    if (storage && value) {",
        "          if (storage.put) {",
        "              storage.put(name, value);",
        "        }",
        "          else {",
        "              storage[name] = value;",
        "        }",
        "    }",
        "    else if (value) {",
        "        sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "    }",
        "}",
      ],
    },
    "1d475815-72cb-42eb-aafd-4026989d28a7": {
      "_id": "1d475815-72cb-42eb-aafd-4026989d28a7",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Default global script for Social Identity Provider Profile Transformation",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Social Identity Provider Profile Transformation Script",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/* Default Social Identity Provider Profile Transformation script to use as a template for new scripts */",
      ],
    },
    "1e8175a2-6114-415f-9b72-9fe15bdf3661": {
      "_id": "1e8175a2-6114-415f-9b72-9fe15bdf3661",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_IsFederationEnforcedForUser",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "var fr = new JavaImporter(",
        "  org.forgerock.openam.auth.nodes,",
        "  org.forgerock.guice.core",
        ");",
        "",
        "with (fr) {",
        "  var enforcement = 'none';",
        "",
        "  function isSuperAdmin() {",
        "    var uuid = sharedState.get('_id');",
        "    var realm = sharedState.get('realm');",
        "    var identityProvider = InjectorHolder.getInstance(IdentityProvider);",
        "    var identity = identityProvider.getIdentity(uuid, realm);",
        "    var groups = identity.getAttribute('fr-attr-group').toArray();",
        "    for (var i = 0; i < groups.length; i++) {",
        "      if (groups[i] == 'super-admins') {",
        "        return true;",
        "      }",
        "    }",
        "    return false;",
        "  }",
        "",
        "  try {",
        "    switch (enforcement) {",
        "      case 'none':",
        "        outcome = 'False';",
        "        break;",
        "      case 'all':",
        "        outcome = 'True';",
        "        break;",
        "      default:",
        "        outcome = isSuperAdmin() ? 'False' : 'True';",
        "        break;",
        "    }",
        "  } catch (e) {",
        "    logger.error('Failed to determine if federation is enforced for user: {}', e);",
        "    outcome = 'Error';",
        "  }",
        "}",
      ],
    },
    "1f389a3d-21cf-417c-a6d3-42ea620071f0": {
      "_id": "1f389a3d-21cf-417c-a6d3-42ea620071f0",
      "context": "OIDC_CLAIMS",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Internal OIDC Claims script",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "ForgeRock Internal: OIDC Claims Script",
      "script": [
        "/*",
        " * Copyright 2014-2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        " * This script computes claim values returned in ID tokens and/or at the UserInfo Endpoint.",
        " * The claim values are computed for:",
        " * the claims derived from the requested scopes,",
        " * the claims provided by the authorization server,",
        " * and the claims requested by the client via the claims parameter.",
        " *",
        " * In the CONFIGURATION AND CUSTOMIZATION section, you can",
        " * define the scope-to-claims mapping, and",
        " * assign to each claim a resolver function that will compute the claim value.",
        " *",
        " * Defined variables (class references are provided below):",
        " * scopes - Set<String> (6).",
        " *          Always present, the requested scopes.",
        " * claims - Map<String, Object> (5).",
        " *          Always present, default server provided claims.",
        " * claimObjects - List<Claim> (7, 2).",
        " *                Always present, the default server provided claims.",
        " * requestedClaims - Map<String, Set<String>> (5).",
        " *                   Always present, not empty if the request contains the claims parameter and the server has enabled",
        " *                   claims_parameter_supported. A map of the requested claims to possible values, otherwise empty;",
        " *                   requested claims with no requested values will have a key but no value in the map. A key with",
        " *                   a single value in its Set (6) indicates that this is the only value that should be returned.",
        " * requestedTypedClaims - List<Claim> (7, 2).",
        " *                        Always present, the requested claims.",
        " *                        Requested claims with no requested values will have a claim with no values.",
        " *                        A claim with a single value indicates this is the only value that should be returned.",
        " * claimsLocales - List<String> (7).",
        " *                 The values from the 'claims_locales' parameter.",
        " *                 See https://openid.net/specs/openid-connect-core-1_0.html#ClaimsLanguagesAndScripts for the OIDC specification details.",
        " * requestProperties - Unmodifiable Map (5).",
        " *                     Always present, contains a map of request properties:",
        " *                     requestUri - The request URI.",
        " *                     realm - The realm that the request relates to.",
        " *                     requestParams - A map of the request params and/or posted data.",
        " *                                     Each value is a list of one or more properties.",
        " *                                     Please note that these should be handled in accordance with OWASP best practices:",
        " *                                     https://owasp.org/www-community/vulnerabilities/Unsafe_use_of_Reflection.",
        " * clientProperties - Unmodifiable Map (5).",
        " *                    Present if the client specified in the request was identified, contains a map of client properties:",
        " *                    clientId - The client's URI for the request locale.",
        " *                    allowedGrantTypes - List of the allowed grant types (org.forgerock.oauth2.core.GrantType) for the client.",
        " *                    allowedResponseTypes - List of the allowed response types for the client.",
        " *                    allowedScopes - List of the allowed scopes for the client.",
        " *                    customProperties - A map of the custom properties of the client.",
        " *                                       Lists or maps will be included as sub-maps; for example:",
        " *                                       customMap[Key1]=Value1 will be returned as customMap -> Key1 -> Value1.",
        " *                                       To add custom properties to a client, update the Custom Properties field",
        " *                                       in AM Console > Realm Name > Applications > OAuth 2.0 > Clients > Client ID > Advanced.",
        " * identity - AMIdentity (3).",
        " *            Always present, the identity of the resource owner.",
        " * session - SSOToken (4).",
        " *           Present if the request contains the session cookie, the user's session object.",
        " * scriptName - String (primitive).",
        " *              Always present, the display name of the script.",
        " * logger - Always present, the "OAuth2Provider" debug logger instance:",
        " *          https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.",
        " *          Corresponding files will be prefixed with: scripts.OIDC_CLAIMS.",
        " * httpClient - HTTP Client (8).",
        " *              Always present, the HTTP Client instance:",
        " *              https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-http-client.html#scripting-api-global-http-client.",
        " *              In order to use the client, you may need to add",
        " *              org.forgerock.http.Client,",
        " *              org.forgerock.http.protocol.*,",
        " *              and org.forgerock.util.promise.PromiseImpl",
        " *              to the allowed Java classes in the scripting engine configuration, as described in:",
        " *              https://backstage.forgerock.com/docs/am/7/scripting-guide/script-engine-security.html",
        " *",
        " * Return - a new UserInfoClaims(Map<String, Object> values, Map<String, List<String>> compositeScopes) (1) object.",
        " *          The result of the last statement in the script is returned to the server.",
        " *          Currently, the Immediately Invoked Function Expression (also known as Self-Executing Anonymous Function)",
        " *          is the last (and only) statement in this script, and its return value will become the script result.",
        " *          Do not use "return variable" statement outside of a function definition.",
        " *          See RESULTS section for additional details.",
        " *",
        " * Class reference:",
        " * (1) UserInfoClaims - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html.",
        " * (2) Claim - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html).",
        " *         An instance of org.forgerock.openidconnect.Claim has methods to access",
        " *         the claim name, requested values, locale, and whether the claim is essential.",
        " * (3) AMIdentity - https://backstage.forgerock.com/docs/am/7/apidocs/com/sun/identity/idm/AMIdentity.html.",
        " * (4) SSOToken - https://backstage.forgerock.com/docs/am/7/apidocs/com/iplanet/sso/SSOToken.html.",
        " * (5) Map - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashMap.html,",
        " *           or https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/LinkedHashMap.html.",
        " * (6) Set - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashSet.html.",
        " * (7) List - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/ArrayList.html.",
        " * (8) Client - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/http/Client.html.",
        "*/",
        "",
        "(function () {",
        "    // SETUP",
        "",
        "    /**",
        "     * Claim processing utilities.",
        "     * An object that contains reusable functions for processing claims.",
        "     * @see CLAIM PROCESSING UTILITIES section for details.",
        "     */",
        "    var utils = getUtils();",
        "",
        "    // CONFIGURATION AND CUSTOMIZATION",
        "",
        "    /**",
        "     * OAuth 2.0 scope values (scopes) can be used by the Client to request OIDC claims.",
        "     *",
        "     * Call this configuration method, and pass in as the first argument",
        "     * an object that maps a scope value to an array of claim names",
        "     * to specify which claims need to be processed and returned for the requested scopes.",
        "     * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#ScopeClaims}",
        "     * for the scope values that could be used to request claims as defined in the OIDC specification.",
        "     *",
        "     * Below, find a default configuration that is expected to work in the current environment.",
        "     *",
        "     * CUSTOMIZATION",
        "     * You can choose the claim names returned for a scope.",
        "     */",
        "    utils.setScopeClaimsMap({",
        "        profile: [",
        "            'name',",
        "            'family_name',",
        "            'given_name',",
        "            'zoneinfo',",
        "            'locale'",
        "        ],",
        "        email: ['email'],",
        "        address: ['address'],",
        "        phone: ['phone_number']",
        "    });",
        "",
        "    /**",
        "     * In this script, each claim",
        "     * derived from the requested scopes,",
        "     * provided by the authorization server, and",
        "     * requested by the client via the claims parameter",
        "     * will be processed by a function associated with the claim name.",
        "     *",
        "     * Call this configuration method, and pass in as the first argument",
        "     * an object that maps a claim name to a resolver function,",
        "     * which will be automatically executed for each claim processed by the script.",
        "     *",
        "     * The claim resolver function will receive the requested claim information",
        "     * in an instance of org.forgerock.openidconnect.Claim as the first argument.",
        "     * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html}",
        "     * for details on the Claim class.",
        "     *",
        "     * If the claim resolver function returns a value,",
        "     * other than undefined or null,",
        "     * the claim will be included in the script's results.",
        "     *",
        "     * The Claim instance provides methods to check",
        "     * what the name of the claim is,",
        "     * which values the claim request contains,",
        "     * whether the claim is essential, and",
        "     * which locale the claim is associated with.",
        "     * The resolver function can consider this information when computing and returning the claim value.",
        "     *",
        "     * Below, find a default configuration that is expected to work in the current environment.",
        "     * A reusable function, utils.getUserProfileClaimResolver(String attribute-name),",
        "     * is called to return a claim resolver function based on a user profile attribute.",
        "     * @see CLAIM RESOLVERS section for the implementation details and examples.",
        "     * For the address claim, an example of a claim resolver that uses another claim resolver is provided.",
        "     *",
        "     * CUSTOMIZATION",
        "     * You can reuse the predefined utils methods with your custom arguments.",
        "     * You can also specify a custom resolver function for a claim name,",
        "     * that will compute and return the claim value—as shown in the commented out example below.",
        "     */",
        "    utils.setClaimResolvers({",
        "        /*",
        "        // An example of a simple claim resolver function that is defined for a claim",
        "        // directly in the configuration object:",
        "        custom-claim-name: function (requestedClaim) {",
        "            // In this case, initially, the claim value comes straight from a user profile attribute value:",
        "            var claimValue = identity.getAttribute('custom-attribute-name').toArray()[0]",
        "",
        "            // Optionally, provide additional logic for processing (filtering, formatting, etc.) the claim value.",
        "            // You can use:",
        "            // requestedClaim.getName()",
        "            // requestedClaim.getValues()",
        "            // requestedClaim.getLocale()",
        "            // requestedClaim.isEssential()",
        "",
        "            return claimValue",
        "        },",
        "        */",
        "        /**",
        "         * The use of utils.getUserProfileClaimResolver shows how",
        "         * an argument passed to a function that returns a claim resolver",
        "         * becomes available to the resolver function (via its lexical context).",
        "         */",
        "        name: utils.getUserProfileClaimResolver('cn'),",
        "        family_name: utils.getUserProfileClaimResolver('sn'),",
        "        given_name: utils.getUserProfileClaimResolver('givenname'),",
        "        zoneinfo: utils.getUserProfileClaimResolver('preferredtimezone'),",
        "        locale: utils.getUserProfileClaimResolver('preferredlocale'),",
        "        email: utils.getUserProfileClaimResolver('mail'),",
        "        address: utils.getAddressClaimResolver(",
        "            /**",
        "             * The passed in user profile claim resolver function",
        "             * can be used by the address claim resolver function",
        "             * to obtain the claim value to be formatted as per the OIDC specification:",
        "             * @see https://openid.net/specs/openid-connect-core-1_0.html#AddressClaim.",
        "             */",
        "            utils.getUserProfileClaimResolver('postaladdress')",
        "        ),",
        "        phone_number: utils.getUserProfileClaimResolver('telephonenumber')",
        "    });",
        "",
        "    // CLAIM PROCESSING UTILITIES",
        "",
        "    /**",
        "     * @returns {object} An object that contains reusable claim processing utilities.",
        "     * @see PUBLIC METHODS section and the return statement for the list of exported functions.",
        "     */",
        "    function getUtils () {",
        "        // IMPORT JAVA",
        "",
        "        /**",
        "         * Provides Java scripting functionality.",
        "         * @see {@link https://developer.mozilla.org/en-US/docs/Mozilla/Projects/Rhino/Scripting_Java#javaimporter_constructor}.",
        "         */",
        "        var frJava = JavaImporter(",
        "            org.forgerock.oauth2.core.exceptions.InvalidRequestException,",
        "            org.forgerock.oauth2.core.UserInfoClaims,",
        "            org.forgerock.openidconnect.Claim,",
        "",
        "            java.util.LinkedHashMap,",
        "            java.util.ArrayList",
        "        );",
        "",
        "        // SET UP CONFIGURATION",
        "",
        "        /**",
        "         * Placeholder for a configuration option that contains",
        "         * an object that maps the supported scope values (scopes)",
        "         * and the corresponding claim names for each scope value.",
        "         */",
        "        var scopeClaimsMap;",
        "",
        "        /**",
        "         * Placeholder for a configuration option that contains",
        "         * an object that maps the supported claim names",
        "         * and the resolver functions returning the claim value.",
        "         */",
        "        var claimResolvers;",
        "",
        "        /**",
        "         * A (public) method that accepts an object that maps the supported scopes and the corresponding claim names,",
        "         * and assigns it to a (private) variable that serves as a configuration option.",
        "         * @param {object} params - An object that maps each supported scope value to an array of claim names,",
        "         * in order to specify which claims need to be processed for the requested scopes.",
        "         * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#ScopeClaims} for details.",
        "         * @param {string[]} [params.profile] - An array of claim names to be returned if the profile scope is requested.",
        "         * @param {string[]} [params.email] - An array of claim names to be returned if the email scope is requested.",
        "         * @param {string[]} [params.address] - An array of claim names to be returned if the address scope is requested.",
        "         * @param {string[]} [params.phone] - An array of claim names to be returned if the phone scope is requested.",
        "         * @returns {undefined}",
        "         */",
        "        function setScopeClaimsMap(params) {",
        "            scopeClaimsMap = params;",
        "        }",
        "",
        "        /**",
        "         * A (public) method that accepts an object that maps the supported claim names",
        "         * and the resolver functions returning the claim value,",
        "         * and assigns it to a (private) variable that serves as a configuration option.",
        "         * @param {object} params - An object that maps",
        "         * each supported claim name to a function that computes and returns the claim value.",
        "         */",
        "        function setClaimResolvers(params) {",
        "            claimResolvers = params;",
        "        }",
        "",
        "        // CLAIM RESOLVERS",
        "",
        "        /**",
        "         * Claim resolvers are functions that return a claim value.",
        "         * @param {*}",
        "         * @returns {*}",
        "         */",
        "",
        "        /**",
        "         * Defines a claim resolver based on a user profile attribute.",
        "         * @param {string} attributeName - Name of the user profile attribute.",
        "         * @returns {function} A function that will determine the claim value",
        "         * based on the user profile attribute and the (requested) claim properties.",
        "         */",
        "        function getUserProfileClaimResolver (attributeName) {",
        "            /**",
        "             * Resolves a claim with a user profile attribute value.",
        "             * Returns undefined if the identity attribute is not populated,",
        "             * OR if the claim has requested values that do not contain the identity attribute value.",
        "             * ATTENTION: the aforementioned comparison is case-sensitive.",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {string|HashSet|undefined}",
        "             */",
        "            function resolveClaim(claim) {",
        "                var userProfileValue;",
        "",
        "                if (identity) {",
        "                    userProfileValue = getClaimValueFromSet(claim, identity.getAttribute(attributeName));",
        "",
        "                    if (userProfileValue && !userProfileValue.isEmpty()) {",
        "                        if (!claim.getValues() || claim.getValues().isEmpty() || claim.getValues().contains(userProfileValue)) {",
        "                            return userProfileValue;",
        "                        }",
        "                    }",
        "                }",
        "            }",
        "",
        "            return resolveClaim;",
        "        }",
        "",
        "        /**",
        "         * Returns an address claim resolver based on a claim value obtained with another claim resolver.",
        "         * @param {function} resolveClaim - A function that returns a claim value.",
        "         * @returns {function} A function that will accept a claim as an argument,",
        "         * run the claim resolver function for the claim and obtain the claim value,",
        "         * and apply additional formatting to the value before returning it.",
        "         */",
        "        function getAddressClaimResolver (resolveClaim) {",
        "            /**",
        "             * Creates an address claim object from a value returned by a claim resolver,",
        "             * and returns the address claim object as the claim value.",
        "             * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#AddressClaim}.",
        "             * The claim value is obtained with a claim resolving function available from the closure.",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {java.util.LinkedHashMap|undefined} The address claim object created from a claim value.",
        "             */",
        "            function resolveAddressClaim(claim) {",
        "                var claimValue = resolveClaim(claim);",
        "                var addressObject;",
        "",
        "                if (isClaimValueValid(claimValue)) {",
        "                    addressObject = new frJava.LinkedHashMap();",
        "",
        "                    addressObject.put('formatted', claimValue);",
        "",
        "                    return addressObject;",
        "                }",
        "            }",
        "",
        "            return resolveAddressClaim;",
        "        }",
        "",
        "        /**",
        "         * Returns an essential claim resolver based on a claim value obtained with another claim resolver.",
        "         * @param {function} resolveClaim - A function that returns a claim value.",
        "         * @returns {function} A function that will accept a claim as an argument,",
        "         * run the claim resolver function for the claim and obtain the claim value,",
        "         * and apply additional logic for essential claims.",
        "         */",
        "        function getEssentialClaimResolver (resolveClaim) {",
        "            /**",
        "             * Returns a claim value or throws an error.",
        "             * The claim value is obtained with a claim resolving function available from the closure.",
        "             * Throws an exception if the claim is essential and no value is returned for the claim.",
        "             *",
        "             * Use of this resolver is optional.",
        "             * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#IndividualClaimsRequests} stating:",
        "             * "Note that even if the Claims are not available because the End-User did not authorize their release or they are not present,",
        "             * the Authorization Server MUST NOT generate an error when Claims are not returned, whether they are Essential or Voluntary,",
        "             * unless otherwise specified in the description of the specific claim."",
        "             *",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {*}",
        "             * @throws {org.forgerock.oauth2.core.exceptions.InvalidRequestException}",
        "             */",
        "            function resolveEssentialClaim(claim) {",
        "                var claimValue = resolveClaim(claim);",
        "",
        "                if (claim.isEssential() && !isClaimValueValid(claimValue)) {",
        "                    throw new frJava.InvalidRequestException('Could not provide value for essential claim: ' + claim.getName());",
        "                }",
        "",
        "                return claimValue;",
        "            }",
        "",
        "            return resolveEssentialClaim;",
        "        }",
        "",
        "        /**",
        "         * Provides default resolution for a claim.",
        "         * Use it if a claim-specific resolver is not defined in the configuration.",
        "         * @param {org.forgerock.openidconnect.Claim} claim",
        "         * An object that provides methods to obtain information/requirements associated with a claim.",
        "         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "         * @returns {*} A single value associated with this claim.",
        "         */",
        "        function resolveAnyClaim (claim) {",
        "            if (claim.getValues().size() === 1) {",
        "                return claim.getValues().toArray()[0];",
        "            }",
        "        }",
        "",
        "        // UTILITIES",
        "",
        "        /**",
        "         * Returns claim value from a set.",
        "         * If the set contains a single value, returns the value.",
        "         * If the set contains multiple values, returns the set.",
        "         * Otherwise, returns undefined.",
        "         *",
        "         * @param {org.forgerock.openidconnect.Claim} claim",
        "         * An object that provides methods to obtain information/requirements associated with a claim.",
        "         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "         * @param {java.util.HashSet} set The set—for example, a user profile attribute value.",
        "         * @returns {string|java.util.HashSet|undefined}",
        "         */",
        "        function getClaimValueFromSet (claim, set) {",
        "            if (set && set.size()) {",
        "                if (set.size() === 1) {",
        "                    return set.toArray()[0];",
        "                } else {",
        "                    return set;",
        "                }",
        "            } else if (logger.warningEnabled()) {",
        "                logger.warning('OIDC Claims script. Got an empty set for claim: ' + claim.getName());",
        "            }",
        "        }",
        "",
        "        function isClaimValueValid (claimValue) {",
        "            if (typeof claimValue === 'undefined' || claimValue === null) {",
        "                return false;",
        "            }",
        "",
        "            return true;",
        "        }",
        "",
        "        // CLAIM PROCESSING",
        "",
        "        /**",
        "         * Constructs and returns an object populated with the computed claim values",
        "         * and the requested scopes mapped to the claim names.",
        "         * @returns {org.forgerock.oauth2.core.UserInfoClaims} The object to be returned to the authorization server.",
        "         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html}.",
        "         * @see RESULTS section for the use of this function.",
        "         */",
        "        function getUserInfoClaims () {",
        "            return new frJava.UserInfoClaims(getComputedClaims(), getCompositeScopes());",
        "        }",
        "",
        "        /**",
        "         * Creates a map of (requested) claim names populated with the computed claim values.",
        "         * @returns {java.util.LinkedHashMap}",
        "         * A map of the requested claim names and the corresponding claim values.",
        "         */",
        "        function getComputedClaims () {",
        "            /**",
        "             * Creates a complete list of claim objects from:",
        "             * the claims derived from the scopes,",
        "             * the claims provided by the authorization server,",
        "             * and the claims requested by the client.",
        "             * @returns {java.util.ArrayList}",
        "             * Returns a complete list of org.forgerock.openidconnect.Claim objects available to the script.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for the claim object details.",
        "             */",
        "            function getClaims() {",
        "                /**",
        "                 * Returns a list of claim objects for the requested scopes.",
        "                 * Uses the scopeClaimsMap configuration option to derive the claim names;",
        "                 * no other properties of a claim derived from a scope are populated.",
        "                 * @returns {java.util.ArrayList}",
        "                 * A list of org.forgerock.openidconnect.Claim objects derived from the requested scopes.",
        "                 * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for the claim object details.",
        "                 */",
        "                function convertScopeToClaims() {",
        "                    var claims = new frJava.ArrayList();",
        "",
        "                    scopes.toArray().forEach(function (scope) {",
        "                        if (String(scope) !== 'openid' && scopeClaimsMap[scope]) {",
        "                            scopeClaimsMap[scope].forEach(function (claimName) {",
        "                                claims.add(new frJava.Claim(claimName));",
        "                            });",
        "                        }",
        "                    });",
        "",
        "                    return claims;",
        "                }",
        "",
        "                var claims = new frJava.ArrayList();",
        "",
        "                claims.addAll(convertScopeToClaims());",
        "                claims.addAll(claimObjects);",
        "                claims.addAll(requestedTypedClaims);",
        "",
        "                return claims;",
        "            }",
        "",
        "            /**",
        "             * Computes and returns a claim value.",
        "             * To obtain the claim value, uses the resolver function specified for the claim in the claimResolvers configuration object.",
        "             * @see claimResolvers",
        "             * If no resolver function is found, uses the default claim resolver function.",
        "             *",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {*} Claim value.",
        "             * @throws {org.forgerock.oauth2.core.exceptions.InvalidRequestException}",
        "             * Rethrows this exception if a claim resolver throws it.",
        "             * You can throw org.forgerock.oauth2.core.exceptions.InvalidRequestException from your custom claim resolver",
        "             * if you want to terminate the claim processing.",
        "             */",
        "            function computeClaim(claim) {",
        "                var resolveClaim;",
        "                var message;",
        "",
        "                try {",
        "                    resolveClaim = claimResolvers[claim.getName()] || resolveAnyClaim;",
        "",
        "                    return resolveClaim(claim);",
        "                } catch (e) {",
        "                    message = 'OIDC Claims script exception. Unable to resolve OIDC Claim. ' + e;",
        "",
        "                    if (String(e).indexOf('org.forgerock.oauth2.core.exceptions.InvalidRequestException') !== -1) {",
        "                        throw e;",
        "                    }",
        "",
        "                    if (logger.warningEnabled()) {",
        "                        logger.warning(message);",
        "                    }",
        "                }",
        "            }",
        "",
        "            var computedClaims = new frJava.LinkedHashMap();",
        "",
        "            getClaims().toArray().forEach(function (claim) {",
        "                var claimValue = computeClaim(claim);",
        "",
        "                if (isClaimValueValid(claimValue)) {",
        "                    computedClaims.put(claim.getName(), claimValue);",
        "                } else {",
        "                    /**",
        "                     * If a claim has been processed, but appears in the list again,",
        "                     * and its value cannot be computed under the new conditions,",
        "                     * the claim is removed from the final result.",
        "                     *",
        "                     * For example, a claim could be mapped to a scope and found in the user profile,",
        "                     * but also requested by the client with required values that don't match the computed one.",
        "                     * @see {link https://openid.net/specs/openid-connect-core-1_0.html#IndividualClaimsRequests}.",
        "                     * for the relevant OIDC specification details.",
        "                     */",
        "                    computedClaims.remove(claim.getName());",
        "                }",
        "            });",
        "",
        "            return computedClaims;",
        "        }",
        "",
        "        /**",
        "         * Creates a map of requested scopes and the corresponding claim names.",
        "         * @returns {java.util.LinkedHashMap}",
        "         */",
        "        function getCompositeScopes () {",
        "            var compositeScopes = new frJava.LinkedHashMap();",
        "",
        "            scopes.toArray().forEach(function (scope) {",
        "                var scopeClaims = new frJava.ArrayList();",
        "",
        "                if (scopeClaimsMap[scope]) {",
        "                    scopeClaimsMap[scope].forEach(function (claimName) {",
        "                        scopeClaims.add(claimName);",
        "                    });",
        "                }",
        "",
        "                if (scopeClaims.size()) {",
        "                    compositeScopes.put(scope, scopeClaims);",
        "                }",
        "            });",
        "",
        "            return compositeScopes;",
        "        }",
        "",
        "        // PUBLIC METHODS",
        "",
        "        return {",
        "            setScopeClaimsMap: setScopeClaimsMap,",
        "            setClaimResolvers: setClaimResolvers,",
        "            getUserProfileClaimResolver: getUserProfileClaimResolver,",
        "            getAddressClaimResolver: getAddressClaimResolver,",
        "            getEssentialClaimResolver: getEssentialClaimResolver,",
        "            getUserInfoClaims: getUserInfoClaims",
        "        };",
        "    }",
        "",
        "    // RESULTS",
        "",
        "    /**",
        "     * This script returns an instance of the org.forgerock.oauth2.core.UserInfoClaims class",
        "     * populated with the computed claim values and",
        "     * the requested scopes mapped to the claim names.",
        "     * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html}.",
        "     *",
        "     * Assigning it to a variable gives you an opportunity",
        "     * to log the content of the returned value during development.",
        "     */",
        "    var userInfoClaims = utils.getUserInfoClaims();",
        "",
        "    /*",
        "    logger.error(scriptName + ' results:')",
        "    logger.error('Values: ' + userInfoClaims.getValues())",
        "    logger.error('Scopes: ' + userInfoClaims.getCompositeScopes())",
        "    */",
        "",
        "    return userInfoClaims;",
        "}());",
        "",
      ],
    },
    "22ab12ac-d1d9-414b-ab51-cfae30de8c0a": {
      "_id": "22ab12ac-d1d9-414b-ab51-cfae30de8c0a",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Create a configuration object for the Email Template Node.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Configure Email Template Node",
      "script": [
        "/* Configure Email Template Node",
        " * ",
        " * Create a configuration object for the Email Template Node.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * - error",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "  try {",
        "  outcome = 'true';",
        "  var config = {",
        "    emailAttribute: 'mail',",
        "    emailTemplateName: 'welcome',",
        "    identityAttribute: 'userName'",
        "  };",
        "  nodeState.putShared('nodeConfig', config);",
        "  } catch (error) {",
        "      outcome = 'error';",
        "    nodeState.putShared('error', error.message);",
        "  }",
        "}());",
      ],
    },
    "23143919-6b78-40c3-b25e-beca19b229e0": {
      "_id": "23143919-6b78-40c3-b25e-beca19b229e0",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Normalizes raw profile data from GitHub",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "GitHub Profile Normalization (VS)",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "logger.warning("GitHub rawProfile: "+rawProfile)",
        "",
        "return json(object(",
        "        field("id", rawProfile.id),",
        "        field("displayName", rawProfile.name),",
        "        field("givenName", rawProfile.first_name),",
        "        field("familyName", rawProfile.last_name),",
        "        field("photoUrl", rawProfile.picture.data.url),",
        "        field("email", rawProfile.email),",
        "        field("username", rawProfile.email)))",
      ],
    },
    "27f1b5a3-9446-4e5c-b965-f195a99fa666": {
      "_id": "27f1b5a3-9446-4e5c-b965-f195a99fa666",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_PasswordFixEnd",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        "This restores sharedState.objectAttributes temporarily overwritten to fix an issue with password policy.",
        "*/",
        "",
        "//var password = '';",
        "//var objAttrs = sharedState.get('objectAttributes');",
        "//if (objAttrs && objAttrs.containsKey('password')) {",
        "//  password = objAttrs.get('password');",
        "//}",
        "",
        "// Restore original object attributes",
        "var origObjAttrs = sharedState.get('originalObjectAttributes');",
        "if (origObjAttrs) {",
        "//  if (password) {",
        "//    origObjAttrs.put('password', password);",
        "//  }",
        "  sharedState.put('objectAttributes', origObjAttrs);",
        "}",
        "",
        "outcome = 'True';",
        "",
      ],
    },
    "2997bd4d-14be-4dc6-8701-27f08d10b8b7": {
      "_id": "2997bd4d-14be-4dc6-8701-27f08d10b8b7",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Profile Normalization Script for idddataweb",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "iddataweb Profile Normalization",
      "script": [
        "/*/*",
        " * Copyright 2022 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS. Not for Production use. ",
        " * Modified by Stephen Payne",
        " */",
        "/* Social Identity Provider Profile Transformation script for ID DataWeb */",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "logger.error("iddataweb_Social Identity Provider Profile Transformation script: Start");",
        "userName = sharedState.get("objectAttributes").get("mail");",
        "logger.error("iddataweb_Social Identity Provider Profile Transformation script: userName" + userName );",
        "username = userName;",
        "sharedState.put("userName", userName);",
        "",
        "return json(object(",
        "        field("id", rawProfile.sub),",
        "        field("displayName", rawProfile.acquiredAttributes_AcquiredFullName_fname.asString() + " " + rawProfile.acquiredAttributes_AcquiredFullName_lname.asString().toLowerCase().capitalize() ),",
        "        field("givenName", rawProfile.acquiredAttributes_AcquiredFullName_fname.asString().toLowerCase().capitalize() ),",
        "        field("familyName", rawProfile.acquiredAttributes_AcquiredFullName_lname.asString().toLowerCase().capitalize() ),",
        "        field("postalAddress", rawProfile.acquiredAttributes_AcquiredAddress_address),",
        "        field("addressLocality", rawProfile.acquiredAttributes_AcquiredAddress_locality),",
        "        field("addressRegion", rawProfile.acquiredAttributes_AcquiredAddress_administrative_area_level_1),",
        "        field("postalCode", rawProfile.acquiredAttributes_AcquiredAddress_postal_code),",
        "        field("country", rawProfile.acquiredAttributes_AcquiredAddress_country),",
        "        field("driversLicense", rawProfile.acquiredAttributes_AcquiredDriversLicenseNumber_acquiredDriversLicenseNumber),",
        "        field("driversLicenseIssuer", rawProfile.acquiredAttributes_DriversLicenseIssuerCode_DriversLicenseIssuerCode),",
        "          field("DOB", rawProfile.acquiredAttributes_AcquiredDOB_month.asString() + "/" + rawProfile.acquiredAttributes_AcquiredDOB_day.asString() + "/" + rawProfile.acquiredAttributes_AcquiredDOB_year.asString() ),",
        "",
        "        field("IDWScore", rawProfile.acquiredAttributes_IDWScore),",
        "        field("policyDecision", rawProfile.policyDecision_conclusion),",
        "        field("phone", rawProfile.userAttributes_InternationalTelephone_dialCode.asString() + rawProfile.userAttributes_InternationalTelephone_telephone.asString()),",
        "        field("username", userName )",
        "       //field("username", rawProfile.acquiredAttributes_AcquiredFullName_fname.asString() + "." + rawProfile.acquiredAttributes_AcquiredFullName_lname.asString() )",
        "",
        "   )",
        ")",
        "",
      ],
    },
    "2a076e9e-75a9-46b5-b971-10ffafbdf652": {
      "_id": "2a076e9e-75a9-46b5-b971-10ffafbdf652",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Return true if a goto param has been specified, false otherwise.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Goto Specified Decision",
      "script": [
        "/* Goto Specified Decision",
        " * ",
        " * Return true if a goto param has been specified, false otherwise.",
        " * ",
        " * This script does not require configuration. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * - false",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    logger.message("Goto Specified Decision: start");",
        "      outcome = "false";",
        "      var referer = parseUrl(requestHeaders.get("referer").get(0));",
        "      if (referer.searchParam.goto) {",
        "          outcome = "true";",
        "    }",
        "    logger.message("Goto Specified Decision: end [outcome={}]", outcome);",
        "",
        "    /*",
        "     * Parse a URL into its components and make them easily accessible by name",
        "     *",
        "     * Use in a Scripte Decision Node Script as follows:",
        "     * var referer = parseUrl(requestHeaders.get("referer").get(0));",
        "     * var origin = referer.origin;",
        "     * ",
        "     * e.g.: https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/",
        "     * {",
        "     *     hash: '#/',",
        "     *     host: 'openam-volker-dev.forgeblocks.com',",
        "     *     hostname: 'openam-volker-dev.forgeblocks.com',",
        "     *     href: 'https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/',",
        "     *     origin: 'https://openam-volker-dev.forgeblocks.com',",
        "     *     pathname: '/am/XUI/',",
        "     *     port: '',",
        "     *     protocol: 'https',",
        "     *     search: '?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim',",
        "     *     username: '',",
        "     *     password: '',",
        "     *     searchParam: {",
        "     *         realm: '/bravo',",
        "     *         authIndexType: 'service',",
        "     *         authIndexValue: 'InitiateOwnerClaim'",
        "     *     }",
        "     * }",
        "     */",
        "    function parseUrl(href) {",
        "        var m = href.match(/^(([^:\\/?#]+):?(?:\\/\\/((?:([^\\/?#:]*):([^\\/?#:]*)@)?([^\\/?#:]*)(?::([^\\/?#:]*))?)))?([^?#]*)(\\?[^#]*)?(#.*)?$/),",
        "        r = {",
        "            hash: m[10] || "",                      // #/",
        "            host: m[3] || "",                       // openam-volker-dev.forgeblocks.com",
        "            hostname: m[6] || "",                   // openam-volker-dev.forgeblocks.com",
        "            href: m[0] || "",                       // https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/",
        "            origin: m[1] || "",                     // https://openam-volker-dev.forgeblocks.com",
        "            pathname: m[8] || (m[1] ? "/" : ""),    // /am/XUI/",
        "            port: m[7] || "",                       // ",
        "            protocol: m[2] || "",                   // https",
        "            search: m[9] || "",                     // ?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim",
        "            username: m[4] || "",                   // ",
        "            password: m[5] || "",                   // ",
        "            searchParam: {}                         // { realm: '/bravo',",
        "                                                    //   authIndexType: 'service',",
        "                                                    //   authIndexValue: 'InitiateOwnerClaim' }",
        "        };",
        "        if (r.protocol.length == 2) {",
        "            r.protocol = "file:///" + r.protocol.toUpperCase();",
        "            r.origin = r.protocol + "//" + r.host;",
        "        }",
        "        if (r.search.length > 2) {",
        "            var query = (r.search.indexOf('?') === 0) ? r.search.substr(1) : r.search;",
        "            var vars = query.split('&');",
        "            for (var i = 0; i < vars.length; i++) {",
        "            var pair = vars[i].split('=');",
        "            r.searchParam[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1]);",
        "            }",
        "        }",
        "        r.href = r.origin + r.pathname + r.search + r.hash;",
        "        return r;",
        "    };",
        "}());",
      ],
    },
    "2aaa8076-5d0b-4433-9660-fec1ba51b608": {
      "_id": "2aaa8076-5d0b-4433-9660-fec1ba51b608",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "temp",
      "script": [
        "/*",
        "  - Data made available by nodes that have already executed are available in the sharedState variable.",
        "  - The script should set outcome to either "true" or "false".",
        " */",
        "outcome = "false";",
        "if(sharedState.get("userName"))",
        "{",
        "var username = sharedState.get("userName")",
        "var id = sharedState.get("_id")",
        "var persona = existingSession.get('persona')",
        "",
        "sharedState.put("debug",username);",
        "sharedState.put("debug_id",id);",
        "sharedState.put("persona",persona);",
        "",
        "if(username!=='')",
        "{",
        "  outcome = "true";",
        "}}",
        "",
      ],
    },
    "2ada53cd-5d37-4592-9c7f-5711271229c2": {
      "_id": "2ada53cd-5d37-4592-9c7f-5711271229c2",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Has Profile Changed",
      "script": [
        "logger.error("Has Profile Changed: start");",
        "outcome = "unchanged";",
        "if (getObjectAttribute("old_givenName") ||",
        "    getObjectAttribute("old_sn") ||",
        "    getObjectAttribute("frUnindexedString5") ||",
        "    getObjectAttribute("old_telephoneNumber")) {",
        "  outcome = "changed";",
        "}",
        "logger.error("Has Profile Changed: end [outcome=".concat(outcome).concat("]"));",
        "",
        "/*",
        " * Get objectAttribute value",
        " */",
        "function getObjectAttribute(name) {",
        "    if (sharedState.get("objectAttributes") && sharedState.get("objectAttributes").get(name)) {",
        "        return sharedState.get("objectAttributes").get(name).toString();",
        "    }",
        "    else {",
        "        return null;",
        "    }",
        "}",
      ],
    },
    "2eb48a0c-24e0-4dac-acaf-02085c142ec5": {
      "_id": "2eb48a0c-24e0-4dac-acaf-02085c142ec5",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Integration to Okta Authentication API okta_url/api/v1/authn",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Okta API AuthN",
      "script": [
        "/* Okta Passthru Authentication",
        " *",
        " * Authors: chico.demettroff@forgerock.com, volker.scheuber@forgerock.com",
        " * ",
        " * Okta pass through authentication using Okta Authentication API.",
        " * ",
        " * This script needs to be parametrized. It will not work properly as is. ",
        " * It requires the Platform Username and Platform Password collector nodes",
        " * before it can operate.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - Success",
        " * - Failure",
        " * - Timeout",
        " * - Error",
        " */",
        "logger.message("Okta Passthru Authentication: start");",
        "",
        "if (sharedState.get("username") && transientState.get("password")) {",
        "      /*",
        "     * BEGIN SCRIPT CONFIGURATION",
        "     *",
        "     * REPLACE WITH YOUR OWN OKTA TENANT SETTINGS",
        "     *",
        "     */",
        "    var OKTA_API_URI = "https://dev-18030933.okta.com/api/v1/authn/";",
        "    /*",
        "     * END SCRIPT CONFIGURATION",
        "     */",
        "",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setMethod('POST');",
        "    request.setUri(OKTA_API_URI);",
        "    request.getHeaders().add("Content-Type", "application/json");",
        "      //var body =     "{\\"username\\":".concat(sharedState.get("username")).concat(",\\"password\\":").concat(transientState.get("password")).concat(",\\"options\\":{\\"multiOptionalFactorEnroll\\":true,\\"warnBeforePasswordExpired\\":true}}");",
        "    var body = {",
        "        "username": sharedState.get("username"),",
        "        "password": transientState.get("password"),",
        "        "options": {",
        "            "multiOptionalFactorEnroll": true,",
        "            "warnBeforePasswordExpired": true",
        "        }",
        "    }",
        "      request.getEntity().setJson(body);",
        "",
        "    var response = httpClient.send(request).get();",
        "    var result = JSON.parse(response.getEntity().getString());",
        "    logger.message("Okta Passthru Authentication: JSON result: " + JSON.stringify(result));",
        "",
        "      if (response.getStatus().getCode() === 200 && result.status === "SUCCESS") {",
        "          outcome = "Success"",
        "        transientState.put("oktaProfile", result._embedded.user.profile);",
        "    } else {",
        "        /* Outcomes:",
        "         * - Success",
        "         * - Failure",
        "         * - Timeout",
        "         * - Error",
        "         *",
        "         * Expected/known Error Codes:",
        "         * E0000004 - Authentication failed.",
        "         * E0000003 - The request body was not well-formed",
        "         */",
        "      ",
        "    /*",
        "{",
        "    "expiresAt": "2021-10-14T22:15:04.000Z",",
        "    "status": "SUCCESS",",
        "    "sessionToken": "20111FNVseT3WyCzBHFBi3dYtx980FHen46QKlWXRNTe1kRef3GQu1W",",
        "    "_embedded": {",
        "        "user": {",
        "            "id": "00u1xqw851dEqM1Y15d7",",
        "            "passwordChanged": "2021-09-21T18:26:25.000Z",",
        "            "profile": {",
        "                "login": "chico@crossfithighvoltage.com",",
        "                "firstName": "chico",",
        "                "lastName": "deme",",
        "                "locale": "en",",
        "                "timeZone": "America/Los_Angeles"",
        "            }",
        "        }",
        "    },",
        "    "_links": {",
        "        "cancel": {",
        "            "href": "https://dev-18030933.okta.com/api/v1/authn/cancel",",
        "            "hints": {",
        "                "allow": [",
        "                    "POST"",
        "                ]",
        "            }",
        "        }",
        "    }",
        "}",
        "*/",
        "",
        "  /*",
        "  FAILED",
        "  {",
        "    "errorCode": "E0000004",",
        "    "errorSummary": "Authentication failed",",
        "    "errorLink": "E0000004",",
        "    "errorId": "oae1Y3Kk_WvRAOBSDeG9qeyHQ",",
        "    "errorCauses": []",
        "}",
        "*/",
        "        transientState.put("oktaResult", result);",
        "        if (result.timed_out) {",
        "            outcome = "Timeout";",
        "        } else if (result.errorCode === "E0000004") {",
        "            outcome = "Failure";",
        "        } else {",
        "            outcome = "Error";",
        "        }",
        "        logger.message("Okta Passthru Authentication: errorCode = ".concat(result.errorCode));",
        "        logger.message("Okta Passthru Authentication: errorSummary = ".concat(result.errorSummary));",
        "        logger.message("Okta Passthru Authentication: errorId = ".concat(result.errorId));",
        "    }",
        "} else {",
        "      outcome = "Error";",
        "      logger.message("Okta Passthru Authentication: No user or password found in shared state! Use username and password collector nodes before this script to populate shared and transient states!'");",
        "}",
        "logger.message("Okta Passthru Authentication: End (outcome=".concat(outcome).concat(")"));",
      ],
    },
    "312e951f-70c5-49d2-a9ae-93aef909d5df": {
      "_id": "312e951f-70c5-49d2-a9ae-93aef909d5df",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from Salesforce",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Salesforce Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "return json(object(",
        "        field("id", rawProfile.user_id),",
        "        field("displayName", rawProfile.name),",
        "        field("givenName", rawProfile.given_name),",
        "        field("familyName", rawProfile.family_name),",
        "        field("photoUrl", rawProfile.picture),",
        "        field("email", rawProfile.email),",
        "        field("username", rawProfile.email),",
        "        field("locale", rawProfile.zoneInfo)))",
      ],
    },
    "3156d7e9-1589-4ffb-a659-37a1647ee03d": {
      "_id": "3156d7e9-1589-4ffb-a659-37a1647ee03d",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Converts a normalized social profile coming from ADFS into a managed user",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Normalized ADFS Profile to Managed User",
      "script": [
        "/*",
        " * Copyright 2022 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "import org.forgerock.json.JsonValue",
        "",
        "JsonValue managedUser = json(object(",
        "        field("givenName", normalizedProfile.givenName),",
        "        field("sn", normalizedProfile.familyName),",
        "        field("mail", normalizedProfile.email),",
        "        field("userName", normalizedProfile.username)))",
        "",
        "if (normalizedProfile.postalAddress.isNotNull()) managedUser.put("postalAddress", normalizedProfile.postalAddress)",
        "if (normalizedProfile.addressLocality.isNotNull()) managedUser.put("city", normalizedProfile.addressLocality)",
        "if (normalizedProfile.addressRegion.isNotNull()) managedUser.put("stateProvince", normalizedProfile.addressRegion)",
        "if (normalizedProfile.postalCode.isNotNull()) managedUser.put("postalCode", normalizedProfile.postalCode)",
        "if (normalizedProfile.country.isNotNull()) managedUser.put("country", normalizedProfile.country)",
        "if (normalizedProfile.phone.isNotNull()) managedUser.put("telephoneNumber", normalizedProfile.phone)",
        "managedUser.put("accountStatus", (normalizedProfile.roles.asString() == "fidc-volker-dev-admins") ? 'Active' : 'Inactive')",
        "",
        "// if the givenName and familyName is null or empty",
        "// then add a boolean flag to the shared state to indicate names are not present",
        "// this could be used elsewhere",
        "// for eg. this could be used in a scripted decision node to by-pass patching",
        "// the user object with blank values when givenName  and familyName is not present",
        "boolean noGivenName = normalizedProfile.givenName.isNull() || (!normalizedProfile.givenName.asString()?.trim())",
        "boolean noFamilyName = normalizedProfile.familyName.isNull() || (!normalizedProfile.familyName.asString()?.trim())",
        "sharedState.put("nameEmptyOrNull", noGivenName && noFamilyName)",
        "",
        "return managedUser",
        "",
      ],
    },
    "3369037a-7a49-4aed-a1dc-7aab7608812b": {
      "_id": "3369037a-7a49-4aed-a1dc-7aab7608812b",
      "context": "OAUTH2_ACCESS_TOKEN_MODIFICATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Service Account - Token Modification",
      "script": [
        "(function () {",
        "  var fr = JavaImporter(",
        "    java.lang.String,",
        "    java.security.MessageDigest,",
        "    java.util.Arrays,",
        "    javax.crypto.Cipher,",
        "    javax.crypto.spec.SecretKeySpec,",
        "    org.forgerock.http.protocol.Request,",
        "    org.forgerock.http.protocol.Response,",
        "    org.forgerock.util.encode.Base64",
        "  );",
        "  ",
        "  var secret = 'FuwwVKpPER9tPSMYUiIkY7IaPzv85aGU';",
        "  ",
        "  function encrypt(str) {",
        "    try {",
        "      var key = new fr.String(secret).getBytes('UTF-8');",
        "      var sha = fr.MessageDigest.getInstance('SHA-256');",
        "      key = sha.digest(key);",
        "      key = fr.Arrays.copyOf(key, 32);",
        "      var secretKey = new fr.SecretKeySpec(key, 'AES');",
        "      var cipher = fr.Cipher.getInstance('AES/ECB/PKCS5Padding');",
        "      cipher.init(fr.Cipher.ENCRYPT_MODE, secretKey);",
        "      var finalBytes = cipher.doFinal(new fr.String(str).getBytes('UTF-8'));",
        "      return fr.Base64.encode(finalBytes);",
        "    } catch (e) {",
        "      logger.error('{}: failed to encrypt: {}', scriptName, e);",
        "      throw e;",
        "    }",
        "  }",
        "",
        "  function hasAmScope(scope) {",
        "    if (!scope) return false;",
        "    for (var i = 0; i < scope.length; i++) {",
        "      if (scope[i].indexOf('fr:am:') > -1) return true;",
        "    }",
        "    return false;",
        "  }",
        "",
        "  try {",
        "    var uri = 'http://am.fr-platform:80/am/json/authenticate?authIndexType=service&authIndexValue=FRServiceAccountInternal';",
        "    var requestParams = requestProperties.get('requestParams');",
        "",
        "    var scope = requestParams.get('scope');",
        "    if (!hasAmScope(scope)) {",
        "      logger.message('AM scope not requested');",
        "      return null;",
        "    }",
        "",
        "    var jwts = requestParams.get('assertion');",
        "    if (!jwts || jwts.isEmpty()) {",
        "      logger.message('No jwt assertion');",
        "      return null;",
        "    }",
        "",
        "    var jwt = jwts[0];",
        "    var uuid = identity.getAttribute('_id').iterator().next();",
        "",
        "    var request = new fr.Request();",
        "    request.getHeaders().add('authorization', 'svcacct ' + uuid + ' ' + jwt);",
        "    request.getHeaders().add('content-type', 'application/json');",
        "    request",
        "      .setUri(uri)",
        "      .setMethod('POST')",
        "      .setEntity('{}');",
        "",
        "    var response = httpClient.send(request).getOrThrow();",
        "    if (response.getStatus() === org.forgerock.http.protocol.Status.OK) {",
        "      var result = JSON.parse(response.getEntity().getString());",
        "      var encryptedTokenId = encrypt(result.tokenId);",
        "      accessToken.setField('sessionToken', encryptedTokenId);",
        "    } else {",
        "      logger.message('Failed to get session from service account tree (status: ' + response.getStatus() + ')');",
        "    }",
        "  } catch (e) {",
        "    throw ('Failed to modify service account token: ' + e);",
        "  }",
        "}());",
        "",
      ],
    },
    "355a8b7c-9e3c-40c1-a873-68127e483adf": {
      "_id": "355a8b7c-9e3c-40c1-a873-68127e483adf",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Extract Username from request.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "KerberosLogin: Extract Username",
      "script": [
        "/* KerberosLogin: Extract Username",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * - false",
        " */",
        "",
        "logger.warning("KerberosLogin: Extract Username: start");",
        "outcome = "false";",
        "",
        "/*",
        " * BEGIN SCRIPT CONFIGURATION",
        " */",
        "var USERNAME_HEADER_NAME = "X-OpenAM-Username";",
        "/*",
        " * END SCRIPT CONFIGURATION",
        " */",
        "",
        "var username = getHeader(USERNAME_HEADER_NAME);",
        "if (username) {",
        "    ",
        "      outcome = "true";",
        "    sharedState.put("username", username);",
        "    setSharedObjectAttribute("userName", username);",
        "}",
        "",
        "logger.warning("KerberosLogin: Extract Username: finish [outcome=".concat(outcome).concat("]"));",
        "",
        "/*",
        " * Returns the value of the requested header",
        " */",
        "function getHeader(headerName) {",
        "      if (requestHeaders.get(headerName) && requestHeaders.get(headerName).get(0)) {",
        "        return requestHeaders.get(headerName).get(0).toString();",
        "    }",
        "      return null;",
        "}",
        "",
        "/*",
        " * Store attributes in shared state for use with the Create/Patch Object nodes.",
        " */",
        "function setSharedObjectAttribute(name, value) {",
        "       var storage = sharedState.get("objectAttributes");",
        "    if (storage && value) {",
        "          if (storage.put) {",
        "              storage.put(name, value);",
        "        }",
        "          else {",
        "              storage[name] = value;",
        "        }",
        "    }",
        "    else if (value) {",
        "        sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "    }",
        "}",
      ],
    },
    "36863ffb-40ec-48b9-94b1-9a99f71cc3b5": {
      "_id": "36863ffb-40ec-48b9-94b1-9a99f71cc3b5",
      "context": "OIDC_CLAIMS",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Default global script for OIDC claims",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "OIDC Claims Script",
      "script": [
        "/*",
        " * Copyright 2014-2021 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        " * This script computes claim values returned in ID tokens and/or at the UserInfo Endpoint.",
        " * The claim values are computed for:",
        " * the claims derived from the requested scopes,",
        " * the claims provided by the authorization server,",
        " * and the claims requested by the client via the claims parameter.",
        " *",
        " * In the CONFIGURATION AND CUSTOMIZATION section, you can",
        " * define the scope-to-claims mapping, and",
        " * assign to each claim a resolver function that will compute the claim value.",
        " *",
        " * Defined variables (class references are provided below):",
        " * scopes - Set<String> (6).",
        " *          Always present, the requested scopes.",
        " * claims - Map<String, Object> (5).",
        " *          Always present, default server provided claims.",
        " * claimObjects - List<Claim> (7, 2).",
        " *                Always present, the default server provided claims.",
        " * requestedClaims - Map<String, Set<String>> (5).",
        " *                   Always present, not empty if the request contains the claims parameter and the server has enabled",
        " *                   claims_parameter_supported. A map of the requested claims to possible values, otherwise empty;",
        " *                   requested claims with no requested values will have a key but no value in the map. A key with",
        " *                   a single value in its Set (6) indicates that this is the only value that should be returned.",
        " * requestedTypedClaims - List<Claim> (7, 2).",
        " *                        Always present, the requested claims.",
        " *                        Requested claims with no requested values will have a claim with no values.",
        " *                        A claim with a single value indicates this is the only value that should be returned.",
        " * claimsLocales - List<String> (7).",
        " *                 The values from the 'claims_locales' parameter.",
        " *                 See https://openid.net/specs/openid-connect-core-1_0.html#ClaimsLanguagesAndScripts for the OIDC specification details.",
        " * requestProperties - Unmodifiable Map (5).",
        " *                     Always present, contains a map of request properties:",
        " *                     requestUri - The request URI.",
        " *                     realm - The realm that the request relates to.",
        " *                     requestParams - A map of the request params and/or posted data.",
        " *                                     Each value is a list of one or more properties.",
        " *                                     Please note that these should be handled in accordance with OWASP best practices:",
        " *                                     https://owasp.org/www-community/vulnerabilities/Unsafe_use_of_Reflection.",
        " * clientProperties - Unmodifiable Map (5).",
        " *                    Present if the client specified in the request was identified, contains a map of client properties:",
        " *                    clientId - The client's URI for the request locale.",
        " *                    allowedGrantTypes - List of the allowed grant types (org.forgerock.oauth2.core.GrantType) for the client.",
        " *                    allowedResponseTypes - List of the allowed response types for the client.",
        " *                    allowedScopes - List of the allowed scopes for the client.",
        " *                    customProperties - A map of the custom properties of the client.",
        " *                                       Lists or maps will be included as sub-maps; for example:",
        " *                                       customMap[Key1]=Value1 will be returned as customMap -> Key1 -> Value1.",
        " *                                       To add custom properties to a client, update the Custom Properties field",
        " *                                       in AM Console > Realm Name > Applications > OAuth 2.0 > Clients > Client ID > Advanced.",
        " * identity - AMIdentity (3).",
        " *            Always present, the identity of the resource owner.",
        " * session - SSOToken (4).",
        " *           Present if the request contains the session cookie, the user's session object.",
        " * scriptName - String (primitive).",
        " *              Always present, the display name of the script.",
        " * logger - Always present, the "OAuth2Provider" debug logger instance:",
        " *          https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.",
        " *          Corresponding files will be prefixed with: scripts.OIDC_CLAIMS.",
        " * httpClient - HTTP Client (8).",
        " *              Always present, the HTTP Client instance:",
        " *              https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-http-client.html#scripting-api-global-http-client.",
        " *              In order to use the client, you may need to add",
        " *              org.forgerock.http.Client,",
        " *              org.forgerock.http.protocol.*,",
        " *              and org.forgerock.util.promise.PromiseImpl",
        " *              to the allowed Java classes in the scripting engine configuration, as described in:",
        " *              https://backstage.forgerock.com/docs/am/7/scripting-guide/script-engine-security.html",
        " *",
        " * Return - a new UserInfoClaims(Map<String, Object> values, Map<String, List<String>> compositeScopes) (1) object.",
        " *          The result of the last statement in the script is returned to the server.",
        " *          Currently, the Immediately Invoked Function Expression (also known as Self-Executing Anonymous Function)",
        " *          is the last (and only) statement in this script, and its return value will become the script result.",
        " *          Do not use "return variable" statement outside of a function definition.",
        " *          See RESULTS section for additional details.",
        " *",
        " * Class reference:",
        " * (1) UserInfoClaims - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html.",
        " * (2) Claim - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html).",
        " *         An instance of org.forgerock.openidconnect.Claim has methods to access",
        " *         the claim name, requested values, locale, and whether the claim is essential.",
        " * (3) AMIdentity - https://backstage.forgerock.com/docs/am/7/apidocs/com/sun/identity/idm/AMIdentity.html.",
        " * (4) SSOToken - https://backstage.forgerock.com/docs/am/7/apidocs/com/iplanet/sso/SSOToken.html.",
        " * (5) Map - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashMap.html,",
        " *           or https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/LinkedHashMap.html.",
        " * (6) Set - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashSet.html.",
        " * (7) List - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/ArrayList.html.",
        " * (8) Client - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/http/Client.html.",
        "*/",
        "",
        "(function () {",
        "    // SETUP",
        "",
        "    /**",
        "     * Claim processing utilities.",
        "     * An object that contains reusable functions for processing claims.",
        "     * @see CLAIM PROCESSING UTILITIES section for details.",
        "     */",
        "    var utils = getUtils();",
        "",
        "    // CONFIGURATION AND CUSTOMIZATION",
        "",
        "    /**",
        "     * OAuth 2.0 scope values (scopes) can be used by the Client to request OIDC claims.",
        "     *",
        "     * Call this configuration method, and pass in as the first argument",
        "     * an object that maps a scope value to an array of claim names",
        "     * to specify which claims need to be processed and returned for the requested scopes.",
        "     * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#ScopeClaims}",
        "     * for the scope values that could be used to request claims as defined in the OIDC specification.",
        "     *",
        "     * Below, find a default configuration that is expected to work in the current environment.",
        "     *",
        "     * CUSTOMIZATION",
        "     * You can choose the claim names returned for a scope.",
        "     */",
        "    utils.setScopeClaimsMap({",
        "        profile: [",
        "            'name',",
        "            'family_name',",
        "            'given_name',",
        "            'zoneinfo',",
        "            'locale'",
        "        ],",
        "        email: ['email'],",
        "        address: ['address'],",
        "        phone: ['phone_number']",
        "    });",
        "",
        "    /**",
        "     * In this script, each claim",
        "     * derived from the requested scopes,",
        "     * provided by the authorization server, and",
        "     * requested by the client via the claims parameter",
        "     * will be processed by a function associated with the claim name.",
        "     *",
        "     * Call this configuration method, and pass in as the first argument",
        "     * an object that maps a claim name to a resolver function,",
        "     * which will be automatically executed for each claim processed by the script.",
        "     *",
        "     * The claim resolver function will receive the requested claim information",
        "     * in an instance of org.forgerock.openidconnect.Claim as the first argument.",
        "     * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html}",
        "     * for details on the Claim class.",
        "     *",
        "     * If the claim resolver function returns a value,",
        "     * other than undefined or null,",
        "     * the claim will be included in the script's results.",
        "     *",
        "     * The Claim instance provides methods to check",
        "     * what the name of the claim is,",
        "     * which values the claim request contains,",
        "     * whether the claim is essential, and",
        "     * which locale the claim is associated with.",
        "     * The resolver function can consider this information when computing and returning the claim value.",
        "     *",
        "     * Below, find a default configuration that is expected to work in the current environment.",
        "     * A reusable function, utils.getUserProfileClaimResolver(String attribute-name),",
        "     * is called to return a claim resolver function based on a user profile attribute.",
        "     * @see CLAIM RESOLVERS section for the implementation details and examples.",
        "     * For the address claim, an example of a claim resolver that uses another claim resolver is provided.",
        "     *",
        "     * CUSTOMIZATION",
        "     * You can reuse the predefined utils methods with your custom arguments.",
        "     * You can also specify a custom resolver function for a claim name,",
        "     * that will compute and return the claim value—as shown in the commented out example below.",
        "     */",
        "    utils.setClaimResolvers({",
        "        /*",
        "        // An example of a simple claim resolver function that is defined for a claim",
        "        // directly in the configuration object:",
        "        custom-claim-name: function (requestedClaim) {",
        "            // In this case, initially, the claim value comes straight from a user profile attribute value:",
        "            var claimValue = identity.getAttribute('custom-attribute-name').toArray()[0]",
        "",
        "            // Optionally, provide additional logic for processing (filtering, formatting, etc.) the claim value.",
        "            // You can use:",
        "            // requestedClaim.getName()",
        "            // requestedClaim.getValues()",
        "            // requestedClaim.getLocale()",
        "            // requestedClaim.isEssential()",
        "",
        "            return claimValue",
        "        },",
        "        */",
        "        /**",
        "         * The use of utils.getUserProfileClaimResolver shows how",
        "         * an argument passed to a function that returns a claim resolver",
        "         * becomes available to the resolver function (via its lexical context).",
        "         */",
        "        name: utils.getUserProfileClaimResolver('cn'),",
        "        family_name: utils.getUserProfileClaimResolver('sn'),",
        "        given_name: utils.getUserProfileClaimResolver('givenname'),",
        "        zoneinfo: utils.getUserProfileClaimResolver('preferredtimezone'),",
        "        locale: utils.getUserProfileClaimResolver('preferredlocale'),",
        "        email: utils.getUserProfileClaimResolver('mail'),",
        "        address: utils.getAddressClaimResolver(",
        "            /**",
        "             * The passed in user profile claim resolver function",
        "             * can be used by the address claim resolver function",
        "             * to obtain the claim value to be formatted as per the OIDC specification:",
        "             * @see https://openid.net/specs/openid-connect-core-1_0.html#AddressClaim.",
        "             */",
        "            utils.getUserProfileClaimResolver('postaladdress')",
        "        ),",
        "        phone_number: utils.getUserProfileClaimResolver('telephonenumber')",
        "    });",
        "",
        "    // CLAIM PROCESSING UTILITIES",
        "",
        "    /**",
        "     * @returns {object} An object that contains reusable claim processing utilities.",
        "     * @see PUBLIC METHODS section and the return statement for the list of exported functions.",
        "     */",
        "    function getUtils () {",
        "        // IMPORT JAVA",
        "",
        "        /**",
        "         * Provides Java scripting functionality.",
        "         * @see {@link https://developer.mozilla.org/en-US/docs/Mozilla/Projects/Rhino/Scripting_Java#javaimporter_constructor}.",
        "         */",
        "        var frJava = JavaImporter(",
        "            org.forgerock.oauth2.core.exceptions.InvalidRequestException,",
        "            org.forgerock.oauth2.core.UserInfoClaims,",
        "            org.forgerock.openidconnect.Claim,",
        "",
        "            java.util.LinkedHashMap,",
        "            java.util.ArrayList",
        "        );",
        "",
        "        // SET UP CONFIGURATION",
        "",
        "        /**",
        "         * Placeholder for a configuration option that contains",
        "         * an object that maps the supported scope values (scopes)",
        "         * and the corresponding claim names for each scope value.",
        "         */",
        "        var scopeClaimsMap;",
        "",
        "        /**",
        "         * Placeholder for a configuration option that contains",
        "         * an object that maps the supported claim names",
        "         * and the resolver functions returning the claim value.",
        "         */",
        "        var claimResolvers;",
        "",
        "        /**",
        "         * A (public) method that accepts an object that maps the supported scopes and the corresponding claim names,",
        "         * and assigns it to a (private) variable that serves as a configuration option.",
        "         * @param {object} params - An object that maps each supported scope value to an array of claim names,",
        "         * in order to specify which claims need to be processed for the requested scopes.",
        "         * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#ScopeClaims} for details.",
        "         * @param {string[]} [params.profile] - An array of claim names to be returned if the profile scope is requested.",
        "         * @param {string[]} [params.email] - An array of claim names to be returned if the email scope is requested.",
        "         * @param {string[]} [params.address] - An array of claim names to be returned if the address scope is requested.",
        "         * @param {string[]} [params.phone] - An array of claim names to be returned if the phone scope is requested.",
        "         * @returns {undefined}",
        "         */",
        "        function setScopeClaimsMap(params) {",
        "            scopeClaimsMap = params;",
        "        }",
        "",
        "        /**",
        "         * A (public) method that accepts an object that maps the supported claim names",
        "         * and the resolver functions returning the claim value,",
        "         * and assigns it to a (private) variable that serves as a configuration option.",
        "         * @param {object} params - An object that maps",
        "         * each supported claim name to a function that computes and returns the claim value.",
        "         */",
        "        function setClaimResolvers(params) {",
        "            claimResolvers = params;",
        "        }",
        "",
        "        // CLAIM RESOLVERS",
        "",
        "        /**",
        "         * Claim resolvers are functions that return a claim value.",
        "         * @param {*}",
        "         * @returns {*}",
        "         */",
        "",
        "        /**",
        "         * Defines a claim resolver based on a user profile attribute.",
        "         * @param {string} attributeName - Name of the user profile attribute.",
        "         * @returns {function} A function that will determine the claim value",
        "         * based on the user profile attribute and the (requested) claim properties.",
        "         */",
        "        function getUserProfileClaimResolver (attributeName) {",
        "            /**",
        "             * Resolves a claim with a user profile attribute value.",
        "             * Returns undefined if the identity attribute is not populated,",
        "             * OR if the claim has requested values that do not contain the identity attribute value.",
        "             * ATTENTION: the aforementioned comparison is case-sensitive.",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {string|HashSet|undefined}",
        "             */",
        "            function resolveClaim(claim) {",
        "                var userProfileValue;",
        "",
        "                if (identity) {",
        "                    userProfileValue = getClaimValueFromSet(claim, identity.getAttribute(attributeName));",
        "",
        "                    if (userProfileValue && !userProfileValue.isEmpty()) {",
        "                        if (!claim.getValues() || claim.getValues().isEmpty() || claim.getValues().contains(userProfileValue)) {",
        "                            return userProfileValue;",
        "                        }",
        "                    }",
        "                }",
        "            }",
        "",
        "            return resolveClaim;",
        "        }",
        "",
        "        /**",
        "         * Returns an address claim resolver based on a claim value obtained with another claim resolver.",
        "         * @param {function} resolveClaim - A function that returns a claim value.",
        "         * @returns {function} A function that will accept a claim as an argument,",
        "         * run the claim resolver function for the claim and obtain the claim value,",
        "         * and apply additional formatting to the value before returning it.",
        "         */",
        "        function getAddressClaimResolver (resolveClaim) {",
        "            /**",
        "             * Creates an address claim object from a value returned by a claim resolver,",
        "             * and returns the address claim object as the claim value.",
        "             * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#AddressClaim}.",
        "             * The claim value is obtained with a claim resolving function available from the closure.",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {java.util.LinkedHashMap|undefined} The address claim object created from a claim value.",
        "             */",
        "            function resolveAddressClaim(claim) {",
        "                var claimValue = resolveClaim(claim);",
        "                var addressObject;",
        "",
        "                if (isClaimValueValid(claimValue)) {",
        "                    addressObject = new frJava.LinkedHashMap();",
        "",
        "                    addressObject.put('formatted', claimValue);",
        "",
        "                    return addressObject;",
        "                }",
        "            }",
        "",
        "            return resolveAddressClaim;",
        "        }",
        "",
        "        /**",
        "         * Returns an essential claim resolver based on a claim value obtained with another claim resolver.",
        "         * @param {function} resolveClaim - A function that returns a claim value.",
        "         * @returns {function} A function that will accept a claim as an argument,",
        "         * run the claim resolver function for the claim and obtain the claim value,",
        "         * and apply additional logic for essential claims.",
        "         */",
        "        function getEssentialClaimResolver (resolveClaim) {",
        "            /**",
        "             * Returns a claim value or throws an error.",
        "             * The claim value is obtained with a claim resolving function available from the closure.",
        "             * Throws an exception if the claim is essential and no value is returned for the claim.",
        "             *",
        "             * Use of this resolver is optional.",
        "             * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#IndividualClaimsRequests} stating:",
        "             * "Note that even if the Claims are not available because the End-User did not authorize their release or they are not present,",
        "             * the Authorization Server MUST NOT generate an error when Claims are not returned, whether they are Essential or Voluntary,",
        "             * unless otherwise specified in the description of the specific claim."",
        "             *",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {*}",
        "             * @throws {org.forgerock.oauth2.core.exceptions.InvalidRequestException}",
        "             */",
        "            function resolveEssentialClaim(claim) {",
        "                var claimValue = resolveClaim(claim);",
        "",
        "                if (claim.isEssential() && !isClaimValueValid(claimValue)) {",
        "                    throw new frJava.InvalidRequestException('Could not provide value for essential claim: ' + claim.getName());",
        "                }",
        "",
        "                return claimValue;",
        "            }",
        "",
        "            return resolveEssentialClaim;",
        "        }",
        "",
        "        /**",
        "         * Provides default resolution for a claim.",
        "         * Use it if a claim-specific resolver is not defined in the configuration.",
        "         * @param {org.forgerock.openidconnect.Claim} claim",
        "         * An object that provides methods to obtain information/requirements associated with a claim.",
        "         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "         * @returns {*} A single value associated with this claim.",
        "         */",
        "        function resolveAnyClaim (claim) {",
        "            if (claim.getValues().size() === 1) {",
        "                return claim.getValues().toArray()[0];",
        "            }",
        "        }",
        "",
        "        // UTILITIES",
        "",
        "        /**",
        "         * Returns claim value from a set.",
        "         * If the set contains a single value, returns the value.",
        "         * If the set contains multiple values, returns the set.",
        "         * Otherwise, returns undefined.",
        "         *",
        "         * @param {org.forgerock.openidconnect.Claim} claim",
        "         * An object that provides methods to obtain information/requirements associated with a claim.",
        "         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "         * @param {java.util.HashSet} set The set—for example, a user profile attribute value.",
        "         * @returns {string|java.util.HashSet|undefined}",
        "         */",
        "        function getClaimValueFromSet (claim, set) {",
        "            if (set && set.size()) {",
        "                if (set.size() === 1) {",
        "                    return set.toArray()[0];",
        "                } else {",
        "                    return set;",
        "                }",
        "            } else if (logger.warningEnabled()) {",
        "                logger.warning('OIDC Claims script. Got an empty set for claim: ' + claim.getName());",
        "            }",
        "        }",
        "",
        "        function isClaimValueValid (claimValue) {",
        "            if (typeof claimValue === 'undefined' || claimValue === null) {",
        "                return false;",
        "            }",
        "",
        "            return true;",
        "        }",
        "",
        "        // CLAIM PROCESSING",
        "",
        "        /**",
        "         * Constructs and returns an object populated with the computed claim values",
        "         * and the requested scopes mapped to the claim names.",
        "         * @returns {org.forgerock.oauth2.core.UserInfoClaims} The object to be returned to the authorization server.",
        "         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html}.",
        "         * @see RESULTS section for the use of this function.",
        "         */",
        "        function getUserInfoClaims () {",
        "            return new frJava.UserInfoClaims(getComputedClaims(), getCompositeScopes());",
        "        }",
        "",
        "        /**",
        "         * Creates a map of (requested) claim names populated with the computed claim values.",
        "         * @returns {java.util.LinkedHashMap}",
        "         * A map of the requested claim names and the corresponding claim values.",
        "         */",
        "        function getComputedClaims () {",
        "            /**",
        "             * Creates a complete list of claim objects from:",
        "             * the claims derived from the scopes,",
        "             * the claims provided by the authorization server,",
        "             * and the claims requested by the client.",
        "             * @returns {java.util.ArrayList}",
        "             * Returns a complete list of org.forgerock.openidconnect.Claim objects available to the script.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for the claim object details.",
        "             */",
        "            function getClaims() {",
        "                /**",
        "                 * Returns a list of claim objects for the requested scopes.",
        "                 * Uses the scopeClaimsMap configuration option to derive the claim names;",
        "                 * no other properties of a claim derived from a scope are populated.",
        "                 * @returns {java.util.ArrayList}",
        "                 * A list of org.forgerock.openidconnect.Claim objects derived from the requested scopes.",
        "                 * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for the claim object details.",
        "                 */",
        "                function convertScopeToClaims() {",
        "                    var claims = new frJava.ArrayList();",
        "",
        "                    scopes.toArray().forEach(function (scope) {",
        "                        if (String(scope) !== 'openid' && scopeClaimsMap[scope]) {",
        "                            scopeClaimsMap[scope].forEach(function (claimName) {",
        "                                claims.add(new frJava.Claim(claimName));",
        "                            });",
        "                        }",
        "                    });",
        "",
        "                    return claims;",
        "                }",
        "",
        "                var claims = new frJava.ArrayList();",
        "",
        "                claims.addAll(convertScopeToClaims());",
        "                claims.addAll(claimObjects);",
        "                claims.addAll(requestedTypedClaims);",
        "",
        "                return claims;",
        "            }",
        "",
        "            /**",
        "             * Computes and returns a claim value.",
        "             * To obtain the claim value, uses the resolver function specified for the claim in the claimResolvers configuration object.",
        "             * @see claimResolvers",
        "             * If no resolver function is found, uses the default claim resolver function.",
        "             *",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {*} Claim value.",
        "             * @throws {org.forgerock.oauth2.core.exceptions.InvalidRequestException}",
        "             * Rethrows this exception if a claim resolver throws it.",
        "             * You can throw org.forgerock.oauth2.core.exceptions.InvalidRequestException from your custom claim resolver",
        "             * if you want to terminate the claim processing.",
        "             */",
        "            function computeClaim(claim) {",
        "                var resolveClaim;",
        "                var message;",
        "",
        "                try {",
        "                    resolveClaim = claimResolvers[claim.getName()] || resolveAnyClaim;",
        "",
        "                    return resolveClaim(claim);",
        "                } catch (e) {",
        "                    message = 'OIDC Claims script exception. Unable to resolve OIDC Claim. ' + e;",
        "",
        "                    if (String(e).indexOf('org.forgerock.oauth2.core.exceptions.InvalidRequestException') !== -1) {",
        "                        throw e;",
        "                    }",
        "",
        "                    if (logger.warningEnabled()) {",
        "                        logger.warning(message);",
        "                    }",
        "                }",
        "            }",
        "",
        "            var computedClaims = new frJava.LinkedHashMap();",
        "",
        "            getClaims().toArray().forEach(function (claim) {",
        "                var claimValue = computeClaim(claim);",
        "",
        "                if (isClaimValueValid(claimValue)) {",
        "                    computedClaims.put(claim.getName(), claimValue);",
        "                } else {",
        "                    /**",
        "                     * If a claim has been processed, but appears in the list again,",
        "                     * and its value cannot be computed under the new conditions,",
        "                     * the claim is removed from the final result.",
        "                     *",
        "                     * For example, a claim could be mapped to a scope and found in the user profile,",
        "                     * but also requested by the client with required values that don't match the computed one.",
        "                     * @see {link https://openid.net/specs/openid-connect-core-1_0.html#IndividualClaimsRequests}.",
        "                     * for the relevant OIDC specification details.",
        "                     */",
        "                    computedClaims.remove(claim.getName());",
        "                }",
        "            });",
        "",
        "            return computedClaims;",
        "        }",
        "",
        "        /**",
        "         * Creates a map of requested scopes and the corresponding claim names.",
        "         * @returns {java.util.LinkedHashMap}",
        "         */",
        "        function getCompositeScopes () {",
        "            var compositeScopes = new frJava.LinkedHashMap();",
        "",
        "            scopes.toArray().forEach(function (scope) {",
        "                var scopeClaims = new frJava.ArrayList();",
        "",
        "                if (scopeClaimsMap[scope]) {",
        "                    scopeClaimsMap[scope].forEach(function (claimName) {",
        "                        scopeClaims.add(claimName);",
        "                    });",
        "                }",
        "",
        "                if (scopeClaims.size()) {",
        "                    compositeScopes.put(scope, scopeClaims);",
        "                }",
        "            });",
        "",
        "            return compositeScopes;",
        "        }",
        "",
        "        // PUBLIC METHODS",
        "",
        "        return {",
        "            setScopeClaimsMap: setScopeClaimsMap,",
        "            setClaimResolvers: setClaimResolvers,",
        "            getUserProfileClaimResolver: getUserProfileClaimResolver,",
        "            getAddressClaimResolver: getAddressClaimResolver,",
        "            getEssentialClaimResolver: getEssentialClaimResolver,",
        "            getUserInfoClaims: getUserInfoClaims",
        "        };",
        "    }",
        "",
        "    // RESULTS",
        "",
        "    /**",
        "     * This script returns an instance of the org.forgerock.oauth2.core.UserInfoClaims class",
        "     * populated with the computed claim values and",
        "     * the requested scopes mapped to the claim names.",
        "     * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html}.",
        "     *",
        "     * Assigning it to a variable gives you an opportunity",
        "     * to log the content of the returned value during development.",
        "     */",
        "    var userInfoClaims = utils.getUserInfoClaims();",
        "",
        "    /*",
        "    logger.error(scriptName + ' results:')",
        "    logger.error('Values: ' + userInfoClaims.getValues())",
        "    logger.error('Scopes: ' + userInfoClaims.getCompositeScopes())",
        "    */",
        "",
        "    return userInfoClaims;",
        "}());",
        "",
      ],
    },
    "37bf200a-158f-4a45-8ee5-81516e4593f8": {
      "_id": "37bf200a-158f-4a45-8ee5-81516e4593f8",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Display session info.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Display Session Info",
      "script": [
        "/* Display Session Info",
        " * ",
        " * Display Session Info.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    outcome = "true";",
        "",
        "    var anchor = "anchor-".concat(generateNumericToken('xxx'));",
        "    var halign = "left";",
        "",
        "    var choices = [];",
        "      var defaultChoice = 0;",
        "  ",
        "      var include = ["org","idp","saas","profileType","givenName","sn","mail","roles","userName","UserId","Locale","authInstant","AuthLevel","Host","Service"];",
        "    var message = "";",
        "    if (typeof existingSession !== "undefined") {",
        "          message = "<h4>Session Info</h4><p style=\\"font-family:courier;\\">";",
        "          include.forEach(function (key) {",
        "              message += "<b>" + key + "</b>: " + existingSession.get(key) + "<br/>";",
        "        });",
        "         message += "</p><p style=\\"font-size:70%;font-family:courier;\\">"",
        "          var entries = existingSession.keySet().toArray();",
        "        entries.forEach(function (key) {",
        "              if (include.indexOf(""+key)===-1) {",
        "                message += "<b>" + key + "</b>: " + existingSession.get(key) + "<br/>";",
        "            }",
        "        });",
        "         message += "</p>"",
        "          choices.push("Goto SAML App");",
        "          choices.push("Goto OIDC App");",
        "          if (""+existingSession.get("profileType") === "persistent") {",
        "              choices.push("Goto Profile Page");",
        "        }",
        "          choices.push("Logout");",
        "    } else {",
        "          message = "<h4>No Session!</h4><p>"",
        "          choices.push("Login");",
        "    }",
        "    var script = "Array.prototype.slice.call(\\n".concat(",
        "      "document.getElementsByClassName('callback-component')).forEach(\\n").concat(",
        "      "function (e) {\\n").concat(",
        "      "  var message = e.firstElementChild;\\n").concat(",
        "      "  if (message.firstChild && message.firstChild.nodeName == '#text' && message.firstChild.nodeValue.trim() == '").concat(anchor).concat("') {\\n").concat(",
        "      "    message.className = \\"\\";\\n").concat(",
        "      "    message.style = \\"text-align: left; inline-size: 430px; overflow-wrap: break-word;\\";\\n").concat(",
        "      "    message.align = \\"").concat(halign).concat("\\";\\n").concat(",
        "      "    message.innerHTML = '").concat(message).concat("';\\n").concat(",
        "      "  }\\n").concat(",
        "      "})")",
        "  ",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "        javax.security.auth.callback.TextOutputCallback,",
        "        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback,",
        "        javax.security.auth.callback.ConfirmationCallback",
        "    )",
        "    if (callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "            new fr.TextOutputCallback(",
        "                fr.TextOutputCallback.INFORMATION,",
        "                anchor",
        "            ),",
        "            new fr.ScriptTextOutputCallback(script),",
        "            new fr.ConfirmationCallback(",
        "                fr.ConfirmationCallback.INFORMATION,",
        "                choices,",
        "                defaultChoice",
        "            )",
        "        ).build()",
        "    }",
        "    else {",
        "      outcome = choices[callbacks.get(2).getSelectedIndex()];",
        "      action = fr.Action.goTo(outcome).build();",
        "    }",
        "",
        "     /*",
        "      * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "      * ",
        "      * Example:",
        "      * 'xxxxx' produces '28535'",
        "      * 'xxx-xxx' produces '432-521'",
        "      */",
        "    function generateNumericToken(format) {",
        "        return format.replace(/[x]/g, function(c) {",
        "            var r = Math.random()*10|0;",
        "            var v = r;",
        "            return v.toString(10);",
        "        });",
        "    }",
        "}());",
        "",
        "/*",
        "Locale: en_US",
        "authInstant: 2021-09-25T17:28:38Z",
        "Organization: o=alpha,ou=services,ou=am-config",
        "mail: volker@scheuber.name",
        "Principals: volker@scheuber.name",
        "UserProfile: Ignore",
        "CharSet: UTF-8",
        "FullLoginURL: /am/UI/Login?code=4%2F0AX4XfWjiEfbrfIstsFUKoaibPCQmTbuPonLfuhpYhjfj-N5QEe9u2P5Os9wNadGaPsQVBA&scope=email+profile+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.email+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.profile+openid&realm=%2Falpha&state=fykprtfmeclrgwszmomvqxnlirrehcs&hd=scheuber.name&prompt=none&authuser=2",
        "clientType: genericHTML",
        "goto: /am/XUI/?realm=/alpha&authIndexType=service&authIndexValue=SessionInfo&ForceAuth=true#/",
        "AMCtxId: d3188938-d07e-4134-95db-f1cc97fc6c40-503275",
        "loginURL: /am/UI/Login",
        "sn: Scheuber",
        "amlbcookie: 01",
        "HostName: 99.72.28.182",
        "UserToken: volker@scheuber.name",
        "givenName: Volker",
        "successURL: /am/XUI/?realm=/alpha&authIndexType=service&authIndexValue=SessionInfo&ForceAuth=true#/",
        "Service: Router",
        "Host: 99.72.28.182",
        "AuthLevel: 0",
        "idp: google",
        "UserId: volker@scheuber.name",
        "sun.am.UniversalIdentifier: id=volker@scheuber.name,ou=user,o=alpha,ou=services,ou=am-config",
        "OidcSid: ACuTQIObj0tajPYhLOjMlWc2urM",
        "Principal: id=volker@scheuber.name,ou=user,o=alpha,ou=services,ou=am-config",
        " */",
      ],
    },
    "3814d347-a2f2-4be9-a810-ab41a1e374bd": {
      "_id": "3814d347-a2f2-4be9-a810-ab41a1e374bd",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Hide buttons on the journey page.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Remove Button - imported (1)",
      "script": [
        "/* Remove Button",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Hide buttons on the journey page.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "(function () {",
        "    var script = "Array.prototype.slice.call(document.getElementsByTagName('button')).forEach(function (e) {e.style.display = 'none'})"",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "        javax.security.auth.callback.TextOutputCallback,",
        "        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        "    )",
        "    var message = " "",
        "    if (callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "            new fr.TextOutputCallback(",
        "                fr.TextOutputCallback.INFORMATION,",
        "                message",
        "            ),",
        "            new fr.ScriptTextOutputCallback(script)",
        "        ).build()",
        "    }",
        "}());",
      ],
    },
    "38f698de-fe11-43d2-8480-44e1312d121d": {
      "_id": "38f698de-fe11-43d2-8480-44e1312d121d",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "FRAAS-7955 Both States",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "FRAAS-7955 Both States",
      "script": [
        "outcome = "true";",
        "",
        "setSharedObjectAttribute("userName", "FRAAS-7955");",
        "setSharedObjectAttribute("givenName", "First-shared");",
        "setSharedObjectAttribute("sn", "Last-shared");",
        "setSharedObjectAttribute("mail", "first.last-shared@company.com");",
        "",
        "setTransientObjectAttribute("userName", "FRAAS-7955");",
        "setTransientObjectAttribute("givenName", "First-transient");",
        "setTransientObjectAttribute("sn", "Last-transient");",
        "setTransientObjectAttribute("mail", "first.last-transient@company.com");",
        "",
        "/*",
        " * Store attributes in shared state for use with the Create/Patch Object nodes.",
        " */",
        "function setSharedObjectAttribute(name, value) {",
        "       var storage = sharedState.get("objectAttributes");",
        "    if (storage && value) {",
        "          if (storage.put) {",
        "              storage.put(name, value);",
        "        }",
        "          else {",
        "              storage[name] = value;",
        "        }",
        "    }",
        "    else if (value) {",
        "        sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "    }",
        "}",
        "",
        "/*",
        " * Store attributes in transient state for use with the Create/Patch Object nodes.",
        " */",
        "function setTransientObjectAttribute(name, value) {",
        "    var transientStorage = transientState.get("objectAttributes");",
        "    if (transientStorage && value) {",
        "          if (transientStorage.put) {",
        "            transientStorage.put(name, value);",
        "        }",
        "          else {",
        "            transientStorage[name] = value;",
        "        }",
        "    }",
        "    else if (value) {",
        "    transientState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "    }",
        "}",
      ],
    },
    "39c08084-1238-43e8-857f-2e11005eac49": {
      "_id": "39c08084-1238-43e8-857f-2e11005eac49",
      "context": "OAUTH2_ACCESS_TOKEN_MODIFICATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Default alpha realm script for OAuth2 Access Token Modification",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Alpha OAuth2 Access Token Modification Script",
      "script": [
        "/*",
        " * Copyright 2019-2021 ForgeRock AS. All Rights Reserved.",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        " * This script lets you modify information associated with an OAuth2 access token",
        " * with methods provided by the AccessToken (1) interface.",
        " * The changes made to OAuth2 access tokens will directly impact the size of the CTS tokens,",
        " * and, similarly, the size of the JWTs if client-based OAuth2 tokens are utilized.",
        " * When adding/updating fields make sure that the token size remains within client/user-agent limits.",
        " *",
        " * Defined variables:",
        " * accessToken - AccessToken (1).",
        " *               The access token to be updated.",
        " *               Mutable object, all changes to the access token will be reflected.",
        " * scopes - Set<String> (6).",
        " *          Always present, the requested scopes.",
        " * requestProperties - Unmodifiable Map (5).",
        " *                     Always present, contains a map of request properties:",
        " *                     requestUri - The request URI.",
        " *                     realm - The realm that the request relates to.",
        " *                     requestParams - A map of the request params and/or posted data.",
        " *                                     Each value is a list of one or more properties.",
        " *                                     Please note that these should be handled in accordance with OWASP best practices:",
        " *                                     https://owasp.org/www-community/vulnerabilities/Unsafe_use_of_Reflection.",
        " * clientProperties - Unmodifiable Map (5).",
        " *                    Present if the client specified in the request was identified, contains a map of client properties:",
        " *                    clientId - The client's URI for the request locale.",
        " *                    allowedGrantTypes - List of the allowed grant types (org.forgerock.oauth2.core.GrantType) for the client.",
        " *                    allowedResponseTypes - List of the allowed response types for the client.",
        " *                    allowedScopes - List of the allowed scopes for the client.",
        " *                    customProperties - A map of the custom properties of the client.",
        " *                                       Lists or maps will be included as sub-maps; for example:",
        " *                                       customMap[Key1]=Value1 will be returned as customMap -> Key1 -> Value1.",
        " *                                       To add custom properties to a client, update the Custom Properties field",
        " *                                       in AM Console > Realm Name > Applications > OAuth 2.0 > Clients > Client ID > Advanced.",
        " * identity - AMIdentity (3).",
        " *            Always present, the identity of the resource owner.",
        " * session - SSOToken (4).",
        " *           Present if the request contains the session cookie, the user's session object.",
        " * scriptName - String (primitive).",
        " *              Always present, the display name of the script.",
        " * logger - Always present, the "OAuth2Provider" debug logger instance:",
        " *          https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.",
        " *          Corresponding log files will be prefixed with: scripts.OAUTH2_ACCESS_TOKEN_MODIFICATION.",
        " * httpClient - HTTP Client (8).",
        " *              Always present, the HTTP Client instance:",
        " *              https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-http-client.html#scripting-api-global-http-client.",
        " *",
        " * Return - no value is expected, changes shall be made to the accessToken parameter directly.",
        " *",
        " * Class reference:",
        " * (1) AccessToken - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/AccessToken.html.",
        " * (3) AMIdentity - https://backstage.forgerock.com/docs/am/7/apidocs/com/sun/identity/idm/AMIdentity.html.",
        " * (4) SSOToken - https://backstage.forgerock.com/docs/am/7/apidocs/com/iplanet/sso/SSOToken.html.",
        " * (5) Map - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashMap.html,",
        " *           or https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/LinkedHashMap.html.",
        " * (6) Set - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashSet.html.",
        " * (8) Client - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/http/Client.html.",
        " */",
        "",
        "/* EXAMPLE",
        "(function () {",
        "    var frJava = JavaImporter(",
        "        org.forgerock.http.protocol.Request,",
        "        org.forgerock.http.protocol.Response",
        "    );",
        "",
        "    // Always includes this field in the token.",
        "    accessToken.setField('key1', 'value1');",
        "",
        "    // Receives and adds to the access token additional values by performing a REST call to an external service.",
        "    // WARNING: Below, you will find a reference to a third-party site, which is provided only as an example.",
        "    var uri = 'https://jsonplaceholder.typicode.com/posts';",
        "",
        "    try {",
        "        var request = new frJava.Request();",
        "",
        "        // You can chain methods that return the request object.",
        "        request.setUri(uri)",
        "            .setMethod('POST')",
        "            .setEntity(JSON.stringify({",
        "                updatedFields: {",
        "                    key2: 'value2',",
        "                    key3: 'value3'",
        "                }",
        "            }));",
        "",
        "        // You can call a method when chaining is not possible.",
        "        request.getHeaders().add('Content-Type', 'application/json; charset=UTF-8');",
        "",
        "        // Sends the request and receives the response.",
        "        var response = httpClient.send(request).getOrThrow();",
        "",
        "        // Checks if the response status is as expected.",
        "        if (response.getStatus() === org.forgerock.http.protocol.Status.CREATED) {",
        "            var result = JSON.parse(response.getEntity().getString());",
        "",
        "            // Set multiple token fields at once.",
        "            accessToken.setFields(result.updatedFields);",
        "        } else {",
        "            logger.error('Unable to obtain access token modifications. Status: ' + response.getStatus() + '. Content: ' + response.getEntity().getString());",
        "        }",
        "    } catch (e) {",
        "        logger.error('The request processing was interrupted. ' + e);",
        "",
        "        // The access token request fails with the HTTP 500 error in this case.",
        "        throw ('Unable to obtain response from: ' + uri);",
        "    }",
        "",
        "    // Adds new fields containing identity attribute values to the access token.",
        "    accessToken.setField('mail', identity.getAttribute('mail'));",
        "    accessToken.setField('phone', identity.getAttribute('telephoneNumber').toArray()[0]);",
        "",
        "    // Adds new fields containing the session property values.",
        "    // NOTE: session may not be available for non-interactive authorization grants.",
        "    if (session) {",
        "        try {",
        "            accessToken.setField('ipAddress', session.getProperty('Host'));",
        "        } catch (e) {",
        "            logger.error('Unable to retrieve session property value. ' + e);",
        "        }",
        "    }",
        "",
        "    // Removes a native field from the token entry, that was set by AM.",
        "    // WARNING: removing native fields from the token may result in loss of functionality.",
        "    // accessToken.removeTokenName()",
        "",
        "    // No return value is expected. Let it be undefined.",
        "}());",
        "*/",
      ],
    },
    "3cb43516-ae69-433a-8787-501d45db14e9": {
      "_id": "3cb43516-ae69-433a-8787-501d45db14e9",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Display sharedState, transientState, and headers.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "debug",
      "script": [
        "/* debug",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Display sharedState, transientState, and headers.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "var anchor = "anchor-".concat(generateNumericToken('xxx'));",
        "var halign = "left";",
        "var message = "<p><b>Shared State</b>:<br/>".concat(",
        "      sharedState.toString()).concat("</p>").concat(",
        "    "<p><b>Transient State</b>:<br/>").concat(",
        "      transientState.toString()).concat("</p>").concat(",
        "    "<p><b>Request Headers</b>:<br/>").concat(",
        "      requestHeaders.toString()).concat("</p>")",
        "var script = "Array.prototype.slice.call(\\n".concat(",
        "  "document.getElementsByClassName('callback-component')).forEach(\\n").concat(",
        "  "function (e) {\\n").concat(",
        "  "  var message = e.firstElementChild;\\n").concat(",
        "  "  if (message.firstChild && message.firstChild.nodeName == '#text' && message.firstChild.nodeValue.trim() == '").concat(anchor).concat("') {\\n").concat(",
        "  "    message.className = \\"text-left\\";\\n").concat(",
        "  "    message.align = \\"").concat(halign).concat("\\";\\n").concat(",
        "  "    message.innerHTML = '").concat(message).concat("';\\n").concat(",
        "  "  }\\n").concat(",
        "  "})")",
        "var fr = JavaImporter(",
        "    org.forgerock.openam.auth.node.api.Action,",
        "    javax.security.auth.callback.TextOutputCallback,",
        "    com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        ")",
        "if (message.length && callbacks.isEmpty()) {",
        "    action = fr.Action.send(",
        "        new fr.TextOutputCallback(",
        "            fr.TextOutputCallback.INFORMATION,",
        "            anchor",
        "        ),",
        "        new fr.ScriptTextOutputCallback(script)",
        "    ).build()",
        "}",
        "else {",
        "  action = fr.Action.goTo("true").build();",
        "}",
        "",
        " /*",
        "  * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "  * ",
        "  * Example:",
        "  * 'xxxxx' produces '28535'",
        "  * 'xxx-xxx' produces '432-521'",
        "  */",
        "function generateNumericToken(format) {",
        "    return format.replace(/[x]/g, function(c) {",
        "        var r = Math.random()*10|0;",
        "        var v = r;",
        "        return v.toString(10);",
        "    });",
        "}",
      ],
    },
    "3d97c436-42c0-4dd0-a571-ea6f34f752b3": {
      "_id": "3d97c436-42c0-4dd0-a571-ea6f34f752b3",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from Itsme",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Itsme Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2020-2021 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "import org.forgerock.json.JsonValue",
        "",
        "JsonValue managedUser = json(object(",
        "        field("id", rawProfile.sub),",
        "        field("displayName", rawProfile.name),",
        "        field("givenName", rawProfile.given_name),",
        "        field("familyName", rawProfile.family_name),",
        "        field("username", rawProfile.email),",
        "        field("email", rawProfile.email)))",
        "return managedUser",
      ],
    },
    "403cf226-6051-4368-8b72-9ba14f9a5140": {
      "_id": "403cf226-6051-4368-8b72-9ba14f9a5140",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from VKontakte",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "VKontakte Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "return json(object(",
        "        field("id", rawProfile.id),",
        "        field("displayName", rawProfile.first_name),",
        "        field("givenName", rawProfile.first_name),",
        "        field("familyName", rawProfile.last_name),",
        "        field("photoUrl", rawProfile.photo_50),",
        "        field("email", rawProfile.email),",
        "        field("username", rawProfile.email)))",
      ],
    },
    "41c24257-d7fc-4654-8b46-c2666dc5b56d": {
      "_id": "41c24257-d7fc-4654-8b46-c2666dc5b56d",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "set per level shared state variable",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "level",
      "script": [
        "(function () {",
        "  outcome = 'true';",
        "  var level = nodeState.get('level').asInteger();",
        "  sharedState.put('level' + level + 'Value', 'Level ' + level + ': This is a longer string value set at each level of the nested journeys. It contains an indicator in which level it was set.');",
        "}());",
      ],
    },
    "424da748-82cc-4b54-be6f-82bd64d82a74": {
      "_id": "424da748-82cc-4b54-be6f-82bd64d82a74",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from Yahoo",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Yahoo Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "return json(object(",
        "        field("id", rawProfile.sub),",
        "        field("displayName", rawProfile.name),",
        "        field("givenName", rawProfile.given_name),",
        "        field("familyName", rawProfile.family_name),",
        "        field("photoUrl", rawProfile.picture),",
        "        field("email", rawProfile.email),",
        "        field("username", rawProfile.email),",
        "        field("locale", rawProfile.locale)))",
      ],
    },
    "452d73ee-c6f3-4f4e-9dae-e75bb3886cbd": {
      "_id": "452d73ee-c6f3-4f4e-9dae-e75bb3886cbd",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Copy sharedState to transientState",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Copy to transientState",
      "script": [
        "outcome = "true";",
        "if (sharedState.get("objectAttributes")) {",
        "    transientState.put("objectAttributes", sharedState.get("objectAttributes"))",
        "}",
        "if (sharedState.get("username")) {",
        "    transientState.put("username", sharedState.get("username"))",
        "}",
        "if (sharedState.get("_id")) {",
        "    transientState.put("_id", sharedState.get("_id"))",
        "}",
      ],
    },
    "472534ec-a25f-468d-a606-3fb1935190df": {
      "_id": "472534ec-a25f-468d-a606-3fb1935190df",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from WeChat",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "WeChat Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "return json(object(",
        "        field("id", rawProfile.openid),",
        "        field("displayName", rawProfile.nickname),",
        "        field("photoUrl", rawProfile.headimgurl),",
        "        field("username", rawProfile.nickname)))",
      ],
    },
    "484e6246-dbc6-4288-97e6-54e55431402e": {
      "_id": "484e6246-dbc6-4288-97e6-54e55431402e",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from Apple",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Apple Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2021-2022 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " *",
        " * In some common default configurations, the following keys are required to be not empty:",
        " * username, givenName, familyName, email.",
        " *",
        " * From RFC4517: A value of the Directory String syntax is a string of one or more",
        " * arbitrary characters from the Universal Character Set (UCS).",
        " * A zero-length character string is not permitted.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "String email = "change@me.com"",
        "String subjectId = rawProfile.sub",
        "String firstName = " "",
        "String lastName = " "",
        "String username = subjectId",
        "String name",
        "",
        "if (rawProfile.isDefined("email") && rawProfile.email.isNotNull()){ // User can elect to not share their email",
        "    email = rawProfile.email.asString()",
        "    username = email",
        "}",
        "if (rawProfile.isDefined("name") && rawProfile.name.isNotNull()) {",
        "    if (rawProfile.name.isDefined("firstName") && rawProfile.name.firstName.isNotNull()) {",
        "        firstName = rawProfile.name.firstName.asString()",
        "    }",
        "    if (rawProfile.name.isDefined("lastName") && rawProfile.name.lastName.isNotNull()) {",
        "        lastName = rawProfile.name.lastName.asString()",
        "    }",
        "}",
        "",
        "name = (firstName?.trim() ? firstName : "") + (lastName?.trim() ? ((firstName?.trim() ? " " : "") + lastName) : "")",
        "name =  (!name?.trim()) ? " " : name",
        "",
        "return json(object(",
        "        field("id", subjectId),",
        "        field("displayName", name),",
        "        field("email", email),",
        "        field("givenName", firstName),",
        "        field("familyName", lastName),",
        "        field("username", username)))",
      ],
    },
    "4855aac0-1efd-49c0-a153-3b9aadc911a6": {
      "_id": "4855aac0-1efd-49c0-a153-3b9aadc911a6",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Populate Username From Email",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Populate Username From Email",
      "script": [
        "outcome = "true";",
        "",
        "sharedState.put("username", getSharedObjectAttribute("mail"))",
        "setSharedObjectAttribute("userName", getSharedObjectAttribute("mail"))",
        "",
        "/*",
        " * Store attributes in shared state for use with the Create/Patch Object nodes.",
        " */",
        "function setSharedObjectAttribute(name, value) {",
        "       var storage = sharedState.get("objectAttributes");",
        "    if (storage && value) {",
        "          if (storage.put) {",
        "              storage.put(name, value);",
        "        }",
        "          else {",
        "              storage[name] = value;",
        "        }",
        "    }",
        "    else if (value) {",
        "        sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "    }",
        "}",
        "",
        "/*",
        " * Read attributes in shared state for use with the Create/Patch Object nodes.",
        " */",
        "function getSharedObjectAttribute(name) {",
        "    var storage = sharedState.get("objectAttributes");",
        "    if (storage) {",
        "          if (storage.get) {",
        "            return sharedState.get("objectAttributes").get(name);",
        "        }",
        "          else {",
        "              return storage.name;",
        "        }",
        "    }",
        "    return null;",
        "}",
      ],
    },
    "48f17202-039f-4d40-b7fc-4ce380f1b929": {
      "_id": "48f17202-039f-4d40-b7fc-4ce380f1b929",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Collect all the configuration items required for the SAML2 Node to function properly.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Collect SAML2 Node Config",
      "script": [
        "/* Collect SAML2 Node Config",
        " * ",
        " * Collect all the configuration items required for the SAML2 Node to function properly.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    outcome = "true";",
        "      var config = {",
        "        "metaAlias": "/iSPAzure",",
        "        "allowCreate": false,",
        "        "sloEnabled": false,",
        "        "authnContextClassRef": [],",
        "        "authnContextDeclRef": [],",
        "        "authComparison": "EXACT",",
        "        "nameIdFormat": "urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified",",
        "        "requestBinding": "HTTP_REDIRECT",",
        "        "binding": "HTTP_POST",",
        "        "forceAuthn": false,",
        "        "idpEntityId": "https://sts.windows.net/711ffa9c-5972-4713-ace3-688c9732614a/",",
        "        "isPassive": false,",
        "        "sloRelayState": """,
        "    };",
        "      var script = "";",
        "    script += "Array.prototype.slice.call(";",
        "    script += "    document.getElementsByTagName('input')";",
        "    script += ").forEach(";",
        "    script += "    function (input,i) {";",
        "    script += "        console.log('input '+i);"",
        "    script += "        var config = JSON.parse('"+JSON.stringify(config)+"');";",
        "    script += "        var keys = Object.keys(config);";",
        "    script += "        if (input.type === 'text') {";",
        "    script += "            input.setAttribute('value', config[keys[i]]);";",
        "    script += "            input.dispatchEvent(new KeyboardEvent( 'input' , {'key':'Enter'} ));";",
        "    script += "        }";",
        "    script += "    }";",
        "    script += ");";",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "          javax.security.auth.callback.NameCallback,",
        "        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        "    )",
        "    if (callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "            new fr.NameCallback("metaAlias"),",
        "            new fr.NameCallback("allowCreate"),",
        "            new fr.NameCallback("sloEnabled"),",
        "            new fr.NameCallback("authnContextClassRef"),",
        "            new fr.NameCallback("authnContextDeclRef"),",
        "            new fr.NameCallback("authComparison"),",
        "            new fr.NameCallback("nameIdFormat"),",
        "            new fr.NameCallback("requestBinding"),",
        "            new fr.NameCallback("binding"),",
        "            new fr.NameCallback("forceAuthn"),",
        "            new fr.NameCallback("idpEntityId"),",
        "            new fr.NameCallback("isPassive"),",
        "            new fr.NameCallback("sloRelayState"),",
        "              new fr.ScriptTextOutputCallback(script)",
        "        ).build();",
        "    }",
        "    else {",
        "          config[callbacks.get(0).getPrompt()] = callbacks.get(0).getName();",
        "          config[callbacks.get(1).getPrompt()] = (callbacks.get(1).getName() === 'true');",
        "          config[callbacks.get(2).getPrompt()] = (callbacks.get(2).getName() === 'true');",
        "          config[callbacks.get(3).getPrompt()] = [callbacks.get(3).getName()];",
        "          config[callbacks.get(4).getPrompt()] = [callbacks.get(4).getName()];",
        "          config[callbacks.get(5).getPrompt()] = callbacks.get(5).getName();",
        "          config[callbacks.get(6).getPrompt()] = callbacks.get(6).getName();",
        "          config[callbacks.get(7).getPrompt()] = callbacks.get(7).getName();",
        "          config[callbacks.get(8).getPrompt()] = callbacks.get(8).getName();",
        "          config[callbacks.get(9).getPrompt()] = (callbacks.get(9).getName() === 'true');",
        "          config[callbacks.get(10).getPrompt()] = callbacks.get(10).getName();",
        "          config[callbacks.get(11).getPrompt()] = (callbacks.get(11).getName() === 'true');",
        "          config[callbacks.get(12).getPrompt()] = callbacks.get(12).getName();",
        "          nodeState.putShared("nodeConfig", config);",
        "        action = fr.Action.goTo(outcome).build();",
        "    }",
        "}());",
      ],
    },
    "4a9aefc4-be0e-4625-95c3-ee8f354bce35": {
      "_id": "4a9aefc4-be0e-4625-95c3-ee8f354bce35",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_ClearCurrentYear",
      "script": [
        "if (sharedState.containsKey('objectAttributes')) {",
        "  sharedState.get('objectAttributes').remove('currentYear');",
        "}",
        "",
        "outcome = 'True';",
        "",
      ],
    },
    "4accb4d0-56ec-4a28-a769-5275dbac3147": {
      "_id": "4accb4d0-56ec-4a28-a769-5275dbac3147",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_PasswordFixStart",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        "This is a workaround that fixes an issue with password policy.",
        "",
        "The Platform Password node attempts to validate a password by calling IDM's validateProperty action, and it uses",
        "sharedState.objectAttributes as the \`object\` property of that request payload.  If the request is missing required properties",
        "or contains properties not in the object's schema, DS will error and IDM will swallow that error, returning an empty ",
        "list of failed policies instead.",
        "",
        "This workaround provides fake values for required properties. It also ensures first/last name is in objectAttributes so the",
        ""can't contain" policy can be evaluated. This workaround is cleaned up by Admin_PasswordFixEnd.js.",
        "*/",
        "",
        "// Capture existing object attributes so we can restore them later",
        "if (sharedState.containsKey('objectAttributes')) {",
        "  sharedState.put('originalObjectAttributes', sharedState.get('objectAttributes'));",
        "}",
        "",
        "// Define the object to use for policy evaluation",
        "var policyObject = {",
        "  givenName: '',",
        "  sn: '',",
        "  groups: ['fake'],",
        "  inviteDate: 'fake'",
        "};",
        "",
        "// If we've loaded the admin object, add first/last name to support",
        "// evaluation of the full policy",
        "if (sharedState.containsKey('adminObject')) {",
        "  var adminObject = sharedState.get('adminObject');",
        "  policyObject.givenName = adminObject.get('givenName');",
        "  policyObject.sn = adminObject.get('sn');",
        "}",
        "",
        "// Replace objectAttributes with our policy object",
        "sharedState.put('objectAttributes', policyObject);",
        "",
        "outcome = 'True';",
        "",
      ],
    },
    "4c7bb7bb-c5d6-47ac-92dc-256fb8121fa9": {
      "_id": "4c7bb7bb-c5d6-47ac-92dc-256fb8121fa9",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_MfaRequiredCheck",
      "script": [
        "if ("false" == "true") {",
        "  outcome = "Required";",
        "} else {",
        "  outcome = "Optional";",
        "}",
      ],
    },
    "4ee5b182-1b09-45cc-97a9-0e609f0a2915": {
      "_id": "4ee5b182-1b09-45cc-97a9-0e609f0a2915",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Resend OTP Option",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Resend OTP Option",
      "script": [
        "/* CResend OTP Option",
        " *",
        " * Author: jon.knight@forgerock.com, volker.scheuber@forgerock.com",
        " * ",
        " * Collect OTP and validate the collected OTP. Also offer a resend option.",
        " * Return "true" if collected OTP is valid, "false" if collected OTP is invalid, ",
        " * and resend if the user selected the resend button.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * - false",
        " * - resend",
        " */",
        "(function () {",
        "  // how long until the "resend" button becomes enabled.",
        "  DELAY=20;",
        "  ",
        "  // how long (in seconds) should the OTP be accepted as valid",
        "  OTP_TTL = 30;",
        "",
        "  var fr = JavaImporter(",
        "      org.forgerock.openam.auth.node.api.Action,",
        "      javax.security.auth.callback.NameCallback,",
        "      com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        "  )",
        "",
        "  function createScript() {",
        "      return String(" \\n\\",
        "          var COUNT = " + DELAY + "; \\n\\",
        "          function go(obs) { \\n\\",
        "              const p = document.querySelectorAll('input[data-vv-as=\\"One Time Passcode\\"]')[0]; \\n\\",
        "              if (p) { \\n\\",
        "                  var b = document.createElement('button'); \\n\\",
        "                  b.id = 'resendButton'; \\n\\",
        "                  b.classList.add(\\"btn\\", \\"mt-3\\", \\"btn-secondary\\", \\"btn-sm\\"); \\n\\",
        "                  b.onclick = function() { p.value='___RESEND___'; p.dispatchEvent(new Event('input')); }; \\n\\",
        "                  b.innerHTML = 'Resend Code ... ' + COUNT + 's'; \\n\\",
        "                  b.disabled = true; \\n\\",
        "                  p.parentNode.insertBefore(b, p.nextSibling); \\n\\",
        "                  var t = setInterval(function() { \\n\\",
        "                      if (COUNT == 1) { \\n\\",
        "                          clearInterval(t); \\n\\",
        "                          b.disabled = false; \\n\\",
        "                          b.innerHTML = 'Resend Code'; \\n\\",
        "                      } else { \\n\\",
        "                          COUNT--; \\n\\",
        "                          b.innerHTML = 'Resend Code ... ' + COUNT + 's'; \\n\\",
        "                      } \\n\\",
        "                  }, 1000 ); \\n\\",
        "                  if (obs) obs.disconnect(); \\n\\",
        "                  return; \\n\\",
        "              } \\n\\",
        "          } \\n\\",
        "          if (document.querySelectorAll('input[data-vv-as=\\"One Time Passcode\\"]')[0]) go(); \\n\\",
        "          else { \\n\\",
        "              const observer = new MutationObserver((mutations, obs) => { go(obs); }); \\n\\",
        "              observer.observe(document, { childList: true, subtree: true }); \\n\\",
        "          } \\n\\",
        "      ");",
        "  }",
        "",
        "  if (callbacks.isEmpty()) {",
        "      action = fr.Action.send(",
        "          new fr.ScriptTextOutputCallback(createScript()),",
        "          new fr.NameCallback("One Time Passcode")",
        "      ).build()",
        "  } else {",
        "      var otpTimestamp = Math.floor(new java.util.Date().getTime() / 1000);",
        "      var otp = callbacks.get(1).getName();",
        "      if (otp === "___RESEND___") {",
        "          action = fr.Action.goTo("resend").build();",
        "      } else {",
        "          var sentOtp = sharedState.get("oneTimePassword");",
        "          var sentOtpTimestamp = sharedState.get("oneTimePasswordTimestamp");",
        "          if (sentOtp == otp && otpTimestamp - OTP_TTL >= sentOtpTimestamp) {",
        "              action = fr.Action.goTo("true").build();",
        "            }",
        "          else {",
        "            action = fr.Action.goTo("false").build();",
        "          }",
        "      }",
        "  }",
        "}());",
      ],
    },
    "4f1273be-9c52-4879-bbe9-9a47068aeed9": {
      "_id": "4f1273be-9c52-4879-bbe9-9a47068aeed9",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Unverified caller message",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Twilio IVR: Unverified Caller Message",
      "script": [
        "/* Twilio IVR: Unverified Caller Message",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * ",
        " * Depending on the amount of data collected through callbacks and how many of the callParams",
        " * you activate below, you will need to change your authentication session from JWT to CTS or",
        " * Memory.",
        " */",
        "outcome = "true";",
        "",
        "/* Begin Configuration",
        " */",
        "",
        "// Build out the full message",
        "var message = "That doesn't match our records. Let us try this another way.";",
        "",
        "/* End Configuration",
        " */",
        "",
        "var fr = JavaImporter(",
        "      org.forgerock.openam.auth.node.api,",
        "      javax.security.auth.callback.TextOutputCallback",
        ");",
        "  ",
        "with (fr) {",
        "      if (callbacks.isEmpty()) {",
        "        var output = new TextOutputCallback(TextOutputCallback.INFORMATION, message);",
        "        action = Action.send(output).build();",
        "      } ",
        "      else {",
        "        action = Action.goTo(outcome).build();",
        "      }",
        "}",
      ],
    },
    "50cde102-d4b6-44c4-9ba7-8564af05ae08": {
      "_id": "50cde102-d4b6-44c4-9ba7-8564af05ae08",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Select and apply theme from query param in the request URL.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Select Theme from URL",
      "script": [
        "/* Select Theme from URL",
        " * ",
        " * Select and apply theme from query param in the request URL.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "      outcome = "true";",
        "      var theme = "";",
        "      if (requestParameters.get("themeId")) {",
        "          theme = requestParameters.get("themeId").get(0);",
        "    }",
        "",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "        org.forgerock.openam.authentication.callbacks.PollingWaitCallback",
        "    )",
        "    if (theme && callbacks.isEmpty()) {",
        "        var stage = "themeId="+theme;",
        "        action = fr.Action.send(",
        "              new fr.PollingWaitCallback("100", "Please wait ...")",
        "        ).withStage(stage).build();",
        "    } else {",
        "          action = fr.Action.goTo(outcome).build();",
        "    }",
        "}());",
      ],
    },
    "53c50dbd-5331-4739-bea1-4c5e9bf553f2": {
      "_id": "53c50dbd-5331-4739-bea1-4c5e9bf553f2",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Welcome message",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Twilio IVR: Welcome Message",
      "script": [
        "/* Twilio IVR: Welcome Message",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * ",
        " * Depending on the amount of data collected through callbacks and how many of the callParams",
        " * you activate below, you will need to change your authentication session from JWT to CTS or",
        " * Memory.",
        " */",
        "logger.warning("Twilio IVR: Welcome Message: start");",
        "outcome = "true";",
        "",
        "/* Begin Configuration",
        " */",
        "",
        "// Build out the full message",
        "var message = "Thank you for calling ForgeRock Identity Cloud!";",
        "",
        "/* End Configuration",
        " */",
        "",
        "var fr = JavaImporter(",
        "      org.forgerock.openam.auth.node.api,",
        "      javax.security.auth.callback.TextOutputCallback",
        ");",
        "  ",
        "with (fr) {",
        "      if (callbacks.isEmpty()) {",
        "        var output = new TextOutputCallback(TextOutputCallback.INFORMATION, message);",
        "        action = Action.send(output).build();",
        "      } ",
        "      else {",
        "        logger.warning("Twilio IVR: Welcome Message: finish [outcome=".concat(outcome).concat("]"));",
        "        action = Action.goTo(outcome).build();",
        "      }",
        "}",
      ],
    },
    "5561a45f-bf00-4ec5-bab4-f069bac9a38b": {
      "_id": "5561a45f-bf00-4ec5-bab4-f069bac9a38b",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Copy an OTP generated by the "HOTP Generator" node to the IDM profile shared state so it can be patched to the user profile.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "CopyOTPToObjectAttributes",
      "script": [
        "/* CopyOTPToObjectAttributes",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Copy an OTP generated by the "HOTP Generator" node to the IDM profile ",
        " * shared state so it can be patched to the user profile.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "if (sharedState.get("objectAttributes")) {",
        "    sharedState.get("objectAttributes").put("description", sharedState.get("oneTimePassword"))",
        "}",
        "else {",
        "    sharedState.put("objectAttributes", {description: sharedState.get("oneTimePassword")});",
        "}",
        "outcome = "true";",
      ],
    },
    "57807349-630f-496a-bccb-ea1011b8e945": {
      "_id": "57807349-630f-496a-bccb-ea1011b8e945",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Extract username, password, and OTP from request headers and put them in shared state for validation.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "MobileOTP: Extract Username, Password, OTP",
      "script": [
        "logger.warning("MobileOTP: Extract Username, Password, OTP: start");",
        "",
        "/*",
        " * BEGIN SCRIPT CONFIGURATION",
        " */",
        "var USERNAME_HEADER_NAME = "X-OpenAM-Username";",
        "var PASSWORD_HEADER_NAME = "X-OpenAM-Password";",
        "var OTP_HEADER_NAME = "X-OpenAM-MobileOTP";",
        "/*",
        " * END SCRIPT CONFIGURATION",
        " */",
        "",
        "outcome = "false";",
        "",
        "var username = getHeader(USERNAME_HEADER_NAME) || null;",
        "var password = getHeader(PASSWORD_HEADER_NAME) || null;",
        "var mobileOTP = getHeader(OTP_HEADER_NAME) || null;",
        "",
        "if (username && password && mobileOTP) {",
        "      sharedState.put("username", username);",
        "      transientState.put("password", password);",
        "      transientState.put("mobileOTP", mobileOTP);",
        "    outcome = "true";",
        "}",
        "",
        "logger.warning("MobileOTP: Extract Username, Password, OTP: finish [outcome=".concat(outcome).concat("]"));",
        "",
        "/*",
        " * Returns the value of the requested header",
        " */",
        "function getHeader(headerName) {",
        "      if (requestHeaders.get(headerName) && requestHeaders.get(headerName).get(0)) {",
        "        return requestHeaders.get(headerName).get(0).toString();",
        "    }",
        "      return null;",
        "}",
      ],
    },
    "58258c2d-46f3-4811-85c4-ea1476dd9cf4": {
      "_id": "58258c2d-46f3-4811-85c4-ea1476dd9cf4",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Service Account - Cluster Internal Requests Only",
      "script": [
        "",
        "try {",
        "  var clientIpAddresses = requestHeaders.get(new java.lang.String('x-forwarded-for'));",
        "  if (!clientIpAddresses) {",
        "    logger.message('No forwarded header; internal cluster request');",
        "    outcome = 'True'",
        "  } else {",
        "    logger.message('Forwarded header {}', clientIpAddresses);",
        "    outcome = 'False';",
        "  }",
        "} catch (e) {",
        "  logger.error('Service Account - Cluster Internal Requests Only - failed deducing header');",
        "  logger.error(e);",
        "  outcome = 'Error';",
        "}",
      ],
    },
    "58c824ae-84ed-4724-82cd-db128fc3f6c": {
      "_id": "58c824ae-84ed-4724-82cd-db128fc3f6c",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Converts a normalized social profile into a managed user",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Normalized Profile to Managed User",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "import org.forgerock.json.JsonValue",
        "",
        "JsonValue managedUser = json(object(",
        "        field("givenName", normalizedProfile.givenName),",
        "        field("sn", normalizedProfile.familyName),",
        "        field("mail", normalizedProfile.email),",
        "        field("userName", normalizedProfile.username)))",
        "",
        "if (normalizedProfile.postalAddress.isNotNull()) managedUser.put("postalAddress", normalizedProfile.postalAddress)",
        "if (normalizedProfile.addressLocality.isNotNull()) managedUser.put("city", normalizedProfile.addressLocality)",
        "if (normalizedProfile.addressRegion.isNotNull()) managedUser.put("stateProvince", normalizedProfile.addressRegion)",
        "if (normalizedProfile.postalCode.isNotNull()) managedUser.put("postalCode", normalizedProfile.postalCode)",
        "if (normalizedProfile.country.isNotNull()) managedUser.put("country", normalizedProfile.country)",
        "if (normalizedProfile.phone.isNotNull()) managedUser.put("telephoneNumber", normalizedProfile.phone)",
        "",
        "// if the givenName and familyName is null or empty",
        "// then add a boolean flag to the shared state to indicate names are not present",
        "// this could be used elsewhere",
        "// for eg. this could be used in a scripted decision node to by-pass patching",
        "// the user object with blank values when givenName  and familyName is not present",
        "boolean noGivenName = normalizedProfile.givenName.isNull() || (!normalizedProfile.givenName.asString()?.trim())",
        "boolean noFamilyName = normalizedProfile.familyName.isNull() || (!normalizedProfile.familyName.asString()?.trim())",
        "sharedState.put("nameEmptyOrNull", noGivenName && noFamilyName)",
        "",
        "return managedUser",
        "",
      ],
    },
    "58d29080-4563-480b-89bb-1e7719776a21": {
      "_id": "58d29080-4563-480b-89bb-1e7719776a21",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from Google",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Google Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "return json(object(",
        "        field("id", rawProfile.sub),",
        "        field("displayName", rawProfile.name),",
        "        field("givenName", rawProfile.given_name),",
        "        field("familyName", rawProfile.family_name),",
        "        field("photoUrl", rawProfile.picture),",
        "        field("email", rawProfile.email),",
        "        field("username", rawProfile.email),",
        "        field("locale", rawProfile.locale)))",
      ],
    },
    "5b29c5b7-b161-4a42-a41f-d6c85316b951": {
      "_id": "5b29c5b7-b161-4a42-a41f-d6c85316b951",
      "context": "SAML2_IDP_ADAPTER",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Saml2 IDP Adapter Script",
      "script": [
        "/*",
        " * Copyright 2021 ForgeRock AS. All Rights Reserved",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        " * The script has these top level functions that could be executed during a SAML2 flow.",
        " *      - preSingleSignOn",
        " *      - preAuthentication",
        " *      - preSendResponse",
        " *      - preSignResponse",
        " *      - preSendFailureResponse",
        " *",
        " * Please see the javadoc for the interface definition and more information about these methods.",
        " * https://backstage.forgerock.com/docs/am/7.2/apidocs/com/sun/identity/saml2/plugins/SAML2IdentityProviderAdapter.html",
        " * Note that the initialize method is not supported in the scripts.",
        " *",
        " * Defined variables. Check the documentation on the respective functions for the variables available to it.",
        " *",
        " * hostedEntityId - String",
        " *     Entity ID for the hosted IDP",
        " * realm - String",
        " *     Realm of the hosted IDP",
        " * idpAdapterScriptHelper - IdpAdapterScriptHelper (1)",
        " *     An instance of IdpAdapterScriptHelper containing helper methods. See Javadoc for more details.",
        " * request - HttpServletRequest (2)",
        " *     Servlet request object",
        " * response - HttpServletResponse (3)",
        " *     Servlet response object",
        " * authnRequest - AuthnRequest (4)",
        " *     The original authentication request sent from SP",
        " * reqId - String",
        " *     The id to use for continuation of processing if the adapter redirects",
        " * res - Response (5)",
        " *     The SAML Response",
        " * session - SSOToken (6)",
        " *     The single sign-on session. The reference type of this is Object and would need to be casted to SSOToken.",
        " * relayState - String",
        " *     The relayState that will be used in the redirect",
        " * faultCode - String",
        " *     the fault code that will be returned in the SAML response",
        " * faultDetail - String",
        " *     the fault detail that will be returned in the SAML response",
        " * logger - Logger instance",
        " *     https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.",
        " *     Corresponding log files will be prefixed with: scripts.<script name>",
        " *",
        " * Throws SAML2Exception (7):",
        " *     for any exceptions occurring in the adapter. The federation process will continue",
        " *",
        " * Class reference:",
        " * (1) idpAdapterScriptHelper - https://backstage.forgerock.com/docs/am/7.2/apidocs/com/sun/identity/saml2/plugins/scripted/IdpAdapterScriptHelper.html.",
        " * (2) HttpServletRequest - https://tomcat.apache.org/tomcat-7.0-doc/servletapi/javax/servlet/http/HttpServletRequest.html.",
        " * (3) HttpServletResponse - https://tomcat.apache.org/tomcat-7.0-doc/servletapi/javax/servlet/http/HttpServletResponse.html.",
        " * (4) AuthnRequest - https://backstage.forgerock.com/docs/am/7.2/apidocs/com/sun/identity/saml2/protocol/AuthnRequest.html.",
        " * (5) Response - https://backstage.forgerock.com/docs/am/7.2/apidocs/com/sun/identity/saml2/protocol/Response.html.",
        " * (6) SSOToken - https://backstage.forgerock.com/docs/am/7.2/apidocs/com/iplanet/sso/SSOToken.html.",
        " * (7) SAML2Exception - https://backstage.forgerock.com/docs/am/7.2/apidocs/com/sun/identity/saml2/common/SAML2Exception.html.",
        " */",
        "",
        "/*",
        " * Template/default script for SAML2 IDP Adapter scripted plugin.",
        " */",
        "",
        "/*",
        " * Available variables for preSingleSignOn:",
        " *     hostedEntityId",
        " *     realm",
        " *     idpAdapterScriptHelper",
        " *     request",
        " *     authnRequest",
        " *     response",
        " *     reqId",
        " *     logger",
        " *",
        " * Return - true if browser redirection is happening after processing, false otherwise. Default to false.",
        " */",
        "function preSingleSignOn () {",
        "    return false;",
        "}",
        "",
        "/*",
        " * Available variables for preAuthentication:",
        " *     hostedEntityId",
        " *     realm",
        " *     idpAdapterScriptHelper",
        " *     request",
        " *     authnRequest",
        " *     response",
        " *     reqId",
        " *     session",
        " *     relayState",
        " *     logger",
        " *",
        " * Return - true if browser redirection is happening after processing, false otherwise. Default to false.",
        " */",
        "function preAuthentication () {",
        "    return false;",
        "}",
        "",
        "/*",
        " * Available variables for preSendResponse:",
        " *     hostedEntityId",
        " *     realm",
        " *     idpAdapterScriptHelper",
        " *     request",
        " *     authnRequest",
        " *     response",
        " *     reqId",
        " *     session",
        " *     relayState",
        " *     logger",
        " *",
        " * Return - true if browser redirection happened after processing, false otherwise. Default to false.",
        " */",
        "function preSendResponse () {",
        "    return false;",
        "}",
        "",
        "/*",
        " * Available variables for preSignResponse:",
        " *     hostedEntityId",
        " *     realm",
        " *     idpAdapterScriptHelper",
        " *     request",
        " *     authnRequest",
        " *     session",
        " *     relayState",
        " *     res",
        " *     logger",
        " */",
        "function preSignResponse () {",
        "}",
        "",
        "/*",
        " * Available variables for preSendFailureResponse:",
        " *     hostedEntityId",
        " *     realm",
        " *     idpAdapterScriptHelper",
        " *     request",
        " *     response",
        " *     faultCode",
        " *     faultDetail",
        " *     logger",
        " */",
        "function preSendFailureResponse () {",
        "}",
      ],
    },
    "5b3b2c47-0248-46f4-8a1c-8a495d249037": {
      "_id": "5b3b2c47-0248-46f4-8a1c-8a495d249037",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Save/restore perpetrator",
      "script": [
        "outcome = "true";",
        "if (sharedState.get("perpetrator"))",
        "{",
        "  sharedState.put("username", sharedState.get("perpetrator"));",
        "//  if (sharedState.get("objectAttributes")) {",
        "//    sharedState.remove("objectAttributes");",
        "//  }",
        "  sharedState.put("objectAttributes", {});",
        "}",
        "else",
        "{",
        "  sharedState.put("perpetrator", sharedState.get("username"));",
        "  if (sharedState.get("objectAttributes") && ",
        "      sharedState.get("objectAttributes").get("userName")) {",
        "    sharedState.get("objectAttributes").remove("userName");",
        "  }",
        "}",
      ],
    },
    "5b553f58-16bd-42b7-a782-4a981a66dbd4": {
      "_id": "5b553f58-16bd-42b7-a782-4a981a66dbd4",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Branch based on the IDP setting.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Routed IDP Persist Decision",
      "script": [
        "/* Routed IDP Persist Decision",
        " * ",
        " * Branch based on the IDP setting.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * - false",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "      logger.message("Routed IDP Persist Decision: Start");",
        "      outcome = "false";",
        "      var routedIDP = sharedState.get("routedIDPs").get(0);",
        "      if (routedIDP) {",
        "        outcome = "".concat(routedIDP.get("idpPersist"));",
        "    }",
        "      logger.message("Routed IDP Persist Decision: Done [outcome={}]", outcome);",
        "}());",
      ],
    },
    "5bbdaeff-ddee-44b9-b608-8d413d7d65a6": {
      "_id": "5bbdaeff-ddee-44b9-b608-8d413d7d65a6",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Check if mode has already been set.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "mode",
      "script": [
        "/* mode",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Collect mode if not already set and set outcome to mode.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - 'shared and level'",
        " * - 'shared only'",
        " * - 'level only'",
        " * - 'none'",
        " */",
        "(function () {",
        "  var mode = nodeState.get('mode');",
        "  if (mode) {",
        "    outcome = mode.asString();",
        "    var level = nodeState.get('level').asInteger() + 1;",
        "    logger.error('mode: mode=' + mode.asString() + ', level=' + level);",
        "    sharedState.put('level', level);",
        "  }",
        "  else {",
        "    var choices = ['shared and level', 'shared only', 'level only', 'none'];",
        "  ",
        "    var fr = JavaImporter(",
        "      org.forgerock.openam.auth.node.api.Action,",
        "      javax.security.auth.callback.ChoiceCallback",
        "    )",
        "",
        "    if (callbacks.isEmpty()) {",
        "      action = fr.Action.send([",
        "        new fr.ChoiceCallback('Choose test mode', choices, 0, false)",
        "      ]).build();",
        "    } else {",
        "      var choice = parseInt(callbacks.get(0).getSelectedIndexes()[0]);",
        "      nodeState.putShared('mode', choices[choice]);",
        "      nodeState.putShared('level', 0);",
        "      action = fr.Action.goTo(choices[choice]).build();",
        "    }",
        "  }",
        "}());",
      ],
    },
    "5dbd53c6-67ff-4a43-84c3-90c5cf5da35a": {
      "_id": "5dbd53c6-67ff-4a43-84c3-90c5cf5da35a",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Return TextOutputCallback indicating the provided OTP was valid.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "OTP Valid",
      "script": [
        "/* OTP Valid",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Return TextOutputCallback indicating the provided OTP was valid.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "outcome = "true";",
        "var fr = JavaImporter(",
        "    org.forgerock.openam.auth.node.api.Action,",
        "    javax.security.auth.callback.TextOutputCallback",
        ")",
        "if (callbacks.isEmpty()) {",
        "    action = fr.Action.send(",
        "        new fr.TextOutputCallback(",
        "            fr.TextOutputCallback.INFORMATION,",
        "            "VALID"",
        "        )",
        "    ).build()",
        "}",
        "else {",
        "  action = fr.Action.goTo(outcome).build();",
        "}",
      ],
    },
    "5e68fee3-047d-4fff-8e99-89fb5908f068": {
      "_id": "5e68fee3-047d-4fff-8e99-89fb5908f068",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_ForgotUsernameMailCheck",
      "script": [
        "var fr = new JavaImporter(",
        "  org.forgerock.openam.auth.nodes,",
        "  org.forgerock.guice.core,",
        "  java.util.HashMap",
        ");",
        "",
        "// This confirms the Identify Existing User node was able to find the",
        "// admin, otherwise we remove the mail attribute so no email can be sent",
        "with (fr) {",
        "  try {",
        "",
        "    var objAttrs = sharedState.get('objectAttributes') || new HashMap();",
        "    var username = objAttrs.get('userName');",
        "    outcome = username ? 'Valid' : 'Invalid';",
        "    if (username) {",
        "      outcome = 'Valid';",
        "    } else {",
        "      objAttrs.remove('mail');",
        "      sharedState.put('objectAttributes', objAttrs);",
        "      outcome = 'Invalid';",
        "    }",
        "",
        "    logger.message('Admin_ForgotUsernameMailCheck: ' + outcome);",
        "",
        "  } catch (e) {",
        "",
        "    logger.error('Admin_ForgotUsernameMailCheck: Failed to determine mail validity');",
        "    logger.error(e);",
        "    outcome = 'Error';",
        "",
        "  }",
        "}",
      ],
    },
    "5e854779-6ec1-4c39-aeba-0477e0986646": {
      "_id": "5e854779-6ec1-4c39-aeba-0477e0986646",
      "context": "CONFIG_PROVIDER_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Default global script for Config Provider",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Config Provider",
      "script": [
        "/*",
        " * Copyright 2021 ForgeRock AS. All Rights Reserved",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/**",
        " * The following script is a simplified template for understanding how to build",
        " * up a config Map object with custom values. The Config Provider Node will then",
        " * provide this config Map to the desired node type. It is important that the Map",
        " * you build here is named 'config'.",
        " *",
        " * Defined variables:",
        " *",
        " * nodeState - Node State (1)",
        " *           Always present, this represents the current values stored in the node state.",
        " *",
        " * idRepository - Profile Data (2)",
        " *           Always present, a repository to retrieve user information.",
        " *",
        " * secrets - Credentials and Secrets (3)",
        " *           Always present, an interface to access the Secrets API from a scripting context.",
        " *",
        " * requestHeaders (4) - Map (5)",
        " *           Always present, an object that provides methods for accessing headers in the login request.",
        " *",
        " * logger - Debug Logging (6)",
        " *          Always present, the debug logger instance.",
        " *",
        " * httpClient - HTTP Client (7)",
        " *          Always present, the HTTP client that can be used to make external HTTP requests.",
        " *",
        " * realm - String (primitive).",
        " *          Always present, the name of the realm the user is authenticating to.",
        " *",
        " * existingSession - Map<String, String> (5)",
        " *          Present if the request contains the session cookie, the user's session object. The returned map from",
        " *          SSOToken.getProperties() (8)",
        " *",
        " * requestParameters - Map (5)",
        " *          Always present, the object that contains the authentication request parameters.",
        " *",
        " *",
        " * Outputs:",
        " *",
        " * config - Map (5)",
        " *           Define and fill a Map object named 'config' with custom values, this will define the configuration for the",
        " *           associated node selected in the ConfigProviderNode.",
        " *",
        " * Reference:",
        " * (1) Node State - https://backstage.forgerock.com/docs/idcloud-am/latest/authentication-guide/scripting-api-node.html#scripting-api-node-nodeState",
        " * (2) Profile Data - https://backstage.forgerock.com/docs/am/7.1/authentication-guide/scripting-api-node.html#scripting-api-node-id-repo",
        " * (3) Credentials and Secrets - https://backstage.forgerock.com/docs/am/7.1/authentication-guide/scripting-api-node.html#scripting-api-authn-secrets",
        " * (4) Request Headers - https://backstage.forgerock.com/docs/am/7/authentication-guide/scripting-api-node.html#scripting-api-node-requestHeaders.",
        " * (5) Map - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/Map.html",
        " * (6) Debug Logging - https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.",
        " * (7) HTTP Client - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/http/Client.html.",
        " * (8) SSOToken - https://backstage.forgerock.com/docs/am/7/apidocs/com/iplanet/sso/SSOToken.html.",
        " */",
        "",
        "config = nodeState.get('nodeConfig').asMap();",
      ],
    },
    "6325cf19-a49b-471e-8d26-7e4df76df0e2": {
      "_id": "6325cf19-a49b-471e-8d26-7e4df76df0e2",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Normalizes raw profile data from GitHub",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Okta Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2022 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "logger.warning("Okta rawProfile: "+rawProfile)",
        "",
        "return json(object(",
        "        field("id", rawProfile.id),",
        "        field("displayName", rawProfile.name),",
        "        field("givenName", rawProfile.first_name),",
        "        field("familyName", rawProfile.last_name),",
        "        field("photoUrl", rawProfile.picture.data.url),",
        "        field("email", rawProfile.email),",
        "        field("username", rawProfile.preferred_username)))",
      ],
    },
    "638c865e-d393-4503-a517-535b9c74e010": {
      "_id": "638c865e-d393-4503-a517-535b9c74e010",
      "context": "CONFIG_PROVIDER_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "CP-InnerTreeEvaluator-static-inner1",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "CP-ITE-static-inner1",
      "script": [
        "/*",
        " * Copyright 2021 ForgeRock AS. All Rights Reserved",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/**",
        " * The following script is a simplified template for understanding how to build",
        " * up a config Map object with custom values. The Config Provider Node will then",
        " * provide this config Map to the desired node type. It is important that the Map",
        " * you build here is named 'config'.",
        " *",
        " * Defined variables:",
        " *",
        " * nodeState - Node State (1)",
        " *           Always present, this represents the current values stored in the node state.",
        " *",
        " * idRepository - Profile Data (2)",
        " *           Always present, a repository to retrieve user information.",
        " *",
        " * secrets - Credentials and Secrets (3)",
        " *           Always present, an interface to access the Secrets API from a scripting context.",
        " *",
        " * requestHeaders (4) - Map (5)",
        " *           Always present, an object that provides methods for accessing headers in the login request.",
        " *",
        " * logger - Debug Logging (6)",
        " *          Always present, the debug logger instance.",
        " *",
        " * httpClient - HTTP Client (7)",
        " *          Always present, the HTTP client that can be used to make external HTTP requests.",
        " *",
        " * realm - String (primitive).",
        " *          Always present, the name of the realm the user is authenticating to.",
        " *",
        " * existingSession - Map<String, String> (5)",
        " *          Present if the request contains the session cookie, the user's session object. The returned map from",
        " *          SSOToken.getProperties() (8)",
        " *",
        " * requestParameters - Map (5)",
        " *          Always present, the object that contains the authentication request parameters.",
        " *",
        " *",
        " * Outputs:",
        " *",
        " * config - Map (5)",
        " *           Define and fill a Map object named 'config' with custom values, this will define the configuration for the",
        " *           associated node selected in the ConfigProviderNode.",
        " *",
        " * Reference:",
        " * (1) Node State - https://backstage.forgerock.com/docs/idcloud-am/latest/authentication-guide/scripting-api-node.html#scripting-api-node-nodeState",
        " * (2) Profile Data - https://backstage.forgerock.com/docs/am/7.1/authentication-guide/scripting-api-node.html#scripting-api-node-id-repo",
        " * (3) Credentials and Secrets - https://backstage.forgerock.com/docs/am/7.1/authentication-guide/scripting-api-node.html#scripting-api-authn-secrets",
        " * (4) Request Headers - https://backstage.forgerock.com/docs/am/7/authentication-guide/scripting-api-node.html#scripting-api-node-requestHeaders.",
        " * (5) Map - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/Map.html",
        " * (6) Debug Logging - https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.",
        " * (7) HTTP Client - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/http/Client.html.",
        " * (8) SSOToken - https://backstage.forgerock.com/docs/am/7/apidocs/com/iplanet/sso/SSOToken.html.",
        " */",
        "",
        "config = {",
        "  tree: 'inner1'",
        "};",
      ],
    },
    "653b70b0-a23d-403a-933b-911371cf84c0": {
      "_id": "653b70b0-a23d-403a-933b-911371cf84c0",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Returns privacy policy collection",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_PrivacyPolicy",
      "script": [
        "var jurisdictions = [",
        "  {",
        "    name: 'Australia',",
        "    url: 'https://backstage.forgerock.com/knowledge/identity-cloud/article/a92472578'",
        "  },",
        "  {",
        "    name: 'Brazil',",
        "    url: 'https://www.forgerock.com/privacy-policy'",
        "  },",
        "  {",
        "    name: 'California',",
        "    url: 'https://backstage.forgerock.com/knowledge/identity-cloud/article/a67552843'",
        "  },",
        "  {",
        "    name: 'Canada',",
        "    url: 'https://backstage.forgerock.com/knowledge/identity-cloud/article/a92472578'",
        "  },",
        "  {",
        "    name: 'European Union',",
        "    url: 'https://backstage.forgerock.com/knowledge/identity-cloud/article/a28580828'",
        "  },",
        "  {",
        "    name: 'Hong Kong',",
        "    url: 'https://www.forgerock.com/resources/view/109827462/overview/identity-cloud-privacy.pdf'",
        "  },",
        "  {",
        "    name: 'Indonesia',",
        "    url: 'https://www.forgerock.com/resources/view/109827462/overview/identity-cloud-privacy.pdf'",
        "  },",
        "  {",
        "    name: 'New Zealand',",
        "    url: 'https://backstage.forgerock.com/knowledge/identity-cloud/article/a92472578'",
        "  },",
        "  {",
        "    name: 'Singapore',",
        "    url: 'https://backstage.forgerock.com/knowledge/identity-cloud/article/a92472578'",
        "  },",
        "  {",
        "    name: 'United Kingdom',",
        "    url: 'https://backstage.forgerock.com/knowledge/identity-cloud/article/a28580828'",
        "  },",
        "  {",
        "    name: 'United States',",
        "    url: 'https://www.forgerock.com/privacy-policy'",
        "  },",
        "  {",
        "    name: 'Rest of the World',",
        "    url: 'https://www.forgerock.com/privacy-policy'",
        "  }",
        "];",
        "",
        "var token = generateNumericToken('xxx');",
        "var inputId = 'jurisdiction-input-'.concat(token);",
        "var selectId = 'jurisdiction-select-'.concat(token);",
        "",
        "// Build the header and instructions",
        "var message = "<h2 class='h2'>Accept Privacy Policy</h2><div style='margin-bottom:1em'>Select your region of residence to review the applicable privacy policy.</div>";",
        "",
        "// Build the jurisdiction dropdown",
        "var dropdown = "<select id='".concat(selectId).concat("' class='custom-select' onchange='document._onJurisdictionChange()'><option value=''>Region of residence</option>");",
        "for (var i = 0; i < jurisdictions.length; i++) {",
        "  var j = jurisdictions[i];",
        "  dropdown = dropdown.concat("<option value='").concat(j.name).concat("' data-url='").concat(j.url).concat("'>").concat(j.name).concat("</option>");",
        "}",
        "dropdown = dropdown.concat("</select>");",
        "",
        "// Build the confirmation checkbox with policy link",
        "var confirm = "<div id='confirm-wrapper' class='custom-control custom-checkbox' style='padding:1rem;visibility:hidden'>".concat(",
        "  "<input id='confirm-check' type='checkbox' class='custom-control-input' onchange='document._setNextButton()'>").concat(",
        "  "<label class='custom-control-label' for='confirm-check'>").concat(",
        "  "I agree to ForgeRock's <a id='policy-link' target=_blank href='" + jurisdictions[0].url + "'>Privacy Policy</a>").concat(",
        "  "</label>").concat(",
        ""</div>");",
        "",
        "var html = message + dropdown + confirm;",
        "",
        "var script =",
        "  'document._onJurisdictionChange = function() {'.concat(",
        "  '  var jurisdiction = getJurisdiction();').concat(",
        "  '  console.log(jurisdiction);').concat(",
        "  '  if (jurisdiction) {').concat(",
        "  '    setPolicyLink(jurisdiction.url);').concat(",
        "  '    setJurisdiction(jurisdiction.name);').concat(",
        "  '    setConfirmVisibility(true);').concat(",
        "  '  } else {').concat(",
        "  '    setJurisdiction("");').concat(",
        "  '    setConfirmVisibility(false);').concat(",
        "  '  }').concat(",
        "  '  document._setNextButton();').concat(",
        "  '};').concat(",
        "    ",
        "  'document._setNextButton = function() {').concat(",
        "  '  var jurisdiction = getJurisdiction();').concat(",
        "  '  var cb = getCheckbox();').concat(",
        "  '  loginHelpers.disableNextButton(!jurisdiction || !cb.checked);').concat(",
        "  '};').concat(",
        "    ",
        "  'var getJurisdiction = function() {').concat(",
        "  '  var sel = document.getElementById("').concat(selectId).concat('");').concat(",
        "  '  var opt = sel.options[sel.selectedIndex];').concat(",
        "  '  return opt.value ? { name: opt.value, url: opt.getAttribute("data-url") } : null;').concat(",
        "  '};').concat(",
        "    ",
        "  'var getCheckbox = function() {').concat(",
        "  '  return document.getElementById("confirm-check");').concat(",
        "  '};').concat(",
        "    ",
        "  'var setConfirmVisibility = function(show) {').concat(",
        "  '  var el = document.getElementById("confirm-wrapper");').concat(",
        "  '  el.style.visibility = show ? "visible" : "hidden";').concat(",
        "  '};').concat(",
        "    ",
        "  'var setPolicyLink = function(url) {').concat(",
        "  '  document.getElementById("policy-link").setAttribute("href", url);').concat(",
        "  '};').concat(",
        "",
        "  'var setJurisdiction = function(name) {').concat(",
        "  '  loginHelpers.setHiddenCallback("').concat(inputId).concat('", name);').concat(",
        "  '};').concat(",
        "    ",
        "  'var isPageReady = function() {').concat(",
        "  '  return document.getElementById("callback_0") != null;').concat(",
        "  '};').concat(",
        "    ",
        "  'var setupPage = function() {').concat(",
        "  '  if (!isPageReady()) {').concat(",
        "  '    return setTimeout(setupPage, 100);').concat(",
        "  '  }').concat(",
        "  '  loginHelpers.disableNextButton(true);').concat(",
        "  '  var container = document.getElementById("callback_0");').concat(",
        "  '  container.insertAdjacentHTML("beforeend", "').concat(html).concat('");').concat(",
        "  '};').concat(",
        "    ",
        "  'setupPage();');",
        "",
        "function isValidJurisdiction(name) {",
        "  for (var i = 0; i < jurisdictions.length; i++) {",
        "    if (jurisdictions[i].name == name) {",
        "      return true;",
        "    }",
        "  }",
        "  return false;",
        "}",
        "",
        "var fr = JavaImporter(",
        "  org.forgerock.openam.auth.node.api.Action,",
        "  com.sun.identity.authentication.callbacks.HiddenValueCallback,",
        "  com.sun.identity.authentication.callbacks.ScriptTextOutputCallback,",
        "  java.util.HashMap",
        ")",
        "",
        "with (fr) {",
        "  if (callbacks.isEmpty() || !isValidJurisdiction(callbacks.get(0).getValue())) {",
        "    action = Action.send(",
        "      new HiddenValueCallback(inputId, ''),",
        "      new ScriptTextOutputCallback(script)",
        "    ).build();",
        "  } else {",
        "    var OBJ_ATTRS = 'objectAttributes';",
        "    var attrs = sharedState.containsKey(OBJ_ATTRS) ? sharedState.get(OBJ_ATTRS) : new HashMap();",
        "    attrs.put('jurisdiction', callbacks.get(0).getValue());",
        "    sharedState.put(OBJ_ATTRS, attrs);",
        "    action = Action.goTo('True').build();",
        "  }",
        "}",
        "",
        " /*",
        "  * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "  * ",
        "  * Example:",
        "  * 'xxxxx' produces '28535'",
        "  * 'xxx-xxx' produces '432-521'",
        "  */",
        "function generateNumericToken(format) {",
        "  return format.replace(/[x]/g, function(c) {",
        "    var r = Math.random()*10|0;",
        "    var v = r;",
        "    return v.toString(10);",
        "  });",
        "}",
      ],
    },
    "68d5a8e7-fcc9-4215-9e63-a01afe8fa849": {
      "_id": "68d5a8e7-fcc9-4215-9e63-a01afe8fa849",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Perform IDP lookup based on email domain. Set users' external IDP in shared state or continue to local authentication.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "IDP Lookup",
      "script": [
        "/* IDP Lookup",
        " * ",
        " * Perform IDP lookup based on email domain. Set users' external IDP in shared state or continue to local authentication.",
        " * ",
        " * This script requires parametrization. Make sure you carefully review the configuration parameters.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - one",
        " * - multiple",
        " * - none",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    logger.message("IDP Lookup: start");",
        "      outcome = "none";",
        "      var username = sharedState.get("username");",
        "      var domain = username.substr(username.lastIndexOf("@")+1);",
        "      var referer = parseUrl(requestHeaders.get("referer").get(0));",
        "",
        "      /* Begin Configuration */",
        "  ",
        "    // long-lived token",
        "    var IDM_API_TOKEN = systemEnv.getProperty("esv.admin.token");",
        "  ",
        "    // IDM API Configuration",
        "    var IDM_API_URI = referer.origin + "/openidm/managed/alpha_organization?_queryFilter=idpDomains+co+'" + domain + "'&_fields=name,description,idpName,idpType,idpDomains,idpJourney,idpTheme,idpPersist,samlConfig";",
        "",
        "      /* End Configuration */",
        "",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setMethod('GET');",
        "    request.setUri(IDM_API_URI);",
        "    request.getHeaders().add("Content-Type", "application/json; charset=UTF-8");",
        "    request.getHeaders().add("Authorization", "Bearer " + IDM_API_TOKEN);",
        "",
        "    var response = httpClient.send(request).get();",
        "    var result = JSON.parse(response.getEntity().getString());",
        "    logger.message("IDP Lookup: JSON result: " + JSON.stringify(result));",
        "    ",
        "      var routedIDPs = result.result.length ? result.result : [{}];",
        "      // stringify the samlConfig property",
        "      routedIDPs.forEach(function (routedIDP, index) {",
        "          routedIDPs[index].samlConfig = JSON.stringify(routedIDP.samlConfig);",
        "    });",
        "      sharedState.put("routedIDPs", routedIDPs);",
        "    if (result.resultCount === 1) {",
        "        logger.message("IDP Lookup: Found exactly 1 IDP");",
        "        outcome = "one";",
        "    }",
        "      else if (result.resultCount > 1) {",
        "        logger.message("IDP Lookup: Found {} IDPs", result.resultCount);",
        "        outcome = "multiple";",
        "    }",
        "      else {",
        "        logger.message("IDP Lookup: Found no IDPs");",
        "    }",
        "    logger.message("IDP Lookup: end [outcome={}]", outcome);",
        "",
        "    /*",
        "     * Parse a URL into its components and make them easily accessible by name",
        "     *",
        "     * Use in a Scripte Decision Node Script as follows:",
        "     * var referer = parseUrl(requestHeaders.get("referer").get(0));",
        "     * var origin = referer.origin;",
        "     * ",
        "     * e.g.: https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/",
        "     * {",
        "     *     hash: '#/',",
        "     *     host: 'openam-volker-dev.forgeblocks.com',",
        "     *     hostname: 'openam-volker-dev.forgeblocks.com',",
        "     *     href: 'https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/',",
        "     *     origin: 'https://openam-volker-dev.forgeblocks.com',",
        "     *     pathname: '/am/XUI/',",
        "     *     port: '',",
        "     *     protocol: 'https',",
        "     *     search: '?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim',",
        "     *     username: '',",
        "     *     password: '',",
        "     *     searchParam: {",
        "     *         realm: '/bravo',",
        "     *         authIndexType: 'service',",
        "     *         authIndexValue: 'InitiateOwnerClaim'",
        "     *     }",
        "     * }",
        "     */",
        "    function parseUrl(href) {",
        "        var m = href.match(/^(([^:\\/?#]+):?(?:\\/\\/((?:([^\\/?#:]*):([^\\/?#:]*)@)?([^\\/?#:]*)(?::([^\\/?#:]*))?)))?([^?#]*)(\\?[^#]*)?(#.*)?$/),",
        "        r = {",
        "            hash: m[10] || "",                      // #/",
        "            host: m[3] || "",                       // openam-volker-dev.forgeblocks.com",
        "            hostname: m[6] || "",                   // openam-volker-dev.forgeblocks.com",
        "            href: m[0] || "",                       // https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/",
        "            origin: m[1] || "",                     // https://openam-volker-dev.forgeblocks.com",
        "            pathname: m[8] || (m[1] ? "/" : ""),    // /am/XUI/",
        "            port: m[7] || "",                       // ",
        "            protocol: m[2] || "",                   // https",
        "            search: m[9] || "",                     // ?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim",
        "            username: m[4] || "",                   // ",
        "            password: m[5] || "",                   // ",
        "            searchParam: {}                         // { realm: '/bravo',",
        "                                                    //   authIndexType: 'service',",
        "                                                    //   authIndexValue: 'InitiateOwnerClaim' }",
        "        };",
        "        if (r.protocol.length == 2) {",
        "            r.protocol = "file:///" + r.protocol.toUpperCase();",
        "            r.origin = r.protocol + "//" + r.host;",
        "        }",
        "        if (r.search.length > 2) {",
        "            var query = (r.search.indexOf('?') === 0) ? r.search.substr(1) : r.search;",
        "            var vars = query.split('&');",
        "            for (var i = 0; i < vars.length; i++) {",
        "            var pair = vars[i].split('=');",
        "            r.searchParam[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1]);",
        "            }",
        "        }",
        "        r.href = r.origin + r.pathname + r.search + r.hash;",
        "        return r;",
        "    };",
        "}());",
      ],
    },
    "6963d84e-e2f0-4db1-a746-116604189602": {
      "_id": "6963d84e-e2f0-4db1-a746-116604189602",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_SetCurrentYear",
      "script": [
        "var currentYear = new Date().getFullYear().toString();",
        "",
        "var objAttrs = sharedState.get('objectAttributes') || new java.util.HashMap();",
        "objAttrs.put('currentYear', currentYear);",
        "sharedState.put('objectAttributes', objAttrs);",
        "",
        "outcome = 'True';",
        "",
      ],
    },
    "6ad22934-5d12-43a6-96a7-a2fba8d999bf": {
      "_id": "6ad22934-5d12-43a6-96a7-a2fba8d999bf",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Call out to University of Phoenix Course Registration System and get current course.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "UOP Get Course ID",
      "script": [
        "/* UOP Get Course ID",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Call out to University of Phoenix Course Registration System and get current class.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is. ",
        " * It requires the Identify Existing User node before it is being called.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - has classes",
        " * - no classes",
        " * - error",
        " */",
        "logger.warning("UOP Get Course ID: start now");",
        "",
        "outcome = "error";",
        "",
        "if (sharedState.get("_id") && idRepository.getAttribute(sharedState.get("_id"), "mail").iterator().hasNext()) {",
        "",
        "       /* BEGIN SCRIPT CONFIGURATION",
        "     *",
        "     * REPLACE WITH YOUR OWN API SETTINGS",
        "     */",
        "      var email = idRepository.getAttribute(sharedState.get("_id"), "mail").iterator().next();",
        "    var UOP_CLASS_API_URI = "https://dy4rpew5va.execute-api.us-east-1.amazonaws.com/forgerock/course?courseId=CES422";",
        "      //var UOP_CLASS_API_URI = "https://dy4rpew5va.execute-api.us-east-1.amazonaws.com/forgerock/course?emailId=".concat(email);",
        "    /*",
        "     * END SCRIPT CONFIGURATION",
        "     */",
        "",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setMethod('GET');",
        "    request.setUri(UOP_CLASS_API_URI);",
        "",
        "    var response = httpClient.send(request).get();",
        "    var UOPClassID = response.getEntity().getString();",
        "    logger.warning("UOP Get Course ID: API call result: Course ID=".concat(UOPClassID));",
        "",
        "    /* Sample API response",
        "    CES421",
        "    */",
        "",
        "    if (UOPClassID) {",
        "        outcome = "has classes";",
        "",
        "        // preserve result in shared state",
        "        sharedState.put("uopCurrentClassID", UOPClassID);",
        "    } ",
        "    else if (UOPClassID === "") {",
        "        outcome = "no classes";",
        "    }",
        "    else {",
        "        outcome = "error";",
        "    }",
        "",
        "} else {",
        "    logger.error("UOP Get Course ID: no classes!");",
        "}",
        "",
        "logger.warning("UOP Get Course ID: End (outcome=".concat(outcome).concat(")"));",
      ],
    },
    "6b3cfd48-62d3-48ff-a96f-fe8f3a22ab30": {
      "_id": "6b3cfd48-62d3-48ff-a96f-fe8f3a22ab30",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from Amazon",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Amazon Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "return json(object(",
        "        field("id", rawProfile.user_id),",
        "        field("displayName", rawProfile.name),",
        "        field("email", rawProfile.email),",
        "        field("username", rawProfile.email)))",
      ],
    },
    "6d6c2202-725b-4196-9436-92ec11a0b385": {
      "_id": "6d6c2202-725b-4196-9436-92ec11a0b385",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Display sharedState and transientState.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Display States - imported (2)",
      "script": [
        "/* Display States",
        " * ",
        " * Display sharedState and transientState.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    outcome = "true";",
        "",
        "    var anchor = "anchor-".concat(generateNumericToken('xxx'));",
        "    var halign = "left";",
        "    var message = "<h4>Current State Values</h4>".concat(",
        "        "<p><b>Shared State</b>:<br/>").concat(",
        "        sharedState.toString()).concat("</p>").concat(",
        "        "<p><b>Transient State</b>:<br/>").concat(",
        "        transientState.toString()).concat("</p>")",
        "    var script = "Array.prototype.slice.call(\\n".concat(",
        "      "document.getElementsByClassName('callback-component')).forEach(\\n").concat(",
        "      "function (e) {\\n").concat(",
        "      "  var message = e.firstElementChild;\\n").concat(",
        "      "  if (message.firstChild && message.firstChild.nodeName == '#text' && message.firstChild.nodeValue.trim() == '").concat(anchor).concat("') {\\n").concat(",
        "      "    message.className = \\"\\";\\n").concat(",
        "      "    message.style = \\"text-align: left; inline-size: 430px; overflow-wrap: break-word;\\";\\n").concat(",
        "      "    message.align = \\"").concat(halign).concat("\\";\\n").concat(",
        "      "    message.innerHTML = '").concat(message).concat("';\\n").concat(",
        "      "  }\\n").concat(",
        "      "})")",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "        javax.security.auth.callback.TextOutputCallback,",
        "        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        "    )",
        "    if (message.length && callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "            new fr.TextOutputCallback(",
        "                fr.TextOutputCallback.INFORMATION,",
        "                anchor",
        "            ),",
        "            new fr.ScriptTextOutputCallback(script)",
        "        ).build()",
        "    }",
        "    else {",
        "      action = fr.Action.goTo(outcome).build();",
        "    }",
        "",
        "     /*",
        "      * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "      * ",
        "      * Example:",
        "      * 'xxxxx' produces '28535'",
        "      * 'xxx-xxx' produces '432-521'",
        "      */",
        "    function generateNumericToken(format) {",
        "        return format.replace(/[x]/g, function(c) {",
        "            var r = Math.random()*10|0;",
        "            var v = r;",
        "            return v.toString(10);",
        "        });",
        "    }",
        "}());",
      ],
    },
    "6dfc6de4-64cb-4d47-8269-6c5ced44344d": {
      "_id": "6dfc6de4-64cb-4d47-8269-6c5ced44344d",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_IsInvited",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "if (sharedState.get('invited') == true) {",
        "  outcome = 'True';",
        "} else {",
        "  outcome = 'False';",
        "}",
      ],
    },
    "703dab1a-1921-4981-98dd-b8e5349d8548": {
      "_id": "703dab1a-1921-4981-98dd-b8e5349d8548",
      "context": "AUTHENTICATION_SERVER_SIDE",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Default global script for server side Device Id (Match) Authentication Module",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Device Id (Match) - Server Side",
      "script": [
        "/*",
        " * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS HEADER.",
        " *",
        " * Copyright (c) 2009 Sun Microsystems Inc. All Rights Reserved",
        " *",
        " * The contents of this file are subject to the terms",
        " * of the Common Development and Distribution License",
        " * (the License). You may not use this file except in",
        " * compliance with the License.",
        " *",
        " * You can obtain a copy of the License at",
        " * https://opensso.dev.java.net/public/CDDLv1.0.html or",
        " * opensso/legal/CDDLv1.0.txt",
        " * See the License for the specific language governing",
        " * permission and limitations under the License.",
        " *",
        " * When distributing Covered Code, include this CDDL",
        " * Header Notice in each file and include the License file",
        " * at opensso/legal/CDDLv1.0.txt.",
        " * If applicable, add the following below the CDDL Header,",
        " * with the fields enclosed by brackets [] replaced by",
        " * your own identifying information:",
        " * "Portions Copyrighted [year] [name of copyright owner]"",
        " *",
        " */",
        "/*",
        " * Portions Copyrighted 2013 Syntegrity.",
        " * Portions Copyrighted 2013-2018 ForgeRock AS.",
        " */",
        "",
        "var ScalarComparator = {}, ScreenComparator = {}, MultiValueComparator = {}, UserAgentComparator = {}, GeolocationComparator = {};",
        "",
        "var config = {",
        "    profileExpiration: 30,              //in days",
        "    maxProfilesAllowed: 5,",
        "    maxPenaltyPoints: 0,",
        "    attributes: {",
        "        screen: {",
        "            required: true,",
        "            comparator: ScreenComparator,",
        "            args: {",
        "                penaltyPoints: 50",
        "            }",
        "        },",
        "        plugins: {",
        "            installedPlugins: {",
        "                required: false,",
        "                comparator: MultiValueComparator,",
        "                args: {",
        "                    maxPercentageDifference: 10,",
        "                    maxDifferences: 5,",
        "                    penaltyPoints: 100",
        "                }",
        "            }",
        "        },",
        "        fonts: {",
        "            installedFonts: {",
        "                required: false,",
        "                comparator: MultiValueComparator,",
        "                args: {",
        "                    maxPercentageDifference: 10,",
        "                    maxDifferences: 5,",
        "                    penaltyPoints: 100",
        "                }",
        "            }",
        "        },",
        "        timezone: {",
        "            timezone: {",
        "                required: false,",
        "                comparator: ScalarComparator,",
        "                args: {",
        "                    penaltyPoints: 100",
        "                }",
        "            }",
        "        },",
        "        userAgent: {",
        "            required: true,",
        "            comparator: UserAgentComparator,",
        "            args: {",
        "                ignoreVersion: true,",
        "                penaltyPoints: 100",
        "            }",
        "        },",
        "        geolocation: {",
        "            required: false,",
        "            comparator: GeolocationComparator,",
        "            args: {",
        "                allowedRange: 100,            //in miles",
        "                penaltyPoints: 100",
        "            }",
        "        }",
        "    }",
        "};",
        "",
        "//---------------------------------------------------------------------------//",
        "//                           Comparator functions                            //",
        "//---------------------------------------------------------------------------//",
        "",
        "var all, any, calculateDistance, calculateIntersection, calculatePercentage, nullOrUndefined, splitAndTrim,",
        "    undefinedLocation;",
        "",
        "// ComparisonResult",
        "",
        "/**",
        " * Constructs an instance of a ComparisonResult with the given penalty points.",
        " *",
        " * @param penaltyPoints (Number) The penalty points for the comparison (defaults to 0).",
        " * @param additionalInfoInCurrentValue (boolean) Whether the current value contains more information",
        " *                                               than the stored value (defaults to false).",
        " */",
        "function ComparisonResult() {",
        "",
        "    var penaltyPoints = 0,",
        "        additionalInfoInCurrentValue = false;",
        "",
        "    if (arguments[0] !== undefined && arguments[1] !== undefined) {",
        "        penaltyPoints = arguments[0];",
        "        additionalInfoInCurrentValue = arguments[1];",
        "    }",
        "",
        "    if (arguments[0] !== undefined && arguments[1] === undefined) {",
        "        if (typeof(arguments[0]) === "boolean") {",
        "            additionalInfoInCurrentValue = arguments[0];",
        "        } else {",
        "            penaltyPoints = arguments[0];",
        "        }",
        "    }",
        "",
        "    this.penaltyPoints = penaltyPoints;",
        "    this.additionalInfoInCurrentValue = additionalInfoInCurrentValue;",
        "",
        "}",
        "",
        "ComparisonResult.ZERO_PENALTY_POINTS = new ComparisonResult(0);",
        "",
        "/**",
        " * Static method for functional programming.",
        " *",
        " * @return boolean true if comparisonResult.isSuccessful().",
        " */",
        "ComparisonResult.isSuccessful =  function(comparisonResult) {",
        "    return comparisonResult.isSuccessful();",
        "};",
        "",
        "",
        "/**",
        " * Static method for functional programming.",
        " *",
        " * @return boolean true if comparisonResult.additionalInfoInCurrentValue.",
        " */",
        "ComparisonResult.additionalInfoInCurrentValue =  function(comparisonResult) {",
        "    return comparisonResult.additionalInfoInCurrentValue;",
        "};",
        "",
        "/**",
        " * Comparison function that can be provided as an argument to array.sort",
        " */",
        "ComparisonResult.compare = function(first, second) {",
        "    if (nullOrUndefined(first) && nullOrUndefined(second)) {",
        "        return 0;",
        "    } else if (nullOrUndefined(first)) {",
        "        return -1;",
        "    } else if (nullOrUndefined(second)) {",
        "        return 1;",
        "    } else {",
        "        if (first.penaltyPoints !== second.penaltyPoints) {",
        "            return first.penaltyPoints - second.penaltyPoints;",
        "        } else {",
        "            return (first.additionalInfoInCurrentValue ? 1 : 0) - (second.additionalInfoInCurrentValue ? 1 : 0);",
        "        }",
        "    }",
        "};",
        "",
        "/**",
        " * Amalgamates the given ComparisonResult into this ComparisonResult.",
        " *",
        " * @param comparisonResult The ComparisonResult to include.",
        " */",
        "ComparisonResult.prototype.addComparisonResult = function(comparisonResult) {",
        "    this.penaltyPoints += comparisonResult.penaltyPoints;",
        "    if (comparisonResult.additionalInfoInCurrentValue) {",
        "        this.additionalInfoInCurrentValue = comparisonResult.additionalInfoInCurrentValue;",
        "    }",
        "};",
        "",
        "/**",
        " * Returns true if no penalty points have been assigned for the comparison.",
        " *",
        " * @return boolean true if the comparison was successful.",
        " */",
        "ComparisonResult.prototype.isSuccessful = function() {",
        "    return nullOrUndefined(this.penaltyPoints) || this.penaltyPoints === 0;",
        "};",
        "",
        "/**",
        " * Compares two simple objects (String|Number) and if they are equal then returns a ComparisonResult with zero",
        " * penalty points assigned, otherwise returns a ComparisonResult with the given number of penalty points assigned.",
        " *",
        " * @param currentValue (String|Number) The current value.",
        " * @param storedValue (String|Number) The stored value.",
        " * @param config: {",
        " *            "penaltyPoints": (Number) The number of penalty points.",
        " *        }",
        " * @return ComparisonResult.",
        " */",
        "ScalarComparator.compare = function (currentValue, storedValue, config) {",
        "    if (logger.messageEnabled()) {",
        "        logger.message("StringComparator.compare:currentValue: " + JSON.stringify(currentValue));",
        "        logger.message("StringComparator.compare:storedValue: " + JSON.stringify(storedValue));",
        "        logger.message("StringComparator.compare:config: " + JSON.stringify(config));",
        "    }",
        "    if (config.penaltyPoints === 0) {",
        "        return ComparisonResult.ZERO_PENALTY_POINTS;",
        "    }",
        "",
        "    if (!nullOrUndefined(storedValue)) {",
        "        if (nullOrUndefined(currentValue) || currentValue !== storedValue) {",
        "            return new ComparisonResult(config.penaltyPoints);",
        "        }",
        "    } else if (!nullOrUndefined(currentValue)) {",
        "        return new ComparisonResult(true);",
        "    }",
        "",
        "    return ComparisonResult.ZERO_PENALTY_POINTS;",
        "};",
        "",
        "/**",
        " * Compares two screens and if they are equal then returns a ComparisonResult with zero penalty points assigned,",
        " * otherwise returns a ComparisonResult with the given number of penalty points assigned.",
        " *",
        " * @param currentValue: {",
        " *            "screenWidth": (Number) The current client screen width.",
        " *            "screenHeight": (Number) The current client screen height.",
        " *            "screenColourDepth": (Number) The current client screen colour depth.",
        " *        }",
        " * @param storedValue: {",
        " *            "screenWidth": (Number) The stored client screen width.",
        " *            "screenHeight": (Number) The stored client screen height.",
        " *            "screenColourDepth": (Number) The stored client screen colour depth.",
        " *        }",
        " * @param config: {",
        " *            "penaltyPoints": (Number) The number of penalty points.",
        " *        }",
        " * @return ComparisonResult",
        " */",
        "ScreenComparator.compare = function (currentValue, storedValue, config) {",
        "    if (logger.messageEnabled()) {",
        "        logger.message("ScreenComparator.compare:currentValue: " + JSON.stringify(currentValue));",
        "        logger.message("ScreenComparator.compare:storedValue: " + JSON.stringify(storedValue));",
        "        logger.message("ScreenComparator.compare:config: " + JSON.stringify(config));",
        "    }",
        "",
        "    if (nullOrUndefined(currentValue)) {",
        "        currentValue = {screenWidth: null, screenHeight: null, screenColourDepth: null};",
        "    }",
        "    if (nullOrUndefined(storedValue)) {",
        "        storedValue = {screenWidth: null, screenHeight: null, screenColourDepth: null};",
        "    }",
        "",
        "    var comparisonResults = [",
        "        ScalarComparator.compare(currentValue.screenWidth, storedValue.screenWidth, config),",
        "        ScalarComparator.compare(currentValue.screenHeight, storedValue.screenHeight, config),",
        "        ScalarComparator.compare(currentValue.screenColourDepth, storedValue.screenColourDepth, config)];",
        "",
        "    if (all(comparisonResults, ComparisonResult.isSuccessful)) {",
        "        return new ComparisonResult(any(comparisonResults, ComparisonResult.additionalInfoInCurrentValue));",
        "    } else {",
        "        return new ComparisonResult(config.penaltyPoints);",
        "    }",
        "};",
        "",
        "/**",
        " * Splits both values using delimiter, trims every value and compares collections of values.",
        " * Returns zero-result for same multi-value attributes.",
        " *",
        " * If collections are not same checks if number of differences is less or equal maxDifferences or",
        " * percentage of difference is less or equal maxPercentageDifference.",
        " *",
        " * If yes then returns zero-result with additional info, else returns penaltyPoints-result.",
        " *",
        " * @param currentValue: (String) The current value.",
        " * @param storedValue: (String) The stored value.",
        " * @param config: {",
        " *            "maxPercentageDifference": (Number) The max difference percentage in the values,",
        " *                                                before the penalty is assigned.",
        " *            "maxDifferences": (Number) The max number of differences in the values,",
        " *                                       before the penalty points are assigned.",
        " *            "penaltyPoints": (Number) The number of penalty points.",
        "  *        }",
        " * @return ComparisonResult",
        " */",
        "MultiValueComparator.compare = function (currentValue, storedValue, config) {",
        "    if (logger.messageEnabled()) {",
        "        logger.message("MultiValueComparator.compare:currentValue: " + JSON.stringify(currentValue));",
        "        logger.message("MultiValueComparator.compare:storedValue: " + JSON.stringify(storedValue));",
        "        logger.message("MultiValueComparator.compare:config: " + JSON.stringify(config));",
        "    }",
        "",
        "    var delimiter = ";",",
        "        currentValues = splitAndTrim(currentValue, delimiter),",
        "        storedValues = splitAndTrim(storedValue, delimiter),",
        "        maxNumberOfElements = Math.max(currentValues.length, storedValues.length),",
        "        numberOfTheSameElements = calculateIntersection(currentValues, storedValues).length,",
        "        numberOfDifferences = maxNumberOfElements - numberOfTheSameElements,",
        "        percentageOfDifferences = calculatePercentage(numberOfDifferences, maxNumberOfElements);",
        "",
        "    if (nullOrUndefined(storedValue) && !nullOrUndefined(currentValue)) {",
        "        return new ComparisonResult(true);",
        "    }",
        "",
        "    if (logger.messageEnabled()) {",
        "        logger.message(numberOfTheSameElements + " of " + maxNumberOfElements + " are same");",
        "    }",
        "",
        "    if (maxNumberOfElements === 0) {",
        "        logger.message("Ignored because no attributes found in both profiles");",
        "        return ComparisonResult.ZERO_PENALTY_POINTS;",
        "    }",
        "",
        "    if (numberOfTheSameElements === maxNumberOfElements) {",
        "        logger.message("Ignored because all attributes are same");",
        "        return ComparisonResult.ZERO_PENALTY_POINTS;",
        "    }",
        "",
        "    if (numberOfDifferences > config.maxDifferences) {",
        "        if (logger.messageEnabled()) {",
        "            logger.message("Would be ignored if not more than " + config.maxDifferences + " differences");",
        "        }",
        "        return new ComparisonResult(config.penaltyPoints);",
        "    }",
        "",
        "    if (percentageOfDifferences > config.maxPercentageDifference) {",
        "        if (logger.messageEnabled()) {",
        "            logger.message(percentageOfDifferences + " percents are different");",
        "            logger.message("Would be ignored if not more than " + config.maxPercentageDifference + " percent");",
        "        }",
        "        return new ComparisonResult(config.penaltyPoints);",
        "    }",
        "",
        "    if (logger.messageEnabled()) {",
        "        logger.message("Ignored because number of differences(" + numberOfDifferences + ") not more than "",
        "            + config.maxDifferences);",
        "        logger.message(percentageOfDifferences + " percents are different");",
        "        logger.message("Ignored because not more than " + config.maxPercentageDifference + " percent");",
        "    }",
        "    return new ComparisonResult(true);",
        "};",
        "",
        "/**",
        " * Compares two User Agent Strings and if they are equal then returns a ComparisonResult with zero penalty",
        " * points assigned, otherwise returns a ComparisonResult with the given number of penalty points assigned.",
        " *",
        " * @param currentValue (String) The current value.",
        " * @param storedValue (String) The stored value.",
        " * @param config: {",
        " *            "ignoreVersion": (boolean) If the version numbers in the User Agent Strings should be ignore",
        " *                                       in the comparison.",
        " *            "penaltyPoints": (Number) The number of penalty points.",
        " *        }",
        " * @return A ComparisonResult.",
        " */",
        "UserAgentComparator.compare = function (currentValue, storedValue, config) {",
        "    if (logger.messageEnabled()) {",
        "        logger.message("UserAgentComparator.compare:currentValue: " + JSON.stringify(currentValue));",
        "        logger.message("UserAgentComparator.compare:storedValue: " + JSON.stringify(storedValue));",
        "        logger.message("UserAgentComparator.compare:config: " + JSON.stringify(config));",
        "    }",
        "",
        "    if (config.ignoreVersion) {",
        "        // remove version number",
        "        currentValue = nullOrUndefined(currentValue) ? null : currentValue.replace(/[\\d\\.]+/g, "").trim();",
        "        storedValue = nullOrUndefined(storedValue) ? null : storedValue.replace(/[\\d\\.]+/g, "").trim();",
        "    }",
        "",
        "    return ScalarComparator.compare(currentValue, storedValue, config);",
        "};",
        "",
        "/**",
        " * Compares two locations, taking into account a degree of difference.",
        " *",
        " * @param currentValue: {",
        " *            "latitude": (Number) The current latitude.",
        " *            "longitude": (Number) The current longitude.",
        " *        }",
        " * @param storedValue: {",
        " *            "latitude": (Number) The stored latitude.",
        " *            "longitude": (Number) The stored longitude.",
        " *        }",
        " * @param config: {",
        " *            "allowedRange": (Number) The max difference allowed in the two locations, before the penalty is assigned.",
        " *            "penaltyPoints": (Number) The number of penalty points.",
        "*         }",
        " * @return ComparisonResult",
        " */",
        "GeolocationComparator.compare = function (currentValue, storedValue, config) {",
        "    if (logger.messageEnabled()) {",
        "        logger.message("GeolocationComparator.compare:currentValue: " + JSON.stringify(currentValue));",
        "        logger.message("GeolocationComparator.compare:storedValue: " + JSON.stringify(storedValue));",
        "        logger.message("GeolocationComparator.compare:config: " + JSON.stringify(config));",
        "    }",
        "",
        "    // Check for undefined stored or current locations",
        "",
        "    if (undefinedLocation(currentValue) && undefinedLocation(storedValue)) {",
        "        return ComparisonResult.ZERO_PENALTY_POINTS;",
        "    }",
        "    if (undefinedLocation(currentValue) && !undefinedLocation(storedValue)) {",
        "        return new ComparisonResult(config.penaltyPoints);",
        "    }",
        "    if (!undefinedLocation(currentValue) && undefinedLocation(storedValue)) {",
        "        return new ComparisonResult(true);",
        "    }",
        "",
        "    // Both locations defined, therefore perform comparison",
        "",
        "    var distance = calculateDistance(currentValue, storedValue);",
        "",
        "    if (logger.messageEnabled()) {",
        "        logger.message("Distance between (" + currentValue.latitude + "," + currentValue.longitude + ") and (" +",
        "            storedValue.latitude + "," + storedValue.longitude + ") is " + distance + " miles");",
        "    }",
        "",
        "    if (parseFloat(distance.toPrecision(5)) === 0) {",
        "        logger.message("Location is the same");",
        "        return ComparisonResult.ZERO_PENALTY_POINTS;",
        "    }",
        "",
        "    if (distance <= config.allowedRange) {",
        "        if (logger.messageEnabled()) {",
        "            logger.message("Tolerated because distance not more then " + config.allowedRange);",
        "        }",
        "        return new ComparisonResult(true);",
        "    } else {",
        "        if (logger.messageEnabled()) {",
        "            logger.message("Would be ignored if distance not more then " + config.allowedRange);",
        "        }",
        "        return new ComparisonResult(config.penaltyPoints);",
        "    }",
        "};",
        "",
        "",
        "//---------------------------------------------------------------------------//",
        "//                    Device Print Logic - DO NOT MODIFY                     //",
        "//---------------------------------------------------------------------------//",
        "",
        "// Utility functions",
        "",
        "/**",
        " * Returns true if evaluating function f on each element of the Array a returns true.",
        " *",
        " * @param a: (Array) The array of elements to evaluate",
        " * @param f: (Function) A single argument function for mapping elements of the array to boolean.",
        " * @return boolean.",
        " */",
        "all = function(a, f) {",
        "    var i;",
        "    for (i = 0; i < a.length; i++) {",
        "        if (f(a[i]) === false) {",
        "            return false;",
        "        }",
        "    }",
        "    return true;",
        "};",
        "",
        "/**",
        " * Returns true if evaluating function f on any element of the Array a returns true.",
        " *",
        " * @param a: (Array) The array of elements to evaluate",
        " * @param f: (Function) A single argument function for mapping elements of the array to boolean.",
        " * @return boolean.",
        " */",
        "any = function(a, f) {",
        "    var i;",
        "    for (i = 0; i < a.length; i++) {",
        "        if (f(a[i]) === true) {",
        "            return true;",
        "        }",
        "    }",
        "    return false;",
        "};",
        "",
        "/**",
        " * Returns true if the provided location is null or has undefined longitude or latitude values.",
        " *",
        " * @param location: {",
        " *            "latitude": (Number) The latitude.",
        " *            "longitude": (Number) The longitude.",
        " *        }",
        " * @return boolean",
        " */",
        "undefinedLocation = function(location) {",
        "    return nullOrUndefined(location) || nullOrUndefined(location.latitude) || nullOrUndefined(location.longitude);",
        "};",
        "",
        "/**",
        " * Returns true if the provided value is null or undefined.",
        " *",
        " * @param value: a value of any type",
        " * @return boolean",
        " */",
        "nullOrUndefined = function(value) {",
        "    return value === null || value === undefined;",
        "};",
        "",
        "/**",
        " * Calculates the distances between the two locations.",
        " *",
        " * @param first: {",
        " *            "latitude": (Number) The first latitude.",
        " *            "longitude": (Number) The first longitude.",
        " *        }",
        " * @param second: {",
        " *            "latitude": (Number) The second latitude.",
        " *            "longitude": (Number) The second longitude.",
        " *        }",
        " * @return Number The distance between the two locations.",
        " */",
        "calculateDistance = function(first, second) {",
        "    var factor = (Math.PI / 180),",
        "        theta,",
        "        dist;",
        "    function degreesToRadians(degrees) {",
        "        return degrees * factor;",
        "    }",
        "    function radiansToDegrees(radians) {",
        "        return radians / factor;",
        "    }",
        "    theta = first.longitude - second.longitude;",
        "    dist = Math.sin(degreesToRadians(first.latitude)) * Math.sin(degreesToRadians(second.latitude))",
        "        + Math.cos(degreesToRadians(first.latitude)) * Math.cos(degreesToRadians(second.latitude))",
        "        * Math.cos(degreesToRadians(theta));",
        "    dist = Math.acos(dist);",
        "    dist = radiansToDegrees(dist);",
        "    dist = dist * 60 * 1.1515;",
        "    return dist;",
        "};",
        "",
        "/**",
        " * Converts a String holding a delimited sequence of values into an array.",
        " *",
        " * @param text (String) The String representation of a delimited sequence of values.",
        " * @param delimiter (String) The character delimiting values within the text String.",
        " * @return (Array) The comma separated values.",
        " */",
        "splitAndTrim = function(text, delimiter) {",
        "",
        "    var results = [],",
        "        i,",
        "        values,",
        "        value;",
        "    if (text === null) {",
        "        return results;",
        "    }",
        "",
        "    values = text.split(delimiter);",
        "    for (i = 0; i < values.length; i++) {",
        "        value = values[i].trim();",
        "        if (value !== "") {",
        "            results.push(value);",
        "        }",
        "    }",
        "",
        "    return results;",
        "};",
        "",
        "/**",
        " * Converts value to a percentage of range.",
        " *",
        " * @param value (Number) The actual number to be converted to a percentage.",
        " * @param range (Number) The total number of values (i.e. represents 100%).",
        " * @return (Number) The percentage.",
        " */",
        "calculatePercentage = function(value, range) {",
        "    if (range === 0) {",
        "        return 0;",
        "    }",
        "    return parseFloat((value / range).toPrecision(2)) * 100;",
        "};",
        "",
        "/**",
        " * Creates a new array containing only those elements found in both arrays received as arguments.",
        " *",
        " * @param first (Array) The first array.",
        " * @param second (Array) The second array.",
        " * @return (Array) The elements that found in first and second.",
        " */",
        "calculateIntersection = function(first, second) {",
        "    return first.filter(function(element) {",
        "        return second.indexOf(element) !== -1;",
        "    });",
        "};",
        "",
        "function getValue(obj, attributePath) {",
        "    var value = obj,",
        "        i;",
        "    for (i = 0; i < attributePath.length; i++) {",
        "        if (value === undefined) {",
        "            return null;",
        "        }",
        "        value = value[attributePath[i]];",
        "    }",
        "    return value;",
        "}",
        "",
        "",
        "function isLeafNode(attributeConfig) {",
        "    return attributeConfig.comparator !== undefined;",
        "}",
        "",
        "function getAttributePaths(attributeConfig, attributePath) {",
        "",
        "    var attributePaths = [],",
        "        attributeName,",
        "        attrPaths,",
        "        attrPath,",
        "        i;",
        "",
        "    for (attributeName in attributeConfig) {",
        "        if (attributeConfig.hasOwnProperty(attributeName)) {",
        "",
        "            if (isLeafNode(attributeConfig[attributeName])) {",
        "                attrPath = attributePath.slice();",
        "                attrPath.push(attributeName);",
        "                attributePaths.push(attrPath);",
        "            } else {",
        "                attrPath = attributePath.slice();",
        "                attrPath.push(attributeName);",
        "                attrPaths = getAttributePaths(attributeConfig[attributeName], attrPath);",
        "                for (i = 0; i < attrPaths.length; i++) {",
        "                    attributePaths.push(attrPaths[i]);",
        "                }",
        "            }",
        "        }",
        "    }",
        "",
        "    return attributePaths;",
        "}",
        "",
        "function getDevicePrintAttributePaths(attributeConfig) {",
        "    return getAttributePaths(attributeConfig, []);",
        "}",
        "",
        "function hasRequiredAttributes(devicePrint, attributeConfig) {",
        "",
        "    var attributePaths = getDevicePrintAttributePaths(attributeConfig),",
        "        i,",
        "        attrValue,",
        "        attrConfig;",
        "",
        "    for (i = 0; i < attributePaths.length; i++) {",
        "",
        "        attrValue = getValue(devicePrint, attributePaths[i]);",
        "        attrConfig = getValue(attributeConfig, attributePaths[i]);",
        "",
        "        if (attrConfig.required && attrValue === undefined) {",
        "            logger.warning("Device Print profile missing required attribute, " + attributePaths[i]);",
        "            return false;",
        "        }",
        "    }",
        "",
        "    logger.message("device print has required attributes");",
        "    return true;",
        "}",
        "",
        "function compareDevicePrintProfiles(attributeConfig, devicePrint, devicePrintProfiles, maxPenaltyPoints) {",
        "",
        "    var attributePaths = getDevicePrintAttributePaths(attributeConfig),",
        "        dao = sharedState.get('_DeviceIdDao'),",
        "        results,",
        "        j,",
        "        aggregatedComparisonResult,",
        "        i,",
        "        currentValue,",
        "        storedValue,",
        "        attrConfig,",
        "        comparisonResult,",
        "        selectedComparisonResult,",
        "        selectedProfile,",
        "        curDevicePrintProfile,",
        "        vals;",
        "",
        "    results = [];",
        "    for (j = 0; j < devicePrintProfiles.length; j++) {",
        "        curDevicePrintProfile = JSON.parse(org.forgerock.json.JsonValue.json(devicePrintProfiles[j]));",
        "        aggregatedComparisonResult = new ComparisonResult();",
        "        for (i = 0; i < attributePaths.length; i++) {",
        "",
        "            currentValue = getValue(devicePrint, attributePaths[i]);",
        "            storedValue = getValue(curDevicePrintProfile.devicePrint, attributePaths[i]);",
        "            attrConfig = getValue(attributeConfig, attributePaths[i]);",
        "",
        "            if (storedValue === null) {",
        "                comparisonResult = new ComparisonResult(attrConfig.penaltyPoints);",
        "            } else {",
        "                comparisonResult = attrConfig.comparator.compare(currentValue, storedValue, attrConfig.args);",
        "            }",
        "",
        "            if (logger.messageEnabled()) {",
        "                logger.message("Comparing attribute path: " + attributePaths[i]",
        "                    + ", Comparison result: successful=" + comparisonResult.isSuccessful() + ", penaltyPoints="",
        "                    + comparisonResult.penaltyPoints + ", additionalInfoInCurrentValue="",
        "                    + comparisonResult.additionalInfoInCurrentValue);",
        "            }",
        "            aggregatedComparisonResult.addComparisonResult(comparisonResult);",
        "        }",
        "        if (logger.messageEnabled()) {",
        "            logger.message("Aggregated comparison result: successful="",
        "                + aggregatedComparisonResult.isSuccessful() + ", penaltyPoints="",
        "                + aggregatedComparisonResult.penaltyPoints + ", additionalInfoInCurrentValue="",
        "                + aggregatedComparisonResult.additionalInfoInCurrentValue);",
        "        }",
        "",
        "        results.push({",
        "            key: aggregatedComparisonResult,",
        "            value: devicePrintProfiles[j]",
        "        });",
        "    }",
        "",
        "    if (results.length === 0) {",
        "        return null;",
        "    }",
        "",
        "    results.sort(function(a, b) {",
        "        return ComparisonResult.compare(a.key, b.key);",
        "    });",
        "    selectedComparisonResult = results[0].key;",
        "    if (logger.messageEnabled()) {",
        "        logger.message("Selected comparison result: successful=" + selectedComparisonResult.isSuccessful()",
        "            + ", penaltyPoints=" + selectedComparisonResult.penaltyPoints + ", additionalInfoInCurrentValue="",
        "            + selectedComparisonResult.additionalInfoInCurrentValue);",
        "    }",
        "",
        "    selectedProfile = null;",
        "    if (selectedComparisonResult.penaltyPoints <= maxPenaltyPoints) {",
        "        selectedProfile = results[0].value;",
        "        if (logger.messageEnabled()) {",
        "            logger.message("Selected profile: " + selectedProfile +",
        "                " with " + selectedComparisonResult.penaltyPoints + " penalty points");",
        "        }",
        "    }",
        "",
        "    if (selectedProfile === null) {",
        "        return false;",
        "    }",
        "",
        "    /* update profile */",
        "    selectedProfile.put("selectionCounter",",
        "        java.lang.Integer.valueOf(parseInt(selectedProfile.get("selectionCounter"), 10) + 1));",
        "    selectedProfile.put("lastSelectedDate", java.lang.Long.valueOf(new Date().getTime()));",
        "    selectedProfile.put("devicePrint", devicePrint);",
        "",
        "    vals = [];",
        "    for (i = 0; i < devicePrintProfiles.length; i++) {",
        "        vals.push(org.forgerock.json.JsonValue.json(devicePrintProfiles[i]));",
        "    }",
        "",
        "    dao.saveDeviceProfiles(username, realm, vals);",
        "",
        "    return true;",
        "}",
        "",
        "function matchDevicePrint() {",
        "",
        "    if (!username) {",
        "        logger.error("Username not set. Cannot compare user's device print profiles.");",
        "        authState = FAILED;",
        "    } else {",
        "",
        "        if (logger.messageEnabled()) {",
        "            logger.message("client devicePrint: " + clientScriptOutputData);",
        "        }",
        "",
        "        var getProfiles = function () {",
        "",
        "                function isExpiredProfile(devicePrintProfile) {",
        "                    var expirationDate = new Date(),",
        "                        lastSelectedDate;",
        "                    expirationDate.setDate(expirationDate.getDate() - config.profileExpiration);",
        "",
        "                    lastSelectedDate = new Date(devicePrintProfile.lastSelectedDate);",
        "",
        "                    return lastSelectedDate < expirationDate;",
        "                }",
        "",
        "                function getNotExpiredProfiles() {",
        "                    var profile,",
        "                        dao = sharedState.get('_DeviceIdDao'),",
        "                        results = [],",
        "                        profiles,",
        "                        iter;",
        "",
        "                    profiles = dao.getDeviceProfiles(username, realm);",
        "",
        "                    if (profiles) {",
        "                        iter = profiles.iterator();",
        "",
        "                        while (iter.hasNext()) {",
        "                            profile = iter.next().getObject();",
        "                            if (!isExpiredProfile(profile)) {",
        "                                results.push(profile);",
        "                            }",
        "                        }",
        "                    }",
        "                    if (logger.messageEnabled()) {",
        "                        logger.message("stored non-expired profiles: " + results);",
        "                    }",
        "                    return results;",
        "                }",
        "",
        "                return getNotExpiredProfiles();",
        "            },",
        "            devicePrint = JSON.parse(clientScriptOutputData),",
        "            devicePrintProfiles = getProfiles();",
        "",
        "        if (!hasRequiredAttributes(devicePrint, config.attributes)) {",
        "            logger.message("devicePrint.hasRequiredAttributes: false");",
        "            // Will fail this module but fall-through to next module. Which should be OTP.",
        "            authState = FAILED;",
        "        } else if (compareDevicePrintProfiles(config.attributes, devicePrint, devicePrintProfiles, config.maxPenaltyPoints)) {",
        "            logger.message("devicePrint.hasValidProfile: true");",
        "            authState = SUCCESS;",
        "        } else {",
        "            logger.message("devicePrint.hasValidProfile: false");",
        "            sharedState.put('devicePrintProfile', JSON.stringify(devicePrint));",
        "            // Will fail this module but fall-through to next module. Which should be OTP.",
        "            authState = FAILED;",
        "        }",
        "    }",
        "}",
        "",
        "matchDevicePrint();",
      ],
    },
    "71545db5-ce01-46b1-b79f-d41af36bd548": {
      "_id": "71545db5-ce01-46b1-b79f-d41af36bd548",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Capture Evidence",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Onfido-CaptureEvidence",
      "script": [
        "logger.error("Onfido-CaptureEvidence: Start");",
        "/*",
        " * !!! Extend your authentication session time so your identity proofing flows don't time out !!!",
        " *",
        " * Authentication > Settings > Trees > Max Duration (Minutes)",
        " *",
        " * Set to 15 minutes.",
        " *",
        " */",
        "",
        "/*",
        " * BEGIN SCRIPT CONFIGURATION",
        " */",
        "var onfido_auth_token = String(sharedState.get("onfidoAuthToken"));",
        "var onfido_dialog_title = "Join the Expanse family!";",
        "var onfido_dialog_msg1 = "To open an Expanse account, we will need to verify your identity.";",
        "var onfido_dialog_msg2 = "It will only take a couple of minutes.";",
        "var onfido_country_code = "US";",
        "/*",
        " * END SCRIPT CONFIGURATION",
        " */",
        "",
        "var mobile = idRepository.getAttribute(sharedState.get("_id"), "telephoneNumber");",
        "var smsNumber = "";",
        "if (mobile && mobile.iterator().hasNext()) {",
        "    smsNumber = String(mobile.iterator().next().toString());",
        "}",
        "",
        "// Inject Onfido SDK into login page",
        "onfidoScript = String("var body=document.body;\\n" +",
        "    "var script = document.createElement('script');\\n" +",
        "    "document.getElementById('callbacksPanel').style.display = 'none';\\n" +",
        "    "var onfido_div = document.createElement(\\"div\\");\\n" +",
        "    "onfido_div.id=\\"onfido-mount\\";\\n" +",
        "    "script.src = 'https://assets.onfido.com/web-sdk-releases/5.2.1/onfido.min.js';\\n" +",
        "    "var head = document.head; \\n " +",
        "    "var link = document.createElement(\\"link\\");  \\n" +",
        "    "     link.type = \\"text/css\\"; \\n " +",
        "    "     link.rel = \\"stylesheet\\"; \\n " +",
        "    "     link.href = 'https://assets.onfido.com/web-sdk-releases/5.2.1/style.css'; \\n " +",
        "    "    head.appendChild(link); \\n " +",
        "    ";\\n" +",
        "    "var onfido = {};\\n" +",
        "    "script.onload=function() {\\n" +",
        "    "    onfido=Onfido.init({\\n" +",
        "    "       token: '" + onfido_auth_token + "', \\n" +",
        "    "       useModal: true, \\n" +",
        "    "       isModalOpen: true, \\n" +",
        "    "       smsNumberCountryCode: '" + onfido_country_code + "', \\n" +",
        "    "       userDetails: { \\n" +",
        "    "           smsNumber: '" + smsNumber + "' \\n" +",
        "    "       }, \\n" +",
        "    "       steps: [\\n" +",
        "    "           {\\n" +",
        "    "               type:'welcome',\\n" +",
        "    "               options:{\\n" +",
        "    "                   title:'" + onfido_dialog_title + "',\\n" +",
        "    "                   descriptions:[\\n" +",
        "    "                       '" + onfido_dialog_msg1 + "',\\n" +",
        "    "                       '" + onfido_dialog_msg2 + "',\\n" +",
        "    "                   ]\\n" +",
        "    "               }\\n" +",
        "    "          },\\n" +",
        "    "          'document',\\n" +",
        "    "          'face',\\n" +",
        "    "          'complete',\\n" +",
        "    "       ],\\n" +",
        "    "       onComplete: function(data){ console.log('DONE'); onfido.setOptions({ isModalOpen:false }); document.getElementById('loginButton_0').click(); } \\n" +",
        "    "    })\\n" +",
        "    "};\\n" +",
        "    "document.body.appendChild(script);\\n");",
        "",
        "var fr = JavaImporter(",
        "    org.forgerock.openam.auth.node.api,",
        "    javax.security.auth.callback.NameCallback,",
        "    com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        ");",
        "",
        "with (fr) {",
        "    if (callbacks.isEmpty()) {",
        "        logger.error("Onfido-CaptureEvidence: Sending callbacks");",
        "        action = Action.send(new ScriptTextOutputCallback(onfidoScript)).build();",
        "    } else {",
        "        logger.error("Onfido-CaptureEvidence: End (outcome=true)");",
        "        action = Action.goTo("true").build();",
        "    }",
        "}",
      ],
    },
    "71b3c70b-920c-464b-a918-4c86eaaddccd": {
      "_id": "71b3c70b-920c-464b-a918-4c86eaaddccd",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Render a dropdown",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Dropdown",
      "script": [
        "/* Dropdown",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Render a dropdown selector",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "(function () {",
        "  outcome = "true";",
        "  var choices = [" ", "Red pill", "Blue pill", "Steak", "Rabbit hole"];",
        "  ",
        "  var fr = JavaImporter(",
        "    org.forgerock.openam.auth.node.api.Action,",
        "    javax.security.auth.callback.ChoiceCallback",
        "  )",
        "",
        "  if (callbacks.isEmpty()) {",
        "    action = fr.Action.send([",
        "      new fr.ChoiceCallback("Make your choice", choices, 0, false)",
        "    ]).build();",
        "  } else {",
        "    var choice = parseInt(callbacks.get(0).getSelectedIndexes()[0]);",
        "    nodeState.putShared("choice", choices[choice]);",
        "    action = fr.Action.goTo(outcome).build();",
        "  }",
        "}());",
      ],
    },
    "71e3b4ae-52c1-49d6-98fd-c279f43ea3ce": {
      "_id": "71e3b4ae-52c1-49d6-98fd-c279f43ea3ce",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "AAcustomLogic",
      "script": [
        "/*",
        "  - Data made available by nodes that have already executed are available in the sharedState variable.",
        "  - The script should set outcome to either "true" or "false".",
        " */",
        "outcome = "false";",
        "var predictionResult = sharedState.get("predictionResult");",
        "var predictionResultString = predictionResult.toString();",
        "",
        "var is_impossible_travel = 0;",
        "var is_credential_stuffing = 0;",
        "var is_automated_user_agent = 0;",
        "var is_brute_force = 0;",
        "var is_suspicious_ip = 0;",
        "",
        "var signal_count = 0;",
        "var position = 0;",
        "",
        "position = predictionResultString.search("is_impossible_travel=false");",
        "if(position<0)",
        "{",
        "  signal_count++;",
        "  is_impossible_travel=1;",
        "}",
        "position = predictionResultString.search("is_credential_stuffing=false");",
        "if(position<0)",
        "{",
        "  signal_count++;",
        "  is_credential_stuffing=1;",
        "}",
        "position = predictionResultString.search("is_automated_user_agent=false");",
        "if(position<0)",
        "{",
        "  signal_count++;",
        "  is_automated_user_agent=1;",
        "}",
        "position = predictionResultString.search("is_brute_force=false");",
        "if(position<0)",
        "{",
        "  signal_count++;",
        "  is_brute_force=1;",
        "}",
        "position = predictionResultString.search("is_suspicious_ip=false");",
        "if(position<0)",
        "{",
        "  signal_count++;",
        "  is_suspicious_ip=1;",
        "}",
        "",
        "sharedState.put("debug-signal-count",signal_count);",
        "if(signal_count>1)",
        "{",
        "     outcome="true"; ",
        "}",
        "",
        "",
        "",
      ],
    },
    "739bdc48-fd24-4c52-b353-88706d75558a": {
      "_id": "739bdc48-fd24-4c52-b353-88706d75558a",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Check if username has already been collected.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Check Username",
      "script": [
        "/* Check Username",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Check if username has already been collected.",
        " * Return "known" if yes, "unknown" otherwise.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - known",
        " * - unknown",
        " */",
        "(function () {",
        "    if (null != sharedState.get("username")) {",
        "        outcome = "known";",
        "    }",
        "    else {",
        "        outcome = "unknown";",
        "    }",
        "}());",
      ],
    },
    "73cecbfc-dad0-4395-be6a-6858ee3a80e5": {
      "_id": "73cecbfc-dad0-4395-be6a-6858ee3a80e5",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from Microsoft",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Microsoft Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        "{",
        "    "@odata.context": "https://graph.microsoft.com/v1.0/$metadata#users/$entity",",
        "    "@odata.id": "https://graph.microsoft.com/v2/711ffa9c-5972-4713-ace3-688c9732614a/directoryObjects/7d7759e2-36d8-4e64-b173-3f890d7d46d6/Microsoft.DirectoryServices.User",",
        "    "businessPhones": [",
        "        "18014735451"",
        "    ],",
        "    "displayName": "Volker Scheuber",",
        "    "givenName": "Volker",",
        "    "jobTitle": null,",
        "    "mail": "vscheuber@vscheuber.onmicrosoft.com",",
        "    "mobilePhone": null,",
        "    "officeLocation": null,",
        "    "preferredLanguage": null,",
        "    "surname": "Scheuber",",
        "    "userPrincipalName": "vscheuber@vscheuber.onmicrosoft.com",",
        "    "id": "7d7759e2-36d8-4e64-b173-3f890d7d46d6"",
        "}",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "logger.message("Kauai Microsoft Profile Normalization: rawProfile={}", rawProfile)",
        "",
        "return json(object(",
        "        field("id", rawProfile.id),",
        "        field("displayName", rawProfile.displayName),",
        "        field("givenName", rawProfile.givenName),",
        "        field("familyName", rawProfile.surname),",
        "        field("email", rawProfile.userPrincipalName),",
        "        field("username", rawProfile.userPrincipalName),",
        "        field("groups", rawProfile.groups)))",
      ],
    },
    "740cf6fa-a173-4e9d-b17c-44758e9b19ec": {
      "_id": "740cf6fa-a173-4e9d-b17c-44758e9b19ec",
      "context": "CONFIG_PROVIDER_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "CP-InnerTreeEvaluator-static-inner2",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "CP-ITE-static-inner2",
      "script": [
        "/*",
        " * Copyright 2021 ForgeRock AS. All Rights Reserved",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/**",
        " * The following script is a simplified template for understanding how to build",
        " * up a config Map object with custom values. The Config Provider Node will then",
        " * provide this config Map to the desired node type. It is important that the Map",
        " * you build here is named 'config'.",
        " *",
        " * Defined variables:",
        " *",
        " * nodeState - Node State (1)",
        " *           Always present, this represents the current values stored in the node state.",
        " *",
        " * idRepository - Profile Data (2)",
        " *           Always present, a repository to retrieve user information.",
        " *",
        " * secrets - Credentials and Secrets (3)",
        " *           Always present, an interface to access the Secrets API from a scripting context.",
        " *",
        " * requestHeaders (4) - Map (5)",
        " *           Always present, an object that provides methods for accessing headers in the login request.",
        " *",
        " * logger - Debug Logging (6)",
        " *          Always present, the debug logger instance.",
        " *",
        " * httpClient - HTTP Client (7)",
        " *          Always present, the HTTP client that can be used to make external HTTP requests.",
        " *",
        " * realm - String (primitive).",
        " *          Always present, the name of the realm the user is authenticating to.",
        " *",
        " * existingSession - Map<String, String> (5)",
        " *          Present if the request contains the session cookie, the user's session object. The returned map from",
        " *          SSOToken.getProperties() (8)",
        " *",
        " * requestParameters - Map (5)",
        " *          Always present, the object that contains the authentication request parameters.",
        " *",
        " *",
        " * Outputs:",
        " *",
        " * config - Map (5)",
        " *           Define and fill a Map object named 'config' with custom values, this will define the configuration for the",
        " *           associated node selected in the ConfigProviderNode.",
        " *",
        " * Reference:",
        " * (1) Node State - https://backstage.forgerock.com/docs/idcloud-am/latest/authentication-guide/scripting-api-node.html#scripting-api-node-nodeState",
        " * (2) Profile Data - https://backstage.forgerock.com/docs/am/7.1/authentication-guide/scripting-api-node.html#scripting-api-node-id-repo",
        " * (3) Credentials and Secrets - https://backstage.forgerock.com/docs/am/7.1/authentication-guide/scripting-api-node.html#scripting-api-authn-secrets",
        " * (4) Request Headers - https://backstage.forgerock.com/docs/am/7/authentication-guide/scripting-api-node.html#scripting-api-node-requestHeaders.",
        " * (5) Map - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/Map.html",
        " * (6) Debug Logging - https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.",
        " * (7) HTTP Client - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/http/Client.html.",
        " * (8) SSOToken - https://backstage.forgerock.com/docs/am/7/apidocs/com/iplanet/sso/SSOToken.html.",
        " */",
        "",
        "config = {",
        "  tree: 'inner2'",
        "};",
      ],
    },
    "743351b3-001a-4ec8-b3ac-a674ddb8de22": {
      "_id": "743351b3-001a-4ec8-b3ac-a674ddb8de22",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Enrich user session with UOP class ID.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "UOP Enrich Session",
      "script": [
        "/* UOP Enrich Session",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Add current class ID to user session.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is. ",
        " * It requires the Identify Existing User node before it is being called.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * - false",
        " */",
        "logger.warning("UOP Enrich Session: start");",
        "outcome = "false";",
        "",
        "if (sharedState.get("uopCurrentClassID")) {",
        "    outcome = "true";",
        "    logger.warning("UOP Enrich Session: going to enrich session with class id: ".concat(sharedState.get("uopCurrentClassID")));",
        "  ",
        "    var fr = JavaImporter(",
        "      org.forgerock.openam.auth.node.api",
        "    );",
        "",
        "    with (fr) {",
        "        logger.warning("UOP Enrich Session: End (outcome=".concat(outcome).concat(")"));",
        "        action = Action.goTo(outcome).putSessionProperty("UOPClassID", sharedState.get("uopCurrentClassID")).build();",
        "    }",
        "  ",
        "} else {",
        "    logger.error("UOP Enrich Session: no classes!");",
        "    logger.warning("UOP Enrich Session: End (outcome=".concat(outcome).concat(")"));",
        "}",
      ],
    },
    "76421cb0-0550-43e7-89f8-51ad1d95d306": {
      "_id": "76421cb0-0550-43e7-89f8-51ad1d95d306",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Detect and preserve currently active theme before setting the new theme.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Set Theme",
      "script": [
        "/* Set Theme",
        " * ",
        " * Detect and preserve currently active theme before setting the new theme.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "      outcome = "true";",
        "      ",
        "      var theme = "Expanse_MFA";",
        "",
        "    // do not change, must be a random identifier",
        "    var anchor = generateNumericToken('xxx');",
        "  ",
        "      var script = "";",
        "    script += "document.getElementById(\\"theme-id-"+anchor+"\\").value = localStorage.getItem('theme-id');";",
        "    script += "console.log('theme-id='+document.getElementById(\\"theme-id-"+anchor+"\\").value);";",
        "      script += "document.getElementById(\\"loginButton_0\\").click();";",
        "",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "          org.forgerock.openam.authentication.callbacks.PollingWaitCallback,",
        "        com.sun.identity.authentication.callbacks.HiddenValueCallback,",
        "        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        "    )",
        "    // discover active theme from UI",
        "    if (callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "            new fr.HiddenValueCallback("theme-id-"+anchor, "false"),",
        "            new fr.ScriptTextOutputCallback(script)",
        "        ).build();",
        "    }",
        "      // get active theme from callback and set new theme",
        "      else if (callbacks.size() === 2) {",
        "        // did we get the id of the currently active theme?",
        "        if (callbacks.get(0).getValue() !== "theme-id-"+anchor) {",
        "              sharedState.put("themeId", callbacks.get(0).getValue());",
        "        }",
        "        // set new theme",
        "        var stage = "themeId="+theme;",
        "        action = fr.Action.send(",
        "              new fr.PollingWaitCallback("100", "Please wait ...")",
        "        ).withStage(stage).build();",
        "    }",
        "      else {",
        "        // continue",
        "        action = fr.Action.goTo(outcome).build();",
        "    }",
        "",
        "     /*",
        "      * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "      * ",
        "      * Example:",
        "      * 'xxxxx' produces '28535'",
        "      * 'xxx-xxx' produces '432-521'",
        "      */",
        "    function generateNumericToken(format) {",
        "        return format.replace(/[x]/g, function(c) {",
        "            var r = Math.random()*10|0;",
        "            var v = r;",
        "            return v.toString(10);",
        "        });",
        "    }",
        "}());",
      ],
    },
    "766ed2a6-29dd-4bd7-a60d-9eabbd63545c": {
      "_id": "766ed2a6-29dd-4bd7-a60d-9eabbd63545c",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Service Account - Verify JWT",
      "script": [
        "var fr = JavaImporter(",
        "  org.forgerock.util.Options,",
        "  org.forgerock.json.jose.jwk.JWKSet,",
        "  org.forgerock.json.jose.jws.SigningManager,",
        "  org.forgerock.json.jose.builders.JwtBuilderFactory,",
        "  org.forgerock.json.jose.jws.SignedJwt",
        ");",
        "",
        "var sm = new fr.SigningManager();",
        "",
        "function getJWKs(svcAcctId) {",
        "  var svcAcct = idRepository.getIdentity(svcAcctId);",
        "  if (svcAcct == null) {",
        "    logger.message('No service account found for {}', svcAcctId);",
        "    return null;",
        "  }",
        "  var jwksAttrs = svcAcct.getAttributeValues('fr-attr-jwks');",
        "  if (!jwksAttrs || jwksAttrs.length === 0) {",
        "    logger.message('No jwks attributes in issuer');",
        "    return null;",
        "  }",
        "  var jwkSet = jwksAttrs[0];",
        "  if (!jwkSet) {",
        "    logger.message('No jwk set in jwks attribute in issuer');",
        "    return null;",
        "  }",
        "  return fr.JWKSet.parse(jwkSet).getJWKsAsList();",
        "}",
        "",
        "outcome = (function () {",
        "  var authz = requestHeaders.get('authorization');",
        "  if (authz === null || authz.length === 0 || authz[0].indexOf('svcacct') !== 0) {",
        "    logger.message('No authorization header');",
        "    return 'False';",
        "  }",
        "",
        "  authz = authz[0].split(' ');",
        "  if (authz.length !== 3) {",
        "    logger.message('Bad authorization header length {}', authz.length);",
        "    return 'False';",
        "  }",
        "  var svcAcctId = authz[1];",
        "  var jwt = authz[2];",
        "  var signedJwt = new fr.JwtBuilderFactory().reconstruct(jwt, fr.SignedJwt);",
        "",
        "  var jwks = getJWKs(svcAcctId);",
        "  for (var i = 0; i < jwks.size(); i++) {",
        "    var verifier = sm.newVerificationHandler(jwks.get(i))",
        "    if (signedJwt.verify(verifier)) {",
        "      nodeState.putShared("username", svcAcctId);",
        "      return 'True';",
        "    }",
        "  }",
        "",
        "  logger.message('Could not verify jwt');",
        "  return 'False';",
        "})();",
      ],
    },
    "779bb956-676d-4e44-b828-b9efa3c866d4": {
      "_id": "779bb956-676d-4e44-b828-b9efa3c866d4",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "ForgeRockVpnOnly",
      "script": [
        "/*",
        "  - Data made available by nodes that have already executed are available in the sharedState variable.",
        "  - The script should set outcome to either "true" or "false".",
        " */",
        "",
        "var validIpAddresses = [",
        "  "37.71.148.92", // FR Grenoble",
        "  "84.214.156.50", // FR Oslo",
        "  "180.255.64.26", // FR Singapore",
        "  "128.106.105.136", // FR Singapore Sales",
        "  "188.39.235.130", // FR Bristol",
        "  "78.33.22.162", // FR Bristol Marsh Street",
        "  "65.113.98.10", // FR San Francisco",
        "  "24.155.146.18" // FR Austin",
        "];",
        "",
        "try {",
        "  outcome = function() {",
        "    logger.message(requestHeaders);",
        "    var vpnBypassSecret = systemEnv.getProperty('esv.amadmin.vpn.bypass.secret', '') + '';",
        "    var bypassHeader = requestHeaders.get(new java.lang.String('x-forgerock-tests-bearer'));",
        "    logger.message("checking for VPN bypass - header {} to match secret {}", bypassHeader, vpnBypassSecret);",
        "    if (vpnBypassSecret && bypassHeader && bypassHeader.size() === 1) {",
        "      logger.message("bypass header is present");",
        "      if (bypassHeader.get(0) + '' === vpnBypassSecret + '') {",
        "        logger.warning("bypassing VPN check - request from tests authorized");",
        "        return 'True';",
        "      }",
        "    }",
        "    var clientIpAddresses = requestHeaders.get(new java.lang.String('x-forwarded-for'));",
        "    logger.message(clientIpAddresses);",
        "    if (!clientIpAddresses) {",
        "      logger.message("No forwarded header - internal cluster request");",
        "      return 'True';",
        "    }",
        "    for (var i = 0; i < clientIpAddresses.size(); i++) {",
        "      var clientIpHeader = clientIpAddresses.get(i);",
        "      var ipAddresses = clientIpHeader.split(',');",
        "      for (var j = 0; j < ipAddresses.length; j++) {",
        "        var clientIp = ipAddresses[j].trim();",
        "        logger.message('Checking client IP ' + clientIp);",
        "        for (var k = 0; k < validIpAddresses.length; k++) {",
        "          if (clientIp + '' === validIpAddresses[k]) {",
        "            logger.warning("request from ForgeRock VPN authorized");",
        "            return 'True';",
        "          }",
        "        }",
        "      }",
        "    }",
        "    logger.warning("request from outside the cluster and not from ForgeRock VPN rejected");",
        "    return 'False';",
        "  }();",
        "",
        "} catch (e) {",
        "",
        "  logger.error('ForgeRockVpnOnly failed to check IP');",
        "  logger.error(e);",
        "  outcome = 'Error';",
        "",
        "}",
        "",
      ],
    },
    "790045fa-a325-4e3e-96f8-d4a91b32e9de": {
      "_id": "790045fa-a325-4e3e-96f8-d4a91b32e9de",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Use Have I Been Pwned Password to check if password has been breached.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "HIBP Password Breach Analysis",
      "script": [
        "/* HIBP Password Breach Analysis",
        " *",
        " * Authors: jon.knight@forgerock.com, volker.scheuber@forgerock.com",
        " * ",
        " * Use Have I Been Pwned Password to check if password has been breached.",
        " * Calls HIBP API to retrieve the count of matching passwords in breached ",
        " * password database",
        " * ",
        " * This script needs to be parametrized. It will not work properly as is. ",
        " * It requires the Password or Platform Password collector nodes before",
        " * it can operate.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - clear",
        " *   The number of breaches for password was either zero or less than the ",
        " *   value of THRESHOLD",
        " * - breached ",
        " *   The number of incidents of the password in the breached password ",
        " *   database exceeds THRESHOLD",
        " * - failed",
        " *   The API call was rejected.",
        " */",
        "(function () {",
        "    var USER_AGENT="ForgeRock";",
        "    var HIBP_API_KEY=systemEnv.getProperty("esv.hibp.api.key");",
        "    var THRESHOLD=0;",
        "",
        "    function toHexString(byteArray) {",
        "        var s = '';",
        "        byteArray.forEach(function(byte) {",
        "            s += ('0' + (byte & 0xFF).toString(16)).slice(-2);",
        "        });",
        "        return s;",
        "    }",
        "",
        "    outcome = "failed";",
        "",
        "    var md = java.security.MessageDigest.getInstance('SHA-1');",
        "      var password = nodeState.get("password").asString();",
        "//      var password = new java.lang.String("");",
        "//      if (nodeState.get("password")) {",
        "//      password = nodeState.get("password").asString();",
        "//    }",
        "    var byteArray = password.getBytes("UTF-8");",
        "    md.update(byteArray);",
        "    var digest = md.digest();",
        "    var hex = String(toHexString(digest)).toUpperCase();",
        "",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setMethod('GET');",
        "    request.setUri('https://api.pwnedpasswords.com/range/' + hex.substring(0,5));",
        "    request.getHeaders().add("Accept","*/*");",
        "    request.getHeaders().add("Content-Type","application/json");",
        "    request.getHeaders().add("User-Agent", USER_AGENT);",
        "    request.getHeaders().add("hibp-api-key", HIBP_API_KEY);",
        "",
        "    var response = httpClient.send(request).get();",
        "",
        "    if (response.getStatus().getCode() === 200) {",
        "        var max = 0;",
        "        outcome = "clear";",
        "        var result = response.getEntity().getString();",
        "        var lines = result.split('\\n');",
        "        for (i=0; i<lines.length; i++) {",
        "            var prefix = lines[i].split(':')[0];",
        "            if (String(hex.substring(0,5) + prefix) == hex) {",
        "                var count = lines[i].split(':')[1];",
        "                if (count > max) max = count;",
        "            }",
        "        }",
        "        if (max > THRESHOLD) outcome = "breached";",
        "        sharedState.put("hibp_password_count", max);",
        "    }",
        "}());",
      ],
    },
    "7dce8f07-d9fe-4752-94b9-ff99dfd0433b": {
      "_id": "7dce8f07-d9fe-4752-94b9-ff99dfd0433b",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Parse parameters of the incoming call.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Twilio IVR: Parse Call Parameters",
      "script": [
        "/* Twilio IVR Integration",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * - false",
        " * ",
        " * Depending on the amount of data collected through callbacks and how many of the callParams",
        " * you activate below, you will need to change your authentication session from JWT to CTS or",
        " * Memory.",
        " */",
        "",
        "logger.warning("Twilio IVR: Parse Call Parameters: start");",
        "outcome = "false";",
        "",
        "/* Begin Twilio IVR Configuration Parameters",
        " *",
        " * These are used to protect this journey so it is only being executed by your Twilio account.",
        " */",
        "var TWILIO_ACCOUNT_SID = "AC750415e3163a2e57b7aeea7eed82d944";",
        "var TWILIO_PHONE_NUMBER = "+13176443107";",
        "",
        "// keep the params to a minimum to minimize authentication session size",
        "var callParams = {",
        "  //"CallSid" : decodeURIComponent(requestParameters.get("CallSid").get(0)),",
        "  "AccountSid" : decodeURIComponent(requestParameters.get("AccountSid").get(0)),",
        "  "From" : decodeURIComponent(requestParameters.get("From").get(0)),",
        "  "To" : decodeURIComponent(requestParameters.get("To").get(0)),",
        "  //"CallStatus" : decodeURIComponent(requestParameters.get("CallStatus").get(0)),",
        "  //"ApiVersion" : decodeURIComponent(requestParameters.get("ApiVersion").get(0)),",
        "  //"Direction" : decodeURIComponent(requestParameters.get("Direction").get(0)),",
        "  //"ForwardedFrom" : decodeURIComponent(requestParameters.get("ForwardedFrom").get(0)),",
        "  //"CallerName" : decodeURIComponent(requestParameters.get("CallerNameCallerName").get(0)),",
        "  //"ParentCallSid" : decodeURIComponent(requestParameters.get("ParentCallSid").get(0)),",
        "  //"FromCity" : decodeURIComponent(requestParameters.get("FromCity").get(0)),",
        "  //"FromState" : decodeURIComponent(requestParameters.get("FromState").get(0)),",
        "  //"FromZip" : decodeURIComponent(requestParameters.get("FromZip").get(0)),",
        "  //"FromCountry" : decodeURIComponent(requestParameters.get("FromCountry").get(0)),",
        "  //"ToCity" : decodeURIComponent(requestParameters.get("ToCity").get(0)),",
        "  //"ToState" : decodeURIComponent(requestParameters.get("ToState").get(0)),",
        "  //"ToZip" : decodeURIComponent(requestParameters.get("ToZip").get(0)),",
        "  //"ToCountry" : decodeURIComponent(requestParameters.get("ToCountry").get(0)),",
        "};",
        "",
        "/* End Twilio IVR Configuration Parameters ",
        " */",
        "",
        "if (callParams.AccountSid == TWILIO_ACCOUNT_SID &&",
        "    callParams.To == TWILIO_PHONE_NUMBER) ",
        "{",
        "      outcome = "true";",
        "    sharedState.put("TwilioIVRCallParams", callParams);",
        "    setSharedObjectAttribute("telephoneNumber", callParams.From);",
        "}",
        "",
        "logger.warning("Twilio IVR: Parse Call Parameters: finish [outcome=".concat(outcome).concat("]"));",
        "",
        "/*",
        " * Store attributes in shared state for use with the Create/Patch Object nodes.",
        " */",
        "function setSharedObjectAttribute(name, value) {",
        "       var storage = sharedState.get("objectAttributes");",
        "    if (storage && value) {",
        "          if (storage.put) {",
        "              storage.put(name, value);",
        "        }",
        "          else {",
        "              storage[name] = value;",
        "        }",
        "    }",
        "    else if (value) {",
        "        sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "    }",
        "}",
      ],
    },
    "7dd80834-e7b2-4737-85a7-40434bb19dde": {
      "_id": "7dd80834-e7b2-4737-85a7-40434bb19dde",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Store the impersontor and impersonatee profile information in session properties.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Impersonate: Update Session Properties",
      "script": [
        "/* Impersonate: Update Session Properties",
        " * ",
        " * Store the impersontor and impersonatee profile information in session properties.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: jake.feasel@forgerock.com, volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "      logger.message("Impersonate: Update Session Properties: start");",
        "      outcome = "true";",
        "  ",
        "    var goTo = org.forgerock.openam.auth.node.api.Action.goTo;",
        "    myGoto = goTo(outcome);",
        "    myGoto.putSessionProperty("userName", sharedState.get("username"));",
        "    myGoto.putSessionProperty("impersonator", sharedState.get("impersonator"));",
        "",
        "      logger.message("Impersonate: Update Session Properties: done [outcome={}]", outcome);",
        "    action = myGoto.build();",
        "}());",
      ],
    },
    "7e3d7067-d50f-4674-8c76-a3e13a810c33": {
      "_id": "7e3d7067-d50f-4674-8c76-a3e13a810c33",
      "context": "AUTHENTICATION_SERVER_SIDE",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Default global script for server side Scripted Authentication Module",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Scripted Module - Server Side",
      "script": [
        "/*",
        " * Copyright 2015-2017 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "var START_TIME = 9;  // 9am",
        "var END_TIME   = 17; // 5pm",
        "var longitude, latitude;",
        "var localTime;",
        "",
        "logger.message("Starting scripted authentication");",
        "logger.message("User: " + username);",
        "",
        "var userPostalAddress = getUserPostalAddress();",
        "logger.message("User address: " + userPostalAddress);",
        "",
        "getLongitudeLatitudeFromUserPostalAddress();",
        "getLocalTime();",
        "",
        "logger.message("Current time at the users location: " + localTime.getHours());",
        "if (localTime.getHours() < START_TIME || localTime.getHours() > END_TIME) {",
        "    logger.error("Login forbidden outside work hours!");",
        "    authState = FAILED;",
        "} else {",
        "    logger.message("Authentication allowed!");",
        "    authState = SUCCESS;",
        "}",
        "",
        "function getLongitudeLatitudeFromUserPostalAddress() {",
        "",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setUri("http://maps.googleapis.com/maps/api/geocode/json?address=" + encodeURIComponent(userPostalAddress));",
        "      request.setMethod("GET");",
        "      //the above URI has to be extended with an API_KEY if used in a frequent manner",
        "      //see documentation: https://developers.google.com/maps/documentation/geocoding/intro",
        "",
        "    var response = httpClient.send(request).get();",
        "    logResponse(response);",
        "",
        "    var geocode = JSON.parse(response.getEntity().getString());",
        "    var i;",
        "    for (i = 0; i < geocode.results.length; i++) {",
        "        var result = geocode.results[i];",
        "        latitude = result.geometry.location.lat;",
        "        longitude = result.geometry.location.lng;",
        "      ",
        "           logger.message("latitude:" + latitude + " longitude:" + longitude);",
        "    }",
        "}",
        "",
        "function getLocalTime() {",
        "",
        "    var now = new Date().getTime() / 1000;",
        "    var location = "location=" + latitude + "," + longitude;",
        "    var timestamp = "timestamp=" + now;",
        "        ",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setUri("https://maps.googleapis.com/maps/api/timezone/json?" + location + "&" + timestamp);",
        "      request.setMethod("GET");",
        "      //the above URI has to be extended with an API_KEY if used in a frequent manner",
        "      //see documentation: https://developers.google.com/maps/documentation/timezone/intro",
        "",
        "    var response = httpClient.send(request).get();",
        "    logResponse(response);",
        "",
        "    var timezone = JSON.parse(response.getEntity().getString());",
        "    var localTimestamp = parseInt(now) + parseInt(timezone.dstOffset) + parseInt(timezone.rawOffset);",
        "    localTime = new Date(localTimestamp*1000);",
        "}",
        "",
        "function getUserPostalAddress() {",
        "    var userAddressSet = idRepository.getAttribute(username, "postalAddress");",
        "    if (userAddressSet == null || userAddressSet.isEmpty()) {",
        "        logger.warning("No address specified for user: " + username);",
        "        return false;",
        "    }",
        "    return userAddressSet.iterator().next()",
        "}",
        "",
        "function logResponse(response) {",
        "    logger.message("User REST Call. Status: " + response.getStatus() + ", Body: " + response.getEntity().getString());",
        "}",
      ],
    },
    "7fb962a5-9f20-41d3-a077-b424a29c1198": {
      "_id": "7fb962a5-9f20-41d3-a077-b424a29c1198",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Evaluate IPv4 CIDR access rules from "esv-ipv4-cidr-access-rules".",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "IPv4 CIDR Rules Engine",
      "script": [
        "/* IPv4 CIDR Rules Engine",
        " *",
        " * Author: volker.scheuber@forgerock.com, justin.chin@forgerock.com",
        " * ",
        " * Evaluate IPv4 CIDR access rules from "esv-ipv4-cidr-access-rules". ",
        " * Access rules must have the following format:",
        " * {",
        " *   "allow": [",
        " *     "140.118.0.0/16",",
        " *     "110.35.0.0/16",",
        " *     "131.26.0.0/16",",
        " *     "92.61.21.153/32"",
        " *   ]",
        " * }",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - allow",
        " * - deny",
        " */",
        "(function () {",
        "  outcome = "deny";",
        "  ",
        "  var rules = JSON.parse(systemEnv.getProperty("esv.ipv4.cidr.access.rules"));",
        "  var allow = rules['allow'];",
        "",
        "  /*",
        "   * Returns the value of the requested header",
        "   */",
        "  function getHeader(headerName) {",
        "    return requestHeaders.get(headerName).get(0);",
        "  }",
        "",
        "  /*",
        "   * Returns the client's IP address",
        "   */",
        "  function getClientIPAddress() {",
        "    return getHeader("x-forwarded-for").split(',')[0];",
        "  }",
        "",
        "  function IPnumber(IPaddress) {",
        "    var ip = IPaddress.match(/^(\\d+)\\.(\\d+)\\.(\\d+)\\.(\\d+)$/);",
        "    if (ip) {",
        "      return (+ip[1] << 24) + (+ip[2] << 16) + (+ip[3] << 8) + +ip[4];",
        "    }",
        "    // else ... ?",
        "    return null;",
        "  }",
        "",
        "  function IPmask(maskSize) {",
        "    return -1 << (32 - maskSize);",
        "  }",
        "",
        "  function isAllowed(ip) {",
        "    var allowed = false;",
        "    allow.forEach((cidr) => {",
        "      if (",
        "        (IPnumber(ip) & IPmask(cidr.split('/')[1])) ==",
        "        IPnumber(cidr.split('/')[0])",
        "      ) {",
        "        allowed = true;",
        "      }",
        "    });",
        "    return allowed;",
        "  }",
        "  ",
        "  if (isAllowed(getClientIPAddress())) {",
        "    outcome = "allow";",
        "  }",
        "}());",
      ],
    },
    "809330cf-874c-4d57-a8f1-5882c6dd855b": {
      "_id": "809330cf-874c-4d57-a8f1-5882c6dd855b",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Converts a normalized social profile for iddataweb into a Managed user",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Normalized idddataweb Profile to Managed User",
      "script": [
        "/* Normalized idddataweb Profile to Managed User",
        " * Copyright 2022 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS. Not for production use.",
        " * Modified by Stephen Payne, 2021-Mar-30",
        " */",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "import org.forgerock.json.JsonValue",
        "logger.error("Normalized_Profile_IDDataWeb: Start " + normalizedProfile);",
        "",
        "JsonValue managedUser = json(object(",
        "        field("givenName", normalizedProfile.givenName),",
        "        field("sn", normalizedProfile.familyName),",
        "        field("userName", normalizedProfile.username)))",
        "if (normalizedProfile.postalAddress.isNotNull()) managedUser.put("postalAddress", normalizedProfile.postalAddress)",
        "if (normalizedProfile.addressLocality.isNotNull()) managedUser.put("city", normalizedProfile.addressLocality)",
        "if (normalizedProfile.addressRegion.isNotNull()) managedUser.put("stateProvince", normalizedProfile.addressRegion)",
        "if (normalizedProfile.postalCode.isNotNull()) managedUser.put("postalCode", normalizedProfile.postalCode)",
        "if (normalizedProfile.country.isNotNull()) managedUser.put("country", normalizedProfile.country)",
        "if (normalizedProfile.phone.isNotNull()) managedUser.put("telephoneNumber", normalizedProfile.phone)",
        "if (normalizedProfile.DOB.isNotNull()) managedUser.put("frIndexedString2", normalizedProfile.DOB)",
        "",
        "return managedUser",
        "",
      ],
    },
    "80c3e733-ae51-4851-a01d-1cbf193c80e9": {
      "_id": "80c3e733-ae51-4851-a01d-1cbf193c80e9",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Activates the admin's account",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_SetOnboardingAttributes",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "function utcNow() {",
        "  return new Date().toISOString();",
        "}",
        "",
        "try {",
        "  ",
        "  var OBJECT_ATTRS = 'objectAttributes';",
        "",
        "  // Start by getting object attributes from shared state",
        "  var sharedObjAttrs = sharedState.get(OBJECT_ATTRS);",
        "  sharedObjAttrs.put('accountStatus', 'Active');",
        "  sharedObjAttrs.put('onboardDate', utcNow());",
        "  ",
        "  // Copy attributes from transient state",
        "  var transientObjAttrs = nodeState.get(OBJECT_ATTRS);",
        "  var attrs = ['aliasList', 'givenName', 'password', 'sn'];",
        "  for (var i = 0; i < attrs.length; i++) {",
        "    var val = transientObjAttrs.get(attrs[i]);",
        "    if (val.isNotNull()) {",
        "      sharedObjAttrs.put(attrs[i], val);",
        "    }",
        "  }",
        "  ",
        "  // Ensure object attributes match in both shared and transient state",
        "  nodeState.putTransient(OBJECT_ATTRS, sharedObjAttrs);",
        "  sharedState.put(OBJECT_ATTRS, sharedObjAttrs);",
        "  outcome = 'Success';",
        "",
        "} catch (e) {",
        "",
        "  logger.error('Failed to set attributes to complete onboarding: {}', e);",
        "  outcome = 'Error';",
        "",
        "}",
        "",
      ],
    },
    "847aab1b-c739-4d64-b26c-180f96cba02b": {
      "_id": "847aab1b-c739-4d64-b26c-180f96cba02b",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Select and apply theme from based on the browser language in the request.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Select Theme by Browser Language",
      "script": [
        "/* Select Theme by Browser Language",
        " * ",
        " * Select and apply theme from based on the browser language in the request.",
        " * ",
        " * This script needs to be parametrized!",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    /******************************/",
        "    /* Begin Script Configuration */",
        "",
        "    // the script expects the themes to be named <baseTheme>_<language>, e.g. "Zardoz_en"",
        "    var baseTheme = "Zardoz";",
        "",
        "    // add all the language codes you want to support",
        "    var supportedLanguages = ["de", "en", "fr"];",
        "",
        "    // specify the default language to fall back on if the browser language is not a supported language",
        "    var defaultLanguage = "en";",
        "",
        "    /* End Script Configuration   */",
        "    /******************************/",
        "",
        "    outcome = "true";",
        "    var theme = getThemeByLanguage(baseTheme);",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "        org.forgerock.openam.authentication.callbacks.PollingWaitCallback",
        "    )",
        "    if (theme && callbacks.isEmpty()) {",
        "        var stage = "themeId=" + theme;",
        "        action = fr.Action.send(",
        "            new fr.PollingWaitCallback("100", "Please wait ...")",
        "        ).withStage(stage).build();",
        "    } else {",
        "        action = fr.Action.goTo(outcome).build();",
        "    }",
        "",
        "    /*",
        "     * Returns the name of the theme to select based on browser language",
        "     */",
        "    function getThemeByLanguage(theme) {",
        "        var languageHeader = getHeader("accept-language");",
        "        var language = languageHeader.split(';')[0].split(',')[0].split('-')[0];",
        "        if (supportedLanguages.indexOf(language) < 0) {",
        "            language = defaultLanguage;",
        "        }",
        "        return theme + "_" + language;",
        "    }",
        "",
        "    /*",
        "     * Returns the value of the requested header",
        "     */",
        "    function getHeader(headerName) {",
        "        return requestHeaders.get(headerName).get(0) + "";",
        "    }",
        "}());",
      ],
    },
    "849ef5f3-7481-4607-a668-f0b5bf47db4c": {
      "_id": "849ef5f3-7481-4607-a668-f0b5bf47db4c",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Goodbye Message",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Twilio IVR: Goodbye Message",
      "script": [
        "/* Twilio IVR: Goodbye Message",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * ",
        " * Depending on the amount of data collected through callbacks and how many of the callParams",
        " * you activate below, you will need to change your authentication session from JWT to CTS or",
        " * Memory.",
        " */",
        "logger.warning("Twilio IVR: Goodbye Message: start");",
        "outcome = "true";",
        "",
        "/* Begin Configuration",
        " */",
        "",
        "// Build out the full message",
        "var message = "Thank you for calling ForgeRock Identity Cloud. Goodbye!";",
        "",
        "/* End Configuration",
        " */",
        "",
        "var fr = JavaImporter(",
        "      org.forgerock.openam.auth.node.api,",
        "      javax.security.auth.callback.TextOutputCallback",
        ");",
        "  ",
        "with (fr) {",
        "      if (callbacks.isEmpty()) {",
        "        var output = new TextOutputCallback(TextOutputCallback.INFORMATION, message);",
        "        action = Action.send(output).build();",
        "      } ",
        "      else {",
        "        logger.warning("Twilio IVR: Goodbye Message: finish [outcome=".concat(outcome).concat("]"));",
        "        action = Action.goTo(outcome).build();",
        "      }",
        "}",
      ],
    },
    "8508a00e-ad45-4310-b3c7-c6871b6a41a9": {
      "_id": "8508a00e-ad45-4310-b3c7-c6871b6a41a9",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Browser Language Decision",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Browser Language Decision",
      "script": [
        "/* Browser Language Decision",
        " * ",
        " * Detect the browser language in the request and branch out to its named exit (e.g.: "de" or "en" or "fr") ",
        " * if it is part of the supportedLanguages array, otherwise take the "other" exit.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - other",
        " * - <all of the items in the supportedLanguages array>",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "      /******************************/",
        "      /* Begin Script Configuration */",
        "      ",
        "      // add all the language codes you want to support",
        "      var supportedLanguages = ["de","en","fr"];",
        "      ",
        "      /* End Script Configuration   */",
        "      /******************************/",
        "  ",
        "      outcome = getBrowserLanguage();",
        "      ",
        "    /*",
        "     * Returns the supported browser language or "other"",
        "     */",
        "    function getBrowserLanguage() {",
        "          var languageHeader = getHeader("accept-language");",
        "          var language = languageHeader.split(';')[0].split(',')[0].split('-')[0];",
        "          if (supportedLanguages.indexOf(language) < 0) {",
        "              return "other";",
        "        }",
        "        return language;",
        "    }",
        "",
        "    /*",
        "     * Returns the value of the requested header",
        "     */",
        "    function getHeader(headerName) {",
        "        return requestHeaders.get(headerName).get(0)+"";",
        "    }",
        "}());",
      ],
    },
    "85523e71-2d77-4577-b078-6f9674cc54e2": {
      "_id": "85523e71-2d77-4577-b078-6f9674cc54e2",
      "context": "SAML2_IDP_ADAPTER",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Always redirect browser pre-auth",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Saml2 IDP Adapter Always Auth",
      "script": [
        "/*",
        " * Copyright 2021-2022 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        " * The script has these top level functions that could be executed during a SAML2 flow.",
        " *      - preSingleSignOn",
        " *      - preAuthentication",
        " *      - preSendResponse",
        " *      - preSignResponse",
        " *      - preSendFailureResponse",
        " *",
        " * Please see the javadoc for the interface definition and more information about these methods.",
        " * https://backstage.forgerock.com/docs/am/7.2/apidocs/com/sun/identity/saml2/plugins/SAML2IdentityProviderAdapter.html",
        " * Note that the initialize method is not supported in the scripts.",
        " *",
        " * Defined variables. Check the documentation on the respective functions for the variables available to it.",
        " *",
        " * hostedEntityId - String",
        " *     Entity ID for the hosted IDP",
        " * realm - String",
        " *     Realm of the hosted IDP",
        " * idpAdapterScriptHelper - IdpAdapterScriptHelper (1)",
        " *     An instance of IdpAdapterScriptHelper containing helper methods. See Javadoc for more details.",
        " * request - HttpServletRequest (2)",
        " *     Servlet request object",
        " * response - HttpServletResponse (3)",
        " *     Servlet response object",
        " * authnRequest - AuthnRequest (4)",
        " *     The original authentication request sent from SP",
        " * reqId - String",
        " *     The id to use for continuation of processing if the adapter redirects",
        " * res - Response (5)",
        " *     The SAML Response",
        " * session - SSOToken (6)",
        " *     The single sign-on session. The reference type of this is Object and would need to be casted to SSOToken.",
        " * relayState - String",
        " *     The relayState that will be used in the redirect",
        " * faultCode - String",
        " *     the fault code that will be returned in the SAML response",
        " * faultDetail - String",
        " *     the fault detail that will be returned in the SAML response",
        " * logger - Logger instance",
        " *     https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.",
        " *     Corresponding log files will be prefixed with: scripts.<script name>",
        " *",
        " * Throws SAML2Exception (7):",
        " *     for any exceptions occurring in the adapter. The federation process will continue",
        " *",
        " * Class reference:",
        " * (1) idpAdapterScriptHelper - https://backstage.forgerock.com/docs/am/7.2/apidocs/com/sun/identity/saml2/plugins/scripted/IdpAdapterScriptHelper.html.",
        " * (2) HttpServletRequest - https://tomcat.apache.org/tomcat-7.0-doc/servletapi/javax/servlet/http/HttpServletRequest.html.",
        " * (3) HttpServletResponse - https://tomcat.apache.org/tomcat-7.0-doc/servletapi/javax/servlet/http/HttpServletResponse.html.",
        " * (4) AuthnRequest - https://backstage.forgerock.com/docs/am/7.2/apidocs/com/sun/identity/saml2/protocol/AuthnRequest.html.",
        " * (5) Response - https://backstage.forgerock.com/docs/am/7.2/apidocs/com/sun/identity/saml2/protocol/Response.html.",
        " * (6) SSOToken - https://backstage.forgerock.com/docs/am/7.2/apidocs/com/iplanet/sso/SSOToken.html.",
        " * (7) SAML2Exception - https://backstage.forgerock.com/docs/am/7.2/apidocs/com/sun/identity/saml2/common/SAML2Exception.html.",
        " */",
        "",
        "/*",
        " * Template/default script for SAML2 IDP Adapter scripted plugin.",
        " */",
        "",
        "/*",
        " * Available variables for preSingleSignOn:",
        " *     hostedEntityId",
        " *     realm",
        " *     idpAdapterScriptHelper",
        " *     request",
        " *     authnRequest",
        " *     response",
        " *     reqId",
        " *     logger",
        " *",
        " * Return - true if browser redirection is happening after processing, false otherwise. Default to false.",
        " */",
        "function preSingleSignOn () {",
        "      logger.error("Chicago: preSingleSignOn");",
        "    return true;",
        "}",
        "",
        "/*",
        " * Available variables for preAuthentication:",
        " *     hostedEntityId",
        " *     realm",
        " *     idpAdapterScriptHelper",
        " *     request",
        " *     authnRequest",
        " *     response",
        " *     reqId",
        " *     session",
        " *     relayState",
        " *     logger",
        " *",
        " * Return - true if browser redirection is happening after processing, false otherwise. Default to false.",
        " */",
        "function preAuthentication () {",
        "      logger.error("Chicago: preAuthentication");",
        "    return true;",
        "}",
        "",
        "/*",
        " * Available variables for preSendResponse:",
        " *     hostedEntityId",
        " *     realm",
        " *     idpAdapterScriptHelper",
        " *     request",
        " *     authnRequest",
        " *     response",
        " *     reqId",
        " *     session",
        " *     relayState",
        " *     logger",
        " *",
        " * Return - true if browser redirection happened after processing, false otherwise. Default to false.",
        " */",
        "function preSendResponse () {",
        "      logger.error("Chicago: preSendResponse");",
        "      logger.error("Chicago: authnRequest: "+authnRequest);",
        "      response.sendRedirect("https://idc.scheuber.io/am/XUI/?realm=alpha&authIndexType=service&authIndexValue=Dispatcher&ForceAuth=true&goto="+relayState);",
        "    return true;",
        "}",
        "",
        "/*",
        " * Available variables for preSignResponse:",
        " *     hostedEntityId",
        " *     realm",
        " *     idpAdapterScriptHelper",
        " *     request",
        " *     authnRequest",
        " *     session",
        " *     relayState",
        " *     res",
        " *     logger",
        " */",
        "function preSignResponse () {",
        "      logger.error("Chicago: preSignResponse");",
        "}",
        "",
        "/*",
        " * Available variables for preSendFailureResponse:",
        " *     hostedEntityId",
        " *     realm",
        " *     idpAdapterScriptHelper",
        " *     request",
        " *     response",
        " *     faultCode",
        " *     faultDetail",
        " *     logger",
        " */",
        "function preSendFailureResponse () {",
        "      logger.error("Chicago: preSendFailureResponse");",
        "}",
      ],
    },
    "87497360-d89c-412a-a99e-c8a9bec465cc": {
      "_id": "87497360-d89c-412a-a99e-c8a9bec465cc",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "ipstack",
      "script": [
        "logger.warning("ipstack: start");",
        "",
        "outcome = "unknown";",
        "",
        "var ip = getClientIPAddress();",
        "logger.warning("ipstack: ip=".concat(ip));",
        "",
        "if (ip) {",
        "",
        "      // ipstack API Configuration",
        "    var IPSTACK_ACCESS_KEY = "efc2f8d9796b9feff5f03359d6fbccc9";",
        "    var IPSTACK_API_URI = "http://api.ipstack.com/".concat(ip).concat("?access_key=").concat(IPSTACK_ACCESS_KEY);    ",
        "",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setMethod('GET');",
        "    request.setUri(IPSTACK_API_URI);",
        "",
        "    var response = httpClient.send(request).get();",
        "    var result = JSON.parse(response.getEntity().getString());",
        "    logger.warning("ipstack: JSON result: " + JSON.stringify(result));",
        "",
        "      /*",
        "    {",
        "        "ip": "99.72.28.182",",
        "        "type": "ipv4",",
        "        "continent_code": "NA",",
        "        "continent_name": "North America",",
        "        "country_code": "US",",
        "        "country_name": "United States",",
        "        "region_code": "TX",",
        "        "region_name": "Texas",",
        "        "city": "Georgetown",",
        "        "zip": "78626",",
        "        "latitude": 30.592500686645508,",
        "        "longitude": -97.66710662841797,",
        "        "location": {",
        "            "geoname_id": 4693342,",
        "            "capital": "Washington D.C.",",
        "            "languages": [",
        "                {",
        "                    "code": "en",",
        "                    "name": "English",",
        "                    "native": "English"",
        "                }",
        "            ],",
        "            "country_flag": "http://assets.ipstack.com/flags/us.svg",",
        "            "country_flag_emoji": "🇺🇸",",
        "            "country_flag_emoji_unicode": "U+1F1FA U+1F1F8",",
        "            "calling_code": "1",",
        "            "is_eu": false",
        "        }",
        "    }",
        "    */",
        "  ",
        "      // preserve result in transient state",
        "      transientState.put("ipstack", JSON.stringify(result));",
        "",
        "    switch(result.country_code) {",
        "      case "CA":",
        "        outcome = result.country_code;",
        "        break;",
        "      case "UK":",
        "        outcome = result.country_code;",
        "        break;",
        "      case "US":",
        "        outcome = result.country_code;",
        "        break;",
        "      default:",
        "        outcome = "other";",
        "    }",
        "",
        "} else {",
        "      logger.error("ipstack: no client ip!");",
        "}",
        "",
        "logger.warning("ipstack: finish");",
        "",
        " /*",
        "  * !!! ASSUMES ID CLOUD !!!",
        "  *",
        "  * Returns the client's IP address",
        "  */",
        " function getClientIPAddress() {",
        "    return requestHeaders.get("x-forwarded-for").get(0).split(',')[0];",
        " }",
      ],
    },
    "878816b3-2bb4-4b43-8001-10f926ddefff": {
      "_id": "878816b3-2bb4-4b43-8001-10f926ddefff",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Switch Actors And Become Impersonatee.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Impersonate: Switch Actors And Become Impersonatee",
      "script": [
        "/* Impersonate: Switch Actors And Become Impersonatee",
        " *",
        " * Switch Actors And Become Impersonatee.",
        " *",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * - false",
        " */",
        "",
        "(function () {",
        "    logger.warning("Impersonate: Switch Actors: start");",
        "    outcome = "false";",
        "",
        "    var impersonatee = sharedState.get("impersonatee");",
        "    var impersonator = sharedState.get("impersonator");",
        "    if (impersonatee && impersonator) {",
        "        outcome = "true";",
        "        sharedState.put("username", impersonatee);",
        "        setSharedObjectAttribute("userName", impersonatee);",
        "    }",
        "",
        "    logger.warning("Impersonate: Switch Actors: finish [outcome=".concat(outcome).concat("]"));",
        "  ",
        "    /*",
        "     * Store attributes in shared state for use with the Create/Patch Object nodes.",
        "     */",
        "    function setSharedObjectAttribute(name, value) {",
        "         var storage = sharedState.get("objectAttributes");",
        "        if (storage && value) {",
        "            if (storage.put) {",
        "                  storage.put(name, value);",
        "            }",
        "            else {",
        "                storage[name] = value;",
        "            }",
        "        }",
        "        else if (value) {",
        "            sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "        }",
        "    }",
        "}());",
      ],
    },
    "8862ca8f-7770-4af5-a888-ac0df0947f36": {
      "_id": "8862ca8f-7770-4af5-a888-ac0df0947f36",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from LinkedIn",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "LinkedIn Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "return json(object(",
        "        field("id", rawProfile.id),",
        "        field("givenName", rawProfile.firstName.localized.get(0)),",
        "        field("familyName", rawProfile.lastName.localized.get(0)),",
        "        field("photoUrl", rawProfile.profilePicture.displayImage),",
        "        field("email", rawProfile.elements.get(0).get("handle~").emailAddress),",
        "        field("username", rawProfile.elements.get(0).get("handle~").emailAddress)))",
      ],
    },
    "89eff37a-2e1e-47c2-8d62-5f7417fbb6b4": {
      "_id": "89eff37a-2e1e-47c2-8d62-5f7417fbb6b4",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Return TextOutputCallback indicating the provided OTP was invalid.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "OTP Invalid",
      "script": [
        "/* OTP Invalid",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Return TextOutputCallback indicating the provided OTP was invalid.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "outcome = "true";",
        "var fr = JavaImporter(",
        "    org.forgerock.openam.auth.node.api.Action,",
        "    javax.security.auth.callback.TextOutputCallback",
        ")",
        "if (callbacks.isEmpty()) {",
        "    action = fr.Action.send(",
        "        new fr.TextOutputCallback(",
        "            fr.TextOutputCallback.INFORMATION,",
        "            "INVALID"",
        "        )",
        "    ).build()",
        "}",
        "else {",
        "  action = fr.Action.goTo(outcome).build();",
        "}",
      ],
    },
    "8a768bb3-01cd-46b8-881c-b77f5a26c283": {
      "_id": "8a768bb3-01cd-46b8-881c-b77f5a26c283",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Write Onfido HTML Meta Tags",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Onfido-Meta-Tags",
      "script": [
        "/* Write HTML Meta Tags",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * This script writes meta tags to the header.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "(function () {",
        "  var fr = JavaImporter(",
        "      org.forgerock.openam.auth.node.api.Action,",
        "      com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        "  )",
        "",
        "  function createScript() {",
        "    return String("\\n\\",
        "    Array.prototype.slice.call(\\n\\",
        "      document.getElementsByTagName('head')\\n\\",
        "    ).forEach(\\n\\",
        "      function (e) {\\n\\",
        "        var meta = document.createElement('meta'); \\n\\",
        "        meta.name = \\"author\\"; \\n\\",
        "        meta.content = \\"John Doe\\"; \\n\\",
        "        document.getElementsByTagName('head')[0].appendChild(meta); \\n\\",
        "      }\\n\\",
        "    )");",
        "  }",
        "",
        "  if (callbacks.isEmpty()) {",
        "      action = fr.Action.send(",
        "          new fr.ScriptTextOutputCallback(createScript())",
        "      ).build()",
        "  } else {",
        "      action = fr.Action.goTo("true").build();",
        "  }",
        "}());",
      ],
    },
    "8bccfdd0-5556-4562-a1ca-6d725a449556": {
      "_id": "8bccfdd0-5556-4562-a1ca-6d725a449556",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "display country",
      "script": [
        "var fr = JavaImporter(",
        "  org.forgerock.openam.auth.node.api,",
        "  javax.security.auth.callback.TextOutputCallback",
        ");",
        "  ",
        "outcome = "true";",
        "",
        "var country = "unknown";",
        "if (transientState.get("ipstack")) {",
        "    country = JSON.parse(transientState.get("ipstack")).country_code;",
        "}",
        "  ",
        "with (fr) {",
        "  if (callbacks.isEmpty()) {",
        "    var callback = new TextOutputCallback(TextOutputCallback.INFORMATION, "Country: ".concat(country));",
        "    action = Action.send(callback).build();",
        "  } else {",
        "    action = Action.goTo("true").build();",
        "  }",
        "}",
      ],
    },
    "8e03eb43-ed5d-4c12-9e15-2051cc9be578": {
      "_id": "8e03eb43-ed5d-4c12-9e15-2051cc9be578",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Copy SAML Data To ObjectAttributes",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "CopySAMLDataToObjectAttributes",
      "script": [
        "/* CopySAMLDataToObjectAttributes",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Copy SAML Data To ObjectAttributes.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "outcome = "true";",
        "if (sharedState.get("userInfo")) {",
        "    if (sharedState.get("objectAttributes")) {",
        "          sharedState.remove("objectAttributes");",
        "    }",
        "    var userName=null,givenName=null,sn=null,mail=null,telephoneNumber=null,roles=null;",
        "",
        "    try { userName=sharedState.get("userInfo").get("userNames").get("uid").get(0).toString(); } catch (e) {}",
        "    try { givenName=sharedState.get("userInfo").get("attributes").get("givenName").get(0).toString(); } catch (e) {}",
        "    try { sn=sharedState.get("userInfo").get("attributes").get("sn").get(0).toString(); } catch (e) {}",
        "    try { mail=sharedState.get("userInfo").get("attributes").get("mail").get(0).toString(); } catch (e) {}",
        "    try { telephoneNumber=sharedState.get("userInfo").get("attributes").get("telephoneNumber").get(0).toString(); } catch (e) {}",
        "    //try { roles=sharedState.get("userInfo").get("attributes").get("roles").get(0).toString(); } catch (e) {}",
        "    try { roles=sharedState.get("userInfo").get("attributes").get("roles").toArray().join("|"); } catch (e) {}",
        "",
        "    sharedState.put("objectAttributes", {"userName":userName,"givenName":givenName,"sn":sn,"mail":mail,"telephoneNumber":telephoneNumber,"roles":roles});",
        "}",
      ],
    },
    "8e298710-b55e-4085-a464-88a375a4004b": {
      "_id": "8e298710-b55e-4085-a464-88a375a4004b",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from Twitter",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Twitter Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "return json(object(",
        "        field("id", rawProfile.id_str),",
        "        field("displayName", rawProfile.name),",
        "        field("photoUrl", rawProfile.profile_image_url),",
        "        field("email", rawProfile.email),",
        "        field("username", rawProfile.screen_name)))",
      ],
    },
    "90c4eca5-05f0-42f5-b9bf-88b693eabbbd": {
      "_id": "90c4eca5-05f0-42f5-b9bf-88b693eabbbd",
      "context": "SAML2_IDP_ATTRIBUTE_MAPPER",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Saml2 IDP Attribute Mapper Script",
      "script": [
        "/*",
        " * Copyright 2021 ForgeRock AS. All Rights Reserved",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        " * This script returns a list of SAML Attribute objects for the IDP framework to insert into the generated Assertion.",
        " *",
        " * Defined variables:",
        " * session - SSOToken (1)",
        " *           The single sign-on session.",
        " * hostedEntityId - String (primitive).",
        " *                  The hosted entity ID.",
        " * remoteEntityId - String (primitive).",
        " *                  The remote entity ID.",
        " * realm - String (primitive).",
        " *         The name of the realm the user is authenticating to.",
        " * logger - Always present, the debug logger instance:",
        " *          https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.",
        " *          Corresponding log files will be prefixed with: scripts.SAML2_IDP_ATTRIBUTE_MAPPER",
        " * idpAttributeMapperScriptHelper - IdpAttributeMapperScriptHelper (2)",
        " *                                - An IdpAttributeMapperScriptHelper instance containing methods used for IDP attribute mapping.",
        " *",
        " * Throws SAML2Exception:",
        " *      - on failing to map the IDP attributes.",
        " *",
        " * Return - a list of SAML Attribute (3) objects.",
        " *",
        " * Class reference:",
        " * (1) SSOToken - https://backstage.forgerock.com/docs/am/7/apidocs/com/iplanet/sso/SSOToken.html.",
        " * (2) IdpAttributeMapperScriptHelper - https://backstage.forgerock.com/docs/am/7/apidocs/com/sun/identity/saml2/plugins/scripted/IdpAttributeMapperScriptHelper.html.",
        " * (3) Attribute - https://backstage.forgerock.com/docs/am/7/apidocs/com/sun/identity/saml2/assertion/Attribute.html.",
        " */",
        "",
        "/**",
        " * Default SAML2 IDP Attribute Mapper.",
        " */",
        "function getAttributes() {",
        "    var frJava = JavaImporter(",
        "        com.sun.identity.saml2.common.SAML2Exception",
        "    );",
        "",
        "    const debugMethod = "ScriptedIDPAttributeMapper.getAttributes:: ";",
        "",
        "    try {",
        "",
        "        if (!idpAttributeMapperScriptHelper.isSessionValid(session)) {",
        "            logger.error(debugMethod + "Invalid session.");",
        "            return null;",
        "        }",
        "",
        "        var configMap = idpAttributeMapperScriptHelper.getRemoteSPConfigAttributeMap(realm, remoteEntityId);",
        "        logger.message(debugMethod + "Remote SP attribute map = {}", configMap);",
        "        if (configMap == null || configMap.isEmpty()) {",
        "            configMap = idpAttributeMapperScriptHelper.getHostedIDPConfigAttributeMap(realm, hostedEntityId);",
        "            if (configMap == null || configMap.isEmpty()) {",
        "                logger.message(debugMethod + "Configuration map is not defined.");",
        "                return null;",
        "            }",
        "            logger.message(debugMethod + "Hosted IDP attribute map = {}", configMap);",
        "        }",
        "",
        "        var attributes = new java.util.ArrayList();",
        "        var stringValueMap = new java.util.HashSet();",
        "        var binaryValueMap;",
        "        var localAttribute;",
        "",
        "        // Don't try to read the attributes from the datastore if the ignored profile is enabled in this realm.",
        "        if (!idpAttributeMapperScriptHelper.isIgnoredProfile(session, realm)) {",
        "            try {",
        "                // Resolve attributes to be read from the datastore.",
        "                var stringAttributes = new java.util.HashSet();",
        "                var binaryAttributes = new java.util.HashSet();",
        "                var keyIter = configMap.keySet().iterator();",
        "                while (keyIter.hasNext()) {",
        "                    var key = keyIter.next();",
        "                    localAttribute = configMap.get(key);",
        "                    if (!idpAttributeMapperScriptHelper.isStaticAttribute(localAttribute)) {",
        "                        if (idpAttributeMapperScriptHelper.isBinaryAttribute(localAttribute)) {",
        "                            // add it to the list of attributes to treat as being binary",
        "                            binaryAttributes.add(idpAttributeMapperScriptHelper.removeBinaryAttributeFlag(localAttribute));",
        "                        } else {",
        "                            stringAttributes.add(localAttribute);",
        "                        }",
        "                    }",
        "                }",
        "",
        "                if (!stringAttributes.isEmpty()) {",
        "                    stringValueMap = idpAttributeMapperScriptHelper.getAttributes(session, stringAttributes);",
        "                }",
        "                if (!binaryAttributes.isEmpty()) {",
        "                    binaryValueMap = idpAttributeMapperScriptHelper.getBinaryAttributes(session, binaryAttributes);",
        "                }",
        "            } catch (error) {",
        "                logger.error(debugMethod + "Error accessing the datastore. " + error);",
        "                //continue to check in ssotoken.",
        "            }",
        "        }",
        "",
        "        var keyIter = configMap.keySet().iterator();",
        "        while (keyIter.hasNext()) {",
        "            var key = keyIter.next()",
        "            var nameFormat = null;",
        "            var samlAttribute = key;",
        "            localAttribute = configMap.get(key);",
        "            // check if samlAttribute has format nameFormat|samlAttribute",
        "            var samlAttributes = String(new java.lang.String(samlAttribute));",
        "            var tokens = samlAttributes.split('|');",
        "",
        "            if (tokens.length > 1) {",
        "                nameFormat = tokens[0];",
        "                samlAttribute = tokens[1];",
        "            }",
        "",
        "            var attributeValues = new java.util.HashSet();",
        "            if (idpAttributeMapperScriptHelper.isStaticAttribute(localAttribute)) {",
        "                // Remove the static flag before using it as the static value",
        "                localAttribute = idpAttributeMapperScriptHelper.removeStaticAttributeFlag(localAttribute);",
        "                attributeValues = new java.util.HashSet([localAttribute]);",
        "                logger.message(debugMethod + "Adding static value {} for attribute named {}", localAttribute, samlAttribute);",
        "            } else {",
        "                if (idpAttributeMapperScriptHelper.isBinaryAttribute(localAttribute)) {",
        "                    // Remove the flag as not used for lookup",
        "                    localAttribute = idpAttributeMapperScriptHelper.removeBinaryAttributeFlag(localAttribute);",
        "                    attributeValues = idpAttributeMapperScriptHelper.getBinaryAttributeValues(samlAttribute, localAttribute,",
        "                        binaryValueMap);",
        "                } else {",
        "                    if (stringValueMap != null && !stringValueMap.isEmpty()) {",
        "                        attributeValues = stringValueMap.get(localAttribute);",
        "                    } else {",
        "                        logger.message(debugMethod + "{} string value map was empty or null.", localAttribute);",
        "                    }",
        "                }",
        "",
        "                // If all else fails, try to get the value from the users ssoToken",
        "                if (attributeValues == null || attributeValues.isEmpty()) {",
        "                    logger.message(debugMethod + "User profile does not have value for {}, checking SSOToken.", localAttribute);",
        "                    attributeValues = new java.util.HashSet(idpAttributeMapperScriptHelper.getPropertySet(session, localAttribute));",
        "                }",
        "            }",
        "",
        "            if (attributeValues == null || attributeValues.isEmpty()) {",
        "                logger.message(debugMethod + "{} not found in user profile or SSOToken.", localAttribute);",
        "            } else {",
        "                attributes.add(idpAttributeMapperScriptHelper.createSAMLAttribute(samlAttribute, nameFormat, attributeValues));",
        "            }",
        "        }",
        "",
        "        return attributes;",
        "",
        "    } catch (error) {",
        "        logger.error(debugMethod + "Error mapping IDP attributes. " + error);",
        "        throw new frJava.SAML2Exception(error);",
        "    }",
        "}",
        "",
        "getAttributes();",
      ],
    },
    "91554b10-79a5-4aa8-aca1-59481a734c19": {
      "_id": "91554b10-79a5-4aa8-aca1-59481a734c19",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Twilio SMS OTP Sender",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Twilio SMS OTP Sender",
      "script": [
        "/* Twilio SMS OTP Sender",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * This script will send an SMS containing the OTP to the phone number in the user's profile.",
        " * ",
        " * This script needs to be parametrized. It will not work properly as is. ",
        " * It requires the Identify Existing User node and HOTP Generator node before it is being called.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - sent",
        " * - failed",
        " */",
        "logger.warning("Twilio SMS OTP Sender: start");",
        "",
        "if (sharedState.get("_id") && idRepository.getAttribute(sharedState.get("_id"), "telephoneNumber").iterator().hasNext()) {",
        "    var Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(input){var output="";var chr1,chr2,chr3,enc1,enc2,enc3,enc4;var i=0;input=Base64._utf8_encode(input);while(i<input.length){chr1=input.charCodeAt(i++);chr2=input.charCodeAt(i++);chr3=input.charCodeAt(i++);enc1=chr1>>2;enc2=(chr1&3)<<4|chr2>>4;enc3=(chr2&15)<<2|chr3>>6;enc4=chr3&63;if(isNaN(chr2)){enc3=enc4=64}else if(isNaN(chr3)){enc4=64}output=output+this._keyStr.charAt(enc1)+this._keyStr.charAt(enc2)+this._keyStr.charAt(enc3)+this._keyStr.charAt(enc4)}return output},decode:function(input){var output="";var chr1,chr2,chr3;var enc1,enc2,enc3,enc4;var i=0;input=input.replace(/[^A-Za-z0-9\\+\\/\\=]/g,"");while(i<input.length){enc1=this._keyStr.indexOf(input.charAt(i++));enc2=this._keyStr.indexOf(input.charAt(i++));enc3=this._keyStr.indexOf(input.charAt(i++));enc4=this._keyStr.indexOf(input.charAt(i++));chr1=enc1<<2|enc2>>4;chr2=(enc2&15)<<4|enc3>>2;chr3=(enc3&3)<<6|enc4;output=output+String.fromCharCode(chr1);if(enc3!=64){output=output+String.fromCharCode(chr2)}if(enc4!=64){output=output+String.fromCharCode(chr3)}}output=Base64._utf8_decode(output);return output},_utf8_encode:function(string){string=string.replace(/\\r\\n/g,"\\n");var utftext="";for(var n=0;n<string.length;n++){var c=string.charCodeAt(n);if(c<128){utftext+=String.fromCharCode(c)}else if(c>127&&c<2048){utftext+=String.fromCharCode(c>>6|192);utftext+=String.fromCharCode(c&63|128)}else{utftext+=String.fromCharCode(c>>12|224);utftext+=String.fromCharCode(c>>6&63|128);utftext+=String.fromCharCode(c&63|128)}}return utftext},_utf8_decode:function(utftext){var string="";var i=0;var c=c1=c2=0;while(i<utftext.length){c=utftext.charCodeAt(i);if(c<128){string+=String.fromCharCode(c);i++}else if(c>191&&c<224){c2=utftext.charCodeAt(i+1);string+=String.fromCharCode((c&31)<<6|c2&63);i+=2}else{c2=utftext.charCodeAt(i+1);c3=utftext.charCodeAt(i+2);string+=String.fromCharCode((c&15)<<12|(c2&63)<<6|c3&63);i+=3}}return string}};",
        "",
        "       /* BEGIN SCRIPT CONFIGURATION",
        "     *",
        "     * REPLACE WITH YOUR OWN AZURE AD SETTINGS",
        "     */",
        "    var TWILIO_API_SID = "AC750415e3163a2e57b7aeea7eed82d944";",
        "    var TWILIO_API_TOKEN = "d36a719c94b4be08592d69ec4f80a5bb";",
        "    var TWILIO_API_FROM = "+13176443107";",
        "    /*",
        "     * END SCRIPT CONFIGURATION",
        "     */",
        "  ",
        "    // Twilio SMS Message API Configuration",
        "    var TWILIO_API_URI = "https://api.twilio.com/2010-04-01/Accounts/".concat(TWILIO_API_SID).concat("/Messages.json");    ",
        "    var TWILIO_API_TO = idRepository.getAttribute(sharedState.get("_id"), "telephoneNumber").iterator().next();",
        "    var TWILIO_API_BODY = "OTP for account ".concat(sharedState.get("username")).concat(": ").concat(sharedState.get("oneTimePassword"));",
        "    //logger.warning("Twilio SMS OTP Sender: To: ".concat(TWILIO_API_TO));",
        "    //logger.warning("Twilio SMS OTP Sender: Message: ".concat(TWILIO_API_BODY));",
        "",
        "    var AUTHZ = "Basic ".concat(Base64.encode(TWILIO_API_SID.concat(':').concat(TWILIO_API_TOKEN)));",
        "    //logger.warning("Twilio SMS OTP Sender: AUTHZ - ".concat(AUTHZ));",
        "",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setMethod('POST');",
        "    request.setUri(TWILIO_API_URI);",
        "    request.getHeaders().add("Content-Type", "application/x-www-form-urlencoded");",
        "    request.getHeaders().add("Authorization", AUTHZ);",
        "    var params = request.getForm();",
        "    params.add("From", TWILIO_API_FROM);",
        "    params.add("Body", TWILIO_API_BODY);",
        "    params.add("To", TWILIO_API_TO);",
        "    request.getEntity().setString(params.toString());",
        "",
        "    var response = httpClient.send(request).get();",
        "    var result = JSON.parse(response.getEntity().getString());",
        "    //logger.warning("Twilio SMS OTP Sender: JSON result: " + JSON.stringify(result));",
        "",
        "    if (result["error_code"]) {",
        "        outcome = "failed";",
        "        logger.error("Twilio SMS OTP Sender: error_code = ".concat(result["error_code"]));",
        "        logger.error("Twilio SMS OTP Sender: error_message = ".concat(result["error_message"]));",
        "        logger.error("Twilio SMS OTP Sender: outcome = failed");",
        "    } else if (result["code"]) {",
        "        outcome = "failed";",
        "        logger.error("Twilio SMS OTP Sender: code = ".concat(result["code"]));",
        "        logger.error("Twilio SMS OTP Sender: message = ".concat(result["message"]));",
        "    } else {",
        "        outcome = "sent";",
        "        logger.warning("Twilio SMS OTP Sender: outcome = sent");",
        "    }",
        "} else {",
        "      outcome = "failed";",
        "      logger.error("Twilio SMS OTP Sender: No user or phone number found! Use 'Identify Existing User node before this script to populate the user's _id in shared state!'");",
        "      logger.error("Twilio SMS OTP Sender: outcome = failed");",
        "}",
      ],
    },
    "91d197de-5916-4dca-83b5-9a4df26e7159": {
      "_id": "91d197de-5916-4dca-83b5-9a4df26e7159",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from WordPress",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "WordPress Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "return json(object(",
        "        field("id", rawProfile.username),",
        "        field("displayName", rawProfile.display_name),",
        "        field("photoUrl", rawProfile.avatar_URL),",
        "        field("email", rawProfile.email),",
        "        field("username", rawProfile.username)))",
      ],
    },
    "92edf2c7-0bab-412c-a0da-82ad4f04505b": {
      "_id": "92edf2c7-0bab-412c-a0da-82ad4f04505b",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Collect Extra Fields",
      "script": [
        "/* Collect Extra Fields",
        " * ",
        " * Collect extra fields not part of the user profile.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    outcome = 'true';",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "          javax.security.auth.callback.NameCallback",
        "    )",
        "    if (callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "            new fr.NameCallback('modality'),",
        "            new fr.NameCallback('jwtToken')",
        "        ).build();",
        "    }",
        "    else {",
        "          var modality = callbacks.get(0).getName();",
        "          var jwtToken = callbacks.get(1).getName();",
        "          nodeState.putShared('modality', modality);",
        "          nodeState.putShared('jwtToken', jwtToken);",
        "        action = fr.Action.goTo(outcome).build();",
        "    }",
        "}());",
      ],
    },
    "9399ac8b-3a6e-423b-95a2-6e0fd07262b1": {
      "_id": "9399ac8b-3a6e-423b-95a2-6e0fd07262b1",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "APIProtection: Get Key And Secret",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "APIProtection: Get Key And Secret",
      "script": [
        "logger.warning("APIProtection: Get Key And Secret: start");",
        "",
        "/*",
        " * BEGIN SCRIPT CONFIGURATION",
        " */",
        "var KEY_HEADER_NAME = "x-api-key";",
        "var SECRET_HEADER_NAME = "x-api-secret";",
        "var USERNAME_HEADER_NAME = "X-OpenAM-Username";",
        "var PASSWORD_HEADER_NAME = "X-OpenAM-Password";",
        "/*",
        " * END SCRIPT CONFIGURATION",
        " */",
        "",
        "outcome = "false";",
        "",
        "var key = getHeader(KEY_HEADER_NAME) || readValue(KEY_HEADER_NAME) || null;",
        "var secret = getHeader(SECRET_HEADER_NAME) || readTransientValue(SECRET_HEADER_NAME) || null;",
        "",
        "var username = sharedState.get("username") || null;",
        "var password = transientState.get("password") || null;",
        "",
        "if (key && secret) {",
        "    logger.warning("APIProtection: Get Key And Secret: key=".concat(key));",
        "  ",
        "      storeValue(KEY_HEADER_NAME, key);",
        "      storeValue("username", username);",
        "      sharedState.put("username", key);",
        "      ",
        "      storeTransientValue(SECRET_HEADER_NAME, secret);",
        "      storeTransientValue("password", password);",
        "      transientState.put("password", secret);",
        "  ",
        "    outcome = "true";",
        "}",
        "",
        "logger.warning("APIProtection: Get Key And Secret: finish [outcome=".concat(outcome).concat("]"));",
        "",
        "/*",
        " * Returns the value of the requested header",
        " */",
        "function getHeader(headerName) {",
        "      if (requestHeaders.get(headerName) && requestHeaders.get(headerName).get(0)) {",
        "        return requestHeaders.get(headerName).get(0).toString();",
        "    }",
        "      return null;",
        "}",
        "",
        "/*",
        " * Store value for APIProtection script use",
        " */",
        "function storeValue(name, value) {",
        "      var storage = sharedState.get("APIProtection");",
        "    if (storage && value) {",
        "          if (storage.put) {",
        "            storage.put(name, value);",
        "        }",
        "          else {",
        "              storage[name] = value;",
        "        }",
        "    }",
        "    else if (value) {",
        "        sharedState.put("APIProtection", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "    }",
        "}",
        "",
        "/*",
        " * Read value from storage for APIProtection script use",
        " */",
        "function readValue(name) {",
        "      var storage = sharedState.get("APIProtection");",
        "    if (storage) {",
        "          if (storage.get) {",
        "            return sharedState.get("APIProtection").get(name);",
        "        }",
        "          else {",
        "              return storage.name;",
        "        }",
        "    }",
        "      return null;",
        "}",
        "",
        "/*",
        " * Store transient value for APIProtection script use",
        " */",
        "function storeTransientValue(name, value) {",
        "    var transientStorage = transientState.get("APIProtection");",
        "    if (transientStorage && value) {",
        "          if (transientStorage.put) {",
        "            transientStorage.put(name, value);",
        "        }",
        "          else {",
        "              transientStorage[name] = value;",
        "        }",
        "    }",
        "    else if (value) {",
        "        transientState.put("APIProtection", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "    }",
        "}",
        "",
        "/*",
        " * Read transient value from storage for APIProtection script use",
        " */",
        "function readTransientValue(name) {",
        "      var transientStorage = transientState.get("APIProtection");",
        "    if (transientStorage) {",
        "          if (transientStorage.get) {",
        "            return transientState.get("APIProtection").get(name);",
        "        }",
        "          else {",
        "              return transientStorage.name;",
        "        }",
        "    }",
        "      return null;",
        "}",
      ],
    },
    "9535446c-0ff6-4a76-8576-616599119d64": {
      "_id": "9535446c-0ff6-4a76-8576-616599119d64",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Remove button from page.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Remove Button",
      "script": [
        "/* Remove Button",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Hide buttons on the journey page.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "(function () {",
        "    var script = "Array.prototype.slice.call(document.getElementsByTagName('button')).forEach(function (e) {e.style.display = 'none'})"",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "        javax.security.auth.callback.TextOutputCallback,",
        "        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        "    )",
        "    var message = " "",
        "    if (callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "            new fr.TextOutputCallback(",
        "                fr.TextOutputCallback.INFORMATION,",
        "                message",
        "            ),",
        "            new fr.ScriptTextOutputCallback(script)",
        "        ).build()",
        "    }",
        "}());",
      ],
    },
    "988c10fa-98da-4bf7-8ac9-a558d2fef1fd": {
      "_id": "988c10fa-98da-4bf7-8ac9-a558d2fef1fd",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Protection from malicious IDPs. Only allow white-listed email domains (usernames are email addresses).",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "IDP Integrity Check",
      "script": [
        "/* IDP Integrity Check",
        " * ",
        " * Protection from malicious IDPs. Only allow white-listed email domains (usernames are email addresses).",
        " * ",
        " * This script does not require cofiguration. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * - false",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    outcome = "false";",
        "      var routedIDP = sharedState.get("routedIDPs").get(0);",
        "      var validDomains = [];",
        "      if (routedIDP) {",
        "          validDomains = routedIDP.get("idpDomains");",
        "    }",
        "      ",
        "      var username = sharedState.get("username");",
        "      var domain = username.substr(username.lastIndexOf("@")+1);",
        "      if (validDomains.indexOf(domain) > -1) {",
        "          outcome = "true";",
        "    }",
        "}());",
      ],
    },
    "9de3eb62-f131-4fac-a294-7bd170fd4acb": {
      "_id": "9de3eb62-f131-4fac-a294-7bd170fd4acb",
      "context": "POLICY_CONDITION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Default global script for Scripted Policy Conditions",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Scripted Policy Condition",
      "script": [
        "/*",
        " * Copyright 2015-2017 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "/**",
        " * This is a Policy Condition example script. It demonstrates how to access a user's information,",
        " * use that information in external HTTP calls and make a policy decision based on the outcome.",
        " */",
        "",
        "var userAddress, userIP, resourceHost;",
        "",
        "if (validateAndInitializeParameters()) {",
        "",
        "    var countryFromUserAddress = getCountryFromUserAddress();",
        "    logger.message("Country retrieved from user's address: " + countryFromUserAddress);",
        "    var countryFromUserIP = getCountryFromUserIP();",
        "    logger.message("Country retrieved from user's IP: " + countryFromUserIP);",
        "    var countryFromResourceURI = getCountryFromResourceURI();",
        "    logger.message("Country retrieved from resource URI: " + countryFromResourceURI);",
        "",
        "    if (countryFromUserAddress === countryFromUserIP && countryFromUserAddress === countryFromResourceURI) {",
        "        logger.message("Authorization Succeeded");",
        "        responseAttributes.put("countryOfOrigin", [countryFromUserAddress]);",
        "        authorized = true;",
        "    } else {",
        "        logger.message("Authorization Failed");",
        "        authorized = false;",
        "    }",
        "",
        "} else {",
        "    logger.message("Required parameters not found. Authorization Failed.");",
        "    authorized = false;",
        "}",
        "",
        "/**",
        " * Use the user's address to lookup their country of residence.",
        " *",
        " * @returns {*} The user's country of residence.",
        " */",
        "function getCountryFromUserAddress() {",
        "",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setUri("http://maps.googleapis.com/maps/api/geocode/json?address=" + encodeURIComponent(userAddress));",
        "      request.setMethod("GET");",
        "",
        "    var response = httpClient.send(request).get();",
        "    logResponse(response);",
        "",
        "    var geocode = JSON.parse(response.getEntity().getString());",
        "    var i;",
        "    for (i = 0; i < geocode.results.length; i++) {",
        "        var result = geocode.results[i];",
        "        var j;",
        "        for (j = 0; j < result.address_components.length; i++) {",
        "            if (result.address_components[i].types[0] == "country") {",
        "                return result.address_components[i].long_name;",
        "            }",
        "        }",
        "    }",
        "}",
        "",
        "/**",
        " * Use the user's IP to lookup the country from which the request originated.",
        " *",
        " * @returns {*} The country from which the request originated.",
        " */",
        "function getCountryFromUserIP() {",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setUri("http://ip-api.com/json/" + userIP);",
        "      request.setMethod("GET");",
        "",
        "    var response = httpClient.send(request).get();",
        "    logResponse(response);",
        "",
        "    var result = JSON.parse(response.getEntity().getString());",
        "    if (result) {",
        "        return result.country;",
        "    }",
        "}",
        "",
        "/**",
        " * Use the requested resource's host name to lookup the country where the resource is hosted.",
        " *",
        " * @returns {*} The country in which the resource is hosted.",
        " */",
        "function getCountryFromResourceURI() {",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setUri("http://ip-api.com/json/" + encodeURIComponent(resourceHost));",
        "      request.setMethod("GET");",
        "",
        "    var response = httpClient.send(request).get();",
        "    logResponse(response);",
        "",
        "    var result = JSON.parse(response.getEntity().getString());",
        "    if (result) {",
        "        return result.country;",
        "    }",
        "}",
        "",
        "/**",
        " * Retrieve and validate the variables required to make the external HTTP calls.",
        " *",
        " * @returns {boolean} Will be true if validation was successful.",
        " */",
        "function validateAndInitializeParameters() {",
        "    var userAddressSet = identity.getAttribute("postalAddress");",
        "    if (userAddressSet == null || userAddressSet.isEmpty()) {",
        "        logger.warning("No address specified for user: " + username);",
        "        return false;",
        "    }",
        "    userAddress = userAddressSet.iterator().next();",
        "    logger.message("User address: " + userAddress);",
        "",
        "    if (!environment) {",
        "        logger.warning("No environment parameters specified in the evaluation request.");",
        "        return false;",
        "    }",
        "",
        "    var ipSet = environment.get("IP");",
        "    if (ipSet == null || ipSet.isEmpty()) {",
        "        logger.warning("No IP specified in the evaluation request environment parameters.");",
        "        return false;",
        "    }",
        "    userIP = ipSet.iterator().next();",
        "    logger.message("User IP: " + userIP);",
        "",
        "    if (!resourceURI) {",
        "        logger.warning("No resource URI specified.");",
        "        return false;",
        "    }",
        "    resourceHost = resourceURI.match(/^(.*:\\/\\/)(www\\.)?([A-Za-z0-9\\-\\.]+)(:[0-9]+)?(.*)$/)[3];",
        "    logger.message("Resource host: " + resourceHost);",
        "",
        "    return true;",
        "}",
        "",
        "function logResponse(response) {",
        "    logger.message("User REST Call. Status: " + response.getStatus() + ", Body: " + response.getEntity().getString());",
        "}",
      ],
    },
    "9e9c6c4d-5d9d-4990-9f05-d8b2b25ad52b": {
      "_id": "9e9c6c4d-5d9d-4990-9f05-d8b2b25ad52b",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Custom risk policy engine combining Autonomous Access signals with external signals.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "AA Custom Policy Engine",
      "script": [
        "/* AA Custom Policy Engine",
        " *",
        " * Author: marcin.zimny@forgerock.com",
        " * Adaptations: volker.scheuber@forgerock.com",
        " * ",
        " * Custom policy engine combining the Autonomous Access risk engine output with external systems and custom policy output:",
        " * ",
        " * - use multiple risk scoring policies (currently it's part of risk config file and used across all evaluations)",
        " * - deliver custom logic of delivering outcome (we can sum the signals instead of returning the highest)",
        " * - use custom signals as part of the (single) risk node (for example anonymisation detection)",
        " * - exceptions/overrides (i.e. if we have to allow a flow with high risk for whatever reason) ",
        " * ",
        " * This script needs to be parametrized. It will NOT work properly as is!",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - low",
        " * - medium",
        " * - high",
        " * - failed",
        " */",
        "(function () {",
        "  /* ",
        "   * MUST CONFIGURE THIS SECTION",
        "   * Custom signals parameters",
        "   */",
        "  ",
        "  // IPQualityScore API",
        "  var USER_AGENT = "ForgeRock"",
        "  var API_KEY = systemEnv.getProperty("esv.ipqs.api.key");",
        "  ",
        "  /*",
        "   * END MANDATORY CONFIGURATION",
        "   */",
        "  ",
        "  outcome = "failed"; //default outcome",
        "  /*",
        "    Risk Policy - Signal Scores",
        "  */",
        "  var aa_impossible_travel_score = 21;",
        "  var aa_credential_stuffing_score = 100;",
        "  var aa_automated_user_agent_score = 25;",
        "  var aa_brute_force_score = 100;",
        "  var aa_suspicious_ip_score = 35;",
        "  /*",
        "    Risk Policy - Custom Signals",
        "  */",
        "  var aa_use_anonymizer_detection = 1;",
        "  var custom_aa_tor_detected_score = 50;",
        "  var custom_aa_vpn_detected_score = 20;",
        "  var custom_aa_proxy_detected_score = 20;",
        "  /*",
        "    Risk Policy - Thresholds And Extra Features",
        "  */",
        "  var aa_medium_risk_threshold = 30;",
        "  var aa_high_risk_threshold = 75;",
        "  var aa_max_signal_count_high_risk_override = 99;",
        "  /*",
        "    Risk Policy - Method",
        "      0 - highest score out of all triggered signals",
        "      1 - summary of all triggered signals",
        "  */",
        "  var aa_risk_method=1;",
        "  /*",
        "    Risk Policy - UEBA method",
        "      0 - highest score out of 3 models",
        "      1 - average score out of 3 models",
        "  */",
        "  var aa_ueba_method=0;",
        "  /*",
        "    Risk Policy - Overrides",
        "",
        "    Whitelist - false positive control",
        "    Blacklist - preventative block",
        "    Example - ip_whitelist or ip_blacklist = ["62.21.63.30-62.21.63.30","82.21.168.1-82.21.168.255"];",
        "  */",
        "  var ip_whitelist = [];",
        "  var ip_blacklist = [];",
        "  ",
        "  /********************************************************",
        "    The engine *",
        "  */",
        "  //Define variables",
        "  var signal_count = 0;",
        "  var pos = 0;",
        "  var arr_scores = [];",
        "  var arr_scores_models = [];",
        "  var score = 0;",
        "  var predictionResultChopped;",
        "  var predictionResultChoppedVal;",
        "  //Define signal variables and assign defaults (negative)",
        "  var is_impossible_travel = 0;",
        "  var is_credential_stuffing = 0;",
        "  var is_automated_user_agent = 0;",
        "  var is_brute_force = 0;",
        "  var is_suspicious_ip = 0;",
        "  var model1_score = 0;",
        "  var model2_score = 0;",
        "  var model3_score = 0;",
        "  var isAnonymizedResult;",
        "  //Get risk data",
        "  var predictionResultRaw = sharedState.get("predictionResult");",
        "  var predictionResultString = predictionResultRaw.toString();",
        "",
        "  var result;",
        "",
        "  function inet_aton (ip)",
        "  {",
        "      return ip.split(".").reduce((int, v) => int * 256 + +v);",
        "  }",
        "",
        "",
        "  function isAnonymized()",
        "  {",
        "    var payload = sharedState.get("IPQualityScore")",
        "",
        "    if (payload)",
        "    {",
        "      var jsonResult = JSON.parse(payload);",
        "    }",
        "    else",
        "    {",
        "      var ipaddress = requestHeaders.get("X-FORWARDED-FOR").get(0).split(",")[0].trim();",
        "",
        "      var request = new org.forgerock.http.protocol.Request();",
        "      request.setMethod("GET");",
        "      request.setUri("https://ipqualityscore.com/api/json/ip/" + API_KEY + "/" + ipaddress + "?strictness=0&allow_public_access_points=false&fast=false&lighter_penalties=false&mobile=false");",
        "      request.getHeaders().add("Accept","application/json");",
        "      request.getHeaders().add("User-Agent", USER_AGENT);",
        "",
        "      var response = httpClient.send(request).get();",
        "      if (response.getStatus().getCode() === 200) {",
        "        var payload = response.getEntity().getString();",
        "        var jsonResult = JSON.parse(payload)",
        "          if (jsonResult.success === true) {",
        "          sharedState.put("Debug-IPQualityScore", payload);",
        "        }",
        "      }",
        "    }",
        "",
        "    if (jsonResult) {",
        "      if (jsonResult.tor === true) {",
        "        isAnonymizedResult = "tor";",
        "      } else if (jsonResult.vpn === true) {",
        "        isAnonymizedResult= "vpn";",
        "      } else if (jsonResult.proxy === true) {",
        "        isAnonymizedResult = "proxy";",
        "      } else {",
        "        isAnonymizedResult = "not_detected";",
        "      }",
        "    }",
        "  }",
        "",
        "",
        "  if(aa_use_anonymizer_detection==1)",
        "  {",
        "    isAnonymized();",
        "    sharedState.put("custom_aa_isAnonymized",isAnonymizedResult);",
        "    if(isAnonymizedResult=="vpn")",
        "    {",
        "      arr_scores.push(custom_aa_vpn_detected_score);",
        "    }",
        "    else if(isAnonymizedResult=="proxy")",
        "    {",
        "      arr_scores.push(custom_aa_proxy_detected_score);",
        "    }",
        "    else if(isAnonymizedResult=="tor")",
        "    {",
        "      arr_scores.push(custom_aa_tor_detected_score);",
        "    }",
        "    else",
        "    {",
        "      arr_scores.push(0);",
        "    }",
        "  }",
        "",
        "  if(predictionResultString.search("risk_score_data")>=0)",
        "  {",
        "    outcome = "low"; //default if there's data from risk API",
        "  }",
        "",
        "  //Check if we're assessing impossible travel and assign result",
        "  pos = predictionResultString.search("impossibleTravellerCheck=true");",
        "  if(pos>0)",
        "  {",
        "    pos = predictionResultString.search("is_impossible_travel=false");",
        "    if(pos<0)",
        "    {",
        "      signal_count++;",
        "      is_impossible_travel=1;",
        "      arr_scores.push(aa_impossible_travel_score);",
        "    }",
        "  }",
        "  //Check if we're assessing credential stuffing and assign result",
        "  pos = predictionResultString.search("credentialStuffing=true");",
        "  if(pos>0)",
        "  {",
        "    pos = predictionResultString.search("is_credential_stuffing=false");",
        "    if(pos<0)",
        "    {",
        "      signal_count++;",
        "      is_credential_stuffing=1;",
        "      arr_scores.push(aa_credential_stuffing_score);",
        "    }",
        "  }",
        "  //Check if we're assessing automated user angent (antibot) and assign result",
        "  pos = predictionResultString.search("automatedUserAgentsFilter=true");",
        "  if(pos>0)",
        "  {",
        "    pos = predictionResultString.search("is_automated_user_agent=false");",
        "    if(pos<0)",
        "    {",
        "      signal_count++;",
        "      is_automated_user_agent=1;",
        "      arr_scores.push(aa_automated_user_agent_score);",
        "    }",
        "  }",
        "  //Check if we're assessing brute-force and assign result",
        "  pos = predictionResultString.search("bruteForcePreventionCheck=true");",
        "  if(pos>0)",
        "  {",
        "    pos = predictionResultString.search("is_brute_force=false");",
        "    if(pos<0)",
        "    {",
        "      signal_count++;",
        "      is_brute_force=1;",
        "      arr_scores.push(aa_brute_force_score);",
        "    }",
        "  }",
        "  //Check if we're assessing suspicious IP and assign result",
        "  pos = predictionResultString.search("suspiciousIPCheck=true");",
        "  if(pos>0)",
        "  {",
        "    pos = predictionResultString.search("is_suspicious_ip=false");",
        "    if(pos<0)",
        "    {",
        "      signal_count++;",
        "      is_suspicious_ip=1;",
        "      arr_scores.push(aa_suspicious_ip_score);",
        "    }",
        "  }",
        "  //Check if we're assessing UEBA and assign result",
        "  pos = predictionResultString.search("anomalyDetection=true");",
        "  if(pos>0)",
        "  {",
        "    pos = predictionResultString.search("clustering_result=");",
        "    if(pos>0)",
        "    {",
        "        predictionResultChopped=predictionResultString.substring(pos);",
        "        predictionResultChopped=predictionResultChopped.substring(predictionResultChopped.search("risk_score="));",
        "        predictionResultChoppedVal=predictionResultChopped.substring(11,predictionResultChopped.search(","));",
        "        predictionResultChopped=predictionResultChopped.substring(11);",
        "        model1score=parseInt(predictionResultChoppedVal,10);",
        "",
        "        predictionResultChopped=predictionResultChopped.substring(predictionResultChopped.search("risk_score="));",
        "        predictionResultChoppedVal=predictionResultChopped.substring(11,predictionResultChopped.search(","));",
        "        predictionResultChopped=predictionResultChopped.substring(11);",
        "        model2score=parseInt(predictionResultChoppedVal,10);",
        "",
        "        predictionResultChopped=predictionResultChopped.substring(predictionResultChopped.search("risk_score="));",
        "        predictionResultChoppedVal=predictionResultChopped.substring(11,predictionResultChopped.search(","));",
        "        predictionResultChopped=predictionResultChopped.substring(11);",
        "        model3score=parseInt(predictionResultChoppedVal,10);",
        "",
        "        arr_scores_models.push(model1score,model2score,model3score);",
        "    }",
        "  }",
        "",
        "  //Deliver risk score",
        "  if(aa_ueba_method==0)",
        "  {",
        "    score = Math.max.apply(null, arr_scores_models);",
        "  }",
        "  else if(aa_ueba_method==1)",
        "  {",
        "    score = arr_scores_models.reduce((a, b) => a + b, 0)/arr_scores_models.length;",
        "  }",
        "  arr_scores.push(score);",
        "",
        "",
        "  if(aa_risk_method==0)",
        "  {",
        "    score = Math.max.apply(null, arr_scores);",
        "  }",
        "  else if (aa_risk_method===1)",
        "  {",
        "    score = arr_scores.reduce((a, b) => a + b, 0);",
        "  }",
        "  //Deliver risk outcome",
        "  if(score>aa_medium_risk_threshold)",
        "  {",
        "    outcome="medium";",
        "  }",
        "  if(score>aa_high_risk_threshold)",
        "  {",
        "    outcome="high";",
        "  }",
        "  if(signal_count>=aa_max_signal_count_high_risk_override && outcome=="medium")",
        "  {",
        "    outcome="high";",
        "    sharedState.put("debug-signal-count-override","true");",
        "  }",
        "",
        "  //process the blacklist and whitelist",
        "  var src_ipaddress;",
        "  var src_ipaddress_dec;",
        "  var list_first_ipaddress_dec;",
        "  var list_last_ipaddress_dec;",
        "  var list_entry;",
        "  var logmessage;",
        "  src_ipaddress = requestHeaders.get("X-FORWARDED-FOR").get(0).split(",")[0].trim();",
        "  src_ipaddress_dec = inet_aton(src_ipaddress);",
        "",
        "  if(ip_blacklist.length>0)",
        "  {",
        "    for (var i = 0; i < ip_blacklist.length; i++)",
        "    {",
        "      list_entry = ip_blacklist[i].split("-");",
        "      list_first_ipaddress_dec=inet_aton(list_entry[0]);",
        "      list_last_ipaddress_dec=inet_aton(list_entry[1]);",
        "",
        "      if(src_ipaddress_dec>=list_first_ipaddress_dec && src_ipaddress_dec<=list_last_ipaddress_dec)",
        "      {",
        "          sharedState.put("debug-blacklist","condition met for: " + src_ipaddress + ", " + outcome + "->high");",
        "           outcome="high";",
        "      }",
        "    }",
        "  }",
        "  if(ip_whitelist.length>0)",
        "  {",
        "    for (var i = 0; i < ip_whitelist.length; i++)",
        "    {",
        "      //list_entry = ip_whitelist[i].split("-");",
        "      list_entry = ip_whitelist[i].split("-");",
        "      list_first_ipaddress_dec=inet_aton(list_entry[0]);",
        "      list_last_ipaddress_dec=inet_aton(list_entry[1]);",
        "      if(src_ipaddress_dec>=list_first_ipaddress_dec && src_ipaddress_dec<=list_last_ipaddress_dec)",
        "      {",
        "        sharedState.put("debug-whitelist","condition met for: " + src_ipaddress + ", " + outcome + "->low");",
        "        outcome = "low";",
        "      }",
        "    }",
        "  }",
        "",
        "",
        "",
        "  sharedState.put('debug-score',score.toString());",
        "  sharedState.put('debug-signal-count',signal_count.toString());",
        "  sharedState.put('debug-outcome',outcome);",
        "}());",
      ],
    },
    "a064f7b7-29c5-480b-ac09-d3d122829278": {
      "_id": "a064f7b7-29c5-480b-ac09-d3d122829278",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Sanitize objectAttributes",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Sanitize objectAttributes",
      "script": [
        "/*",
        "{",
        "    "userName": "sholmes",",
        "    "givenName": "Sherlock",",
        "    "sn": "Holmes",",
        "    "mail": "info918@06152alerts.security.org",",
        "    "telephoneNumber": ,",
        "    "postalAddress": "221B Baker Street",",
        "    "city": "London",",
        "    "stateProvince": ,",
        "    "postalCode": "NW1",",
        "    "country": "United States",",
        "    "preferences": {",
        "        "marketing": false,",
        "        "updates": true",
        "    }",
        "}",
        "*/",
        "logger.error("Sanitize objectAttributes: start");",
        "outcome = "true";",
        "var attrs = sharedState.get("objectAttributes");",
        "if (attrs) {",
        "  var keys = [",
        "    "userName",",
        "    "givenName",",
        "    "sn",",
        "    "mail",",
        "    "telephoneNumber",",
        "    "postalAddress",",
        "    "city",",
        "    "stateProvince",",
        "    "postalCode",",
        "    "country",",
        "    "frIndexedString2"",
        "  ]",
        "  keys.forEach(function (key) {",
        "    if (attrs.get(key) && attrs.get(key).toString() == "") {",
        "      logger.error("Sanitize objectAttributes: remove ".concat(key));",
        "      attrs.remove(key);",
        "    }",
        "  })",
        "}",
        "if (transientState.get("objectAttributes") && transientState.get("objectAttributes").get("password").toString() !== "") {",
        "  logger.error("Sanitize objectAttributes: preserve password in shared state");",
        "  setSharedObjectAttribute("password", transientState.get("objectAttributes").get("password").toString());",
        "}",
        "logger.error("Sanitize objectAttributes: end");",
        "",
        "/*",
        " * Properly set attributes in shared state for use with the Create/Patch Object nodes.",
        " */",
        "function setSharedObjectAttribute(name, value) {",
        "    if (sharedState.get("objectAttributes")) {",
        "        sharedState.get("objectAttributes").put(name, value);",
        "    }",
        "    else {",
        "        sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":"+value+"}"));",
        "    }",
        "}",
      ],
    },
    "a316aedd-8b3b-4f68-b6e8-65859f1e87be": {
      "_id": "a316aedd-8b3b-4f68-b6e8-65859f1e87be",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_LocalRegistrationPrep",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        "When an admin managed object is created at the time of invitation, the email address",
        "is used to populate the required first/last names.  This script clears those attributes",
        "(if set to the email address) so the UI doesn't display the email address in the first/last",
        "name input fields.",
        "",
        "It also populates other required attributes with fake values to ensure password policy",
        "validation works correctly when AM calls IDM.",
        "*/",
        "",
        "var objAttrs = sharedState.get('objectAttributes') || new java.util.HashMap();",
        "objAttrs.put('givenName', '');",
        "objAttrs.put('sn', '');",
        "objAttrs.put('groups', ['fake']);",
        "objAttrs.put('inviteDate', 'fake');",
        "sharedState.put('objectAttributes', objAttrs);",
        "",
        "outcome = 'True';",
        "",
      ],
    },
    "a31a1796-8410-46b8-82ca-eb0c6e901775": {
      "_id": "a31a1796-8410-46b8-82ca-eb0c6e901775",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Collect all the configuration items required for the Set Custom Cookie node to function properly.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Collect Set Custom Cookie Node Config",
      "script": [
        "/* Collect Set Custom Cookie Node Config",
        " * ",
        " * Collect all the configuration items required for the Set Custom Cookie node to function properly.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    outcome = "true";",
        "      var config = {",
        "        "name": "oreo",",
        "        "value": "original",",
        "        "domain": ".scheuber.io",",
        "        "path": "/",",
        "        "maxAge": 3600,",
        "        "useHttpOnlyCookie": true,",
        "        "useSecureCookie": true,",
        "        "sameSite": "NONE"",
        "    };",
        "  ",
        "      var script = "";",
        "    script += "Array.prototype.slice.call(";",
        "    script += "    document.getElementsByTagName('input')";",
        "    script += ").forEach(";",
        "    script += "    function (input,i) {";",
        "    script += "        console.log('input '+i);"",
        "    script += "        var config = JSON.parse('"+JSON.stringify(config)+"');";",
        "    script += "        var keys = Object.keys(config);";",
        "    script += "        if (input.type === 'text') {";",
        "    script += "            input.setAttribute('value', config[keys[i]]);";",
        "    script += "            input.dispatchEvent(new KeyboardEvent( 'input' , {'key':'Enter'} ));";",
        "    script += "        }";",
        "    script += "    }";",
        "    script += ");";",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "          javax.security.auth.callback.NameCallback,",
        "        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        "    )",
        "    if (callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "            new fr.NameCallback("name"),",
        "            new fr.NameCallback("value"),",
        "            new fr.NameCallback("domain"),",
        "            new fr.NameCallback("path"),",
        "            new fr.NameCallback("maxAge"),",
        "            new fr.NameCallback("useHttpOnlyCookie"),",
        "            new fr.NameCallback("useSecureCookie"),",
        "            new fr.NameCallback("sameSite"),",
        "              new fr.ScriptTextOutputCallback(script)",
        "        ).build();",
        "    }",
        "    else {",
        "          config[callbacks.get(0).getPrompt()] = callbacks.get(0).getName();",
        "          config[callbacks.get(1).getPrompt()] = callbacks.get(1).getName();",
        "          config[callbacks.get(2).getPrompt()] = callbacks.get(2).getName();",
        "          config[callbacks.get(3).getPrompt()] = callbacks.get(3).getName();",
        "          config[callbacks.get(4).getPrompt()] = parseInt(callbacks.get(4).getName(), 10).toFixed();",
        "          config[callbacks.get(5).getPrompt()] = (""+callbacks.get(5).getName() === 'true');",
        "          config[callbacks.get(6).getPrompt()] = (""+callbacks.get(6).getName() === 'true');",
        "          config[callbacks.get(7).getPrompt()] = callbacks.get(7).getName();",
        "          nodeState.putShared("nodeConfig", config);",
        "        action = fr.Action.goTo(outcome).build();",
        "    }",
        "}());",
      ],
    },
    "a7a78773-445b-4eca-bb93-409e86bced81": {
      "_id": "a7a78773-445b-4eca-bb93-409e86bced81",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from GitHub",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "GitHub Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2022 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "return json(object(",
        "        field("id", rawProfile.id),",
        "        field("displayName", rawProfile.name),",
        "        field("username", rawProfile.login)))",
      ],
    },
    "a873fcd8-8f17-4675-9dd6-54ab1c11e2df": {
      "_id": "a873fcd8-8f17-4675-9dd6-54ab1c11e2df",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Record that MFA has been performed for this journey and no longer needs to be performed. This allows journeys and inner journeys to check that flag before performing MFA multiple times.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Record MFA",
      "script": [
        "/* MFA Status",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Record that MFA has been performed for this journey and no longer needs ",
        " * to be performed. This allows journeys and inner journeys to check that ",
        " * flag before performing MFA multiple times.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "outcome = "true";",
        "sharedState.put("mfaPerformed", "true");",
      ],
    },
    "a8f10e93-3f6c-4d6c-b6a3-a8453e3d6b3a": {
      "_id": "a8f10e93-3f6c-4d6c-b6a3-a8453e3d6b3a",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Reset the attributes holding replay credentials for the IG replay use case.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "ResetPasswordReplayCredentials",
      "script": [
        "/* ResetPasswordReplayCredentials",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Reset the attributes holding replay credentials for the IG replay use case.",
        " * ",
        " * This script needs to be parametrized for your env.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "(function () {",
        "  outcome = "true";",
        "  var REPLAY_USERNAME_IDM_ATTR = "frUnindexedString1";",
        "  var REPLAY_PASSWORD_IDM_ATTR = "frUnindexedString2";",
        "  ",
        "  sharedState.get("objectAttributes").put(REPLAY_USERNAME_IDM_ATTR, null);",
        "  sharedState.get("objectAttributes").put(REPLAY_PASSWORD_IDM_ATTR, null);",
        "}());",
      ],
    },
    "aa2dabff-f5c4-4dc5-b4ac-5909e88a3a8f": {
      "_id": "aa2dabff-f5c4-4dc5-b4ac-5909e88a3a8f",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Verify known caller by first name",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Twilio IVR: Verify Known Caller",
      "script": [
        "/* Twilio IVR: Verify Known Caller",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * - false",
        " * ",
        " * Depending on the amount of data collected through callbacks and how many of the callParams",
        " * you activate below, you will need to change your authentication session from JWT to CTS or",
        " * Memory.",
        " */",
        "logger.warning("Twilio IVR: Verify Known Caller: start");",
        "outcome = "false";",
        "",
        "/* Begin Configuration",
        " */",
        "",
        "// For ID Cloud use "_id", for classic deployments use "username"",
        "var userid = sharedState.get("_id")",
        "",
        "// Retrieve the known caller's first name",
        "var firstName = idRepository.getAttribute(userid, "givenName").iterator().next().replaceAll("[^a-zA-Z ]", "").toLowerCase();",
        "",
        "// Build out the full message",
        "var message = "I see we have a profile associated with your phone number!";",
        "",
        "// Build out the verification prompt",
        "var prompt = "To verify I have the right account, please say your first name.";",
        "",
        "/* End Configuration",
        " */",
        "",
        "var fr = JavaImporter(",
        "      org.forgerock.openam.auth.node.api,",
        "      javax.security.auth.callback.TextOutputCallback,",
        "      javax.security.auth.callback.TextInputCallback",
        ");",
        "  ",
        "with (fr) {",
        "      if (callbacks.isEmpty()) {",
        "        var output = new TextOutputCallback(TextOutputCallback.INFORMATION, message);",
        "        var input = new TextInputCallback(prompt);",
        "        action = Action.send(output, input).build();",
        "      } ",
        "      else {",
        "          var answer = callbacks.get(1).getText().replaceAll("[^a-zA-Z ]", "").toLowerCase();",
        "        logger.warning("Twilio IVR: Verify Known Caller: callbacks received: answer=".concat(answer).concat(" [firstName=").concat(firstName).concat("]"));",
        "        if (answer == firstName) {",
        "              outcome = "true";",
        "        }",
        "          else if (answer.length == 0) {",
        "              outcome = "no input";",
        "        }",
        "        logger.warning("Twilio IVR: Verify Known Caller: finish [outcome=".concat(outcome).concat("]"));",
        "        action = Action.goTo(outcome).build();",
        "      }",
        "}",
      ],
    },
    "ab78dcb5-85cb-41a6-813e-e07a77761376": {
      "_id": "ab78dcb5-85cb-41a6-813e-e07a77761376",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_ProfileToManagedObject",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "function setIfValidString(managedData, managedKey, profileKey) {",
        "  var normalizedValue = normalizedProfile.get(profileKey);",
        "  if (normalizedValue && !normalizedValue.isNull() && normalizedValue.asString() != '') {",
        "    managedData.put(managedKey, normalizedValue);",
        "  }",
        "}",
        "",
        "(function () {",
        "  var frJava = JavaImporter(",
        "    org.forgerock.json.JsonValue,",
        "    java.util.HashMap",
        "  );",
        "",
        "  var OBJ_ATTR = 'objectAttributes';",
        "",
        "  // We should have objectAttributes during onboarding because the user is established earlier in",
        "  // the journey.  We won't have objectAttributes during login, though.",
        "  var objAttrs = sharedState.containsKey(OBJ_ATTR) ? sharedState.get(OBJ_ATTR) : new frJava.HashMap();",
        "",
        "  // If this flow requires email matching, confirm the IdP user email address matches the FR email address",
        "  if (sharedState.checkEmailClaim == true) {",
        "    var idpEmail = normalizedProfile.get('email').asString();",
        "    var frEmail = objAttrs.get('mail');",
        "    if (idpEmail != frEmail) {",
        "      throw 'Email claim from IDP does not match identity mail attribute';",
        "    }",
        "  }",
        "",
        "  // Update user with first/last name from IDP, if available",
        "  var managedUserData = frJava.JsonValue.json(frJava.JsonValue.object());",
        "  setIfValidString(managedUserData, 'givenName', 'givenName');",
        "  setIfValidString(managedUserData, 'sn', 'familyName');",
        "  ",
        "  // For login: Ensure the mail attribute is set in case we have to look up the admin using",
        "  // their email.  This will occur when an existing admin is federating for the first time.",
        "  if (!objAttrs.containsKey('mail')) {",
        "    managedUserData.put('mail', normalizedProfile.get('email').asString());",
        "  }",
        "",
        "  if (!normalizedProfile.get('groups').isNull()) {",
        "    managedUserData.put('groups', normalizedProfile.get('groups').asList());",
        "  }",
        "  ",
        "  // Merge anything we've put into \`managedUserData\` into sharedState.objectAttributes because",
        "  // \`managedUserData\` goes into transient state, which isn't used by our downstream nodes",
        "  var keys = managedUserData.keys().toArray();",
        "  for (var i = 0; i < keys.length; i++) {",
        "    objAttrs.put(keys[i], managedUserData.get(keys[i]));",
        "  }",
        "  sharedState.put(OBJ_ATTR, objAttrs);",
        "",
        "  return managedUserData;",
        "}());",
      ],
    },
    "ab917dad-6fdb-46c2-8c8c-42f094ebeea1": {
      "_id": "ab917dad-6fdb-46c2-8c8c-42f094ebeea1",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Perform IDP re-lookup based on the Organization ID from the initial lookup. Set users' external IDP in shared state for further processing.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "IDP Re-Lookup",
      "script": [
        "/* IDP Re-Lookup",
        " * ",
        " * Perform IDP re-lookup based on the Organization ID from the initial lookup. ",
        " * Set users' external IDP in shared state for further processing.",
        " * ",
        " * This script requires parametrization. Make sure you carefully review the configuration parameters.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * - false",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    logger.message("IDP Re-Lookup: start");",
        "      outcome = "false";",
        "      var referer = parseUrl(requestHeaders.get("referer").get(0));",
        "      var orgId = referer.searchParam.o;",
        "      sharedState.put("username", referer.searchParam.u);",
        "",
        "      /* Begin Configuration */",
        "  ",
        "    // long-lived token, expires: Friday, January 16, 2032 9:45:14 PM GMT-06:00",
        "    var IDM_API_TOKEN = "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJlMWE1YzU5OC04MGUyLTRhZGMtYjM0NS0zMWQwMmUyOThjNGIiLCJjdHMiOiJPQVVUSDJfR1JBTlRfU0VUIiwiYXV0aF9sZXZlbCI6MCwiYXVkaXRUcmFja2luZ0lkIjoiNGYzMDkxYTktZjU0Ni00MDdiLTkzNjMtM2RiZGJiZjYzMDc0LTM1NzcwOSIsInN1Ym5hbWUiOiJlMWE1YzU5OC04MGUyLTRhZGMtYjM0NS0zMWQwMmUyOThjNGIiLCJpc3MiOiJodHRwczovL29wZW5hbS12b2xrZXItZGV2LmZvcmdlYmxvY2tzLmNvbTo0NDMvYW0vb2F1dGgyL2FscGhhIiwidG9rZW5OYW1lIjoiYWNjZXNzX3Rva2VuIiwidG9rZW5fdHlwZSI6IkJlYXJlciIsImF1dGhHcmFudElkIjoiLUIxQlRUM3FqNi04Zkd3a2d6bzgzNzlSRjVJLjA4NkNJdTFyOUNCNlROcEIwV3Q5OFEyNTJYcyIsImF1ZCI6IjY5ZDA1YzExLWU4ZmUtNGFlNS1hN2M5LTIyNTJhNGQ4NWRmNCIsIm5iZiI6MTY0MjU2MzkxNCwiZ3JhbnRfdHlwZSI6InBhc3N3b3JkIiwic2NvcGUiOlsiZnI6aWRtOioiXSwiYXV0aF90aW1lIjoxNjQyNTYzOTE0LCJyZWFsbSI6Ii9hbHBoYSIsImV4cCI6MTk1NzkyMzkxNCwiaWF0IjoxNjQyNTYzOTE0LCJleHBpcmVzX2luIjozMTUzNjAwMDAsImp0aSI6Ii1CMUJUVDNxajYtOGZHd2tnem84Mzc5UkY1SS5CSHFZNVp3c0lGNVpMbEtvcGNvUlVGVHNLUjAiLCJtYXlfYWN0Ijp7ImNsaWVudF9pZCI6WyI2OWQwNWMxMS1lOGZlLTRhZTUtYTdjOS0yMjUyYTRkODVkZjQiXX19.f2NmwHVtekH93jO7-jM6mkFRcuvEN3WzcKsH-RAPnlc";",
        "",
        "    // IDM API Configuration",
        "    var IDM_API_URI = referer.origin + "/openidm/managed/alpha_organization/"+ orgId + "?_fields=name,description,idpName,idpType,idpDomains,idpJourney,idpTheme,idpPersist";",
        "",
        "      /* End Configuration */",
        "",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setMethod('GET');",
        "    request.setUri(IDM_API_URI);",
        "    request.getHeaders().add("Content-Type", "application/json; charset=UTF-8");",
        "    request.getHeaders().add("Authorization", "Bearer " + IDM_API_TOKEN);",
        "",
        "    var response = httpClient.send(request).get();",
        "    var result = JSON.parse(response.getEntity().getString());",
        "    logger.message("IDP Re-Lookup: JSON result: " + JSON.stringify(result));",
        "    ",
        "      if (result) {",
        "          outcome = "true";",
        "        var routedIDPs = [result];",
        "        sharedState.put("routedIDPs", routedIDPs);",
        "        logger.message("IDP Re-Lookup: Found IDP");",
        "    }",
        "    logger.message("IDP Re-Lookup: end [outcome={}]", outcome);",
        "",
        "    /*",
        "     * Parse a URL into its components and make them easily accessible by name",
        "     *",
        "     * Use in a Scripte Decision Node Script as follows:",
        "     * var referer = parseUrl(requestHeaders.get("referer").get(0));",
        "     * var origin = referer.origin;",
        "     * ",
        "     * e.g.: https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/",
        "     * {",
        "     *     hash: '#/',",
        "     *     host: 'openam-volker-dev.forgeblocks.com',",
        "     *     hostname: 'openam-volker-dev.forgeblocks.com',",
        "     *     href: 'https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/',",
        "     *     origin: 'https://openam-volker-dev.forgeblocks.com',",
        "     *     pathname: '/am/XUI/',",
        "     *     port: '',",
        "     *     protocol: 'https',",
        "     *     search: '?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim',",
        "     *     username: '',",
        "     *     password: '',",
        "     *     searchParam: {",
        "     *         realm: '/bravo',",
        "     *         authIndexType: 'service',",
        "     *         authIndexValue: 'InitiateOwnerClaim'",
        "     *     }",
        "     * }",
        "     */",
        "    function parseUrl(href) {",
        "        var m = href.match(/^(([^:\\/?#]+):?(?:\\/\\/((?:([^\\/?#:]*):([^\\/?#:]*)@)?([^\\/?#:]*)(?::([^\\/?#:]*))?)))?([^?#]*)(\\?[^#]*)?(#.*)?$/),",
        "        r = {",
        "            hash: m[10] || "",                      // #/",
        "            host: m[3] || "",                       // openam-volker-dev.forgeblocks.com",
        "            hostname: m[6] || "",                   // openam-volker-dev.forgeblocks.com",
        "            href: m[0] || "",                       // https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/",
        "            origin: m[1] || "",                     // https://openam-volker-dev.forgeblocks.com",
        "            pathname: m[8] || (m[1] ? "/" : ""),    // /am/XUI/",
        "            port: m[7] || "",                       // ",
        "            protocol: m[2] || "",                   // https",
        "            search: m[9] || "",                     // ?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim",
        "            username: m[4] || "",                   // ",
        "            password: m[5] || "",                   // ",
        "            searchParam: {}                         // { realm: '/bravo',",
        "                                                    //   authIndexType: 'service',",
        "                                                    //   authIndexValue: 'InitiateOwnerClaim' }",
        "        };",
        "        if (r.protocol.length == 2) {",
        "            r.protocol = "file:///" + r.protocol.toUpperCase();",
        "            r.origin = r.protocol + "//" + r.host;",
        "        }",
        "        if (r.search.length > 2) {",
        "            var query = (r.search.indexOf('?') === 0) ? r.search.substr(1) : r.search;",
        "            var vars = query.split('&');",
        "            for (var i = 0; i < vars.length; i++) {",
        "            var pair = vars[i].split('=');",
        "            r.searchParam[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1]);",
        "            }",
        "        }",
        "        r.href = r.origin + r.pathname + r.search + r.hash;",
        "        return r;",
        "    };",
        "}());",
      ],
    },
    "ac9fc25e-3ad9-4f80-a796-2d9093795439": {
      "_id": "ac9fc25e-3ad9-4f80-a796-2d9093795439",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Check if MFA has already been performed for this journey. This allows journeys and inner journeys not to perform MFA multiple times.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "MFA Status",
      "script": [
        "/* MFA Status",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Check if MFA has already been performed for this journey. ",
        " * This allows journeys and inner journeys not to perform MFA multiple times.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * - false",
        " */",
        "outcome = "false";",
        "if (sharedState.get("mfaPerformed")=="true") {",
        "      outcome = "true";",
        "}",
      ],
    },
    "aef262d0-7a42-4a34-9826-e7dbc2ea6eb9": {
      "_id": "aef262d0-7a42-4a34-9826-e7dbc2ea6eb9",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Route users to their organization's IDP of type saml, oidc, local, or custom and apply the organization's theme, if specified",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "IDP Router",
      "script": [
        "/* IDP Router",
        " * ",
        " * Route users to their organization's IDP of type saml, oidc, local, ",
        " * or custom and apply the organization's theme, if specified.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - saml",
        " * - oidc",
        " * - local",
        " * - custom",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "      logger.message("IDP Router: Start");",
        "    outcome = "local";",
        "      var referer = parseUrl(requestHeaders.get("referer").get(0));",
        "      var routedIDP = sharedState.get("routedIDPs").get(0);",
        "      if (routedIDP) {",
        "        outcome = routedIDP.get("idpType");",
        "        logger.message("IDP Router: Routed IDP: " + routedIDP);",
        "          sharedState.put("selectedIdp", routedIDP.get("idpName"));",
        "        var nodeConfig = {};",
        "          // load samlConfig",
        "          if (routedIDP.get("samlConfig")) {",
        "              nodeConfig = JSON.parse(routedIDP.get("samlConfig"));",
        "        }",
        "          // route to a custom journey",
        "        if (routedIDP.get("idpJourney")) {",
        "            logger.message("IDP Router: Route to custom IDP {}, journey: {}", routedIDP.get("idpName"), routedIDP.get("idpJourney"));",
        "              nodeConfig.tree = routedIDP.get("idpJourney");",
        "              outcome = "custom";",
        "        }",
        "          sharedState.put("nodeConfig", nodeConfig);",
        "          // only send callback if the org/idp requires a custom theme",
        "        if (routedIDP.get("idpTheme") && callbacks.isEmpty()) {",
        "            var stage = "themeId="+routedIDP.get("idpTheme");",
        "            var fr = JavaImporter(",
        "                org.forgerock.openam.auth.node.api.Action,",
        "                org.forgerock.openam.authentication.callbacks.PollingWaitCallback",
        "            )",
        "              action = fr.Action.send(",
        "                  new fr.PollingWaitCallback("0", "Please wait ...")",
        "            ).withStage(stage).build();",
        "          }",
        "    }",
        "      logger.message("IDP Router: Done [outcome={}]", outcome);",
        "",
        "    /*",
        "     * Parse a URL into its components and make them easily accessible by name",
        "     *",
        "     * Use in a Scripte Decision Node Script as follows:",
        "     * var referer = parseUrl(requestHeaders.get("referer").get(0));",
        "     * var origin = referer.origin;",
        "     * ",
        "     * e.g.: https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/",
        "     * {",
        "     *     hash: '#/',",
        "     *     host: 'openam-volker-dev.forgeblocks.com',",
        "     *     hostname: 'openam-volker-dev.forgeblocks.com',",
        "     *     href: 'https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/',",
        "     *     origin: 'https://openam-volker-dev.forgeblocks.com',",
        "     *     pathname: '/am/XUI/',",
        "     *     port: '',",
        "     *     protocol: 'https',",
        "     *     search: '?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim',",
        "     *     username: '',",
        "     *     password: '',",
        "     *     searchParam: {",
        "     *         realm: '/bravo',",
        "     *         authIndexType: 'service',",
        "     *         authIndexValue: 'InitiateOwnerClaim'",
        "     *     }",
        "     * }",
        "     */",
        "    function parseUrl(href) {",
        "        var m = href.match(/^(([^:\\/?#]+):?(?:\\/\\/((?:([^\\/?#:]*):([^\\/?#:]*)@)?([^\\/?#:]*)(?::([^\\/?#:]*))?)))?([^?#]*)(\\?[^#]*)?(#.*)?$/),",
        "        r = {",
        "            hash: m[10] || "",                      // #/",
        "            host: m[3] || "",                       // openam-volker-dev.forgeblocks.com",
        "            hostname: m[6] || "",                   // openam-volker-dev.forgeblocks.com",
        "            href: m[0] || "",                       // https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/",
        "            origin: m[1] || "",                     // https://openam-volker-dev.forgeblocks.com",
        "            pathname: m[8] || (m[1] ? "/" : ""),    // /am/XUI/",
        "            port: m[7] || "",                       // ",
        "            protocol: m[2] || "",                   // https",
        "            search: m[9] || "",                     // ?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim",
        "            username: m[4] || "",                   // ",
        "            password: m[5] || "",                   // ",
        "            searchParam: {}                         // { realm: '/bravo',",
        "                                                    //   authIndexType: 'service',",
        "                                                    //   authIndexValue: 'InitiateOwnerClaim' }",
        "        };",
        "        if (r.protocol.length == 2) {",
        "            r.protocol = "file:///" + r.protocol.toUpperCase();",
        "            r.origin = r.protocol + "//" + r.host;",
        "        }",
        "        if (r.search.length > 2) {",
        "            var query = (r.search.indexOf('?') === 0) ? r.search.substr(1) : r.search;",
        "            var vars = query.split('&');",
        "            for (var i = 0; i < vars.length; i++) {",
        "            var pair = vars[i].split('=');",
        "            r.searchParam[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1]);",
        "            }",
        "        }",
        "        r.href = r.origin + r.pathname + r.search + r.hash;",
        "        return r;",
        "    };",
        "}());",
      ],
    },
    "b3824c66-2dff-4613-9e54-4a7577fdb765": {
      "_id": "b3824c66-2dff-4613-9e54-4a7577fdb765",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Places a timestamp in the frIndexedMultivalued1 attribute",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "TimeStamp_Login",
      "script": [
        "/*",
        "  - Data made available by nodes that have already executed are available in the sharedState variable.",
        "  - The script should set outcome to either "true" or "false".",
        " */",
        "",
        "",
        "//var timestamps = sharedState.get("objectAttributes").get("frIndexedMultivalued1");",
        "",
        "",
        "var lastLogin = new Date();",
        "/*",
        "var datetime = ""+ currentdate.getDate() + "/"",
        "                + (currentdate.getMonth()+1)  + "/" ",
        "                + currentdate.getFullYear() + " @ "  ",
        "                + currentdate.getHours() + ":"  ",
        "                + currentdate.getMinutes() + ":" ",
        "                + currentdate.getSeconds();",
        "*/",
        "",
        "var objectAttributes = sharedState.get("objectAttributes");",
        "",
        "",
        "sharedState.put("last Login",lastLogin.toString());",
        "",
        "",
        "",
        "",
        "",
        "objectAttributes.put("frUnindexedString1",lastLogin.toString());",
        "",
        "",
        "sharedState.put("objectAttributes",objectAttributes);",
        "",
        "",
        "outcome = "true";",
      ],
    },
    "b63981d8-cb73-4e47-8749-e58654dcaa31": {
      "_id": "b63981d8-cb73-4e47-8749-e58654dcaa31",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "This script uses phonevalidator.com to determine the type of phone number stored in the user profile.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Phone Validator - Line Type",
      "script": [
        "/* Phone Validator - Line Type",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * This script uses phonevalidator.com to determine the type of phone number stored in the user profile.",
        " * Get your own API Key at https://www.phonevalidator.com",
        " * ",
        " * This script needs to be parametrized. It will not work properly as is. ",
        " * It requires the Identify Existing User node before it is being called.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - CELL PHONE",
        " * - LANDLINE",
        " * - VOIP",
        " * - TOLL-FREE",
        " * - UNKNOWN",
        " * - failed",
        " */",
        "logger.warning("Phone Validator - Line Type: start");",
        "",
        "if (getSharedObjectAttribute("telephoneNumber") || (sharedState.get("_id") && idRepository.getAttribute(sharedState.get("_id"), "telephoneNumber").iterator().hasNext())) {",
        "",
        "    /* BEGIN SCRIPT CONFIGURATION",
        "     *",
        "     * REPLACE WITH YOUR OWN AZURE AD SETTINGS",
        "     *",
        "       * Phone Validator - Line Type API Configuration",
        "       * Get your own API Key at https://www.phonevalidator.com",
        "     */",
        "    var PV_API_KEY = "849d564a-594d-4bde-b691-afe5ddadd547";",
        "    /*",
        "     * END SCRIPT CONFIGURATION",
        "     */",
        "",
        "      var PV_API_TYPE = "basic";",
        "    var PV_API_PHONE = getSharedObjectAttribute("telephoneNumber") || idRepository.getAttribute(sharedState.get("_id"), "telephoneNumber").iterator().next();",
        "    var PV_API_URI = "https://www.phonevalidator.com/api/v2/phonesearch?apikey=".concat(PV_API_KEY).concat("&phone=").concat(PV_API_PHONE).concat("&type=").concat(PV_API_TYPE);    ",
        "",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setMethod('GET');",
        "    request.setUri(PV_API_URI);",
        "",
        "    var response = httpClient.send(request).get();",
        "    var result = JSON.parse(response.getEntity().getString());",
        "",
        "    if (result["StatusCode"]=="200") {",
        "        outcome = result["PhoneBasic"]["LineType"];",
        "    } else {",
        "        outcome = "failed";",
        "    }",
        "    logger.error("Phone Validator - Line Type: StatusCode = ".concat(result["StatusCode"]));",
        "    logger.error("Phone Validator - Line Type: StatusMessage = ".concat(result["StatusMessage"]));",
        "    logger.error("Phone Validator - Line Type: outcome = ".concat(outcome));",
        "} else {",
        "      outcome = "failed";",
        "      logger.error("Phone Validator - Line Type: No user or phone number found! Use 'Identify Existing User node before this script to populate the user's _id in shared state or put a valid cell phone number into sharedState.objectAttributes.telephoneNumber!'");",
        "    logger.error("Phone Validator - Line Type: outcome = ".concat(outcome));",
        "}",
        "",
        "/*",
        " * Read attributes in shared state for use with the Create/Patch Object nodes.",
        " */",
        "function getSharedObjectAttribute(name) {",
        "    var storage = sharedState.get("objectAttributes");",
        "    if (storage) {",
        "          if (storage.get) {",
        "            return sharedState.get("objectAttributes").get(name);",
        "        }",
        "          else {",
        "            return storage.name;",
        "        }",
        "    }",
        "    return null;",
        "}",
      ],
    },
    "b6fce769-cf21-4963-a8dc-7c5370a4d15b": {
      "_id": "b6fce769-cf21-4963-a8dc-7c5370a4d15b",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "shared State Printer",
      "script": [
        "var fr = JavaImporter(",
        "  org.forgerock.openam.auth.node.api,",
        "  javax.security.auth.callback.TextOutputCallback",
        ");",
        "outcome = "true";",
        "with (fr) {",
        "  if (callbacks.isEmpty()) {",
        "    var callback = new TextOutputCallback(TextOutputCallback.INFORMATION, "sharedState: ".concat(sharedState.toString()));",
        "    action = Action.send(callback).build();",
        "  } else {",
        "    action = Action.goTo("true").build();",
        "  }",
        "}",
      ],
    },
    "b703581a-e112-42b9-bc24-6db8bced5a13": {
      "_id": "b703581a-e112-42b9-bc24-6db8bced5a13",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Display sharedState and transientState.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Display States",
      "script": [
        "/* Display States",
        " * ",
        " * Display sharedState and transientState.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    outcome = "true";",
        "",
        "    var anchor = "anchor-".concat(generateNumericToken('xxx'));",
        "    var halign = "left";",
        "    var message = "<h4>Current State Values</h4>".concat(",
        "        "<p><b>Shared State</b>:<br/>").concat(",
        "        sharedState.toString()).concat("</p>").concat(",
        "        "<p><b>Transient State</b>:<br/>").concat(",
        "        transientState.toString()).concat("</p>").concat(",
        "        "<p><b>Request Headers</b>:<br/>").concat(",
        "        requestHeaders.toString()).concat("</p>")",
        "    var script = "Array.prototype.slice.call(\\n".concat(",
        "      "document.getElementsByClassName('callback-component')).forEach(\\n").concat(",
        "      "function (e) {\\n").concat(",
        "      "  var message = e.firstElementChild;\\n").concat(",
        "      "  if (message.firstChild && message.firstChild.nodeName == '#text' && message.firstChild.nodeValue.trim() == '").concat(anchor).concat("') {\\n").concat(",
        "      "    message.className = \\"\\";\\n").concat(",
        "      "    message.style = \\"text-align: left; inline-size: 430px; overflow-wrap: break-word;\\";\\n").concat(",
        "      "    message.align = \\"").concat(halign).concat("\\";\\n").concat(",
        "      "    message.innerHTML = '").concat(message).concat("';\\n").concat(",
        "      "  }\\n").concat(",
        "      "})")",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "        javax.security.auth.callback.TextOutputCallback,",
        "        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        "    )",
        "    if (message.length && callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "            new fr.TextOutputCallback(",
        "                fr.TextOutputCallback.INFORMATION,",
        "                anchor",
        "            ),",
        "            new fr.ScriptTextOutputCallback(script)",
        "        ).build()",
        "    }",
        "    else {",
        "      action = fr.Action.goTo(outcome).build();",
        "    }",
        "",
        "     /*",
        "      * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "      * ",
        "      * Example:",
        "      * 'xxxxx' produces '28535'",
        "      * 'xxx-xxx' produces '432-521'",
        "      */",
        "    function generateNumericToken(format) {",
        "        return format.replace(/[x]/g, function(c) {",
        "            var r = Math.random()*10|0;",
        "            var v = r;",
        "            return v.toString(10);",
        "        });",
        "    }",
        "}());",
      ],
    },
    "b7ce17a1-e41d-42b0-bedc-f88a4d5e1c3a": {
      "_id": "b7ce17a1-e41d-42b0-bedc-f88a4d5e1c3a",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Prepares onboarding check if not amadmin",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_AmadminCheck",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "var fr = new JavaImporter(",
        "  java.util.HashMap",
        ");",
        "",
        "with (fr) {",
        "  try {",
        "    ",
        "    if (sharedState.get('username').toLowerCase() == 'amadmin') {",
        "      outcome = 'True';",
        "    } else {",
        "      outcome = 'False';",
        "    }",
        "    ",
        "  } catch (e) {",
        "",
        "    logger.error('Failed to determine if user is amadmin: {}', e);",
        "    outcome = 'Error';",
        "",
        "  }",
        "}",
      ],
    },
    "b88ce1fe-2480-4fd5-8062-2bd1f4659e2e": {
      "_id": "b88ce1fe-2480-4fd5-8062-2bd1f4659e2e",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_LoadObjectByID",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        " * This is a utility script to simplify access to admin identity properties. It",
        " * requires that \`sharedState._id\` be populated, which can be loaded using an",
        " * Identify Existing User node.",
        " */",
        "",
        "function val(attrs, name) {",
        "  if (attrs.containsKey(name)) {",
        "    return attrs.get(name).iterator().next();",
        "  }",
        "  return '';",
        "}",
        "",
        "(function() {",
        "  var fr = new JavaImporter(",
        "    org.forgerock.openam.auth.nodes,",
        "    org.forgerock.guice.core",
        "  );",
        "",
        "  with (fr) {",
        "    try {",
        "",
        "      outcome = 'False';",
        "",
        "      if (!sharedState.containsKey('_id')) {",
        "        throw 'Required sharedState property _id is missing';",
        "      }      ",
        "      ",
        "      var realm = sharedState.get('realm');",
        "      var uuid = sharedState.get('_id');",
        "      ",
        "      var identityProvider = InjectorHolder.getInstance(IdentityProvider);",
        "      var identity = identityProvider.getIdentity(uuid, realm);",
        "      var attrs = identity.getAttributes();",
        "      ",
        "      sharedState.put('adminObject', {",
        "        givenName: val(attrs, 'givenName'),        ",
        "        sn: val(attrs, 'sn'),",
        "        mail: val(attrs, 'mail'),",
        "        inviteDate: val(attrs, 'fr-idm-inviteDate'),",
        "        onboardDate: val(attrs, 'fr-idm-onboardDate')        ",
        "      });",
        "",
        "      logger.message('Loaded admin object for id: {}', uuid);",
        "",
        "      outcome = 'True';",
        "",
        "    } catch (e) {",
        "      logger.error('Failed to load admin object: {}', e);",
        "    }",
        "  }",
        "}());",
      ],
    },
    "bae1d54a-e97d-4997-aa5d-c027f21af82c": {
      "_id": "bae1d54a-e97d-4997-aa5d-c027f21af82c",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from Facebook",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Facebook Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "return json(object(",
        "        field("id", rawProfile.id),",
        "        field("displayName", rawProfile.name),",
        "        field("givenName", rawProfile.first_name),",
        "        field("familyName", rawProfile.last_name),",
        "        field("photoUrl", rawProfile.picture.data.url),",
        "        field("email", rawProfile.email),",
        "        field("username", rawProfile.email)))",
      ],
    },
    "be6f1f2c-30ee-41fb-9e1e-8da72267fad3": {
      "_id": "be6f1f2c-30ee-41fb-9e1e-8da72267fad3",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Greet verified caller",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Twilio IVR: Greet Verified Caller",
      "script": [
        "/* Twilio IVR: Greet Verified Caller",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * ",
        " * Depending on the amount of data collected through callbacks and how many of the callParams",
        " * you activate below, you will need to change your authentication session from JWT to CTS or",
        " * Memory.",
        " */",
        "outcome = "true";",
        "",
        "/* Begin Configuration",
        " */",
        "",
        "// For ID Cloud use "_id", for classic deployments use "username"",
        "var userid = sharedState.get("_id")",
        "",
        "// Configure how you would like to address the verified caller. The default is the full name.",
        "var name = [idRepository.getAttribute(userid, "givenName").iterator().next(), idRepository.getAttribute(userid, "sn").iterator().next()].join(" ");",
        "",
        "// Build out the full message",
        "var message = ["Hello", name, "! How can I help you today?"].join(" ");",
        "",
        "/* End Configuration",
        " */",
        "",
        "var fr = JavaImporter(",
        "      org.forgerock.openam.auth.node.api,",
        "      javax.security.auth.callback.TextOutputCallback",
        ");",
        "  ",
        "with (fr) {",
        "      if (callbacks.isEmpty()) {",
        "        var output = new TextOutputCallback(TextOutputCallback.INFORMATION, message);",
        "        action = Action.send(output).build();",
        "      } ",
        "      else {",
        "        action = Action.goTo(outcome).build();",
        "      }",
        "}",
      ],
    },
    "c234ba0b-58a1-4cfd-9567-09edde980745": {
      "_id": "c234ba0b-58a1-4cfd-9567-09edde980745",
      "context": "OAUTH2_ACCESS_TOKEN_MODIFICATION",
      "createdBy": "null",
      "creationDate": 1433147666269,
      "default": true,
      "description": "Internal token modification script",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "ForgeRock Internal: OAuth2 Access Token Modification Script",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "// Script is intentionally empty",
        "",
      ],
    },
    "c253a7ac-ebc9-4268-9e62-89f38f98e4ab": {
      "_id": "c253a7ac-ebc9-4268-9e62-89f38f98e4ab",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "CopyIDToObjectAttributes",
      "script": [
        "/*",
        "  - Data made available by nodes that have already executed are available in the sharedState variable.",
        "  - The script should set outcome to either "true" or "false".",
        " */",
        "",
        "sharedState.get("objectAttributes").put("_id", sharedState.get("_id"));",
        "",
        "outcome = "true";",
      ],
    },
    "c827d2b4-3608-4693-868e-bbcf86bd87c7": {
      "_id": "c827d2b4-3608-4693-868e-bbcf86bd87c7",
      "context": "AUTHENTICATION_CLIENT_SIDE",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Default global script for client side Scripted Authentication Module",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Scripted Module - Client Side",
      "script": [
        "/*",
        " * Copyright 2016-2017 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "/* Default Authentication client side script to use as a template for new scripts */",
      ],
    },
    "c9fa3899-c3ce-4833-af83-64d709202600": {
      "_id": "c9fa3899-c3ce-4833-af83-64d709202600",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Verify security PIN",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Twilio IVR: Verify Security PIN",
      "script": [
        "/* Twilio IVR: Verify Security PIN",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * - false",
        " * ",
        " * Depending on the amount of data collected through callbacks and how many of the callParams",
        " * you activate below, you will need to change your authentication session from JWT to CTS or",
        " * Memory.",
        " */",
        "logger.warning("Twilio IVR: Verify Security PIN: start");",
        "outcome = "false";",
        "",
        "/* Begin Configuration",
        " */",
        "",
        "// For ID Cloud use "_id", for classic deployments use "username"",
        "var userid = sharedState.get("_id")",
        "",
        "// Retrieve the identified caller's PIN (in IDM: frUnindexedInteger5, in AM: fr-attr-int5)",
        "var securityPIN = idRepository.getAttribute(userid, "fr-attr-int5").iterator().next();",
        "",
        "// Build out the verification prompt",
        "var prompt = "To verify I have the right account, please enter your 4-digit security PIN.";",
        "",
        "/* End Configuration",
        " */",
        "",
        "var fr = JavaImporter(",
        "      org.forgerock.openam.auth.node.api,",
        "      javax.security.auth.callback.TextInputCallback",
        ");",
        "  ",
        "with (fr) {",
        "      if (callbacks.isEmpty()) {",
        "        var input = new TextInputCallback(prompt);",
        "        action = Action.send(input).build();",
        "      } ",
        "      else {",
        "          var answer = new String(callbacks.get(0).getText()).replace(/[^0-9]/g, "");",
        "        logger.warning("Twilio IVR: Verify Security PIN: callbacks received");",
        "        if (answer == securityPIN) {",
        "              outcome = "true";",
        "        }",
        "        logger.warning("Twilio IVR: Verify Security PIN: finish [outcome=".concat(outcome).concat("]"));",
        "        action = Action.goTo(outcome).build();",
        "      }",
        "}",
      ],
    },
    "cdea92a1-d2bf-4364-a525-fde8b7a95792": {
      "_id": "cdea92a1-d2bf-4364-a525-fde8b7a95792",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Get Lockout Status",
      "script": [
        "outcome = "true";",
        "",
        "var username = sharedState.get("_id")",
        "var lockoutDataAttr = "sunAMAuthInvalidAttemptsData"",
        "var accountStatusAttr = "inetUserStatus"",
        "",
        "var lockoutData = idRepository.getAttribute(username, lockoutDataAttr)",
        "var accountStatus = idRepository.getAttribute(username, accountStatusAttr)",
        "",
        "transientState.put("lockoutData", lockoutData)",
        "transientState.put("accountStatus", accountStatus)",
        "",
        "logger.error(lockoutData.toString())",
      ],
    },
    "ce6fbbcf-5d9a-471b-bcc1-448758a6374a": {
      "_id": "ce6fbbcf-5d9a-471b-bcc1-448758a6374a",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Validate OTP in profile attribute",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "MobileOTP: Validate OTP In Profile Attribute",
      "script": [
        "/*",
        " * Validate OTP in user profile attribute against OTP in shared state",
        " */",
        "outcome = "false";",
        "var OTP_LENGTH = 8;",
        "",
        "if (sharedState.get("mobileOTP")) {",
        "      var profileOTP = idRepository.getAttribute(username, "fr-attr-int5");",
        "}",
        "",
        "function checkPassword(profileOTP, password) {",
        "    var oneTimePassword = profileOTP.substring(0,7);",
        "    var passwordTimestamp = Number(profileOTP.substring(8));",
        "",
        "    var passwordMatches = oneTimePassword",
        "        && (oneTimePassword == password)",
        "        && passwordTimestamp != null",
        "        && isWithinExpiryTime(passwordTimestamp);",
        "    return passwordMatches;",
        "}",
        "",
        "function isWithinExpiryTime(passwordTimestamp) {",
        "        Instant previous = Instant.ofEpochSecond(passwordTimestamp);",
        "        Duration passwordExpiry = Duration.ofMinutes(config.passwordExpiryTime());",
        "        Instant now = Time.getClock().instant();",
        "        logger.debug("previous {} \\n passwordExpiry {} \\n now {}", previous, passwordExpiry, now);",
        "        boolean withinExpiryTime = Duration.between(previous.plus(passwordExpiry), now).isNegative();",
        "        logger.debug("withinExpiryTime {}", withinExpiryTime);",
        "        return withinExpiryTime;",
        "}",
        "",
        "/*",
        "    private Action checkPassword(TreeContext context, String password) {",
        "        JsonValue oneTimePassword = context.getState(ONE_TIME_PASSWORD);",
        "        JsonValue passwordTimestamp = context.getState(ONE_TIME_PASSWORD_TIMESTAMP);",
        "",
        "        boolean passwordMatches = oneTimePassword != null && oneTimePassword.isString()",
        "                && oneTimePassword.asString().equals(password)",
        "                && passwordTimestamp != null && passwordTimestamp.isNumber()",
        "                && isWithinExpiryTime(passwordTimestamp.asLong());",
        "        logger.debug("passwordMatches {}", passwordMatches);",
        "        return goTo(passwordMatches).build();",
        "    }",
        "",
        "    private boolean isWithinExpiryTime(long passwordTimestamp) {",
        "        Instant previous = Instant.ofEpochSecond(passwordTimestamp);",
        "        Duration passwordExpiry = Duration.ofMinutes(config.passwordExpiryTime());",
        "        Instant now = Time.getClock().instant();",
        "        logger.debug("previous {} \\n passwordExpiry {} \\n now {}", previous, passwordExpiry, now);",
        "        boolean withinExpiryTime = Duration.between(previous.plus(passwordExpiry), now).isNegative();",
        "        logger.debug("withinExpiryTime {}", withinExpiryTime);",
        "        return withinExpiryTime;",
        "    }",
        "    */",
      ],
    },
    "cf3515f0-8278-4ee3-a530-1bad7424c416": {
      "_id": "cf3515f0-8278-4ee3-a530-1bad7424c416",
      "context": "OIDC_CLAIMS",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Default alpha realm script for OIDC claims",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Alpha OIDC Claims Script",
      "script": [
        "/*",
        " * Copyright 2014-2021 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        " * This script computes claim values returned in ID tokens and/or at the UserInfo Endpoint.",
        " * The claim values are computed for:",
        " * the claims derived from the requested scopes,",
        " * the claims provided by the authorization server,",
        " * and the claims requested by the client via the claims parameter.",
        " *",
        " * In the CONFIGURATION AND CUSTOMIZATION section, you can",
        " * define the scope-to-claims mapping, and",
        " * assign to each claim a resolver function that will compute the claim value.",
        " *",
        " * Defined variables (class references are provided below):",
        " * scopes - Set<String> (6).",
        " *          Always present, the requested scopes.",
        " * claims - Map<String, Object> (5).",
        " *          Always present, default server provided claims.",
        " * claimObjects - List<Claim> (7, 2).",
        " *                Always present, the default server provided claims.",
        " * requestedClaims - Map<String, Set<String>> (5).",
        " *                   Always present, not empty if the request contains the claims parameter and the server has enabled",
        " *                   claims_parameter_supported. A map of the requested claims to possible values, otherwise empty;",
        " *                   requested claims with no requested values will have a key but no value in the map. A key with",
        " *                   a single value in its Set (6) indicates that this is the only value that should be returned.",
        " * requestedTypedClaims - List<Claim> (7, 2).",
        " *                        Always present, the requested claims.",
        " *                        Requested claims with no requested values will have a claim with no values.",
        " *                        A claim with a single value indicates this is the only value that should be returned.",
        " * claimsLocales - List<String> (7).",
        " *                 The values from the 'claims_locales' parameter.",
        " *                 See https://openid.net/specs/openid-connect-core-1_0.html#ClaimsLanguagesAndScripts for the OIDC specification details.",
        " * requestProperties - Unmodifiable Map (5).",
        " *                     Always present, contains a map of request properties:",
        " *                     requestUri - The request URI.",
        " *                     realm - The realm that the request relates to.",
        " *                     requestParams - A map of the request params and/or posted data.",
        " *                                     Each value is a list of one or more properties.",
        " *                                     Please note that these should be handled in accordance with OWASP best practices:",
        " *                                     https://owasp.org/www-community/vulnerabilities/Unsafe_use_of_Reflection.",
        " * clientProperties - Unmodifiable Map (5).",
        " *                    Present if the client specified in the request was identified, contains a map of client properties:",
        " *                    clientId - The client's URI for the request locale.",
        " *                    allowedGrantTypes - List of the allowed grant types (org.forgerock.oauth2.core.GrantType) for the client.",
        " *                    allowedResponseTypes - List of the allowed response types for the client.",
        " *                    allowedScopes - List of the allowed scopes for the client.",
        " *                    customProperties - A map of the custom properties of the client.",
        " *                                       Lists or maps will be included as sub-maps; for example:",
        " *                                       customMap[Key1]=Value1 will be returned as customMap -> Key1 -> Value1.",
        " *                                       To add custom properties to a client, update the Custom Properties field",
        " *                                       in AM Console > Realm Name > Applications > OAuth 2.0 > Clients > Client ID > Advanced.",
        " * identity - AMIdentity (3).",
        " *            Always present, the identity of the resource owner.",
        " * session - SSOToken (4).",
        " *           Present if the request contains the session cookie, the user's session object.",
        " * scriptName - String (primitive).",
        " *              Always present, the display name of the script.",
        " * logger - Always present, the "OAuth2Provider" debug logger instance:",
        " *          https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.",
        " *          Corresponding files will be prefixed with: scripts.OIDC_CLAIMS.",
        " * httpClient - HTTP Client (8).",
        " *              Always present, the HTTP Client instance:",
        " *              https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-http-client.html#scripting-api-global-http-client.",
        " *              In order to use the client, you may need to add",
        " *              org.forgerock.http.Client,",
        " *              org.forgerock.http.protocol.*,",
        " *              and org.forgerock.util.promise.PromiseImpl",
        " *              to the allowed Java classes in the scripting engine configuration, as described in:",
        " *              https://backstage.forgerock.com/docs/am/7/scripting-guide/script-engine-security.html",
        " *",
        " * Return - a new UserInfoClaims(Map<String, Object> values, Map<String, List<String>> compositeScopes) (1) object.",
        " *          The result of the last statement in the script is returned to the server.",
        " *          Currently, the Immediately Invoked Function Expression (also known as Self-Executing Anonymous Function)",
        " *          is the last (and only) statement in this script, and its return value will become the script result.",
        " *          Do not use "return variable" statement outside of a function definition.",
        " *          See RESULTS section for additional details.",
        " *",
        " * Class reference:",
        " * (1) UserInfoClaims - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html.",
        " * (2) Claim - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html).",
        " *         An instance of org.forgerock.openidconnect.Claim has methods to access",
        " *         the claim name, requested values, locale, and whether the claim is essential.",
        " * (3) AMIdentity - https://backstage.forgerock.com/docs/am/7/apidocs/com/sun/identity/idm/AMIdentity.html.",
        " * (4) SSOToken - https://backstage.forgerock.com/docs/am/7/apidocs/com/iplanet/sso/SSOToken.html.",
        " * (5) Map - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashMap.html,",
        " *           or https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/LinkedHashMap.html.",
        " * (6) Set - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashSet.html.",
        " * (7) List - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/ArrayList.html.",
        " * (8) Client - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/http/Client.html.",
        "*/",
        "",
        "(function () {",
        "    // SETUP",
        "",
        "    /**",
        "     * Claim processing utilities.",
        "     * An object that contains reusable functions for processing claims.",
        "     * @see CLAIM PROCESSING UTILITIES section for details.",
        "     */",
        "    var utils = getUtils();",
        "",
        "    // CONFIGURATION AND CUSTOMIZATION",
        "",
        "    /**",
        "     * OAuth 2.0 scope values (scopes) can be used by the Client to request OIDC claims.",
        "     *",
        "     * Call this configuration method, and pass in as the first argument",
        "     * an object that maps a scope value to an array of claim names",
        "     * to specify which claims need to be processed and returned for the requested scopes.",
        "     * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#ScopeClaims}",
        "     * for the scope values that could be used to request claims as defined in the OIDC specification.",
        "     *",
        "     * Below, find a default configuration that is expected to work in the current environment.",
        "     *",
        "     * CUSTOMIZATION",
        "     * You can choose the claim names returned for a scope.",
        "     */",
        "    utils.setScopeClaimsMap({",
        "        profile: [",
        "            'name',",
        "            'family_name',",
        "            'given_name',",
        "            'zoneinfo',",
        "            'locale'",
        "        ],",
        "        email: ['email'],",
        "        address: ['address'],",
        "        phone: ['phone_number']",
        "    });",
        "",
        "    /**",
        "     * In this script, each claim",
        "     * derived from the requested scopes,",
        "     * provided by the authorization server, and",
        "     * requested by the client via the claims parameter",
        "     * will be processed by a function associated with the claim name.",
        "     *",
        "     * Call this configuration method, and pass in as the first argument",
        "     * an object that maps a claim name to a resolver function,",
        "     * which will be automatically executed for each claim processed by the script.",
        "     *",
        "     * The claim resolver function will receive the requested claim information",
        "     * in an instance of org.forgerock.openidconnect.Claim as the first argument.",
        "     * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html}",
        "     * for details on the Claim class.",
        "     *",
        "     * If the claim resolver function returns a value,",
        "     * other than undefined or null,",
        "     * the claim will be included in the script's results.",
        "     *",
        "     * The Claim instance provides methods to check",
        "     * what the name of the claim is,",
        "     * which values the claim request contains,",
        "     * whether the claim is essential, and",
        "     * which locale the claim is associated with.",
        "     * The resolver function can consider this information when computing and returning the claim value.",
        "     *",
        "     * Below, find a default configuration that is expected to work in the current environment.",
        "     * A reusable function, utils.getUserProfileClaimResolver(String attribute-name),",
        "     * is called to return a claim resolver function based on a user profile attribute.",
        "     * @see CLAIM RESOLVERS section for the implementation details and examples.",
        "     * For the address claim, an example of a claim resolver that uses another claim resolver is provided.",
        "     *",
        "     * CUSTOMIZATION",
        "     * You can reuse the predefined utils methods with your custom arguments.",
        "     * You can also specify a custom resolver function for a claim name,",
        "     * that will compute and return the claim value—as shown in the commented out example below.",
        "     */",
        "    utils.setClaimResolvers({",
        "        /*",
        "        // An example of a simple claim resolver function that is defined for a claim",
        "        // directly in the configuration object:",
        "        custom-claim-name: function (requestedClaim) {",
        "            // In this case, initially, the claim value comes straight from a user profile attribute value:",
        "            var claimValue = identity.getAttribute('custom-attribute-name').toArray()[0]",
        "",
        "            // Optionally, provide additional logic for processing (filtering, formatting, etc.) the claim value.",
        "            // You can use:",
        "            // requestedClaim.getName()",
        "            // requestedClaim.getValues()",
        "            // requestedClaim.getLocale()",
        "            // requestedClaim.isEssential()",
        "",
        "            return claimValue",
        "        },",
        "        */",
        "        /**",
        "         * The use of utils.getUserProfileClaimResolver shows how",
        "         * an argument passed to a function that returns a claim resolver",
        "         * becomes available to the resolver function (via its lexical context).",
        "         */",
        "        name: utils.getUserProfileClaimResolver('cn'),",
        "        family_name: utils.getUserProfileClaimResolver('sn'),",
        "        given_name: utils.getUserProfileClaimResolver('givenname'),",
        "        zoneinfo: utils.getUserProfileClaimResolver('preferredtimezone'),",
        "        locale: utils.getUserProfileClaimResolver('preferredlocale'),",
        "        email: utils.getUserProfileClaimResolver('mail'),",
        "        address: utils.getAddressClaimResolver(",
        "            /**",
        "             * The passed in user profile claim resolver function",
        "             * can be used by the address claim resolver function",
        "             * to obtain the claim value to be formatted as per the OIDC specification:",
        "             * @see https://openid.net/specs/openid-connect-core-1_0.html#AddressClaim.",
        "             */",
        "            utils.getUserProfileClaimResolver('postaladdress')",
        "        ),",
        "        phone_number: utils.getUserProfileClaimResolver('telephonenumber')",
        "    });",
        "",
        "    // CLAIM PROCESSING UTILITIES",
        "",
        "    /**",
        "     * @returns {object} An object that contains reusable claim processing utilities.",
        "     * @see PUBLIC METHODS section and the return statement for the list of exported functions.",
        "     */",
        "    function getUtils () {",
        "        // IMPORT JAVA",
        "",
        "        /**",
        "         * Provides Java scripting functionality.",
        "         * @see {@link https://developer.mozilla.org/en-US/docs/Mozilla/Projects/Rhino/Scripting_Java#javaimporter_constructor}.",
        "         */",
        "        var frJava = JavaImporter(",
        "            org.forgerock.oauth2.core.exceptions.InvalidRequestException,",
        "            org.forgerock.oauth2.core.UserInfoClaims,",
        "            org.forgerock.openidconnect.Claim,",
        "",
        "            java.util.LinkedHashMap,",
        "            java.util.ArrayList",
        "        );",
        "",
        "        // SET UP CONFIGURATION",
        "",
        "        /**",
        "         * Placeholder for a configuration option that contains",
        "         * an object that maps the supported scope values (scopes)",
        "         * and the corresponding claim names for each scope value.",
        "         */",
        "        var scopeClaimsMap;",
        "",
        "        /**",
        "         * Placeholder for a configuration option that contains",
        "         * an object that maps the supported claim names",
        "         * and the resolver functions returning the claim value.",
        "         */",
        "        var claimResolvers;",
        "",
        "        /**",
        "         * A (public) method that accepts an object that maps the supported scopes and the corresponding claim names,",
        "         * and assigns it to a (private) variable that serves as a configuration option.",
        "         * @param {object} params - An object that maps each supported scope value to an array of claim names,",
        "         * in order to specify which claims need to be processed for the requested scopes.",
        "         * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#ScopeClaims} for details.",
        "         * @param {string[]} [params.profile] - An array of claim names to be returned if the profile scope is requested.",
        "         * @param {string[]} [params.email] - An array of claim names to be returned if the email scope is requested.",
        "         * @param {string[]} [params.address] - An array of claim names to be returned if the address scope is requested.",
        "         * @param {string[]} [params.phone] - An array of claim names to be returned if the phone scope is requested.",
        "         * @returns {undefined}",
        "         */",
        "        function setScopeClaimsMap(params) {",
        "            scopeClaimsMap = params;",
        "        }",
        "",
        "        /**",
        "         * A (public) method that accepts an object that maps the supported claim names",
        "         * and the resolver functions returning the claim value,",
        "         * and assigns it to a (private) variable that serves as a configuration option.",
        "         * @param {object} params - An object that maps",
        "         * each supported claim name to a function that computes and returns the claim value.",
        "         */",
        "        function setClaimResolvers(params) {",
        "            claimResolvers = params;",
        "        }",
        "",
        "        // CLAIM RESOLVERS",
        "",
        "        /**",
        "         * Claim resolvers are functions that return a claim value.",
        "         * @param {*}",
        "         * @returns {*}",
        "         */",
        "",
        "        /**",
        "         * Defines a claim resolver based on a user profile attribute.",
        "         * @param {string} attributeName - Name of the user profile attribute.",
        "         * @returns {function} A function that will determine the claim value",
        "         * based on the user profile attribute and the (requested) claim properties.",
        "         */",
        "        function getUserProfileClaimResolver (attributeName) {",
        "            /**",
        "             * Resolves a claim with a user profile attribute value.",
        "             * Returns undefined if the identity attribute is not populated,",
        "             * OR if the claim has requested values that do not contain the identity attribute value.",
        "             * ATTENTION: the aforementioned comparison is case-sensitive.",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {string|HashSet|undefined}",
        "             */",
        "            function resolveClaim(claim) {",
        "                var userProfileValue;",
        "",
        "                if (identity) {",
        "                    userProfileValue = getClaimValueFromSet(claim, identity.getAttribute(attributeName));",
        "",
        "                    if (userProfileValue && !userProfileValue.isEmpty()) {",
        "                        if (!claim.getValues() || claim.getValues().isEmpty() || claim.getValues().contains(userProfileValue)) {",
        "                            return userProfileValue;",
        "                        }",
        "                    }",
        "                }",
        "            }",
        "",
        "            return resolveClaim;",
        "        }",
        "",
        "        /**",
        "         * Returns an address claim resolver based on a claim value obtained with another claim resolver.",
        "         * @param {function} resolveClaim - A function that returns a claim value.",
        "         * @returns {function} A function that will accept a claim as an argument,",
        "         * run the claim resolver function for the claim and obtain the claim value,",
        "         * and apply additional formatting to the value before returning it.",
        "         */",
        "        function getAddressClaimResolver (resolveClaim) {",
        "            /**",
        "             * Creates an address claim object from a value returned by a claim resolver,",
        "             * and returns the address claim object as the claim value.",
        "             * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#AddressClaim}.",
        "             * The claim value is obtained with a claim resolving function available from the closure.",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {java.util.LinkedHashMap|undefined} The address claim object created from a claim value.",
        "             */",
        "            function resolveAddressClaim(claim) {",
        "                var claimValue = resolveClaim(claim);",
        "                var addressObject;",
        "",
        "                if (isClaimValueValid(claimValue)) {",
        "                    addressObject = new frJava.LinkedHashMap();",
        "",
        "                    addressObject.put('formatted', claimValue);",
        "",
        "                    return addressObject;",
        "                }",
        "            }",
        "",
        "            return resolveAddressClaim;",
        "        }",
        "",
        "        /**",
        "         * Returns an essential claim resolver based on a claim value obtained with another claim resolver.",
        "         * @param {function} resolveClaim - A function that returns a claim value.",
        "         * @returns {function} A function that will accept a claim as an argument,",
        "         * run the claim resolver function for the claim and obtain the claim value,",
        "         * and apply additional logic for essential claims.",
        "         */",
        "        function getEssentialClaimResolver (resolveClaim) {",
        "            /**",
        "             * Returns a claim value or throws an error.",
        "             * The claim value is obtained with a claim resolving function available from the closure.",
        "             * Throws an exception if the claim is essential and no value is returned for the claim.",
        "             *",
        "             * Use of this resolver is optional.",
        "             * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#IndividualClaimsRequests} stating:",
        "             * "Note that even if the Claims are not available because the End-User did not authorize their release or they are not present,",
        "             * the Authorization Server MUST NOT generate an error when Claims are not returned, whether they are Essential or Voluntary,",
        "             * unless otherwise specified in the description of the specific claim."",
        "             *",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {*}",
        "             * @throws {org.forgerock.oauth2.core.exceptions.InvalidRequestException}",
        "             */",
        "            function resolveEssentialClaim(claim) {",
        "                var claimValue = resolveClaim(claim);",
        "",
        "                if (claim.isEssential() && !isClaimValueValid(claimValue)) {",
        "                    throw new frJava.InvalidRequestException('Could not provide value for essential claim: ' + claim.getName());",
        "                }",
        "",
        "                return claimValue;",
        "            }",
        "",
        "            return resolveEssentialClaim;",
        "        }",
        "",
        "        /**",
        "         * Provides default resolution for a claim.",
        "         * Use it if a claim-specific resolver is not defined in the configuration.",
        "         * @param {org.forgerock.openidconnect.Claim} claim",
        "         * An object that provides methods to obtain information/requirements associated with a claim.",
        "         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "         * @returns {*} A single value associated with this claim.",
        "         */",
        "        function resolveAnyClaim (claim) {",
        "            if (claim.getValues().size() === 1) {",
        "                return claim.getValues().toArray()[0];",
        "            }",
        "        }",
        "",
        "        // UTILITIES",
        "",
        "        /**",
        "         * Returns claim value from a set.",
        "         * If the set contains a single value, returns the value.",
        "         * If the set contains multiple values, returns the set.",
        "         * Otherwise, returns undefined.",
        "         *",
        "         * @param {org.forgerock.openidconnect.Claim} claim",
        "         * An object that provides methods to obtain information/requirements associated with a claim.",
        "         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "         * @param {java.util.HashSet} set The set—for example, a user profile attribute value.",
        "         * @returns {string|java.util.HashSet|undefined}",
        "         */",
        "        function getClaimValueFromSet (claim, set) {",
        "            if (set && set.size()) {",
        "                if (set.size() === 1) {",
        "                    return set.toArray()[0];",
        "                } else {",
        "                    return set;",
        "                }",
        "            } else if (logger.warningEnabled()) {",
        "                logger.warning('OIDC Claims script. Got an empty set for claim: ' + claim.getName());",
        "            }",
        "        }",
        "",
        "        function isClaimValueValid (claimValue) {",
        "            if (typeof claimValue === 'undefined' || claimValue === null) {",
        "                return false;",
        "            }",
        "",
        "            return true;",
        "        }",
        "",
        "        // CLAIM PROCESSING",
        "",
        "        /**",
        "         * Constructs and returns an object populated with the computed claim values",
        "         * and the requested scopes mapped to the claim names.",
        "         * @returns {org.forgerock.oauth2.core.UserInfoClaims} The object to be returned to the authorization server.",
        "         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html}.",
        "         * @see RESULTS section for the use of this function.",
        "         */",
        "        function getUserInfoClaims () {",
        "            return new frJava.UserInfoClaims(getComputedClaims(), getCompositeScopes());",
        "        }",
        "",
        "        /**",
        "         * Creates a map of (requested) claim names populated with the computed claim values.",
        "         * @returns {java.util.LinkedHashMap}",
        "         * A map of the requested claim names and the corresponding claim values.",
        "         */",
        "        function getComputedClaims () {",
        "            /**",
        "             * Creates a complete list of claim objects from:",
        "             * the claims derived from the scopes,",
        "             * the claims provided by the authorization server,",
        "             * and the claims requested by the client.",
        "             * @returns {java.util.ArrayList}",
        "             * Returns a complete list of org.forgerock.openidconnect.Claim objects available to the script.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for the claim object details.",
        "             */",
        "            function getClaims() {",
        "                /**",
        "                 * Returns a list of claim objects for the requested scopes.",
        "                 * Uses the scopeClaimsMap configuration option to derive the claim names;",
        "                 * no other properties of a claim derived from a scope are populated.",
        "                 * @returns {java.util.ArrayList}",
        "                 * A list of org.forgerock.openidconnect.Claim objects derived from the requested scopes.",
        "                 * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for the claim object details.",
        "                 */",
        "                function convertScopeToClaims() {",
        "                    var claims = new frJava.ArrayList();",
        "",
        "                    scopes.toArray().forEach(function (scope) {",
        "                        if (String(scope) !== 'openid' && scopeClaimsMap[scope]) {",
        "                            scopeClaimsMap[scope].forEach(function (claimName) {",
        "                                claims.add(new frJava.Claim(claimName));",
        "                            });",
        "                        }",
        "                    });",
        "",
        "                    return claims;",
        "                }",
        "",
        "                var claims = new frJava.ArrayList();",
        "",
        "                claims.addAll(convertScopeToClaims());",
        "                claims.addAll(claimObjects);",
        "                claims.addAll(requestedTypedClaims);",
        "",
        "                return claims;",
        "            }",
        "",
        "            /**",
        "             * Computes and returns a claim value.",
        "             * To obtain the claim value, uses the resolver function specified for the claim in the claimResolvers configuration object.",
        "             * @see claimResolvers",
        "             * If no resolver function is found, uses the default claim resolver function.",
        "             *",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {*} Claim value.",
        "             * @throws {org.forgerock.oauth2.core.exceptions.InvalidRequestException}",
        "             * Rethrows this exception if a claim resolver throws it.",
        "             * You can throw org.forgerock.oauth2.core.exceptions.InvalidRequestException from your custom claim resolver",
        "             * if you want to terminate the claim processing.",
        "             */",
        "            function computeClaim(claim) {",
        "                var resolveClaim;",
        "                var message;",
        "",
        "                try {",
        "                    resolveClaim = claimResolvers[claim.getName()] || resolveAnyClaim;",
        "",
        "                    return resolveClaim(claim);",
        "                } catch (e) {",
        "                    message = 'OIDC Claims script exception. Unable to resolve OIDC Claim. ' + e;",
        "",
        "                    if (String(e).indexOf('org.forgerock.oauth2.core.exceptions.InvalidRequestException') !== -1) {",
        "                        throw e;",
        "                    }",
        "",
        "                    if (logger.warningEnabled()) {",
        "                        logger.warning(message);",
        "                    }",
        "                }",
        "            }",
        "",
        "            var computedClaims = new frJava.LinkedHashMap();",
        "",
        "            getClaims().toArray().forEach(function (claim) {",
        "                var claimValue = computeClaim(claim);",
        "",
        "                if (isClaimValueValid(claimValue)) {",
        "                    computedClaims.put(claim.getName(), claimValue);",
        "                } else {",
        "                    /**",
        "                     * If a claim has been processed, but appears in the list again,",
        "                     * and its value cannot be computed under the new conditions,",
        "                     * the claim is removed from the final result.",
        "                     *",
        "                     * For example, a claim could be mapped to a scope and found in the user profile,",
        "                     * but also requested by the client with required values that don't match the computed one.",
        "                     * @see {link https://openid.net/specs/openid-connect-core-1_0.html#IndividualClaimsRequests}.",
        "                     * for the relevant OIDC specification details.",
        "                     */",
        "                    computedClaims.remove(claim.getName());",
        "                }",
        "            });",
        "",
        "            return computedClaims;",
        "        }",
        "",
        "        /**",
        "         * Creates a map of requested scopes and the corresponding claim names.",
        "         * @returns {java.util.LinkedHashMap}",
        "         */",
        "        function getCompositeScopes () {",
        "            var compositeScopes = new frJava.LinkedHashMap();",
        "",
        "            scopes.toArray().forEach(function (scope) {",
        "                var scopeClaims = new frJava.ArrayList();",
        "",
        "                if (scopeClaimsMap[scope]) {",
        "                    scopeClaimsMap[scope].forEach(function (claimName) {",
        "                        scopeClaims.add(claimName);",
        "                    });",
        "                }",
        "",
        "                if (scopeClaims.size()) {",
        "                    compositeScopes.put(scope, scopeClaims);",
        "                }",
        "            });",
        "",
        "            return compositeScopes;",
        "        }",
        "",
        "        // PUBLIC METHODS",
        "",
        "        return {",
        "            setScopeClaimsMap: setScopeClaimsMap,",
        "            setClaimResolvers: setClaimResolvers,",
        "            getUserProfileClaimResolver: getUserProfileClaimResolver,",
        "            getAddressClaimResolver: getAddressClaimResolver,",
        "            getEssentialClaimResolver: getEssentialClaimResolver,",
        "            getUserInfoClaims: getUserInfoClaims",
        "        };",
        "    }",
        "",
        "    // RESULTS",
        "",
        "    /**",
        "     * This script returns an instance of the org.forgerock.oauth2.core.UserInfoClaims class",
        "     * populated with the computed claim values and",
        "     * the requested scopes mapped to the claim names.",
        "     * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html}.",
        "     *",
        "     * Assigning it to a variable gives you an opportunity",
        "     * to log the content of the returned value during development.",
        "     */",
        "    var userInfoClaims = utils.getUserInfoClaims();",
        "",
        "    /*",
        "    logger.error(scriptName + ' results:')",
        "    logger.error('Values: ' + userInfoClaims.getValues())",
        "    logger.error('Scopes: ' + userInfoClaims.getCompositeScopes())",
        "    */",
        "",
        "    return userInfoClaims;",
        "}());",
      ],
    },
    "cfb208d8-241c-4953-b87b-bf59d1ab3d05": {
      "_id": "cfb208d8-241c-4953-b87b-bf59d1ab3d05",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_EnableEmailClaimCheck",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "nodeState.putShared('checkEmailClaim', true);",
        "",
        "outcome = 'True';",
      ],
    },
    "d22f9a0c-426a-4466-b95e-d0f125b0d5fa": {
      "_id": "d22f9a0c-426a-4466-b95e-d0f125b0d5fa",
      "context": "OAUTH2_ACCESS_TOKEN_MODIFICATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Default global script for OAuth2 Access Token Modification",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "OAuth2 Access Token Modification Script",
      "script": [
        "/*",
        " * Copyright 2019-2021 ForgeRock AS. All Rights Reserved.",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        " * This script lets you modify information associated with an OAuth2 access token",
        " * with methods provided by the AccessToken (1) interface.",
        " * The changes made to OAuth2 access tokens will directly impact the size of the CTS tokens,",
        " * and, similarly, the size of the JWTs if client-based OAuth2 tokens are utilized.",
        " * When adding/updating fields make sure that the token size remains within client/user-agent limits.",
        " *",
        " * Defined variables:",
        " * accessToken - AccessToken (1).",
        " *               The access token to be updated.",
        " *               Mutable object, all changes to the access token will be reflected.",
        " * scopes - Set<String> (6).",
        " *          Always present, the requested scopes.",
        " * requestProperties - Unmodifiable Map (5).",
        " *                     Always present, contains a map of request properties:",
        " *                     requestUri - The request URI.",
        " *                     realm - The realm that the request relates to.",
        " *                     requestParams - A map of the request params and/or posted data.",
        " *                                     Each value is a list of one or more properties.",
        " *                                     Please note that these should be handled in accordance with OWASP best practices:",
        " *                                     https://owasp.org/www-community/vulnerabilities/Unsafe_use_of_Reflection.",
        " * clientProperties - Unmodifiable Map (5).",
        " *                    Present if the client specified in the request was identified, contains a map of client properties:",
        " *                    clientId - The client's URI for the request locale.",
        " *                    allowedGrantTypes - List of the allowed grant types (org.forgerock.oauth2.core.GrantType) for the client.",
        " *                    allowedResponseTypes - List of the allowed response types for the client.",
        " *                    allowedScopes - List of the allowed scopes for the client.",
        " *                    customProperties - A map of the custom properties of the client.",
        " *                                       Lists or maps will be included as sub-maps; for example:",
        " *                                       customMap[Key1]=Value1 will be returned as customMap -> Key1 -> Value1.",
        " *                                       To add custom properties to a client, update the Custom Properties field",
        " *                                       in AM Console > Realm Name > Applications > OAuth 2.0 > Clients > Client ID > Advanced.",
        " * identity - AMIdentity (3).",
        " *            Always present, the identity of the resource owner.",
        " * session - SSOToken (4).",
        " *           Present if the request contains the session cookie, the user's session object.",
        " * scriptName - String (primitive).",
        " *              Always present, the display name of the script.",
        " * logger - Always present, the "OAuth2Provider" debug logger instance:",
        " *          https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.",
        " *          Corresponding log files will be prefixed with: scripts.OAUTH2_ACCESS_TOKEN_MODIFICATION.",
        " * httpClient - HTTP Client (8).",
        " *              Always present, the HTTP Client instance:",
        " *              https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-http-client.html#scripting-api-global-http-client.",
        " *",
        " * Return - no value is expected, changes shall be made to the accessToken parameter directly.",
        " *",
        " * Class reference:",
        " * (1) AccessToken - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/AccessToken.html.",
        " * (3) AMIdentity - https://backstage.forgerock.com/docs/am/7/apidocs/com/sun/identity/idm/AMIdentity.html.",
        " * (4) SSOToken - https://backstage.forgerock.com/docs/am/7/apidocs/com/iplanet/sso/SSOToken.html.",
        " * (5) Map - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashMap.html,",
        " *           or https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/LinkedHashMap.html.",
        " * (6) Set - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashSet.html.",
        " * (8) Client - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/http/Client.html.",
        " */",
        "",
        "(function () {",
        "  // Adds new fields containing the session property values.",
        "  // NOTE: session may not be available for non-interactive authorization grants.",
        "  if (session) {",
        "    try {",
        "      accessToken.setField('ip_address', session.getProperty('Host'));",
        "    } catch (e) {",
        "      logger.error('Unable to retrieve session property value. ' + e);",
        "    }",
        "  }",
        "}());",
        "",
        "/* EXAMPLE",
        "(function () {",
        "    var frJava = JavaImporter(",
        "        org.forgerock.http.protocol.Request,",
        "        org.forgerock.http.protocol.Response",
        "    );",
        "",
        "    // Always includes this field in the token.",
        "    accessToken.setField('key1', 'value1');",
        "",
        "    // Receives and adds to the access token additional values by performing a REST call to an external service.",
        "    // WARNING: Below, you will find a reference to a third-party site, which is provided only as an example.",
        "    var uri = 'https://jsonplaceholder.typicode.com/posts';",
        "",
        "    try {",
        "        var request = new frJava.Request();",
        "",
        "        // You can chain methods that return the request object.",
        "        request.setUri(uri)",
        "            .setMethod('POST')",
        "            .setEntity(JSON.stringify({",
        "                updatedFields: {",
        "                    key2: 'value2',",
        "                    key3: 'value3'",
        "                }",
        "            }));",
        "",
        "        // You can call a method when chaining is not possible.",
        "        request.getHeaders().add('Content-Type', 'application/json; charset=UTF-8');",
        "",
        "        // Sends the request and receives the response.",
        "        var response = httpClient.send(request).getOrThrow();",
        "",
        "        // Checks if the response status is as expected.",
        "        if (response.getStatus() === org.forgerock.http.protocol.Status.CREATED) {",
        "            var result = JSON.parse(response.getEntity().getString());",
        "",
        "            // Set multiple token fields at once.",
        "            accessToken.setFields(result.updatedFields);",
        "        } else {",
        "            logger.error('Unable to obtain access token modifications. Status: ' + response.getStatus() + '. Content: ' + response.getEntity().getString());",
        "        }",
        "    } catch (e) {",
        "        logger.error('The request processing was interrupted. ' + e);",
        "",
        "        // The access token request fails with the HTTP 500 error in this case.",
        "        throw ('Unable to obtain response from: ' + uri);",
        "    }",
        "",
        "    // Adds new fields containing identity attribute values to the access token.",
        "    accessToken.setField('mail', identity.getAttribute('mail'));",
        "    accessToken.setField('phone', identity.getAttribute('telephoneNumber').toArray()[0]);",
        "",
        "    // Adds new fields containing the session property values.",
        "    // NOTE: session may not be available for non-interactive authorization grants.",
        "    if (session) {",
        "        try {",
        "            accessToken.setField('ipAddress', session.getProperty('Host'));",
        "        } catch (e) {",
        "            logger.error('Unable to retrieve session property value. ' + e);",
        "        }",
        "    }",
        "",
        "    // Removes a native field from the token entry, that was set by AM.",
        "    // WARNING: removing native fields from the token may result in loss of functionality.",
        "    // accessToken.removeTokenName()",
        "",
        "    // No return value is expected. Let it be undefined.",
        "}());",
        "*/",
      ],
    },
    "d25a1315-8beb-4a0c-84bf-534214fed087": {
      "_id": "d25a1315-8beb-4a0c-84bf-534214fed087",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Prepare Reset Of OTP Profile Attribute",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "MobileOTP: Prepare Reset Of OTP Profile Attribute",
      "script": [
        "/*",
        " * Reset OTP profile attribute in ObjectAttributes so it can be patched to the user profile.",
        " */",
        "outcome = "true";",
        "",
        "setSharedObjectAttribute("fr-attr-int5", "0");",
        "",
        "/*",
        " * Store attributes in shared state for use with the Create/Patch Object nodes.",
        " */",
        "function setSharedObjectAttribute(name, value) {",
        "      var storage = sharedState.get("objectAttributes");",
        "    if (storage && value) {",
        "          if (storage.put) {",
        "              storage.put(name, value);",
        "        }",
        "          else {",
        "              storage[name] = value;",
        "        }",
        "    }",
        "    else if (value) {",
        "        sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "    }",
        "}",
      ],
    },
    "d2a41d85-d33a-42d9-a7dd-50dfbc9fa7c0": {
      "_id": "d2a41d85-d33a-42d9-a7dd-50dfbc9fa7c0",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Check Applicant",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Onfido-CheckApplicant",
      "script": [
        "logger.error("Onfido-CheckApplicant: Start");",
        "",
        "/*",
        " * !!! Extend your authentication session time so your identity proofing flows don't time out !!!",
        " *",
        " * Authentication > Settings > Trees > Max Duration (Minutes)",
        " *",
        " * Set to 15 minutes.",
        " *",
        " */",
        "",
        "/*",
        " * BEGIN SCRIPT CONFIGURATION",
        " *",
        " * REPLACE WITH YOUR OWN ONFIDO API TOKEN",
        " */",
        "//var ONFIDO_API_TOKEN = "api_live.StUdfxdiCFb.YrzbadxB_R2-qG5lFUc3lWg6JAc3Cnq-"",
        "var ONFIDO_API_TOKEN = "api_live.H5ysRusAomY.nbbkimoWc91cDZAWJZkJt0Tkqdjm1Rjr";",
        "/*",
        " * END SCRIPT CONFIGURATION",
        " */",
        "",
        "var requestBodyJson = {",
        "    "applicant_id": String(sharedState.get("onfidoApplicantID")),",
        "    "report_names": ["document", "facial_similarity_photo"]",
        "}",
        "// var requestBodyJson = {",
        "//     "applicant_id": String(sharedState.get("onfidoApplicantID")),",
        "//     "report_names": ["document"]",
        "// }",
        "",
        "var failure = true",
        "",
        "var fr = JavaImporter(",
        "    org.forgerock.http.protocol.Request",
        ")",
        "",
        "var request = new fr.Request()",
        "request.setUri("https://api.onfido.com/v3/checks")",
        "request.setMethod("POST")",
        "request.getHeaders().add("Content-Type", "application/json; charset=UTF-8")",
        "request.getHeaders().add("Authorization", "Token token=" + ONFIDO_API_TOKEN)",
        "request.getEntity().setString(JSON.stringify(requestBodyJson))",
        "",
        "var response = httpClient.send(request).get()",
        "logger.error("Onfido-CheckApplicant: Initiate checks response: ".concat(response.getEntity().getString()));",
        "",
        "if (response.getStatus().getCode() === 200) {",
        "    var id = JSON.parse(response.getEntity().getString()).id",
        "    failure = !id",
        "    if (!failure) sharedState.put("onfidoAuthToken", id);",
        "} else {",
        "    failure = true",
        "}",
        "",
        "outcome = failure ? "false" : "true";",
        "logger.error("Onfido-CheckApplicant: End (outcome=".concat(outcome).concat(")"));",
      ],
    },
    "d2cf4f18-651a-4a3c-9b04-ee4fc896d0c3": {
      "_id": "d2cf4f18-651a-4a3c-9b04-ee4fc896d0c3",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Social Identity Provider Profile Transformation for ForgeRock OIDC Providers",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "ST_healthcare-idc-social-transformation",
      "script": [
        "/*",
        " * Copyright 2022 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock. Not for production use.",
        " * Modified by Stephen Payne",
        " */",
        "/* Social Identity Provider Profile Transformation script for Healthcare ID Cloud */",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "logger.error("ST_healthcare-idc-social-transformation Healthcare ID Cloud Identity Provider Profile Transformation script: Start");",
        "",
        "logger.error("ST_healthcare-idc-social-transformation Profile Transformation script: Start");",
        "logger.error("ST_healthcare-idc-social-transformationy: givenName " + rawProfile.givenName);",
        "logger.error("ST_healthcare-idc-social-transformation: sn: " +rawProfile.familyName);",
        "logger.error("ST_healthcare-idc-social-transformation: id: " +rawProfile.id);",
        "logger.error("ST_healthcare-idc-social-transformation: mail: " + rawProfile.email);",
        "logger.error("ST_healthcare-idc-social-transformation: cn: " + rawProfile.displayName);",
        "logger.error("ST_healthcare-idc-social-transformation: userName: " + rawProfile.username);",
        "logger.error("ST_healthcare-idc-social-transformation: id: " + rawProfile.id.asString());",
        "//logger.error("ST_healthcare-idc-social-transformation: iplanet-am-user-alias-list: " + selectedIdp + '-' + rawProfile.id.asString() );",
        "//logger.error("ST_healthcare-idc-social-transformation: selectedIdp: " + selectedIdp);",
        "if (rawProfile.fhirUser.isNotNull()) logger.error("ST_healthcare-idc-social-transformation: fhirUser: " + rawProfile.fhirUser);",
        "if (rawProfile.IAL.isNotNull()) logger.error("ST_healthcare-idc-social-transformatio: IAL: " + rawProfile.IAL);",
        "",
        "",
        "",
        "",
        "return json(object(",
        "        field("id", rawProfile.sub),",
        "        field("displayName", rawProfile.name),",
        "        field("givenName", rawProfile.given_name),",
        "        field("familyName", rawProfile.family_name),",
        "        field("email", rawProfile.email),",
        "        field("username", rawProfile.email),",
        "        field("IAL", rawProfile.IAL),  ",
        "        field("telephoneNumber", rawProfile.phone_number),",
        "        field("fhirUser", rawProfile.fhirUser),",
        "        field("userType", rawProfile.userType),",
        "        )",
        ")",
      ],
    },
    "d3405f9c-d338-4dc2-b00d-7aacf77b731d": {
      "_id": "d3405f9c-d338-4dc2-b00d-7aacf77b731d",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Return the generated OTP using a TextOutputCallback",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Return OTP",
      "script": [
        "/* Return OTP",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Return the generated OTP using a TextOutputCallback.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "outcome = "true";",
        "var fr = JavaImporter(",
        "    org.forgerock.openam.auth.node.api.Action,",
        "    javax.security.auth.callback.TextOutputCallback",
        ")",
        "if (callbacks.isEmpty()) {",
        "    action = fr.Action.send(",
        "        new fr.TextOutputCallback(",
        "            fr.TextOutputCallback.INFORMATION,",
        "            nodeState.get("oneTimePassword").asString()",
        "        )",
        "    ).build()",
        "}",
        "else {",
        "  action = fr.Action.goTo(outcome).build();",
        "}",
      ],
    },
    "d6469639-249f-4df1-9e03-335cd3e37b3d": {
      "_id": "d6469639-249f-4df1-9e03-335cd3e37b3d",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Get Email",
      "script": [
        "logger.error("Get Email: start");",
        "outcome = "true";",
        "if (getProfileAttribute("mail")) {",
        "  setSharedObjectAttribute("mail", getProfileAttribute("mail"));",
        "}",
        "logger.error("Get Email: end");",
        "",
        "/*",
        " * Get profile attribute",
        " */",
        "function getProfileAttribute(name) {",
        "    return idRepository.getAttribute(sharedState.get("_id"), name).iterator().next();",
        "}",
        "",
        "/*",
        " * Properly set attributes in shared state for use with the Create/Patch Object nodes.",
        " */",
        "function setSharedObjectAttribute(name, value) {",
        "    if (sharedState.get("objectAttributes")) {",
        "        sharedState.get("objectAttributes").put(name, value);",
        "    }",
        "    else {",
        "        sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":"+value+"}"));",
        "    }",
        "}",
      ],
    },
    "d6f3befb-c73a-437e-b02a-66d9b4c93f8b": {
      "_id": "d6f3befb-c73a-437e-b02a-66d9b4c93f8b",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Extract impersonatee and impersonator from headers and become impersonator.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Impersonate: Extract Actors And Become Impersonator",
      "script": [
        "/* Impersonate: Extract Actors And Become Impersonator",
        " *",
        " * Extract impersonatee and impersonator from headers and become impersonatee.",
        " *",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * - false",
        " */",
        "",
        "(function () {",
        "    logger.warning("Impersonate: Extract Actors: start");",
        "    outcome = "false";",
        "",
        "    /*",
        "     * BEGIN SCRIPT CONFIGURATION",
        "     */",
        "    var IMPERSONATEE_HEADER_NAME = "X-Impersonatee";",
        "    var IMPERSONATOR_HEADER_NAME = "X-Impersonator";",
        "    /*",
        "     * END SCRIPT CONFIGURATION",
        "     */",
        "",
        "    var impersonatee = getHeader(IMPERSONATEE_HEADER_NAME);",
        "    var impersonator = getHeader(IMPERSONATOR_HEADER_NAME);",
        "    if (impersonatee && impersonator) {",
        "        outcome = "true";",
        "        sharedState.put("impersonatee", impersonatee);",
        "        sharedState.put("impersonator", impersonator);",
        "        sharedState.put("username", impersonator);",
        "        setSharedObjectAttribute("userName", impersonator);",
        "    }",
        "",
        "    logger.warning("Impersonate: Extract Actors: finish [outcome=".concat(outcome).concat("]"));",
        "",
        "    /*",
        "     * Returns the value of the requested header",
        "     */",
        "    function getHeader(headerName) {",
        "        if (requestHeaders.get(headerName) && requestHeaders.get(headerName).get(0)) {",
        "            return requestHeaders.get(headerName).get(0).toString();",
        "        }",
        "        return null;",
        "    }",
        "",
        "    /*",
        "     * Store attributes in shared state for use with the Create/Patch Object nodes.",
        "     */",
        "    function setSharedObjectAttribute(name, value) {",
        "         var storage = sharedState.get("objectAttributes");",
        "        if (storage && value) {",
        "            if (storage.put) {",
        "                  storage.put(name, value);",
        "            }",
        "            else {",
        "                storage[name] = value;",
        "            }",
        "        }",
        "        else if (value) {",
        "            sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "        }",
        "    }",
        "}());",
      ],
    },
    "d70df7a8-6390-409d-b821-166272a9a9c8": {
      "_id": "d70df7a8-6390-409d-b821-166272a9a9c8",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Collect all the configuration items required for the Inner Tree Evaluator to function properly.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Collect Inner Tree Evaluator Config",
      "script": [
        "/* Collect Inner Tree Evaluator Config",
        " * ",
        " * Collect all the configuration items required for the Inner Tree Evaluator to function properly.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    outcome = "true";",
        "      var config = {",
        "        "tree": "Login",",
        "    };",
        "      var script = "";",
        "    script += "Array.prototype.slice.call(";",
        "    script += "    document.getElementsByTagName('input')";",
        "    script += ").forEach(";",
        "    script += "    function (input,i) {";",
        "    script += "        console.log('input '+i);"",
        "    script += "        var config = JSON.parse('"+JSON.stringify(config)+"');";",
        "    script += "        var keys = Object.keys(config);";",
        "    script += "        if (input.type === 'text') {";",
        "    script += "            input.setAttribute('value', config[keys[i]]);";",
        "    script += "            input.dispatchEvent(new KeyboardEvent( 'input' , {'key':'Enter'} ));";",
        "    script += "        }";",
        "    script += "    }";",
        "    script += ");";",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "          javax.security.auth.callback.NameCallback,",
        "        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        "    )",
        "    if (callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "            new fr.NameCallback("tree", config.tree),",
        "              new fr.ScriptTextOutputCallback(script)",
        "        ).build();",
        "    }",
        "    else {",
        "          config[callbacks.get(0).getPrompt()] = callbacks.get(0).getName();",
        "          nodeState.putShared("nodeConfig", config);",
        "        action = fr.Action.goTo(outcome).build();",
        "    }",
        "}());",
      ],
    },
    "d82a4ad6-cd8a-437b-af55-7373e50d685b": {
      "_id": "d82a4ad6-cd8a-437b-af55-7373e50d685b",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Collect Replay Password (frUnindexedString2).",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Collect Replay Password (frUnindexedString2)",
      "script": [
        "/* Collect And Encrypt Custom Password",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * ",
        " * See copyright notices, conditions, and disclaimers at the bottom of this script.",
        " * ",
        " * volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    "use strict";var sjcl={cipher:{},hash:{},keyexchange:{},mode:{},misc:{},codec:{},exception:{corrupt:function(message){this.toString=function(){return"CORRUPT: "+this.message};this.message=message},invalid:function(message){this.toString=function(){return"INVALID: "+this.message};this.message=message},bug:function(message){this.toString=function(){return"BUG: "+this.message};this.message=message},notReady:function(message){this.toString=function(){return"NOT READY: "+this.message};this.message=message}}};sjcl.cipher.aes=function(key){if(!this._tables[0][0][0]){this._precompute()}var i,j,tmp,encKey,decKey,sbox=this._tables[0][4],decTable=this._tables[1],keyLen=key.length,rcon=1;if(keyLen!==4&&keyLen!==6&&keyLen!==8){throw new sjcl.exception.invalid("invalid aes key size")}this._key=[encKey=key.slice(0),decKey=[]];for(i=keyLen;i<4*keyLen+28;i++){tmp=encKey[i-1];if(i%keyLen===0||keyLen===8&&i%keyLen===4){tmp=sbox[tmp>>>24]<<24^sbox[tmp>>16&255]<<16^sbox[tmp>>8&255]<<8^sbox[tmp&255];if(i%keyLen===0){tmp=tmp<<8^tmp>>>24^rcon<<24;rcon=rcon<<1^(rcon>>7)*283}}encKey[i]=encKey[i-keyLen]^tmp}for(j=0;i;j++,i--){tmp=encKey[j&3?i:i-4];if(i<=4||j<4){decKey[j]=tmp}else{decKey[j]=decTable[0][sbox[tmp>>>24]]^decTable[1][sbox[tmp>>16&255]]^decTable[2][sbox[tmp>>8&255]]^decTable[3][sbox[tmp&255]]}}};sjcl.cipher.aes.prototype={encrypt:function(data){return this._crypt(data,0)},decrypt:function(data){return this._crypt(data,1)},_tables:[[[],[],[],[],[]],[[],[],[],[],[]]],_precompute:function(){var encTable=this._tables[0],decTable=this._tables[1],sbox=encTable[4],sboxInv=decTable[4],i,x,xInv,d=[],th=[],x2,x4,x8,s,tEnc,tDec;for(i=0;i<256;i++){th[(d[i]=i<<1^(i>>7)*283)^i]=i}for(x=xInv=0;!sbox[x];x^=x2||1,xInv=th[xInv]||1){s=xInv^xInv<<1^xInv<<2^xInv<<3^xInv<<4;s=s>>8^s&255^99;sbox[x]=s;sboxInv[s]=x;x8=d[x4=d[x2=d[x]]];tDec=x8*16843009^x4*65537^x2*257^x*16843008;tEnc=d[s]*257^s*16843008;for(i=0;i<4;i++){encTable[i][x]=tEnc=tEnc<<24^tEnc>>>8;decTable[i][s]=tDec=tDec<<24^tDec>>>8}}for(i=0;i<5;i++){encTable[i]=encTable[i].slice(0);decTable[i]=decTable[i].slice(0)}},_crypt:function(input,dir){if(input.length!==4){throw new sjcl.exception.invalid("invalid aes block size")}var key=this._key[dir],a=input[0]^key[0],b=input[dir?3:1]^key[1],c=input[2]^key[2],d=input[dir?1:3]^key[3],a2,b2,c2,nInnerRounds=key.length/4-2,i,kIndex=4,out=[0,0,0,0],table=this._tables[dir],t0=table[0],t1=table[1],t2=table[2],t3=table[3],sbox=table[4];for(i=0;i<nInnerRounds;i++){a2=t0[a>>>24]^t1[b>>16&255]^t2[c>>8&255]^t3[d&255]^key[kIndex];b2=t0[b>>>24]^t1[c>>16&255]^t2[d>>8&255]^t3[a&255]^key[kIndex+1];c2=t0[c>>>24]^t1[d>>16&255]^t2[a>>8&255]^t3[b&255]^key[kIndex+2];d=t0[d>>>24]^t1[a>>16&255]^t2[b>>8&255]^t3[c&255]^key[kIndex+3];kIndex+=4;a=a2;b=b2;c=c2}for(i=0;i<4;i++){out[dir?3&-i:i]=sbox[a>>>24]<<24^sbox[b>>16&255]<<16^sbox[c>>8&255]<<8^sbox[d&255]^key[kIndex++];a2=a;a=b;b=c;c=d;d=a2}return out}};sjcl.bitArray={bitSlice:function(a,bstart,bend){a=sjcl.bitArray._shiftRight(a.slice(bstart/32),32-(bstart&31)).slice(1);return bend===undefined?a:sjcl.bitArray.clamp(a,bend-bstart)},extract:function(a,bstart,blength){var x,sh=Math.floor(-bstart-blength&31);if((bstart+blength-1^bstart)&-32){x=a[bstart/32|0]<<32-sh^a[bstart/32+1|0]>>>sh}else{x=a[bstart/32|0]>>>sh}return x&(1<<blength)-1},concat:function(a1,a2){if(a1.length===0||a2.length===0){return a1.concat(a2)}var last=a1[a1.length-1],shift=sjcl.bitArray.getPartial(last);if(shift===32){return a1.concat(a2)}else{return sjcl.bitArray._shiftRight(a2,shift,last|0,a1.slice(0,a1.length-1))}},bitLength:function(a){var l=a.length,x;if(l===0){return 0}x=a[l-1];return(l-1)*32+sjcl.bitArray.getPartial(x)},clamp:function(a,len){if(a.length*32<len){return a}a=a.slice(0,Math.ceil(len/32));var l=a.length;len=len&31;if(l>0&&len){a[l-1]=sjcl.bitArray.partial(len,a[l-1]&2147483648>>len-1,1)}return a},partial:function(len,x,_end){if(len===32){return x}return(_end?x|0:x<<32-len)+len*1099511627776},getPartial:function(x){return Math.round(x/1099511627776)||32},equal:function(a,b){if(sjcl.bitArray.bitLength(a)!==sjcl.bitArray.bitLength(b)){return false}var x=0,i;for(i=0;i<a.length;i++){x|=a[i]^b[i]}return x===0},_shiftRight:function(a,shift,carry,out){var i,last2=0,shift2;if(out===undefined){out=[]}for(;shift>=32;shift-=32){out.push(carry);carry=0}if(shift===0){return out.concat(a)}for(i=0;i<a.length;i++){out.push(carry|a[i]>>>shift);carry=a[i]<<32-shift}last2=a.length?a[a.length-1]:0;shift2=sjcl.bitArray.getPartial(last2);out.push(sjcl.bitArray.partial(shift+shift2&31,shift+shift2>32?carry:out.pop(),1));return out},_xor4:function(x,y){return[x[0]^y[0],x[1]^y[1],x[2]^y[2],x[3]^y[3]]},byteswapM:function(a){var i,v,m=65280;for(i=0;i<a.length;++i){v=a[i];a[i]=v>>>24|v>>>8&m|(v&m)<<8|v<<24}return a}};sjcl.codec.utf8String={fromBits:function(arr){var out="",bl=sjcl.bitArray.bitLength(arr),i,tmp;for(i=0;i<bl/8;i++){if((i&3)===0){tmp=arr[i/4]}out+=String.fromCharCode(tmp>>>8>>>8>>>8);tmp<<=8}return decodeURIComponent(escape(out))},toBits:function(str){str=unescape(encodeURIComponent(str));var out=[],i,tmp=0;for(i=0;i<str.length;i++){tmp=tmp<<8|str.charCodeAt(i);if((i&3)===3){out.push(tmp);tmp=0}}if(i&3){out.push(sjcl.bitArray.partial(8*(i&3),tmp))}return out}};sjcl.codec.base64={_chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",fromBits:function(arr,_noEquals,_url){var out="",i,bits=0,c=sjcl.codec.base64._chars,ta=0,bl=sjcl.bitArray.bitLength(arr);if(_url){c=c.substr(0,62)+"-_"}for(i=0;out.length*6<bl;){out+=c.charAt((ta^arr[i]>>>bits)>>>26);if(bits<6){ta=arr[i]<<6-bits;bits+=26;i++}else{ta<<=6;bits-=6}}while(out.length&3&&!_noEquals){out+="="}return out},toBits:function(str,_url){str=str.replace(/\\s|=/g,"");var out=[],i,bits=0,c=sjcl.codec.base64._chars,ta=0,x;if(_url){c=c.substr(0,62)+"-_"}for(i=0;i<str.length;i++){x=c.indexOf(str.charAt(i));if(x<0){throw new sjcl.exception.invalid("this isn't base64!")}if(bits>26){bits-=26;out.push(ta^x>>>bits);ta=x<<32-bits}else{bits+=6;ta^=x<<32-bits}}if(bits&56){out.push(sjcl.bitArray.partial(bits&56,ta,1))}return out}};sjcl.codec.base64url={fromBits:function(arr){return sjcl.codec.base64.fromBits(arr,1,1)},toBits:function(str){return sjcl.codec.base64.toBits(str,1)}};sjcl.hash.sha256=function(hash){if(!this._key[0]){this._precompute()}if(hash){this._h=hash._h.slice(0);this._buffer=hash._buffer.slice(0);this._length=hash._length}else{this.reset()}};sjcl.hash.sha256.hash=function(data){return(new sjcl.hash.sha256).update(data).finalize()};sjcl.hash.sha256.prototype={blockSize:512,reset:function(){this._h=this._init.slice(0);this._buffer=[];this._length=0;return this},update:function(data){if(typeof data==="string"){data=sjcl.codec.utf8String.toBits(data)}var i,b=this._buffer=sjcl.bitArray.concat(this._buffer,data),ol=this._length,nl=this._length=ol+sjcl.bitArray.bitLength(data);if(nl>9007199254740991){throw new sjcl.exception.invalid("Cannot hash more than 2^53 - 1 bits")}if(typeof Uint32Array!=="undefined"){var c=new Uint32Array(b);var j=0;for(i=512+ol-(512+ol&511);i<=nl;i+=512){this._block(c.subarray(16*j,16*(j+1)));j+=1}b.splice(0,16*j)}else{for(i=512+ol-(512+ol&511);i<=nl;i+=512){this._block(b.splice(0,16))}}return this},finalize:function(){var i,b=this._buffer,h=this._h;b=sjcl.bitArray.concat(b,[sjcl.bitArray.partial(1,1)]);for(i=b.length+2;i&15;i++){b.push(0)}b.push(Math.floor(this._length/4294967296));b.push(this._length|0);while(b.length){this._block(b.splice(0,16))}this.reset();return h},_init:[],_key:[],_precompute:function(){var i=0,prime=2,factor,isPrime;function frac(x){return(x-Math.floor(x))*4294967296|0}for(;i<64;prime++){isPrime=true;for(factor=2;factor*factor<=prime;factor++){if(prime%factor===0){isPrime=false;break}}if(isPrime){if(i<8){this._init[i]=frac(Math.pow(prime,1/2))}this._key[i]=frac(Math.pow(prime,1/3));i++}}},_block:function(w){var i,tmp,a,b,h=this._h,k=this._key,h0=h[0],h1=h[1],h2=h[2],h3=h[3],h4=h[4],h5=h[5],h6=h[6],h7=h[7];for(i=0;i<64;i++){if(i<16){tmp=w[i]}else{a=w[i+1&15];b=w[i+14&15];tmp=w[i&15]=(a>>>7^a>>>18^a>>>3^a<<25^a<<14)+(b>>>17^b>>>19^b>>>10^b<<15^b<<13)+w[i&15]+w[i+9&15]|0}tmp=tmp+h7+(h4>>>6^h4>>>11^h4>>>25^h4<<26^h4<<21^h4<<7)+(h6^h4&(h5^h6))+k[i];h7=h6;h6=h5;h5=h4;h4=h3+tmp|0;h3=h2;h2=h1;h1=h0;h0=tmp+(h1&h2^h3&(h1^h2))+(h1>>>2^h1>>>13^h1>>>22^h1<<30^h1<<19^h1<<10)|0}h[0]=h[0]+h0|0;h[1]=h[1]+h1|0;h[2]=h[2]+h2|0;h[3]=h[3]+h3|0;h[4]=h[4]+h4|0;h[5]=h[5]+h5|0;h[6]=h[6]+h6|0;h[7]=h[7]+h7|0}};sjcl.mode.ccm={name:"ccm",_progressListeners:[],listenProgress:function(cb){sjcl.mode.ccm._progressListeners.push(cb)},unListenProgress:function(cb){var index=sjcl.mode.ccm._progressListeners.indexOf(cb);if(index>-1){sjcl.mode.ccm._progressListeners.splice(index,1)}},_callProgressListener:function(val){var p=sjcl.mode.ccm._progressListeners.slice(),i;for(i=0;i<p.length;i+=1){p[i](val)}},encrypt:function(prf,plaintext,iv,adata,tlen){var L,out=plaintext.slice(0),tag,w=sjcl.bitArray,ivl=w.bitLength(iv)/8,ol=w.bitLength(out)/8;tlen=tlen||64;adata=adata||[];if(ivl<7){throw new sjcl.exception.invalid("ccm: iv must be at least 7 bytes")}for(L=2;L<4&&ol>>>8*L;L++){}if(L<15-ivl){L=15-ivl}iv=w.clamp(iv,8*(15-L));tag=sjcl.mode.ccm._computeTag(prf,plaintext,iv,adata,tlen,L);out=sjcl.mode.ccm._ctrMode(prf,out,iv,tag,tlen,L);return w.concat(out.data,out.tag)},decrypt:function(prf,ciphertext,iv,adata,tlen){tlen=tlen||64;adata=adata||[];var L,w=sjcl.bitArray,ivl=w.bitLength(iv)/8,ol=w.bitLength(ciphertext),out=w.clamp(ciphertext,ol-tlen),tag=w.bitSlice(ciphertext,ol-tlen),tag2;ol=(ol-tlen)/8;if(ivl<7){throw new sjcl.exception.invalid("ccm: iv must be at least 7 bytes")}for(L=2;L<4&&ol>>>8*L;L++){}if(L<15-ivl){L=15-ivl}iv=w.clamp(iv,8*(15-L));out=sjcl.mode.ccm._ctrMode(prf,out,iv,tag,tlen,L);tag2=sjcl.mode.ccm._computeTag(prf,out.data,iv,adata,tlen,L);if(!w.equal(out.tag,tag2)){throw new sjcl.exception.corrupt("ccm: tag doesn't match")}return out.data},_macAdditionalData:function(prf,adata,iv,tlen,ol,L){var mac,tmp,i,macData=[],w=sjcl.bitArray,xor=w._xor4;mac=[w.partial(8,(adata.length?1<<6:0)|tlen-2<<2|L-1)];mac=w.concat(mac,iv);mac[3]|=ol;mac=prf.encrypt(mac);if(adata.length){tmp=w.bitLength(adata)/8;if(tmp<=65279){macData=[w.partial(16,tmp)]}else if(tmp<=4294967295){macData=w.concat([w.partial(16,65534)],[tmp])}macData=w.concat(macData,adata);for(i=0;i<macData.length;i+=4){mac=prf.encrypt(xor(mac,macData.slice(i,i+4).concat([0,0,0])))}}return mac},_computeTag:function(prf,plaintext,iv,adata,tlen,L){var mac,i,w=sjcl.bitArray,xor=w._xor4;tlen/=8;if(tlen%2||tlen<4||tlen>16){throw new sjcl.exception.invalid("ccm: invalid tag length")}if(adata.length>4294967295||plaintext.length>4294967295){throw new sjcl.exception.bug("ccm: can't deal with 4GiB or more data")}mac=sjcl.mode.ccm._macAdditionalData(prf,adata,iv,tlen,w.bitLength(plaintext)/8,L);for(i=0;i<plaintext.length;i+=4){mac=prf.encrypt(xor(mac,plaintext.slice(i,i+4).concat([0,0,0])))}return w.clamp(mac,tlen*8)},_ctrMode:function(prf,data,iv,tag,tlen,L){var enc,i,w=sjcl.bitArray,xor=w._xor4,ctr,l=data.length,bl=w.bitLength(data),n=l/50,p=n;ctr=w.concat([w.partial(8,L-1)],iv).concat([0,0,0]).slice(0,4);tag=w.bitSlice(xor(tag,prf.encrypt(ctr)),0,tlen);if(!l){return{tag:tag,data:[]}}for(i=0;i<l;i+=4){if(i>n){sjcl.mode.ccm._callProgressListener(i/l);n+=p}ctr[3]++;enc=prf.encrypt(ctr);data[i]^=enc[0];data[i+1]^=enc[1];data[i+2]^=enc[2];data[i+3]^=enc[3]}return{tag:tag,data:w.clamp(data,bl)}}};sjcl.misc.hmac=function(key,Hash){this._hash=Hash=Hash||sjcl.hash.sha256;var exKey=[[],[]],i,bs=Hash.prototype.blockSize/32;this._baseHash=[new Hash,new Hash];if(key.length>bs){key=Hash.hash(key)}for(i=0;i<bs;i++){exKey[0][i]=key[i]^909522486;exKey[1][i]=key[i]^1549556828}this._baseHash[0].update(exKey[0]);this._baseHash[1].update(exKey[1]);this._resultHash=new Hash(this._baseHash[0])};sjcl.misc.hmac.prototype.encrypt=sjcl.misc.hmac.prototype.mac=function(data){if(!this._updated){this.update(data);return this.digest(data)}else{throw new sjcl.exception.invalid("encrypt on already updated hmac called!")}};sjcl.misc.hmac.prototype.reset=function(){this._resultHash=new this._hash(this._baseHash[0]);this._updated=false};sjcl.misc.hmac.prototype.update=function(data){this._updated=true;this._resultHash.update(data)};sjcl.misc.hmac.prototype.digest=function(){var w=this._resultHash.finalize(),result=new this._hash(this._baseHash[1]).update(w).finalize();this.reset();return result};sjcl.misc.pbkdf2=function(password,salt,count,length,Prff){count=count||1e4;if(length<0||count<0){throw new sjcl.exception.invalid("invalid params to pbkdf2")}if(typeof password==="string"){password=sjcl.codec.utf8String.toBits(password)}if(typeof salt==="string"){salt=sjcl.codec.utf8String.toBits(salt)}Prff=Prff||sjcl.misc.hmac;var prf=new Prff(password),u,ui,i,j,k,out=[],b=sjcl.bitArray;for(k=1;32*out.length<(length||1);k++){u=ui=prf.encrypt(b.concat(salt,[k]));for(i=1;i<count;i++){ui=prf.encrypt(ui);for(j=0;j<ui.length;j++){u[j]^=ui[j]}}out=out.concat(u)}if(length){out=b.clamp(out,length)}return out};sjcl.prng=function(defaultParanoia){this._pools=[new sjcl.hash.sha256];this._poolEntropy=[0];this._reseedCount=0;this._robins={};this._eventId=0;this._collectorIds={};this._collectorIdNext=0;this._strength=0;this._poolStrength=0;this._nextReseed=0;this._key=[0,0,0,0,0,0,0,0];this._counter=[0,0,0,0];this._cipher=undefined;this._defaultParanoia=defaultParanoia;this._collectorsStarted=false;this._callbacks={progress:{},seeded:{}};this._callbackI=0;this._NOT_READY=0;this._READY=1;this._REQUIRES_RESEED=2;this._MAX_WORDS_PER_BURST=65536;this._PARANOIA_LEVELS=[0,48,64,96,128,192,256,384,512,768,1024];this._MILLISECONDS_PER_RESEED=3e4;this._BITS_PER_RESEED=80};sjcl.prng.prototype={randomWords:function(nwords,paranoia){var out=[],i,readiness=this.isReady(paranoia),g;if(readiness===this._NOT_READY){throw new sjcl.exception.notReady("generator isn't seeded")}else if(readiness&this._REQUIRES_RESEED){this._reseedFromPools(!(readiness&this._READY))}for(i=0;i<nwords;i+=4){if((i+1)%this._MAX_WORDS_PER_BURST===0){this._gate()}g=this._gen4words();out.push(g[0],g[1],g[2],g[3])}this._gate();return out.slice(0,nwords)},setDefaultParanoia:function(paranoia,allowZeroParanoia){if(paranoia===0&&allowZeroParanoia!=="Setting paranoia=0 will ruin your security; use it only for testing"){throw new sjcl.exception.invalid("Setting paranoia=0 will ruin your security; use it only for testing")}this._defaultParanoia=paranoia},addEntropy:function(data,estimatedEntropy,source){source=source||"user";var id,i,tmp,t=(new Date).valueOf(),robin=this._robins[source],oldReady=this.isReady(),err=0,objName;id=this._collectorIds[source];if(id===undefined){id=this._collectorIds[source]=this._collectorIdNext++}if(robin===undefined){robin=this._robins[source]=0}this._robins[source]=(this._robins[source]+1)%this._pools.length;switch(typeof data){case"number":if(estimatedEntropy===undefined){estimatedEntropy=1}this._pools[robin].update([id,this._eventId++,1,estimatedEntropy,t,1,data|0]);break;case"object":objName=Object.prototype.toString.call(data);if(objName==="[object Uint32Array]"){tmp=[];for(i=0;i<data.length;i++){tmp.push(data[i])}data=tmp}else{if(objName!=="[object Array]"){err=1}for(i=0;i<data.length&&!err;i++){if(typeof data[i]!=="number"){err=1}}}if(!err){if(estimatedEntropy===undefined){estimatedEntropy=0;for(i=0;i<data.length;i++){tmp=data[i];while(tmp>0){estimatedEntropy++;tmp=tmp>>>1}}}this._pools[robin].update([id,this._eventId++,2,estimatedEntropy,t,data.length].concat(data))}break;case"string":if(estimatedEntropy===undefined){estimatedEntropy=data.length}this._pools[robin].update([id,this._eventId++,3,estimatedEntropy,t,data.length]);this._pools[robin].update(data);break;default:err=1}if(err){throw new sjcl.exception.bug("random: addEntropy only supports number, array of numbers or string")}this._poolEntropy[robin]+=estimatedEntropy;this._poolStrength+=estimatedEntropy;if(oldReady===this._NOT_READY){if(this.isReady()!==this._NOT_READY){this._fireEvent("seeded",Math.max(this._strength,this._poolStrength))}this._fireEvent("progress",this.getProgress())}},isReady:function(paranoia){var entropyRequired=this._PARANOIA_LEVELS[paranoia!==undefined?paranoia:this._defaultParanoia];if(this._strength&&this._strength>=entropyRequired){return this._poolEntropy[0]>this._BITS_PER_RESEED&&(new Date).valueOf()>this._nextReseed?this._REQUIRES_RESEED|this._READY:this._READY}else{return this._poolStrength>=entropyRequired?this._REQUIRES_RESEED|this._NOT_READY:this._NOT_READY}},getProgress:function(paranoia){var entropyRequired=this._PARANOIA_LEVELS[paranoia?paranoia:this._defaultParanoia];if(this._strength>=entropyRequired){return 1}else{return this._poolStrength>entropyRequired?1:this._poolStrength/entropyRequired}},startCollectors:function(){if(this._collectorsStarted){return}this._eventListener={loadTimeCollector:this._bind(this._loadTimeCollector),mouseCollector:this._bind(this._mouseCollector),keyboardCollector:this._bind(this._keyboardCollector),accelerometerCollector:this._bind(this._accelerometerCollector),touchCollector:this._bind(this._touchCollector)};if(window.addEventListener){window.addEventListener("load",this._eventListener.loadTimeCollector,false);window.addEventListener("mousemove",this._eventListener.mouseCollector,false);window.addEventListener("keypress",this._eventListener.keyboardCollector,false);window.addEventListener("devicemotion",this._eventListener.accelerometerCollector,false);window.addEventListener("touchmove",this._eventListener.touchCollector,false)}else if(document.attachEvent){document.attachEvent("onload",this._eventListener.loadTimeCollector);document.attachEvent("onmousemove",this._eventListener.mouseCollector);document.attachEvent("keypress",this._eventListener.keyboardCollector)}else{throw new sjcl.exception.bug("can't attach event")}this._collectorsStarted=true},stopCollectors:function(){if(!this._collectorsStarted){return}if(window.removeEventListener){window.removeEventListener("load",this._eventListener.loadTimeCollector,false);window.removeEventListener("mousemove",this._eventListener.mouseCollector,false);window.removeEventListener("keypress",this._eventListener.keyboardCollector,false);window.removeEventListener("devicemotion",this._eventListener.accelerometerCollector,false);window.removeEventListener("touchmove",this._eventListener.touchCollector,false)}else if(document.detachEvent){document.detachEvent("onload",this._eventListener.loadTimeCollector);document.detachEvent("onmousemove",this._eventListener.mouseCollector);document.detachEvent("keypress",this._eventListener.keyboardCollector)}this._collectorsStarted=false},addEventListener:function(name,callback){this._callbacks[name][this._callbackI++]=callback},removeEventListener:function(name,cb){var i,j,cbs=this._callbacks[name],jsTemp=[];for(j in cbs){if(cbs.hasOwnProperty(j)&&cbs[j]===cb){jsTemp.push(j)}}for(i=0;i<jsTemp.length;i++){j=jsTemp[i];delete cbs[j]}},_bind:function(func){var that=this;return function(){func.apply(that,arguments)}},_gen4words:function(){for(var i=0;i<4;i++){this._counter[i]=this._counter[i]+1|0;if(this._counter[i]){break}}return this._cipher.encrypt(this._counter)},_gate:function(){this._key=this._gen4words().concat(this._gen4words());this._cipher=new sjcl.cipher.aes(this._key)},_reseed:function(seedWords){this._key=sjcl.hash.sha256.hash(this._key.concat(seedWords));this._cipher=new sjcl.cipher.aes(this._key);for(var i=0;i<4;i++){this._counter[i]=this._counter[i]+1|0;if(this._counter[i]){break}}},_reseedFromPools:function(full){var reseedData=[],strength=0,i;this._nextReseed=reseedData[0]=(new Date).valueOf()+this._MILLISECONDS_PER_RESEED;for(i=0;i<16;i++){reseedData.push(Math.random()*4294967296|0)}for(i=0;i<this._pools.length;i++){reseedData=reseedData.concat(this._pools[i].finalize());strength+=this._poolEntropy[i];this._poolEntropy[i]=0;if(!full&&this._reseedCount&1<<i){break}}if(this._reseedCount>=1<<this._pools.length){this._pools.push(new sjcl.hash.sha256);this._poolEntropy.push(0)}this._poolStrength-=strength;if(strength>this._strength){this._strength=strength}this._reseedCount++;this._reseed(reseedData)},_keyboardCollector:function(){this._addCurrentTimeToEntropy(1)},_mouseCollector:function(ev){var x,y;try{x=ev.x||ev.clientX||ev.offsetX||0;y=ev.y||ev.clientY||ev.offsetY||0}catch(err){x=0;y=0}if(x!=0&&y!=0){this.addEntropy([x,y],2,"mouse")}this._addCurrentTimeToEntropy(0)},_touchCollector:function(ev){var touch=ev.touches[0]||ev.changedTouches[0];var x=touch.pageX||touch.clientX,y=touch.pageY||touch.clientY;this.addEntropy([x,y],1,"touch");this._addCurrentTimeToEntropy(0)},_loadTimeCollector:function(){this._addCurrentTimeToEntropy(2)},_addCurrentTimeToEntropy:function(estimatedEntropy){if(typeof window!=="undefined"&&window.performance&&typeof window.performance.now==="function"){this.addEntropy(window.performance.now(),estimatedEntropy,"loadtime")}else{this.addEntropy((new Date).valueOf(),estimatedEntropy,"loadtime")}},_accelerometerCollector:function(ev){var ac=ev.accelerationIncludingGravity.x||ev.accelerationIncludingGravity.y||ev.accelerationIncludingGravity.z;if(window.orientation){var or=window.orientation;if(typeof or==="number"){this.addEntropy(or,1,"accelerometer")}}if(ac){this.addEntropy(ac,2,"accelerometer")}this._addCurrentTimeToEntropy(0)},_fireEvent:function(name,arg){var j,cbs=sjcl.random._callbacks[name],cbsTemp=[];for(j in cbs){if(cbs.hasOwnProperty(j)){cbsTemp.push(cbs[j])}}for(j=0;j<cbsTemp.length;j++){cbsTemp[j](arg)}}};sjcl.random=new sjcl.prng(6);(function(){function getCryptoModule(){try{return require("crypto")}catch(e){return null}}try{var buf,crypt,ab;if(typeof module!=="undefined"&&module.exports&&(crypt=getCryptoModule())&&crypt.randomBytes){buf=crypt.randomBytes(1024/8);buf=new Uint32Array(new Uint8Array(buf).buffer);sjcl.random.addEntropy(buf,1024,"crypto.randomBytes")}else if(typeof window!=="undefined"&&typeof Uint32Array!=="undefined"){ab=new Uint32Array(32);if(window.crypto&&window.crypto.getRandomValues){window.crypto.getRandomValues(ab)}else if(window.msCrypto&&window.msCrypto.getRandomValues){window.msCrypto.getRandomValues(ab)}else{return}sjcl.random.addEntropy(ab,1024,"crypto.getRandomValues")}else{}}catch(e){if(typeof window!=="undefined"&&window.console){console.log("There was an error collecting entropy from the browser:");console.log(e)}}})();sjcl.json={defaults:{v:1,iter:1e4,ks:128,ts:64,mode:"ccm",adata:"",cipher:"aes"},_encrypt:function(password,plaintext,params,rp){params=params||{};rp=rp||{};var j=sjcl.json,p=j._add({iv:sjcl.random.randomWords(4,0)},j.defaults),tmp,prp,adata;j._add(p,params);adata=p.adata;if(typeof p.salt==="string"){p.salt=sjcl.codec.base64.toBits(p.salt)}if(typeof p.iv==="string"){p.iv=sjcl.codec.base64.toBits(p.iv)}if(!sjcl.mode[p.mode]||!sjcl.cipher[p.cipher]||typeof password==="string"&&p.iter<=100||p.ts!==64&&p.ts!==96&&p.ts!==128||p.ks!==128&&p.ks!==192&&p.ks!==256||(p.iv.length<2||p.iv.length>4)){throw new sjcl.exception.invalid("json encrypt: invalid parameters")}if(typeof password==="string"){tmp=sjcl.misc.cachedPbkdf2(password,p);password=tmp.key.slice(0,p.ks/32);p.salt=tmp.salt}else if(sjcl.ecc&&password instanceof sjcl.ecc.elGamal.publicKey){tmp=password.kem();p.kemtag=tmp.tag;password=tmp.key.slice(0,p.ks/32)}if(typeof plaintext==="string"){plaintext=sjcl.codec.utf8String.toBits(plaintext)}if(typeof adata==="string"){p.adata=adata=sjcl.codec.utf8String.toBits(adata)}prp=new sjcl.cipher[p.cipher](password);j._add(rp,p);rp.key=password;if(p.mode==="ccm"&&sjcl.arrayBuffer&&sjcl.arrayBuffer.ccm&&plaintext instanceof ArrayBuffer){p.ct=sjcl.arrayBuffer.ccm.encrypt(prp,plaintext,p.iv,adata,p.ts)}else{p.ct=sjcl.mode[p.mode].encrypt(prp,plaintext,p.iv,adata,p.ts)}return p},encrypt:function(password,plaintext,params,rp){var j=sjcl.json,p=j._encrypt.apply(j,arguments);return j.encode(p)},_decrypt:function(password,ciphertext,params,rp){params=params||{};rp=rp||{};var j=sjcl.json,p=j._add(j._add(j._add({},j.defaults),ciphertext),params,true),ct,tmp,prp,adata=p.adata;if(typeof p.salt==="string"){p.salt=sjcl.codec.base64.toBits(p.salt)}if(typeof p.iv==="string"){p.iv=sjcl.codec.base64.toBits(p.iv)}if(!sjcl.mode[p.mode]||!sjcl.cipher[p.cipher]||typeof password==="string"&&p.iter<=100||p.ts!==64&&p.ts!==96&&p.ts!==128||p.ks!==128&&p.ks!==192&&p.ks!==256||!p.iv||(p.iv.length<2||p.iv.length>4)){throw new sjcl.exception.invalid("json decrypt: invalid parameters")}if(typeof password==="string"){tmp=sjcl.misc.cachedPbkdf2(password,p);password=tmp.key.slice(0,p.ks/32);p.salt=tmp.salt}else if(sjcl.ecc&&password instanceof sjcl.ecc.elGamal.secretKey){password=password.unkem(sjcl.codec.base64.toBits(p.kemtag)).slice(0,p.ks/32)}if(typeof adata==="string"){adata=sjcl.codec.utf8String.toBits(adata)}prp=new sjcl.cipher[p.cipher](password);if(p.mode==="ccm"&&sjcl.arrayBuffer&&sjcl.arrayBuffer.ccm&&p.ct instanceof ArrayBuffer){ct=sjcl.arrayBuffer.ccm.decrypt(prp,p.ct,p.iv,p.tag,adata,p.ts)}else{ct=sjcl.mode[p.mode].decrypt(prp,p.ct,p.iv,adata,p.ts)}j._add(rp,p);rp.key=password;if(params.raw===1){return ct}else{return sjcl.codec.utf8String.fromBits(ct)}},decrypt:function(password,ciphertext,params,rp){var j=sjcl.json;return j._decrypt(password,j.decode(ciphertext),params,rp)},encode:function(obj){var i,out="{",comma="";for(i in obj){if(obj.hasOwnProperty(i)){if(!i.match(/^[a-z0-9]+$/i)){throw new sjcl.exception.invalid("json encode: invalid property name")}out+=comma+'"'+i+'":';comma=",";switch(typeof obj[i]){case"number":case"boolean":out+=obj[i];break;case"string":out+='"'+escape(obj[i])+'"';break;case"object":out+='"'+sjcl.codec.base64.fromBits(obj[i],0)+'"';break;default:throw new sjcl.exception.bug("json encode: unsupported type")}}}return out+"}"},decode:function(str){str=str.replace(/\\s/g,"");if(!str.match(/^\\{.*}$/)){throw new sjcl.exception.invalid("json decode: this isn't json!")}var a=str.replace(/^\\{|}$/g,"").split(/,/),out={},i,m;for(i=0;i<a.length;i++){if(!(m=a[i].match(/^\\s*(?:(["']?)([a-z][a-z0-9]*)\\1)\\s*:\\s*(?:(-?\\d+)|"([a-z0-9+\\/%*_.@=\\-]*)"|(true|false))$/i))){throw new sjcl.exception.invalid("json decode: this isn't json!")}if(m[3]!=null){out[m[2]]=parseInt(m[3],10)}else if(m[4]!=null){out[m[2]]=m[2].match(/^(ct|adata|salt|iv)$/)?sjcl.codec.base64.toBits(m[4]):unescape(m[4])}else if(m[5]!=null){out[m[2]]=m[5]==="true"}}return out},_add:function(target,src,requireSame){if(target===undefined){target={}}if(src===undefined){return target}var i;for(i in src){if(src.hasOwnProperty(i)){if(requireSame&&target[i]!==undefined&&target[i]!==src[i]){throw new sjcl.exception.invalid("required parameter overridden")}target[i]=src[i]}}return target},_subtract:function(plus,minus){var out={},i;for(i in plus){if(plus.hasOwnProperty(i)&&plus[i]!==minus[i]){out[i]=plus[i]}}return out},_filter:function(src,filter){var out={},i;for(i=0;i<filter.length;i++){if(src[filter[i]]!==undefined){out[filter[i]]=src[filter[i]]}}return out}};sjcl.encrypt=sjcl.json.encrypt;sjcl.decrypt=sjcl.json.decrypt;sjcl.misc._pbkdf2Cache={};sjcl.misc.cachedPbkdf2=function(password,obj){var cache=sjcl.misc._pbkdf2Cache,c,cp,str,salt,iter;obj=obj||{};iter=obj.iter||1e3;cp=cache[password]=cache[password]||{};c=cp[iter]=cp[iter]||{firstSalt:obj.salt&&obj.salt.length?obj.salt.slice(0):sjcl.random.randomWords(2,0)};salt=obj.salt===undefined?c.firstSalt:obj.salt;c[salt]=c[salt]||sjcl.misc.pbkdf2(password,salt,obj.iter);return{key:c[salt].slice(0),salt:salt.slice(0)}};if(typeof module!=="undefined"&&module.exports){module.exports=sjcl}if(typeof define==="function"){define([],function(){return sjcl})}",
        "    var Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(input){var output="";var chr1,chr2,chr3,enc1,enc2,enc3,enc4;var i=0;input=Base64._utf8_encode(input);while(i<input.length){chr1=input.charCodeAt(i++);chr2=input.charCodeAt(i++);chr3=input.charCodeAt(i++);enc1=chr1>>2;enc2=(chr1&3)<<4|chr2>>4;enc3=(chr2&15)<<2|chr3>>6;enc4=chr3&63;if(isNaN(chr2)){enc3=enc4=64}else if(isNaN(chr3)){enc4=64}output=output+this._keyStr.charAt(enc1)+this._keyStr.charAt(enc2)+this._keyStr.charAt(enc3)+this._keyStr.charAt(enc4)}return output},decode:function(input){var output="";var chr1,chr2,chr3;var enc1,enc2,enc3,enc4;var i=0;input=input.replace(/[^A-Za-z0-9\\+\\/\\=]/g,"");while(i<input.length){enc1=this._keyStr.indexOf(input.charAt(i++));enc2=this._keyStr.indexOf(input.charAt(i++));enc3=this._keyStr.indexOf(input.charAt(i++));enc4=this._keyStr.indexOf(input.charAt(i++));chr1=enc1<<2|enc2>>4;chr2=(enc2&15)<<4|enc3>>2;chr3=(enc3&3)<<6|enc4;output=output+String.fromCharCode(chr1);if(enc3!=64){output=output+String.fromCharCode(chr2)}if(enc4!=64){output=output+String.fromCharCode(chr3)}}output=Base64._utf8_decode(output);return output},_utf8_encode:function(string){string=string.replace(/\\r\\n/g,"\\n");var utftext="";for(var n=0;n<string.length;n++){var c=string.charCodeAt(n);if(c<128){utftext+=String.fromCharCode(c)}else if(c>127&&c<2048){utftext+=String.fromCharCode(c>>6|192);utftext+=String.fromCharCode(c&63|128)}else{utftext+=String.fromCharCode(c>>12|224);utftext+=String.fromCharCode(c>>6&63|128);utftext+=String.fromCharCode(c&63|128)}}return utftext},_utf8_decode:function(utftext){var string="";var i=0;var c=c1=c2=0;while(i<utftext.length){c=utftext.charCodeAt(i);if(c<128){string+=String.fromCharCode(c);i++}else if(c>191&&c<224){c2=utftext.charCodeAt(i+1);string+=String.fromCharCode((c&31)<<6|c2&63);i+=2}else{c2=utftext.charCodeAt(i+1);c3=utftext.charCodeAt(i+2);string+=String.fromCharCode((c&15)<<12|(c2&63)<<6|c3&63);i+=3}}return string}};",
        "",
        "      logger.message("Collect And Encrypt Custom Password: start");",
        "    outcome = "true";",
        "  ",
        "    /* Begin Configuration */",
        "      ",
        "      // Attribute name",
        "      var idmAttrName = "frUnindexedString2"; // AM: "fr-attr-str2"",
        "      ",
        "      // Pick a shared secret to use for encryption and decryption",
        "    var sharedSecret = "RainbowPoniesHaveNoStripes";",
        "",
        "      // Fine-tune encryption settings. Default iterations are 10k, to speed up the process, it's reduced to 1k here.",
        "      var encryptionParameters = { "iter" : 1000 };",
        "      ",
        "    // Build out the password prompt",
        "    var prompt = "Replay Password";",
        "",
        "    /* End Configuration */",
        "  ",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "        javax.security.auth.callback.PasswordCallback,",
        "          java.lang.String",
        "    )",
        "    ",
        "    if (callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "          new fr.PasswordCallback(prompt, false)",
        "        ).build();",
        "    } ",
        "    else {",
        "          // PasswordCallback returns the password as a char[], which is not the same as a JS char array. It must be converted to a proper string using the java.lang.Sting.valueOf(char[]) method.",
        "        var password = new String(fr.String.valueOf(callbacks.get(0).getPassword()));",
        "        logger.message("Collect And Encrypt Custom Password: callbacks received");",
        "",
        "          /*",
        "        var cipherPasswordJson = sjcl.encrypt(sharedSecret, password, encryptionParameters);",
        "        //setSharedObjectAttribute(idmAttrName, Base64.encode(JSON.stringify(cipherPasswordJson)));",
        "        setSharedObjectAttribute(idmAttrName, JSON.stringify(cipherPasswordJson));",
        "        logger.message("Collect And Encrypt Custom Password: cipherPasswordJson="+JSON.stringify(cipherPasswordJson));",
        "        */",
        "      ",
        "        logger.message("Collect And Encrypt Custom Password: password="+Base64.encode(password));",
        "        setSharedObjectAttribute(idmAttrName, Base64.encode(password));",
        "",
        "        logger.message("Collect And Encrypt Custom Password: finish [outcome=".concat(outcome).concat("]"));",
        "        action = fr.Action.goTo(outcome).build();",
        "    }",
        "",
        "    /*",
        "     * Store attributes in shared state for use with the Create/Patch Object nodes.",
        "     */",
        "    function setSharedObjectAttribute(name, value) {",
        "        var storage = sharedState.get("objectAttributes");",
        "        if (storage && value) {",
        "            if (storage.put) {",
        "                  storage.put(name, value);",
        "            }",
        "            else {",
        "                storage[name] = value;",
        "            }",
        "        }",
        "        else if (value) {",
        "              var object = {",
        "                  name: value",
        "            };",
        "            sharedState.put("objectAttributes", object);",
        "            //sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "        }",
        "    }",
        "}());",
        "/* SJCL is open. You can use, modify and redistribute it under a BSD",
        "license or under the GNU GPL, version 2.0.",
        "",
        "---------------------------------------------------------------------",
        "",
        "http://opensource.org/licenses/BSD-2-Clause",
        "",
        "Copyright (c) 2009-2015, Emily Stark, Mike Hamburg and Dan Boneh at",
        "Stanford University. All rights reserved.",
        "",
        "Redistribution and use in source and binary forms, with or without",
        "modification, are permitted provided that the following conditions are",
        "met:",
        "",
        "1. Redistributions of source code must retain the above copyright",
        "notice, this list of conditions and the following disclaimer.",
        "",
        "2. Redistributions in binary form must reproduce the above copyright",
        "notice, this list of conditions and the following disclaimer in the",
        "documentation and/or other materials provided with the distribution.",
        "",
        "THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS",
        "IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED",
        "TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A",
        "PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT",
        "HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,",
        "SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED",
        "TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR",
        "PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF",
        "LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING",
        "NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS",
        "SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.",
        "",
        "---------------------------------------------------------------------",
        "",
        "http://opensource.org/licenses/GPL-2.0",
        "",
        "The Stanford Javascript Crypto Library (hosted here on GitHub) is a",
        "project by the Stanford Computer Security Lab to build a secure,",
        "powerful, fast, small, easy-to-use, cross-browser library for",
        "cryptography in Javascript.",
        "",
        "Copyright (c) 2009-2015, Emily Stark, Mike Hamburg and Dan Boneh at",
        "Stanford University.",
        "",
        "This program is free software; you can redistribute it and/or modify it",
        "under the terms of the GNU General Public License as published by the",
        "Free Software Foundation; either version 2 of the License, or (at your",
        "option) any later version.",
        "",
        "This program is distributed in the hope that it will be useful, but",
        "WITHOUT ANY WARRANTY; without even the implied warranty of",
        "MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General",
        "Public License for more details.",
        "",
        "You should have received a copy of the GNU General Public License along",
        "with this program; if not, write to the Free Software Foundation, Inc.,",
        "59 Temple Place, Suite 330, Boston, MA 02111-1307 USA */",
        "",
        "/*",
        " * Base64 encode / decode",
        " *  http://www.webtoolkit.info/",
        " * ",
        " * Example:",
        " * Base64.encode('some string')",
        " * Base64.decode('some encoded string')",
        " */",
      ],
    },
    "db854830-a069-471f-875a-8dc67d45ea2d": {
      "_id": "db854830-a069-471f-875a-8dc67d45ea2d",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_SetInviteMailVars",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "var objAttrs = sharedState.get('objectAttributes') || new HashMap();",
        "objAttrs.put('currentYear', new Date().getFullYear().toString());",
        "sharedState.put('objectAttributes', objAttrs);",
        "",
        "outcome = 'True';",
        "",
      ],
    },
    "dbe0bf9a-72aa-49d5-8483-9db147985a47": {
      "_id": "dbe0bf9a-72aa-49d5-8483-9db147985a47",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Normalizes raw profile data from ADFS",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "ADFS Profile Normalization (JS)",
      "script": [
        "/*",
        " * Copyright 2022 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        " * This script returns the social identity profile information for the authenticating user",
        " * in a standard form expected by the Social Provider Handler Node.",
        " *",
        " * Defined variables:",
        " * rawProfile - The social identity provider profile information for the authenticating user.",
        " *              JsonValue (1).",
        " * logger - The debug logger instance:",
        " *          https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.",
        " * realm - String (primitive).",
        " *         The name of the realm the user is authenticating to.",
        " * requestHeaders - TreeMap (2).",
        " *                  The object that provides methods for accessing headers in the login request:",
        " *                  https://backstage.forgerock.com/docs/am/7/authentication-guide/scripting-api-node.html#scripting-api-node-requestHeaders.",
        " * requestParameters - TreeMap (2).",
        " *                     The object that contains the authentication request parameters.",
        " * selectedIdp - String (primitive).",
        " *               The social identity provider name. For example: google.",
        " * sharedState - LinkedHashMap (3).",
        " *               The object that holds the state of the authentication tree and allows data exchange between the stateless nodes:",
        " *               https://backstage.forgerock.com/docs/am/7/auth-nodes/core-action.html#accessing-tree-state.",
        " * transientState - LinkedHashMap (3).",
        " *                  The object for storing sensitive information that must not leave the server unencrypted,",
        " *                  and that may not need to persist between authentication requests during the authentication session:",
        " *                  https://backstage.forgerock.com/docs/am/7/auth-nodes/core-action.html#accessing-tree-state.",
        " *",
        " * Return - a JsonValue (1).",
        " *          The result of the last statement in the script is returned to the server.",
        " *          Currently, the Immediately Invoked Function Expression (also known as Self-Executing Anonymous Function)",
        " *          is the last (and only) statement in this script, and its return value will become the script result.",
        " *          Do not use "return variable" statement outside of a function definition.",
        " *",
        " *          This script's last statement should result in a JsonValue (1) with the following keys:",
        " *          {",
        " *              {"displayName": "corresponding-social-identity-provider-value"},",
        " *              {"email": "corresponding-social-identity-provider-value"},",
        " *              {"familyName": "corresponding-social-identity-provider-value"},",
        " *              {"givenName": "corresponding-social-identity-provider-value"},",
        " *              {"id": "corresponding-social-identity-provider-value"},",
        " *              {"locale": "corresponding-social-identity-provider-value"},",
        " *              {"photoUrl": "corresponding-social-identity-provider-value"},",
        " *              {"username": "corresponding-social-identity-provider-value"}",
        " *          }",
        " *",
        " *          The consumer of this data defines which keys are required and which are optional.",
        " *          For example, the script associated with the Social Provider Handler Node and,",
        " *          ultimately, the managed object created/updated with this data",
        " *          will expect certain keys to be populated.",
        " *          In some common default configurations, the following keys are required to be not empty:",
        " *          username, givenName, familyName, email.",
        " *",
        " *          From RFC4517: A value of the Directory String syntax is a string of one or more",
        " *          arbitrary characters from the Universal Character Set (UCS).",
        " *          A zero-length character string is not permitted.",
        " *",
        " * (1) JsonValue - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/json/JsonValue.html.",
        " * (2) TreeMap - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/TreeMap.html.",
        " * (3) LinkedHashMap - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/LinkedHashMap.html.",
        " */",
        "",
        "(function () {",
        "    var frJava = JavaImporter(",
        "        org.forgerock.json.JsonValue",
        "    );",
        "",
        "    var normalizedProfileData = frJava.JsonValue.json(frJava.JsonValue.object());",
        "  ",
        "      //logger.message('Seguin rawProfile: '+rawProfile);",
        "",
        "    normalizedProfileData.put('id', rawProfile.get('sub').asString());",
        "    normalizedProfileData.put('displayName', rawProfile.get('givenName').asString() + ' ' + rawProfile.get('sn').asString());",
        "    normalizedProfileData.put('email', rawProfile.get('mail').asString());",
        "    normalizedProfileData.put('givenName', rawProfile.get('givenName').asString());",
        "    normalizedProfileData.put('familyName', rawProfile.get('sn').asString());",
        "    normalizedProfileData.put('username', rawProfile.get('upn').asString());",
        "    normalizedProfileData.put('roles', rawProfile.get('roles').asString());",
        "  ",
        "      //logger.message('Seguin normalizedProfileData: '+normalizedProfileData);",
        "",
        "    return normalizedProfileData;",
        "}());",
      ],
    },
    "dc0c9905-4a58-4f61-8562-337514e610a7": {
      "_id": "dc0c9905-4a58-4f61-8562-337514e610a7",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_IdPNormalization",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        " * This script maps token claim values to managed object attributes. It uses a "claim map" that defines",
        " * several common claim names for a given attribute so that this same script can be used for all IdPs.",
        " * For example, the attribute \`familyName\` can be populated from claims \`familyName\`, \`family_name\`, or \`sn\`.",
        " * ",
        " * Also, if custom IdP config exists in shared state and defines IdP-to-IDC group membership mappings,",
        " * those will be applied/enforced by this script. ",
        " */",
        "",
        "var SHARED_STATE_KEY = 'idpCustomConfig';",
        "",
        "// Helper to avoid strict comparison of string objects",
        "function containsGroup(jsArray, javaString) {",
        "  for (var i = 0; i < jsArray.length; i++) {",
        "    if (jsArray[i] == javaString) {",
        "      return true;",
        "    }",
        "  }",
        "  return false;",
        "}",
        "",
        "(function () {",
        "  var fr = JavaImporter(",
        "    java.lang.String,",
        "    java.util.ArrayList,",
        "    org.forgerock.json.JsonValue",
        "  );",
        "  ",
        "  var normalizedProfileData = fr.JsonValue.json(fr.JsonValue.object());",
        "  var idpConfig = sharedState.get(SHARED_STATE_KEY);",
        "",
        "  // If we have config that defines a groups claim map for this IdP, ensure the claim value matches one that's in the map",
        "  if (idpConfig && idpConfig.groups) {",
        "",
        "    logger.message('enforcing groups claim config');",
        "",
        "    // Get the groups claim from the IdP profile",
        "    var groupsClaim = rawProfile.get(idpConfig.groups.claim);",
        "    if (groupsClaim.isNull()) {",
        "      logger.error('groups claim map was enabled for "{}", but claim "{}" was not found in the raw profile', selectedIdp, idpConfig.groups.claim);",
        "      throw 'Required groups claim is missing from raw profile';",
        "    }",
        "",
        "    logger.message('received group claim value {}', groupsClaim);",
        "",
        "    // Validate the claim type and convert strings to single-value collection",
        "    var groupsClaimList;",
        "    if (groupsClaim.isCollection()) {",
        "      groupsClaimList = groupsClaim;",
        "    } else if (groupsClaim.isString()) {",
        "      groupsClaimList = new fr.ArrayList();",
        "      groupsClaimList.add(groupsClaim);",
        "    } else {",
        "      throw 'Groups claim was not a string or collection';",
        "    }",
        "    ",
        "    // Assert the claim contains at least one group",
        "    var groupsClaimLen = groupsClaimList.size();",
        "    if (groupsClaimLen < 1) {",
        "      throw 'An empty groups claim was found in raw profile';",
        "    }",
        "",
        "    // Loop through each IDC group name in the map. If the raw profile groups claim contains",
        "    // a value that matches the map for that IDC group, add that IDC group to the list for this admin.",
        "    var groups = [];",
        "    for (var idcGroupName in idpConfig.groups.mappings) {",
        "      for (var i = 0; i < groupsClaimLen; i++) {",
        "        var claimGroupId = groupsClaimList.get(i).asString();",
        "",
        "        logger.message('checking if mapping for IDC group "{}" contains claim value "{}"', idcGroupName, claimGroupId);",
        "",
        "        if (containsGroup(idpConfig.groups.mappings[idcGroupName], claimGroupId)) {",
        "          groups.push(idcGroupName);",
        "        }",
        "      }",
        "    }",
        "",
        "    // Assert at least one group was mapped to the claim",
        "    if (groups.length == 0) {",
        "      logger.error('groups claim map was enabled for "{}", but the value of claim "{}" did not match a group mapping', selectedIdp, idpConfig.groups.claim);",
        "      throw 'Raw profile groups claim value does not match a configured mapping';",
        "    }",
        "",
        "    normalizedProfileData.put('groups', groups);",
        "    sharedState.put('groups', groups);",
        "  } else {",
        "    logger.message('no enabled groups claim config to enforce');",
        "  }",
        "",
        "  // Maps normalized profile keys to the possible raw profile keys that values can come from",
        "  var claimMap = {",
        "    email: ['email', 'mail'],",
        "    familyName: ['familyName', 'family_name', 'sn'],",
        "    givenName: ['givenName', 'given_name']",
        "  };",
        "",
        "  // Try to populate each normalized profile property",
        "  var keys = Object.keys(claimMap);",
        "  for (var i = 0; i < keys.length; i++) {",
        "    var normalizedProp = keys[i];",
        "    // Try each mapped raw profile key until a value is found",
        "    for (var j = 0; j < claimMap[normalizedProp].length; j++) {",
        "      var rawProp = claimMap[normalizedProp][j];",
        "      if (!rawProfile.get(rawProp).isNull()) {",
        "        normalizedProfileData.put(normalizedProp, rawProfile.get(rawProp));",
        "        break;",
        "      }",
        "    }",
        "  }",
        "",
        "  return normalizedProfileData;",
        "}());",
      ],
    },
    "dedbc9f6-7fc9-4332-a330-55f7aeb95e78": {
      "_id": "dedbc9f6-7fc9-4332-a330-55f7aeb95e78",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "FRAAS-7955 Shared State Only",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "FRAAS-7955 Shared State Only",
      "script": [
        "outcome = "true";",
        "",
        "setSharedObjectAttribute("userName", "FRAAS-7955");",
        "setSharedObjectAttribute("givenName", "First-shared");",
        "setSharedObjectAttribute("sn", "Last-shared");",
        "setSharedObjectAttribute("mail", "first.last-shared@company.com");",
        "",
        "/*",
        " * Store attributes in shared state for use with the Create/Patch Object nodes.",
        " */",
        "function setSharedObjectAttribute(name, value) {",
        "       var storage = sharedState.get("objectAttributes");",
        "    if (storage && value) {",
        "          if (storage.put) {",
        "              storage.put(name, value);",
        "        }",
        "          else {",
        "              storage[name] = value;",
        "        }",
        "    }",
        "    else if (value) {",
        "        sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "    }",
        "}",
      ],
    },
    "e0666b8b-f625-4047-89d8-e7e91151027f": {
      "_id": "e0666b8b-f625-4047-89d8-e7e91151027f",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Twilio Voice OTP Sender",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Twilio Voice OTP Sender",
      "script": [
        "/* Twilio Voice OTP Sender",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * This script will deliver the OTP via voice to the phone number in the user's profile.",
        " * ",
        " * This script needs to be parametrized. It will not work properly as is. ",
        " * It requires the Identify Existing User node and HOTP Generator node before it is being called.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - sent",
        " * - failed",
        " */",
        "logger.warning("Twilio Voice OTP Sender: start");",
        "",
        "if (sharedState.get("_id") && idRepository.getAttribute(sharedState.get("_id"), "telephoneNumber").iterator().hasNext()) {",
        "    var Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(input){var output="";var chr1,chr2,chr3,enc1,enc2,enc3,enc4;var i=0;input=Base64._utf8_encode(input);while(i<input.length){chr1=input.charCodeAt(i++);chr2=input.charCodeAt(i++);chr3=input.charCodeAt(i++);enc1=chr1>>2;enc2=(chr1&3)<<4|chr2>>4;enc3=(chr2&15)<<2|chr3>>6;enc4=chr3&63;if(isNaN(chr2)){enc3=enc4=64}else if(isNaN(chr3)){enc4=64}output=output+this._keyStr.charAt(enc1)+this._keyStr.charAt(enc2)+this._keyStr.charAt(enc3)+this._keyStr.charAt(enc4)}return output},decode:function(input){var output="";var chr1,chr2,chr3;var enc1,enc2,enc3,enc4;var i=0;input=input.replace(/[^A-Za-z0-9\\+\\/\\=]/g,"");while(i<input.length){enc1=this._keyStr.indexOf(input.charAt(i++));enc2=this._keyStr.indexOf(input.charAt(i++));enc3=this._keyStr.indexOf(input.charAt(i++));enc4=this._keyStr.indexOf(input.charAt(i++));chr1=enc1<<2|enc2>>4;chr2=(enc2&15)<<4|enc3>>2;chr3=(enc3&3)<<6|enc4;output=output+String.fromCharCode(chr1);if(enc3!=64){output=output+String.fromCharCode(chr2)}if(enc4!=64){output=output+String.fromCharCode(chr3)}}output=Base64._utf8_decode(output);return output},_utf8_encode:function(string){string=string.replace(/\\r\\n/g,"\\n");var utftext="";for(var n=0;n<string.length;n++){var c=string.charCodeAt(n);if(c<128){utftext+=String.fromCharCode(c)}else if(c>127&&c<2048){utftext+=String.fromCharCode(c>>6|192);utftext+=String.fromCharCode(c&63|128)}else{utftext+=String.fromCharCode(c>>12|224);utftext+=String.fromCharCode(c>>6&63|128);utftext+=String.fromCharCode(c&63|128)}}return utftext},_utf8_decode:function(utftext){var string="";var i=0;var c=c1=c2=0;while(i<utftext.length){c=utftext.charCodeAt(i);if(c<128){string+=String.fromCharCode(c);i++}else if(c>191&&c<224){c2=utftext.charCodeAt(i+1);string+=String.fromCharCode((c&31)<<6|c2&63);i+=2}else{c2=utftext.charCodeAt(i+1);c3=utftext.charCodeAt(i+2);string+=String.fromCharCode((c&15)<<12|(c2&63)<<6|c3&63);i+=3}}return string}};",
        "",
        "    /* BEGIN SCRIPT CONFIGURATION",
        "     *",
        "     * REPLACE WITH YOUR OWN AZURE AD SETTINGS",
        "     */",
        "    var TWILIO_API_SID = "AC750415e3163a2e57b7aeea7eed82d944";",
        "    var TWILIO_API_TOKEN = "d36a719c94b4be08592d69ec4f80a5bb";",
        "    var TWILIO_API_FROM = "+13176443107";",
        "    /*",
        "     * END SCRIPT CONFIGURATION",
        "     */",
        "  ",
        "    // Twilio SMS Message API Configuration",
        "    var TWILIO_API_URI = "https://api.twilio.com/2010-04-01/Accounts/".concat(TWILIO_API_SID).concat("/Calls.json");    ",
        "    var TWILIO_API_TO = idRepository.getAttribute(sharedState.get("_id"), "telephoneNumber").iterator().next();",
        "      var OTP = sharedState.get("oneTimePassword").split("").join("; ");",
        "    var TWILIO_API_TWIML = "<Response><Pause length='1'/><Say voice='alice'>Your one-time password is ".concat(OTP).concat("</Say><Pause length='1'/><Say>Your one-time password is ").concat(OTP).concat("</Say><Pause length='1'/><Say>Goodbye</Say></Response>");",
        "    //logger.warning("Twilio Voice OTP Sender: To: ".concat(TWILIO_API_TO));",
        "    //logger.warning("Twilio Voice OTP Sender: Twiml: ".concat(TWILIO_API_TWIML));",
        "",
        "    var AUTHZ = "Basic ".concat(Base64.encode(TWILIO_API_SID.concat(':').concat(TWILIO_API_TOKEN)));",
        "    //logger.warning("Twilio SMS OTP Sender: AUTHZ - ".concat(AUTHZ));",
        "",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setMethod('POST');",
        "    request.setUri(TWILIO_API_URI);",
        "    request.getHeaders().add("Content-Type", "application/x-www-form-urlencoded");",
        "    request.getHeaders().add("Authorization", AUTHZ);",
        "    var params = request.getForm();",
        "    params.add("From", TWILIO_API_FROM);",
        "    params.add("Twiml", TWILIO_API_TWIML);",
        "    params.add("To", TWILIO_API_TO);",
        "    request.getEntity().setString(params.toString());",
        "",
        "    var response = httpClient.send(request).get();",
        "    var result = JSON.parse(response.getEntity().getString());",
        "    //logger.warning("Twilio SMS OTP Sender: JSON result: " + JSON.stringify(result));",
        "",
        "    if (result["status"]=="queued") {",
        "        outcome = result["status"];",
        "        logger.error("Twilio Voice OTP Sender: status = ".concat(result["status"]));",
        "        logger.error("Twilio Voice OTP Sender: subresource_uris = ".concat(result["subresource_uris"]));",
        "        logger.error("Twilio Voice OTP Sender: outcome = ".concat(outcome));",
        "    } else {",
        "        outcome = "failed";",
        "        logger.error("Twilio Voice OTP Sender: status = ".concat(result["status"]));",
        "        logger.error("Twilio Voice OTP Sender: code = ".concat(result["code"]));",
        "        logger.error("Twilio Voice OTP Sender: more_info = ".concat(result["more_info"]));",
        "        logger.error("Twilio Voice OTP Sender: message = ".concat(result["message"]));",
        "        logger.error("Twilio Voice OTP Sender: outcome = ".concat(outcome));",
        "    }",
        "} else {",
        "      outcome = "failed";",
        "      logger.error("Twilio Voice OTP Sender: No user or phone number found! Use 'Identify Existing User node before this script to populate the user's _id in shared state!'");",
        "    logger.error("Twilio Voice OTP Sender: outcome = ".concat(outcome));",
        "}",
      ],
    },
    "e0ba741b-c952-4062-9899-0b1c19237ee4": {
      "_id": "e0ba741b-c952-4062-9899-0b1c19237ee4",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "FRAAS-7955 Workaround: Copy sharedState to transientState",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "FRAAS-7955 Workaround",
      "script": [
        "outcome = "true";",
        "var attrs = sharedState.get("objectAttributes");",
        "if (attrs) {",
        "      setTransientObjectAttribute("givenName", attrs.get("givenName").concat("-workaround"));",
        "      setTransientObjectAttribute("sn", attrs.get("sn").concat("-workaround"));",
        "      setTransientObjectAttribute("mail", attrs.get("mail").concat("-workaround"));",
        "}",
        "",
        "/*",
        " * Store attributes in transient state for use with the Create/Patch Object nodes.",
        " */",
        "function setTransientObjectAttribute(name, value) {",
        "    var transientStorage = transientState.get("objectAttributes");",
        "    if (transientStorage && value) {",
        "          if (transientStorage.put) {",
        "            transientStorage.put(name, value);",
        "        }",
        "          else {",
        "            transientStorage[name] = value;",
        "        }",
        "    }",
        "    else if (value) {",
        "    transientState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "    }",
        "}",
      ],
    },
    "e15a13ee-9168-40cf-934f-656a5f568a6a": {
      "_id": "e15a13ee-9168-40cf-934f-656a5f568a6a",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "hashdeviceProfile",
      "script": [
        "/*",
        "  - Data made available by nodes that have already executed are available in the sharedState variable.",
        "  - The script should set outcome to either "true" or "false".",
        " */",
        "",
        "//<script type="text/javascript" src="http://www.myersdaily.org/joseph/javascript/md5.js" />",
        "",
        "function hashCode(r){var e,h=0;for(e=0;e<r.length;e++)h=(h<<5)-h+r.charCodeAt(e),h|=0;return h>>>0}",
        "",
        "",
        "var hashMe = sharedState.get("forgeRock.device.profile");",
        "var hashMe = sharedState.put("forgeRock.device.profile","deleted in script - hashdeviceProfile");",
        "//var hashMeStr = JSON.stringify(hashMe);",
        "//logger.error("HashMeStr: " + hashMeStr);",
        "",
        "sharedState.put("deviceHash",hashCode(escape(hashMe)).toString());",
        "sharedState.put("frIndexedString1",hashCode(escape(hashMe)).toString());",
        "",
        "outcome = "true";",
      ],
    },
    "e1db8a0a-0329-4962-a5bf-ecffaca376ae": {
      "_id": "e1db8a0a-0329-4962-a5bf-ecffaca376ae",
      "context": "OIDC_CLAIMS",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Used by endUserUIClient",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Alpha endUserUIClient OIDC Claims Script",
      "script": [
        "/*",
        " * Copyright 2014-2021 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        " * This script computes claim values returned in ID tokens and/or at the UserInfo Endpoint.",
        " * The claim values are computed for:",
        " * the claims derived from the requested scopes,",
        " * the claims provided by the authorization server,",
        " * and the claims requested by the client via the claims parameter.",
        " *",
        " * In the CONFIGURATION AND CUSTOMIZATION section, you can",
        " * define the scope-to-claims mapping, and",
        " * assign to each claim a resolver function that will compute the claim value.",
        " *",
        " * Defined variables (class references are provided below):",
        " * scopes - Set<String> (6).",
        " *          Always present, the requested scopes.",
        " * claims - Map<String, Object> (5).",
        " *          Always present, default server provided claims.",
        " * claimObjects - List<Claim> (7, 2).",
        " *                Always present, the default server provided claims.",
        " * requestedClaims - Map<String, Set<String>> (5).",
        " *                   Always present, not empty if the request contains the claims parameter and the server has enabled",
        " *                   claims_parameter_supported. A map of the requested claims to possible values, otherwise empty;",
        " *                   requested claims with no requested values will have a key but no value in the map. A key with",
        " *                   a single value in its Set (6) indicates that this is the only value that should be returned.",
        " * requestedTypedClaims - List<Claim> (7, 2).",
        " *                        Always present, the requested claims.",
        " *                        Requested claims with no requested values will have a claim with no values.",
        " *                        A claim with a single value indicates this is the only value that should be returned.",
        " * claimsLocales - List<String> (7).",
        " *                 The values from the 'claims_locales' parameter.",
        " *                 See https://openid.net/specs/openid-connect-core-1_0.html#ClaimsLanguagesAndScripts for the OIDC specification details.",
        " * requestProperties - Unmodifiable Map (5).",
        " *                     Always present, contains a map of request properties:",
        " *                     requestUri - The request URI.",
        " *                     realm - The realm that the request relates to.",
        " *                     requestParams - A map of the request params and/or posted data.",
        " *                                     Each value is a list of one or more properties.",
        " *                                     Please note that these should be handled in accordance with OWASP best practices:",
        " *                                     https://owasp.org/www-community/vulnerabilities/Unsafe_use_of_Reflection.",
        " * clientProperties - Unmodifiable Map (5).",
        " *                    Present if the client specified in the request was identified, contains a map of client properties:",
        " *                    clientId - The client's URI for the request locale.",
        " *                    allowedGrantTypes - List of the allowed grant types (org.forgerock.oauth2.core.GrantType) for the client.",
        " *                    allowedResponseTypes - List of the allowed response types for the client.",
        " *                    allowedScopes - List of the allowed scopes for the client.",
        " *                    customProperties - A map of the custom properties of the client.",
        " *                                       Lists or maps will be included as sub-maps; for example:",
        " *                                       customMap[Key1]=Value1 will be returned as customMap -> Key1 -> Value1.",
        " *                                       To add custom properties to a client, update the Custom Properties field",
        " *                                       in AM Console > Realm Name > Applications > OAuth 2.0 > Clients > Client ID > Advanced.",
        " * identity - AMIdentity (3).",
        " *            Always present, the identity of the resource owner.",
        " * session - SSOToken (4).",
        " *           Present if the request contains the session cookie, the user's session object.",
        " * scriptName - String (primitive).",
        " *              Always present, the display name of the script.",
        " * logger - Always present, the "OAuth2Provider" debug logger instance:",
        " *          https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.",
        " *          Corresponding files will be prefixed with: scripts.OIDC_CLAIMS.",
        " * httpClient - HTTP Client (8).",
        " *              Always present, the HTTP Client instance:",
        " *              https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-http-client.html#scripting-api-global-http-client.",
        " *              In order to use the client, you may need to add",
        " *              org.forgerock.http.Client,",
        " *              org.forgerock.http.protocol.*,",
        " *              and org.forgerock.util.promise.PromiseImpl",
        " *              to the allowed Java classes in the scripting engine configuration, as described in:",
        " *              https://backstage.forgerock.com/docs/am/7/scripting-guide/script-engine-security.html",
        " *",
        " * Return - a new UserInfoClaims(Map<String, Object> values, Map<String, List<String>> compositeScopes) (1) object.",
        " *          The result of the last statement in the script is returned to the server.",
        " *          Currently, the Immediately Invoked Function Expression (also known as Self-Executing Anonymous Function)",
        " *          is the last (and only) statement in this script, and its return value will become the script result.",
        " *          Do not use "return variable" statement outside of a function definition.",
        " *          See RESULTS section for additional details.",
        " *",
        " * Class reference:",
        " * (1) UserInfoClaims - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html.",
        " * (2) Claim - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html).",
        " *         An instance of org.forgerock.openidconnect.Claim has methods to access",
        " *         the claim name, requested values, locale, and whether the claim is essential.",
        " * (3) AMIdentity - https://backstage.forgerock.com/docs/am/7/apidocs/com/sun/identity/idm/AMIdentity.html.",
        " * (4) SSOToken - https://backstage.forgerock.com/docs/am/7/apidocs/com/iplanet/sso/SSOToken.html.",
        " * (5) Map - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashMap.html,",
        " *           or https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/LinkedHashMap.html.",
        " * (6) Set - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashSet.html.",
        " * (7) List - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/ArrayList.html.",
        " * (8) Client - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/http/Client.html.",
        "*/",
        "",
        "(function () {",
        "    // SETUP",
        "",
        "    /**",
        "     * Claim processing utilities.",
        "     * An object that contains reusable functions for processing claims.",
        "     * @see CLAIM PROCESSING UTILITIES section for details.",
        "     */",
        "    var utils = getUtils();",
        "",
        "    // CONFIGURATION AND CUSTOMIZATION",
        "",
        "    /**",
        "     * OAuth 2.0 scope values (scopes) can be used by the Client to request OIDC claims.",
        "     *",
        "     * Call this configuration method, and pass in as the first argument",
        "     * an object that maps a scope value to an array of claim names",
        "     * to specify which claims need to be processed and returned for the requested scopes.",
        "     * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#ScopeClaims}",
        "     * for the scope values that could be used to request claims as defined in the OIDC specification.",
        "     *",
        "     * Below, find a default configuration that is expected to work in the current environment.",
        "     *",
        "     * CUSTOMIZATION",
        "     * You can choose the claim names returned for a scope.",
        "     */",
        "    utils.setScopeClaimsMap({",
        "        profile: [",
        "            'name',",
        "            'family_name',",
        "            'given_name',",
        "            'zoneinfo',",
        "            'locale'",
        "        ],",
        "        email: ['email'],",
        "        address: ['address'],",
        "        phone: ['phone_number']",
        "    });",
        "",
        "    /**",
        "     * In this script, each claim",
        "     * derived from the requested scopes,",
        "     * provided by the authorization server, and",
        "     * requested by the client via the claims parameter",
        "     * will be processed by a function associated with the claim name.",
        "     *",
        "     * Call this configuration method, and pass in as the first argument",
        "     * an object that maps a claim name to a resolver function,",
        "     * which will be automatically executed for each claim processed by the script.",
        "     *",
        "     * The claim resolver function will receive the requested claim information",
        "     * in an instance of org.forgerock.openidconnect.Claim as the first argument.",
        "     * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html}",
        "     * for details on the Claim class.",
        "     *",
        "     * If the claim resolver function returns a value,",
        "     * other than undefined or null,",
        "     * the claim will be included in the script's results.",
        "     *",
        "     * The Claim instance provides methods to check",
        "     * what the name of the claim is,",
        "     * which values the claim request contains,",
        "     * whether the claim is essential, and",
        "     * which locale the claim is associated with.",
        "     * The resolver function can consider this information when computing and returning the claim value.",
        "     *",
        "     * Below, find a default configuration that is expected to work in the current environment.",
        "     * A reusable function, utils.getUserProfileClaimResolver(String attribute-name),",
        "     * is called to return a claim resolver function based on a user profile attribute.",
        "     * @see CLAIM RESOLVERS section for the implementation details and examples.",
        "     * For the address claim, an example of a claim resolver that uses another claim resolver is provided.",
        "     *",
        "     * CUSTOMIZATION",
        "     * You can reuse the predefined utils methods with your custom arguments.",
        "     * You can also specify a custom resolver function for a claim name,",
        "     * that will compute and return the claim value—as shown in the commented out example below.",
        "     */",
        "    utils.setClaimResolvers({",
        "        /*",
        "        // An example of a simple claim resolver function that is defined for a claim",
        "        // directly in the configuration object:",
        "        custom-claim-name: function (requestedClaim) {",
        "            // In this case, initially, the claim value comes straight from a user profile attribute value:",
        "            var claimValue = identity.getAttribute('custom-attribute-name').toArray()[0]",
        "",
        "            // Optionally, provide additional logic for processing (filtering, formatting, etc.) the claim value.",
        "            // You can use:",
        "            // requestedClaim.getName()",
        "            // requestedClaim.getValues()",
        "            // requestedClaim.getLocale()",
        "            // requestedClaim.isEssential()",
        "",
        "            return claimValue",
        "        },",
        "        */",
        "        /**",
        "         * The use of utils.getUserProfileClaimResolver shows how",
        "         * an argument passed to a function that returns a claim resolver",
        "         * becomes available to the resolver function (via its lexical context).",
        "         */",
        "        name: utils.getUserProfileClaimResolver('cn'),",
        "        family_name: utils.getUserProfileClaimResolver('sn'),",
        "        given_name: utils.getUserProfileClaimResolver('givenname'),",
        "        zoneinfo: utils.getUserProfileClaimResolver('preferredtimezone'),",
        "        locale: utils.getUserProfileClaimResolver('preferredlocale'),",
        "        email: utils.getUserProfileClaimResolver('mail'),",
        "        address: utils.getAddressClaimResolver(",
        "            /**",
        "             * The passed in user profile claim resolver function",
        "             * can be used by the address claim resolver function",
        "             * to obtain the claim value to be formatted as per the OIDC specification:",
        "             * @see https://openid.net/specs/openid-connect-core-1_0.html#AddressClaim.",
        "             */",
        "            utils.getUserProfileClaimResolver('postaladdress')",
        "        ),",
        "        phone_number: utils.getUserProfileClaimResolver('telephonenumber')",
        "    });",
        "",
        "    // CLAIM PROCESSING UTILITIES",
        "",
        "    /**",
        "     * @returns {object} An object that contains reusable claim processing utilities.",
        "     * @see PUBLIC METHODS section and the return statement for the list of exported functions.",
        "     */",
        "    function getUtils () {",
        "        // IMPORT JAVA",
        "",
        "        /**",
        "         * Provides Java scripting functionality.",
        "         * @see {@link https://developer.mozilla.org/en-US/docs/Mozilla/Projects/Rhino/Scripting_Java#javaimporter_constructor}.",
        "         */",
        "        var frJava = JavaImporter(",
        "            org.forgerock.oauth2.core.exceptions.InvalidRequestException,",
        "            org.forgerock.oauth2.core.UserInfoClaims,",
        "            org.forgerock.openidconnect.Claim,",
        "",
        "            java.util.LinkedHashMap,",
        "            java.util.ArrayList",
        "        );",
        "",
        "        // SET UP CONFIGURATION",
        "",
        "        /**",
        "         * Placeholder for a configuration option that contains",
        "         * an object that maps the supported scope values (scopes)",
        "         * and the corresponding claim names for each scope value.",
        "         */",
        "        var scopeClaimsMap;",
        "",
        "        /**",
        "         * Placeholder for a configuration option that contains",
        "         * an object that maps the supported claim names",
        "         * and the resolver functions returning the claim value.",
        "         */",
        "        var claimResolvers;",
        "",
        "        /**",
        "         * A (public) method that accepts an object that maps the supported scopes and the corresponding claim names,",
        "         * and assigns it to a (private) variable that serves as a configuration option.",
        "         * @param {object} params - An object that maps each supported scope value to an array of claim names,",
        "         * in order to specify which claims need to be processed for the requested scopes.",
        "         * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#ScopeClaims} for details.",
        "         * @param {string[]} [params.profile] - An array of claim names to be returned if the profile scope is requested.",
        "         * @param {string[]} [params.email] - An array of claim names to be returned if the email scope is requested.",
        "         * @param {string[]} [params.address] - An array of claim names to be returned if the address scope is requested.",
        "         * @param {string[]} [params.phone] - An array of claim names to be returned if the phone scope is requested.",
        "         * @returns {undefined}",
        "         */",
        "        function setScopeClaimsMap(params) {",
        "            scopeClaimsMap = params;",
        "        }",
        "",
        "        /**",
        "         * A (public) method that accepts an object that maps the supported claim names",
        "         * and the resolver functions returning the claim value,",
        "         * and assigns it to a (private) variable that serves as a configuration option.",
        "         * @param {object} params - An object that maps",
        "         * each supported claim name to a function that computes and returns the claim value.",
        "         */",
        "        function setClaimResolvers(params) {",
        "            claimResolvers = params;",
        "        }",
        "",
        "        // CLAIM RESOLVERS",
        "",
        "        /**",
        "         * Claim resolvers are functions that return a claim value.",
        "         * @param {*}",
        "         * @returns {*}",
        "         */",
        "",
        "        /**",
        "         * Defines a claim resolver based on a user profile attribute.",
        "         * @param {string} attributeName - Name of the user profile attribute.",
        "         * @returns {function} A function that will determine the claim value",
        "         * based on the user profile attribute and the (requested) claim properties.",
        "         */",
        "        function getUserProfileClaimResolver (attributeName) {",
        "            /**",
        "             * Resolves a claim with a user profile attribute value.",
        "             * Returns undefined if the identity attribute is not populated,",
        "             * OR if the claim has requested values that do not contain the identity attribute value.",
        "             * ATTENTION: the aforementioned comparison is case-sensitive.",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {string|HashSet|undefined}",
        "             */",
        "            function resolveClaim(claim) {",
        "                var userProfileValue;",
        "",
        "                if (identity) {",
        "                    userProfileValue = getClaimValueFromSet(claim, identity.getAttribute(attributeName));",
        "",
        "                    if (userProfileValue && !userProfileValue.isEmpty()) {",
        "                        if (!claim.getValues() || claim.getValues().isEmpty() || claim.getValues().contains(userProfileValue)) {",
        "                            return userProfileValue;",
        "                        }",
        "                    }",
        "                }",
        "            }",
        "",
        "            return resolveClaim;",
        "        }",
        "",
        "        /**",
        "         * Returns an address claim resolver based on a claim value obtained with another claim resolver.",
        "         * @param {function} resolveClaim - A function that returns a claim value.",
        "         * @returns {function} A function that will accept a claim as an argument,",
        "         * run the claim resolver function for the claim and obtain the claim value,",
        "         * and apply additional formatting to the value before returning it.",
        "         */",
        "        function getAddressClaimResolver (resolveClaim) {",
        "            /**",
        "             * Creates an address claim object from a value returned by a claim resolver,",
        "             * and returns the address claim object as the claim value.",
        "             * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#AddressClaim}.",
        "             * The claim value is obtained with a claim resolving function available from the closure.",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {java.util.LinkedHashMap|undefined} The address claim object created from a claim value.",
        "             */",
        "            function resolveAddressClaim(claim) {",
        "                var claimValue = resolveClaim(claim);",
        "                var addressObject;",
        "",
        "                if (isClaimValueValid(claimValue)) {",
        "                    addressObject = new frJava.LinkedHashMap();",
        "",
        "                    addressObject.put('formatted', claimValue);",
        "",
        "                    return addressObject;",
        "                }",
        "            }",
        "",
        "            return resolveAddressClaim;",
        "        }",
        "",
        "        /**",
        "         * Returns an essential claim resolver based on a claim value obtained with another claim resolver.",
        "         * @param {function} resolveClaim - A function that returns a claim value.",
        "         * @returns {function} A function that will accept a claim as an argument,",
        "         * run the claim resolver function for the claim and obtain the claim value,",
        "         * and apply additional logic for essential claims.",
        "         */",
        "        function getEssentialClaimResolver (resolveClaim) {",
        "            /**",
        "             * Returns a claim value or throws an error.",
        "             * The claim value is obtained with a claim resolving function available from the closure.",
        "             * Throws an exception if the claim is essential and no value is returned for the claim.",
        "             *",
        "             * Use of this resolver is optional.",
        "             * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#IndividualClaimsRequests} stating:",
        "             * "Note that even if the Claims are not available because the End-User did not authorize their release or they are not present,",
        "             * the Authorization Server MUST NOT generate an error when Claims are not returned, whether they are Essential or Voluntary,",
        "             * unless otherwise specified in the description of the specific claim."",
        "             *",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {*}",
        "             * @throws {org.forgerock.oauth2.core.exceptions.InvalidRequestException}",
        "             */",
        "            function resolveEssentialClaim(claim) {",
        "                var claimValue = resolveClaim(claim);",
        "",
        "                if (claim.isEssential() && !isClaimValueValid(claimValue)) {",
        "                    throw new frJava.InvalidRequestException('Could not provide value for essential claim: ' + claim.getName());",
        "                }",
        "",
        "                return claimValue;",
        "            }",
        "",
        "            return resolveEssentialClaim;",
        "        }",
        "",
        "        /**",
        "         * Provides default resolution for a claim.",
        "         * Use it if a claim-specific resolver is not defined in the configuration.",
        "         * @param {org.forgerock.openidconnect.Claim} claim",
        "         * An object that provides methods to obtain information/requirements associated with a claim.",
        "         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "         * @returns {*} A single value associated with this claim.",
        "         */",
        "        function resolveAnyClaim (claim) {",
        "            if (claim.getValues().size() === 1) {",
        "                return claim.getValues().toArray()[0];",
        "            }",
        "        }",
        "",
        "        // UTILITIES",
        "",
        "        /**",
        "         * Returns claim value from a set.",
        "         * If the set contains a single value, returns the value.",
        "         * If the set contains multiple values, returns the set.",
        "         * Otherwise, returns undefined.",
        "         *",
        "         * @param {org.forgerock.openidconnect.Claim} claim",
        "         * An object that provides methods to obtain information/requirements associated with a claim.",
        "         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "         * @param {java.util.HashSet} set The set—for example, a user profile attribute value.",
        "         * @returns {string|java.util.HashSet|undefined}",
        "         */",
        "        function getClaimValueFromSet (claim, set) {",
        "            if (set && set.size()) {",
        "                if (set.size() === 1) {",
        "                    return set.toArray()[0];",
        "                } else {",
        "                    return set;",
        "                }",
        "            } else if (logger.warningEnabled()) {",
        "                logger.warning('OIDC Claims script. Got an empty set for claim: ' + claim.getName());",
        "            }",
        "        }",
        "",
        "        function isClaimValueValid (claimValue) {",
        "            if (typeof claimValue === 'undefined' || claimValue === null) {",
        "                return false;",
        "            }",
        "",
        "            return true;",
        "        }",
        "",
        "        // CLAIM PROCESSING",
        "",
        "        /**",
        "         * Constructs and returns an object populated with the computed claim values",
        "         * and the requested scopes mapped to the claim names.",
        "         * @returns {org.forgerock.oauth2.core.UserInfoClaims} The object to be returned to the authorization server.",
        "         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html}.",
        "         * @see RESULTS section for the use of this function.",
        "         */",
        "        function getUserInfoClaims () {",
        "            return new frJava.UserInfoClaims(getComputedClaims(), getCompositeScopes());",
        "        }",
        "",
        "        /**",
        "         * Creates a map of (requested) claim names populated with the computed claim values.",
        "         * @returns {java.util.LinkedHashMap}",
        "         * A map of the requested claim names and the corresponding claim values.",
        "         */",
        "        function getComputedClaims () {",
        "            /**",
        "             * Creates a complete list of claim objects from:",
        "             * the claims derived from the scopes,",
        "             * the claims provided by the authorization server,",
        "             * and the claims requested by the client.",
        "             * @returns {java.util.ArrayList}",
        "             * Returns a complete list of org.forgerock.openidconnect.Claim objects available to the script.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for the claim object details.",
        "             */",
        "            function getClaims() {",
        "                /**",
        "                 * Returns a list of claim objects for the requested scopes.",
        "                 * Uses the scopeClaimsMap configuration option to derive the claim names;",
        "                 * no other properties of a claim derived from a scope are populated.",
        "                 * @returns {java.util.ArrayList}",
        "                 * A list of org.forgerock.openidconnect.Claim objects derived from the requested scopes.",
        "                 * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for the claim object details.",
        "                 */",
        "                function convertScopeToClaims() {",
        "                    var claims = new frJava.ArrayList();",
        "",
        "                    scopes.toArray().forEach(function (scope) {",
        "                        if (String(scope) !== 'openid' && scopeClaimsMap[scope]) {",
        "                            scopeClaimsMap[scope].forEach(function (claimName) {",
        "                                claims.add(new frJava.Claim(claimName));",
        "                            });",
        "                        }",
        "                    });",
        "",
        "                    return claims;",
        "                }",
        "",
        "                var claims = new frJava.ArrayList();",
        "",
        "                claims.addAll(convertScopeToClaims());",
        "                claims.addAll(claimObjects);",
        "                claims.addAll(requestedTypedClaims);",
        "",
        "                return claims;",
        "            }",
        "",
        "            /**",
        "             * Computes and returns a claim value.",
        "             * To obtain the claim value, uses the resolver function specified for the claim in the claimResolvers configuration object.",
        "             * @see claimResolvers",
        "             * If no resolver function is found, uses the default claim resolver function.",
        "             *",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {*} Claim value.",
        "             * @throws {org.forgerock.oauth2.core.exceptions.InvalidRequestException}",
        "             * Rethrows this exception if a claim resolver throws it.",
        "             * You can throw org.forgerock.oauth2.core.exceptions.InvalidRequestException from your custom claim resolver",
        "             * if you want to terminate the claim processing.",
        "             */",
        "            function computeClaim(claim) {",
        "                var resolveClaim;",
        "                var message;",
        "",
        "                try {",
        "                    resolveClaim = claimResolvers[claim.getName()] || resolveAnyClaim;",
        "",
        "                    return resolveClaim(claim);",
        "                } catch (e) {",
        "                    message = 'OIDC Claims script exception. Unable to resolve OIDC Claim. ' + e;",
        "",
        "                    if (String(e).indexOf('org.forgerock.oauth2.core.exceptions.InvalidRequestException') !== -1) {",
        "                        throw e;",
        "                    }",
        "",
        "                    if (logger.warningEnabled()) {",
        "                        logger.warning(message);",
        "                    }",
        "                }",
        "            }",
        "",
        "            var computedClaims = new frJava.LinkedHashMap();",
        "",
        "            getClaims().toArray().forEach(function (claim) {",
        "                var claimValue = computeClaim(claim);",
        "",
        "                if (isClaimValueValid(claimValue)) {",
        "                    computedClaims.put(claim.getName(), claimValue);",
        "                } else {",
        "                    /**",
        "                     * If a claim has been processed, but appears in the list again,",
        "                     * and its value cannot be computed under the new conditions,",
        "                     * the claim is removed from the final result.",
        "                     *",
        "                     * For example, a claim could be mapped to a scope and found in the user profile,",
        "                     * but also requested by the client with required values that don't match the computed one.",
        "                     * @see {link https://openid.net/specs/openid-connect-core-1_0.html#IndividualClaimsRequests}.",
        "                     * for the relevant OIDC specification details.",
        "                     */",
        "                    computedClaims.remove(claim.getName());",
        "                }",
        "            });",
        "",
        "            return computedClaims;",
        "        }",
        "",
        "        /**",
        "         * Creates a map of requested scopes and the corresponding claim names.",
        "         * @returns {java.util.LinkedHashMap}",
        "         */",
        "        function getCompositeScopes () {",
        "            var compositeScopes = new frJava.LinkedHashMap();",
        "",
        "            scopes.toArray().forEach(function (scope) {",
        "                var scopeClaims = new frJava.ArrayList();",
        "",
        "                if (scopeClaimsMap[scope]) {",
        "                    scopeClaimsMap[scope].forEach(function (claimName) {",
        "                        scopeClaims.add(claimName);",
        "                    });",
        "                }",
        "",
        "                if (scopeClaims.size()) {",
        "                    compositeScopes.put(scope, scopeClaims);",
        "                }",
        "            });",
        "",
        "            return compositeScopes;",
        "        }",
        "",
        "        // PUBLIC METHODS",
        "",
        "        return {",
        "            setScopeClaimsMap: setScopeClaimsMap,",
        "            setClaimResolvers: setClaimResolvers,",
        "            getUserProfileClaimResolver: getUserProfileClaimResolver,",
        "            getAddressClaimResolver: getAddressClaimResolver,",
        "            getEssentialClaimResolver: getEssentialClaimResolver,",
        "            getUserInfoClaims: getUserInfoClaims",
        "        };",
        "    }",
        "",
        "    // RESULTS",
        "",
        "    /**",
        "     * This script returns an instance of the org.forgerock.oauth2.core.UserInfoClaims class",
        "     * populated with the computed claim values and",
        "     * the requested scopes mapped to the claim names.",
        "     * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html}.",
        "     *",
        "     * Assigning it to a variable gives you an opportunity",
        "     * to log the content of the returned value during development.",
        "     */",
        "    var userInfoClaims = utils.getUserInfoClaims();",
        "",
        "    /*",
        "    logger.error(scriptName + ' results:')",
        "    logger.error('Values: ' + userInfoClaims.getValues())",
        "    logger.error('Scopes: ' + userInfoClaims.getCompositeScopes())",
        "    */",
        "",
        "    return userInfoClaims;",
        "}());",
      ],
    },
    "e232cff3-2460-47cd-80b2-36c86c0d0f06": {
      "_id": "e232cff3-2460-47cd-80b2-36c86c0d0f06",
      "context": "OAUTH2_ACCESS_TOKEN_MODIFICATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Used by endUserUIClient",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Alpha endUserUIClient OAuth2 Access Token Modification Script",
      "script": [
        "(function () {",
        "  if (scopes.contains('fr:autoaccess:*') || scopes.contains('fr:iga:*')) {",
        "    var fr = JavaImporter(",
        "      com.sun.identity.idm.IdType",
        "    );",
        "    var groups = [];",
        "    identity.getMemberships(fr.IdType.GROUP).toArray().forEach(function (group) {",
        "      groups.push(group.getAttribute('cn').toArray()[0]);",
        "    });",
        "    accessToken.setField('groups', groups);",
        "  }",
        "}());",
        "",
      ],
    },
    "e4417108-4dc9-4ffc-9995-3cd490adf2ed": {
      "_id": "e4417108-4dc9-4ffc-9995-3cd490adf2ed",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Collect PIN",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Collect PIN",
      "script": [
        "/* Collect PIN",
        " * ",
        " * Collect PIN using password callback and store in user profile.",
        " * ",
        " * This script must be parametrized. It may not work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "  ",
        "  /*** BEGIN PARAMETRIZATION ***/",
        "  var pinAttrName = 'frUnindexedString3';",
        "  var pinPrompt = 'New PIN';",
        "  /**** END PARAMETRIZATION ****/",
        "  ",
        "  outcome = 'true';",
        "  var fr = JavaImporter(",
        "    org.forgerock.openam.auth.node.api.Action,",
        "      javax.security.auth.callback.PasswordCallback",
        "  )",
        "  if (callbacks.isEmpty()) {",
        "    action = fr.Action.send(",
        "      new fr.PasswordCallback(pinPrompt, false)",
        "    ).build();",
        "  }",
        "  else {",
        "      var pin = new java.lang.String(callbacks.get(0).getPassword());",
        "    setTransientObjectAttribute(pinAttrName, pin);",
        "    action = fr.Action.goTo(outcome).build();",
        "  }",
        "",
        "  /*",
        "   * Store attributes in transient state for use with the Create/Patch Object nodes.",
        "   */",
        "  function setTransientObjectAttribute(name, value) {",
        "    var transientStorage = transientState.get("objectAttributes");",
        "    if (transientStorage && value) {",
        "      if (transientStorage.put) {",
        "        transientStorage.put(name, value);",
        "      }",
        "      else {",
        "        transientStorage[name] = value;",
        "      }",
        "    }",
        "    else if (value) {",
        "      transientState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "    }",
        "  }",
        "}());",
      ],
    },
    "e49225eb-e7ad-4699-bf2a-d57689f9cd6e": {
      "_id": "e49225eb-e7ad-4699-bf2a-d57689f9cd6e",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Display sharedState and transientState.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Display States - imported (1)",
      "script": [
        "/* Display States",
        " * ",
        " * Display sharedState and transientState.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    outcome = "true";",
        "",
        "    var anchor = "anchor-".concat(generateNumericToken('xxx'));",
        "    var halign = "left";",
        "    var message = "<h4>Current State Values</h4>".concat(",
        "        "<p><b>Shared State</b>:<br/>").concat(",
        "        sharedState.toString()).concat("</p>").concat(",
        "        "<p><b>Transient State</b>:<br/>").concat(",
        "        transientState.toString()).concat("</p>").concat(",
        "        "<p><b>Request Headers</b>:<br/>").concat(",
        "        requestHeaders.toString()).concat("</p>")",
        "    var script = "Array.prototype.slice.call(\\n".concat(",
        "      "document.getElementsByClassName('callback-component')).forEach(\\n").concat(",
        "      "function (e) {\\n").concat(",
        "      "  var message = e.firstElementChild;\\n").concat(",
        "      "  if (message.firstChild && message.firstChild.nodeName == '#text' && message.firstChild.nodeValue.trim() == '").concat(anchor).concat("') {\\n").concat(",
        "      "    message.className = \\"\\";\\n").concat(",
        "      "    message.style = \\"text-align: left; inline-size: 430px; overflow-wrap: break-word;\\";\\n").concat(",
        "      "    message.align = \\"").concat(halign).concat("\\";\\n").concat(",
        "      "    message.innerHTML = '").concat(message).concat("';\\n").concat(",
        "      "  }\\n").concat(",
        "      "})")",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "        javax.security.auth.callback.TextOutputCallback,",
        "        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        "    )",
        "    if (message.length && callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "            new fr.TextOutputCallback(",
        "                fr.TextOutputCallback.INFORMATION,",
        "                anchor",
        "            ),",
        "            new fr.ScriptTextOutputCallback(script)",
        "        ).build()",
        "    }",
        "    else {",
        "      action = fr.Action.goTo(outcome).build();",
        "    }",
        "",
        "     /*",
        "      * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "      * ",
        "      * Example:",
        "      * 'xxxxx' produces '28535'",
        "      * 'xxx-xxx' produces '432-521'",
        "      */",
        "    function generateNumericToken(format) {",
        "        return format.replace(/[x]/g, function(c) {",
        "            var r = Math.random()*10|0;",
        "            var v = r;",
        "            return v.toString(10);",
        "        });",
        "    }",
        "}());",
      ],
    },
    "e9c9d940-30d9-4a0c-a834-7de69a0600cf": {
      "_id": "e9c9d940-30d9-4a0c-a834-7de69a0600cf",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_CollectUsernameOrEmail",
      "script": [
        "var fr = JavaImporter(",
        "  org.forgerock.json.JsonValue,",
        "  org.forgerock.openam.auth.node.api.Action,",
        "  javax.security.auth.callback.NameCallback,",
        "  java.util.HashMap",
        ");",
        "",
        "with (fr) {",
        "  try {",
        "    ",
        "    if (callbacks.isEmpty()) {",
        "      ",
        "      action = Action.send(new NameCallback('Username or email address')).build();",
        "      ",
        "    } else {",
        "",
        "      // If a value is provided, store it as username and an object attribute",
        "      var callback = callbacks.iterator().next();",
        "      var name = callback.getName().trim();",
        "      if (name) {",
        "        var objAttrs = sharedState.get('objectAttributes') || new HashMap();",
        "        objAttrs.put('mail', name);",
        "        sharedState.put('username', name);",
        "        sharedState.put('objectAttributes', objAttrs);",
        "",
        "        action = Action.goTo('Collected').build();",
        "      }",
        "      ",
        "    }",
        "    ",
        "  } catch (e) {",
        "    ",
        "    logger.error('Admin_CollectUsernameOrEmail: {}', e);",
        "    action = Action.goTo('Error').build();",
        "    ",
        "  }",
        "}",
      ],
    },
    "ec8b314c-8e11-4364-93b9-a3e82d2a074a": {
      "_id": "ec8b314c-8e11-4364-93b9-a3e82d2a074a",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Display Password from nodeState",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Display Password",
      "script": [
        "/* Display Password",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Display Password collected via Platform Password node.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "var password = "unable to retrieve!";",
        "if (nodeState.get("password")) {",
        "  password = nodeState.get("password").asString();",
        "}",
        "var fr = JavaImporter(",
        "    org.forgerock.openam.auth.node.api.Action,",
        "    javax.security.auth.callback.TextOutputCallback",
        ")",
        "if (callbacks.isEmpty()) {",
        "    action = fr.Action.send(",
        "        new fr.TextOutputCallback(",
        "            fr.TextOutputCallback.INFORMATION,",
        "            password",
        "        )",
        "    ).build()",
        "}",
        "else {",
        "  action = fr.Action.goTo("true").build();",
        "}",
      ],
    },
    "ed685f9f-5909-4726-86e8-22bd38b47663": {
      "_id": "ed685f9f-5909-4726-86e8-22bd38b47663",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Converts a normalized social profile into an Identity",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Normalized Profile to Identity",
      "script": [
        "/*",
        " * Copyright 2021 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "import org.forgerock.json.JsonValue",
        "",
        "JsonValue identity = json(object(",
        "        field("givenName", normalizedProfile.givenName),",
        "        field("sn", normalizedProfile.familyName),",
        "        field("mail", normalizedProfile.email),",
        "        field("cn", normalizedProfile.displayName),",
        "        field("userName", normalizedProfile.username),",
        "        field("iplanet-am-user-alias-list", selectedIdp + '-' + normalizedProfile.id.asString())))",
        "",
        "return identity",
      ],
    },
    "f1a2764b-d05a-4480-8f5f-78fda7814227": {
      "_id": "f1a2764b-d05a-4480-8f5f-78fda7814227",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "APIProtection: Reset State",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "APIProtection: Reset States",
      "script": [
        "logger.warning("APIProtection: Reset States: start");",
        "",
        "/*",
        " * BEGIN SCRIPT CONFIGURATION",
        " *",
        " * Outcomes:",
        " * - "true"",
        " */",
        "var KEY_HEADER_NAME = "x-api-key";",
        "var SECRET_HEADER_NAME = "x-api-secret";",
        "/*",
        " * END SCRIPT CONFIGURATION",
        " */",
        "",
        "outcome = "true";",
        "",
        "if (sharedState.get("username") == readValue(KEY_HEADER_NAME)) {",
        "    logger.warning("APIProtection: Reset States: resetting username to:".concat(readValue("username")));",
        "      sharedState.put("username", readValue("username"));",
        "}",
        "",
        "if (transientState.get("password") == readTransientValue(SECRET_HEADER_NAME)) {",
        "    logger.warning("APIProtection: Reset States: resetting password");",
        "      transientState.put("password", readTransientValue("password"));",
        "}",
        "",
        "logger.warning("APIProtection: Reset States: finish [outcome=".concat(outcome).concat("]"));",
        "",
        "/*",
        " * Read value from storage for APIProtection script use",
        " */",
        "function readValue(name) {",
        "      var storage = sharedState.get("APIProtection");",
        "    if (storage) {",
        "          if (storage.get) {",
        "            return sharedState.get("APIProtection").get(name);",
        "        }",
        "          else {",
        "              return storage.name;",
        "        }",
        "    }",
        "      return null;",
        "}",
        "",
        "/*",
        " * Read transient value from storage for APIProtection script use",
        " */",
        "function readTransientValue(name) {",
        "      var transientStorage = transientState.get("APIProtection");",
        "    if (transientStorage) {",
        "          if (transientStorage.get) {",
        "            return transientState.get("APIProtection").get(name);",
        "        }",
        "          else {",
        "              return transientStorage.name;",
        "        }",
        "    }",
        "      return null;",
        "}",
      ],
    },
    "f2107949-22f8-46c4-865d-ae1d1110a9cb": {
      "_id": "f2107949-22f8-46c4-865d-ae1d1110a9cb",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Detect and preserve currently active theme before setting the new theme.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Set OATH Theme",
      "script": [
        "/* Set OATH Theme",
        " * ",
        " * Detect and preserve currently active theme before setting the new theme.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "      outcome = "true";",
        "      ",
        "      var theme = "Expanse_OATH";",
        "",
        "    // do not change, must be a random identifier",
        "    var anchor = generateNumericToken('xxx');",
        "  ",
        "      var script = "";",
        "    script += "document.getElementById(\\"theme-id-"+anchor+"\\").value = localStorage.getItem('theme-id');";",
        "    script += "console.log('theme-id='+document.getElementById(\\"theme-id-"+anchor+"\\").value);";",
        "      script += "document.getElementById(\\"loginButton_0\\").click();";",
        "",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "          org.forgerock.openam.authentication.callbacks.PollingWaitCallback,",
        "        com.sun.identity.authentication.callbacks.HiddenValueCallback,",
        "        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        "    )",
        "    // discover active theme from UI",
        "    if (callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "            new fr.HiddenValueCallback("theme-id-"+anchor, "false"),",
        "            new fr.ScriptTextOutputCallback(script)",
        "        ).build();",
        "    }",
        "      // get active theme from callback and set new theme",
        "      else if (callbacks.size() === 2) {",
        "        // did we get the id of the currently active theme?",
        "        if (callbacks.get(0).getValue() !== "theme-id-"+anchor) {",
        "              sharedState.put("themeId", callbacks.get(0).getValue());",
        "        }",
        "        // set new theme",
        "        var stage = "themeId="+theme;",
        "        action = fr.Action.send(",
        "              new fr.PollingWaitCallback("0", "Please wait ...")",
        "        ).withStage(stage).build();",
        "    }",
        "      else {",
        "        // continue",
        "        action = fr.Action.goTo(outcome).build();",
        "    }",
        "",
        "     /*",
        "      * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "      * ",
        "      * Example:",
        "      * 'xxxxx' produces '28535'",
        "      * 'xxx-xxx' produces '432-521'",
        "      */",
        "    function generateNumericToken(format) {",
        "        return format.replace(/[x]/g, function(c) {",
        "            var r = Math.random()*10|0;",
        "            var v = r;",
        "            return v.toString(10);",
        "        });",
        "    }",
        "}());",
      ],
    },
    "f26cc0de-ee31-4114-8a32-27799bb49357": {
      "_id": "f26cc0de-ee31-4114-8a32-27799bb49357",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Setup MFA Choice",
      "script": [
        "/*",
        " * Adapt the configuration values below",
        " */",
        "",
        "// do not change, must be a random identifier",
        "var anchor = generateNumericToken('xxx');",
        "",
        "// specify the horizontal alignment of the message: left, center, right",
        "var halign = "center";",
        "",
        "// specify the style to apply to the button in the message to make it look like a link",
        "var linkButtonStyle = "border: 0; color: #109CF1; text-decoration: none; background-color: transparent;";",
        "",
        "// specify the link button HTML element. only modify the text between the <button> and </button> tags.",
        "var linkButton = "<button id=\\"skip-link-".concat(anchor).concat("\\" type=\\"submit\\" style=\\"").concat(linkButtonStyle).concat("\\">skip for now.</button>");",
        "",
        "// specify the message you want to display and place the linkButton anywhere",
        "var message = "Please select your prefered factor or".concat(linkButton);",
        "",
        "// specify the choices you want to offer the user.",
        "var choices = ["SMS","Fido","Push"];",
        "",
        "// specify the default choice. this setting must be a valid 0-based index of the choices array above.",
        "var defaultChoice = 0;",
        "",
        "/*",
        " * All the configuration values are above this comment.",
        " *",
        " * DO NOT MAKE ANY CHANGES BELOW!",
        " */",
        "",
        "// find the TextOutputCallback with the message_anchor",
        "// and replace the message_anchor with the message",
        "var displayMessageScript = "".concat(",
        "  "Array.prototype.slice.call(\\n").concat(",
        "  "  document.getElementsByClassName('callback-component')\\n").concat(",
        "  ").forEach(\\n").concat(",
        "  "  function (e) {\\n").concat(",
        "  "    var message = e.firstElementChild;\\n").concat(",
        "  "    if (message.firstChild && message.firstChild.nodeName == '#text' && message.firstChild.nodeValue.trim() == 'message-").concat(anchor).concat("') {\\n").concat(",
        "  "      message.align = \\"").concat(halign).concat("\\";\\n").concat(",
        "  "      message.innerHTML = '").concat(message).concat("';\\n").concat(",
        "  "    }\\n").concat(",
        "  "  }\\n").concat(",
        "  ")")",
        "",
        "// hijack the link button in the message and:",
        "// - find the HiddenValueCallback and set its value to "Skip"",
        "// - then simulate a login button click",
        "var skipOptionScript = "".concat(",
        "  "document.getElementById(\\"skip-link-").concat(anchor).concat("\\").onclick = function(){\\n").concat(",
        "  "  document.getElementById(\\"skip-input-").concat(anchor).concat("\\").value = \\"Skip\\";\\n").concat(",
        "  "  document.getElementById(\\"loginButton_0\\").click();\\n").concat(",
        "  "  return false;\\n").concat(",
        "  "}")",
        "",
        "var fr = JavaImporter(",
        "    org.forgerock.openam.auth.node.api.Action,",
        "    javax.security.auth.callback.ConfirmationCallback,",
        "    javax.security.auth.callback.TextOutputCallback,",
        "    com.sun.identity.authentication.callbacks.HiddenValueCallback,",
        "    com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        ")",
        "",
        "if (callbacks.isEmpty()) {",
        "    action = fr.Action.send(",
        "        new fr.TextOutputCallback(",
        "            fr.TextOutputCallback.INFORMATION,",
        "            "message-".concat(anchor)",
        "        ),",
        "        new fr.ConfirmationCallback(",
        "            fr.ConfirmationCallback.INFORMATION,",
        "            choices,",
        "            defaultChoice",
        "        ),",
        "        new fr.HiddenValueCallback("skip-input-".concat(anchor), "false"),",
        "        new fr.ScriptTextOutputCallback(displayMessageScript),",
        "        new fr.ScriptTextOutputCallback(skipOptionScript)",
        "    ).build()",
        "}",
        "else {",
        "  // did the user skip?",
        "  if (callbacks.get(2).getValue() == "Skip") {",
        "    action = fr.Action.goTo("Skip").build();",
        "  }",
        "  // user didn't skip, pick the right outcome",
        "  else {",
        "    action = fr.Action.goTo(choices[callbacks.get(1).getSelectedIndex()]).build();",
        "  }",
        "}",
        "",
        " /*",
        "  * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "  * ",
        "  * Example:",
        "  * 'xxxxx' produces '28535'",
        "  * 'xxx-xxx' produces '432-521'",
        "  */",
        "function generateNumericToken(format) {",
        "    return format.replace(/[x]/g, function(c) {",
        "        var r = Math.random()*10|0;",
        "        var v = r;",
        "        return v.toString(10);",
        "    });",
        "}",
      ],
    },
    "fbc563cb-eced-4e1b-9cd4-022680347668": {
      "_id": "fbc563cb-eced-4e1b-9cd4-022680347668",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "FRAAS-7955 Show Object Values",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "FRAAS-7955 Show Object Values",
      "script": [
        "var outcome = true;",
        "",
        "// Requires Identify Existing User auth node to retrieve real user ID from IDM",
        "var userid = sharedState.get("_id");",
        "",
        "// Retrieve user profile attributes",
        "var userName = idRepository.getAttribute(userid, "uid").iterator().next().toString();",
        "var firstName = idRepository.getAttribute(userid, "givenName").iterator().next().toString();",
        "var lastName = idRepository.getAttribute(userid, "sn").iterator().next().toString();",
        "var email = idRepository.getAttribute(userid, "mail").iterator().next().toString();",
        "",
        "var anchor = "anchor-".concat(generateNumericToken('xxx'));",
        "var halign = "left";",
        "var message = "<h4>Object Values</h4>".concat(",
        "    "<p><b>Username</b>: ").concat(userName).concat("</p>").concat(",
        "    "<p><b>First Name</b>: ").concat(firstName).concat("</p>").concat(",
        "    "<p><b>Last Name</b>: ").concat(lastName).concat("</p>").concat(",
        "    "<p><b>Email</b>: ").concat(email).concat("</p>")",
        "var script = "Array.prototype.slice.call(\\n".concat(",
        "  "document.getElementsByClassName('callback-component')).forEach(\\n").concat(",
        "  "function (e) {\\n").concat(",
        "  "  var message = e.firstElementChild;\\n").concat(",
        "  "  if (message.firstChild && message.firstChild.nodeName == '#text' && message.firstChild.nodeValue.trim() == '").concat(anchor).concat("') {\\n").concat(",
        "  "    message.className = \\"text-left\\";\\n").concat(",
        "  "    message.align = \\"").concat(halign).concat("\\";\\n").concat(",
        "  "    message.innerHTML = '").concat(message).concat("';\\n").concat(",
        "  "  }\\n").concat(",
        "  "})")",
        "var fr = JavaImporter(",
        "    org.forgerock.openam.auth.node.api.Action,",
        "    javax.security.auth.callback.TextOutputCallback,",
        "    com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        ")",
        "if (message.length && callbacks.isEmpty()) {",
        "    action = fr.Action.send(",
        "        new fr.TextOutputCallback(",
        "            fr.TextOutputCallback.INFORMATION,",
        "            anchor",
        "        ),",
        "        new fr.ScriptTextOutputCallback(script)",
        "    ).build()",
        "}",
        "else {",
        "  action = fr.Action.goTo(outcome).build();",
        "}",
        "",
        " /*",
        "  * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "  * ",
        "  * Example:",
        "  * 'xxxxx' produces '28535'",
        "  * 'xxx-xxx' produces '432-521'",
        "  */",
        "function generateNumericToken(format) {",
        "    return format.replace(/[x]/g, function(c) {",
        "        var r = Math.random()*10|0;",
        "        var v = r;",
        "        return v.toString(10);",
        "    });",
        "}",
      ],
    },
    "fd536b1f-6ee4-4505-b148-71160414ddcc": {
      "_id": "fd536b1f-6ee4-4505-b148-71160414ddcc",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_AttributeCollectionWorkaroundCleanup",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        "This is the second part of a workaround began in Admin_AttributeCollectionWorkaround.",
        "*/",
        "",
        "var objAttrs = sharedState.get('objectAttributes') || new HashMap();",
        "",
        "if (objAttrs.containsKey('groups')) {",
        "  var groups = objAttrs.get('groups');",
        "  if (groups.length == 1 && groups[0] == 'fake') {",
        "    objAttrs.remove('groups');",
        "  }",
        "}",
        "",
        "if (objAttrs.containsKey('inviteDate') && objAttrs.get('inviteDate') == 'fake') {",
        "   objAttrs.remove('inviteDate');",
        "}",
        "",
        "sharedState.put('objectAttributes', objAttrs);",
        "",
        "outcome = 'True';",
      ],
    },
    "fd560219-00ad-4763-9a29-f65aa9ecf776": {
      "_id": "fd560219-00ad-4763-9a29-f65aa9ecf776",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_GetIdPGroupsClaimConfig",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        " * This script is used to retrieve optional custom IdP configuration from IDM as an admin",
        " * completes a login journey. This needs to happen after an IdP has been selected so that",
        " * the \`selectedIdp\` exists in shared state. The result will be stored in a shared state",
        " * key of \`idpCustomConfig\`. The value will be \`null\` if no config was found in IDM.",
        " */",
        "",
        "var AM_INTERNAL_URL = 'http://am.fr-platform:80/am';",
        "var IDM_INTERNAL_URL = 'http://idm.fr-platform:80/openidm';",
        "var RSFILTER_PROVISIONING_CLIENT_ID = 'idm-provisioning';",
        "var RSFILTER_PROVISIONING_SECRET = 'DKNK5K2m5Q98tBTt0yei';",
        "",
        "var SHARED_STATE_KEY = 'idpCustomConfig';",
        "var TXN_ID_HEADER = 'x-forgerock-transactionid';",
        "",
        "// Helper for returning the request transaction ID",
        "function getTransId() {",
        "  var transIds = requestHeaders.get(TXN_ID_HEADER);",
        "  if (transIds) {",
        "    return java.lang.String(transIds.get(0));",
        "  }",
        "  return null;",
        "}",
        "",
        "// Retrieves an access token using a client credentials grant",
        "function getAccessToken(txnId, clientId, clientSecret, scope) {",
        "  var fr = JavaImporter(",
        "    java.lang.String,",
        "    org.forgerock.http.protocol.Request,",
        "    org.forgerock.http.protocol.Response,",
        "    org.forgerock.util.encode.Base64",
        "  );",
        "",
        "  var basicAuthCreds = fr.Base64.encode(new fr.String(clientId + ':' + clientSecret).getBytes('UTF-8'));",
        "",
        "  var request = new fr.Request();",
        "  request.getHeaders().add('authorization', 'Basic ' + basicAuthCreds);",
        "  request.getHeaders().add('content-type', 'application/x-www-form-urlencoded');",
        "  if (txnId) {",
        "    request.getHeaders().add(TXN_ID_HEADER, txnId);",
        "  }",
        "  request",
        "    .setEntity('grant_type=client_credentials&scope=' + scope)",
        "    .setMethod('POST')",
        "    .setUri(AM_INTERNAL_URL + '/oauth2/access_token');",
        "",
        "  var response = httpClient.send(request).getOrThrow();",
        "  if (response.getStatus() === org.forgerock.http.protocol.Status.OK) {",
        "    var result = JSON.parse(response.getEntity().getString());",
        "    logger.message('got access token for client {}', clientId);",
        "    return result.access_token;",
        "  }",
        "  ",
        "  logger.error('failed to get access token for client {}; received status {}', clientId, response.getStatus());",
        "  throw 'failed to get access token';",
        "}",
        "",
        "// Retrieves the IdP custom configuration from IDM",
        "function getConfigFromIDM(txnId, accessToken, idp) {",
        "  var fr = JavaImporter(",
        "    org.forgerock.http.protocol.Request,",
        "    org.forgerock.http.protocol.Response,",
        "    org.forgerock.json.JsonValue,",
        "    org.forgerock.openam.placeholder.substitution.PlaceholderSubstitution,",
        "    org.forgerock.guice.core.InjectorHolder",
        "  );",
        "",
        "  var request = new fr.Request();",
        "  request.getHeaders().add('authorization', 'Bearer ' + accessToken);",
        "  if (txnId) {",
        "    request.getHeaders().add(TXN_ID_HEADER, txnId);",
        "  }",
        "  request",
        "    .setMethod('GET')",
        "    .setUri(IDM_INTERNAL_URL + '/config/fidc/federation-' + idp);",
        "",
        "  var response = httpClient.send(request).getOrThrow();",
        "  if (response.getStatus() === org.forgerock.http.protocol.Status.OK) {",
        "    var rawConfig = JSON.parse(response.getEntity().getString());",
        "    var placeholder = fr.InjectorHolder.getInstance(fr.PlaceholderSubstitution);",
        "    var finalConfig = JSON.parse(placeholder.substitute(fr.JsonValue.json(rawConfig)));",
        "    return finalConfig;",
        "  } else if (response.getStatus() === org.forgerock.http.protocol.Status.NOT_FOUND) {",
        "    return null;",
        "  }",
        "  ",
        "  logger.error('failed to get groups claim config for IdP {}; received status {}', idp, response.getStatus());",
        "  throw 'failed to get groups claim config';",
        "}",
        "",
        "(function () {",
        "  try {",
        "    var idp = nodeState.get('selectedIdp');",
        "    if (!idp.isString()) {",
        "      throw 'selectedIdp not found in shared state';",
        "    }",
        "",
        "    var txnId = getTransId();",
        "    var accessToken = getAccessToken(txnId, RSFILTER_PROVISIONING_CLIENT_ID, RSFILTER_PROVISIONING_SECRET, 'fr:idm:*');",
        "",
        "    var config = getConfigFromIDM(txnId, accessToken, idp.asString())",
        "    if (config) {",
        "      nodeState.putShared(SHARED_STATE_KEY, config);",
        "      logger.message('found groups claim config for IdP {}', idp.asString());",
        "    } else {",
        "      logger.message('no groups claim config found for IdP {}', idp.asString());",
        "    }",
        " ",
        "    outcome = 'Success';",
        "  } catch (e) {",
        "    logger.error('failed to get federation config from IDM: {}', e);",
        "    outcome = 'Error';",
        "  }",
        "}());",
      ],
    },
    "fe35a8fb-31b1-441c-bb9b-27932565061c": {
      "_id": "fe35a8fb-31b1-441c-bb9b-27932565061c",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_MfaGetApp",
      "script": [
        "/*",
        "This creates the following callbacks:",
        "- TextOutputCallback: Display the step title and description",
        "- ConfirmationCallback: Display the "Next" button",
        "- HiddenValueCallback: Captures the "Get app" option, if selected",
        "- ScriptTextOutputCallback: Creates a "Download the app" link button and positions it below the "Next" button",
        "*/",
        "",
        "var token = generateNumericToken('xxx');",
        "var loadingMessage = 'Loading...';",
        "var linkButton = "<button id='getapp-link-".concat(token).concat("' class='btn btn-block btn-link' type='submit'>Download the app</button>");",
        "var message = "<h2 class='h2'>Set up the ForgeRock Authenticator</h2><div style='margin-bottom:1em'>To get started, you need to register your device using the ForgeRock Authenticator app.</div>";",
        "var choices = ['Next'];",
        "var defaultChoice = 0;",
        "var getAppValue = 'Get app';",
        "var getAppInputId = 'getapp-input-'.concat(token);",
        "",
        "var setupPageScript =",
        "  'var setupPage = function() {'.concat(",
        "  '  var getAppInputElem = document.getElementById("').concat(getAppInputId).concat('");').concat(",
        "  '  var messageElem;').concat(",
        "  '  document.getElementsByClassName("callback-component").forEach(').concat(",
        "  '    function (e) {').concat(",
        "  '      var m = e.firstElementChild;').concat(",
        "  '      if (m.firstChild && m.firstChild.nodeName == "#text" && m.firstChild.nodeValue.trim() == "').concat(loadingMessage).concat('") {').concat(",
        "  '        messageElem = m;').concat(",
        "  '      }').concat(",
        "  '    }').concat(",
        "  '  );').concat(",
        "  '  if (!getAppInputElem || !messageElem) {').concat(",
        "  '    return setTimeout(setupPage, 50);').concat(",
        "  '  }').concat(",
        "  '  var skipContainer = document.createElement("div");').concat(",
        "  '  skipContainer.style = "width:100%";').concat(",
        "  '  skipContainer.innerHTML = "').concat(linkButton).concat('";').concat(",
        "  '  getAppInputElem.parentNode.append(skipContainer);').concat(",
        "  '  messageElem.align = "center";').concat(",
        "  '  messageElem.innerHTML = "').concat(message).concat('";').concat(",
        "  '  var bindGetAppLink = function() {').concat(",
        "  '    document.getElementById("getapp-link-').concat(token).concat('").onclick = function() {').concat(",
        "  '      getAppInputElem.value = "').concat(getAppValue).concat('";').concat(",
        "  '      document.getElementById("loginButton_0").click();').concat(",
        "  '      return false;').concat(",
        "  '    };').concat(",
        "  '  };').concat(",
        "  '  setTimeout(bindGetAppLink, 100);').concat(",
        "  '};').concat(",
        "  'setupPage();');",
        "",
        "var fr = JavaImporter(",
        "  org.forgerock.openam.auth.node.api.Action,",
        "  javax.security.auth.callback.ConfirmationCallback,",
        "  javax.security.auth.callback.TextOutputCallback,",
        "  com.sun.identity.authentication.callbacks.HiddenValueCallback,",
        "  com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        ")",
        "",
        "with (fr) {",
        "  if (callbacks.isEmpty()) {",
        "    action = Action.send(",
        "      new TextOutputCallback(",
        "          TextOutputCallback.INFORMATION,",
        "          loadingMessage",
        "      ),",
        "      new ConfirmationCallback(",
        "          ConfirmationCallback.INFORMATION,",
        "          choices,",
        "          defaultChoice",
        "      ),",
        "      new HiddenValueCallback(getAppInputId, 'false'),",
        "      new ScriptTextOutputCallback(setupPageScript)",
        "    ).build()",
        "  } else {",
        "    if (callbacks.get(2).getValue() == getAppValue) {",
        "      action = Action.goTo(getAppValue).build();",
        "    } else {",
        "      action = Action.goTo(choices[callbacks.get(1).getSelectedIndex()]).build();",
        "    }",
        "  }",
        "}",
        "",
        " /*",
        "  * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "  * ",
        "  * Example:",
        "  * 'xxxxx' produces '28535'",
        "  * 'xxx-xxx' produces '432-521'",
        "  */",
        "function generateNumericToken(format) {",
        "  return format.replace(/[x]/g, function(c) {",
        "    var r = Math.random()*10|0;",
        "    var v = r;",
        "    return v.toString(10);",
        "  });",
        "}",
      ],
    },
    "fe5e303b-9ed7-4853-84fe-0ae43e2254d5": {
      "_id": "fe5e303b-9ed7-4853-84fe-0ae43e2254d5",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Display the username in an HTML dialog.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Display Username",
      "script": [
        "/* Display Username",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Display the username.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "(function () {",
        "  try {",
        "    var outcome = 'true';",
        "    var username = nodeState.get('username').asString();",
        "",
        "    // Specify the message you want to display. You may use HTML for formatting. Avoid line breaks! Use <br> instead.",
        "    var message = '<h5>'+username+'</h5>';",
        "",
        "    var anchor = 'anchor-'+generateNumericToken('xxx');",
        "    var script = "Array.prototype.slice.call(\\n \\",
        "      document.getElementsByClassName('callback-component')).forEach(\\n \\",
        "      function (e) {\\n \\",
        "        var message = e.firstElementChild;\\n \\",
        "        if (message.firstChild && message.firstChild.nodeName == '#text' && message.firstChild.nodeValue.trim() == '"+anchor+"') {\\n \\",
        "          message.innerHTML = '"+message+"';\\n \\",
        "        }\\n \\",
        "      })";",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "        javax.security.auth.callback.TextOutputCallback,",
        "        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        "    )",
        "    if (message.length && callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "            new fr.TextOutputCallback(",
        "                fr.TextOutputCallback.INFORMATION,",
        "                anchor",
        "            ),",
        "            new fr.ScriptTextOutputCallback(script)",
        "        ).build()",
        "    }",
        "    else {",
        "      action = fr.Action.goTo(outcome).build();",
        "    }",
        "  } catch (error) {",
        "    logger.error('Error: ' + error);",
        "    nodeState.putShared('error', error.message);",
        "  }",
        "",
        "   /*",
        "    * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "    * ",
        "    * Example:",
        "    * 'xxxxx' produces '28535'",
        "    * 'xxx-xxx' produces '432-521'",
        "    */",
        "  function generateNumericToken(format) {",
        "      return format.replace(/[x]/g, function(c) {",
        "          var r = Math.random()*10|0;",
        "          var v = r;",
        "          return v.toString(10);",
        "      });",
        "  }",
        "}());",
      ],
    },
    "fff76556-2882-4109-a9a6-c42d546cfe57": {
      "_id": "fff76556-2882-4109-a9a6-c42d546cfe57",
      "context": "OAUTH2_SCRIPTED_JWT_ISSUER",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Service Account - JWT Issuers",
      "script": [
        "(function () {",
        "  var frJava = JavaImporter(",
        "    org.forgerock.oauth2.core.TrustedJwtIssuerConfig,",
        "    java.util.HashSet",
        "  );",
        "",
        "  with (frJava) {",
        "    var iss = idRepository.getIdentity(issuer);",
        "    if (iss == null) {",
        "      logger.message('No issuer found for: ' + issuer);",
        "      return null;",
        "    }",
        "    logger.message('Found issuer: ' + iss);",
        "",
        "    var accountStatus = iss.getAttributeValues('inetUserStatus');",
        "    if (!accountStatus || accountStatus.length === 0) {",
        "      logger.message('No inetUserStatus attribute in issuer');",
        "      return null;",
        "    } else if (accountStatus[0].toLowerCase() != 'active') {",
        "      logger.message('Issuer is not active');",
        "      return null;",
        "    }",
        "",
        "    var jwksAttrs = iss.getAttributeValues('fr-attr-jwks');",
        "    if (!jwksAttrs || jwksAttrs.length === 0) {",
        "      logger.message('No jwks attributes in issuer');",
        "      return null;",
        "    }",
        "",
        "    var jwkSet = jwksAttrs[0];",
        "    if (!jwkSet) {",
        "      logger.message('No jwk set in issuer');",
        "      return null;",
        "    }",
        "",
        "    var config = new TrustedJwtIssuerConfig(",
        "      issuer,",
        "      'sub',",
        "      'scope',",
        "      new HashSet([issuer]),",
        "      jwkSet,",
        "      null, null, null",
        "    );",
        "",
        "    return config;",
        "  }",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export --script-name 'GitHub Profile Normalization'": should export the script named "GitHub Profile Normalization" 1`] = `""`;

exports[`frodo script export "frodo script export --script-name 'GitHub Profile Normalization'": should export the script named "GitHub Profile Normalization": ./GitHub-Profile-Normalization.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "a7a78773-445b-4eca-bb93-409e86bced81": {
      "_id": "a7a78773-445b-4eca-bb93-409e86bced81",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from GitHub",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "GitHub Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2022 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "return json(object(",
        "        field("id", rawProfile.id),",
        "        field("displayName", rawProfile.name),",
        "        field("username", rawProfile.login)))",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files 1`] = `""`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./AA-Custom-Policy-Engine.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "9e9c6c4d-5d9d-4990-9f05-d8b2b25ad52b": {
      "_id": "9e9c6c4d-5d9d-4990-9f05-d8b2b25ad52b",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Custom risk policy engine combining Autonomous Access signals with external signals.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "AA Custom Policy Engine",
      "script": [
        "/* AA Custom Policy Engine",
        " *",
        " * Author: marcin.zimny@forgerock.com",
        " * Adaptations: volker.scheuber@forgerock.com",
        " * ",
        " * Custom policy engine combining the Autonomous Access risk engine output with external systems and custom policy output:",
        " * ",
        " * - use multiple risk scoring policies (currently it's part of risk config file and used across all evaluations)",
        " * - deliver custom logic of delivering outcome (we can sum the signals instead of returning the highest)",
        " * - use custom signals as part of the (single) risk node (for example anonymisation detection)",
        " * - exceptions/overrides (i.e. if we have to allow a flow with high risk for whatever reason) ",
        " * ",
        " * This script needs to be parametrized. It will NOT work properly as is!",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - low",
        " * - medium",
        " * - high",
        " * - failed",
        " */",
        "(function () {",
        "  /* ",
        "   * MUST CONFIGURE THIS SECTION",
        "   * Custom signals parameters",
        "   */",
        "  ",
        "  // IPQualityScore API",
        "  var USER_AGENT = "ForgeRock"",
        "  var API_KEY = systemEnv.getProperty("esv.ipqs.api.key");",
        "  ",
        "  /*",
        "   * END MANDATORY CONFIGURATION",
        "   */",
        "  ",
        "  outcome = "failed"; //default outcome",
        "  /*",
        "    Risk Policy - Signal Scores",
        "  */",
        "  var aa_impossible_travel_score = 21;",
        "  var aa_credential_stuffing_score = 100;",
        "  var aa_automated_user_agent_score = 25;",
        "  var aa_brute_force_score = 100;",
        "  var aa_suspicious_ip_score = 35;",
        "  /*",
        "    Risk Policy - Custom Signals",
        "  */",
        "  var aa_use_anonymizer_detection = 1;",
        "  var custom_aa_tor_detected_score = 50;",
        "  var custom_aa_vpn_detected_score = 20;",
        "  var custom_aa_proxy_detected_score = 20;",
        "  /*",
        "    Risk Policy - Thresholds And Extra Features",
        "  */",
        "  var aa_medium_risk_threshold = 30;",
        "  var aa_high_risk_threshold = 75;",
        "  var aa_max_signal_count_high_risk_override = 99;",
        "  /*",
        "    Risk Policy - Method",
        "      0 - highest score out of all triggered signals",
        "      1 - summary of all triggered signals",
        "  */",
        "  var aa_risk_method=1;",
        "  /*",
        "    Risk Policy - UEBA method",
        "      0 - highest score out of 3 models",
        "      1 - average score out of 3 models",
        "  */",
        "  var aa_ueba_method=0;",
        "  /*",
        "    Risk Policy - Overrides",
        "",
        "    Whitelist - false positive control",
        "    Blacklist - preventative block",
        "    Example - ip_whitelist or ip_blacklist = ["62.21.63.30-62.21.63.30","82.21.168.1-82.21.168.255"];",
        "  */",
        "  var ip_whitelist = [];",
        "  var ip_blacklist = [];",
        "  ",
        "  /********************************************************",
        "    The engine *",
        "  */",
        "  //Define variables",
        "  var signal_count = 0;",
        "  var pos = 0;",
        "  var arr_scores = [];",
        "  var arr_scores_models = [];",
        "  var score = 0;",
        "  var predictionResultChopped;",
        "  var predictionResultChoppedVal;",
        "  //Define signal variables and assign defaults (negative)",
        "  var is_impossible_travel = 0;",
        "  var is_credential_stuffing = 0;",
        "  var is_automated_user_agent = 0;",
        "  var is_brute_force = 0;",
        "  var is_suspicious_ip = 0;",
        "  var model1_score = 0;",
        "  var model2_score = 0;",
        "  var model3_score = 0;",
        "  var isAnonymizedResult;",
        "  //Get risk data",
        "  var predictionResultRaw = sharedState.get("predictionResult");",
        "  var predictionResultString = predictionResultRaw.toString();",
        "",
        "  var result;",
        "",
        "  function inet_aton (ip)",
        "  {",
        "      return ip.split(".").reduce((int, v) => int * 256 + +v);",
        "  }",
        "",
        "",
        "  function isAnonymized()",
        "  {",
        "    var payload = sharedState.get("IPQualityScore")",
        "",
        "    if (payload)",
        "    {",
        "      var jsonResult = JSON.parse(payload);",
        "    }",
        "    else",
        "    {",
        "      var ipaddress = requestHeaders.get("X-FORWARDED-FOR").get(0).split(",")[0].trim();",
        "",
        "      var request = new org.forgerock.http.protocol.Request();",
        "      request.setMethod("GET");",
        "      request.setUri("https://ipqualityscore.com/api/json/ip/" + API_KEY + "/" + ipaddress + "?strictness=0&allow_public_access_points=false&fast=false&lighter_penalties=false&mobile=false");",
        "      request.getHeaders().add("Accept","application/json");",
        "      request.getHeaders().add("User-Agent", USER_AGENT);",
        "",
        "      var response = httpClient.send(request).get();",
        "      if (response.getStatus().getCode() === 200) {",
        "        var payload = response.getEntity().getString();",
        "        var jsonResult = JSON.parse(payload)",
        "          if (jsonResult.success === true) {",
        "          sharedState.put("Debug-IPQualityScore", payload);",
        "        }",
        "      }",
        "    }",
        "",
        "    if (jsonResult) {",
        "      if (jsonResult.tor === true) {",
        "        isAnonymizedResult = "tor";",
        "      } else if (jsonResult.vpn === true) {",
        "        isAnonymizedResult= "vpn";",
        "      } else if (jsonResult.proxy === true) {",
        "        isAnonymizedResult = "proxy";",
        "      } else {",
        "        isAnonymizedResult = "not_detected";",
        "      }",
        "    }",
        "  }",
        "",
        "",
        "  if(aa_use_anonymizer_detection==1)",
        "  {",
        "    isAnonymized();",
        "    sharedState.put("custom_aa_isAnonymized",isAnonymizedResult);",
        "    if(isAnonymizedResult=="vpn")",
        "    {",
        "      arr_scores.push(custom_aa_vpn_detected_score);",
        "    }",
        "    else if(isAnonymizedResult=="proxy")",
        "    {",
        "      arr_scores.push(custom_aa_proxy_detected_score);",
        "    }",
        "    else if(isAnonymizedResult=="tor")",
        "    {",
        "      arr_scores.push(custom_aa_tor_detected_score);",
        "    }",
        "    else",
        "    {",
        "      arr_scores.push(0);",
        "    }",
        "  }",
        "",
        "  if(predictionResultString.search("risk_score_data")>=0)",
        "  {",
        "    outcome = "low"; //default if there's data from risk API",
        "  }",
        "",
        "  //Check if we're assessing impossible travel and assign result",
        "  pos = predictionResultString.search("impossibleTravellerCheck=true");",
        "  if(pos>0)",
        "  {",
        "    pos = predictionResultString.search("is_impossible_travel=false");",
        "    if(pos<0)",
        "    {",
        "      signal_count++;",
        "      is_impossible_travel=1;",
        "      arr_scores.push(aa_impossible_travel_score);",
        "    }",
        "  }",
        "  //Check if we're assessing credential stuffing and assign result",
        "  pos = predictionResultString.search("credentialStuffing=true");",
        "  if(pos>0)",
        "  {",
        "    pos = predictionResultString.search("is_credential_stuffing=false");",
        "    if(pos<0)",
        "    {",
        "      signal_count++;",
        "      is_credential_stuffing=1;",
        "      arr_scores.push(aa_credential_stuffing_score);",
        "    }",
        "  }",
        "  //Check if we're assessing automated user angent (antibot) and assign result",
        "  pos = predictionResultString.search("automatedUserAgentsFilter=true");",
        "  if(pos>0)",
        "  {",
        "    pos = predictionResultString.search("is_automated_user_agent=false");",
        "    if(pos<0)",
        "    {",
        "      signal_count++;",
        "      is_automated_user_agent=1;",
        "      arr_scores.push(aa_automated_user_agent_score);",
        "    }",
        "  }",
        "  //Check if we're assessing brute-force and assign result",
        "  pos = predictionResultString.search("bruteForcePreventionCheck=true");",
        "  if(pos>0)",
        "  {",
        "    pos = predictionResultString.search("is_brute_force=false");",
        "    if(pos<0)",
        "    {",
        "      signal_count++;",
        "      is_brute_force=1;",
        "      arr_scores.push(aa_brute_force_score);",
        "    }",
        "  }",
        "  //Check if we're assessing suspicious IP and assign result",
        "  pos = predictionResultString.search("suspiciousIPCheck=true");",
        "  if(pos>0)",
        "  {",
        "    pos = predictionResultString.search("is_suspicious_ip=false");",
        "    if(pos<0)",
        "    {",
        "      signal_count++;",
        "      is_suspicious_ip=1;",
        "      arr_scores.push(aa_suspicious_ip_score);",
        "    }",
        "  }",
        "  //Check if we're assessing UEBA and assign result",
        "  pos = predictionResultString.search("anomalyDetection=true");",
        "  if(pos>0)",
        "  {",
        "    pos = predictionResultString.search("clustering_result=");",
        "    if(pos>0)",
        "    {",
        "        predictionResultChopped=predictionResultString.substring(pos);",
        "        predictionResultChopped=predictionResultChopped.substring(predictionResultChopped.search("risk_score="));",
        "        predictionResultChoppedVal=predictionResultChopped.substring(11,predictionResultChopped.search(","));",
        "        predictionResultChopped=predictionResultChopped.substring(11);",
        "        model1score=parseInt(predictionResultChoppedVal,10);",
        "",
        "        predictionResultChopped=predictionResultChopped.substring(predictionResultChopped.search("risk_score="));",
        "        predictionResultChoppedVal=predictionResultChopped.substring(11,predictionResultChopped.search(","));",
        "        predictionResultChopped=predictionResultChopped.substring(11);",
        "        model2score=parseInt(predictionResultChoppedVal,10);",
        "",
        "        predictionResultChopped=predictionResultChopped.substring(predictionResultChopped.search("risk_score="));",
        "        predictionResultChoppedVal=predictionResultChopped.substring(11,predictionResultChopped.search(","));",
        "        predictionResultChopped=predictionResultChopped.substring(11);",
        "        model3score=parseInt(predictionResultChoppedVal,10);",
        "",
        "        arr_scores_models.push(model1score,model2score,model3score);",
        "    }",
        "  }",
        "",
        "  //Deliver risk score",
        "  if(aa_ueba_method==0)",
        "  {",
        "    score = Math.max.apply(null, arr_scores_models);",
        "  }",
        "  else if(aa_ueba_method==1)",
        "  {",
        "    score = arr_scores_models.reduce((a, b) => a + b, 0)/arr_scores_models.length;",
        "  }",
        "  arr_scores.push(score);",
        "",
        "",
        "  if(aa_risk_method==0)",
        "  {",
        "    score = Math.max.apply(null, arr_scores);",
        "  }",
        "  else if (aa_risk_method===1)",
        "  {",
        "    score = arr_scores.reduce((a, b) => a + b, 0);",
        "  }",
        "  //Deliver risk outcome",
        "  if(score>aa_medium_risk_threshold)",
        "  {",
        "    outcome="medium";",
        "  }",
        "  if(score>aa_high_risk_threshold)",
        "  {",
        "    outcome="high";",
        "  }",
        "  if(signal_count>=aa_max_signal_count_high_risk_override && outcome=="medium")",
        "  {",
        "    outcome="high";",
        "    sharedState.put("debug-signal-count-override","true");",
        "  }",
        "",
        "  //process the blacklist and whitelist",
        "  var src_ipaddress;",
        "  var src_ipaddress_dec;",
        "  var list_first_ipaddress_dec;",
        "  var list_last_ipaddress_dec;",
        "  var list_entry;",
        "  var logmessage;",
        "  src_ipaddress = requestHeaders.get("X-FORWARDED-FOR").get(0).split(",")[0].trim();",
        "  src_ipaddress_dec = inet_aton(src_ipaddress);",
        "",
        "  if(ip_blacklist.length>0)",
        "  {",
        "    for (var i = 0; i < ip_blacklist.length; i++)",
        "    {",
        "      list_entry = ip_blacklist[i].split("-");",
        "      list_first_ipaddress_dec=inet_aton(list_entry[0]);",
        "      list_last_ipaddress_dec=inet_aton(list_entry[1]);",
        "",
        "      if(src_ipaddress_dec>=list_first_ipaddress_dec && src_ipaddress_dec<=list_last_ipaddress_dec)",
        "      {",
        "          sharedState.put("debug-blacklist","condition met for: " + src_ipaddress + ", " + outcome + "->high");",
        "           outcome="high";",
        "      }",
        "    }",
        "  }",
        "  if(ip_whitelist.length>0)",
        "  {",
        "    for (var i = 0; i < ip_whitelist.length; i++)",
        "    {",
        "      //list_entry = ip_whitelist[i].split("-");",
        "      list_entry = ip_whitelist[i].split("-");",
        "      list_first_ipaddress_dec=inet_aton(list_entry[0]);",
        "      list_last_ipaddress_dec=inet_aton(list_entry[1]);",
        "      if(src_ipaddress_dec>=list_first_ipaddress_dec && src_ipaddress_dec<=list_last_ipaddress_dec)",
        "      {",
        "        sharedState.put("debug-whitelist","condition met for: " + src_ipaddress + ", " + outcome + "->low");",
        "        outcome = "low";",
        "      }",
        "    }",
        "  }",
        "",
        "",
        "",
        "  sharedState.put('debug-score',score.toString());",
        "  sharedState.put('debug-signal-count',signal_count.toString());",
        "  sharedState.put('debug-outcome',outcome);",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./AAD-Passthru-ROPC.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "13cd3c60-a04b-4455-b028-fbfd01ed88b1": {
      "_id": "13cd3c60-a04b-4455-b028-fbfd01ed88b1",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Azure AD pass through authentication using Resource Owner Password Credential flow",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "AAD Passthru ROPC",
      "script": [
        "/* AAD Passthru ROPC",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Azure AD pass through authentication using Resource Owner Password Credential flow",
        " * ",
        " * This script needs to be parametrized. It will not work properly as is. ",
        " * It requires the Platform Username and Platform Password collector nodes",
        " * before it can operate.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - Valid",
        " * - Invalid",
        " * - Expired",
        " * - Disabled",
        " * - Error",
        " */",
        "logger.message("AAD Passthru ROPC: start");",
        "",
        "if (sharedState.get("username") && transientState.get("password")) {",
        "      /*",
        "     * BEGIN SCRIPT CONFIGURATION",
        "     *",
        "     * REPLACE WITH YOUR OWN AZURE AD SETTINGS",
        "     *",
        "     * AAD_TENANT_ID is your tenant ID: https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/active-directory-how-to-find-tenant",
        "     * AAD_CLIENT_ID is your registered app ID: https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-register-app",
        "     */",
        "    var AAD_TENANT_ID = "711ffa9c-5972-4713-ace3-688c9732614a";",
        "    var AAD_CLIENT_ID = "51f130ec-d29d-4419-a492-0011d09c1a16";",
        "    /*",
        "     * END SCRIPT CONFIGURATION",
        "     */",
        "      ",
        "    // Azure AD ROPC Configuration",
        "    var AAD_SCOPE = "profile";",
        "      var AAD_RESOURCE = "https://graph.microsoft.com/"",
        "    var AAD_OAUTH2_TOKEN_URI = "https://login.windows.net/".concat(AAD_TENANT_ID).concat("/oauth2/token");",
        "",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setMethod('POST');",
        "    request.setUri(AAD_OAUTH2_TOKEN_URI);",
        "    request.getHeaders().add("Content-Type", "application/x-www-form-urlencoded");",
        "    var params = request.getForm();",
        "    params.add("resource", AAD_RESOURCE);",
        "    params.add("client_id", AAD_CLIENT_ID);",
        "    params.add("grant_type", "password");",
        "    params.add("scope", AAD_SCOPE);",
        "    params.add("username", sharedState.get("username"));",
        "    params.add("password", transientState.get("password"));",
        "    request.getEntity().setString(params.toString());",
        "",
        "    var response = httpClient.send(request).get();",
        "    var result = JSON.parse(response.getEntity().getString());",
        "    //logger.message("AAD Passthru ROPC: JSON result: " + JSON.stringify(result));",
        "",
        "      if (response.getStatus().getCode() === 200) {",
        "          outcome = "Valid"",
        "        transientState.put("aadAccessToken", result.access_token);",
        "    } else {",
        "        /* Outcomes:",
        "         * - Valid",
        "         * - Invalid",
        "         * - Expired",
        "         * - Disabled",
        "         * - Error",
        "         *",
        "         * Expected Error Codes:",
        "         * 50126 - Error validating credentials due to invalid username or password.",
        "         * 50055 - The password is expired.",
        "         * 50057 - The user account is disabled.",
        "         * 50196 - The server terminated an operation because it encountered a client request loop. Please contact your app vendor.",
        "         */",
        "        if (result.error_codes.includes(50126)) {",
        "            outcome = "Invalid";",
        "        } else if (result.error_codes.includes(50055)) {",
        "            outcome = "Expired";",
        "        } else if (result.error_codes.includes(50057)) {",
        "            outcome = "Disabled";",
        "        } else {",
        "            outcome = "Error";",
        "        }",
        "        logger.message("AAD Passthru ROPC: error = ".concat(result.error));",
        "        logger.message("AAD Passthru ROPC: error_description = ".concat(result.error_description));",
        "        logger.message("AAD Passthru ROPC: error_codes = ".concat(result.error_codes));",
        "    }",
        "} else {",
        "      outcome = "Error";",
        "      logger.message("AAD Passthru ROPC: No user or password found in shared state! Use username and password collector nodes before this script to populate shared and transient states!'");",
        "}",
        "logger.message("AAD Passthru ROPC: End (outcome=".concat(outcome).concat(")"));",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./AAcustomLogic.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "71e3b4ae-52c1-49d6-98fd-c279f43ea3ce": {
      "_id": "71e3b4ae-52c1-49d6-98fd-c279f43ea3ce",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "AAcustomLogic",
      "script": [
        "/*",
        "  - Data made available by nodes that have already executed are available in the sharedState variable.",
        "  - The script should set outcome to either "true" or "false".",
        " */",
        "outcome = "false";",
        "var predictionResult = sharedState.get("predictionResult");",
        "var predictionResultString = predictionResult.toString();",
        "",
        "var is_impossible_travel = 0;",
        "var is_credential_stuffing = 0;",
        "var is_automated_user_agent = 0;",
        "var is_brute_force = 0;",
        "var is_suspicious_ip = 0;",
        "",
        "var signal_count = 0;",
        "var position = 0;",
        "",
        "position = predictionResultString.search("is_impossible_travel=false");",
        "if(position<0)",
        "{",
        "  signal_count++;",
        "  is_impossible_travel=1;",
        "}",
        "position = predictionResultString.search("is_credential_stuffing=false");",
        "if(position<0)",
        "{",
        "  signal_count++;",
        "  is_credential_stuffing=1;",
        "}",
        "position = predictionResultString.search("is_automated_user_agent=false");",
        "if(position<0)",
        "{",
        "  signal_count++;",
        "  is_automated_user_agent=1;",
        "}",
        "position = predictionResultString.search("is_brute_force=false");",
        "if(position<0)",
        "{",
        "  signal_count++;",
        "  is_brute_force=1;",
        "}",
        "position = predictionResultString.search("is_suspicious_ip=false");",
        "if(position<0)",
        "{",
        "  signal_count++;",
        "  is_suspicious_ip=1;",
        "}",
        "",
        "sharedState.put("debug-signal-count",signal_count);",
        "if(signal_count>1)",
        "{",
        "     outcome="true"; ",
        "}",
        "",
        "",
        "",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./ADFS-Profile-Normalization-(JS).script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "dbe0bf9a-72aa-49d5-8483-9db147985a47": {
      "_id": "dbe0bf9a-72aa-49d5-8483-9db147985a47",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Normalizes raw profile data from ADFS",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "ADFS Profile Normalization (JS)",
      "script": [
        "/*",
        " * Copyright 2022 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        " * This script returns the social identity profile information for the authenticating user",
        " * in a standard form expected by the Social Provider Handler Node.",
        " *",
        " * Defined variables:",
        " * rawProfile - The social identity provider profile information for the authenticating user.",
        " *              JsonValue (1).",
        " * logger - The debug logger instance:",
        " *          https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.",
        " * realm - String (primitive).",
        " *         The name of the realm the user is authenticating to.",
        " * requestHeaders - TreeMap (2).",
        " *                  The object that provides methods for accessing headers in the login request:",
        " *                  https://backstage.forgerock.com/docs/am/7/authentication-guide/scripting-api-node.html#scripting-api-node-requestHeaders.",
        " * requestParameters - TreeMap (2).",
        " *                     The object that contains the authentication request parameters.",
        " * selectedIdp - String (primitive).",
        " *               The social identity provider name. For example: google.",
        " * sharedState - LinkedHashMap (3).",
        " *               The object that holds the state of the authentication tree and allows data exchange between the stateless nodes:",
        " *               https://backstage.forgerock.com/docs/am/7/auth-nodes/core-action.html#accessing-tree-state.",
        " * transientState - LinkedHashMap (3).",
        " *                  The object for storing sensitive information that must not leave the server unencrypted,",
        " *                  and that may not need to persist between authentication requests during the authentication session:",
        " *                  https://backstage.forgerock.com/docs/am/7/auth-nodes/core-action.html#accessing-tree-state.",
        " *",
        " * Return - a JsonValue (1).",
        " *          The result of the last statement in the script is returned to the server.",
        " *          Currently, the Immediately Invoked Function Expression (also known as Self-Executing Anonymous Function)",
        " *          is the last (and only) statement in this script, and its return value will become the script result.",
        " *          Do not use "return variable" statement outside of a function definition.",
        " *",
        " *          This script's last statement should result in a JsonValue (1) with the following keys:",
        " *          {",
        " *              {"displayName": "corresponding-social-identity-provider-value"},",
        " *              {"email": "corresponding-social-identity-provider-value"},",
        " *              {"familyName": "corresponding-social-identity-provider-value"},",
        " *              {"givenName": "corresponding-social-identity-provider-value"},",
        " *              {"id": "corresponding-social-identity-provider-value"},",
        " *              {"locale": "corresponding-social-identity-provider-value"},",
        " *              {"photoUrl": "corresponding-social-identity-provider-value"},",
        " *              {"username": "corresponding-social-identity-provider-value"}",
        " *          }",
        " *",
        " *          The consumer of this data defines which keys are required and which are optional.",
        " *          For example, the script associated with the Social Provider Handler Node and,",
        " *          ultimately, the managed object created/updated with this data",
        " *          will expect certain keys to be populated.",
        " *          In some common default configurations, the following keys are required to be not empty:",
        " *          username, givenName, familyName, email.",
        " *",
        " *          From RFC4517: A value of the Directory String syntax is a string of one or more",
        " *          arbitrary characters from the Universal Character Set (UCS).",
        " *          A zero-length character string is not permitted.",
        " *",
        " * (1) JsonValue - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/json/JsonValue.html.",
        " * (2) TreeMap - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/TreeMap.html.",
        " * (3) LinkedHashMap - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/LinkedHashMap.html.",
        " */",
        "",
        "(function () {",
        "    var frJava = JavaImporter(",
        "        org.forgerock.json.JsonValue",
        "    );",
        "",
        "    var normalizedProfileData = frJava.JsonValue.json(frJava.JsonValue.object());",
        "  ",
        "      //logger.message('Seguin rawProfile: '+rawProfile);",
        "",
        "    normalizedProfileData.put('id', rawProfile.get('sub').asString());",
        "    normalizedProfileData.put('displayName', rawProfile.get('givenName').asString() + ' ' + rawProfile.get('sn').asString());",
        "    normalizedProfileData.put('email', rawProfile.get('mail').asString());",
        "    normalizedProfileData.put('givenName', rawProfile.get('givenName').asString());",
        "    normalizedProfileData.put('familyName', rawProfile.get('sn').asString());",
        "    normalizedProfileData.put('username', rawProfile.get('upn').asString());",
        "    normalizedProfileData.put('roles', rawProfile.get('roles').asString());",
        "  ",
        "      //logger.message('Seguin normalizedProfileData: '+normalizedProfileData);",
        "",
        "    return normalizedProfileData;",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./APIProtection:-Get-Key-And-Secret.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "9399ac8b-3a6e-423b-95a2-6e0fd07262b1": {
      "_id": "9399ac8b-3a6e-423b-95a2-6e0fd07262b1",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "APIProtection: Get Key And Secret",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "APIProtection: Get Key And Secret",
      "script": [
        "logger.warning("APIProtection: Get Key And Secret: start");",
        "",
        "/*",
        " * BEGIN SCRIPT CONFIGURATION",
        " */",
        "var KEY_HEADER_NAME = "x-api-key";",
        "var SECRET_HEADER_NAME = "x-api-secret";",
        "var USERNAME_HEADER_NAME = "X-OpenAM-Username";",
        "var PASSWORD_HEADER_NAME = "X-OpenAM-Password";",
        "/*",
        " * END SCRIPT CONFIGURATION",
        " */",
        "",
        "outcome = "false";",
        "",
        "var key = getHeader(KEY_HEADER_NAME) || readValue(KEY_HEADER_NAME) || null;",
        "var secret = getHeader(SECRET_HEADER_NAME) || readTransientValue(SECRET_HEADER_NAME) || null;",
        "",
        "var username = sharedState.get("username") || null;",
        "var password = transientState.get("password") || null;",
        "",
        "if (key && secret) {",
        "    logger.warning("APIProtection: Get Key And Secret: key=".concat(key));",
        "  ",
        "      storeValue(KEY_HEADER_NAME, key);",
        "      storeValue("username", username);",
        "      sharedState.put("username", key);",
        "      ",
        "      storeTransientValue(SECRET_HEADER_NAME, secret);",
        "      storeTransientValue("password", password);",
        "      transientState.put("password", secret);",
        "  ",
        "    outcome = "true";",
        "}",
        "",
        "logger.warning("APIProtection: Get Key And Secret: finish [outcome=".concat(outcome).concat("]"));",
        "",
        "/*",
        " * Returns the value of the requested header",
        " */",
        "function getHeader(headerName) {",
        "      if (requestHeaders.get(headerName) && requestHeaders.get(headerName).get(0)) {",
        "        return requestHeaders.get(headerName).get(0).toString();",
        "    }",
        "      return null;",
        "}",
        "",
        "/*",
        " * Store value for APIProtection script use",
        " */",
        "function storeValue(name, value) {",
        "      var storage = sharedState.get("APIProtection");",
        "    if (storage && value) {",
        "          if (storage.put) {",
        "            storage.put(name, value);",
        "        }",
        "          else {",
        "              storage[name] = value;",
        "        }",
        "    }",
        "    else if (value) {",
        "        sharedState.put("APIProtection", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "    }",
        "}",
        "",
        "/*",
        " * Read value from storage for APIProtection script use",
        " */",
        "function readValue(name) {",
        "      var storage = sharedState.get("APIProtection");",
        "    if (storage) {",
        "          if (storage.get) {",
        "            return sharedState.get("APIProtection").get(name);",
        "        }",
        "          else {",
        "              return storage.name;",
        "        }",
        "    }",
        "      return null;",
        "}",
        "",
        "/*",
        " * Store transient value for APIProtection script use",
        " */",
        "function storeTransientValue(name, value) {",
        "    var transientStorage = transientState.get("APIProtection");",
        "    if (transientStorage && value) {",
        "          if (transientStorage.put) {",
        "            transientStorage.put(name, value);",
        "        }",
        "          else {",
        "              transientStorage[name] = value;",
        "        }",
        "    }",
        "    else if (value) {",
        "        transientState.put("APIProtection", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "    }",
        "}",
        "",
        "/*",
        " * Read transient value from storage for APIProtection script use",
        " */",
        "function readTransientValue(name) {",
        "      var transientStorage = transientState.get("APIProtection");",
        "    if (transientStorage) {",
        "          if (transientStorage.get) {",
        "            return transientState.get("APIProtection").get(name);",
        "        }",
        "          else {",
        "              return transientStorage.name;",
        "        }",
        "    }",
        "      return null;",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./APIProtection:-Reset-States.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "f1a2764b-d05a-4480-8f5f-78fda7814227": {
      "_id": "f1a2764b-d05a-4480-8f5f-78fda7814227",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "APIProtection: Reset State",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "APIProtection: Reset States",
      "script": [
        "logger.warning("APIProtection: Reset States: start");",
        "",
        "/*",
        " * BEGIN SCRIPT CONFIGURATION",
        " *",
        " * Outcomes:",
        " * - "true"",
        " */",
        "var KEY_HEADER_NAME = "x-api-key";",
        "var SECRET_HEADER_NAME = "x-api-secret";",
        "/*",
        " * END SCRIPT CONFIGURATION",
        " */",
        "",
        "outcome = "true";",
        "",
        "if (sharedState.get("username") == readValue(KEY_HEADER_NAME)) {",
        "    logger.warning("APIProtection: Reset States: resetting username to:".concat(readValue("username")));",
        "      sharedState.put("username", readValue("username"));",
        "}",
        "",
        "if (transientState.get("password") == readTransientValue(SECRET_HEADER_NAME)) {",
        "    logger.warning("APIProtection: Reset States: resetting password");",
        "      transientState.put("password", readTransientValue("password"));",
        "}",
        "",
        "logger.warning("APIProtection: Reset States: finish [outcome=".concat(outcome).concat("]"));",
        "",
        "/*",
        " * Read value from storage for APIProtection script use",
        " */",
        "function readValue(name) {",
        "      var storage = sharedState.get("APIProtection");",
        "    if (storage) {",
        "          if (storage.get) {",
        "            return sharedState.get("APIProtection").get(name);",
        "        }",
        "          else {",
        "              return storage.name;",
        "        }",
        "    }",
        "      return null;",
        "}",
        "",
        "/*",
        " * Read transient value from storage for APIProtection script use",
        " */",
        "function readTransientValue(name) {",
        "      var transientStorage = transientState.get("APIProtection");",
        "    if (transientStorage) {",
        "          if (transientStorage.get) {",
        "            return transientState.get("APIProtection").get(name);",
        "        }",
        "          else {",
        "              return transientStorage.name;",
        "        }",
        "    }",
        "      return null;",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Admin_AmadminCheck.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "b7ce17a1-e41d-42b0-bedc-f88a4d5e1c3a": {
      "_id": "b7ce17a1-e41d-42b0-bedc-f88a4d5e1c3a",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Prepares onboarding check if not amadmin",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_AmadminCheck",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "var fr = new JavaImporter(",
        "  java.util.HashMap",
        ");",
        "",
        "with (fr) {",
        "  try {",
        "    ",
        "    if (sharedState.get('username').toLowerCase() == 'amadmin') {",
        "      outcome = 'True';",
        "    } else {",
        "      outcome = 'False';",
        "    }",
        "    ",
        "  } catch (e) {",
        "",
        "    logger.error('Failed to determine if user is amadmin: {}', e);",
        "    outcome = 'Error';",
        "",
        "  }",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Admin_AttributeCollectionWorkaroundCleanup.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "fd536b1f-6ee4-4505-b148-71160414ddcc": {
      "_id": "fd536b1f-6ee4-4505-b148-71160414ddcc",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_AttributeCollectionWorkaroundCleanup",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        "This is the second part of a workaround began in Admin_AttributeCollectionWorkaround.",
        "*/",
        "",
        "var objAttrs = sharedState.get('objectAttributes') || new HashMap();",
        "",
        "if (objAttrs.containsKey('groups')) {",
        "  var groups = objAttrs.get('groups');",
        "  if (groups.length == 1 && groups[0] == 'fake') {",
        "    objAttrs.remove('groups');",
        "  }",
        "}",
        "",
        "if (objAttrs.containsKey('inviteDate') && objAttrs.get('inviteDate') == 'fake') {",
        "   objAttrs.remove('inviteDate');",
        "}",
        "",
        "sharedState.put('objectAttributes', objAttrs);",
        "",
        "outcome = 'True';",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Admin_CanBeInvited.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "0d471aff-81f3-41ce-8bf9-35c27cdc0a26": {
      "_id": "0d471aff-81f3-41ce-8bf9-35c27cdc0a26",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_CanBeInvited",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "(function() {",
        "  var fr = new JavaImporter(",
        "    org.forgerock.openam.auth.nodes,",
        "    org.forgerock.guice.core",
        "  );",
        "",
        "  with (fr) {",
        "    try {",
        "",
        "      outcome = 'False';",
        "",
        "      var realm = sharedState.get('realm');",
        "      var uuid = sharedState.get('username');",
        "      var identityProvider = InjectorHolder.getInstance(IdentityProvider);",
        "      var identity = identityProvider.getIdentity(uuid, realm);",
        "      var attrs = identity.getAttributes();",
        "",
        "      if (!attrs.containsKey('fr-idm-inviteDate')) {",
        "        logger.message('Admin cannot be invited: no invite date');",
        "        return;",
        "      }",
        "",
        "      if (attrs.containsKey('fr-idm-onboardDate')) {",
        "        logger.message('Admin cannot be invited: already onboarded');",
        "        return;",
        "      }",
        "",
        "      var email = attrs.get('mail').iterator().next();",
        "      var objAttrs = {",
        "        mail: email,",
        "        userName: email,",
        "      };",
        "      sharedState.put('objectAttributes', objAttrs);",
        "",
        "      logger.message('Admin can be invited');",
        "      outcome = 'True';",
        "",
        "    } catch (e) {",
        "",
        "      logger.error('Failed to determine if admin can be invited: {}', e);",
        "",
        "    }",
        "  }",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Admin_ClearCurrentYear.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "4a9aefc4-be0e-4625-95c3-ee8f354bce35": {
      "_id": "4a9aefc4-be0e-4625-95c3-ee8f354bce35",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_ClearCurrentYear",
      "script": [
        "if (sharedState.containsKey('objectAttributes')) {",
        "  sharedState.get('objectAttributes').remove('currentYear');",
        "}",
        "",
        "outcome = 'True';",
        "",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Admin_CollectUsernameOrEmail.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "e9c9d940-30d9-4a0c-a834-7de69a0600cf": {
      "_id": "e9c9d940-30d9-4a0c-a834-7de69a0600cf",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_CollectUsernameOrEmail",
      "script": [
        "var fr = JavaImporter(",
        "  org.forgerock.json.JsonValue,",
        "  org.forgerock.openam.auth.node.api.Action,",
        "  javax.security.auth.callback.NameCallback,",
        "  java.util.HashMap",
        ");",
        "",
        "with (fr) {",
        "  try {",
        "    ",
        "    if (callbacks.isEmpty()) {",
        "      ",
        "      action = Action.send(new NameCallback('Username or email address')).build();",
        "      ",
        "    } else {",
        "",
        "      // If a value is provided, store it as username and an object attribute",
        "      var callback = callbacks.iterator().next();",
        "      var name = callback.getName().trim();",
        "      if (name) {",
        "        var objAttrs = sharedState.get('objectAttributes') || new HashMap();",
        "        objAttrs.put('mail', name);",
        "        sharedState.put('username', name);",
        "        sharedState.put('objectAttributes', objAttrs);",
        "",
        "        action = Action.goTo('Collected').build();",
        "      }",
        "      ",
        "    }",
        "    ",
        "  } catch (e) {",
        "    ",
        "    logger.error('Admin_CollectUsernameOrEmail: {}', e);",
        "    action = Action.goTo('Error').build();",
        "    ",
        "  }",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Admin_EnableEmailClaimCheck.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "cfb208d8-241c-4953-b87b-bf59d1ab3d05": {
      "_id": "cfb208d8-241c-4953-b87b-bf59d1ab3d05",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_EnableEmailClaimCheck",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "nodeState.putShared('checkEmailClaim', true);",
        "",
        "outcome = 'True';",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Admin_ForgotUsernameMailCheck.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "5e68fee3-047d-4fff-8e99-89fb5908f068": {
      "_id": "5e68fee3-047d-4fff-8e99-89fb5908f068",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_ForgotUsernameMailCheck",
      "script": [
        "var fr = new JavaImporter(",
        "  org.forgerock.openam.auth.nodes,",
        "  org.forgerock.guice.core,",
        "  java.util.HashMap",
        ");",
        "",
        "// This confirms the Identify Existing User node was able to find the",
        "// admin, otherwise we remove the mail attribute so no email can be sent",
        "with (fr) {",
        "  try {",
        "",
        "    var objAttrs = sharedState.get('objectAttributes') || new HashMap();",
        "    var username = objAttrs.get('userName');",
        "    outcome = username ? 'Valid' : 'Invalid';",
        "    if (username) {",
        "      outcome = 'Valid';",
        "    } else {",
        "      objAttrs.remove('mail');",
        "      sharedState.put('objectAttributes', objAttrs);",
        "      outcome = 'Invalid';",
        "    }",
        "",
        "    logger.message('Admin_ForgotUsernameMailCheck: ' + outcome);",
        "",
        "  } catch (e) {",
        "",
        "    logger.error('Admin_ForgotUsernameMailCheck: Failed to determine mail validity');",
        "    logger.error(e);",
        "    outcome = 'Error';",
        "",
        "  }",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Admin_GetIdPGroupsClaimConfig.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "fd560219-00ad-4763-9a29-f65aa9ecf776": {
      "_id": "fd560219-00ad-4763-9a29-f65aa9ecf776",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_GetIdPGroupsClaimConfig",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        " * This script is used to retrieve optional custom IdP configuration from IDM as an admin",
        " * completes a login journey. This needs to happen after an IdP has been selected so that",
        " * the \`selectedIdp\` exists in shared state. The result will be stored in a shared state",
        " * key of \`idpCustomConfig\`. The value will be \`null\` if no config was found in IDM.",
        " */",
        "",
        "var AM_INTERNAL_URL = 'http://am.fr-platform:80/am';",
        "var IDM_INTERNAL_URL = 'http://idm.fr-platform:80/openidm';",
        "var RSFILTER_PROVISIONING_CLIENT_ID = 'idm-provisioning';",
        "var RSFILTER_PROVISIONING_SECRET = 'DKNK5K2m5Q98tBTt0yei';",
        "",
        "var SHARED_STATE_KEY = 'idpCustomConfig';",
        "var TXN_ID_HEADER = 'x-forgerock-transactionid';",
        "",
        "// Helper for returning the request transaction ID",
        "function getTransId() {",
        "  var transIds = requestHeaders.get(TXN_ID_HEADER);",
        "  if (transIds) {",
        "    return java.lang.String(transIds.get(0));",
        "  }",
        "  return null;",
        "}",
        "",
        "// Retrieves an access token using a client credentials grant",
        "function getAccessToken(txnId, clientId, clientSecret, scope) {",
        "  var fr = JavaImporter(",
        "    java.lang.String,",
        "    org.forgerock.http.protocol.Request,",
        "    org.forgerock.http.protocol.Response,",
        "    org.forgerock.util.encode.Base64",
        "  );",
        "",
        "  var basicAuthCreds = fr.Base64.encode(new fr.String(clientId + ':' + clientSecret).getBytes('UTF-8'));",
        "",
        "  var request = new fr.Request();",
        "  request.getHeaders().add('authorization', 'Basic ' + basicAuthCreds);",
        "  request.getHeaders().add('content-type', 'application/x-www-form-urlencoded');",
        "  if (txnId) {",
        "    request.getHeaders().add(TXN_ID_HEADER, txnId);",
        "  }",
        "  request",
        "    .setEntity('grant_type=client_credentials&scope=' + scope)",
        "    .setMethod('POST')",
        "    .setUri(AM_INTERNAL_URL + '/oauth2/access_token');",
        "",
        "  var response = httpClient.send(request).getOrThrow();",
        "  if (response.getStatus() === org.forgerock.http.protocol.Status.OK) {",
        "    var result = JSON.parse(response.getEntity().getString());",
        "    logger.message('got access token for client {}', clientId);",
        "    return result.access_token;",
        "  }",
        "  ",
        "  logger.error('failed to get access token for client {}; received status {}', clientId, response.getStatus());",
        "  throw 'failed to get access token';",
        "}",
        "",
        "// Retrieves the IdP custom configuration from IDM",
        "function getConfigFromIDM(txnId, accessToken, idp) {",
        "  var fr = JavaImporter(",
        "    org.forgerock.http.protocol.Request,",
        "    org.forgerock.http.protocol.Response,",
        "    org.forgerock.json.JsonValue,",
        "    org.forgerock.openam.placeholder.substitution.PlaceholderSubstitution,",
        "    org.forgerock.guice.core.InjectorHolder",
        "  );",
        "",
        "  var request = new fr.Request();",
        "  request.getHeaders().add('authorization', 'Bearer ' + accessToken);",
        "  if (txnId) {",
        "    request.getHeaders().add(TXN_ID_HEADER, txnId);",
        "  }",
        "  request",
        "    .setMethod('GET')",
        "    .setUri(IDM_INTERNAL_URL + '/config/fidc/federation-' + idp);",
        "",
        "  var response = httpClient.send(request).getOrThrow();",
        "  if (response.getStatus() === org.forgerock.http.protocol.Status.OK) {",
        "    var rawConfig = JSON.parse(response.getEntity().getString());",
        "    var placeholder = fr.InjectorHolder.getInstance(fr.PlaceholderSubstitution);",
        "    var finalConfig = JSON.parse(placeholder.substitute(fr.JsonValue.json(rawConfig)));",
        "    return finalConfig;",
        "  } else if (response.getStatus() === org.forgerock.http.protocol.Status.NOT_FOUND) {",
        "    return null;",
        "  }",
        "  ",
        "  logger.error('failed to get groups claim config for IdP {}; received status {}', idp, response.getStatus());",
        "  throw 'failed to get groups claim config';",
        "}",
        "",
        "(function () {",
        "  try {",
        "    var idp = nodeState.get('selectedIdp');",
        "    if (!idp.isString()) {",
        "      throw 'selectedIdp not found in shared state';",
        "    }",
        "",
        "    var txnId = getTransId();",
        "    var accessToken = getAccessToken(txnId, RSFILTER_PROVISIONING_CLIENT_ID, RSFILTER_PROVISIONING_SECRET, 'fr:idm:*');",
        "",
        "    var config = getConfigFromIDM(txnId, accessToken, idp.asString())",
        "    if (config) {",
        "      nodeState.putShared(SHARED_STATE_KEY, config);",
        "      logger.message('found groups claim config for IdP {}', idp.asString());",
        "    } else {",
        "      logger.message('no groups claim config found for IdP {}', idp.asString());",
        "    }",
        " ",
        "    outcome = 'Success';",
        "  } catch (e) {",
        "    logger.error('failed to get federation config from IDM: {}', e);",
        "    outcome = 'Error';",
        "  }",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Admin_HasOnboarded.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "13b6a418-4ccc-41b6-86ce-0a13f352da22": {
      "_id": "13b6a418-4ccc-41b6-86ce-0a13f352da22",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_HasOnboarded",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "(function() {",
        "  var fr = new JavaImporter(",
        "    org.forgerock.openam.auth.nodes,",
        "    org.forgerock.guice.core",
        "  );",
        "",
        "  with (fr) {",
        "    try {",
        "",
        "      outcome = 'False';",
        "",
        "      var realm = sharedState.get('realm');",
        "      var uuid = sharedState.get('_id');",
        "      var identityProvider = InjectorHolder.getInstance(IdentityProvider);",
        "      var identity = identityProvider.getIdentity(uuid, realm);",
        "      var attrs = identity.getAttributes();",
        "",
        "      if (attrs.containsKey('fr-idm-onboardDate')) {",
        "        logger.message('Admin has onboard date');",
        "        outcome = 'True';",
        "      }",
        "",
        "    } catch (e) {",
        "",
        "      logger.error('Failed to determine if admin has onboarded: {}', e);",
        "      outcome = 'Error';",
        "",
        "    }",
        "  }",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Admin_IdPNormalization.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "dc0c9905-4a58-4f61-8562-337514e610a7": {
      "_id": "dc0c9905-4a58-4f61-8562-337514e610a7",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_IdPNormalization",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        " * This script maps token claim values to managed object attributes. It uses a "claim map" that defines",
        " * several common claim names for a given attribute so that this same script can be used for all IdPs.",
        " * For example, the attribute \`familyName\` can be populated from claims \`familyName\`, \`family_name\`, or \`sn\`.",
        " * ",
        " * Also, if custom IdP config exists in shared state and defines IdP-to-IDC group membership mappings,",
        " * those will be applied/enforced by this script. ",
        " */",
        "",
        "var SHARED_STATE_KEY = 'idpCustomConfig';",
        "",
        "// Helper to avoid strict comparison of string objects",
        "function containsGroup(jsArray, javaString) {",
        "  for (var i = 0; i < jsArray.length; i++) {",
        "    if (jsArray[i] == javaString) {",
        "      return true;",
        "    }",
        "  }",
        "  return false;",
        "}",
        "",
        "(function () {",
        "  var fr = JavaImporter(",
        "    java.lang.String,",
        "    java.util.ArrayList,",
        "    org.forgerock.json.JsonValue",
        "  );",
        "  ",
        "  var normalizedProfileData = fr.JsonValue.json(fr.JsonValue.object());",
        "  var idpConfig = sharedState.get(SHARED_STATE_KEY);",
        "",
        "  // If we have config that defines a groups claim map for this IdP, ensure the claim value matches one that's in the map",
        "  if (idpConfig && idpConfig.groups) {",
        "",
        "    logger.message('enforcing groups claim config');",
        "",
        "    // Get the groups claim from the IdP profile",
        "    var groupsClaim = rawProfile.get(idpConfig.groups.claim);",
        "    if (groupsClaim.isNull()) {",
        "      logger.error('groups claim map was enabled for "{}", but claim "{}" was not found in the raw profile', selectedIdp, idpConfig.groups.claim);",
        "      throw 'Required groups claim is missing from raw profile';",
        "    }",
        "",
        "    logger.message('received group claim value {}', groupsClaim);",
        "",
        "    // Validate the claim type and convert strings to single-value collection",
        "    var groupsClaimList;",
        "    if (groupsClaim.isCollection()) {",
        "      groupsClaimList = groupsClaim;",
        "    } else if (groupsClaim.isString()) {",
        "      groupsClaimList = new fr.ArrayList();",
        "      groupsClaimList.add(groupsClaim);",
        "    } else {",
        "      throw 'Groups claim was not a string or collection';",
        "    }",
        "    ",
        "    // Assert the claim contains at least one group",
        "    var groupsClaimLen = groupsClaimList.size();",
        "    if (groupsClaimLen < 1) {",
        "      throw 'An empty groups claim was found in raw profile';",
        "    }",
        "",
        "    // Loop through each IDC group name in the map. If the raw profile groups claim contains",
        "    // a value that matches the map for that IDC group, add that IDC group to the list for this admin.",
        "    var groups = [];",
        "    for (var idcGroupName in idpConfig.groups.mappings) {",
        "      for (var i = 0; i < groupsClaimLen; i++) {",
        "        var claimGroupId = groupsClaimList.get(i).asString();",
        "",
        "        logger.message('checking if mapping for IDC group "{}" contains claim value "{}"', idcGroupName, claimGroupId);",
        "",
        "        if (containsGroup(idpConfig.groups.mappings[idcGroupName], claimGroupId)) {",
        "          groups.push(idcGroupName);",
        "        }",
        "      }",
        "    }",
        "",
        "    // Assert at least one group was mapped to the claim",
        "    if (groups.length == 0) {",
        "      logger.error('groups claim map was enabled for "{}", but the value of claim "{}" did not match a group mapping', selectedIdp, idpConfig.groups.claim);",
        "      throw 'Raw profile groups claim value does not match a configured mapping';",
        "    }",
        "",
        "    normalizedProfileData.put('groups', groups);",
        "    sharedState.put('groups', groups);",
        "  } else {",
        "    logger.message('no enabled groups claim config to enforce');",
        "  }",
        "",
        "  // Maps normalized profile keys to the possible raw profile keys that values can come from",
        "  var claimMap = {",
        "    email: ['email', 'mail'],",
        "    familyName: ['familyName', 'family_name', 'sn'],",
        "    givenName: ['givenName', 'given_name']",
        "  };",
        "",
        "  // Try to populate each normalized profile property",
        "  var keys = Object.keys(claimMap);",
        "  for (var i = 0; i < keys.length; i++) {",
        "    var normalizedProp = keys[i];",
        "    // Try each mapped raw profile key until a value is found",
        "    for (var j = 0; j < claimMap[normalizedProp].length; j++) {",
        "      var rawProp = claimMap[normalizedProp][j];",
        "      if (!rawProfile.get(rawProp).isNull()) {",
        "        normalizedProfileData.put(normalizedProp, rawProfile.get(rawProp));",
        "        break;",
        "      }",
        "    }",
        "  }",
        "",
        "  return normalizedProfileData;",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Admin_IsFederationEnforcedForUser.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "1e8175a2-6114-415f-9b72-9fe15bdf3661": {
      "_id": "1e8175a2-6114-415f-9b72-9fe15bdf3661",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_IsFederationEnforcedForUser",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "var fr = new JavaImporter(",
        "  org.forgerock.openam.auth.nodes,",
        "  org.forgerock.guice.core",
        ");",
        "",
        "with (fr) {",
        "  var enforcement = 'none';",
        "",
        "  function isSuperAdmin() {",
        "    var uuid = sharedState.get('_id');",
        "    var realm = sharedState.get('realm');",
        "    var identityProvider = InjectorHolder.getInstance(IdentityProvider);",
        "    var identity = identityProvider.getIdentity(uuid, realm);",
        "    var groups = identity.getAttribute('fr-attr-group').toArray();",
        "    for (var i = 0; i < groups.length; i++) {",
        "      if (groups[i] == 'super-admins') {",
        "        return true;",
        "      }",
        "    }",
        "    return false;",
        "  }",
        "",
        "  try {",
        "    switch (enforcement) {",
        "      case 'none':",
        "        outcome = 'False';",
        "        break;",
        "      case 'all':",
        "        outcome = 'True';",
        "        break;",
        "      default:",
        "        outcome = isSuperAdmin() ? 'False' : 'True';",
        "        break;",
        "    }",
        "  } catch (e) {",
        "    logger.error('Failed to determine if federation is enforced for user: {}', e);",
        "    outcome = 'Error';",
        "  }",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Admin_IsInvited.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "6dfc6de4-64cb-4d47-8269-6c5ced44344d": {
      "_id": "6dfc6de4-64cb-4d47-8269-6c5ced44344d",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_IsInvited",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "if (sharedState.get('invited') == true) {",
        "  outcome = 'True';",
        "} else {",
        "  outcome = 'False';",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Admin_LoadObjectByID.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "b88ce1fe-2480-4fd5-8062-2bd1f4659e2e": {
      "_id": "b88ce1fe-2480-4fd5-8062-2bd1f4659e2e",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_LoadObjectByID",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        " * This is a utility script to simplify access to admin identity properties. It",
        " * requires that \`sharedState._id\` be populated, which can be loaded using an",
        " * Identify Existing User node.",
        " */",
        "",
        "function val(attrs, name) {",
        "  if (attrs.containsKey(name)) {",
        "    return attrs.get(name).iterator().next();",
        "  }",
        "  return '';",
        "}",
        "",
        "(function() {",
        "  var fr = new JavaImporter(",
        "    org.forgerock.openam.auth.nodes,",
        "    org.forgerock.guice.core",
        "  );",
        "",
        "  with (fr) {",
        "    try {",
        "",
        "      outcome = 'False';",
        "",
        "      if (!sharedState.containsKey('_id')) {",
        "        throw 'Required sharedState property _id is missing';",
        "      }      ",
        "      ",
        "      var realm = sharedState.get('realm');",
        "      var uuid = sharedState.get('_id');",
        "      ",
        "      var identityProvider = InjectorHolder.getInstance(IdentityProvider);",
        "      var identity = identityProvider.getIdentity(uuid, realm);",
        "      var attrs = identity.getAttributes();",
        "      ",
        "      sharedState.put('adminObject', {",
        "        givenName: val(attrs, 'givenName'),        ",
        "        sn: val(attrs, 'sn'),",
        "        mail: val(attrs, 'mail'),",
        "        inviteDate: val(attrs, 'fr-idm-inviteDate'),",
        "        onboardDate: val(attrs, 'fr-idm-onboardDate')        ",
        "      });",
        "",
        "      logger.message('Loaded admin object for id: {}', uuid);",
        "",
        "      outcome = 'True';",
        "",
        "    } catch (e) {",
        "      logger.error('Failed to load admin object: {}', e);",
        "    }",
        "  }",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Admin_LocalRegistrationPrep.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "a316aedd-8b3b-4f68-b6e8-65859f1e87be": {
      "_id": "a316aedd-8b3b-4f68-b6e8-65859f1e87be",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_LocalRegistrationPrep",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        "When an admin managed object is created at the time of invitation, the email address",
        "is used to populate the required first/last names.  This script clears those attributes",
        "(if set to the email address) so the UI doesn't display the email address in the first/last",
        "name input fields.",
        "",
        "It also populates other required attributes with fake values to ensure password policy",
        "validation works correctly when AM calls IDM.",
        "*/",
        "",
        "var objAttrs = sharedState.get('objectAttributes') || new java.util.HashMap();",
        "objAttrs.put('givenName', '');",
        "objAttrs.put('sn', '');",
        "objAttrs.put('groups', ['fake']);",
        "objAttrs.put('inviteDate', 'fake');",
        "sharedState.put('objectAttributes', objAttrs);",
        "",
        "outcome = 'True';",
        "",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Admin_MfaGetApp.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "fe35a8fb-31b1-441c-bb9b-27932565061c": {
      "_id": "fe35a8fb-31b1-441c-bb9b-27932565061c",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_MfaGetApp",
      "script": [
        "/*",
        "This creates the following callbacks:",
        "- TextOutputCallback: Display the step title and description",
        "- ConfirmationCallback: Display the "Next" button",
        "- HiddenValueCallback: Captures the "Get app" option, if selected",
        "- ScriptTextOutputCallback: Creates a "Download the app" link button and positions it below the "Next" button",
        "*/",
        "",
        "var token = generateNumericToken('xxx');",
        "var loadingMessage = 'Loading...';",
        "var linkButton = "<button id='getapp-link-".concat(token).concat("' class='btn btn-block btn-link' type='submit'>Download the app</button>");",
        "var message = "<h2 class='h2'>Set up the ForgeRock Authenticator</h2><div style='margin-bottom:1em'>To get started, you need to register your device using the ForgeRock Authenticator app.</div>";",
        "var choices = ['Next'];",
        "var defaultChoice = 0;",
        "var getAppValue = 'Get app';",
        "var getAppInputId = 'getapp-input-'.concat(token);",
        "",
        "var setupPageScript =",
        "  'var setupPage = function() {'.concat(",
        "  '  var getAppInputElem = document.getElementById("').concat(getAppInputId).concat('");').concat(",
        "  '  var messageElem;').concat(",
        "  '  document.getElementsByClassName("callback-component").forEach(').concat(",
        "  '    function (e) {').concat(",
        "  '      var m = e.firstElementChild;').concat(",
        "  '      if (m.firstChild && m.firstChild.nodeName == "#text" && m.firstChild.nodeValue.trim() == "').concat(loadingMessage).concat('") {').concat(",
        "  '        messageElem = m;').concat(",
        "  '      }').concat(",
        "  '    }').concat(",
        "  '  );').concat(",
        "  '  if (!getAppInputElem || !messageElem) {').concat(",
        "  '    return setTimeout(setupPage, 50);').concat(",
        "  '  }').concat(",
        "  '  var skipContainer = document.createElement("div");').concat(",
        "  '  skipContainer.style = "width:100%";').concat(",
        "  '  skipContainer.innerHTML = "').concat(linkButton).concat('";').concat(",
        "  '  getAppInputElem.parentNode.append(skipContainer);').concat(",
        "  '  messageElem.align = "center";').concat(",
        "  '  messageElem.innerHTML = "').concat(message).concat('";').concat(",
        "  '  var bindGetAppLink = function() {').concat(",
        "  '    document.getElementById("getapp-link-').concat(token).concat('").onclick = function() {').concat(",
        "  '      getAppInputElem.value = "').concat(getAppValue).concat('";').concat(",
        "  '      document.getElementById("loginButton_0").click();').concat(",
        "  '      return false;').concat(",
        "  '    };').concat(",
        "  '  };').concat(",
        "  '  setTimeout(bindGetAppLink, 100);').concat(",
        "  '};').concat(",
        "  'setupPage();');",
        "",
        "var fr = JavaImporter(",
        "  org.forgerock.openam.auth.node.api.Action,",
        "  javax.security.auth.callback.ConfirmationCallback,",
        "  javax.security.auth.callback.TextOutputCallback,",
        "  com.sun.identity.authentication.callbacks.HiddenValueCallback,",
        "  com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        ")",
        "",
        "with (fr) {",
        "  if (callbacks.isEmpty()) {",
        "    action = Action.send(",
        "      new TextOutputCallback(",
        "          TextOutputCallback.INFORMATION,",
        "          loadingMessage",
        "      ),",
        "      new ConfirmationCallback(",
        "          ConfirmationCallback.INFORMATION,",
        "          choices,",
        "          defaultChoice",
        "      ),",
        "      new HiddenValueCallback(getAppInputId, 'false'),",
        "      new ScriptTextOutputCallback(setupPageScript)",
        "    ).build()",
        "  } else {",
        "    if (callbacks.get(2).getValue() == getAppValue) {",
        "      action = Action.goTo(getAppValue).build();",
        "    } else {",
        "      action = Action.goTo(choices[callbacks.get(1).getSelectedIndex()]).build();",
        "    }",
        "  }",
        "}",
        "",
        " /*",
        "  * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "  * ",
        "  * Example:",
        "  * 'xxxxx' produces '28535'",
        "  * 'xxx-xxx' produces '432-521'",
        "  */",
        "function generateNumericToken(format) {",
        "  return format.replace(/[x]/g, function(c) {",
        "    var r = Math.random()*10|0;",
        "    var v = r;",
        "    return v.toString(10);",
        "  });",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Admin_MfaOptIn.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "158e500b-8180-4641-ad48-23577fe9d976": {
      "_id": "158e500b-8180-4641-ad48-23577fe9d976",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_MfaOptIn",
      "script": [
        "/*",
        "This creates the following callbacks:",
        "- TextOutputCallback: Display the step title and description",
        "- ConfirmationCallback: Display a list of buttons for choices",
        "- HiddenValueCallback: Captures the "skip" option, if selected",
        "- ScriptTextOutputCallback: Creates a "Skip for now" link button and positions it below the buttons ",
        "*/",
        "",
        "var token = generateNumericToken('xxx');",
        "var loadingMessage = 'Loading...';",
        "var linkButton = "<button id='skip-link-".concat(token).concat("' class='btn btn-block btn-link' type=submit>Skip for now</button>");",
        "var message = "<h2 class=h2>Set up 2-step verification</h2><div style='margin-bottom:1em'>Protect your account by adding a second step after entering your password to verify it's you signing in.</div>";",
        "var choices = ['Set up'];",
        "var defaultChoice = 0;",
        "var skipValue = 'Skip';",
        "",
        "// This will run recursively in the browser until references can be obtained to key DOM elements, at which point.",
        "// it will customize the DOM.  This is to avoid race conditions with the UI rendering callbacks.",
        "var setupPageScript =",
        "  'var setupPage = function() {'.concat(",
        "  '  var skipInputElem = document.getElementById("skip-input-').concat(token).concat('");').concat(",
        "  '  var messageElem;').concat(",
        "  '  document.getElementsByClassName("callback-component").forEach(').concat(",
        "  '    function (e) {').concat(",
        "  '      var m = e.firstElementChild;').concat(",
        "  '      if (m.firstChild && m.firstChild.nodeName == "#text" && m.firstChild.nodeValue.trim() == "').concat(loadingMessage).concat('") {').concat(",
        "  '        messageElem = m;').concat(",
        "  '      }').concat(",
        "  '    }').concat(",
        "  '  );').concat(",
        "  '  if (!skipInputElem || !messageElem) {').concat(",
        "  '    return setTimeout(setupPage, 50);').concat(",
        "  '  }').concat(",
        "  '  var skipContainer = document.createElement("div");').concat(",
        "  '  skipContainer.style = "width:100%";').concat(",
        "  '  skipContainer.innerHTML = "').concat(linkButton).concat('";').concat(",
        "  '  skipInputElem.parentNode.append(skipContainer);').concat(",
        "  '  messageElem.align = "center";').concat(",
        "  '  messageElem.innerHTML = "').concat(message).concat('";').concat(",
        "  '  var bindSkipLink = function() {').concat(",
        "  '    document.getElementById("skip-link-').concat(token).concat('").onclick = function() {').concat(",
        "  '      skipInputElem.value = "').concat(skipValue).concat('";').concat(",
        "  '      document.getElementById("loginButton_0").click();').concat(",
        "  '      return false;').concat(",
        "  '    };').concat(",
        "  '  };').concat(",
        "  '  setTimeout(bindSkipLink, 100);').concat(",
        "  '};').concat(",
        "  'setupPage();');",
        "",
        "var fr = JavaImporter(",
        "  org.forgerock.openam.auth.node.api.Action,",
        "  javax.security.auth.callback.ConfirmationCallback,",
        "  javax.security.auth.callback.TextOutputCallback,",
        "  com.sun.identity.authentication.callbacks.HiddenValueCallback,",
        "  com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        ")",
        "",
        "with (fr) {",
        "  if (callbacks.isEmpty()) {",
        "    action = Action.send(",
        "      new TextOutputCallback(",
        "          TextOutputCallback.INFORMATION,",
        "          loadingMessage",
        "      ),",
        "      new ConfirmationCallback(",
        "          ConfirmationCallback.INFORMATION,",
        "          choices,",
        "          defaultChoice",
        "      ),",
        "      new HiddenValueCallback('skip-input-'.concat(token), 'false'),",
        "      new ScriptTextOutputCallback(setupPageScript)",
        "    ).build()",
        "  } else {",
        "    if (callbacks.get(2).getValue() == skipValue) {",
        "      action = Action.goTo(skipValue).build();",
        "    } else {",
        "      action = Action.goTo(choices[callbacks.get(1).getSelectedIndex()]).build();",
        "    }",
        "  }",
        "}",
        "",
        " /*",
        "  * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "  * ",
        "  * Example:",
        "  * 'xxxxx' produces '28535'",
        "  * 'xxx-xxx' produces '432-521'",
        "  */",
        "function generateNumericToken(format) {",
        "  return format.replace(/[x]/g, function(c) {",
        "    var r = Math.random()*10|0;",
        "    var v = r;",
        "    return v.toString(10);",
        "  });",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Admin_MfaRequiredCheck.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "4c7bb7bb-c5d6-47ac-92dc-256fb8121fa9": {
      "_id": "4c7bb7bb-c5d6-47ac-92dc-256fb8121fa9",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_MfaRequiredCheck",
      "script": [
        "if ("false" == "true") {",
        "  outcome = "Required";",
        "} else {",
        "  outcome = "Optional";",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Admin_PasswordFixEnd.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "27f1b5a3-9446-4e5c-b965-f195a99fa666": {
      "_id": "27f1b5a3-9446-4e5c-b965-f195a99fa666",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_PasswordFixEnd",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        "This restores sharedState.objectAttributes temporarily overwritten to fix an issue with password policy.",
        "*/",
        "",
        "//var password = '';",
        "//var objAttrs = sharedState.get('objectAttributes');",
        "//if (objAttrs && objAttrs.containsKey('password')) {",
        "//  password = objAttrs.get('password');",
        "//}",
        "",
        "// Restore original object attributes",
        "var origObjAttrs = sharedState.get('originalObjectAttributes');",
        "if (origObjAttrs) {",
        "//  if (password) {",
        "//    origObjAttrs.put('password', password);",
        "//  }",
        "  sharedState.put('objectAttributes', origObjAttrs);",
        "}",
        "",
        "outcome = 'True';",
        "",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Admin_PasswordFixStart.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "4accb4d0-56ec-4a28-a769-5275dbac3147": {
      "_id": "4accb4d0-56ec-4a28-a769-5275dbac3147",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_PasswordFixStart",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        "This is a workaround that fixes an issue with password policy.",
        "",
        "The Platform Password node attempts to validate a password by calling IDM's validateProperty action, and it uses",
        "sharedState.objectAttributes as the \`object\` property of that request payload.  If the request is missing required properties",
        "or contains properties not in the object's schema, DS will error and IDM will swallow that error, returning an empty ",
        "list of failed policies instead.",
        "",
        "This workaround provides fake values for required properties. It also ensures first/last name is in objectAttributes so the",
        ""can't contain" policy can be evaluated. This workaround is cleaned up by Admin_PasswordFixEnd.js.",
        "*/",
        "",
        "// Capture existing object attributes so we can restore them later",
        "if (sharedState.containsKey('objectAttributes')) {",
        "  sharedState.put('originalObjectAttributes', sharedState.get('objectAttributes'));",
        "}",
        "",
        "// Define the object to use for policy evaluation",
        "var policyObject = {",
        "  givenName: '',",
        "  sn: '',",
        "  groups: ['fake'],",
        "  inviteDate: 'fake'",
        "};",
        "",
        "// If we've loaded the admin object, add first/last name to support",
        "// evaluation of the full policy",
        "if (sharedState.containsKey('adminObject')) {",
        "  var adminObject = sharedState.get('adminObject');",
        "  policyObject.givenName = adminObject.get('givenName');",
        "  policyObject.sn = adminObject.get('sn');",
        "}",
        "",
        "// Replace objectAttributes with our policy object",
        "sharedState.put('objectAttributes', policyObject);",
        "",
        "outcome = 'True';",
        "",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Admin_PrivacyPolicy.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "653b70b0-a23d-403a-933b-911371cf84c0": {
      "_id": "653b70b0-a23d-403a-933b-911371cf84c0",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Returns privacy policy collection",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_PrivacyPolicy",
      "script": [
        "var jurisdictions = [",
        "  {",
        "    name: 'Australia',",
        "    url: 'https://backstage.forgerock.com/knowledge/identity-cloud/article/a92472578'",
        "  },",
        "  {",
        "    name: 'Brazil',",
        "    url: 'https://www.forgerock.com/privacy-policy'",
        "  },",
        "  {",
        "    name: 'California',",
        "    url: 'https://backstage.forgerock.com/knowledge/identity-cloud/article/a67552843'",
        "  },",
        "  {",
        "    name: 'Canada',",
        "    url: 'https://backstage.forgerock.com/knowledge/identity-cloud/article/a92472578'",
        "  },",
        "  {",
        "    name: 'European Union',",
        "    url: 'https://backstage.forgerock.com/knowledge/identity-cloud/article/a28580828'",
        "  },",
        "  {",
        "    name: 'Hong Kong',",
        "    url: 'https://www.forgerock.com/resources/view/109827462/overview/identity-cloud-privacy.pdf'",
        "  },",
        "  {",
        "    name: 'Indonesia',",
        "    url: 'https://www.forgerock.com/resources/view/109827462/overview/identity-cloud-privacy.pdf'",
        "  },",
        "  {",
        "    name: 'New Zealand',",
        "    url: 'https://backstage.forgerock.com/knowledge/identity-cloud/article/a92472578'",
        "  },",
        "  {",
        "    name: 'Singapore',",
        "    url: 'https://backstage.forgerock.com/knowledge/identity-cloud/article/a92472578'",
        "  },",
        "  {",
        "    name: 'United Kingdom',",
        "    url: 'https://backstage.forgerock.com/knowledge/identity-cloud/article/a28580828'",
        "  },",
        "  {",
        "    name: 'United States',",
        "    url: 'https://www.forgerock.com/privacy-policy'",
        "  },",
        "  {",
        "    name: 'Rest of the World',",
        "    url: 'https://www.forgerock.com/privacy-policy'",
        "  }",
        "];",
        "",
        "var token = generateNumericToken('xxx');",
        "var inputId = 'jurisdiction-input-'.concat(token);",
        "var selectId = 'jurisdiction-select-'.concat(token);",
        "",
        "// Build the header and instructions",
        "var message = "<h2 class='h2'>Accept Privacy Policy</h2><div style='margin-bottom:1em'>Select your region of residence to review the applicable privacy policy.</div>";",
        "",
        "// Build the jurisdiction dropdown",
        "var dropdown = "<select id='".concat(selectId).concat("' class='custom-select' onchange='document._onJurisdictionChange()'><option value=''>Region of residence</option>");",
        "for (var i = 0; i < jurisdictions.length; i++) {",
        "  var j = jurisdictions[i];",
        "  dropdown = dropdown.concat("<option value='").concat(j.name).concat("' data-url='").concat(j.url).concat("'>").concat(j.name).concat("</option>");",
        "}",
        "dropdown = dropdown.concat("</select>");",
        "",
        "// Build the confirmation checkbox with policy link",
        "var confirm = "<div id='confirm-wrapper' class='custom-control custom-checkbox' style='padding:1rem;visibility:hidden'>".concat(",
        "  "<input id='confirm-check' type='checkbox' class='custom-control-input' onchange='document._setNextButton()'>").concat(",
        "  "<label class='custom-control-label' for='confirm-check'>").concat(",
        "  "I agree to ForgeRock's <a id='policy-link' target=_blank href='" + jurisdictions[0].url + "'>Privacy Policy</a>").concat(",
        "  "</label>").concat(",
        ""</div>");",
        "",
        "var html = message + dropdown + confirm;",
        "",
        "var script =",
        "  'document._onJurisdictionChange = function() {'.concat(",
        "  '  var jurisdiction = getJurisdiction();').concat(",
        "  '  console.log(jurisdiction);').concat(",
        "  '  if (jurisdiction) {').concat(",
        "  '    setPolicyLink(jurisdiction.url);').concat(",
        "  '    setJurisdiction(jurisdiction.name);').concat(",
        "  '    setConfirmVisibility(true);').concat(",
        "  '  } else {').concat(",
        "  '    setJurisdiction("");').concat(",
        "  '    setConfirmVisibility(false);').concat(",
        "  '  }').concat(",
        "  '  document._setNextButton();').concat(",
        "  '};').concat(",
        "    ",
        "  'document._setNextButton = function() {').concat(",
        "  '  var jurisdiction = getJurisdiction();').concat(",
        "  '  var cb = getCheckbox();').concat(",
        "  '  loginHelpers.disableNextButton(!jurisdiction || !cb.checked);').concat(",
        "  '};').concat(",
        "    ",
        "  'var getJurisdiction = function() {').concat(",
        "  '  var sel = document.getElementById("').concat(selectId).concat('");').concat(",
        "  '  var opt = sel.options[sel.selectedIndex];').concat(",
        "  '  return opt.value ? { name: opt.value, url: opt.getAttribute("data-url") } : null;').concat(",
        "  '};').concat(",
        "    ",
        "  'var getCheckbox = function() {').concat(",
        "  '  return document.getElementById("confirm-check");').concat(",
        "  '};').concat(",
        "    ",
        "  'var setConfirmVisibility = function(show) {').concat(",
        "  '  var el = document.getElementById("confirm-wrapper");').concat(",
        "  '  el.style.visibility = show ? "visible" : "hidden";').concat(",
        "  '};').concat(",
        "    ",
        "  'var setPolicyLink = function(url) {').concat(",
        "  '  document.getElementById("policy-link").setAttribute("href", url);').concat(",
        "  '};').concat(",
        "",
        "  'var setJurisdiction = function(name) {').concat(",
        "  '  loginHelpers.setHiddenCallback("').concat(inputId).concat('", name);').concat(",
        "  '};').concat(",
        "    ",
        "  'var isPageReady = function() {').concat(",
        "  '  return document.getElementById("callback_0") != null;').concat(",
        "  '};').concat(",
        "    ",
        "  'var setupPage = function() {').concat(",
        "  '  if (!isPageReady()) {').concat(",
        "  '    return setTimeout(setupPage, 100);').concat(",
        "  '  }').concat(",
        "  '  loginHelpers.disableNextButton(true);').concat(",
        "  '  var container = document.getElementById("callback_0");').concat(",
        "  '  container.insertAdjacentHTML("beforeend", "').concat(html).concat('");').concat(",
        "  '};').concat(",
        "    ",
        "  'setupPage();');",
        "",
        "function isValidJurisdiction(name) {",
        "  for (var i = 0; i < jurisdictions.length; i++) {",
        "    if (jurisdictions[i].name == name) {",
        "      return true;",
        "    }",
        "  }",
        "  return false;",
        "}",
        "",
        "var fr = JavaImporter(",
        "  org.forgerock.openam.auth.node.api.Action,",
        "  com.sun.identity.authentication.callbacks.HiddenValueCallback,",
        "  com.sun.identity.authentication.callbacks.ScriptTextOutputCallback,",
        "  java.util.HashMap",
        ")",
        "",
        "with (fr) {",
        "  if (callbacks.isEmpty() || !isValidJurisdiction(callbacks.get(0).getValue())) {",
        "    action = Action.send(",
        "      new HiddenValueCallback(inputId, ''),",
        "      new ScriptTextOutputCallback(script)",
        "    ).build();",
        "  } else {",
        "    var OBJ_ATTRS = 'objectAttributes';",
        "    var attrs = sharedState.containsKey(OBJ_ATTRS) ? sharedState.get(OBJ_ATTRS) : new HashMap();",
        "    attrs.put('jurisdiction', callbacks.get(0).getValue());",
        "    sharedState.put(OBJ_ATTRS, attrs);",
        "    action = Action.goTo('True').build();",
        "  }",
        "}",
        "",
        " /*",
        "  * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "  * ",
        "  * Example:",
        "  * 'xxxxx' produces '28535'",
        "  * 'xxx-xxx' produces '432-521'",
        "  */",
        "function generateNumericToken(format) {",
        "  return format.replace(/[x]/g, function(c) {",
        "    var r = Math.random()*10|0;",
        "    var v = r;",
        "    return v.toString(10);",
        "  });",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Admin_ProfileToManagedObject.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "ab78dcb5-85cb-41a6-813e-e07a77761376": {
      "_id": "ab78dcb5-85cb-41a6-813e-e07a77761376",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_ProfileToManagedObject",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "function setIfValidString(managedData, managedKey, profileKey) {",
        "  var normalizedValue = normalizedProfile.get(profileKey);",
        "  if (normalizedValue && !normalizedValue.isNull() && normalizedValue.asString() != '') {",
        "    managedData.put(managedKey, normalizedValue);",
        "  }",
        "}",
        "",
        "(function () {",
        "  var frJava = JavaImporter(",
        "    org.forgerock.json.JsonValue,",
        "    java.util.HashMap",
        "  );",
        "",
        "  var OBJ_ATTR = 'objectAttributes';",
        "",
        "  // We should have objectAttributes during onboarding because the user is established earlier in",
        "  // the journey.  We won't have objectAttributes during login, though.",
        "  var objAttrs = sharedState.containsKey(OBJ_ATTR) ? sharedState.get(OBJ_ATTR) : new frJava.HashMap();",
        "",
        "  // If this flow requires email matching, confirm the IdP user email address matches the FR email address",
        "  if (sharedState.checkEmailClaim == true) {",
        "    var idpEmail = normalizedProfile.get('email').asString();",
        "    var frEmail = objAttrs.get('mail');",
        "    if (idpEmail != frEmail) {",
        "      throw 'Email claim from IDP does not match identity mail attribute';",
        "    }",
        "  }",
        "",
        "  // Update user with first/last name from IDP, if available",
        "  var managedUserData = frJava.JsonValue.json(frJava.JsonValue.object());",
        "  setIfValidString(managedUserData, 'givenName', 'givenName');",
        "  setIfValidString(managedUserData, 'sn', 'familyName');",
        "  ",
        "  // For login: Ensure the mail attribute is set in case we have to look up the admin using",
        "  // their email.  This will occur when an existing admin is federating for the first time.",
        "  if (!objAttrs.containsKey('mail')) {",
        "    managedUserData.put('mail', normalizedProfile.get('email').asString());",
        "  }",
        "",
        "  if (!normalizedProfile.get('groups').isNull()) {",
        "    managedUserData.put('groups', normalizedProfile.get('groups').asList());",
        "  }",
        "  ",
        "  // Merge anything we've put into \`managedUserData\` into sharedState.objectAttributes because",
        "  // \`managedUserData\` goes into transient state, which isn't used by our downstream nodes",
        "  var keys = managedUserData.keys().toArray();",
        "  for (var i = 0; i < keys.length; i++) {",
        "    objAttrs.put(keys[i], managedUserData.get(keys[i]));",
        "  }",
        "  sharedState.put(OBJ_ATTR, objAttrs);",
        "",
        "  return managedUserData;",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Admin_SetCurrentYear.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "6963d84e-e2f0-4db1-a746-116604189602": {
      "_id": "6963d84e-e2f0-4db1-a746-116604189602",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_SetCurrentYear",
      "script": [
        "var currentYear = new Date().getFullYear().toString();",
        "",
        "var objAttrs = sharedState.get('objectAttributes') || new java.util.HashMap();",
        "objAttrs.put('currentYear', currentYear);",
        "sharedState.put('objectAttributes', objAttrs);",
        "",
        "outcome = 'True';",
        "",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Admin_SetInviteMailVars.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "db854830-a069-471f-875a-8dc67d45ea2d": {
      "_id": "db854830-a069-471f-875a-8dc67d45ea2d",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_SetInviteMailVars",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "var objAttrs = sharedState.get('objectAttributes') || new HashMap();",
        "objAttrs.put('currentYear', new Date().getFullYear().toString());",
        "sharedState.put('objectAttributes', objAttrs);",
        "",
        "outcome = 'True';",
        "",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Admin_SetOnboardingAttributes.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "80c3e733-ae51-4851-a01d-1cbf193c80e9": {
      "_id": "80c3e733-ae51-4851-a01d-1cbf193c80e9",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Activates the admin's account",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_SetOnboardingAttributes",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "function utcNow() {",
        "  return new Date().toISOString();",
        "}",
        "",
        "try {",
        "  ",
        "  var OBJECT_ATTRS = 'objectAttributes';",
        "",
        "  // Start by getting object attributes from shared state",
        "  var sharedObjAttrs = sharedState.get(OBJECT_ATTRS);",
        "  sharedObjAttrs.put('accountStatus', 'Active');",
        "  sharedObjAttrs.put('onboardDate', utcNow());",
        "  ",
        "  // Copy attributes from transient state",
        "  var transientObjAttrs = nodeState.get(OBJECT_ATTRS);",
        "  var attrs = ['aliasList', 'givenName', 'password', 'sn'];",
        "  for (var i = 0; i < attrs.length; i++) {",
        "    var val = transientObjAttrs.get(attrs[i]);",
        "    if (val.isNotNull()) {",
        "      sharedObjAttrs.put(attrs[i], val);",
        "    }",
        "  }",
        "  ",
        "  // Ensure object attributes match in both shared and transient state",
        "  nodeState.putTransient(OBJECT_ATTRS, sharedObjAttrs);",
        "  sharedState.put(OBJECT_ATTRS, sharedObjAttrs);",
        "  outcome = 'Success';",
        "",
        "} catch (e) {",
        "",
        "  logger.error('Failed to set attributes to complete onboarding: {}', e);",
        "  outcome = 'Error';",
        "",
        "}",
        "",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Alpha-OAuth2-Access-Token-Modification-Script.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "39c08084-1238-43e8-857f-2e11005eac49": {
      "_id": "39c08084-1238-43e8-857f-2e11005eac49",
      "context": "OAUTH2_ACCESS_TOKEN_MODIFICATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Default alpha realm script for OAuth2 Access Token Modification",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Alpha OAuth2 Access Token Modification Script",
      "script": [
        "/*",
        " * Copyright 2019-2021 ForgeRock AS. All Rights Reserved.",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        " * This script lets you modify information associated with an OAuth2 access token",
        " * with methods provided by the AccessToken (1) interface.",
        " * The changes made to OAuth2 access tokens will directly impact the size of the CTS tokens,",
        " * and, similarly, the size of the JWTs if client-based OAuth2 tokens are utilized.",
        " * When adding/updating fields make sure that the token size remains within client/user-agent limits.",
        " *",
        " * Defined variables:",
        " * accessToken - AccessToken (1).",
        " *               The access token to be updated.",
        " *               Mutable object, all changes to the access token will be reflected.",
        " * scopes - Set<String> (6).",
        " *          Always present, the requested scopes.",
        " * requestProperties - Unmodifiable Map (5).",
        " *                     Always present, contains a map of request properties:",
        " *                     requestUri - The request URI.",
        " *                     realm - The realm that the request relates to.",
        " *                     requestParams - A map of the request params and/or posted data.",
        " *                                     Each value is a list of one or more properties.",
        " *                                     Please note that these should be handled in accordance with OWASP best practices:",
        " *                                     https://owasp.org/www-community/vulnerabilities/Unsafe_use_of_Reflection.",
        " * clientProperties - Unmodifiable Map (5).",
        " *                    Present if the client specified in the request was identified, contains a map of client properties:",
        " *                    clientId - The client's URI for the request locale.",
        " *                    allowedGrantTypes - List of the allowed grant types (org.forgerock.oauth2.core.GrantType) for the client.",
        " *                    allowedResponseTypes - List of the allowed response types for the client.",
        " *                    allowedScopes - List of the allowed scopes for the client.",
        " *                    customProperties - A map of the custom properties of the client.",
        " *                                       Lists or maps will be included as sub-maps; for example:",
        " *                                       customMap[Key1]=Value1 will be returned as customMap -> Key1 -> Value1.",
        " *                                       To add custom properties to a client, update the Custom Properties field",
        " *                                       in AM Console > Realm Name > Applications > OAuth 2.0 > Clients > Client ID > Advanced.",
        " * identity - AMIdentity (3).",
        " *            Always present, the identity of the resource owner.",
        " * session - SSOToken (4).",
        " *           Present if the request contains the session cookie, the user's session object.",
        " * scriptName - String (primitive).",
        " *              Always present, the display name of the script.",
        " * logger - Always present, the "OAuth2Provider" debug logger instance:",
        " *          https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.",
        " *          Corresponding log files will be prefixed with: scripts.OAUTH2_ACCESS_TOKEN_MODIFICATION.",
        " * httpClient - HTTP Client (8).",
        " *              Always present, the HTTP Client instance:",
        " *              https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-http-client.html#scripting-api-global-http-client.",
        " *",
        " * Return - no value is expected, changes shall be made to the accessToken parameter directly.",
        " *",
        " * Class reference:",
        " * (1) AccessToken - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/AccessToken.html.",
        " * (3) AMIdentity - https://backstage.forgerock.com/docs/am/7/apidocs/com/sun/identity/idm/AMIdentity.html.",
        " * (4) SSOToken - https://backstage.forgerock.com/docs/am/7/apidocs/com/iplanet/sso/SSOToken.html.",
        " * (5) Map - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashMap.html,",
        " *           or https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/LinkedHashMap.html.",
        " * (6) Set - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashSet.html.",
        " * (8) Client - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/http/Client.html.",
        " */",
        "",
        "/* EXAMPLE",
        "(function () {",
        "    var frJava = JavaImporter(",
        "        org.forgerock.http.protocol.Request,",
        "        org.forgerock.http.protocol.Response",
        "    );",
        "",
        "    // Always includes this field in the token.",
        "    accessToken.setField('key1', 'value1');",
        "",
        "    // Receives and adds to the access token additional values by performing a REST call to an external service.",
        "    // WARNING: Below, you will find a reference to a third-party site, which is provided only as an example.",
        "    var uri = 'https://jsonplaceholder.typicode.com/posts';",
        "",
        "    try {",
        "        var request = new frJava.Request();",
        "",
        "        // You can chain methods that return the request object.",
        "        request.setUri(uri)",
        "            .setMethod('POST')",
        "            .setEntity(JSON.stringify({",
        "                updatedFields: {",
        "                    key2: 'value2',",
        "                    key3: 'value3'",
        "                }",
        "            }));",
        "",
        "        // You can call a method when chaining is not possible.",
        "        request.getHeaders().add('Content-Type', 'application/json; charset=UTF-8');",
        "",
        "        // Sends the request and receives the response.",
        "        var response = httpClient.send(request).getOrThrow();",
        "",
        "        // Checks if the response status is as expected.",
        "        if (response.getStatus() === org.forgerock.http.protocol.Status.CREATED) {",
        "            var result = JSON.parse(response.getEntity().getString());",
        "",
        "            // Set multiple token fields at once.",
        "            accessToken.setFields(result.updatedFields);",
        "        } else {",
        "            logger.error('Unable to obtain access token modifications. Status: ' + response.getStatus() + '. Content: ' + response.getEntity().getString());",
        "        }",
        "    } catch (e) {",
        "        logger.error('The request processing was interrupted. ' + e);",
        "",
        "        // The access token request fails with the HTTP 500 error in this case.",
        "        throw ('Unable to obtain response from: ' + uri);",
        "    }",
        "",
        "    // Adds new fields containing identity attribute values to the access token.",
        "    accessToken.setField('mail', identity.getAttribute('mail'));",
        "    accessToken.setField('phone', identity.getAttribute('telephoneNumber').toArray()[0]);",
        "",
        "    // Adds new fields containing the session property values.",
        "    // NOTE: session may not be available for non-interactive authorization grants.",
        "    if (session) {",
        "        try {",
        "            accessToken.setField('ipAddress', session.getProperty('Host'));",
        "        } catch (e) {",
        "            logger.error('Unable to retrieve session property value. ' + e);",
        "        }",
        "    }",
        "",
        "    // Removes a native field from the token entry, that was set by AM.",
        "    // WARNING: removing native fields from the token may result in loss of functionality.",
        "    // accessToken.removeTokenName()",
        "",
        "    // No return value is expected. Let it be undefined.",
        "}());",
        "*/",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Alpha-OIDC-Claims-Script.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "cf3515f0-8278-4ee3-a530-1bad7424c416": {
      "_id": "cf3515f0-8278-4ee3-a530-1bad7424c416",
      "context": "OIDC_CLAIMS",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Default alpha realm script for OIDC claims",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Alpha OIDC Claims Script",
      "script": [
        "/*",
        " * Copyright 2014-2021 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        " * This script computes claim values returned in ID tokens and/or at the UserInfo Endpoint.",
        " * The claim values are computed for:",
        " * the claims derived from the requested scopes,",
        " * the claims provided by the authorization server,",
        " * and the claims requested by the client via the claims parameter.",
        " *",
        " * In the CONFIGURATION AND CUSTOMIZATION section, you can",
        " * define the scope-to-claims mapping, and",
        " * assign to each claim a resolver function that will compute the claim value.",
        " *",
        " * Defined variables (class references are provided below):",
        " * scopes - Set<String> (6).",
        " *          Always present, the requested scopes.",
        " * claims - Map<String, Object> (5).",
        " *          Always present, default server provided claims.",
        " * claimObjects - List<Claim> (7, 2).",
        " *                Always present, the default server provided claims.",
        " * requestedClaims - Map<String, Set<String>> (5).",
        " *                   Always present, not empty if the request contains the claims parameter and the server has enabled",
        " *                   claims_parameter_supported. A map of the requested claims to possible values, otherwise empty;",
        " *                   requested claims with no requested values will have a key but no value in the map. A key with",
        " *                   a single value in its Set (6) indicates that this is the only value that should be returned.",
        " * requestedTypedClaims - List<Claim> (7, 2).",
        " *                        Always present, the requested claims.",
        " *                        Requested claims with no requested values will have a claim with no values.",
        " *                        A claim with a single value indicates this is the only value that should be returned.",
        " * claimsLocales - List<String> (7).",
        " *                 The values from the 'claims_locales' parameter.",
        " *                 See https://openid.net/specs/openid-connect-core-1_0.html#ClaimsLanguagesAndScripts for the OIDC specification details.",
        " * requestProperties - Unmodifiable Map (5).",
        " *                     Always present, contains a map of request properties:",
        " *                     requestUri - The request URI.",
        " *                     realm - The realm that the request relates to.",
        " *                     requestParams - A map of the request params and/or posted data.",
        " *                                     Each value is a list of one or more properties.",
        " *                                     Please note that these should be handled in accordance with OWASP best practices:",
        " *                                     https://owasp.org/www-community/vulnerabilities/Unsafe_use_of_Reflection.",
        " * clientProperties - Unmodifiable Map (5).",
        " *                    Present if the client specified in the request was identified, contains a map of client properties:",
        " *                    clientId - The client's URI for the request locale.",
        " *                    allowedGrantTypes - List of the allowed grant types (org.forgerock.oauth2.core.GrantType) for the client.",
        " *                    allowedResponseTypes - List of the allowed response types for the client.",
        " *                    allowedScopes - List of the allowed scopes for the client.",
        " *                    customProperties - A map of the custom properties of the client.",
        " *                                       Lists or maps will be included as sub-maps; for example:",
        " *                                       customMap[Key1]=Value1 will be returned as customMap -> Key1 -> Value1.",
        " *                                       To add custom properties to a client, update the Custom Properties field",
        " *                                       in AM Console > Realm Name > Applications > OAuth 2.0 > Clients > Client ID > Advanced.",
        " * identity - AMIdentity (3).",
        " *            Always present, the identity of the resource owner.",
        " * session - SSOToken (4).",
        " *           Present if the request contains the session cookie, the user's session object.",
        " * scriptName - String (primitive).",
        " *              Always present, the display name of the script.",
        " * logger - Always present, the "OAuth2Provider" debug logger instance:",
        " *          https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.",
        " *          Corresponding files will be prefixed with: scripts.OIDC_CLAIMS.",
        " * httpClient - HTTP Client (8).",
        " *              Always present, the HTTP Client instance:",
        " *              https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-http-client.html#scripting-api-global-http-client.",
        " *              In order to use the client, you may need to add",
        " *              org.forgerock.http.Client,",
        " *              org.forgerock.http.protocol.*,",
        " *              and org.forgerock.util.promise.PromiseImpl",
        " *              to the allowed Java classes in the scripting engine configuration, as described in:",
        " *              https://backstage.forgerock.com/docs/am/7/scripting-guide/script-engine-security.html",
        " *",
        " * Return - a new UserInfoClaims(Map<String, Object> values, Map<String, List<String>> compositeScopes) (1) object.",
        " *          The result of the last statement in the script is returned to the server.",
        " *          Currently, the Immediately Invoked Function Expression (also known as Self-Executing Anonymous Function)",
        " *          is the last (and only) statement in this script, and its return value will become the script result.",
        " *          Do not use "return variable" statement outside of a function definition.",
        " *          See RESULTS section for additional details.",
        " *",
        " * Class reference:",
        " * (1) UserInfoClaims - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html.",
        " * (2) Claim - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html).",
        " *         An instance of org.forgerock.openidconnect.Claim has methods to access",
        " *         the claim name, requested values, locale, and whether the claim is essential.",
        " * (3) AMIdentity - https://backstage.forgerock.com/docs/am/7/apidocs/com/sun/identity/idm/AMIdentity.html.",
        " * (4) SSOToken - https://backstage.forgerock.com/docs/am/7/apidocs/com/iplanet/sso/SSOToken.html.",
        " * (5) Map - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashMap.html,",
        " *           or https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/LinkedHashMap.html.",
        " * (6) Set - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashSet.html.",
        " * (7) List - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/ArrayList.html.",
        " * (8) Client - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/http/Client.html.",
        "*/",
        "",
        "(function () {",
        "    // SETUP",
        "",
        "    /**",
        "     * Claim processing utilities.",
        "     * An object that contains reusable functions for processing claims.",
        "     * @see CLAIM PROCESSING UTILITIES section for details.",
        "     */",
        "    var utils = getUtils();",
        "",
        "    // CONFIGURATION AND CUSTOMIZATION",
        "",
        "    /**",
        "     * OAuth 2.0 scope values (scopes) can be used by the Client to request OIDC claims.",
        "     *",
        "     * Call this configuration method, and pass in as the first argument",
        "     * an object that maps a scope value to an array of claim names",
        "     * to specify which claims need to be processed and returned for the requested scopes.",
        "     * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#ScopeClaims}",
        "     * for the scope values that could be used to request claims as defined in the OIDC specification.",
        "     *",
        "     * Below, find a default configuration that is expected to work in the current environment.",
        "     *",
        "     * CUSTOMIZATION",
        "     * You can choose the claim names returned for a scope.",
        "     */",
        "    utils.setScopeClaimsMap({",
        "        profile: [",
        "            'name',",
        "            'family_name',",
        "            'given_name',",
        "            'zoneinfo',",
        "            'locale'",
        "        ],",
        "        email: ['email'],",
        "        address: ['address'],",
        "        phone: ['phone_number']",
        "    });",
        "",
        "    /**",
        "     * In this script, each claim",
        "     * derived from the requested scopes,",
        "     * provided by the authorization server, and",
        "     * requested by the client via the claims parameter",
        "     * will be processed by a function associated with the claim name.",
        "     *",
        "     * Call this configuration method, and pass in as the first argument",
        "     * an object that maps a claim name to a resolver function,",
        "     * which will be automatically executed for each claim processed by the script.",
        "     *",
        "     * The claim resolver function will receive the requested claim information",
        "     * in an instance of org.forgerock.openidconnect.Claim as the first argument.",
        "     * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html}",
        "     * for details on the Claim class.",
        "     *",
        "     * If the claim resolver function returns a value,",
        "     * other than undefined or null,",
        "     * the claim will be included in the script's results.",
        "     *",
        "     * The Claim instance provides methods to check",
        "     * what the name of the claim is,",
        "     * which values the claim request contains,",
        "     * whether the claim is essential, and",
        "     * which locale the claim is associated with.",
        "     * The resolver function can consider this information when computing and returning the claim value.",
        "     *",
        "     * Below, find a default configuration that is expected to work in the current environment.",
        "     * A reusable function, utils.getUserProfileClaimResolver(String attribute-name),",
        "     * is called to return a claim resolver function based on a user profile attribute.",
        "     * @see CLAIM RESOLVERS section for the implementation details and examples.",
        "     * For the address claim, an example of a claim resolver that uses another claim resolver is provided.",
        "     *",
        "     * CUSTOMIZATION",
        "     * You can reuse the predefined utils methods with your custom arguments.",
        "     * You can also specify a custom resolver function for a claim name,",
        "     * that will compute and return the claim value—as shown in the commented out example below.",
        "     */",
        "    utils.setClaimResolvers({",
        "        /*",
        "        // An example of a simple claim resolver function that is defined for a claim",
        "        // directly in the configuration object:",
        "        custom-claim-name: function (requestedClaim) {",
        "            // In this case, initially, the claim value comes straight from a user profile attribute value:",
        "            var claimValue = identity.getAttribute('custom-attribute-name').toArray()[0]",
        "",
        "            // Optionally, provide additional logic for processing (filtering, formatting, etc.) the claim value.",
        "            // You can use:",
        "            // requestedClaim.getName()",
        "            // requestedClaim.getValues()",
        "            // requestedClaim.getLocale()",
        "            // requestedClaim.isEssential()",
        "",
        "            return claimValue",
        "        },",
        "        */",
        "        /**",
        "         * The use of utils.getUserProfileClaimResolver shows how",
        "         * an argument passed to a function that returns a claim resolver",
        "         * becomes available to the resolver function (via its lexical context).",
        "         */",
        "        name: utils.getUserProfileClaimResolver('cn'),",
        "        family_name: utils.getUserProfileClaimResolver('sn'),",
        "        given_name: utils.getUserProfileClaimResolver('givenname'),",
        "        zoneinfo: utils.getUserProfileClaimResolver('preferredtimezone'),",
        "        locale: utils.getUserProfileClaimResolver('preferredlocale'),",
        "        email: utils.getUserProfileClaimResolver('mail'),",
        "        address: utils.getAddressClaimResolver(",
        "            /**",
        "             * The passed in user profile claim resolver function",
        "             * can be used by the address claim resolver function",
        "             * to obtain the claim value to be formatted as per the OIDC specification:",
        "             * @see https://openid.net/specs/openid-connect-core-1_0.html#AddressClaim.",
        "             */",
        "            utils.getUserProfileClaimResolver('postaladdress')",
        "        ),",
        "        phone_number: utils.getUserProfileClaimResolver('telephonenumber')",
        "    });",
        "",
        "    // CLAIM PROCESSING UTILITIES",
        "",
        "    /**",
        "     * @returns {object} An object that contains reusable claim processing utilities.",
        "     * @see PUBLIC METHODS section and the return statement for the list of exported functions.",
        "     */",
        "    function getUtils () {",
        "        // IMPORT JAVA",
        "",
        "        /**",
        "         * Provides Java scripting functionality.",
        "         * @see {@link https://developer.mozilla.org/en-US/docs/Mozilla/Projects/Rhino/Scripting_Java#javaimporter_constructor}.",
        "         */",
        "        var frJava = JavaImporter(",
        "            org.forgerock.oauth2.core.exceptions.InvalidRequestException,",
        "            org.forgerock.oauth2.core.UserInfoClaims,",
        "            org.forgerock.openidconnect.Claim,",
        "",
        "            java.util.LinkedHashMap,",
        "            java.util.ArrayList",
        "        );",
        "",
        "        // SET UP CONFIGURATION",
        "",
        "        /**",
        "         * Placeholder for a configuration option that contains",
        "         * an object that maps the supported scope values (scopes)",
        "         * and the corresponding claim names for each scope value.",
        "         */",
        "        var scopeClaimsMap;",
        "",
        "        /**",
        "         * Placeholder for a configuration option that contains",
        "         * an object that maps the supported claim names",
        "         * and the resolver functions returning the claim value.",
        "         */",
        "        var claimResolvers;",
        "",
        "        /**",
        "         * A (public) method that accepts an object that maps the supported scopes and the corresponding claim names,",
        "         * and assigns it to a (private) variable that serves as a configuration option.",
        "         * @param {object} params - An object that maps each supported scope value to an array of claim names,",
        "         * in order to specify which claims need to be processed for the requested scopes.",
        "         * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#ScopeClaims} for details.",
        "         * @param {string[]} [params.profile] - An array of claim names to be returned if the profile scope is requested.",
        "         * @param {string[]} [params.email] - An array of claim names to be returned if the email scope is requested.",
        "         * @param {string[]} [params.address] - An array of claim names to be returned if the address scope is requested.",
        "         * @param {string[]} [params.phone] - An array of claim names to be returned if the phone scope is requested.",
        "         * @returns {undefined}",
        "         */",
        "        function setScopeClaimsMap(params) {",
        "            scopeClaimsMap = params;",
        "        }",
        "",
        "        /**",
        "         * A (public) method that accepts an object that maps the supported claim names",
        "         * and the resolver functions returning the claim value,",
        "         * and assigns it to a (private) variable that serves as a configuration option.",
        "         * @param {object} params - An object that maps",
        "         * each supported claim name to a function that computes and returns the claim value.",
        "         */",
        "        function setClaimResolvers(params) {",
        "            claimResolvers = params;",
        "        }",
        "",
        "        // CLAIM RESOLVERS",
        "",
        "        /**",
        "         * Claim resolvers are functions that return a claim value.",
        "         * @param {*}",
        "         * @returns {*}",
        "         */",
        "",
        "        /**",
        "         * Defines a claim resolver based on a user profile attribute.",
        "         * @param {string} attributeName - Name of the user profile attribute.",
        "         * @returns {function} A function that will determine the claim value",
        "         * based on the user profile attribute and the (requested) claim properties.",
        "         */",
        "        function getUserProfileClaimResolver (attributeName) {",
        "            /**",
        "             * Resolves a claim with a user profile attribute value.",
        "             * Returns undefined if the identity attribute is not populated,",
        "             * OR if the claim has requested values that do not contain the identity attribute value.",
        "             * ATTENTION: the aforementioned comparison is case-sensitive.",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {string|HashSet|undefined}",
        "             */",
        "            function resolveClaim(claim) {",
        "                var userProfileValue;",
        "",
        "                if (identity) {",
        "                    userProfileValue = getClaimValueFromSet(claim, identity.getAttribute(attributeName));",
        "",
        "                    if (userProfileValue && !userProfileValue.isEmpty()) {",
        "                        if (!claim.getValues() || claim.getValues().isEmpty() || claim.getValues().contains(userProfileValue)) {",
        "                            return userProfileValue;",
        "                        }",
        "                    }",
        "                }",
        "            }",
        "",
        "            return resolveClaim;",
        "        }",
        "",
        "        /**",
        "         * Returns an address claim resolver based on a claim value obtained with another claim resolver.",
        "         * @param {function} resolveClaim - A function that returns a claim value.",
        "         * @returns {function} A function that will accept a claim as an argument,",
        "         * run the claim resolver function for the claim and obtain the claim value,",
        "         * and apply additional formatting to the value before returning it.",
        "         */",
        "        function getAddressClaimResolver (resolveClaim) {",
        "            /**",
        "             * Creates an address claim object from a value returned by a claim resolver,",
        "             * and returns the address claim object as the claim value.",
        "             * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#AddressClaim}.",
        "             * The claim value is obtained with a claim resolving function available from the closure.",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {java.util.LinkedHashMap|undefined} The address claim object created from a claim value.",
        "             */",
        "            function resolveAddressClaim(claim) {",
        "                var claimValue = resolveClaim(claim);",
        "                var addressObject;",
        "",
        "                if (isClaimValueValid(claimValue)) {",
        "                    addressObject = new frJava.LinkedHashMap();",
        "",
        "                    addressObject.put('formatted', claimValue);",
        "",
        "                    return addressObject;",
        "                }",
        "            }",
        "",
        "            return resolveAddressClaim;",
        "        }",
        "",
        "        /**",
        "         * Returns an essential claim resolver based on a claim value obtained with another claim resolver.",
        "         * @param {function} resolveClaim - A function that returns a claim value.",
        "         * @returns {function} A function that will accept a claim as an argument,",
        "         * run the claim resolver function for the claim and obtain the claim value,",
        "         * and apply additional logic for essential claims.",
        "         */",
        "        function getEssentialClaimResolver (resolveClaim) {",
        "            /**",
        "             * Returns a claim value or throws an error.",
        "             * The claim value is obtained with a claim resolving function available from the closure.",
        "             * Throws an exception if the claim is essential and no value is returned for the claim.",
        "             *",
        "             * Use of this resolver is optional.",
        "             * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#IndividualClaimsRequests} stating:",
        "             * "Note that even if the Claims are not available because the End-User did not authorize their release or they are not present,",
        "             * the Authorization Server MUST NOT generate an error when Claims are not returned, whether they are Essential or Voluntary,",
        "             * unless otherwise specified in the description of the specific claim."",
        "             *",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {*}",
        "             * @throws {org.forgerock.oauth2.core.exceptions.InvalidRequestException}",
        "             */",
        "            function resolveEssentialClaim(claim) {",
        "                var claimValue = resolveClaim(claim);",
        "",
        "                if (claim.isEssential() && !isClaimValueValid(claimValue)) {",
        "                    throw new frJava.InvalidRequestException('Could not provide value for essential claim: ' + claim.getName());",
        "                }",
        "",
        "                return claimValue;",
        "            }",
        "",
        "            return resolveEssentialClaim;",
        "        }",
        "",
        "        /**",
        "         * Provides default resolution for a claim.",
        "         * Use it if a claim-specific resolver is not defined in the configuration.",
        "         * @param {org.forgerock.openidconnect.Claim} claim",
        "         * An object that provides methods to obtain information/requirements associated with a claim.",
        "         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "         * @returns {*} A single value associated with this claim.",
        "         */",
        "        function resolveAnyClaim (claim) {",
        "            if (claim.getValues().size() === 1) {",
        "                return claim.getValues().toArray()[0];",
        "            }",
        "        }",
        "",
        "        // UTILITIES",
        "",
        "        /**",
        "         * Returns claim value from a set.",
        "         * If the set contains a single value, returns the value.",
        "         * If the set contains multiple values, returns the set.",
        "         * Otherwise, returns undefined.",
        "         *",
        "         * @param {org.forgerock.openidconnect.Claim} claim",
        "         * An object that provides methods to obtain information/requirements associated with a claim.",
        "         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "         * @param {java.util.HashSet} set The set—for example, a user profile attribute value.",
        "         * @returns {string|java.util.HashSet|undefined}",
        "         */",
        "        function getClaimValueFromSet (claim, set) {",
        "            if (set && set.size()) {",
        "                if (set.size() === 1) {",
        "                    return set.toArray()[0];",
        "                } else {",
        "                    return set;",
        "                }",
        "            } else if (logger.warningEnabled()) {",
        "                logger.warning('OIDC Claims script. Got an empty set for claim: ' + claim.getName());",
        "            }",
        "        }",
        "",
        "        function isClaimValueValid (claimValue) {",
        "            if (typeof claimValue === 'undefined' || claimValue === null) {",
        "                return false;",
        "            }",
        "",
        "            return true;",
        "        }",
        "",
        "        // CLAIM PROCESSING",
        "",
        "        /**",
        "         * Constructs and returns an object populated with the computed claim values",
        "         * and the requested scopes mapped to the claim names.",
        "         * @returns {org.forgerock.oauth2.core.UserInfoClaims} The object to be returned to the authorization server.",
        "         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html}.",
        "         * @see RESULTS section for the use of this function.",
        "         */",
        "        function getUserInfoClaims () {",
        "            return new frJava.UserInfoClaims(getComputedClaims(), getCompositeScopes());",
        "        }",
        "",
        "        /**",
        "         * Creates a map of (requested) claim names populated with the computed claim values.",
        "         * @returns {java.util.LinkedHashMap}",
        "         * A map of the requested claim names and the corresponding claim values.",
        "         */",
        "        function getComputedClaims () {",
        "            /**",
        "             * Creates a complete list of claim objects from:",
        "             * the claims derived from the scopes,",
        "             * the claims provided by the authorization server,",
        "             * and the claims requested by the client.",
        "             * @returns {java.util.ArrayList}",
        "             * Returns a complete list of org.forgerock.openidconnect.Claim objects available to the script.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for the claim object details.",
        "             */",
        "            function getClaims() {",
        "                /**",
        "                 * Returns a list of claim objects for the requested scopes.",
        "                 * Uses the scopeClaimsMap configuration option to derive the claim names;",
        "                 * no other properties of a claim derived from a scope are populated.",
        "                 * @returns {java.util.ArrayList}",
        "                 * A list of org.forgerock.openidconnect.Claim objects derived from the requested scopes.",
        "                 * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for the claim object details.",
        "                 */",
        "                function convertScopeToClaims() {",
        "                    var claims = new frJava.ArrayList();",
        "",
        "                    scopes.toArray().forEach(function (scope) {",
        "                        if (String(scope) !== 'openid' && scopeClaimsMap[scope]) {",
        "                            scopeClaimsMap[scope].forEach(function (claimName) {",
        "                                claims.add(new frJava.Claim(claimName));",
        "                            });",
        "                        }",
        "                    });",
        "",
        "                    return claims;",
        "                }",
        "",
        "                var claims = new frJava.ArrayList();",
        "",
        "                claims.addAll(convertScopeToClaims());",
        "                claims.addAll(claimObjects);",
        "                claims.addAll(requestedTypedClaims);",
        "",
        "                return claims;",
        "            }",
        "",
        "            /**",
        "             * Computes and returns a claim value.",
        "             * To obtain the claim value, uses the resolver function specified for the claim in the claimResolvers configuration object.",
        "             * @see claimResolvers",
        "             * If no resolver function is found, uses the default claim resolver function.",
        "             *",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {*} Claim value.",
        "             * @throws {org.forgerock.oauth2.core.exceptions.InvalidRequestException}",
        "             * Rethrows this exception if a claim resolver throws it.",
        "             * You can throw org.forgerock.oauth2.core.exceptions.InvalidRequestException from your custom claim resolver",
        "             * if you want to terminate the claim processing.",
        "             */",
        "            function computeClaim(claim) {",
        "                var resolveClaim;",
        "                var message;",
        "",
        "                try {",
        "                    resolveClaim = claimResolvers[claim.getName()] || resolveAnyClaim;",
        "",
        "                    return resolveClaim(claim);",
        "                } catch (e) {",
        "                    message = 'OIDC Claims script exception. Unable to resolve OIDC Claim. ' + e;",
        "",
        "                    if (String(e).indexOf('org.forgerock.oauth2.core.exceptions.InvalidRequestException') !== -1) {",
        "                        throw e;",
        "                    }",
        "",
        "                    if (logger.warningEnabled()) {",
        "                        logger.warning(message);",
        "                    }",
        "                }",
        "            }",
        "",
        "            var computedClaims = new frJava.LinkedHashMap();",
        "",
        "            getClaims().toArray().forEach(function (claim) {",
        "                var claimValue = computeClaim(claim);",
        "",
        "                if (isClaimValueValid(claimValue)) {",
        "                    computedClaims.put(claim.getName(), claimValue);",
        "                } else {",
        "                    /**",
        "                     * If a claim has been processed, but appears in the list again,",
        "                     * and its value cannot be computed under the new conditions,",
        "                     * the claim is removed from the final result.",
        "                     *",
        "                     * For example, a claim could be mapped to a scope and found in the user profile,",
        "                     * but also requested by the client with required values that don't match the computed one.",
        "                     * @see {link https://openid.net/specs/openid-connect-core-1_0.html#IndividualClaimsRequests}.",
        "                     * for the relevant OIDC specification details.",
        "                     */",
        "                    computedClaims.remove(claim.getName());",
        "                }",
        "            });",
        "",
        "            return computedClaims;",
        "        }",
        "",
        "        /**",
        "         * Creates a map of requested scopes and the corresponding claim names.",
        "         * @returns {java.util.LinkedHashMap}",
        "         */",
        "        function getCompositeScopes () {",
        "            var compositeScopes = new frJava.LinkedHashMap();",
        "",
        "            scopes.toArray().forEach(function (scope) {",
        "                var scopeClaims = new frJava.ArrayList();",
        "",
        "                if (scopeClaimsMap[scope]) {",
        "                    scopeClaimsMap[scope].forEach(function (claimName) {",
        "                        scopeClaims.add(claimName);",
        "                    });",
        "                }",
        "",
        "                if (scopeClaims.size()) {",
        "                    compositeScopes.put(scope, scopeClaims);",
        "                }",
        "            });",
        "",
        "            return compositeScopes;",
        "        }",
        "",
        "        // PUBLIC METHODS",
        "",
        "        return {",
        "            setScopeClaimsMap: setScopeClaimsMap,",
        "            setClaimResolvers: setClaimResolvers,",
        "            getUserProfileClaimResolver: getUserProfileClaimResolver,",
        "            getAddressClaimResolver: getAddressClaimResolver,",
        "            getEssentialClaimResolver: getEssentialClaimResolver,",
        "            getUserInfoClaims: getUserInfoClaims",
        "        };",
        "    }",
        "",
        "    // RESULTS",
        "",
        "    /**",
        "     * This script returns an instance of the org.forgerock.oauth2.core.UserInfoClaims class",
        "     * populated with the computed claim values and",
        "     * the requested scopes mapped to the claim names.",
        "     * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html}.",
        "     *",
        "     * Assigning it to a variable gives you an opportunity",
        "     * to log the content of the returned value during development.",
        "     */",
        "    var userInfoClaims = utils.getUserInfoClaims();",
        "",
        "    /*",
        "    logger.error(scriptName + ' results:')",
        "    logger.error('Values: ' + userInfoClaims.getValues())",
        "    logger.error('Scopes: ' + userInfoClaims.getCompositeScopes())",
        "    */",
        "",
        "    return userInfoClaims;",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Alpha-endUserUIClient-OAuth2-Access-Token-Modification-Script.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "e232cff3-2460-47cd-80b2-36c86c0d0f06": {
      "_id": "e232cff3-2460-47cd-80b2-36c86c0d0f06",
      "context": "OAUTH2_ACCESS_TOKEN_MODIFICATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Used by endUserUIClient",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Alpha endUserUIClient OAuth2 Access Token Modification Script",
      "script": [
        "(function () {",
        "  if (scopes.contains('fr:autoaccess:*') || scopes.contains('fr:iga:*')) {",
        "    var fr = JavaImporter(",
        "      com.sun.identity.idm.IdType",
        "    );",
        "    var groups = [];",
        "    identity.getMemberships(fr.IdType.GROUP).toArray().forEach(function (group) {",
        "      groups.push(group.getAttribute('cn').toArray()[0]);",
        "    });",
        "    accessToken.setField('groups', groups);",
        "  }",
        "}());",
        "",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Alpha-endUserUIClient-OIDC-Claims-Script.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "e1db8a0a-0329-4962-a5bf-ecffaca376ae": {
      "_id": "e1db8a0a-0329-4962-a5bf-ecffaca376ae",
      "context": "OIDC_CLAIMS",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Used by endUserUIClient",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Alpha endUserUIClient OIDC Claims Script",
      "script": [
        "/*",
        " * Copyright 2014-2021 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        " * This script computes claim values returned in ID tokens and/or at the UserInfo Endpoint.",
        " * The claim values are computed for:",
        " * the claims derived from the requested scopes,",
        " * the claims provided by the authorization server,",
        " * and the claims requested by the client via the claims parameter.",
        " *",
        " * In the CONFIGURATION AND CUSTOMIZATION section, you can",
        " * define the scope-to-claims mapping, and",
        " * assign to each claim a resolver function that will compute the claim value.",
        " *",
        " * Defined variables (class references are provided below):",
        " * scopes - Set<String> (6).",
        " *          Always present, the requested scopes.",
        " * claims - Map<String, Object> (5).",
        " *          Always present, default server provided claims.",
        " * claimObjects - List<Claim> (7, 2).",
        " *                Always present, the default server provided claims.",
        " * requestedClaims - Map<String, Set<String>> (5).",
        " *                   Always present, not empty if the request contains the claims parameter and the server has enabled",
        " *                   claims_parameter_supported. A map of the requested claims to possible values, otherwise empty;",
        " *                   requested claims with no requested values will have a key but no value in the map. A key with",
        " *                   a single value in its Set (6) indicates that this is the only value that should be returned.",
        " * requestedTypedClaims - List<Claim> (7, 2).",
        " *                        Always present, the requested claims.",
        " *                        Requested claims with no requested values will have a claim with no values.",
        " *                        A claim with a single value indicates this is the only value that should be returned.",
        " * claimsLocales - List<String> (7).",
        " *                 The values from the 'claims_locales' parameter.",
        " *                 See https://openid.net/specs/openid-connect-core-1_0.html#ClaimsLanguagesAndScripts for the OIDC specification details.",
        " * requestProperties - Unmodifiable Map (5).",
        " *                     Always present, contains a map of request properties:",
        " *                     requestUri - The request URI.",
        " *                     realm - The realm that the request relates to.",
        " *                     requestParams - A map of the request params and/or posted data.",
        " *                                     Each value is a list of one or more properties.",
        " *                                     Please note that these should be handled in accordance with OWASP best practices:",
        " *                                     https://owasp.org/www-community/vulnerabilities/Unsafe_use_of_Reflection.",
        " * clientProperties - Unmodifiable Map (5).",
        " *                    Present if the client specified in the request was identified, contains a map of client properties:",
        " *                    clientId - The client's URI for the request locale.",
        " *                    allowedGrantTypes - List of the allowed grant types (org.forgerock.oauth2.core.GrantType) for the client.",
        " *                    allowedResponseTypes - List of the allowed response types for the client.",
        " *                    allowedScopes - List of the allowed scopes for the client.",
        " *                    customProperties - A map of the custom properties of the client.",
        " *                                       Lists or maps will be included as sub-maps; for example:",
        " *                                       customMap[Key1]=Value1 will be returned as customMap -> Key1 -> Value1.",
        " *                                       To add custom properties to a client, update the Custom Properties field",
        " *                                       in AM Console > Realm Name > Applications > OAuth 2.0 > Clients > Client ID > Advanced.",
        " * identity - AMIdentity (3).",
        " *            Always present, the identity of the resource owner.",
        " * session - SSOToken (4).",
        " *           Present if the request contains the session cookie, the user's session object.",
        " * scriptName - String (primitive).",
        " *              Always present, the display name of the script.",
        " * logger - Always present, the "OAuth2Provider" debug logger instance:",
        " *          https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.",
        " *          Corresponding files will be prefixed with: scripts.OIDC_CLAIMS.",
        " * httpClient - HTTP Client (8).",
        " *              Always present, the HTTP Client instance:",
        " *              https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-http-client.html#scripting-api-global-http-client.",
        " *              In order to use the client, you may need to add",
        " *              org.forgerock.http.Client,",
        " *              org.forgerock.http.protocol.*,",
        " *              and org.forgerock.util.promise.PromiseImpl",
        " *              to the allowed Java classes in the scripting engine configuration, as described in:",
        " *              https://backstage.forgerock.com/docs/am/7/scripting-guide/script-engine-security.html",
        " *",
        " * Return - a new UserInfoClaims(Map<String, Object> values, Map<String, List<String>> compositeScopes) (1) object.",
        " *          The result of the last statement in the script is returned to the server.",
        " *          Currently, the Immediately Invoked Function Expression (also known as Self-Executing Anonymous Function)",
        " *          is the last (and only) statement in this script, and its return value will become the script result.",
        " *          Do not use "return variable" statement outside of a function definition.",
        " *          See RESULTS section for additional details.",
        " *",
        " * Class reference:",
        " * (1) UserInfoClaims - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html.",
        " * (2) Claim - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html).",
        " *         An instance of org.forgerock.openidconnect.Claim has methods to access",
        " *         the claim name, requested values, locale, and whether the claim is essential.",
        " * (3) AMIdentity - https://backstage.forgerock.com/docs/am/7/apidocs/com/sun/identity/idm/AMIdentity.html.",
        " * (4) SSOToken - https://backstage.forgerock.com/docs/am/7/apidocs/com/iplanet/sso/SSOToken.html.",
        " * (5) Map - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashMap.html,",
        " *           or https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/LinkedHashMap.html.",
        " * (6) Set - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashSet.html.",
        " * (7) List - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/ArrayList.html.",
        " * (8) Client - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/http/Client.html.",
        "*/",
        "",
        "(function () {",
        "    // SETUP",
        "",
        "    /**",
        "     * Claim processing utilities.",
        "     * An object that contains reusable functions for processing claims.",
        "     * @see CLAIM PROCESSING UTILITIES section for details.",
        "     */",
        "    var utils = getUtils();",
        "",
        "    // CONFIGURATION AND CUSTOMIZATION",
        "",
        "    /**",
        "     * OAuth 2.0 scope values (scopes) can be used by the Client to request OIDC claims.",
        "     *",
        "     * Call this configuration method, and pass in as the first argument",
        "     * an object that maps a scope value to an array of claim names",
        "     * to specify which claims need to be processed and returned for the requested scopes.",
        "     * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#ScopeClaims}",
        "     * for the scope values that could be used to request claims as defined in the OIDC specification.",
        "     *",
        "     * Below, find a default configuration that is expected to work in the current environment.",
        "     *",
        "     * CUSTOMIZATION",
        "     * You can choose the claim names returned for a scope.",
        "     */",
        "    utils.setScopeClaimsMap({",
        "        profile: [",
        "            'name',",
        "            'family_name',",
        "            'given_name',",
        "            'zoneinfo',",
        "            'locale'",
        "        ],",
        "        email: ['email'],",
        "        address: ['address'],",
        "        phone: ['phone_number']",
        "    });",
        "",
        "    /**",
        "     * In this script, each claim",
        "     * derived from the requested scopes,",
        "     * provided by the authorization server, and",
        "     * requested by the client via the claims parameter",
        "     * will be processed by a function associated with the claim name.",
        "     *",
        "     * Call this configuration method, and pass in as the first argument",
        "     * an object that maps a claim name to a resolver function,",
        "     * which will be automatically executed for each claim processed by the script.",
        "     *",
        "     * The claim resolver function will receive the requested claim information",
        "     * in an instance of org.forgerock.openidconnect.Claim as the first argument.",
        "     * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html}",
        "     * for details on the Claim class.",
        "     *",
        "     * If the claim resolver function returns a value,",
        "     * other than undefined or null,",
        "     * the claim will be included in the script's results.",
        "     *",
        "     * The Claim instance provides methods to check",
        "     * what the name of the claim is,",
        "     * which values the claim request contains,",
        "     * whether the claim is essential, and",
        "     * which locale the claim is associated with.",
        "     * The resolver function can consider this information when computing and returning the claim value.",
        "     *",
        "     * Below, find a default configuration that is expected to work in the current environment.",
        "     * A reusable function, utils.getUserProfileClaimResolver(String attribute-name),",
        "     * is called to return a claim resolver function based on a user profile attribute.",
        "     * @see CLAIM RESOLVERS section for the implementation details and examples.",
        "     * For the address claim, an example of a claim resolver that uses another claim resolver is provided.",
        "     *",
        "     * CUSTOMIZATION",
        "     * You can reuse the predefined utils methods with your custom arguments.",
        "     * You can also specify a custom resolver function for a claim name,",
        "     * that will compute and return the claim value—as shown in the commented out example below.",
        "     */",
        "    utils.setClaimResolvers({",
        "        /*",
        "        // An example of a simple claim resolver function that is defined for a claim",
        "        // directly in the configuration object:",
        "        custom-claim-name: function (requestedClaim) {",
        "            // In this case, initially, the claim value comes straight from a user profile attribute value:",
        "            var claimValue = identity.getAttribute('custom-attribute-name').toArray()[0]",
        "",
        "            // Optionally, provide additional logic for processing (filtering, formatting, etc.) the claim value.",
        "            // You can use:",
        "            // requestedClaim.getName()",
        "            // requestedClaim.getValues()",
        "            // requestedClaim.getLocale()",
        "            // requestedClaim.isEssential()",
        "",
        "            return claimValue",
        "        },",
        "        */",
        "        /**",
        "         * The use of utils.getUserProfileClaimResolver shows how",
        "         * an argument passed to a function that returns a claim resolver",
        "         * becomes available to the resolver function (via its lexical context).",
        "         */",
        "        name: utils.getUserProfileClaimResolver('cn'),",
        "        family_name: utils.getUserProfileClaimResolver('sn'),",
        "        given_name: utils.getUserProfileClaimResolver('givenname'),",
        "        zoneinfo: utils.getUserProfileClaimResolver('preferredtimezone'),",
        "        locale: utils.getUserProfileClaimResolver('preferredlocale'),",
        "        email: utils.getUserProfileClaimResolver('mail'),",
        "        address: utils.getAddressClaimResolver(",
        "            /**",
        "             * The passed in user profile claim resolver function",
        "             * can be used by the address claim resolver function",
        "             * to obtain the claim value to be formatted as per the OIDC specification:",
        "             * @see https://openid.net/specs/openid-connect-core-1_0.html#AddressClaim.",
        "             */",
        "            utils.getUserProfileClaimResolver('postaladdress')",
        "        ),",
        "        phone_number: utils.getUserProfileClaimResolver('telephonenumber')",
        "    });",
        "",
        "    // CLAIM PROCESSING UTILITIES",
        "",
        "    /**",
        "     * @returns {object} An object that contains reusable claim processing utilities.",
        "     * @see PUBLIC METHODS section and the return statement for the list of exported functions.",
        "     */",
        "    function getUtils () {",
        "        // IMPORT JAVA",
        "",
        "        /**",
        "         * Provides Java scripting functionality.",
        "         * @see {@link https://developer.mozilla.org/en-US/docs/Mozilla/Projects/Rhino/Scripting_Java#javaimporter_constructor}.",
        "         */",
        "        var frJava = JavaImporter(",
        "            org.forgerock.oauth2.core.exceptions.InvalidRequestException,",
        "            org.forgerock.oauth2.core.UserInfoClaims,",
        "            org.forgerock.openidconnect.Claim,",
        "",
        "            java.util.LinkedHashMap,",
        "            java.util.ArrayList",
        "        );",
        "",
        "        // SET UP CONFIGURATION",
        "",
        "        /**",
        "         * Placeholder for a configuration option that contains",
        "         * an object that maps the supported scope values (scopes)",
        "         * and the corresponding claim names for each scope value.",
        "         */",
        "        var scopeClaimsMap;",
        "",
        "        /**",
        "         * Placeholder for a configuration option that contains",
        "         * an object that maps the supported claim names",
        "         * and the resolver functions returning the claim value.",
        "         */",
        "        var claimResolvers;",
        "",
        "        /**",
        "         * A (public) method that accepts an object that maps the supported scopes and the corresponding claim names,",
        "         * and assigns it to a (private) variable that serves as a configuration option.",
        "         * @param {object} params - An object that maps each supported scope value to an array of claim names,",
        "         * in order to specify which claims need to be processed for the requested scopes.",
        "         * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#ScopeClaims} for details.",
        "         * @param {string[]} [params.profile] - An array of claim names to be returned if the profile scope is requested.",
        "         * @param {string[]} [params.email] - An array of claim names to be returned if the email scope is requested.",
        "         * @param {string[]} [params.address] - An array of claim names to be returned if the address scope is requested.",
        "         * @param {string[]} [params.phone] - An array of claim names to be returned if the phone scope is requested.",
        "         * @returns {undefined}",
        "         */",
        "        function setScopeClaimsMap(params) {",
        "            scopeClaimsMap = params;",
        "        }",
        "",
        "        /**",
        "         * A (public) method that accepts an object that maps the supported claim names",
        "         * and the resolver functions returning the claim value,",
        "         * and assigns it to a (private) variable that serves as a configuration option.",
        "         * @param {object} params - An object that maps",
        "         * each supported claim name to a function that computes and returns the claim value.",
        "         */",
        "        function setClaimResolvers(params) {",
        "            claimResolvers = params;",
        "        }",
        "",
        "        // CLAIM RESOLVERS",
        "",
        "        /**",
        "         * Claim resolvers are functions that return a claim value.",
        "         * @param {*}",
        "         * @returns {*}",
        "         */",
        "",
        "        /**",
        "         * Defines a claim resolver based on a user profile attribute.",
        "         * @param {string} attributeName - Name of the user profile attribute.",
        "         * @returns {function} A function that will determine the claim value",
        "         * based on the user profile attribute and the (requested) claim properties.",
        "         */",
        "        function getUserProfileClaimResolver (attributeName) {",
        "            /**",
        "             * Resolves a claim with a user profile attribute value.",
        "             * Returns undefined if the identity attribute is not populated,",
        "             * OR if the claim has requested values that do not contain the identity attribute value.",
        "             * ATTENTION: the aforementioned comparison is case-sensitive.",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {string|HashSet|undefined}",
        "             */",
        "            function resolveClaim(claim) {",
        "                var userProfileValue;",
        "",
        "                if (identity) {",
        "                    userProfileValue = getClaimValueFromSet(claim, identity.getAttribute(attributeName));",
        "",
        "                    if (userProfileValue && !userProfileValue.isEmpty()) {",
        "                        if (!claim.getValues() || claim.getValues().isEmpty() || claim.getValues().contains(userProfileValue)) {",
        "                            return userProfileValue;",
        "                        }",
        "                    }",
        "                }",
        "            }",
        "",
        "            return resolveClaim;",
        "        }",
        "",
        "        /**",
        "         * Returns an address claim resolver based on a claim value obtained with another claim resolver.",
        "         * @param {function} resolveClaim - A function that returns a claim value.",
        "         * @returns {function} A function that will accept a claim as an argument,",
        "         * run the claim resolver function for the claim and obtain the claim value,",
        "         * and apply additional formatting to the value before returning it.",
        "         */",
        "        function getAddressClaimResolver (resolveClaim) {",
        "            /**",
        "             * Creates an address claim object from a value returned by a claim resolver,",
        "             * and returns the address claim object as the claim value.",
        "             * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#AddressClaim}.",
        "             * The claim value is obtained with a claim resolving function available from the closure.",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {java.util.LinkedHashMap|undefined} The address claim object created from a claim value.",
        "             */",
        "            function resolveAddressClaim(claim) {",
        "                var claimValue = resolveClaim(claim);",
        "                var addressObject;",
        "",
        "                if (isClaimValueValid(claimValue)) {",
        "                    addressObject = new frJava.LinkedHashMap();",
        "",
        "                    addressObject.put('formatted', claimValue);",
        "",
        "                    return addressObject;",
        "                }",
        "            }",
        "",
        "            return resolveAddressClaim;",
        "        }",
        "",
        "        /**",
        "         * Returns an essential claim resolver based on a claim value obtained with another claim resolver.",
        "         * @param {function} resolveClaim - A function that returns a claim value.",
        "         * @returns {function} A function that will accept a claim as an argument,",
        "         * run the claim resolver function for the claim and obtain the claim value,",
        "         * and apply additional logic for essential claims.",
        "         */",
        "        function getEssentialClaimResolver (resolveClaim) {",
        "            /**",
        "             * Returns a claim value or throws an error.",
        "             * The claim value is obtained with a claim resolving function available from the closure.",
        "             * Throws an exception if the claim is essential and no value is returned for the claim.",
        "             *",
        "             * Use of this resolver is optional.",
        "             * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#IndividualClaimsRequests} stating:",
        "             * "Note that even if the Claims are not available because the End-User did not authorize their release or they are not present,",
        "             * the Authorization Server MUST NOT generate an error when Claims are not returned, whether they are Essential or Voluntary,",
        "             * unless otherwise specified in the description of the specific claim."",
        "             *",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {*}",
        "             * @throws {org.forgerock.oauth2.core.exceptions.InvalidRequestException}",
        "             */",
        "            function resolveEssentialClaim(claim) {",
        "                var claimValue = resolveClaim(claim);",
        "",
        "                if (claim.isEssential() && !isClaimValueValid(claimValue)) {",
        "                    throw new frJava.InvalidRequestException('Could not provide value for essential claim: ' + claim.getName());",
        "                }",
        "",
        "                return claimValue;",
        "            }",
        "",
        "            return resolveEssentialClaim;",
        "        }",
        "",
        "        /**",
        "         * Provides default resolution for a claim.",
        "         * Use it if a claim-specific resolver is not defined in the configuration.",
        "         * @param {org.forgerock.openidconnect.Claim} claim",
        "         * An object that provides methods to obtain information/requirements associated with a claim.",
        "         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "         * @returns {*} A single value associated with this claim.",
        "         */",
        "        function resolveAnyClaim (claim) {",
        "            if (claim.getValues().size() === 1) {",
        "                return claim.getValues().toArray()[0];",
        "            }",
        "        }",
        "",
        "        // UTILITIES",
        "",
        "        /**",
        "         * Returns claim value from a set.",
        "         * If the set contains a single value, returns the value.",
        "         * If the set contains multiple values, returns the set.",
        "         * Otherwise, returns undefined.",
        "         *",
        "         * @param {org.forgerock.openidconnect.Claim} claim",
        "         * An object that provides methods to obtain information/requirements associated with a claim.",
        "         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "         * @param {java.util.HashSet} set The set—for example, a user profile attribute value.",
        "         * @returns {string|java.util.HashSet|undefined}",
        "         */",
        "        function getClaimValueFromSet (claim, set) {",
        "            if (set && set.size()) {",
        "                if (set.size() === 1) {",
        "                    return set.toArray()[0];",
        "                } else {",
        "                    return set;",
        "                }",
        "            } else if (logger.warningEnabled()) {",
        "                logger.warning('OIDC Claims script. Got an empty set for claim: ' + claim.getName());",
        "            }",
        "        }",
        "",
        "        function isClaimValueValid (claimValue) {",
        "            if (typeof claimValue === 'undefined' || claimValue === null) {",
        "                return false;",
        "            }",
        "",
        "            return true;",
        "        }",
        "",
        "        // CLAIM PROCESSING",
        "",
        "        /**",
        "         * Constructs and returns an object populated with the computed claim values",
        "         * and the requested scopes mapped to the claim names.",
        "         * @returns {org.forgerock.oauth2.core.UserInfoClaims} The object to be returned to the authorization server.",
        "         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html}.",
        "         * @see RESULTS section for the use of this function.",
        "         */",
        "        function getUserInfoClaims () {",
        "            return new frJava.UserInfoClaims(getComputedClaims(), getCompositeScopes());",
        "        }",
        "",
        "        /**",
        "         * Creates a map of (requested) claim names populated with the computed claim values.",
        "         * @returns {java.util.LinkedHashMap}",
        "         * A map of the requested claim names and the corresponding claim values.",
        "         */",
        "        function getComputedClaims () {",
        "            /**",
        "             * Creates a complete list of claim objects from:",
        "             * the claims derived from the scopes,",
        "             * the claims provided by the authorization server,",
        "             * and the claims requested by the client.",
        "             * @returns {java.util.ArrayList}",
        "             * Returns a complete list of org.forgerock.openidconnect.Claim objects available to the script.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for the claim object details.",
        "             */",
        "            function getClaims() {",
        "                /**",
        "                 * Returns a list of claim objects for the requested scopes.",
        "                 * Uses the scopeClaimsMap configuration option to derive the claim names;",
        "                 * no other properties of a claim derived from a scope are populated.",
        "                 * @returns {java.util.ArrayList}",
        "                 * A list of org.forgerock.openidconnect.Claim objects derived from the requested scopes.",
        "                 * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for the claim object details.",
        "                 */",
        "                function convertScopeToClaims() {",
        "                    var claims = new frJava.ArrayList();",
        "",
        "                    scopes.toArray().forEach(function (scope) {",
        "                        if (String(scope) !== 'openid' && scopeClaimsMap[scope]) {",
        "                            scopeClaimsMap[scope].forEach(function (claimName) {",
        "                                claims.add(new frJava.Claim(claimName));",
        "                            });",
        "                        }",
        "                    });",
        "",
        "                    return claims;",
        "                }",
        "",
        "                var claims = new frJava.ArrayList();",
        "",
        "                claims.addAll(convertScopeToClaims());",
        "                claims.addAll(claimObjects);",
        "                claims.addAll(requestedTypedClaims);",
        "",
        "                return claims;",
        "            }",
        "",
        "            /**",
        "             * Computes and returns a claim value.",
        "             * To obtain the claim value, uses the resolver function specified for the claim in the claimResolvers configuration object.",
        "             * @see claimResolvers",
        "             * If no resolver function is found, uses the default claim resolver function.",
        "             *",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {*} Claim value.",
        "             * @throws {org.forgerock.oauth2.core.exceptions.InvalidRequestException}",
        "             * Rethrows this exception if a claim resolver throws it.",
        "             * You can throw org.forgerock.oauth2.core.exceptions.InvalidRequestException from your custom claim resolver",
        "             * if you want to terminate the claim processing.",
        "             */",
        "            function computeClaim(claim) {",
        "                var resolveClaim;",
        "                var message;",
        "",
        "                try {",
        "                    resolveClaim = claimResolvers[claim.getName()] || resolveAnyClaim;",
        "",
        "                    return resolveClaim(claim);",
        "                } catch (e) {",
        "                    message = 'OIDC Claims script exception. Unable to resolve OIDC Claim. ' + e;",
        "",
        "                    if (String(e).indexOf('org.forgerock.oauth2.core.exceptions.InvalidRequestException') !== -1) {",
        "                        throw e;",
        "                    }",
        "",
        "                    if (logger.warningEnabled()) {",
        "                        logger.warning(message);",
        "                    }",
        "                }",
        "            }",
        "",
        "            var computedClaims = new frJava.LinkedHashMap();",
        "",
        "            getClaims().toArray().forEach(function (claim) {",
        "                var claimValue = computeClaim(claim);",
        "",
        "                if (isClaimValueValid(claimValue)) {",
        "                    computedClaims.put(claim.getName(), claimValue);",
        "                } else {",
        "                    /**",
        "                     * If a claim has been processed, but appears in the list again,",
        "                     * and its value cannot be computed under the new conditions,",
        "                     * the claim is removed from the final result.",
        "                     *",
        "                     * For example, a claim could be mapped to a scope and found in the user profile,",
        "                     * but also requested by the client with required values that don't match the computed one.",
        "                     * @see {link https://openid.net/specs/openid-connect-core-1_0.html#IndividualClaimsRequests}.",
        "                     * for the relevant OIDC specification details.",
        "                     */",
        "                    computedClaims.remove(claim.getName());",
        "                }",
        "            });",
        "",
        "            return computedClaims;",
        "        }",
        "",
        "        /**",
        "         * Creates a map of requested scopes and the corresponding claim names.",
        "         * @returns {java.util.LinkedHashMap}",
        "         */",
        "        function getCompositeScopes () {",
        "            var compositeScopes = new frJava.LinkedHashMap();",
        "",
        "            scopes.toArray().forEach(function (scope) {",
        "                var scopeClaims = new frJava.ArrayList();",
        "",
        "                if (scopeClaimsMap[scope]) {",
        "                    scopeClaimsMap[scope].forEach(function (claimName) {",
        "                        scopeClaims.add(claimName);",
        "                    });",
        "                }",
        "",
        "                if (scopeClaims.size()) {",
        "                    compositeScopes.put(scope, scopeClaims);",
        "                }",
        "            });",
        "",
        "            return compositeScopes;",
        "        }",
        "",
        "        // PUBLIC METHODS",
        "",
        "        return {",
        "            setScopeClaimsMap: setScopeClaimsMap,",
        "            setClaimResolvers: setClaimResolvers,",
        "            getUserProfileClaimResolver: getUserProfileClaimResolver,",
        "            getAddressClaimResolver: getAddressClaimResolver,",
        "            getEssentialClaimResolver: getEssentialClaimResolver,",
        "            getUserInfoClaims: getUserInfoClaims",
        "        };",
        "    }",
        "",
        "    // RESULTS",
        "",
        "    /**",
        "     * This script returns an instance of the org.forgerock.oauth2.core.UserInfoClaims class",
        "     * populated with the computed claim values and",
        "     * the requested scopes mapped to the claim names.",
        "     * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html}.",
        "     *",
        "     * Assigning it to a variable gives you an opportunity",
        "     * to log the content of the returned value during development.",
        "     */",
        "    var userInfoClaims = utils.getUserInfoClaims();",
        "",
        "    /*",
        "    logger.error(scriptName + ' results:')",
        "    logger.error('Values: ' + userInfoClaims.getValues())",
        "    logger.error('Scopes: ' + userInfoClaims.getCompositeScopes())",
        "    */",
        "",
        "    return userInfoClaims;",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Amazon-Profile-Normalization.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "6b3cfd48-62d3-48ff-a96f-fe8f3a22ab30": {
      "_id": "6b3cfd48-62d3-48ff-a96f-fe8f3a22ab30",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from Amazon",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Amazon Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "return json(object(",
        "        field("id", rawProfile.user_id),",
        "        field("displayName", rawProfile.name),",
        "        field("email", rawProfile.email),",
        "        field("username", rawProfile.email)))",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Apple-Profile-Normalization.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "484e6246-dbc6-4288-97e6-54e55431402e": {
      "_id": "484e6246-dbc6-4288-97e6-54e55431402e",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from Apple",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Apple Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2021-2022 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " *",
        " * In some common default configurations, the following keys are required to be not empty:",
        " * username, givenName, familyName, email.",
        " *",
        " * From RFC4517: A value of the Directory String syntax is a string of one or more",
        " * arbitrary characters from the Universal Character Set (UCS).",
        " * A zero-length character string is not permitted.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "String email = "change@me.com"",
        "String subjectId = rawProfile.sub",
        "String firstName = " "",
        "String lastName = " "",
        "String username = subjectId",
        "String name",
        "",
        "if (rawProfile.isDefined("email") && rawProfile.email.isNotNull()){ // User can elect to not share their email",
        "    email = rawProfile.email.asString()",
        "    username = email",
        "}",
        "if (rawProfile.isDefined("name") && rawProfile.name.isNotNull()) {",
        "    if (rawProfile.name.isDefined("firstName") && rawProfile.name.firstName.isNotNull()) {",
        "        firstName = rawProfile.name.firstName.asString()",
        "    }",
        "    if (rawProfile.name.isDefined("lastName") && rawProfile.name.lastName.isNotNull()) {",
        "        lastName = rawProfile.name.lastName.asString()",
        "    }",
        "}",
        "",
        "name = (firstName?.trim() ? firstName : "") + (lastName?.trim() ? ((firstName?.trim() ? " " : "") + lastName) : "")",
        "name =  (!name?.trim()) ? " " : name",
        "",
        "return json(object(",
        "        field("id", subjectId),",
        "        field("displayName", name),",
        "        field("email", email),",
        "        field("givenName", firstName),",
        "        field("familyName", lastName),",
        "        field("username", username)))",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Authentication-Tree-Decision-Node-Script.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "01e1a3c0-038b-4c16-956a-6c9d89328cff": {
      "_id": "01e1a3c0-038b-4c16-956a-6c9d89328cff",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Default global script for a scripted decision node",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Authentication Tree Decision Node Script",
      "script": [
        "/*",
        "  - Data made available by nodes that have already executed are available in the sharedState variable.",
        "  - The script should set outcome to either "true" or "false".",
        " */",
        "",
        "outcome = "true";",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Browser-Language-Decision.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "8508a00e-ad45-4310-b3c7-c6871b6a41a9": {
      "_id": "8508a00e-ad45-4310-b3c7-c6871b6a41a9",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Browser Language Decision",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Browser Language Decision",
      "script": [
        "/* Browser Language Decision",
        " * ",
        " * Detect the browser language in the request and branch out to its named exit (e.g.: "de" or "en" or "fr") ",
        " * if it is part of the supportedLanguages array, otherwise take the "other" exit.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - other",
        " * - <all of the items in the supportedLanguages array>",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "      /******************************/",
        "      /* Begin Script Configuration */",
        "      ",
        "      // add all the language codes you want to support",
        "      var supportedLanguages = ["de","en","fr"];",
        "      ",
        "      /* End Script Configuration   */",
        "      /******************************/",
        "  ",
        "      outcome = getBrowserLanguage();",
        "      ",
        "    /*",
        "     * Returns the supported browser language or "other"",
        "     */",
        "    function getBrowserLanguage() {",
        "          var languageHeader = getHeader("accept-language");",
        "          var language = languageHeader.split(';')[0].split(',')[0].split('-')[0];",
        "          if (supportedLanguages.indexOf(language) < 0) {",
        "              return "other";",
        "        }",
        "        return language;",
        "    }",
        "",
        "    /*",
        "     * Returns the value of the requested header",
        "     */",
        "    function getHeader(headerName) {",
        "        return requestHeaders.get(headerName).get(0)+"";",
        "    }",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./CP-ITE-static-inner1.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "638c865e-d393-4503-a517-535b9c74e010": {
      "_id": "638c865e-d393-4503-a517-535b9c74e010",
      "context": "CONFIG_PROVIDER_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "CP-InnerTreeEvaluator-static-inner1",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "CP-ITE-static-inner1",
      "script": [
        "/*",
        " * Copyright 2021 ForgeRock AS. All Rights Reserved",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/**",
        " * The following script is a simplified template for understanding how to build",
        " * up a config Map object with custom values. The Config Provider Node will then",
        " * provide this config Map to the desired node type. It is important that the Map",
        " * you build here is named 'config'.",
        " *",
        " * Defined variables:",
        " *",
        " * nodeState - Node State (1)",
        " *           Always present, this represents the current values stored in the node state.",
        " *",
        " * idRepository - Profile Data (2)",
        " *           Always present, a repository to retrieve user information.",
        " *",
        " * secrets - Credentials and Secrets (3)",
        " *           Always present, an interface to access the Secrets API from a scripting context.",
        " *",
        " * requestHeaders (4) - Map (5)",
        " *           Always present, an object that provides methods for accessing headers in the login request.",
        " *",
        " * logger - Debug Logging (6)",
        " *          Always present, the debug logger instance.",
        " *",
        " * httpClient - HTTP Client (7)",
        " *          Always present, the HTTP client that can be used to make external HTTP requests.",
        " *",
        " * realm - String (primitive).",
        " *          Always present, the name of the realm the user is authenticating to.",
        " *",
        " * existingSession - Map<String, String> (5)",
        " *          Present if the request contains the session cookie, the user's session object. The returned map from",
        " *          SSOToken.getProperties() (8)",
        " *",
        " * requestParameters - Map (5)",
        " *          Always present, the object that contains the authentication request parameters.",
        " *",
        " *",
        " * Outputs:",
        " *",
        " * config - Map (5)",
        " *           Define and fill a Map object named 'config' with custom values, this will define the configuration for the",
        " *           associated node selected in the ConfigProviderNode.",
        " *",
        " * Reference:",
        " * (1) Node State - https://backstage.forgerock.com/docs/idcloud-am/latest/authentication-guide/scripting-api-node.html#scripting-api-node-nodeState",
        " * (2) Profile Data - https://backstage.forgerock.com/docs/am/7.1/authentication-guide/scripting-api-node.html#scripting-api-node-id-repo",
        " * (3) Credentials and Secrets - https://backstage.forgerock.com/docs/am/7.1/authentication-guide/scripting-api-node.html#scripting-api-authn-secrets",
        " * (4) Request Headers - https://backstage.forgerock.com/docs/am/7/authentication-guide/scripting-api-node.html#scripting-api-node-requestHeaders.",
        " * (5) Map - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/Map.html",
        " * (6) Debug Logging - https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.",
        " * (7) HTTP Client - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/http/Client.html.",
        " * (8) SSOToken - https://backstage.forgerock.com/docs/am/7/apidocs/com/iplanet/sso/SSOToken.html.",
        " */",
        "",
        "config = {",
        "  tree: 'inner1'",
        "};",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./CP-ITE-static-inner2.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "740cf6fa-a173-4e9d-b17c-44758e9b19ec": {
      "_id": "740cf6fa-a173-4e9d-b17c-44758e9b19ec",
      "context": "CONFIG_PROVIDER_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "CP-InnerTreeEvaluator-static-inner2",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "CP-ITE-static-inner2",
      "script": [
        "/*",
        " * Copyright 2021 ForgeRock AS. All Rights Reserved",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/**",
        " * The following script is a simplified template for understanding how to build",
        " * up a config Map object with custom values. The Config Provider Node will then",
        " * provide this config Map to the desired node type. It is important that the Map",
        " * you build here is named 'config'.",
        " *",
        " * Defined variables:",
        " *",
        " * nodeState - Node State (1)",
        " *           Always present, this represents the current values stored in the node state.",
        " *",
        " * idRepository - Profile Data (2)",
        " *           Always present, a repository to retrieve user information.",
        " *",
        " * secrets - Credentials and Secrets (3)",
        " *           Always present, an interface to access the Secrets API from a scripting context.",
        " *",
        " * requestHeaders (4) - Map (5)",
        " *           Always present, an object that provides methods for accessing headers in the login request.",
        " *",
        " * logger - Debug Logging (6)",
        " *          Always present, the debug logger instance.",
        " *",
        " * httpClient - HTTP Client (7)",
        " *          Always present, the HTTP client that can be used to make external HTTP requests.",
        " *",
        " * realm - String (primitive).",
        " *          Always present, the name of the realm the user is authenticating to.",
        " *",
        " * existingSession - Map<String, String> (5)",
        " *          Present if the request contains the session cookie, the user's session object. The returned map from",
        " *          SSOToken.getProperties() (8)",
        " *",
        " * requestParameters - Map (5)",
        " *          Always present, the object that contains the authentication request parameters.",
        " *",
        " *",
        " * Outputs:",
        " *",
        " * config - Map (5)",
        " *           Define and fill a Map object named 'config' with custom values, this will define the configuration for the",
        " *           associated node selected in the ConfigProviderNode.",
        " *",
        " * Reference:",
        " * (1) Node State - https://backstage.forgerock.com/docs/idcloud-am/latest/authentication-guide/scripting-api-node.html#scripting-api-node-nodeState",
        " * (2) Profile Data - https://backstage.forgerock.com/docs/am/7.1/authentication-guide/scripting-api-node.html#scripting-api-node-id-repo",
        " * (3) Credentials and Secrets - https://backstage.forgerock.com/docs/am/7.1/authentication-guide/scripting-api-node.html#scripting-api-authn-secrets",
        " * (4) Request Headers - https://backstage.forgerock.com/docs/am/7/authentication-guide/scripting-api-node.html#scripting-api-node-requestHeaders.",
        " * (5) Map - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/Map.html",
        " * (6) Debug Logging - https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.",
        " * (7) HTTP Client - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/http/Client.html.",
        " * (8) SSOToken - https://backstage.forgerock.com/docs/am/7/apidocs/com/iplanet/sso/SSOToken.html.",
        " */",
        "",
        "config = {",
        "  tree: 'inner2'",
        "};",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Check-Existing-Session.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "0ab1dd57-eafd-4063-8e60-65bfac8108b7": {
      "_id": "0ab1dd57-eafd-4063-8e60-65bfac8108b7",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Check existing session and set username",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Check Existing Session",
      "script": [
        "if (typeof existingSession !== 'undefined')",
        "{",
        "  outcome = "hasSession";",
        "  sharedState.put("username", existingSession.get("UserId"));",
        "  sharedState.put("_id", existingSession.get("UserId"));",
        "  if (sharedState.get("objectAttributes")) {",
        "    sharedState.get("objectAttributes").put("userName", existingSession.get("UserId"));",
        "  }",
        "  else {",
        "    sharedState.put("objectAttributes", {userName: existingSession.get("UserId")});",
        "  }",
        "}",
        "else",
        "{",
        "  outcome = "noSession";",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Check-Username.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "739bdc48-fd24-4c52-b353-88706d75558a": {
      "_id": "739bdc48-fd24-4c52-b353-88706d75558a",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Check if username has already been collected.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Check Username",
      "script": [
        "/* Check Username",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Check if username has already been collected.",
        " * Return "known" if yes, "unknown" otherwise.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - known",
        " * - unknown",
        " */",
        "(function () {",
        "    if (null != sharedState.get("username")) {",
        "        outcome = "known";",
        "    }",
        "    else {",
        "        outcome = "unknown";",
        "    }",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Choice-inner1-inner2.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "14f14ad3-f35f-455b-a7ba-d7cd939c6921": {
      "_id": "14f14ad3-f35f-455b-a7ba-d7cd939c6921",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Dropdown selector",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Choice inner1, inner2",
      "script": [
        "/* Choice inner1, inner2",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Render a dropdown selector",
        " * ",
        " * This script must be parametrized. It will not work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "(function () {",
        "  outcome = "true";",
        "  var choices = ["inner1", "inner2"];",
        "  ",
        "  var fr = JavaImporter(",
        "    org.forgerock.openam.auth.node.api.Action,",
        "    javax.security.auth.callback.ChoiceCallback",
        "  )",
        "",
        "  if (callbacks.isEmpty()) {",
        "    action = fr.Action.send([",
        "      new fr.ChoiceCallback("Select a journey", choices, 0, false)",
        "    ]).build();",
        "  } else {",
        "    var choice = parseInt(callbacks.get(0).getSelectedIndexes()[0]);",
        "    nodeState.putShared("nodeConfig", {tree: choices[choice]});",
        "    action = fr.Action.goTo(outcome).build();",
        "  }",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Collect-Extra-Fields.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "92edf2c7-0bab-412c-a0da-82ad4f04505b": {
      "_id": "92edf2c7-0bab-412c-a0da-82ad4f04505b",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Collect Extra Fields",
      "script": [
        "/* Collect Extra Fields",
        " * ",
        " * Collect extra fields not part of the user profile.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    outcome = 'true';",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "          javax.security.auth.callback.NameCallback",
        "    )",
        "    if (callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "            new fr.NameCallback('modality'),",
        "            new fr.NameCallback('jwtToken')",
        "        ).build();",
        "    }",
        "    else {",
        "          var modality = callbacks.get(0).getName();",
        "          var jwtToken = callbacks.get(1).getName();",
        "          nodeState.putShared('modality', modality);",
        "          nodeState.putShared('jwtToken', jwtToken);",
        "        action = fr.Action.goTo(outcome).build();",
        "    }",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Collect-Inner-Tree-Evaluator-Config.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "d70df7a8-6390-409d-b821-166272a9a9c8": {
      "_id": "d70df7a8-6390-409d-b821-166272a9a9c8",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Collect all the configuration items required for the Inner Tree Evaluator to function properly.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Collect Inner Tree Evaluator Config",
      "script": [
        "/* Collect Inner Tree Evaluator Config",
        " * ",
        " * Collect all the configuration items required for the Inner Tree Evaluator to function properly.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    outcome = "true";",
        "      var config = {",
        "        "tree": "Login",",
        "    };",
        "      var script = "";",
        "    script += "Array.prototype.slice.call(";",
        "    script += "    document.getElementsByTagName('input')";",
        "    script += ").forEach(";",
        "    script += "    function (input,i) {";",
        "    script += "        console.log('input '+i);"",
        "    script += "        var config = JSON.parse('"+JSON.stringify(config)+"');";",
        "    script += "        var keys = Object.keys(config);";",
        "    script += "        if (input.type === 'text') {";",
        "    script += "            input.setAttribute('value', config[keys[i]]);";",
        "    script += "            input.dispatchEvent(new KeyboardEvent( 'input' , {'key':'Enter'} ));";",
        "    script += "        }";",
        "    script += "    }";",
        "    script += ");";",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "          javax.security.auth.callback.NameCallback,",
        "        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        "    )",
        "    if (callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "            new fr.NameCallback("tree", config.tree),",
        "              new fr.ScriptTextOutputCallback(script)",
        "        ).build();",
        "    }",
        "    else {",
        "          config[callbacks.get(0).getPrompt()] = callbacks.get(0).getName();",
        "          nodeState.putShared("nodeConfig", config);",
        "        action = fr.Action.goTo(outcome).build();",
        "    }",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Collect-Message-Node-Config.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "169150da-0bd1-4866-8095-eae0bbc269e4": {
      "_id": "169150da-0bd1-4866-8095-eae0bbc269e4",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Collect all the configuration items required for the Message Node to function properly.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Collect Message Node Config",
      "script": [
        "/* Collect Message Node Config",
        " * ",
        " * Collect all the configuration items required for the Message Node to function properly.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    outcome = "true";",
        "      var config = {",
        "        "message": {"en": "I believe I can fly!"},",
        "        "messageYes": {"en": "Glorious!"},",
        "        "messageNo": {"en": "Inconceivable!"}",
        "    };",
        "      var script = "";",
        "    script += "Array.prototype.slice.call(";",
        "    script += "    document.getElementsByTagName('input')";",
        "    script += ").forEach(";",
        "    script += "    function (input,i) {";",
        "    script += "        console.log('input '+i);"",
        "    script += "        var config = JSON.parse('"+JSON.stringify(config)+"');";",
        "    script += "        var keys = Object.keys(config);";",
        "    script += "        if (input.type === 'text') {";",
        "    script += "            input.setAttribute('value', config[keys[i]].en);";",
        "    script += "            input.dispatchEvent(new KeyboardEvent( 'input' , {'key':'Enter'} ));";",
        "    script += "        }";",
        "    script += "    }";",
        "    script += ");";",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "          javax.security.auth.callback.NameCallback,",
        "        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        "    )",
        "    if (callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "            new fr.NameCallback("message", config.message.en),",
        "            new fr.NameCallback("messageYes", config.messageYes.en),",
        "            new fr.NameCallback("messageNo", config.messageNo.en),",
        "              new fr.ScriptTextOutputCallback(script)",
        "        ).build();",
        "    }",
        "    else {",
        "          config[callbacks.get(0).getPrompt()].en = callbacks.get(0).getName();",
        "          config[callbacks.get(1).getPrompt()].en = callbacks.get(1).getName();",
        "          config[callbacks.get(2).getPrompt()].en = callbacks.get(2).getName();",
        "          nodeState.putShared("nodeConfig", config);",
        "        action = fr.Action.goTo(outcome).build();",
        "    }",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Collect-PIN.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "e4417108-4dc9-4ffc-9995-3cd490adf2ed": {
      "_id": "e4417108-4dc9-4ffc-9995-3cd490adf2ed",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Collect PIN",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Collect PIN",
      "script": [
        "/* Collect PIN",
        " * ",
        " * Collect PIN using password callback and store in user profile.",
        " * ",
        " * This script must be parametrized. It may not work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "  ",
        "  /*** BEGIN PARAMETRIZATION ***/",
        "  var pinAttrName = 'frUnindexedString3';",
        "  var pinPrompt = 'New PIN';",
        "  /**** END PARAMETRIZATION ****/",
        "  ",
        "  outcome = 'true';",
        "  var fr = JavaImporter(",
        "    org.forgerock.openam.auth.node.api.Action,",
        "      javax.security.auth.callback.PasswordCallback",
        "  )",
        "  if (callbacks.isEmpty()) {",
        "    action = fr.Action.send(",
        "      new fr.PasswordCallback(pinPrompt, false)",
        "    ).build();",
        "  }",
        "  else {",
        "      var pin = new java.lang.String(callbacks.get(0).getPassword());",
        "    setTransientObjectAttribute(pinAttrName, pin);",
        "    action = fr.Action.goTo(outcome).build();",
        "  }",
        "",
        "  /*",
        "   * Store attributes in transient state for use with the Create/Patch Object nodes.",
        "   */",
        "  function setTransientObjectAttribute(name, value) {",
        "    var transientStorage = transientState.get("objectAttributes");",
        "    if (transientStorage && value) {",
        "      if (transientStorage.put) {",
        "        transientStorage.put(name, value);",
        "      }",
        "      else {",
        "        transientStorage[name] = value;",
        "      }",
        "    }",
        "    else if (value) {",
        "      transientState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "    }",
        "  }",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Collect-Replay-Password-(frUnindexedString2).script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "d82a4ad6-cd8a-437b-af55-7373e50d685b": {
      "_id": "d82a4ad6-cd8a-437b-af55-7373e50d685b",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Collect Replay Password (frUnindexedString2).",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Collect Replay Password (frUnindexedString2)",
      "script": [
        "/* Collect And Encrypt Custom Password",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * ",
        " * See copyright notices, conditions, and disclaimers at the bottom of this script.",
        " * ",
        " * volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    "use strict";var sjcl={cipher:{},hash:{},keyexchange:{},mode:{},misc:{},codec:{},exception:{corrupt:function(message){this.toString=function(){return"CORRUPT: "+this.message};this.message=message},invalid:function(message){this.toString=function(){return"INVALID: "+this.message};this.message=message},bug:function(message){this.toString=function(){return"BUG: "+this.message};this.message=message},notReady:function(message){this.toString=function(){return"NOT READY: "+this.message};this.message=message}}};sjcl.cipher.aes=function(key){if(!this._tables[0][0][0]){this._precompute()}var i,j,tmp,encKey,decKey,sbox=this._tables[0][4],decTable=this._tables[1],keyLen=key.length,rcon=1;if(keyLen!==4&&keyLen!==6&&keyLen!==8){throw new sjcl.exception.invalid("invalid aes key size")}this._key=[encKey=key.slice(0),decKey=[]];for(i=keyLen;i<4*keyLen+28;i++){tmp=encKey[i-1];if(i%keyLen===0||keyLen===8&&i%keyLen===4){tmp=sbox[tmp>>>24]<<24^sbox[tmp>>16&255]<<16^sbox[tmp>>8&255]<<8^sbox[tmp&255];if(i%keyLen===0){tmp=tmp<<8^tmp>>>24^rcon<<24;rcon=rcon<<1^(rcon>>7)*283}}encKey[i]=encKey[i-keyLen]^tmp}for(j=0;i;j++,i--){tmp=encKey[j&3?i:i-4];if(i<=4||j<4){decKey[j]=tmp}else{decKey[j]=decTable[0][sbox[tmp>>>24]]^decTable[1][sbox[tmp>>16&255]]^decTable[2][sbox[tmp>>8&255]]^decTable[3][sbox[tmp&255]]}}};sjcl.cipher.aes.prototype={encrypt:function(data){return this._crypt(data,0)},decrypt:function(data){return this._crypt(data,1)},_tables:[[[],[],[],[],[]],[[],[],[],[],[]]],_precompute:function(){var encTable=this._tables[0],decTable=this._tables[1],sbox=encTable[4],sboxInv=decTable[4],i,x,xInv,d=[],th=[],x2,x4,x8,s,tEnc,tDec;for(i=0;i<256;i++){th[(d[i]=i<<1^(i>>7)*283)^i]=i}for(x=xInv=0;!sbox[x];x^=x2||1,xInv=th[xInv]||1){s=xInv^xInv<<1^xInv<<2^xInv<<3^xInv<<4;s=s>>8^s&255^99;sbox[x]=s;sboxInv[s]=x;x8=d[x4=d[x2=d[x]]];tDec=x8*16843009^x4*65537^x2*257^x*16843008;tEnc=d[s]*257^s*16843008;for(i=0;i<4;i++){encTable[i][x]=tEnc=tEnc<<24^tEnc>>>8;decTable[i][s]=tDec=tDec<<24^tDec>>>8}}for(i=0;i<5;i++){encTable[i]=encTable[i].slice(0);decTable[i]=decTable[i].slice(0)}},_crypt:function(input,dir){if(input.length!==4){throw new sjcl.exception.invalid("invalid aes block size")}var key=this._key[dir],a=input[0]^key[0],b=input[dir?3:1]^key[1],c=input[2]^key[2],d=input[dir?1:3]^key[3],a2,b2,c2,nInnerRounds=key.length/4-2,i,kIndex=4,out=[0,0,0,0],table=this._tables[dir],t0=table[0],t1=table[1],t2=table[2],t3=table[3],sbox=table[4];for(i=0;i<nInnerRounds;i++){a2=t0[a>>>24]^t1[b>>16&255]^t2[c>>8&255]^t3[d&255]^key[kIndex];b2=t0[b>>>24]^t1[c>>16&255]^t2[d>>8&255]^t3[a&255]^key[kIndex+1];c2=t0[c>>>24]^t1[d>>16&255]^t2[a>>8&255]^t3[b&255]^key[kIndex+2];d=t0[d>>>24]^t1[a>>16&255]^t2[b>>8&255]^t3[c&255]^key[kIndex+3];kIndex+=4;a=a2;b=b2;c=c2}for(i=0;i<4;i++){out[dir?3&-i:i]=sbox[a>>>24]<<24^sbox[b>>16&255]<<16^sbox[c>>8&255]<<8^sbox[d&255]^key[kIndex++];a2=a;a=b;b=c;c=d;d=a2}return out}};sjcl.bitArray={bitSlice:function(a,bstart,bend){a=sjcl.bitArray._shiftRight(a.slice(bstart/32),32-(bstart&31)).slice(1);return bend===undefined?a:sjcl.bitArray.clamp(a,bend-bstart)},extract:function(a,bstart,blength){var x,sh=Math.floor(-bstart-blength&31);if((bstart+blength-1^bstart)&-32){x=a[bstart/32|0]<<32-sh^a[bstart/32+1|0]>>>sh}else{x=a[bstart/32|0]>>>sh}return x&(1<<blength)-1},concat:function(a1,a2){if(a1.length===0||a2.length===0){return a1.concat(a2)}var last=a1[a1.length-1],shift=sjcl.bitArray.getPartial(last);if(shift===32){return a1.concat(a2)}else{return sjcl.bitArray._shiftRight(a2,shift,last|0,a1.slice(0,a1.length-1))}},bitLength:function(a){var l=a.length,x;if(l===0){return 0}x=a[l-1];return(l-1)*32+sjcl.bitArray.getPartial(x)},clamp:function(a,len){if(a.length*32<len){return a}a=a.slice(0,Math.ceil(len/32));var l=a.length;len=len&31;if(l>0&&len){a[l-1]=sjcl.bitArray.partial(len,a[l-1]&2147483648>>len-1,1)}return a},partial:function(len,x,_end){if(len===32){return x}return(_end?x|0:x<<32-len)+len*1099511627776},getPartial:function(x){return Math.round(x/1099511627776)||32},equal:function(a,b){if(sjcl.bitArray.bitLength(a)!==sjcl.bitArray.bitLength(b)){return false}var x=0,i;for(i=0;i<a.length;i++){x|=a[i]^b[i]}return x===0},_shiftRight:function(a,shift,carry,out){var i,last2=0,shift2;if(out===undefined){out=[]}for(;shift>=32;shift-=32){out.push(carry);carry=0}if(shift===0){return out.concat(a)}for(i=0;i<a.length;i++){out.push(carry|a[i]>>>shift);carry=a[i]<<32-shift}last2=a.length?a[a.length-1]:0;shift2=sjcl.bitArray.getPartial(last2);out.push(sjcl.bitArray.partial(shift+shift2&31,shift+shift2>32?carry:out.pop(),1));return out},_xor4:function(x,y){return[x[0]^y[0],x[1]^y[1],x[2]^y[2],x[3]^y[3]]},byteswapM:function(a){var i,v,m=65280;for(i=0;i<a.length;++i){v=a[i];a[i]=v>>>24|v>>>8&m|(v&m)<<8|v<<24}return a}};sjcl.codec.utf8String={fromBits:function(arr){var out="",bl=sjcl.bitArray.bitLength(arr),i,tmp;for(i=0;i<bl/8;i++){if((i&3)===0){tmp=arr[i/4]}out+=String.fromCharCode(tmp>>>8>>>8>>>8);tmp<<=8}return decodeURIComponent(escape(out))},toBits:function(str){str=unescape(encodeURIComponent(str));var out=[],i,tmp=0;for(i=0;i<str.length;i++){tmp=tmp<<8|str.charCodeAt(i);if((i&3)===3){out.push(tmp);tmp=0}}if(i&3){out.push(sjcl.bitArray.partial(8*(i&3),tmp))}return out}};sjcl.codec.base64={_chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",fromBits:function(arr,_noEquals,_url){var out="",i,bits=0,c=sjcl.codec.base64._chars,ta=0,bl=sjcl.bitArray.bitLength(arr);if(_url){c=c.substr(0,62)+"-_"}for(i=0;out.length*6<bl;){out+=c.charAt((ta^arr[i]>>>bits)>>>26);if(bits<6){ta=arr[i]<<6-bits;bits+=26;i++}else{ta<<=6;bits-=6}}while(out.length&3&&!_noEquals){out+="="}return out},toBits:function(str,_url){str=str.replace(/\\s|=/g,"");var out=[],i,bits=0,c=sjcl.codec.base64._chars,ta=0,x;if(_url){c=c.substr(0,62)+"-_"}for(i=0;i<str.length;i++){x=c.indexOf(str.charAt(i));if(x<0){throw new sjcl.exception.invalid("this isn't base64!")}if(bits>26){bits-=26;out.push(ta^x>>>bits);ta=x<<32-bits}else{bits+=6;ta^=x<<32-bits}}if(bits&56){out.push(sjcl.bitArray.partial(bits&56,ta,1))}return out}};sjcl.codec.base64url={fromBits:function(arr){return sjcl.codec.base64.fromBits(arr,1,1)},toBits:function(str){return sjcl.codec.base64.toBits(str,1)}};sjcl.hash.sha256=function(hash){if(!this._key[0]){this._precompute()}if(hash){this._h=hash._h.slice(0);this._buffer=hash._buffer.slice(0);this._length=hash._length}else{this.reset()}};sjcl.hash.sha256.hash=function(data){return(new sjcl.hash.sha256).update(data).finalize()};sjcl.hash.sha256.prototype={blockSize:512,reset:function(){this._h=this._init.slice(0);this._buffer=[];this._length=0;return this},update:function(data){if(typeof data==="string"){data=sjcl.codec.utf8String.toBits(data)}var i,b=this._buffer=sjcl.bitArray.concat(this._buffer,data),ol=this._length,nl=this._length=ol+sjcl.bitArray.bitLength(data);if(nl>9007199254740991){throw new sjcl.exception.invalid("Cannot hash more than 2^53 - 1 bits")}if(typeof Uint32Array!=="undefined"){var c=new Uint32Array(b);var j=0;for(i=512+ol-(512+ol&511);i<=nl;i+=512){this._block(c.subarray(16*j,16*(j+1)));j+=1}b.splice(0,16*j)}else{for(i=512+ol-(512+ol&511);i<=nl;i+=512){this._block(b.splice(0,16))}}return this},finalize:function(){var i,b=this._buffer,h=this._h;b=sjcl.bitArray.concat(b,[sjcl.bitArray.partial(1,1)]);for(i=b.length+2;i&15;i++){b.push(0)}b.push(Math.floor(this._length/4294967296));b.push(this._length|0);while(b.length){this._block(b.splice(0,16))}this.reset();return h},_init:[],_key:[],_precompute:function(){var i=0,prime=2,factor,isPrime;function frac(x){return(x-Math.floor(x))*4294967296|0}for(;i<64;prime++){isPrime=true;for(factor=2;factor*factor<=prime;factor++){if(prime%factor===0){isPrime=false;break}}if(isPrime){if(i<8){this._init[i]=frac(Math.pow(prime,1/2))}this._key[i]=frac(Math.pow(prime,1/3));i++}}},_block:function(w){var i,tmp,a,b,h=this._h,k=this._key,h0=h[0],h1=h[1],h2=h[2],h3=h[3],h4=h[4],h5=h[5],h6=h[6],h7=h[7];for(i=0;i<64;i++){if(i<16){tmp=w[i]}else{a=w[i+1&15];b=w[i+14&15];tmp=w[i&15]=(a>>>7^a>>>18^a>>>3^a<<25^a<<14)+(b>>>17^b>>>19^b>>>10^b<<15^b<<13)+w[i&15]+w[i+9&15]|0}tmp=tmp+h7+(h4>>>6^h4>>>11^h4>>>25^h4<<26^h4<<21^h4<<7)+(h6^h4&(h5^h6))+k[i];h7=h6;h6=h5;h5=h4;h4=h3+tmp|0;h3=h2;h2=h1;h1=h0;h0=tmp+(h1&h2^h3&(h1^h2))+(h1>>>2^h1>>>13^h1>>>22^h1<<30^h1<<19^h1<<10)|0}h[0]=h[0]+h0|0;h[1]=h[1]+h1|0;h[2]=h[2]+h2|0;h[3]=h[3]+h3|0;h[4]=h[4]+h4|0;h[5]=h[5]+h5|0;h[6]=h[6]+h6|0;h[7]=h[7]+h7|0}};sjcl.mode.ccm={name:"ccm",_progressListeners:[],listenProgress:function(cb){sjcl.mode.ccm._progressListeners.push(cb)},unListenProgress:function(cb){var index=sjcl.mode.ccm._progressListeners.indexOf(cb);if(index>-1){sjcl.mode.ccm._progressListeners.splice(index,1)}},_callProgressListener:function(val){var p=sjcl.mode.ccm._progressListeners.slice(),i;for(i=0;i<p.length;i+=1){p[i](val)}},encrypt:function(prf,plaintext,iv,adata,tlen){var L,out=plaintext.slice(0),tag,w=sjcl.bitArray,ivl=w.bitLength(iv)/8,ol=w.bitLength(out)/8;tlen=tlen||64;adata=adata||[];if(ivl<7){throw new sjcl.exception.invalid("ccm: iv must be at least 7 bytes")}for(L=2;L<4&&ol>>>8*L;L++){}if(L<15-ivl){L=15-ivl}iv=w.clamp(iv,8*(15-L));tag=sjcl.mode.ccm._computeTag(prf,plaintext,iv,adata,tlen,L);out=sjcl.mode.ccm._ctrMode(prf,out,iv,tag,tlen,L);return w.concat(out.data,out.tag)},decrypt:function(prf,ciphertext,iv,adata,tlen){tlen=tlen||64;adata=adata||[];var L,w=sjcl.bitArray,ivl=w.bitLength(iv)/8,ol=w.bitLength(ciphertext),out=w.clamp(ciphertext,ol-tlen),tag=w.bitSlice(ciphertext,ol-tlen),tag2;ol=(ol-tlen)/8;if(ivl<7){throw new sjcl.exception.invalid("ccm: iv must be at least 7 bytes")}for(L=2;L<4&&ol>>>8*L;L++){}if(L<15-ivl){L=15-ivl}iv=w.clamp(iv,8*(15-L));out=sjcl.mode.ccm._ctrMode(prf,out,iv,tag,tlen,L);tag2=sjcl.mode.ccm._computeTag(prf,out.data,iv,adata,tlen,L);if(!w.equal(out.tag,tag2)){throw new sjcl.exception.corrupt("ccm: tag doesn't match")}return out.data},_macAdditionalData:function(prf,adata,iv,tlen,ol,L){var mac,tmp,i,macData=[],w=sjcl.bitArray,xor=w._xor4;mac=[w.partial(8,(adata.length?1<<6:0)|tlen-2<<2|L-1)];mac=w.concat(mac,iv);mac[3]|=ol;mac=prf.encrypt(mac);if(adata.length){tmp=w.bitLength(adata)/8;if(tmp<=65279){macData=[w.partial(16,tmp)]}else if(tmp<=4294967295){macData=w.concat([w.partial(16,65534)],[tmp])}macData=w.concat(macData,adata);for(i=0;i<macData.length;i+=4){mac=prf.encrypt(xor(mac,macData.slice(i,i+4).concat([0,0,0])))}}return mac},_computeTag:function(prf,plaintext,iv,adata,tlen,L){var mac,i,w=sjcl.bitArray,xor=w._xor4;tlen/=8;if(tlen%2||tlen<4||tlen>16){throw new sjcl.exception.invalid("ccm: invalid tag length")}if(adata.length>4294967295||plaintext.length>4294967295){throw new sjcl.exception.bug("ccm: can't deal with 4GiB or more data")}mac=sjcl.mode.ccm._macAdditionalData(prf,adata,iv,tlen,w.bitLength(plaintext)/8,L);for(i=0;i<plaintext.length;i+=4){mac=prf.encrypt(xor(mac,plaintext.slice(i,i+4).concat([0,0,0])))}return w.clamp(mac,tlen*8)},_ctrMode:function(prf,data,iv,tag,tlen,L){var enc,i,w=sjcl.bitArray,xor=w._xor4,ctr,l=data.length,bl=w.bitLength(data),n=l/50,p=n;ctr=w.concat([w.partial(8,L-1)],iv).concat([0,0,0]).slice(0,4);tag=w.bitSlice(xor(tag,prf.encrypt(ctr)),0,tlen);if(!l){return{tag:tag,data:[]}}for(i=0;i<l;i+=4){if(i>n){sjcl.mode.ccm._callProgressListener(i/l);n+=p}ctr[3]++;enc=prf.encrypt(ctr);data[i]^=enc[0];data[i+1]^=enc[1];data[i+2]^=enc[2];data[i+3]^=enc[3]}return{tag:tag,data:w.clamp(data,bl)}}};sjcl.misc.hmac=function(key,Hash){this._hash=Hash=Hash||sjcl.hash.sha256;var exKey=[[],[]],i,bs=Hash.prototype.blockSize/32;this._baseHash=[new Hash,new Hash];if(key.length>bs){key=Hash.hash(key)}for(i=0;i<bs;i++){exKey[0][i]=key[i]^909522486;exKey[1][i]=key[i]^1549556828}this._baseHash[0].update(exKey[0]);this._baseHash[1].update(exKey[1]);this._resultHash=new Hash(this._baseHash[0])};sjcl.misc.hmac.prototype.encrypt=sjcl.misc.hmac.prototype.mac=function(data){if(!this._updated){this.update(data);return this.digest(data)}else{throw new sjcl.exception.invalid("encrypt on already updated hmac called!")}};sjcl.misc.hmac.prototype.reset=function(){this._resultHash=new this._hash(this._baseHash[0]);this._updated=false};sjcl.misc.hmac.prototype.update=function(data){this._updated=true;this._resultHash.update(data)};sjcl.misc.hmac.prototype.digest=function(){var w=this._resultHash.finalize(),result=new this._hash(this._baseHash[1]).update(w).finalize();this.reset();return result};sjcl.misc.pbkdf2=function(password,salt,count,length,Prff){count=count||1e4;if(length<0||count<0){throw new sjcl.exception.invalid("invalid params to pbkdf2")}if(typeof password==="string"){password=sjcl.codec.utf8String.toBits(password)}if(typeof salt==="string"){salt=sjcl.codec.utf8String.toBits(salt)}Prff=Prff||sjcl.misc.hmac;var prf=new Prff(password),u,ui,i,j,k,out=[],b=sjcl.bitArray;for(k=1;32*out.length<(length||1);k++){u=ui=prf.encrypt(b.concat(salt,[k]));for(i=1;i<count;i++){ui=prf.encrypt(ui);for(j=0;j<ui.length;j++){u[j]^=ui[j]}}out=out.concat(u)}if(length){out=b.clamp(out,length)}return out};sjcl.prng=function(defaultParanoia){this._pools=[new sjcl.hash.sha256];this._poolEntropy=[0];this._reseedCount=0;this._robins={};this._eventId=0;this._collectorIds={};this._collectorIdNext=0;this._strength=0;this._poolStrength=0;this._nextReseed=0;this._key=[0,0,0,0,0,0,0,0];this._counter=[0,0,0,0];this._cipher=undefined;this._defaultParanoia=defaultParanoia;this._collectorsStarted=false;this._callbacks={progress:{},seeded:{}};this._callbackI=0;this._NOT_READY=0;this._READY=1;this._REQUIRES_RESEED=2;this._MAX_WORDS_PER_BURST=65536;this._PARANOIA_LEVELS=[0,48,64,96,128,192,256,384,512,768,1024];this._MILLISECONDS_PER_RESEED=3e4;this._BITS_PER_RESEED=80};sjcl.prng.prototype={randomWords:function(nwords,paranoia){var out=[],i,readiness=this.isReady(paranoia),g;if(readiness===this._NOT_READY){throw new sjcl.exception.notReady("generator isn't seeded")}else if(readiness&this._REQUIRES_RESEED){this._reseedFromPools(!(readiness&this._READY))}for(i=0;i<nwords;i+=4){if((i+1)%this._MAX_WORDS_PER_BURST===0){this._gate()}g=this._gen4words();out.push(g[0],g[1],g[2],g[3])}this._gate();return out.slice(0,nwords)},setDefaultParanoia:function(paranoia,allowZeroParanoia){if(paranoia===0&&allowZeroParanoia!=="Setting paranoia=0 will ruin your security; use it only for testing"){throw new sjcl.exception.invalid("Setting paranoia=0 will ruin your security; use it only for testing")}this._defaultParanoia=paranoia},addEntropy:function(data,estimatedEntropy,source){source=source||"user";var id,i,tmp,t=(new Date).valueOf(),robin=this._robins[source],oldReady=this.isReady(),err=0,objName;id=this._collectorIds[source];if(id===undefined){id=this._collectorIds[source]=this._collectorIdNext++}if(robin===undefined){robin=this._robins[source]=0}this._robins[source]=(this._robins[source]+1)%this._pools.length;switch(typeof data){case"number":if(estimatedEntropy===undefined){estimatedEntropy=1}this._pools[robin].update([id,this._eventId++,1,estimatedEntropy,t,1,data|0]);break;case"object":objName=Object.prototype.toString.call(data);if(objName==="[object Uint32Array]"){tmp=[];for(i=0;i<data.length;i++){tmp.push(data[i])}data=tmp}else{if(objName!=="[object Array]"){err=1}for(i=0;i<data.length&&!err;i++){if(typeof data[i]!=="number"){err=1}}}if(!err){if(estimatedEntropy===undefined){estimatedEntropy=0;for(i=0;i<data.length;i++){tmp=data[i];while(tmp>0){estimatedEntropy++;tmp=tmp>>>1}}}this._pools[robin].update([id,this._eventId++,2,estimatedEntropy,t,data.length].concat(data))}break;case"string":if(estimatedEntropy===undefined){estimatedEntropy=data.length}this._pools[robin].update([id,this._eventId++,3,estimatedEntropy,t,data.length]);this._pools[robin].update(data);break;default:err=1}if(err){throw new sjcl.exception.bug("random: addEntropy only supports number, array of numbers or string")}this._poolEntropy[robin]+=estimatedEntropy;this._poolStrength+=estimatedEntropy;if(oldReady===this._NOT_READY){if(this.isReady()!==this._NOT_READY){this._fireEvent("seeded",Math.max(this._strength,this._poolStrength))}this._fireEvent("progress",this.getProgress())}},isReady:function(paranoia){var entropyRequired=this._PARANOIA_LEVELS[paranoia!==undefined?paranoia:this._defaultParanoia];if(this._strength&&this._strength>=entropyRequired){return this._poolEntropy[0]>this._BITS_PER_RESEED&&(new Date).valueOf()>this._nextReseed?this._REQUIRES_RESEED|this._READY:this._READY}else{return this._poolStrength>=entropyRequired?this._REQUIRES_RESEED|this._NOT_READY:this._NOT_READY}},getProgress:function(paranoia){var entropyRequired=this._PARANOIA_LEVELS[paranoia?paranoia:this._defaultParanoia];if(this._strength>=entropyRequired){return 1}else{return this._poolStrength>entropyRequired?1:this._poolStrength/entropyRequired}},startCollectors:function(){if(this._collectorsStarted){return}this._eventListener={loadTimeCollector:this._bind(this._loadTimeCollector),mouseCollector:this._bind(this._mouseCollector),keyboardCollector:this._bind(this._keyboardCollector),accelerometerCollector:this._bind(this._accelerometerCollector),touchCollector:this._bind(this._touchCollector)};if(window.addEventListener){window.addEventListener("load",this._eventListener.loadTimeCollector,false);window.addEventListener("mousemove",this._eventListener.mouseCollector,false);window.addEventListener("keypress",this._eventListener.keyboardCollector,false);window.addEventListener("devicemotion",this._eventListener.accelerometerCollector,false);window.addEventListener("touchmove",this._eventListener.touchCollector,false)}else if(document.attachEvent){document.attachEvent("onload",this._eventListener.loadTimeCollector);document.attachEvent("onmousemove",this._eventListener.mouseCollector);document.attachEvent("keypress",this._eventListener.keyboardCollector)}else{throw new sjcl.exception.bug("can't attach event")}this._collectorsStarted=true},stopCollectors:function(){if(!this._collectorsStarted){return}if(window.removeEventListener){window.removeEventListener("load",this._eventListener.loadTimeCollector,false);window.removeEventListener("mousemove",this._eventListener.mouseCollector,false);window.removeEventListener("keypress",this._eventListener.keyboardCollector,false);window.removeEventListener("devicemotion",this._eventListener.accelerometerCollector,false);window.removeEventListener("touchmove",this._eventListener.touchCollector,false)}else if(document.detachEvent){document.detachEvent("onload",this._eventListener.loadTimeCollector);document.detachEvent("onmousemove",this._eventListener.mouseCollector);document.detachEvent("keypress",this._eventListener.keyboardCollector)}this._collectorsStarted=false},addEventListener:function(name,callback){this._callbacks[name][this._callbackI++]=callback},removeEventListener:function(name,cb){var i,j,cbs=this._callbacks[name],jsTemp=[];for(j in cbs){if(cbs.hasOwnProperty(j)&&cbs[j]===cb){jsTemp.push(j)}}for(i=0;i<jsTemp.length;i++){j=jsTemp[i];delete cbs[j]}},_bind:function(func){var that=this;return function(){func.apply(that,arguments)}},_gen4words:function(){for(var i=0;i<4;i++){this._counter[i]=this._counter[i]+1|0;if(this._counter[i]){break}}return this._cipher.encrypt(this._counter)},_gate:function(){this._key=this._gen4words().concat(this._gen4words());this._cipher=new sjcl.cipher.aes(this._key)},_reseed:function(seedWords){this._key=sjcl.hash.sha256.hash(this._key.concat(seedWords));this._cipher=new sjcl.cipher.aes(this._key);for(var i=0;i<4;i++){this._counter[i]=this._counter[i]+1|0;if(this._counter[i]){break}}},_reseedFromPools:function(full){var reseedData=[],strength=0,i;this._nextReseed=reseedData[0]=(new Date).valueOf()+this._MILLISECONDS_PER_RESEED;for(i=0;i<16;i++){reseedData.push(Math.random()*4294967296|0)}for(i=0;i<this._pools.length;i++){reseedData=reseedData.concat(this._pools[i].finalize());strength+=this._poolEntropy[i];this._poolEntropy[i]=0;if(!full&&this._reseedCount&1<<i){break}}if(this._reseedCount>=1<<this._pools.length){this._pools.push(new sjcl.hash.sha256);this._poolEntropy.push(0)}this._poolStrength-=strength;if(strength>this._strength){this._strength=strength}this._reseedCount++;this._reseed(reseedData)},_keyboardCollector:function(){this._addCurrentTimeToEntropy(1)},_mouseCollector:function(ev){var x,y;try{x=ev.x||ev.clientX||ev.offsetX||0;y=ev.y||ev.clientY||ev.offsetY||0}catch(err){x=0;y=0}if(x!=0&&y!=0){this.addEntropy([x,y],2,"mouse")}this._addCurrentTimeToEntropy(0)},_touchCollector:function(ev){var touch=ev.touches[0]||ev.changedTouches[0];var x=touch.pageX||touch.clientX,y=touch.pageY||touch.clientY;this.addEntropy([x,y],1,"touch");this._addCurrentTimeToEntropy(0)},_loadTimeCollector:function(){this._addCurrentTimeToEntropy(2)},_addCurrentTimeToEntropy:function(estimatedEntropy){if(typeof window!=="undefined"&&window.performance&&typeof window.performance.now==="function"){this.addEntropy(window.performance.now(),estimatedEntropy,"loadtime")}else{this.addEntropy((new Date).valueOf(),estimatedEntropy,"loadtime")}},_accelerometerCollector:function(ev){var ac=ev.accelerationIncludingGravity.x||ev.accelerationIncludingGravity.y||ev.accelerationIncludingGravity.z;if(window.orientation){var or=window.orientation;if(typeof or==="number"){this.addEntropy(or,1,"accelerometer")}}if(ac){this.addEntropy(ac,2,"accelerometer")}this._addCurrentTimeToEntropy(0)},_fireEvent:function(name,arg){var j,cbs=sjcl.random._callbacks[name],cbsTemp=[];for(j in cbs){if(cbs.hasOwnProperty(j)){cbsTemp.push(cbs[j])}}for(j=0;j<cbsTemp.length;j++){cbsTemp[j](arg)}}};sjcl.random=new sjcl.prng(6);(function(){function getCryptoModule(){try{return require("crypto")}catch(e){return null}}try{var buf,crypt,ab;if(typeof module!=="undefined"&&module.exports&&(crypt=getCryptoModule())&&crypt.randomBytes){buf=crypt.randomBytes(1024/8);buf=new Uint32Array(new Uint8Array(buf).buffer);sjcl.random.addEntropy(buf,1024,"crypto.randomBytes")}else if(typeof window!=="undefined"&&typeof Uint32Array!=="undefined"){ab=new Uint32Array(32);if(window.crypto&&window.crypto.getRandomValues){window.crypto.getRandomValues(ab)}else if(window.msCrypto&&window.msCrypto.getRandomValues){window.msCrypto.getRandomValues(ab)}else{return}sjcl.random.addEntropy(ab,1024,"crypto.getRandomValues")}else{}}catch(e){if(typeof window!=="undefined"&&window.console){console.log("There was an error collecting entropy from the browser:");console.log(e)}}})();sjcl.json={defaults:{v:1,iter:1e4,ks:128,ts:64,mode:"ccm",adata:"",cipher:"aes"},_encrypt:function(password,plaintext,params,rp){params=params||{};rp=rp||{};var j=sjcl.json,p=j._add({iv:sjcl.random.randomWords(4,0)},j.defaults),tmp,prp,adata;j._add(p,params);adata=p.adata;if(typeof p.salt==="string"){p.salt=sjcl.codec.base64.toBits(p.salt)}if(typeof p.iv==="string"){p.iv=sjcl.codec.base64.toBits(p.iv)}if(!sjcl.mode[p.mode]||!sjcl.cipher[p.cipher]||typeof password==="string"&&p.iter<=100||p.ts!==64&&p.ts!==96&&p.ts!==128||p.ks!==128&&p.ks!==192&&p.ks!==256||(p.iv.length<2||p.iv.length>4)){throw new sjcl.exception.invalid("json encrypt: invalid parameters")}if(typeof password==="string"){tmp=sjcl.misc.cachedPbkdf2(password,p);password=tmp.key.slice(0,p.ks/32);p.salt=tmp.salt}else if(sjcl.ecc&&password instanceof sjcl.ecc.elGamal.publicKey){tmp=password.kem();p.kemtag=tmp.tag;password=tmp.key.slice(0,p.ks/32)}if(typeof plaintext==="string"){plaintext=sjcl.codec.utf8String.toBits(plaintext)}if(typeof adata==="string"){p.adata=adata=sjcl.codec.utf8String.toBits(adata)}prp=new sjcl.cipher[p.cipher](password);j._add(rp,p);rp.key=password;if(p.mode==="ccm"&&sjcl.arrayBuffer&&sjcl.arrayBuffer.ccm&&plaintext instanceof ArrayBuffer){p.ct=sjcl.arrayBuffer.ccm.encrypt(prp,plaintext,p.iv,adata,p.ts)}else{p.ct=sjcl.mode[p.mode].encrypt(prp,plaintext,p.iv,adata,p.ts)}return p},encrypt:function(password,plaintext,params,rp){var j=sjcl.json,p=j._encrypt.apply(j,arguments);return j.encode(p)},_decrypt:function(password,ciphertext,params,rp){params=params||{};rp=rp||{};var j=sjcl.json,p=j._add(j._add(j._add({},j.defaults),ciphertext),params,true),ct,tmp,prp,adata=p.adata;if(typeof p.salt==="string"){p.salt=sjcl.codec.base64.toBits(p.salt)}if(typeof p.iv==="string"){p.iv=sjcl.codec.base64.toBits(p.iv)}if(!sjcl.mode[p.mode]||!sjcl.cipher[p.cipher]||typeof password==="string"&&p.iter<=100||p.ts!==64&&p.ts!==96&&p.ts!==128||p.ks!==128&&p.ks!==192&&p.ks!==256||!p.iv||(p.iv.length<2||p.iv.length>4)){throw new sjcl.exception.invalid("json decrypt: invalid parameters")}if(typeof password==="string"){tmp=sjcl.misc.cachedPbkdf2(password,p);password=tmp.key.slice(0,p.ks/32);p.salt=tmp.salt}else if(sjcl.ecc&&password instanceof sjcl.ecc.elGamal.secretKey){password=password.unkem(sjcl.codec.base64.toBits(p.kemtag)).slice(0,p.ks/32)}if(typeof adata==="string"){adata=sjcl.codec.utf8String.toBits(adata)}prp=new sjcl.cipher[p.cipher](password);if(p.mode==="ccm"&&sjcl.arrayBuffer&&sjcl.arrayBuffer.ccm&&p.ct instanceof ArrayBuffer){ct=sjcl.arrayBuffer.ccm.decrypt(prp,p.ct,p.iv,p.tag,adata,p.ts)}else{ct=sjcl.mode[p.mode].decrypt(prp,p.ct,p.iv,adata,p.ts)}j._add(rp,p);rp.key=password;if(params.raw===1){return ct}else{return sjcl.codec.utf8String.fromBits(ct)}},decrypt:function(password,ciphertext,params,rp){var j=sjcl.json;return j._decrypt(password,j.decode(ciphertext),params,rp)},encode:function(obj){var i,out="{",comma="";for(i in obj){if(obj.hasOwnProperty(i)){if(!i.match(/^[a-z0-9]+$/i)){throw new sjcl.exception.invalid("json encode: invalid property name")}out+=comma+'"'+i+'":';comma=",";switch(typeof obj[i]){case"number":case"boolean":out+=obj[i];break;case"string":out+='"'+escape(obj[i])+'"';break;case"object":out+='"'+sjcl.codec.base64.fromBits(obj[i],0)+'"';break;default:throw new sjcl.exception.bug("json encode: unsupported type")}}}return out+"}"},decode:function(str){str=str.replace(/\\s/g,"");if(!str.match(/^\\{.*}$/)){throw new sjcl.exception.invalid("json decode: this isn't json!")}var a=str.replace(/^\\{|}$/g,"").split(/,/),out={},i,m;for(i=0;i<a.length;i++){if(!(m=a[i].match(/^\\s*(?:(["']?)([a-z][a-z0-9]*)\\1)\\s*:\\s*(?:(-?\\d+)|"([a-z0-9+\\/%*_.@=\\-]*)"|(true|false))$/i))){throw new sjcl.exception.invalid("json decode: this isn't json!")}if(m[3]!=null){out[m[2]]=parseInt(m[3],10)}else if(m[4]!=null){out[m[2]]=m[2].match(/^(ct|adata|salt|iv)$/)?sjcl.codec.base64.toBits(m[4]):unescape(m[4])}else if(m[5]!=null){out[m[2]]=m[5]==="true"}}return out},_add:function(target,src,requireSame){if(target===undefined){target={}}if(src===undefined){return target}var i;for(i in src){if(src.hasOwnProperty(i)){if(requireSame&&target[i]!==undefined&&target[i]!==src[i]){throw new sjcl.exception.invalid("required parameter overridden")}target[i]=src[i]}}return target},_subtract:function(plus,minus){var out={},i;for(i in plus){if(plus.hasOwnProperty(i)&&plus[i]!==minus[i]){out[i]=plus[i]}}return out},_filter:function(src,filter){var out={},i;for(i=0;i<filter.length;i++){if(src[filter[i]]!==undefined){out[filter[i]]=src[filter[i]]}}return out}};sjcl.encrypt=sjcl.json.encrypt;sjcl.decrypt=sjcl.json.decrypt;sjcl.misc._pbkdf2Cache={};sjcl.misc.cachedPbkdf2=function(password,obj){var cache=sjcl.misc._pbkdf2Cache,c,cp,str,salt,iter;obj=obj||{};iter=obj.iter||1e3;cp=cache[password]=cache[password]||{};c=cp[iter]=cp[iter]||{firstSalt:obj.salt&&obj.salt.length?obj.salt.slice(0):sjcl.random.randomWords(2,0)};salt=obj.salt===undefined?c.firstSalt:obj.salt;c[salt]=c[salt]||sjcl.misc.pbkdf2(password,salt,obj.iter);return{key:c[salt].slice(0),salt:salt.slice(0)}};if(typeof module!=="undefined"&&module.exports){module.exports=sjcl}if(typeof define==="function"){define([],function(){return sjcl})}",
        "    var Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(input){var output="";var chr1,chr2,chr3,enc1,enc2,enc3,enc4;var i=0;input=Base64._utf8_encode(input);while(i<input.length){chr1=input.charCodeAt(i++);chr2=input.charCodeAt(i++);chr3=input.charCodeAt(i++);enc1=chr1>>2;enc2=(chr1&3)<<4|chr2>>4;enc3=(chr2&15)<<2|chr3>>6;enc4=chr3&63;if(isNaN(chr2)){enc3=enc4=64}else if(isNaN(chr3)){enc4=64}output=output+this._keyStr.charAt(enc1)+this._keyStr.charAt(enc2)+this._keyStr.charAt(enc3)+this._keyStr.charAt(enc4)}return output},decode:function(input){var output="";var chr1,chr2,chr3;var enc1,enc2,enc3,enc4;var i=0;input=input.replace(/[^A-Za-z0-9\\+\\/\\=]/g,"");while(i<input.length){enc1=this._keyStr.indexOf(input.charAt(i++));enc2=this._keyStr.indexOf(input.charAt(i++));enc3=this._keyStr.indexOf(input.charAt(i++));enc4=this._keyStr.indexOf(input.charAt(i++));chr1=enc1<<2|enc2>>4;chr2=(enc2&15)<<4|enc3>>2;chr3=(enc3&3)<<6|enc4;output=output+String.fromCharCode(chr1);if(enc3!=64){output=output+String.fromCharCode(chr2)}if(enc4!=64){output=output+String.fromCharCode(chr3)}}output=Base64._utf8_decode(output);return output},_utf8_encode:function(string){string=string.replace(/\\r\\n/g,"\\n");var utftext="";for(var n=0;n<string.length;n++){var c=string.charCodeAt(n);if(c<128){utftext+=String.fromCharCode(c)}else if(c>127&&c<2048){utftext+=String.fromCharCode(c>>6|192);utftext+=String.fromCharCode(c&63|128)}else{utftext+=String.fromCharCode(c>>12|224);utftext+=String.fromCharCode(c>>6&63|128);utftext+=String.fromCharCode(c&63|128)}}return utftext},_utf8_decode:function(utftext){var string="";var i=0;var c=c1=c2=0;while(i<utftext.length){c=utftext.charCodeAt(i);if(c<128){string+=String.fromCharCode(c);i++}else if(c>191&&c<224){c2=utftext.charCodeAt(i+1);string+=String.fromCharCode((c&31)<<6|c2&63);i+=2}else{c2=utftext.charCodeAt(i+1);c3=utftext.charCodeAt(i+2);string+=String.fromCharCode((c&15)<<12|(c2&63)<<6|c3&63);i+=3}}return string}};",
        "",
        "      logger.message("Collect And Encrypt Custom Password: start");",
        "    outcome = "true";",
        "  ",
        "    /* Begin Configuration */",
        "      ",
        "      // Attribute name",
        "      var idmAttrName = "frUnindexedString2"; // AM: "fr-attr-str2"",
        "      ",
        "      // Pick a shared secret to use for encryption and decryption",
        "    var sharedSecret = "RainbowPoniesHaveNoStripes";",
        "",
        "      // Fine-tune encryption settings. Default iterations are 10k, to speed up the process, it's reduced to 1k here.",
        "      var encryptionParameters = { "iter" : 1000 };",
        "      ",
        "    // Build out the password prompt",
        "    var prompt = "Replay Password";",
        "",
        "    /* End Configuration */",
        "  ",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "        javax.security.auth.callback.PasswordCallback,",
        "          java.lang.String",
        "    )",
        "    ",
        "    if (callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "          new fr.PasswordCallback(prompt, false)",
        "        ).build();",
        "    } ",
        "    else {",
        "          // PasswordCallback returns the password as a char[], which is not the same as a JS char array. It must be converted to a proper string using the java.lang.Sting.valueOf(char[]) method.",
        "        var password = new String(fr.String.valueOf(callbacks.get(0).getPassword()));",
        "        logger.message("Collect And Encrypt Custom Password: callbacks received");",
        "",
        "          /*",
        "        var cipherPasswordJson = sjcl.encrypt(sharedSecret, password, encryptionParameters);",
        "        //setSharedObjectAttribute(idmAttrName, Base64.encode(JSON.stringify(cipherPasswordJson)));",
        "        setSharedObjectAttribute(idmAttrName, JSON.stringify(cipherPasswordJson));",
        "        logger.message("Collect And Encrypt Custom Password: cipherPasswordJson="+JSON.stringify(cipherPasswordJson));",
        "        */",
        "      ",
        "        logger.message("Collect And Encrypt Custom Password: password="+Base64.encode(password));",
        "        setSharedObjectAttribute(idmAttrName, Base64.encode(password));",
        "",
        "        logger.message("Collect And Encrypt Custom Password: finish [outcome=".concat(outcome).concat("]"));",
        "        action = fr.Action.goTo(outcome).build();",
        "    }",
        "",
        "    /*",
        "     * Store attributes in shared state for use with the Create/Patch Object nodes.",
        "     */",
        "    function setSharedObjectAttribute(name, value) {",
        "        var storage = sharedState.get("objectAttributes");",
        "        if (storage && value) {",
        "            if (storage.put) {",
        "                  storage.put(name, value);",
        "            }",
        "            else {",
        "                storage[name] = value;",
        "            }",
        "        }",
        "        else if (value) {",
        "              var object = {",
        "                  name: value",
        "            };",
        "            sharedState.put("objectAttributes", object);",
        "            //sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "        }",
        "    }",
        "}());",
        "/* SJCL is open. You can use, modify and redistribute it under a BSD",
        "license or under the GNU GPL, version 2.0.",
        "",
        "---------------------------------------------------------------------",
        "",
        "http://opensource.org/licenses/BSD-2-Clause",
        "",
        "Copyright (c) 2009-2015, Emily Stark, Mike Hamburg and Dan Boneh at",
        "Stanford University. All rights reserved.",
        "",
        "Redistribution and use in source and binary forms, with or without",
        "modification, are permitted provided that the following conditions are",
        "met:",
        "",
        "1. Redistributions of source code must retain the above copyright",
        "notice, this list of conditions and the following disclaimer.",
        "",
        "2. Redistributions in binary form must reproduce the above copyright",
        "notice, this list of conditions and the following disclaimer in the",
        "documentation and/or other materials provided with the distribution.",
        "",
        "THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS",
        "IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED",
        "TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A",
        "PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT",
        "HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,",
        "SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED",
        "TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR",
        "PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF",
        "LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING",
        "NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS",
        "SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.",
        "",
        "---------------------------------------------------------------------",
        "",
        "http://opensource.org/licenses/GPL-2.0",
        "",
        "The Stanford Javascript Crypto Library (hosted here on GitHub) is a",
        "project by the Stanford Computer Security Lab to build a secure,",
        "powerful, fast, small, easy-to-use, cross-browser library for",
        "cryptography in Javascript.",
        "",
        "Copyright (c) 2009-2015, Emily Stark, Mike Hamburg and Dan Boneh at",
        "Stanford University.",
        "",
        "This program is free software; you can redistribute it and/or modify it",
        "under the terms of the GNU General Public License as published by the",
        "Free Software Foundation; either version 2 of the License, or (at your",
        "option) any later version.",
        "",
        "This program is distributed in the hope that it will be useful, but",
        "WITHOUT ANY WARRANTY; without even the implied warranty of",
        "MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General",
        "Public License for more details.",
        "",
        "You should have received a copy of the GNU General Public License along",
        "with this program; if not, write to the Free Software Foundation, Inc.,",
        "59 Temple Place, Suite 330, Boston, MA 02111-1307 USA */",
        "",
        "/*",
        " * Base64 encode / decode",
        " *  http://www.webtoolkit.info/",
        " * ",
        " * Example:",
        " * Base64.encode('some string')",
        " * Base64.decode('some encoded string')",
        " */",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Collect-SAML2-Node-Config.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "48f17202-039f-4d40-b7fc-4ce380f1b929": {
      "_id": "48f17202-039f-4d40-b7fc-4ce380f1b929",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Collect all the configuration items required for the SAML2 Node to function properly.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Collect SAML2 Node Config",
      "script": [
        "/* Collect SAML2 Node Config",
        " * ",
        " * Collect all the configuration items required for the SAML2 Node to function properly.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    outcome = "true";",
        "      var config = {",
        "        "metaAlias": "/iSPAzure",",
        "        "allowCreate": false,",
        "        "sloEnabled": false,",
        "        "authnContextClassRef": [],",
        "        "authnContextDeclRef": [],",
        "        "authComparison": "EXACT",",
        "        "nameIdFormat": "urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified",",
        "        "requestBinding": "HTTP_REDIRECT",",
        "        "binding": "HTTP_POST",",
        "        "forceAuthn": false,",
        "        "idpEntityId": "https://sts.windows.net/711ffa9c-5972-4713-ace3-688c9732614a/",",
        "        "isPassive": false,",
        "        "sloRelayState": """,
        "    };",
        "      var script = "";",
        "    script += "Array.prototype.slice.call(";",
        "    script += "    document.getElementsByTagName('input')";",
        "    script += ").forEach(";",
        "    script += "    function (input,i) {";",
        "    script += "        console.log('input '+i);"",
        "    script += "        var config = JSON.parse('"+JSON.stringify(config)+"');";",
        "    script += "        var keys = Object.keys(config);";",
        "    script += "        if (input.type === 'text') {";",
        "    script += "            input.setAttribute('value', config[keys[i]]);";",
        "    script += "            input.dispatchEvent(new KeyboardEvent( 'input' , {'key':'Enter'} ));";",
        "    script += "        }";",
        "    script += "    }";",
        "    script += ");";",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "          javax.security.auth.callback.NameCallback,",
        "        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        "    )",
        "    if (callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "            new fr.NameCallback("metaAlias"),",
        "            new fr.NameCallback("allowCreate"),",
        "            new fr.NameCallback("sloEnabled"),",
        "            new fr.NameCallback("authnContextClassRef"),",
        "            new fr.NameCallback("authnContextDeclRef"),",
        "            new fr.NameCallback("authComparison"),",
        "            new fr.NameCallback("nameIdFormat"),",
        "            new fr.NameCallback("requestBinding"),",
        "            new fr.NameCallback("binding"),",
        "            new fr.NameCallback("forceAuthn"),",
        "            new fr.NameCallback("idpEntityId"),",
        "            new fr.NameCallback("isPassive"),",
        "            new fr.NameCallback("sloRelayState"),",
        "              new fr.ScriptTextOutputCallback(script)",
        "        ).build();",
        "    }",
        "    else {",
        "          config[callbacks.get(0).getPrompt()] = callbacks.get(0).getName();",
        "          config[callbacks.get(1).getPrompt()] = (callbacks.get(1).getName() === 'true');",
        "          config[callbacks.get(2).getPrompt()] = (callbacks.get(2).getName() === 'true');",
        "          config[callbacks.get(3).getPrompt()] = [callbacks.get(3).getName()];",
        "          config[callbacks.get(4).getPrompt()] = [callbacks.get(4).getName()];",
        "          config[callbacks.get(5).getPrompt()] = callbacks.get(5).getName();",
        "          config[callbacks.get(6).getPrompt()] = callbacks.get(6).getName();",
        "          config[callbacks.get(7).getPrompt()] = callbacks.get(7).getName();",
        "          config[callbacks.get(8).getPrompt()] = callbacks.get(8).getName();",
        "          config[callbacks.get(9).getPrompt()] = (callbacks.get(9).getName() === 'true');",
        "          config[callbacks.get(10).getPrompt()] = callbacks.get(10).getName();",
        "          config[callbacks.get(11).getPrompt()] = (callbacks.get(11).getName() === 'true');",
        "          config[callbacks.get(12).getPrompt()] = callbacks.get(12).getName();",
        "          nodeState.putShared("nodeConfig", config);",
        "        action = fr.Action.goTo(outcome).build();",
        "    }",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Collect-Set-Custom-Cookie-Node-Config.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "a31a1796-8410-46b8-82ca-eb0c6e901775": {
      "_id": "a31a1796-8410-46b8-82ca-eb0c6e901775",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Collect all the configuration items required for the Set Custom Cookie node to function properly.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Collect Set Custom Cookie Node Config",
      "script": [
        "/* Collect Set Custom Cookie Node Config",
        " * ",
        " * Collect all the configuration items required for the Set Custom Cookie node to function properly.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    outcome = "true";",
        "      var config = {",
        "        "name": "oreo",",
        "        "value": "original",",
        "        "domain": ".scheuber.io",",
        "        "path": "/",",
        "        "maxAge": 3600,",
        "        "useHttpOnlyCookie": true,",
        "        "useSecureCookie": true,",
        "        "sameSite": "NONE"",
        "    };",
        "  ",
        "      var script = "";",
        "    script += "Array.prototype.slice.call(";",
        "    script += "    document.getElementsByTagName('input')";",
        "    script += ").forEach(";",
        "    script += "    function (input,i) {";",
        "    script += "        console.log('input '+i);"",
        "    script += "        var config = JSON.parse('"+JSON.stringify(config)+"');";",
        "    script += "        var keys = Object.keys(config);";",
        "    script += "        if (input.type === 'text') {";",
        "    script += "            input.setAttribute('value', config[keys[i]]);";",
        "    script += "            input.dispatchEvent(new KeyboardEvent( 'input' , {'key':'Enter'} ));";",
        "    script += "        }";",
        "    script += "    }";",
        "    script += ");";",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "          javax.security.auth.callback.NameCallback,",
        "        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        "    )",
        "    if (callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "            new fr.NameCallback("name"),",
        "            new fr.NameCallback("value"),",
        "            new fr.NameCallback("domain"),",
        "            new fr.NameCallback("path"),",
        "            new fr.NameCallback("maxAge"),",
        "            new fr.NameCallback("useHttpOnlyCookie"),",
        "            new fr.NameCallback("useSecureCookie"),",
        "            new fr.NameCallback("sameSite"),",
        "              new fr.ScriptTextOutputCallback(script)",
        "        ).build();",
        "    }",
        "    else {",
        "          config[callbacks.get(0).getPrompt()] = callbacks.get(0).getName();",
        "          config[callbacks.get(1).getPrompt()] = callbacks.get(1).getName();",
        "          config[callbacks.get(2).getPrompt()] = callbacks.get(2).getName();",
        "          config[callbacks.get(3).getPrompt()] = callbacks.get(3).getName();",
        "          config[callbacks.get(4).getPrompt()] = parseInt(callbacks.get(4).getName(), 10).toFixed();",
        "          config[callbacks.get(5).getPrompt()] = (""+callbacks.get(5).getName() === 'true');",
        "          config[callbacks.get(6).getPrompt()] = (""+callbacks.get(6).getName() === 'true');",
        "          config[callbacks.get(7).getPrompt()] = callbacks.get(7).getName();",
        "          nodeState.putShared("nodeConfig", config);",
        "        action = fr.Action.goTo(outcome).build();",
        "    }",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Config-Provider.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "5e854779-6ec1-4c39-aeba-0477e0986646": {
      "_id": "5e854779-6ec1-4c39-aeba-0477e0986646",
      "context": "CONFIG_PROVIDER_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Default global script for Config Provider",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Config Provider",
      "script": [
        "/*",
        " * Copyright 2021 ForgeRock AS. All Rights Reserved",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/**",
        " * The following script is a simplified template for understanding how to build",
        " * up a config Map object with custom values. The Config Provider Node will then",
        " * provide this config Map to the desired node type. It is important that the Map",
        " * you build here is named 'config'.",
        " *",
        " * Defined variables:",
        " *",
        " * nodeState - Node State (1)",
        " *           Always present, this represents the current values stored in the node state.",
        " *",
        " * idRepository - Profile Data (2)",
        " *           Always present, a repository to retrieve user information.",
        " *",
        " * secrets - Credentials and Secrets (3)",
        " *           Always present, an interface to access the Secrets API from a scripting context.",
        " *",
        " * requestHeaders (4) - Map (5)",
        " *           Always present, an object that provides methods for accessing headers in the login request.",
        " *",
        " * logger - Debug Logging (6)",
        " *          Always present, the debug logger instance.",
        " *",
        " * httpClient - HTTP Client (7)",
        " *          Always present, the HTTP client that can be used to make external HTTP requests.",
        " *",
        " * realm - String (primitive).",
        " *          Always present, the name of the realm the user is authenticating to.",
        " *",
        " * existingSession - Map<String, String> (5)",
        " *          Present if the request contains the session cookie, the user's session object. The returned map from",
        " *          SSOToken.getProperties() (8)",
        " *",
        " * requestParameters - Map (5)",
        " *          Always present, the object that contains the authentication request parameters.",
        " *",
        " *",
        " * Outputs:",
        " *",
        " * config - Map (5)",
        " *           Define and fill a Map object named 'config' with custom values, this will define the configuration for the",
        " *           associated node selected in the ConfigProviderNode.",
        " *",
        " * Reference:",
        " * (1) Node State - https://backstage.forgerock.com/docs/idcloud-am/latest/authentication-guide/scripting-api-node.html#scripting-api-node-nodeState",
        " * (2) Profile Data - https://backstage.forgerock.com/docs/am/7.1/authentication-guide/scripting-api-node.html#scripting-api-node-id-repo",
        " * (3) Credentials and Secrets - https://backstage.forgerock.com/docs/am/7.1/authentication-guide/scripting-api-node.html#scripting-api-authn-secrets",
        " * (4) Request Headers - https://backstage.forgerock.com/docs/am/7/authentication-guide/scripting-api-node.html#scripting-api-node-requestHeaders.",
        " * (5) Map - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/Map.html",
        " * (6) Debug Logging - https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.",
        " * (7) HTTP Client - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/http/Client.html.",
        " * (8) SSOToken - https://backstage.forgerock.com/docs/am/7/apidocs/com/iplanet/sso/SSOToken.html.",
        " */",
        "",
        "config = nodeState.get('nodeConfig').asMap();",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Configure-Email-Template-Node.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "22ab12ac-d1d9-414b-ab51-cfae30de8c0a": {
      "_id": "22ab12ac-d1d9-414b-ab51-cfae30de8c0a",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Create a configuration object for the Email Template Node.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Configure Email Template Node",
      "script": [
        "/* Configure Email Template Node",
        " * ",
        " * Create a configuration object for the Email Template Node.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * - error",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "  try {",
        "  outcome = 'true';",
        "  var config = {",
        "    emailAttribute: 'mail',",
        "    emailTemplateName: 'welcome',",
        "    identityAttribute: 'userName'",
        "  };",
        "  nodeState.putShared('nodeConfig', config);",
        "  } catch (error) {",
        "      outcome = 'error';",
        "    nodeState.putShared('error', error.message);",
        "  }",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Copy-to-transientState.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "452d73ee-c6f3-4f4e-9dae-e75bb3886cbd": {
      "_id": "452d73ee-c6f3-4f4e-9dae-e75bb3886cbd",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Copy sharedState to transientState",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Copy to transientState",
      "script": [
        "outcome = "true";",
        "if (sharedState.get("objectAttributes")) {",
        "    transientState.put("objectAttributes", sharedState.get("objectAttributes"))",
        "}",
        "if (sharedState.get("username")) {",
        "    transientState.put("username", sharedState.get("username"))",
        "}",
        "if (sharedState.get("_id")) {",
        "    transientState.put("_id", sharedState.get("_id"))",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./CopyIDToObjectAttributes.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "c253a7ac-ebc9-4268-9e62-89f38f98e4ab": {
      "_id": "c253a7ac-ebc9-4268-9e62-89f38f98e4ab",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "CopyIDToObjectAttributes",
      "script": [
        "/*",
        "  - Data made available by nodes that have already executed are available in the sharedState variable.",
        "  - The script should set outcome to either "true" or "false".",
        " */",
        "",
        "sharedState.get("objectAttributes").put("_id", sharedState.get("_id"));",
        "",
        "outcome = "true";",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./CopyOTPToObjectAttributes.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "5561a45f-bf00-4ec5-bab4-f069bac9a38b": {
      "_id": "5561a45f-bf00-4ec5-bab4-f069bac9a38b",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Copy an OTP generated by the "HOTP Generator" node to the IDM profile shared state so it can be patched to the user profile.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "CopyOTPToObjectAttributes",
      "script": [
        "/* CopyOTPToObjectAttributes",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Copy an OTP generated by the "HOTP Generator" node to the IDM profile ",
        " * shared state so it can be patched to the user profile.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "if (sharedState.get("objectAttributes")) {",
        "    sharedState.get("objectAttributes").put("description", sharedState.get("oneTimePassword"))",
        "}",
        "else {",
        "    sharedState.put("objectAttributes", {description: sharedState.get("oneTimePassword")});",
        "}",
        "outcome = "true";",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./CopySAMLDataToObjectAttributes.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "8e03eb43-ed5d-4c12-9e15-2051cc9be578": {
      "_id": "8e03eb43-ed5d-4c12-9e15-2051cc9be578",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Copy SAML Data To ObjectAttributes",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "CopySAMLDataToObjectAttributes",
      "script": [
        "/* CopySAMLDataToObjectAttributes",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Copy SAML Data To ObjectAttributes.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "outcome = "true";",
        "if (sharedState.get("userInfo")) {",
        "    if (sharedState.get("objectAttributes")) {",
        "          sharedState.remove("objectAttributes");",
        "    }",
        "    var userName=null,givenName=null,sn=null,mail=null,telephoneNumber=null,roles=null;",
        "",
        "    try { userName=sharedState.get("userInfo").get("userNames").get("uid").get(0).toString(); } catch (e) {}",
        "    try { givenName=sharedState.get("userInfo").get("attributes").get("givenName").get(0).toString(); } catch (e) {}",
        "    try { sn=sharedState.get("userInfo").get("attributes").get("sn").get(0).toString(); } catch (e) {}",
        "    try { mail=sharedState.get("userInfo").get("attributes").get("mail").get(0).toString(); } catch (e) {}",
        "    try { telephoneNumber=sharedState.get("userInfo").get("attributes").get("telephoneNumber").get(0).toString(); } catch (e) {}",
        "    //try { roles=sharedState.get("userInfo").get("attributes").get("roles").get(0).toString(); } catch (e) {}",
        "    try { roles=sharedState.get("userInfo").get("attributes").get("roles").toArray().join("|"); } catch (e) {}",
        "",
        "    sharedState.put("objectAttributes", {"userName":userName,"givenName":givenName,"sn":sn,"mail":mail,"telephoneNumber":telephoneNumber,"roles":roles});",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Device-Id-(Match)-Client-Side.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "157298c0-7d31-4059-a95b-eeb08473b7e5": {
      "_id": "157298c0-7d31-4059-a95b-eeb08473b7e5",
      "context": "AUTHENTICATION_CLIENT_SIDE",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Default global script for client side Device Id (Match) Authentication Module",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Device Id (Match) - Client Side",
      "script": [
        "var fontDetector = (function () {",
        "    /**",
        "     * JavaScript code to detect available availability of a",
        "     * particular font in a browser using JavaScript and CSS.",
        "     *",
        "     * Author : Lalit Patel",
        "     * Website: http://www.lalit.org/lab/javascript-css-font-detect/",
        "     * License: Apache Software License 2.0",
        "     *          http://www.apache.org/licenses/LICENSE-2.0",
        "     * Version: 0.15 (21 Sep 2009)",
        "     *          Changed comparision font to default from sans-default-default,",
        "     *          as in FF3.0 font of child element didn't fallback",
        "     *          to parent element if the font is missing.",
        "     * Version: 0.2 (04 Mar 2012)",
        "     *          Comparing font against all the 3 generic font families ie,",
        "     *          'monospace', 'sans-serif' and 'sans'. If it doesn't match all 3",
        "     *          then that font is 100% not available in the system",
        "     * Version: 0.3 (24 Mar 2012)",
        "     *          Replaced sans with serif in the list of baseFonts",
        "     */",
        "    /*",
        "     * Portions Copyrighted 2013 ForgeRock AS.",
        "     */",
        "    var detector = {}, baseFonts, testString, testSize, h, s, defaultWidth = {}, defaultHeight = {}, index;",
        "",
        "    // a font will be compared against all the three default fonts.",
        "    // and if it doesn't match all 3 then that font is not available.",
        "    baseFonts = ['monospace', 'sans-serif', 'serif'];",
        "",
        "    //we use m or w because these two characters take up the maximum width.",
        "    // And we use a LLi so that the same matching fonts can get separated",
        "    testString = "mmmmmmmmmmlli";",
        "",
        "    //we test using 72px font size, we may use any size. I guess larger the better.",
        "    testSize = '72px';",
        "",
        "    h = document.getElementsByTagName("body")[0];",
        "",
        "    // create a SPAN in the document to get the width of the text we use to test",
        "    s = document.createElement("span");",
        "    s.style.fontSize = testSize;",
        "    s.innerHTML = testString;",
        "    for (index in baseFonts) {",
        "        //get the default width for the three base fonts",
        "        s.style.fontFamily = baseFonts[index];",
        "        h.appendChild(s);",
        "        defaultWidth[baseFonts[index]] = s.offsetWidth; //width for the default font",
        "        defaultHeight[baseFonts[index]] = s.offsetHeight; //height for the defualt font",
        "        h.removeChild(s);",
        "    }",
        "",
        "    detector.detect = function(font) {",
        "        var detected = false, index, matched;",
        "        for (index in baseFonts) {",
        "            s.style.fontFamily = font + ',' + baseFonts[index]; // name of the font along with the base font for fallback.",
        "            h.appendChild(s);",
        "            matched = (s.offsetWidth !== defaultWidth[baseFonts[index]] || s.offsetHeight !== defaultHeight[baseFonts[index]]);",
        "            h.removeChild(s);",
        "            detected = detected || matched;",
        "        }",
        "        return detected;",
        "    };",
        "",
        "    return detector;",
        "}());",
        "/*",
        " * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS HEADER.",
        " *",
        " * Copyright (c) 2009 Sun Microsystems Inc. All Rights Reserved",
        " *",
        " * The contents of this file are subject to the terms",
        " * of the Common Development and Distribution License",
        " * (the License). You may not use this file except in",
        " * compliance with the License.",
        " *",
        " * You can obtain a copy of the License at",
        " * https://opensso.dev.java.net/public/CDDLv1.0.html or",
        " * opensso/legal/CDDLv1.0.txt",
        " * See the License for the specific language governing",
        " * permission and limitations under the License.",
        " *",
        " * When distributing Covered Code, include this CDDL",
        " * Header Notice in each file and include the License file",
        " * at opensso/legal/CDDLv1.0.txt.",
        " * If applicable, add the following below the CDDL Header,",
        " * with the fields enclosed by brackets [] replaced by",
        " * your own identifying information:",
        " * "Portions Copyrighted [year] [name of copyright owner]"",
        " *",
        " */",
        "/*",
        " * Portions Copyrighted 2013 Syntegrity.",
        " * Portions Copyrighted 2013-2014 ForgeRock AS.",
        " */",
        "",
        "var collectScreenInfo = function () {",
        "        var screenInfo = {};",
        "        if (screen) {",
        "            if (screen.width) {",
        "                screenInfo.screenWidth = screen.width;",
        "            }",
        "",
        "            if (screen.height) {",
        "                screenInfo.screenHeight = screen.height;",
        "            }",
        "",
        "            if (screen.pixelDepth) {",
        "                screenInfo.screenColourDepth = screen.pixelDepth;",
        "            }",
        "        } else {",
        "            console.warn("Cannot collect screen information. screen is not defined.");",
        "        }",
        "        return screenInfo;",
        "    },",
        "    collectTimezoneInfo = function () {",
        "        var timezoneInfo =  {}, offset = new Date().getTimezoneOffset();",
        "",
        "        if (offset) {",
        "            timezoneInfo.timezone = offset;",
        "        } else {",
        "            console.warn("Cannot collect timezone information. timezone is not defined.");",
        "        }",
        "",
        "        return timezoneInfo;",
        "    },",
        "    collectBrowserPluginsInfo = function () {",
        "",
        "        if (navigator && navigator.plugins) {",
        "            var pluginsInfo = {}, i, plugins = navigator.plugins;",
        "            pluginsInfo.installedPlugins = "";",
        "",
        "            for (i = 0; i < plugins.length; i++) {",
        "                pluginsInfo.installedPlugins = pluginsInfo.installedPlugins + plugins[i].filename + ";";",
        "            }",
        "",
        "            return pluginsInfo;",
        "        } else {",
        "            console.warn("Cannot collect browser plugin information. navigator.plugins is not defined.");",
        "            return {};",
        "        }",
        "",
        "    },",
        "// Getting geolocation takes some time and is done asynchronously, hence need a callback which is called once geolocation is retrieved.",
        "    collectGeolocationInfo = function (callback) {",
        "        var geolocationInfo = {},",
        "            successCallback = function(position) {",
        "                geolocationInfo.longitude = position.coords.longitude;",
        "                geolocationInfo.latitude = position.coords.latitude;",
        "                callback(geolocationInfo);",
        "            }, errorCallback = function(error) {",
        "                console.warn("Cannot collect geolocation information. " + error.code + ": " + error.message);",
        "                callback(geolocationInfo);",
        "            };",
        "        if (navigator && navigator.geolocation) {",
        "            // NB: If user chooses 'Not now' on Firefox neither callback gets called",
        "            //     https://bugzilla.mozilla.org/show_bug.cgi?id=675533",
        "            navigator.geolocation.getCurrentPosition(successCallback, errorCallback);",
        "        } else {",
        "            console.warn("Cannot collect geolocation information. navigator.geolocation is not defined.");",
        "            callback(geolocationInfo);",
        "        }",
        "    },",
        "    collectBrowserFontsInfo = function () {",
        "        var fontsInfo = {}, i, fontsList = ["cursive","monospace","serif","sans-serif","fantasy","default","Arial","Arial Black",",
        "            "Arial Narrow","Arial Rounded MT Bold","Bookman Old Style","Bradley Hand ITC","Century","Century Gothic",",
        "            "Comic Sans MS","Courier","Courier New","Georgia","Gentium","Impact","King","Lucida Console","Lalit",",
        "            "Modena","Monotype Corsiva","Papyrus","Tahoma","TeX","Times","Times New Roman","Trebuchet MS","Verdana",",
        "            "Verona"];",
        "        fontsInfo.installedFonts = "";",
        "",
        "        for (i = 0; i < fontsList.length; i++) {",
        "            if (fontDetector.detect(fontsList[i])) {",
        "                fontsInfo.installedFonts = fontsInfo.installedFonts + fontsList[i] + ";";",
        "            }",
        "        }",
        "        return fontsInfo;",
        "    },",
        "    devicePrint = {};",
        "",
        "devicePrint.screen = collectScreenInfo();",
        "devicePrint.timezone = collectTimezoneInfo();",
        "devicePrint.plugins = collectBrowserPluginsInfo();",
        "devicePrint.fonts = collectBrowserFontsInfo();",
        "",
        "if (navigator.userAgent) {",
        "    devicePrint.userAgent = navigator.userAgent;",
        "}",
        "if (navigator.appName) {",
        "    devicePrint.appName = navigator.appName;",
        "}",
        "if (navigator.appCodeName) {",
        "    devicePrint.appCodeName = navigator.appCodeName;",
        "}",
        "if (navigator.appVersion) {",
        "    devicePrint.appVersion = navigator.appVersion;",
        "}",
        "if (navigator.appMinorVersion) {",
        "    devicePrint.appMinorVersion = navigator.appMinorVersion;",
        "}",
        "if (navigator.buildID) {",
        "    devicePrint.buildID = navigator.buildID;",
        "}",
        "if (navigator.platform) {",
        "    devicePrint.platform = navigator.platform;",
        "}",
        "if (navigator.cpuClass) {",
        "    devicePrint.cpuClass = navigator.cpuClass;",
        "}",
        "if (navigator.oscpu) {",
        "    devicePrint.oscpu = navigator.oscpu;",
        "}",
        "if (navigator.product) {",
        "    devicePrint.product = navigator.product;",
        "}",
        "if (navigator.productSub) {",
        "    devicePrint.productSub = navigator.productSub;",
        "}",
        "if (navigator.vendor) {",
        "    devicePrint.vendor = navigator.vendor;",
        "}",
        "if (navigator.vendorSub) {",
        "    devicePrint.vendorSub = navigator.vendorSub;",
        "}",
        "if (navigator.language) {",
        "    devicePrint.language = navigator.language;",
        "}",
        "if (navigator.userLanguage) {",
        "    devicePrint.userLanguage = navigator.userLanguage;",
        "}",
        "if (navigator.browserLanguage) {",
        "    devicePrint.browserLanguage = navigator.browserLanguage;",
        "}",
        "if (navigator.systemLanguage) {",
        "    devicePrint.systemLanguage = navigator.systemLanguage;",
        "}",
        "",
        "// Attempt to collect geo-location information and return this with the data collected so far.",
        "// Otherwise, if geo-location fails or takes longer than 30 seconds, auto-submit the data collected so far.",
        "autoSubmitDelay = 30000;",
        "output.value = JSON.stringify(devicePrint);",
        "collectGeolocationInfo(function(geolocationInfo) {",
        "    devicePrint.geolocation = geolocationInfo;",
        "    output.value = JSON.stringify(devicePrint);",
        "    submit();",
        "});",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Device-Id-(Match)-Server-Side.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "703dab1a-1921-4981-98dd-b8e5349d8548": {
      "_id": "703dab1a-1921-4981-98dd-b8e5349d8548",
      "context": "AUTHENTICATION_SERVER_SIDE",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Default global script for server side Device Id (Match) Authentication Module",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Device Id (Match) - Server Side",
      "script": [
        "/*",
        " * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS HEADER.",
        " *",
        " * Copyright (c) 2009 Sun Microsystems Inc. All Rights Reserved",
        " *",
        " * The contents of this file are subject to the terms",
        " * of the Common Development and Distribution License",
        " * (the License). You may not use this file except in",
        " * compliance with the License.",
        " *",
        " * You can obtain a copy of the License at",
        " * https://opensso.dev.java.net/public/CDDLv1.0.html or",
        " * opensso/legal/CDDLv1.0.txt",
        " * See the License for the specific language governing",
        " * permission and limitations under the License.",
        " *",
        " * When distributing Covered Code, include this CDDL",
        " * Header Notice in each file and include the License file",
        " * at opensso/legal/CDDLv1.0.txt.",
        " * If applicable, add the following below the CDDL Header,",
        " * with the fields enclosed by brackets [] replaced by",
        " * your own identifying information:",
        " * "Portions Copyrighted [year] [name of copyright owner]"",
        " *",
        " */",
        "/*",
        " * Portions Copyrighted 2013 Syntegrity.",
        " * Portions Copyrighted 2013-2018 ForgeRock AS.",
        " */",
        "",
        "var ScalarComparator = {}, ScreenComparator = {}, MultiValueComparator = {}, UserAgentComparator = {}, GeolocationComparator = {};",
        "",
        "var config = {",
        "    profileExpiration: 30,              //in days",
        "    maxProfilesAllowed: 5,",
        "    maxPenaltyPoints: 0,",
        "    attributes: {",
        "        screen: {",
        "            required: true,",
        "            comparator: ScreenComparator,",
        "            args: {",
        "                penaltyPoints: 50",
        "            }",
        "        },",
        "        plugins: {",
        "            installedPlugins: {",
        "                required: false,",
        "                comparator: MultiValueComparator,",
        "                args: {",
        "                    maxPercentageDifference: 10,",
        "                    maxDifferences: 5,",
        "                    penaltyPoints: 100",
        "                }",
        "            }",
        "        },",
        "        fonts: {",
        "            installedFonts: {",
        "                required: false,",
        "                comparator: MultiValueComparator,",
        "                args: {",
        "                    maxPercentageDifference: 10,",
        "                    maxDifferences: 5,",
        "                    penaltyPoints: 100",
        "                }",
        "            }",
        "        },",
        "        timezone: {",
        "            timezone: {",
        "                required: false,",
        "                comparator: ScalarComparator,",
        "                args: {",
        "                    penaltyPoints: 100",
        "                }",
        "            }",
        "        },",
        "        userAgent: {",
        "            required: true,",
        "            comparator: UserAgentComparator,",
        "            args: {",
        "                ignoreVersion: true,",
        "                penaltyPoints: 100",
        "            }",
        "        },",
        "        geolocation: {",
        "            required: false,",
        "            comparator: GeolocationComparator,",
        "            args: {",
        "                allowedRange: 100,            //in miles",
        "                penaltyPoints: 100",
        "            }",
        "        }",
        "    }",
        "};",
        "",
        "//---------------------------------------------------------------------------//",
        "//                           Comparator functions                            //",
        "//---------------------------------------------------------------------------//",
        "",
        "var all, any, calculateDistance, calculateIntersection, calculatePercentage, nullOrUndefined, splitAndTrim,",
        "    undefinedLocation;",
        "",
        "// ComparisonResult",
        "",
        "/**",
        " * Constructs an instance of a ComparisonResult with the given penalty points.",
        " *",
        " * @param penaltyPoints (Number) The penalty points for the comparison (defaults to 0).",
        " * @param additionalInfoInCurrentValue (boolean) Whether the current value contains more information",
        " *                                               than the stored value (defaults to false).",
        " */",
        "function ComparisonResult() {",
        "",
        "    var penaltyPoints = 0,",
        "        additionalInfoInCurrentValue = false;",
        "",
        "    if (arguments[0] !== undefined && arguments[1] !== undefined) {",
        "        penaltyPoints = arguments[0];",
        "        additionalInfoInCurrentValue = arguments[1];",
        "    }",
        "",
        "    if (arguments[0] !== undefined && arguments[1] === undefined) {",
        "        if (typeof(arguments[0]) === "boolean") {",
        "            additionalInfoInCurrentValue = arguments[0];",
        "        } else {",
        "            penaltyPoints = arguments[0];",
        "        }",
        "    }",
        "",
        "    this.penaltyPoints = penaltyPoints;",
        "    this.additionalInfoInCurrentValue = additionalInfoInCurrentValue;",
        "",
        "}",
        "",
        "ComparisonResult.ZERO_PENALTY_POINTS = new ComparisonResult(0);",
        "",
        "/**",
        " * Static method for functional programming.",
        " *",
        " * @return boolean true if comparisonResult.isSuccessful().",
        " */",
        "ComparisonResult.isSuccessful =  function(comparisonResult) {",
        "    return comparisonResult.isSuccessful();",
        "};",
        "",
        "",
        "/**",
        " * Static method for functional programming.",
        " *",
        " * @return boolean true if comparisonResult.additionalInfoInCurrentValue.",
        " */",
        "ComparisonResult.additionalInfoInCurrentValue =  function(comparisonResult) {",
        "    return comparisonResult.additionalInfoInCurrentValue;",
        "};",
        "",
        "/**",
        " * Comparison function that can be provided as an argument to array.sort",
        " */",
        "ComparisonResult.compare = function(first, second) {",
        "    if (nullOrUndefined(first) && nullOrUndefined(second)) {",
        "        return 0;",
        "    } else if (nullOrUndefined(first)) {",
        "        return -1;",
        "    } else if (nullOrUndefined(second)) {",
        "        return 1;",
        "    } else {",
        "        if (first.penaltyPoints !== second.penaltyPoints) {",
        "            return first.penaltyPoints - second.penaltyPoints;",
        "        } else {",
        "            return (first.additionalInfoInCurrentValue ? 1 : 0) - (second.additionalInfoInCurrentValue ? 1 : 0);",
        "        }",
        "    }",
        "};",
        "",
        "/**",
        " * Amalgamates the given ComparisonResult into this ComparisonResult.",
        " *",
        " * @param comparisonResult The ComparisonResult to include.",
        " */",
        "ComparisonResult.prototype.addComparisonResult = function(comparisonResult) {",
        "    this.penaltyPoints += comparisonResult.penaltyPoints;",
        "    if (comparisonResult.additionalInfoInCurrentValue) {",
        "        this.additionalInfoInCurrentValue = comparisonResult.additionalInfoInCurrentValue;",
        "    }",
        "};",
        "",
        "/**",
        " * Returns true if no penalty points have been assigned for the comparison.",
        " *",
        " * @return boolean true if the comparison was successful.",
        " */",
        "ComparisonResult.prototype.isSuccessful = function() {",
        "    return nullOrUndefined(this.penaltyPoints) || this.penaltyPoints === 0;",
        "};",
        "",
        "/**",
        " * Compares two simple objects (String|Number) and if they are equal then returns a ComparisonResult with zero",
        " * penalty points assigned, otherwise returns a ComparisonResult with the given number of penalty points assigned.",
        " *",
        " * @param currentValue (String|Number) The current value.",
        " * @param storedValue (String|Number) The stored value.",
        " * @param config: {",
        " *            "penaltyPoints": (Number) The number of penalty points.",
        " *        }",
        " * @return ComparisonResult.",
        " */",
        "ScalarComparator.compare = function (currentValue, storedValue, config) {",
        "    if (logger.messageEnabled()) {",
        "        logger.message("StringComparator.compare:currentValue: " + JSON.stringify(currentValue));",
        "        logger.message("StringComparator.compare:storedValue: " + JSON.stringify(storedValue));",
        "        logger.message("StringComparator.compare:config: " + JSON.stringify(config));",
        "    }",
        "    if (config.penaltyPoints === 0) {",
        "        return ComparisonResult.ZERO_PENALTY_POINTS;",
        "    }",
        "",
        "    if (!nullOrUndefined(storedValue)) {",
        "        if (nullOrUndefined(currentValue) || currentValue !== storedValue) {",
        "            return new ComparisonResult(config.penaltyPoints);",
        "        }",
        "    } else if (!nullOrUndefined(currentValue)) {",
        "        return new ComparisonResult(true);",
        "    }",
        "",
        "    return ComparisonResult.ZERO_PENALTY_POINTS;",
        "};",
        "",
        "/**",
        " * Compares two screens and if they are equal then returns a ComparisonResult with zero penalty points assigned,",
        " * otherwise returns a ComparisonResult with the given number of penalty points assigned.",
        " *",
        " * @param currentValue: {",
        " *            "screenWidth": (Number) The current client screen width.",
        " *            "screenHeight": (Number) The current client screen height.",
        " *            "screenColourDepth": (Number) The current client screen colour depth.",
        " *        }",
        " * @param storedValue: {",
        " *            "screenWidth": (Number) The stored client screen width.",
        " *            "screenHeight": (Number) The stored client screen height.",
        " *            "screenColourDepth": (Number) The stored client screen colour depth.",
        " *        }",
        " * @param config: {",
        " *            "penaltyPoints": (Number) The number of penalty points.",
        " *        }",
        " * @return ComparisonResult",
        " */",
        "ScreenComparator.compare = function (currentValue, storedValue, config) {",
        "    if (logger.messageEnabled()) {",
        "        logger.message("ScreenComparator.compare:currentValue: " + JSON.stringify(currentValue));",
        "        logger.message("ScreenComparator.compare:storedValue: " + JSON.stringify(storedValue));",
        "        logger.message("ScreenComparator.compare:config: " + JSON.stringify(config));",
        "    }",
        "",
        "    if (nullOrUndefined(currentValue)) {",
        "        currentValue = {screenWidth: null, screenHeight: null, screenColourDepth: null};",
        "    }",
        "    if (nullOrUndefined(storedValue)) {",
        "        storedValue = {screenWidth: null, screenHeight: null, screenColourDepth: null};",
        "    }",
        "",
        "    var comparisonResults = [",
        "        ScalarComparator.compare(currentValue.screenWidth, storedValue.screenWidth, config),",
        "        ScalarComparator.compare(currentValue.screenHeight, storedValue.screenHeight, config),",
        "        ScalarComparator.compare(currentValue.screenColourDepth, storedValue.screenColourDepth, config)];",
        "",
        "    if (all(comparisonResults, ComparisonResult.isSuccessful)) {",
        "        return new ComparisonResult(any(comparisonResults, ComparisonResult.additionalInfoInCurrentValue));",
        "    } else {",
        "        return new ComparisonResult(config.penaltyPoints);",
        "    }",
        "};",
        "",
        "/**",
        " * Splits both values using delimiter, trims every value and compares collections of values.",
        " * Returns zero-result for same multi-value attributes.",
        " *",
        " * If collections are not same checks if number of differences is less or equal maxDifferences or",
        " * percentage of difference is less or equal maxPercentageDifference.",
        " *",
        " * If yes then returns zero-result with additional info, else returns penaltyPoints-result.",
        " *",
        " * @param currentValue: (String) The current value.",
        " * @param storedValue: (String) The stored value.",
        " * @param config: {",
        " *            "maxPercentageDifference": (Number) The max difference percentage in the values,",
        " *                                                before the penalty is assigned.",
        " *            "maxDifferences": (Number) The max number of differences in the values,",
        " *                                       before the penalty points are assigned.",
        " *            "penaltyPoints": (Number) The number of penalty points.",
        "  *        }",
        " * @return ComparisonResult",
        " */",
        "MultiValueComparator.compare = function (currentValue, storedValue, config) {",
        "    if (logger.messageEnabled()) {",
        "        logger.message("MultiValueComparator.compare:currentValue: " + JSON.stringify(currentValue));",
        "        logger.message("MultiValueComparator.compare:storedValue: " + JSON.stringify(storedValue));",
        "        logger.message("MultiValueComparator.compare:config: " + JSON.stringify(config));",
        "    }",
        "",
        "    var delimiter = ";",",
        "        currentValues = splitAndTrim(currentValue, delimiter),",
        "        storedValues = splitAndTrim(storedValue, delimiter),",
        "        maxNumberOfElements = Math.max(currentValues.length, storedValues.length),",
        "        numberOfTheSameElements = calculateIntersection(currentValues, storedValues).length,",
        "        numberOfDifferences = maxNumberOfElements - numberOfTheSameElements,",
        "        percentageOfDifferences = calculatePercentage(numberOfDifferences, maxNumberOfElements);",
        "",
        "    if (nullOrUndefined(storedValue) && !nullOrUndefined(currentValue)) {",
        "        return new ComparisonResult(true);",
        "    }",
        "",
        "    if (logger.messageEnabled()) {",
        "        logger.message(numberOfTheSameElements + " of " + maxNumberOfElements + " are same");",
        "    }",
        "",
        "    if (maxNumberOfElements === 0) {",
        "        logger.message("Ignored because no attributes found in both profiles");",
        "        return ComparisonResult.ZERO_PENALTY_POINTS;",
        "    }",
        "",
        "    if (numberOfTheSameElements === maxNumberOfElements) {",
        "        logger.message("Ignored because all attributes are same");",
        "        return ComparisonResult.ZERO_PENALTY_POINTS;",
        "    }",
        "",
        "    if (numberOfDifferences > config.maxDifferences) {",
        "        if (logger.messageEnabled()) {",
        "            logger.message("Would be ignored if not more than " + config.maxDifferences + " differences");",
        "        }",
        "        return new ComparisonResult(config.penaltyPoints);",
        "    }",
        "",
        "    if (percentageOfDifferences > config.maxPercentageDifference) {",
        "        if (logger.messageEnabled()) {",
        "            logger.message(percentageOfDifferences + " percents are different");",
        "            logger.message("Would be ignored if not more than " + config.maxPercentageDifference + " percent");",
        "        }",
        "        return new ComparisonResult(config.penaltyPoints);",
        "    }",
        "",
        "    if (logger.messageEnabled()) {",
        "        logger.message("Ignored because number of differences(" + numberOfDifferences + ") not more than "",
        "            + config.maxDifferences);",
        "        logger.message(percentageOfDifferences + " percents are different");",
        "        logger.message("Ignored because not more than " + config.maxPercentageDifference + " percent");",
        "    }",
        "    return new ComparisonResult(true);",
        "};",
        "",
        "/**",
        " * Compares two User Agent Strings and if they are equal then returns a ComparisonResult with zero penalty",
        " * points assigned, otherwise returns a ComparisonResult with the given number of penalty points assigned.",
        " *",
        " * @param currentValue (String) The current value.",
        " * @param storedValue (String) The stored value.",
        " * @param config: {",
        " *            "ignoreVersion": (boolean) If the version numbers in the User Agent Strings should be ignore",
        " *                                       in the comparison.",
        " *            "penaltyPoints": (Number) The number of penalty points.",
        " *        }",
        " * @return A ComparisonResult.",
        " */",
        "UserAgentComparator.compare = function (currentValue, storedValue, config) {",
        "    if (logger.messageEnabled()) {",
        "        logger.message("UserAgentComparator.compare:currentValue: " + JSON.stringify(currentValue));",
        "        logger.message("UserAgentComparator.compare:storedValue: " + JSON.stringify(storedValue));",
        "        logger.message("UserAgentComparator.compare:config: " + JSON.stringify(config));",
        "    }",
        "",
        "    if (config.ignoreVersion) {",
        "        // remove version number",
        "        currentValue = nullOrUndefined(currentValue) ? null : currentValue.replace(/[\\d\\.]+/g, "").trim();",
        "        storedValue = nullOrUndefined(storedValue) ? null : storedValue.replace(/[\\d\\.]+/g, "").trim();",
        "    }",
        "",
        "    return ScalarComparator.compare(currentValue, storedValue, config);",
        "};",
        "",
        "/**",
        " * Compares two locations, taking into account a degree of difference.",
        " *",
        " * @param currentValue: {",
        " *            "latitude": (Number) The current latitude.",
        " *            "longitude": (Number) The current longitude.",
        " *        }",
        " * @param storedValue: {",
        " *            "latitude": (Number) The stored latitude.",
        " *            "longitude": (Number) The stored longitude.",
        " *        }",
        " * @param config: {",
        " *            "allowedRange": (Number) The max difference allowed in the two locations, before the penalty is assigned.",
        " *            "penaltyPoints": (Number) The number of penalty points.",
        "*         }",
        " * @return ComparisonResult",
        " */",
        "GeolocationComparator.compare = function (currentValue, storedValue, config) {",
        "    if (logger.messageEnabled()) {",
        "        logger.message("GeolocationComparator.compare:currentValue: " + JSON.stringify(currentValue));",
        "        logger.message("GeolocationComparator.compare:storedValue: " + JSON.stringify(storedValue));",
        "        logger.message("GeolocationComparator.compare:config: " + JSON.stringify(config));",
        "    }",
        "",
        "    // Check for undefined stored or current locations",
        "",
        "    if (undefinedLocation(currentValue) && undefinedLocation(storedValue)) {",
        "        return ComparisonResult.ZERO_PENALTY_POINTS;",
        "    }",
        "    if (undefinedLocation(currentValue) && !undefinedLocation(storedValue)) {",
        "        return new ComparisonResult(config.penaltyPoints);",
        "    }",
        "    if (!undefinedLocation(currentValue) && undefinedLocation(storedValue)) {",
        "        return new ComparisonResult(true);",
        "    }",
        "",
        "    // Both locations defined, therefore perform comparison",
        "",
        "    var distance = calculateDistance(currentValue, storedValue);",
        "",
        "    if (logger.messageEnabled()) {",
        "        logger.message("Distance between (" + currentValue.latitude + "," + currentValue.longitude + ") and (" +",
        "            storedValue.latitude + "," + storedValue.longitude + ") is " + distance + " miles");",
        "    }",
        "",
        "    if (parseFloat(distance.toPrecision(5)) === 0) {",
        "        logger.message("Location is the same");",
        "        return ComparisonResult.ZERO_PENALTY_POINTS;",
        "    }",
        "",
        "    if (distance <= config.allowedRange) {",
        "        if (logger.messageEnabled()) {",
        "            logger.message("Tolerated because distance not more then " + config.allowedRange);",
        "        }",
        "        return new ComparisonResult(true);",
        "    } else {",
        "        if (logger.messageEnabled()) {",
        "            logger.message("Would be ignored if distance not more then " + config.allowedRange);",
        "        }",
        "        return new ComparisonResult(config.penaltyPoints);",
        "    }",
        "};",
        "",
        "",
        "//---------------------------------------------------------------------------//",
        "//                    Device Print Logic - DO NOT MODIFY                     //",
        "//---------------------------------------------------------------------------//",
        "",
        "// Utility functions",
        "",
        "/**",
        " * Returns true if evaluating function f on each element of the Array a returns true.",
        " *",
        " * @param a: (Array) The array of elements to evaluate",
        " * @param f: (Function) A single argument function for mapping elements of the array to boolean.",
        " * @return boolean.",
        " */",
        "all = function(a, f) {",
        "    var i;",
        "    for (i = 0; i < a.length; i++) {",
        "        if (f(a[i]) === false) {",
        "            return false;",
        "        }",
        "    }",
        "    return true;",
        "};",
        "",
        "/**",
        " * Returns true if evaluating function f on any element of the Array a returns true.",
        " *",
        " * @param a: (Array) The array of elements to evaluate",
        " * @param f: (Function) A single argument function for mapping elements of the array to boolean.",
        " * @return boolean.",
        " */",
        "any = function(a, f) {",
        "    var i;",
        "    for (i = 0; i < a.length; i++) {",
        "        if (f(a[i]) === true) {",
        "            return true;",
        "        }",
        "    }",
        "    return false;",
        "};",
        "",
        "/**",
        " * Returns true if the provided location is null or has undefined longitude or latitude values.",
        " *",
        " * @param location: {",
        " *            "latitude": (Number) The latitude.",
        " *            "longitude": (Number) The longitude.",
        " *        }",
        " * @return boolean",
        " */",
        "undefinedLocation = function(location) {",
        "    return nullOrUndefined(location) || nullOrUndefined(location.latitude) || nullOrUndefined(location.longitude);",
        "};",
        "",
        "/**",
        " * Returns true if the provided value is null or undefined.",
        " *",
        " * @param value: a value of any type",
        " * @return boolean",
        " */",
        "nullOrUndefined = function(value) {",
        "    return value === null || value === undefined;",
        "};",
        "",
        "/**",
        " * Calculates the distances between the two locations.",
        " *",
        " * @param first: {",
        " *            "latitude": (Number) The first latitude.",
        " *            "longitude": (Number) The first longitude.",
        " *        }",
        " * @param second: {",
        " *            "latitude": (Number) The second latitude.",
        " *            "longitude": (Number) The second longitude.",
        " *        }",
        " * @return Number The distance between the two locations.",
        " */",
        "calculateDistance = function(first, second) {",
        "    var factor = (Math.PI / 180),",
        "        theta,",
        "        dist;",
        "    function degreesToRadians(degrees) {",
        "        return degrees * factor;",
        "    }",
        "    function radiansToDegrees(radians) {",
        "        return radians / factor;",
        "    }",
        "    theta = first.longitude - second.longitude;",
        "    dist = Math.sin(degreesToRadians(first.latitude)) * Math.sin(degreesToRadians(second.latitude))",
        "        + Math.cos(degreesToRadians(first.latitude)) * Math.cos(degreesToRadians(second.latitude))",
        "        * Math.cos(degreesToRadians(theta));",
        "    dist = Math.acos(dist);",
        "    dist = radiansToDegrees(dist);",
        "    dist = dist * 60 * 1.1515;",
        "    return dist;",
        "};",
        "",
        "/**",
        " * Converts a String holding a delimited sequence of values into an array.",
        " *",
        " * @param text (String) The String representation of a delimited sequence of values.",
        " * @param delimiter (String) The character delimiting values within the text String.",
        " * @return (Array) The comma separated values.",
        " */",
        "splitAndTrim = function(text, delimiter) {",
        "",
        "    var results = [],",
        "        i,",
        "        values,",
        "        value;",
        "    if (text === null) {",
        "        return results;",
        "    }",
        "",
        "    values = text.split(delimiter);",
        "    for (i = 0; i < values.length; i++) {",
        "        value = values[i].trim();",
        "        if (value !== "") {",
        "            results.push(value);",
        "        }",
        "    }",
        "",
        "    return results;",
        "};",
        "",
        "/**",
        " * Converts value to a percentage of range.",
        " *",
        " * @param value (Number) The actual number to be converted to a percentage.",
        " * @param range (Number) The total number of values (i.e. represents 100%).",
        " * @return (Number) The percentage.",
        " */",
        "calculatePercentage = function(value, range) {",
        "    if (range === 0) {",
        "        return 0;",
        "    }",
        "    return parseFloat((value / range).toPrecision(2)) * 100;",
        "};",
        "",
        "/**",
        " * Creates a new array containing only those elements found in both arrays received as arguments.",
        " *",
        " * @param first (Array) The first array.",
        " * @param second (Array) The second array.",
        " * @return (Array) The elements that found in first and second.",
        " */",
        "calculateIntersection = function(first, second) {",
        "    return first.filter(function(element) {",
        "        return second.indexOf(element) !== -1;",
        "    });",
        "};",
        "",
        "function getValue(obj, attributePath) {",
        "    var value = obj,",
        "        i;",
        "    for (i = 0; i < attributePath.length; i++) {",
        "        if (value === undefined) {",
        "            return null;",
        "        }",
        "        value = value[attributePath[i]];",
        "    }",
        "    return value;",
        "}",
        "",
        "",
        "function isLeafNode(attributeConfig) {",
        "    return attributeConfig.comparator !== undefined;",
        "}",
        "",
        "function getAttributePaths(attributeConfig, attributePath) {",
        "",
        "    var attributePaths = [],",
        "        attributeName,",
        "        attrPaths,",
        "        attrPath,",
        "        i;",
        "",
        "    for (attributeName in attributeConfig) {",
        "        if (attributeConfig.hasOwnProperty(attributeName)) {",
        "",
        "            if (isLeafNode(attributeConfig[attributeName])) {",
        "                attrPath = attributePath.slice();",
        "                attrPath.push(attributeName);",
        "                attributePaths.push(attrPath);",
        "            } else {",
        "                attrPath = attributePath.slice();",
        "                attrPath.push(attributeName);",
        "                attrPaths = getAttributePaths(attributeConfig[attributeName], attrPath);",
        "                for (i = 0; i < attrPaths.length; i++) {",
        "                    attributePaths.push(attrPaths[i]);",
        "                }",
        "            }",
        "        }",
        "    }",
        "",
        "    return attributePaths;",
        "}",
        "",
        "function getDevicePrintAttributePaths(attributeConfig) {",
        "    return getAttributePaths(attributeConfig, []);",
        "}",
        "",
        "function hasRequiredAttributes(devicePrint, attributeConfig) {",
        "",
        "    var attributePaths = getDevicePrintAttributePaths(attributeConfig),",
        "        i,",
        "        attrValue,",
        "        attrConfig;",
        "",
        "    for (i = 0; i < attributePaths.length; i++) {",
        "",
        "        attrValue = getValue(devicePrint, attributePaths[i]);",
        "        attrConfig = getValue(attributeConfig, attributePaths[i]);",
        "",
        "        if (attrConfig.required && attrValue === undefined) {",
        "            logger.warning("Device Print profile missing required attribute, " + attributePaths[i]);",
        "            return false;",
        "        }",
        "    }",
        "",
        "    logger.message("device print has required attributes");",
        "    return true;",
        "}",
        "",
        "function compareDevicePrintProfiles(attributeConfig, devicePrint, devicePrintProfiles, maxPenaltyPoints) {",
        "",
        "    var attributePaths = getDevicePrintAttributePaths(attributeConfig),",
        "        dao = sharedState.get('_DeviceIdDao'),",
        "        results,",
        "        j,",
        "        aggregatedComparisonResult,",
        "        i,",
        "        currentValue,",
        "        storedValue,",
        "        attrConfig,",
        "        comparisonResult,",
        "        selectedComparisonResult,",
        "        selectedProfile,",
        "        curDevicePrintProfile,",
        "        vals;",
        "",
        "    results = [];",
        "    for (j = 0; j < devicePrintProfiles.length; j++) {",
        "        curDevicePrintProfile = JSON.parse(org.forgerock.json.JsonValue.json(devicePrintProfiles[j]));",
        "        aggregatedComparisonResult = new ComparisonResult();",
        "        for (i = 0; i < attributePaths.length; i++) {",
        "",
        "            currentValue = getValue(devicePrint, attributePaths[i]);",
        "            storedValue = getValue(curDevicePrintProfile.devicePrint, attributePaths[i]);",
        "            attrConfig = getValue(attributeConfig, attributePaths[i]);",
        "",
        "            if (storedValue === null) {",
        "                comparisonResult = new ComparisonResult(attrConfig.penaltyPoints);",
        "            } else {",
        "                comparisonResult = attrConfig.comparator.compare(currentValue, storedValue, attrConfig.args);",
        "            }",
        "",
        "            if (logger.messageEnabled()) {",
        "                logger.message("Comparing attribute path: " + attributePaths[i]",
        "                    + ", Comparison result: successful=" + comparisonResult.isSuccessful() + ", penaltyPoints="",
        "                    + comparisonResult.penaltyPoints + ", additionalInfoInCurrentValue="",
        "                    + comparisonResult.additionalInfoInCurrentValue);",
        "            }",
        "            aggregatedComparisonResult.addComparisonResult(comparisonResult);",
        "        }",
        "        if (logger.messageEnabled()) {",
        "            logger.message("Aggregated comparison result: successful="",
        "                + aggregatedComparisonResult.isSuccessful() + ", penaltyPoints="",
        "                + aggregatedComparisonResult.penaltyPoints + ", additionalInfoInCurrentValue="",
        "                + aggregatedComparisonResult.additionalInfoInCurrentValue);",
        "        }",
        "",
        "        results.push({",
        "            key: aggregatedComparisonResult,",
        "            value: devicePrintProfiles[j]",
        "        });",
        "    }",
        "",
        "    if (results.length === 0) {",
        "        return null;",
        "    }",
        "",
        "    results.sort(function(a, b) {",
        "        return ComparisonResult.compare(a.key, b.key);",
        "    });",
        "    selectedComparisonResult = results[0].key;",
        "    if (logger.messageEnabled()) {",
        "        logger.message("Selected comparison result: successful=" + selectedComparisonResult.isSuccessful()",
        "            + ", penaltyPoints=" + selectedComparisonResult.penaltyPoints + ", additionalInfoInCurrentValue="",
        "            + selectedComparisonResult.additionalInfoInCurrentValue);",
        "    }",
        "",
        "    selectedProfile = null;",
        "    if (selectedComparisonResult.penaltyPoints <= maxPenaltyPoints) {",
        "        selectedProfile = results[0].value;",
        "        if (logger.messageEnabled()) {",
        "            logger.message("Selected profile: " + selectedProfile +",
        "                " with " + selectedComparisonResult.penaltyPoints + " penalty points");",
        "        }",
        "    }",
        "",
        "    if (selectedProfile === null) {",
        "        return false;",
        "    }",
        "",
        "    /* update profile */",
        "    selectedProfile.put("selectionCounter",",
        "        java.lang.Integer.valueOf(parseInt(selectedProfile.get("selectionCounter"), 10) + 1));",
        "    selectedProfile.put("lastSelectedDate", java.lang.Long.valueOf(new Date().getTime()));",
        "    selectedProfile.put("devicePrint", devicePrint);",
        "",
        "    vals = [];",
        "    for (i = 0; i < devicePrintProfiles.length; i++) {",
        "        vals.push(org.forgerock.json.JsonValue.json(devicePrintProfiles[i]));",
        "    }",
        "",
        "    dao.saveDeviceProfiles(username, realm, vals);",
        "",
        "    return true;",
        "}",
        "",
        "function matchDevicePrint() {",
        "",
        "    if (!username) {",
        "        logger.error("Username not set. Cannot compare user's device print profiles.");",
        "        authState = FAILED;",
        "    } else {",
        "",
        "        if (logger.messageEnabled()) {",
        "            logger.message("client devicePrint: " + clientScriptOutputData);",
        "        }",
        "",
        "        var getProfiles = function () {",
        "",
        "                function isExpiredProfile(devicePrintProfile) {",
        "                    var expirationDate = new Date(),",
        "                        lastSelectedDate;",
        "                    expirationDate.setDate(expirationDate.getDate() - config.profileExpiration);",
        "",
        "                    lastSelectedDate = new Date(devicePrintProfile.lastSelectedDate);",
        "",
        "                    return lastSelectedDate < expirationDate;",
        "                }",
        "",
        "                function getNotExpiredProfiles() {",
        "                    var profile,",
        "                        dao = sharedState.get('_DeviceIdDao'),",
        "                        results = [],",
        "                        profiles,",
        "                        iter;",
        "",
        "                    profiles = dao.getDeviceProfiles(username, realm);",
        "",
        "                    if (profiles) {",
        "                        iter = profiles.iterator();",
        "",
        "                        while (iter.hasNext()) {",
        "                            profile = iter.next().getObject();",
        "                            if (!isExpiredProfile(profile)) {",
        "                                results.push(profile);",
        "                            }",
        "                        }",
        "                    }",
        "                    if (logger.messageEnabled()) {",
        "                        logger.message("stored non-expired profiles: " + results);",
        "                    }",
        "                    return results;",
        "                }",
        "",
        "                return getNotExpiredProfiles();",
        "            },",
        "            devicePrint = JSON.parse(clientScriptOutputData),",
        "            devicePrintProfiles = getProfiles();",
        "",
        "        if (!hasRequiredAttributes(devicePrint, config.attributes)) {",
        "            logger.message("devicePrint.hasRequiredAttributes: false");",
        "            // Will fail this module but fall-through to next module. Which should be OTP.",
        "            authState = FAILED;",
        "        } else if (compareDevicePrintProfiles(config.attributes, devicePrint, devicePrintProfiles, config.maxPenaltyPoints)) {",
        "            logger.message("devicePrint.hasValidProfile: true");",
        "            authState = SUCCESS;",
        "        } else {",
        "            logger.message("devicePrint.hasValidProfile: false");",
        "            sharedState.put('devicePrintProfile', JSON.stringify(devicePrint));",
        "            // Will fail this module but fall-through to next module. Which should be OTP.",
        "            authState = FAILED;",
        "        }",
        "    }",
        "}",
        "",
        "matchDevicePrint();",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Display-Password.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "ec8b314c-8e11-4364-93b9-a3e82d2a074a": {
      "_id": "ec8b314c-8e11-4364-93b9-a3e82d2a074a",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Display Password from nodeState",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Display Password",
      "script": [
        "/* Display Password",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Display Password collected via Platform Password node.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "var password = "unable to retrieve!";",
        "if (nodeState.get("password")) {",
        "  password = nodeState.get("password").asString();",
        "}",
        "var fr = JavaImporter(",
        "    org.forgerock.openam.auth.node.api.Action,",
        "    javax.security.auth.callback.TextOutputCallback",
        ")",
        "if (callbacks.isEmpty()) {",
        "    action = fr.Action.send(",
        "        new fr.TextOutputCallback(",
        "            fr.TextOutputCallback.INFORMATION,",
        "            password",
        "        )",
        "    ).build()",
        "}",
        "else {",
        "  action = fr.Action.goTo("true").build();",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Display-Session-Info.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "37bf200a-158f-4a45-8ee5-81516e4593f8": {
      "_id": "37bf200a-158f-4a45-8ee5-81516e4593f8",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Display session info.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Display Session Info",
      "script": [
        "/* Display Session Info",
        " * ",
        " * Display Session Info.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    outcome = "true";",
        "",
        "    var anchor = "anchor-".concat(generateNumericToken('xxx'));",
        "    var halign = "left";",
        "",
        "    var choices = [];",
        "      var defaultChoice = 0;",
        "  ",
        "      var include = ["org","idp","saas","profileType","givenName","sn","mail","roles","userName","UserId","Locale","authInstant","AuthLevel","Host","Service"];",
        "    var message = "";",
        "    if (typeof existingSession !== "undefined") {",
        "          message = "<h4>Session Info</h4><p style=\\"font-family:courier;\\">";",
        "          include.forEach(function (key) {",
        "              message += "<b>" + key + "</b>: " + existingSession.get(key) + "<br/>";",
        "        });",
        "         message += "</p><p style=\\"font-size:70%;font-family:courier;\\">"",
        "          var entries = existingSession.keySet().toArray();",
        "        entries.forEach(function (key) {",
        "              if (include.indexOf(""+key)===-1) {",
        "                message += "<b>" + key + "</b>: " + existingSession.get(key) + "<br/>";",
        "            }",
        "        });",
        "         message += "</p>"",
        "          choices.push("Goto SAML App");",
        "          choices.push("Goto OIDC App");",
        "          if (""+existingSession.get("profileType") === "persistent") {",
        "              choices.push("Goto Profile Page");",
        "        }",
        "          choices.push("Logout");",
        "    } else {",
        "          message = "<h4>No Session!</h4><p>"",
        "          choices.push("Login");",
        "    }",
        "    var script = "Array.prototype.slice.call(\\n".concat(",
        "      "document.getElementsByClassName('callback-component')).forEach(\\n").concat(",
        "      "function (e) {\\n").concat(",
        "      "  var message = e.firstElementChild;\\n").concat(",
        "      "  if (message.firstChild && message.firstChild.nodeName == '#text' && message.firstChild.nodeValue.trim() == '").concat(anchor).concat("') {\\n").concat(",
        "      "    message.className = \\"\\";\\n").concat(",
        "      "    message.style = \\"text-align: left; inline-size: 430px; overflow-wrap: break-word;\\";\\n").concat(",
        "      "    message.align = \\"").concat(halign).concat("\\";\\n").concat(",
        "      "    message.innerHTML = '").concat(message).concat("';\\n").concat(",
        "      "  }\\n").concat(",
        "      "})")",
        "  ",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "        javax.security.auth.callback.TextOutputCallback,",
        "        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback,",
        "        javax.security.auth.callback.ConfirmationCallback",
        "    )",
        "    if (callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "            new fr.TextOutputCallback(",
        "                fr.TextOutputCallback.INFORMATION,",
        "                anchor",
        "            ),",
        "            new fr.ScriptTextOutputCallback(script),",
        "            new fr.ConfirmationCallback(",
        "                fr.ConfirmationCallback.INFORMATION,",
        "                choices,",
        "                defaultChoice",
        "            )",
        "        ).build()",
        "    }",
        "    else {",
        "      outcome = choices[callbacks.get(2).getSelectedIndex()];",
        "      action = fr.Action.goTo(outcome).build();",
        "    }",
        "",
        "     /*",
        "      * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "      * ",
        "      * Example:",
        "      * 'xxxxx' produces '28535'",
        "      * 'xxx-xxx' produces '432-521'",
        "      */",
        "    function generateNumericToken(format) {",
        "        return format.replace(/[x]/g, function(c) {",
        "            var r = Math.random()*10|0;",
        "            var v = r;",
        "            return v.toString(10);",
        "        });",
        "    }",
        "}());",
        "",
        "/*",
        "Locale: en_US",
        "authInstant: 2021-09-25T17:28:38Z",
        "Organization: o=alpha,ou=services,ou=am-config",
        "mail: volker@scheuber.name",
        "Principals: volker@scheuber.name",
        "UserProfile: Ignore",
        "CharSet: UTF-8",
        "FullLoginURL: /am/UI/Login?code=4%2F0AX4XfWjiEfbrfIstsFUKoaibPCQmTbuPonLfuhpYhjfj-N5QEe9u2P5Os9wNadGaPsQVBA&scope=email+profile+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.email+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.profile+openid&realm=%2Falpha&state=fykprtfmeclrgwszmomvqxnlirrehcs&hd=scheuber.name&prompt=none&authuser=2",
        "clientType: genericHTML",
        "goto: /am/XUI/?realm=/alpha&authIndexType=service&authIndexValue=SessionInfo&ForceAuth=true#/",
        "AMCtxId: d3188938-d07e-4134-95db-f1cc97fc6c40-503275",
        "loginURL: /am/UI/Login",
        "sn: Scheuber",
        "amlbcookie: 01",
        "HostName: 99.72.28.182",
        "UserToken: volker@scheuber.name",
        "givenName: Volker",
        "successURL: /am/XUI/?realm=/alpha&authIndexType=service&authIndexValue=SessionInfo&ForceAuth=true#/",
        "Service: Router",
        "Host: 99.72.28.182",
        "AuthLevel: 0",
        "idp: google",
        "UserId: volker@scheuber.name",
        "sun.am.UniversalIdentifier: id=volker@scheuber.name,ou=user,o=alpha,ou=services,ou=am-config",
        "OidcSid: ACuTQIObj0tajPYhLOjMlWc2urM",
        "Principal: id=volker@scheuber.name,ou=user,o=alpha,ou=services,ou=am-config",
        " */",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Display-States.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "b703581a-e112-42b9-bc24-6db8bced5a13": {
      "_id": "b703581a-e112-42b9-bc24-6db8bced5a13",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Display sharedState and transientState.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Display States",
      "script": [
        "/* Display States",
        " * ",
        " * Display sharedState and transientState.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    outcome = "true";",
        "",
        "    var anchor = "anchor-".concat(generateNumericToken('xxx'));",
        "    var halign = "left";",
        "    var message = "<h4>Current State Values</h4>".concat(",
        "        "<p><b>Shared State</b>:<br/>").concat(",
        "        sharedState.toString()).concat("</p>").concat(",
        "        "<p><b>Transient State</b>:<br/>").concat(",
        "        transientState.toString()).concat("</p>").concat(",
        "        "<p><b>Request Headers</b>:<br/>").concat(",
        "        requestHeaders.toString()).concat("</p>")",
        "    var script = "Array.prototype.slice.call(\\n".concat(",
        "      "document.getElementsByClassName('callback-component')).forEach(\\n").concat(",
        "      "function (e) {\\n").concat(",
        "      "  var message = e.firstElementChild;\\n").concat(",
        "      "  if (message.firstChild && message.firstChild.nodeName == '#text' && message.firstChild.nodeValue.trim() == '").concat(anchor).concat("') {\\n").concat(",
        "      "    message.className = \\"\\";\\n").concat(",
        "      "    message.style = \\"text-align: left; inline-size: 430px; overflow-wrap: break-word;\\";\\n").concat(",
        "      "    message.align = \\"").concat(halign).concat("\\";\\n").concat(",
        "      "    message.innerHTML = '").concat(message).concat("';\\n").concat(",
        "      "  }\\n").concat(",
        "      "})")",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "        javax.security.auth.callback.TextOutputCallback,",
        "        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        "    )",
        "    if (message.length && callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "            new fr.TextOutputCallback(",
        "                fr.TextOutputCallback.INFORMATION,",
        "                anchor",
        "            ),",
        "            new fr.ScriptTextOutputCallback(script)",
        "        ).build()",
        "    }",
        "    else {",
        "      action = fr.Action.goTo(outcome).build();",
        "    }",
        "",
        "     /*",
        "      * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "      * ",
        "      * Example:",
        "      * 'xxxxx' produces '28535'",
        "      * 'xxx-xxx' produces '432-521'",
        "      */",
        "    function generateNumericToken(format) {",
        "        return format.replace(/[x]/g, function(c) {",
        "            var r = Math.random()*10|0;",
        "            var v = r;",
        "            return v.toString(10);",
        "        });",
        "    }",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Display-States-imported-(1).script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "e49225eb-e7ad-4699-bf2a-d57689f9cd6e": {
      "_id": "e49225eb-e7ad-4699-bf2a-d57689f9cd6e",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Display sharedState and transientState.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Display States - imported (1)",
      "script": [
        "/* Display States",
        " * ",
        " * Display sharedState and transientState.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    outcome = "true";",
        "",
        "    var anchor = "anchor-".concat(generateNumericToken('xxx'));",
        "    var halign = "left";",
        "    var message = "<h4>Current State Values</h4>".concat(",
        "        "<p><b>Shared State</b>:<br/>").concat(",
        "        sharedState.toString()).concat("</p>").concat(",
        "        "<p><b>Transient State</b>:<br/>").concat(",
        "        transientState.toString()).concat("</p>").concat(",
        "        "<p><b>Request Headers</b>:<br/>").concat(",
        "        requestHeaders.toString()).concat("</p>")",
        "    var script = "Array.prototype.slice.call(\\n".concat(",
        "      "document.getElementsByClassName('callback-component')).forEach(\\n").concat(",
        "      "function (e) {\\n").concat(",
        "      "  var message = e.firstElementChild;\\n").concat(",
        "      "  if (message.firstChild && message.firstChild.nodeName == '#text' && message.firstChild.nodeValue.trim() == '").concat(anchor).concat("') {\\n").concat(",
        "      "    message.className = \\"\\";\\n").concat(",
        "      "    message.style = \\"text-align: left; inline-size: 430px; overflow-wrap: break-word;\\";\\n").concat(",
        "      "    message.align = \\"").concat(halign).concat("\\";\\n").concat(",
        "      "    message.innerHTML = '").concat(message).concat("';\\n").concat(",
        "      "  }\\n").concat(",
        "      "})")",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "        javax.security.auth.callback.TextOutputCallback,",
        "        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        "    )",
        "    if (message.length && callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "            new fr.TextOutputCallback(",
        "                fr.TextOutputCallback.INFORMATION,",
        "                anchor",
        "            ),",
        "            new fr.ScriptTextOutputCallback(script)",
        "        ).build()",
        "    }",
        "    else {",
        "      action = fr.Action.goTo(outcome).build();",
        "    }",
        "",
        "     /*",
        "      * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "      * ",
        "      * Example:",
        "      * 'xxxxx' produces '28535'",
        "      * 'xxx-xxx' produces '432-521'",
        "      */",
        "    function generateNumericToken(format) {",
        "        return format.replace(/[x]/g, function(c) {",
        "            var r = Math.random()*10|0;",
        "            var v = r;",
        "            return v.toString(10);",
        "        });",
        "    }",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Display-States-imported-(2).script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "6d6c2202-725b-4196-9436-92ec11a0b385": {
      "_id": "6d6c2202-725b-4196-9436-92ec11a0b385",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Display sharedState and transientState.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Display States - imported (2)",
      "script": [
        "/* Display States",
        " * ",
        " * Display sharedState and transientState.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    outcome = "true";",
        "",
        "    var anchor = "anchor-".concat(generateNumericToken('xxx'));",
        "    var halign = "left";",
        "    var message = "<h4>Current State Values</h4>".concat(",
        "        "<p><b>Shared State</b>:<br/>").concat(",
        "        sharedState.toString()).concat("</p>").concat(",
        "        "<p><b>Transient State</b>:<br/>").concat(",
        "        transientState.toString()).concat("</p>")",
        "    var script = "Array.prototype.slice.call(\\n".concat(",
        "      "document.getElementsByClassName('callback-component')).forEach(\\n").concat(",
        "      "function (e) {\\n").concat(",
        "      "  var message = e.firstElementChild;\\n").concat(",
        "      "  if (message.firstChild && message.firstChild.nodeName == '#text' && message.firstChild.nodeValue.trim() == '").concat(anchor).concat("') {\\n").concat(",
        "      "    message.className = \\"\\";\\n").concat(",
        "      "    message.style = \\"text-align: left; inline-size: 430px; overflow-wrap: break-word;\\";\\n").concat(",
        "      "    message.align = \\"").concat(halign).concat("\\";\\n").concat(",
        "      "    message.innerHTML = '").concat(message).concat("';\\n").concat(",
        "      "  }\\n").concat(",
        "      "})")",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "        javax.security.auth.callback.TextOutputCallback,",
        "        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        "    )",
        "    if (message.length && callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "            new fr.TextOutputCallback(",
        "                fr.TextOutputCallback.INFORMATION,",
        "                anchor",
        "            ),",
        "            new fr.ScriptTextOutputCallback(script)",
        "        ).build()",
        "    }",
        "    else {",
        "      action = fr.Action.goTo(outcome).build();",
        "    }",
        "",
        "     /*",
        "      * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "      * ",
        "      * Example:",
        "      * 'xxxxx' produces '28535'",
        "      * 'xxx-xxx' produces '432-521'",
        "      */",
        "    function generateNumericToken(format) {",
        "        return format.replace(/[x]/g, function(c) {",
        "            var r = Math.random()*10|0;",
        "            var v = r;",
        "            return v.toString(10);",
        "        });",
        "    }",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Display-Username.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "fe5e303b-9ed7-4853-84fe-0ae43e2254d5": {
      "_id": "fe5e303b-9ed7-4853-84fe-0ae43e2254d5",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Display the username in an HTML dialog.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Display Username",
      "script": [
        "/* Display Username",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Display the username.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "(function () {",
        "  try {",
        "    var outcome = 'true';",
        "    var username = nodeState.get('username').asString();",
        "",
        "    // Specify the message you want to display. You may use HTML for formatting. Avoid line breaks! Use <br> instead.",
        "    var message = '<h5>'+username+'</h5>';",
        "",
        "    var anchor = 'anchor-'+generateNumericToken('xxx');",
        "    var script = "Array.prototype.slice.call(\\n \\",
        "      document.getElementsByClassName('callback-component')).forEach(\\n \\",
        "      function (e) {\\n \\",
        "        var message = e.firstElementChild;\\n \\",
        "        if (message.firstChild && message.firstChild.nodeName == '#text' && message.firstChild.nodeValue.trim() == '"+anchor+"') {\\n \\",
        "          message.innerHTML = '"+message+"';\\n \\",
        "        }\\n \\",
        "      })";",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "        javax.security.auth.callback.TextOutputCallback,",
        "        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        "    )",
        "    if (message.length && callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "            new fr.TextOutputCallback(",
        "                fr.TextOutputCallback.INFORMATION,",
        "                anchor",
        "            ),",
        "            new fr.ScriptTextOutputCallback(script)",
        "        ).build()",
        "    }",
        "    else {",
        "      action = fr.Action.goTo(outcome).build();",
        "    }",
        "  } catch (error) {",
        "    logger.error('Error: ' + error);",
        "    nodeState.putShared('error', error.message);",
        "  }",
        "",
        "   /*",
        "    * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "    * ",
        "    * Example:",
        "    * 'xxxxx' produces '28535'",
        "    * 'xxx-xxx' produces '432-521'",
        "    */",
        "  function generateNumericToken(format) {",
        "      return format.replace(/[x]/g, function(c) {",
        "          var r = Math.random()*10|0;",
        "          var v = r;",
        "          return v.toString(10);",
        "      });",
        "  }",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Dropdown.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "71b3c70b-920c-464b-a918-4c86eaaddccd": {
      "_id": "71b3c70b-920c-464b-a918-4c86eaaddccd",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Render a dropdown",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Dropdown",
      "script": [
        "/* Dropdown",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Render a dropdown selector",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "(function () {",
        "  outcome = "true";",
        "  var choices = [" ", "Red pill", "Blue pill", "Steak", "Rabbit hole"];",
        "  ",
        "  var fr = JavaImporter(",
        "    org.forgerock.openam.auth.node.api.Action,",
        "    javax.security.auth.callback.ChoiceCallback",
        "  )",
        "",
        "  if (callbacks.isEmpty()) {",
        "    action = fr.Action.send([",
        "      new fr.ChoiceCallback("Make your choice", choices, 0, false)",
        "    ]).build();",
        "  } else {",
        "    var choice = parseInt(callbacks.get(0).getSelectedIndexes()[0]);",
        "    nodeState.putShared("choice", choices[choice]);",
        "    action = fr.Action.goTo(outcome).build();",
        "  }",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./FRAAS-7955-Both-States.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "38f698de-fe11-43d2-8480-44e1312d121d": {
      "_id": "38f698de-fe11-43d2-8480-44e1312d121d",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "FRAAS-7955 Both States",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "FRAAS-7955 Both States",
      "script": [
        "outcome = "true";",
        "",
        "setSharedObjectAttribute("userName", "FRAAS-7955");",
        "setSharedObjectAttribute("givenName", "First-shared");",
        "setSharedObjectAttribute("sn", "Last-shared");",
        "setSharedObjectAttribute("mail", "first.last-shared@company.com");",
        "",
        "setTransientObjectAttribute("userName", "FRAAS-7955");",
        "setTransientObjectAttribute("givenName", "First-transient");",
        "setTransientObjectAttribute("sn", "Last-transient");",
        "setTransientObjectAttribute("mail", "first.last-transient@company.com");",
        "",
        "/*",
        " * Store attributes in shared state for use with the Create/Patch Object nodes.",
        " */",
        "function setSharedObjectAttribute(name, value) {",
        "       var storage = sharedState.get("objectAttributes");",
        "    if (storage && value) {",
        "          if (storage.put) {",
        "              storage.put(name, value);",
        "        }",
        "          else {",
        "              storage[name] = value;",
        "        }",
        "    }",
        "    else if (value) {",
        "        sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "    }",
        "}",
        "",
        "/*",
        " * Store attributes in transient state for use with the Create/Patch Object nodes.",
        " */",
        "function setTransientObjectAttribute(name, value) {",
        "    var transientStorage = transientState.get("objectAttributes");",
        "    if (transientStorage && value) {",
        "          if (transientStorage.put) {",
        "            transientStorage.put(name, value);",
        "        }",
        "          else {",
        "            transientStorage[name] = value;",
        "        }",
        "    }",
        "    else if (value) {",
        "    transientState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "    }",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./FRAAS-7955-Display-States.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "164fe425-01e7-4b0b-9f60-fb41f6bf362b": {
      "_id": "164fe425-01e7-4b0b-9f60-fb41f6bf362b",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "FRAAS-7955 Display sharedState and transientState.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "FRAAS-7955 Display States",
      "script": [
        "/* debug",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Display sharedState and transientState.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "var output = true;",
        "",
        "var anchor = "anchor-".concat(generateNumericToken('xxx'));",
        "var halign = "left";",
        "var message = "<h4>Current State Values</h4>".concat(",
        "    "<p><b>Shared State</b>:<br/>").concat(",
        "      sharedState.toString()).concat("</p>").concat(",
        "    "<p><b>Transient State</b>:<br/>").concat(",
        "      transientState.toString()).concat("</p>")",
        "var script = "Array.prototype.slice.call(\\n".concat(",
        "  "document.getElementsByClassName('callback-component')).forEach(\\n").concat(",
        "  "function (e) {\\n").concat(",
        "  "  var message = e.firstElementChild;\\n").concat(",
        "  "  if (message.firstChild && message.firstChild.nodeName == '#text' && message.firstChild.nodeValue.trim() == '").concat(anchor).concat("') {\\n").concat(",
        "  "    message.className = \\"\\";\\n").concat(",
        "  "    message.style = \\"text-align: left; inline-size: 430px; overflow-wrap: break-word;\\";\\n").concat(",
        "  "    message.align = \\"").concat(halign).concat("\\";\\n").concat(",
        "  "    message.innerHTML = '").concat(message).concat("';\\n").concat(",
        "  "  }\\n").concat(",
        "  "})")",
        "var fr = JavaImporter(",
        "    org.forgerock.openam.auth.node.api.Action,",
        "    javax.security.auth.callback.TextOutputCallback,",
        "    com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        ")",
        "if (message.length && callbacks.isEmpty()) {",
        "    action = fr.Action.send(",
        "        new fr.TextOutputCallback(",
        "            fr.TextOutputCallback.INFORMATION,",
        "            anchor",
        "        ),",
        "        new fr.ScriptTextOutputCallback(script)",
        "    ).build()",
        "}",
        "else {",
        "  action = fr.Action.goTo("true").build();",
        "}",
        "",
        " /*",
        "  * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "  * ",
        "  * Example:",
        "  * 'xxxxx' produces '28535'",
        "  * 'xxx-xxx' produces '432-521'",
        "  */",
        "function generateNumericToken(format) {",
        "    return format.replace(/[x]/g, function(c) {",
        "        var r = Math.random()*10|0;",
        "        var v = r;",
        "        return v.toString(10);",
        "    });",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./FRAAS-7955-Shared-State-Only.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "dedbc9f6-7fc9-4332-a330-55f7aeb95e78": {
      "_id": "dedbc9f6-7fc9-4332-a330-55f7aeb95e78",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "FRAAS-7955 Shared State Only",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "FRAAS-7955 Shared State Only",
      "script": [
        "outcome = "true";",
        "",
        "setSharedObjectAttribute("userName", "FRAAS-7955");",
        "setSharedObjectAttribute("givenName", "First-shared");",
        "setSharedObjectAttribute("sn", "Last-shared");",
        "setSharedObjectAttribute("mail", "first.last-shared@company.com");",
        "",
        "/*",
        " * Store attributes in shared state for use with the Create/Patch Object nodes.",
        " */",
        "function setSharedObjectAttribute(name, value) {",
        "       var storage = sharedState.get("objectAttributes");",
        "    if (storage && value) {",
        "          if (storage.put) {",
        "              storage.put(name, value);",
        "        }",
        "          else {",
        "              storage[name] = value;",
        "        }",
        "    }",
        "    else if (value) {",
        "        sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "    }",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./FRAAS-7955-Show-Object-Values.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "fbc563cb-eced-4e1b-9cd4-022680347668": {
      "_id": "fbc563cb-eced-4e1b-9cd4-022680347668",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "FRAAS-7955 Show Object Values",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "FRAAS-7955 Show Object Values",
      "script": [
        "var outcome = true;",
        "",
        "// Requires Identify Existing User auth node to retrieve real user ID from IDM",
        "var userid = sharedState.get("_id");",
        "",
        "// Retrieve user profile attributes",
        "var userName = idRepository.getAttribute(userid, "uid").iterator().next().toString();",
        "var firstName = idRepository.getAttribute(userid, "givenName").iterator().next().toString();",
        "var lastName = idRepository.getAttribute(userid, "sn").iterator().next().toString();",
        "var email = idRepository.getAttribute(userid, "mail").iterator().next().toString();",
        "",
        "var anchor = "anchor-".concat(generateNumericToken('xxx'));",
        "var halign = "left";",
        "var message = "<h4>Object Values</h4>".concat(",
        "    "<p><b>Username</b>: ").concat(userName).concat("</p>").concat(",
        "    "<p><b>First Name</b>: ").concat(firstName).concat("</p>").concat(",
        "    "<p><b>Last Name</b>: ").concat(lastName).concat("</p>").concat(",
        "    "<p><b>Email</b>: ").concat(email).concat("</p>")",
        "var script = "Array.prototype.slice.call(\\n".concat(",
        "  "document.getElementsByClassName('callback-component')).forEach(\\n").concat(",
        "  "function (e) {\\n").concat(",
        "  "  var message = e.firstElementChild;\\n").concat(",
        "  "  if (message.firstChild && message.firstChild.nodeName == '#text' && message.firstChild.nodeValue.trim() == '").concat(anchor).concat("') {\\n").concat(",
        "  "    message.className = \\"text-left\\";\\n").concat(",
        "  "    message.align = \\"").concat(halign).concat("\\";\\n").concat(",
        "  "    message.innerHTML = '").concat(message).concat("';\\n").concat(",
        "  "  }\\n").concat(",
        "  "})")",
        "var fr = JavaImporter(",
        "    org.forgerock.openam.auth.node.api.Action,",
        "    javax.security.auth.callback.TextOutputCallback,",
        "    com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        ")",
        "if (message.length && callbacks.isEmpty()) {",
        "    action = fr.Action.send(",
        "        new fr.TextOutputCallback(",
        "            fr.TextOutputCallback.INFORMATION,",
        "            anchor",
        "        ),",
        "        new fr.ScriptTextOutputCallback(script)",
        "    ).build()",
        "}",
        "else {",
        "  action = fr.Action.goTo(outcome).build();",
        "}",
        "",
        " /*",
        "  * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "  * ",
        "  * Example:",
        "  * 'xxxxx' produces '28535'",
        "  * 'xxx-xxx' produces '432-521'",
        "  */",
        "function generateNumericToken(format) {",
        "    return format.replace(/[x]/g, function(c) {",
        "        var r = Math.random()*10|0;",
        "        var v = r;",
        "        return v.toString(10);",
        "    });",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./FRAAS-7955-Transient-State-Only.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "073a64d4-37c9-486d-8c59-6583494644b9": {
      "_id": "073a64d4-37c9-486d-8c59-6583494644b9",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "FRAAS-7955 Transient State Only",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "FRAAS-7955 Transient State Only",
      "script": [
        "outcome = "true";",
        "",
        "setTransientObjectAttribute("userName", "FRAAS-7955");",
        "setTransientObjectAttribute("givenName", "First-transient");",
        "setTransientObjectAttribute("sn", "Last-transient");",
        "setTransientObjectAttribute("mail", "first.last-transient@company.com");",
        "",
        "/*",
        " * Store attributes in transient state for use with the Create/Patch Object nodes.",
        " */",
        "function setTransientObjectAttribute(name, value) {",
        "    var transientStorage = transientState.get("objectAttributes");",
        "    if (transientStorage && value) {",
        "          if (transientStorage.put) {",
        "            transientStorage.put(name, value);",
        "        }",
        "          else {",
        "            transientStorage[name] = value;",
        "        }",
        "    }",
        "    else if (value) {",
        "    transientState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "    }",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./FRAAS-7955-Workaround.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "e0ba741b-c952-4062-9899-0b1c19237ee4": {
      "_id": "e0ba741b-c952-4062-9899-0b1c19237ee4",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "FRAAS-7955 Workaround: Copy sharedState to transientState",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "FRAAS-7955 Workaround",
      "script": [
        "outcome = "true";",
        "var attrs = sharedState.get("objectAttributes");",
        "if (attrs) {",
        "      setTransientObjectAttribute("givenName", attrs.get("givenName").concat("-workaround"));",
        "      setTransientObjectAttribute("sn", attrs.get("sn").concat("-workaround"));",
        "      setTransientObjectAttribute("mail", attrs.get("mail").concat("-workaround"));",
        "}",
        "",
        "/*",
        " * Store attributes in transient state for use with the Create/Patch Object nodes.",
        " */",
        "function setTransientObjectAttribute(name, value) {",
        "    var transientStorage = transientState.get("objectAttributes");",
        "    if (transientStorage && value) {",
        "          if (transientStorage.put) {",
        "            transientStorage.put(name, value);",
        "        }",
        "          else {",
        "            transientStorage[name] = value;",
        "        }",
        "    }",
        "    else if (value) {",
        "    transientState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "    }",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Facebook-Profile-Normalization.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "bae1d54a-e97d-4997-aa5d-c027f21af82c": {
      "_id": "bae1d54a-e97d-4997-aa5d-c027f21af82c",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from Facebook",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Facebook Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "return json(object(",
        "        field("id", rawProfile.id),",
        "        field("displayName", rawProfile.name),",
        "        field("givenName", rawProfile.first_name),",
        "        field("familyName", rawProfile.last_name),",
        "        field("photoUrl", rawProfile.picture.data.url),",
        "        field("email", rawProfile.email),",
        "        field("username", rawProfile.email)))",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./ForgeRock-Internal:-OAuth2-Access-Token-Modification-Script.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "c234ba0b-58a1-4cfd-9567-09edde980745": {
      "_id": "c234ba0b-58a1-4cfd-9567-09edde980745",
      "context": "OAUTH2_ACCESS_TOKEN_MODIFICATION",
      "createdBy": "null",
      "creationDate": 1433147666269,
      "default": true,
      "description": "Internal token modification script",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "ForgeRock Internal: OAuth2 Access Token Modification Script",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "// Script is intentionally empty",
        "",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./ForgeRock-Internal:-OIDC-Claims-Script.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "1f389a3d-21cf-417c-a6d3-42ea620071f0": {
      "_id": "1f389a3d-21cf-417c-a6d3-42ea620071f0",
      "context": "OIDC_CLAIMS",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Internal OIDC Claims script",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "ForgeRock Internal: OIDC Claims Script",
      "script": [
        "/*",
        " * Copyright 2014-2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        " * This script computes claim values returned in ID tokens and/or at the UserInfo Endpoint.",
        " * The claim values are computed for:",
        " * the claims derived from the requested scopes,",
        " * the claims provided by the authorization server,",
        " * and the claims requested by the client via the claims parameter.",
        " *",
        " * In the CONFIGURATION AND CUSTOMIZATION section, you can",
        " * define the scope-to-claims mapping, and",
        " * assign to each claim a resolver function that will compute the claim value.",
        " *",
        " * Defined variables (class references are provided below):",
        " * scopes - Set<String> (6).",
        " *          Always present, the requested scopes.",
        " * claims - Map<String, Object> (5).",
        " *          Always present, default server provided claims.",
        " * claimObjects - List<Claim> (7, 2).",
        " *                Always present, the default server provided claims.",
        " * requestedClaims - Map<String, Set<String>> (5).",
        " *                   Always present, not empty if the request contains the claims parameter and the server has enabled",
        " *                   claims_parameter_supported. A map of the requested claims to possible values, otherwise empty;",
        " *                   requested claims with no requested values will have a key but no value in the map. A key with",
        " *                   a single value in its Set (6) indicates that this is the only value that should be returned.",
        " * requestedTypedClaims - List<Claim> (7, 2).",
        " *                        Always present, the requested claims.",
        " *                        Requested claims with no requested values will have a claim with no values.",
        " *                        A claim with a single value indicates this is the only value that should be returned.",
        " * claimsLocales - List<String> (7).",
        " *                 The values from the 'claims_locales' parameter.",
        " *                 See https://openid.net/specs/openid-connect-core-1_0.html#ClaimsLanguagesAndScripts for the OIDC specification details.",
        " * requestProperties - Unmodifiable Map (5).",
        " *                     Always present, contains a map of request properties:",
        " *                     requestUri - The request URI.",
        " *                     realm - The realm that the request relates to.",
        " *                     requestParams - A map of the request params and/or posted data.",
        " *                                     Each value is a list of one or more properties.",
        " *                                     Please note that these should be handled in accordance with OWASP best practices:",
        " *                                     https://owasp.org/www-community/vulnerabilities/Unsafe_use_of_Reflection.",
        " * clientProperties - Unmodifiable Map (5).",
        " *                    Present if the client specified in the request was identified, contains a map of client properties:",
        " *                    clientId - The client's URI for the request locale.",
        " *                    allowedGrantTypes - List of the allowed grant types (org.forgerock.oauth2.core.GrantType) for the client.",
        " *                    allowedResponseTypes - List of the allowed response types for the client.",
        " *                    allowedScopes - List of the allowed scopes for the client.",
        " *                    customProperties - A map of the custom properties of the client.",
        " *                                       Lists or maps will be included as sub-maps; for example:",
        " *                                       customMap[Key1]=Value1 will be returned as customMap -> Key1 -> Value1.",
        " *                                       To add custom properties to a client, update the Custom Properties field",
        " *                                       in AM Console > Realm Name > Applications > OAuth 2.0 > Clients > Client ID > Advanced.",
        " * identity - AMIdentity (3).",
        " *            Always present, the identity of the resource owner.",
        " * session - SSOToken (4).",
        " *           Present if the request contains the session cookie, the user's session object.",
        " * scriptName - String (primitive).",
        " *              Always present, the display name of the script.",
        " * logger - Always present, the "OAuth2Provider" debug logger instance:",
        " *          https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.",
        " *          Corresponding files will be prefixed with: scripts.OIDC_CLAIMS.",
        " * httpClient - HTTP Client (8).",
        " *              Always present, the HTTP Client instance:",
        " *              https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-http-client.html#scripting-api-global-http-client.",
        " *              In order to use the client, you may need to add",
        " *              org.forgerock.http.Client,",
        " *              org.forgerock.http.protocol.*,",
        " *              and org.forgerock.util.promise.PromiseImpl",
        " *              to the allowed Java classes in the scripting engine configuration, as described in:",
        " *              https://backstage.forgerock.com/docs/am/7/scripting-guide/script-engine-security.html",
        " *",
        " * Return - a new UserInfoClaims(Map<String, Object> values, Map<String, List<String>> compositeScopes) (1) object.",
        " *          The result of the last statement in the script is returned to the server.",
        " *          Currently, the Immediately Invoked Function Expression (also known as Self-Executing Anonymous Function)",
        " *          is the last (and only) statement in this script, and its return value will become the script result.",
        " *          Do not use "return variable" statement outside of a function definition.",
        " *          See RESULTS section for additional details.",
        " *",
        " * Class reference:",
        " * (1) UserInfoClaims - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html.",
        " * (2) Claim - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html).",
        " *         An instance of org.forgerock.openidconnect.Claim has methods to access",
        " *         the claim name, requested values, locale, and whether the claim is essential.",
        " * (3) AMIdentity - https://backstage.forgerock.com/docs/am/7/apidocs/com/sun/identity/idm/AMIdentity.html.",
        " * (4) SSOToken - https://backstage.forgerock.com/docs/am/7/apidocs/com/iplanet/sso/SSOToken.html.",
        " * (5) Map - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashMap.html,",
        " *           or https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/LinkedHashMap.html.",
        " * (6) Set - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashSet.html.",
        " * (7) List - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/ArrayList.html.",
        " * (8) Client - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/http/Client.html.",
        "*/",
        "",
        "(function () {",
        "    // SETUP",
        "",
        "    /**",
        "     * Claim processing utilities.",
        "     * An object that contains reusable functions for processing claims.",
        "     * @see CLAIM PROCESSING UTILITIES section for details.",
        "     */",
        "    var utils = getUtils();",
        "",
        "    // CONFIGURATION AND CUSTOMIZATION",
        "",
        "    /**",
        "     * OAuth 2.0 scope values (scopes) can be used by the Client to request OIDC claims.",
        "     *",
        "     * Call this configuration method, and pass in as the first argument",
        "     * an object that maps a scope value to an array of claim names",
        "     * to specify which claims need to be processed and returned for the requested scopes.",
        "     * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#ScopeClaims}",
        "     * for the scope values that could be used to request claims as defined in the OIDC specification.",
        "     *",
        "     * Below, find a default configuration that is expected to work in the current environment.",
        "     *",
        "     * CUSTOMIZATION",
        "     * You can choose the claim names returned for a scope.",
        "     */",
        "    utils.setScopeClaimsMap({",
        "        profile: [",
        "            'name',",
        "            'family_name',",
        "            'given_name',",
        "            'zoneinfo',",
        "            'locale'",
        "        ],",
        "        email: ['email'],",
        "        address: ['address'],",
        "        phone: ['phone_number']",
        "    });",
        "",
        "    /**",
        "     * In this script, each claim",
        "     * derived from the requested scopes,",
        "     * provided by the authorization server, and",
        "     * requested by the client via the claims parameter",
        "     * will be processed by a function associated with the claim name.",
        "     *",
        "     * Call this configuration method, and pass in as the first argument",
        "     * an object that maps a claim name to a resolver function,",
        "     * which will be automatically executed for each claim processed by the script.",
        "     *",
        "     * The claim resolver function will receive the requested claim information",
        "     * in an instance of org.forgerock.openidconnect.Claim as the first argument.",
        "     * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html}",
        "     * for details on the Claim class.",
        "     *",
        "     * If the claim resolver function returns a value,",
        "     * other than undefined or null,",
        "     * the claim will be included in the script's results.",
        "     *",
        "     * The Claim instance provides methods to check",
        "     * what the name of the claim is,",
        "     * which values the claim request contains,",
        "     * whether the claim is essential, and",
        "     * which locale the claim is associated with.",
        "     * The resolver function can consider this information when computing and returning the claim value.",
        "     *",
        "     * Below, find a default configuration that is expected to work in the current environment.",
        "     * A reusable function, utils.getUserProfileClaimResolver(String attribute-name),",
        "     * is called to return a claim resolver function based on a user profile attribute.",
        "     * @see CLAIM RESOLVERS section for the implementation details and examples.",
        "     * For the address claim, an example of a claim resolver that uses another claim resolver is provided.",
        "     *",
        "     * CUSTOMIZATION",
        "     * You can reuse the predefined utils methods with your custom arguments.",
        "     * You can also specify a custom resolver function for a claim name,",
        "     * that will compute and return the claim value—as shown in the commented out example below.",
        "     */",
        "    utils.setClaimResolvers({",
        "        /*",
        "        // An example of a simple claim resolver function that is defined for a claim",
        "        // directly in the configuration object:",
        "        custom-claim-name: function (requestedClaim) {",
        "            // In this case, initially, the claim value comes straight from a user profile attribute value:",
        "            var claimValue = identity.getAttribute('custom-attribute-name').toArray()[0]",
        "",
        "            // Optionally, provide additional logic for processing (filtering, formatting, etc.) the claim value.",
        "            // You can use:",
        "            // requestedClaim.getName()",
        "            // requestedClaim.getValues()",
        "            // requestedClaim.getLocale()",
        "            // requestedClaim.isEssential()",
        "",
        "            return claimValue",
        "        },",
        "        */",
        "        /**",
        "         * The use of utils.getUserProfileClaimResolver shows how",
        "         * an argument passed to a function that returns a claim resolver",
        "         * becomes available to the resolver function (via its lexical context).",
        "         */",
        "        name: utils.getUserProfileClaimResolver('cn'),",
        "        family_name: utils.getUserProfileClaimResolver('sn'),",
        "        given_name: utils.getUserProfileClaimResolver('givenname'),",
        "        zoneinfo: utils.getUserProfileClaimResolver('preferredtimezone'),",
        "        locale: utils.getUserProfileClaimResolver('preferredlocale'),",
        "        email: utils.getUserProfileClaimResolver('mail'),",
        "        address: utils.getAddressClaimResolver(",
        "            /**",
        "             * The passed in user profile claim resolver function",
        "             * can be used by the address claim resolver function",
        "             * to obtain the claim value to be formatted as per the OIDC specification:",
        "             * @see https://openid.net/specs/openid-connect-core-1_0.html#AddressClaim.",
        "             */",
        "            utils.getUserProfileClaimResolver('postaladdress')",
        "        ),",
        "        phone_number: utils.getUserProfileClaimResolver('telephonenumber')",
        "    });",
        "",
        "    // CLAIM PROCESSING UTILITIES",
        "",
        "    /**",
        "     * @returns {object} An object that contains reusable claim processing utilities.",
        "     * @see PUBLIC METHODS section and the return statement for the list of exported functions.",
        "     */",
        "    function getUtils () {",
        "        // IMPORT JAVA",
        "",
        "        /**",
        "         * Provides Java scripting functionality.",
        "         * @see {@link https://developer.mozilla.org/en-US/docs/Mozilla/Projects/Rhino/Scripting_Java#javaimporter_constructor}.",
        "         */",
        "        var frJava = JavaImporter(",
        "            org.forgerock.oauth2.core.exceptions.InvalidRequestException,",
        "            org.forgerock.oauth2.core.UserInfoClaims,",
        "            org.forgerock.openidconnect.Claim,",
        "",
        "            java.util.LinkedHashMap,",
        "            java.util.ArrayList",
        "        );",
        "",
        "        // SET UP CONFIGURATION",
        "",
        "        /**",
        "         * Placeholder for a configuration option that contains",
        "         * an object that maps the supported scope values (scopes)",
        "         * and the corresponding claim names for each scope value.",
        "         */",
        "        var scopeClaimsMap;",
        "",
        "        /**",
        "         * Placeholder for a configuration option that contains",
        "         * an object that maps the supported claim names",
        "         * and the resolver functions returning the claim value.",
        "         */",
        "        var claimResolvers;",
        "",
        "        /**",
        "         * A (public) method that accepts an object that maps the supported scopes and the corresponding claim names,",
        "         * and assigns it to a (private) variable that serves as a configuration option.",
        "         * @param {object} params - An object that maps each supported scope value to an array of claim names,",
        "         * in order to specify which claims need to be processed for the requested scopes.",
        "         * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#ScopeClaims} for details.",
        "         * @param {string[]} [params.profile] - An array of claim names to be returned if the profile scope is requested.",
        "         * @param {string[]} [params.email] - An array of claim names to be returned if the email scope is requested.",
        "         * @param {string[]} [params.address] - An array of claim names to be returned if the address scope is requested.",
        "         * @param {string[]} [params.phone] - An array of claim names to be returned if the phone scope is requested.",
        "         * @returns {undefined}",
        "         */",
        "        function setScopeClaimsMap(params) {",
        "            scopeClaimsMap = params;",
        "        }",
        "",
        "        /**",
        "         * A (public) method that accepts an object that maps the supported claim names",
        "         * and the resolver functions returning the claim value,",
        "         * and assigns it to a (private) variable that serves as a configuration option.",
        "         * @param {object} params - An object that maps",
        "         * each supported claim name to a function that computes and returns the claim value.",
        "         */",
        "        function setClaimResolvers(params) {",
        "            claimResolvers = params;",
        "        }",
        "",
        "        // CLAIM RESOLVERS",
        "",
        "        /**",
        "         * Claim resolvers are functions that return a claim value.",
        "         * @param {*}",
        "         * @returns {*}",
        "         */",
        "",
        "        /**",
        "         * Defines a claim resolver based on a user profile attribute.",
        "         * @param {string} attributeName - Name of the user profile attribute.",
        "         * @returns {function} A function that will determine the claim value",
        "         * based on the user profile attribute and the (requested) claim properties.",
        "         */",
        "        function getUserProfileClaimResolver (attributeName) {",
        "            /**",
        "             * Resolves a claim with a user profile attribute value.",
        "             * Returns undefined if the identity attribute is not populated,",
        "             * OR if the claim has requested values that do not contain the identity attribute value.",
        "             * ATTENTION: the aforementioned comparison is case-sensitive.",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {string|HashSet|undefined}",
        "             */",
        "            function resolveClaim(claim) {",
        "                var userProfileValue;",
        "",
        "                if (identity) {",
        "                    userProfileValue = getClaimValueFromSet(claim, identity.getAttribute(attributeName));",
        "",
        "                    if (userProfileValue && !userProfileValue.isEmpty()) {",
        "                        if (!claim.getValues() || claim.getValues().isEmpty() || claim.getValues().contains(userProfileValue)) {",
        "                            return userProfileValue;",
        "                        }",
        "                    }",
        "                }",
        "            }",
        "",
        "            return resolveClaim;",
        "        }",
        "",
        "        /**",
        "         * Returns an address claim resolver based on a claim value obtained with another claim resolver.",
        "         * @param {function} resolveClaim - A function that returns a claim value.",
        "         * @returns {function} A function that will accept a claim as an argument,",
        "         * run the claim resolver function for the claim and obtain the claim value,",
        "         * and apply additional formatting to the value before returning it.",
        "         */",
        "        function getAddressClaimResolver (resolveClaim) {",
        "            /**",
        "             * Creates an address claim object from a value returned by a claim resolver,",
        "             * and returns the address claim object as the claim value.",
        "             * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#AddressClaim}.",
        "             * The claim value is obtained with a claim resolving function available from the closure.",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {java.util.LinkedHashMap|undefined} The address claim object created from a claim value.",
        "             */",
        "            function resolveAddressClaim(claim) {",
        "                var claimValue = resolveClaim(claim);",
        "                var addressObject;",
        "",
        "                if (isClaimValueValid(claimValue)) {",
        "                    addressObject = new frJava.LinkedHashMap();",
        "",
        "                    addressObject.put('formatted', claimValue);",
        "",
        "                    return addressObject;",
        "                }",
        "            }",
        "",
        "            return resolveAddressClaim;",
        "        }",
        "",
        "        /**",
        "         * Returns an essential claim resolver based on a claim value obtained with another claim resolver.",
        "         * @param {function} resolveClaim - A function that returns a claim value.",
        "         * @returns {function} A function that will accept a claim as an argument,",
        "         * run the claim resolver function for the claim and obtain the claim value,",
        "         * and apply additional logic for essential claims.",
        "         */",
        "        function getEssentialClaimResolver (resolveClaim) {",
        "            /**",
        "             * Returns a claim value or throws an error.",
        "             * The claim value is obtained with a claim resolving function available from the closure.",
        "             * Throws an exception if the claim is essential and no value is returned for the claim.",
        "             *",
        "             * Use of this resolver is optional.",
        "             * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#IndividualClaimsRequests} stating:",
        "             * "Note that even if the Claims are not available because the End-User did not authorize their release or they are not present,",
        "             * the Authorization Server MUST NOT generate an error when Claims are not returned, whether they are Essential or Voluntary,",
        "             * unless otherwise specified in the description of the specific claim."",
        "             *",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {*}",
        "             * @throws {org.forgerock.oauth2.core.exceptions.InvalidRequestException}",
        "             */",
        "            function resolveEssentialClaim(claim) {",
        "                var claimValue = resolveClaim(claim);",
        "",
        "                if (claim.isEssential() && !isClaimValueValid(claimValue)) {",
        "                    throw new frJava.InvalidRequestException('Could not provide value for essential claim: ' + claim.getName());",
        "                }",
        "",
        "                return claimValue;",
        "            }",
        "",
        "            return resolveEssentialClaim;",
        "        }",
        "",
        "        /**",
        "         * Provides default resolution for a claim.",
        "         * Use it if a claim-specific resolver is not defined in the configuration.",
        "         * @param {org.forgerock.openidconnect.Claim} claim",
        "         * An object that provides methods to obtain information/requirements associated with a claim.",
        "         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "         * @returns {*} A single value associated with this claim.",
        "         */",
        "        function resolveAnyClaim (claim) {",
        "            if (claim.getValues().size() === 1) {",
        "                return claim.getValues().toArray()[0];",
        "            }",
        "        }",
        "",
        "        // UTILITIES",
        "",
        "        /**",
        "         * Returns claim value from a set.",
        "         * If the set contains a single value, returns the value.",
        "         * If the set contains multiple values, returns the set.",
        "         * Otherwise, returns undefined.",
        "         *",
        "         * @param {org.forgerock.openidconnect.Claim} claim",
        "         * An object that provides methods to obtain information/requirements associated with a claim.",
        "         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "         * @param {java.util.HashSet} set The set—for example, a user profile attribute value.",
        "         * @returns {string|java.util.HashSet|undefined}",
        "         */",
        "        function getClaimValueFromSet (claim, set) {",
        "            if (set && set.size()) {",
        "                if (set.size() === 1) {",
        "                    return set.toArray()[0];",
        "                } else {",
        "                    return set;",
        "                }",
        "            } else if (logger.warningEnabled()) {",
        "                logger.warning('OIDC Claims script. Got an empty set for claim: ' + claim.getName());",
        "            }",
        "        }",
        "",
        "        function isClaimValueValid (claimValue) {",
        "            if (typeof claimValue === 'undefined' || claimValue === null) {",
        "                return false;",
        "            }",
        "",
        "            return true;",
        "        }",
        "",
        "        // CLAIM PROCESSING",
        "",
        "        /**",
        "         * Constructs and returns an object populated with the computed claim values",
        "         * and the requested scopes mapped to the claim names.",
        "         * @returns {org.forgerock.oauth2.core.UserInfoClaims} The object to be returned to the authorization server.",
        "         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html}.",
        "         * @see RESULTS section for the use of this function.",
        "         */",
        "        function getUserInfoClaims () {",
        "            return new frJava.UserInfoClaims(getComputedClaims(), getCompositeScopes());",
        "        }",
        "",
        "        /**",
        "         * Creates a map of (requested) claim names populated with the computed claim values.",
        "         * @returns {java.util.LinkedHashMap}",
        "         * A map of the requested claim names and the corresponding claim values.",
        "         */",
        "        function getComputedClaims () {",
        "            /**",
        "             * Creates a complete list of claim objects from:",
        "             * the claims derived from the scopes,",
        "             * the claims provided by the authorization server,",
        "             * and the claims requested by the client.",
        "             * @returns {java.util.ArrayList}",
        "             * Returns a complete list of org.forgerock.openidconnect.Claim objects available to the script.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for the claim object details.",
        "             */",
        "            function getClaims() {",
        "                /**",
        "                 * Returns a list of claim objects for the requested scopes.",
        "                 * Uses the scopeClaimsMap configuration option to derive the claim names;",
        "                 * no other properties of a claim derived from a scope are populated.",
        "                 * @returns {java.util.ArrayList}",
        "                 * A list of org.forgerock.openidconnect.Claim objects derived from the requested scopes.",
        "                 * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for the claim object details.",
        "                 */",
        "                function convertScopeToClaims() {",
        "                    var claims = new frJava.ArrayList();",
        "",
        "                    scopes.toArray().forEach(function (scope) {",
        "                        if (String(scope) !== 'openid' && scopeClaimsMap[scope]) {",
        "                            scopeClaimsMap[scope].forEach(function (claimName) {",
        "                                claims.add(new frJava.Claim(claimName));",
        "                            });",
        "                        }",
        "                    });",
        "",
        "                    return claims;",
        "                }",
        "",
        "                var claims = new frJava.ArrayList();",
        "",
        "                claims.addAll(convertScopeToClaims());",
        "                claims.addAll(claimObjects);",
        "                claims.addAll(requestedTypedClaims);",
        "",
        "                return claims;",
        "            }",
        "",
        "            /**",
        "             * Computes and returns a claim value.",
        "             * To obtain the claim value, uses the resolver function specified for the claim in the claimResolvers configuration object.",
        "             * @see claimResolvers",
        "             * If no resolver function is found, uses the default claim resolver function.",
        "             *",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {*} Claim value.",
        "             * @throws {org.forgerock.oauth2.core.exceptions.InvalidRequestException}",
        "             * Rethrows this exception if a claim resolver throws it.",
        "             * You can throw org.forgerock.oauth2.core.exceptions.InvalidRequestException from your custom claim resolver",
        "             * if you want to terminate the claim processing.",
        "             */",
        "            function computeClaim(claim) {",
        "                var resolveClaim;",
        "                var message;",
        "",
        "                try {",
        "                    resolveClaim = claimResolvers[claim.getName()] || resolveAnyClaim;",
        "",
        "                    return resolveClaim(claim);",
        "                } catch (e) {",
        "                    message = 'OIDC Claims script exception. Unable to resolve OIDC Claim. ' + e;",
        "",
        "                    if (String(e).indexOf('org.forgerock.oauth2.core.exceptions.InvalidRequestException') !== -1) {",
        "                        throw e;",
        "                    }",
        "",
        "                    if (logger.warningEnabled()) {",
        "                        logger.warning(message);",
        "                    }",
        "                }",
        "            }",
        "",
        "            var computedClaims = new frJava.LinkedHashMap();",
        "",
        "            getClaims().toArray().forEach(function (claim) {",
        "                var claimValue = computeClaim(claim);",
        "",
        "                if (isClaimValueValid(claimValue)) {",
        "                    computedClaims.put(claim.getName(), claimValue);",
        "                } else {",
        "                    /**",
        "                     * If a claim has been processed, but appears in the list again,",
        "                     * and its value cannot be computed under the new conditions,",
        "                     * the claim is removed from the final result.",
        "                     *",
        "                     * For example, a claim could be mapped to a scope and found in the user profile,",
        "                     * but also requested by the client with required values that don't match the computed one.",
        "                     * @see {link https://openid.net/specs/openid-connect-core-1_0.html#IndividualClaimsRequests}.",
        "                     * for the relevant OIDC specification details.",
        "                     */",
        "                    computedClaims.remove(claim.getName());",
        "                }",
        "            });",
        "",
        "            return computedClaims;",
        "        }",
        "",
        "        /**",
        "         * Creates a map of requested scopes and the corresponding claim names.",
        "         * @returns {java.util.LinkedHashMap}",
        "         */",
        "        function getCompositeScopes () {",
        "            var compositeScopes = new frJava.LinkedHashMap();",
        "",
        "            scopes.toArray().forEach(function (scope) {",
        "                var scopeClaims = new frJava.ArrayList();",
        "",
        "                if (scopeClaimsMap[scope]) {",
        "                    scopeClaimsMap[scope].forEach(function (claimName) {",
        "                        scopeClaims.add(claimName);",
        "                    });",
        "                }",
        "",
        "                if (scopeClaims.size()) {",
        "                    compositeScopes.put(scope, scopeClaims);",
        "                }",
        "            });",
        "",
        "            return compositeScopes;",
        "        }",
        "",
        "        // PUBLIC METHODS",
        "",
        "        return {",
        "            setScopeClaimsMap: setScopeClaimsMap,",
        "            setClaimResolvers: setClaimResolvers,",
        "            getUserProfileClaimResolver: getUserProfileClaimResolver,",
        "            getAddressClaimResolver: getAddressClaimResolver,",
        "            getEssentialClaimResolver: getEssentialClaimResolver,",
        "            getUserInfoClaims: getUserInfoClaims",
        "        };",
        "    }",
        "",
        "    // RESULTS",
        "",
        "    /**",
        "     * This script returns an instance of the org.forgerock.oauth2.core.UserInfoClaims class",
        "     * populated with the computed claim values and",
        "     * the requested scopes mapped to the claim names.",
        "     * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html}.",
        "     *",
        "     * Assigning it to a variable gives you an opportunity",
        "     * to log the content of the returned value during development.",
        "     */",
        "    var userInfoClaims = utils.getUserInfoClaims();",
        "",
        "    /*",
        "    logger.error(scriptName + ' results:')",
        "    logger.error('Values: ' + userInfoClaims.getValues())",
        "    logger.error('Scopes: ' + userInfoClaims.getCompositeScopes())",
        "    */",
        "",
        "    return userInfoClaims;",
        "}());",
        "",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./ForgeRockVpnOnly.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "779bb956-676d-4e44-b828-b9efa3c866d4": {
      "_id": "779bb956-676d-4e44-b828-b9efa3c866d4",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "ForgeRockVpnOnly",
      "script": [
        "/*",
        "  - Data made available by nodes that have already executed are available in the sharedState variable.",
        "  - The script should set outcome to either "true" or "false".",
        " */",
        "",
        "var validIpAddresses = [",
        "  "37.71.148.92", // FR Grenoble",
        "  "84.214.156.50", // FR Oslo",
        "  "180.255.64.26", // FR Singapore",
        "  "128.106.105.136", // FR Singapore Sales",
        "  "188.39.235.130", // FR Bristol",
        "  "78.33.22.162", // FR Bristol Marsh Street",
        "  "65.113.98.10", // FR San Francisco",
        "  "24.155.146.18" // FR Austin",
        "];",
        "",
        "try {",
        "  outcome = function() {",
        "    logger.message(requestHeaders);",
        "    var vpnBypassSecret = systemEnv.getProperty('esv.amadmin.vpn.bypass.secret', '') + '';",
        "    var bypassHeader = requestHeaders.get(new java.lang.String('x-forgerock-tests-bearer'));",
        "    logger.message("checking for VPN bypass - header {} to match secret {}", bypassHeader, vpnBypassSecret);",
        "    if (vpnBypassSecret && bypassHeader && bypassHeader.size() === 1) {",
        "      logger.message("bypass header is present");",
        "      if (bypassHeader.get(0) + '' === vpnBypassSecret + '') {",
        "        logger.warning("bypassing VPN check - request from tests authorized");",
        "        return 'True';",
        "      }",
        "    }",
        "    var clientIpAddresses = requestHeaders.get(new java.lang.String('x-forwarded-for'));",
        "    logger.message(clientIpAddresses);",
        "    if (!clientIpAddresses) {",
        "      logger.message("No forwarded header - internal cluster request");",
        "      return 'True';",
        "    }",
        "    for (var i = 0; i < clientIpAddresses.size(); i++) {",
        "      var clientIpHeader = clientIpAddresses.get(i);",
        "      var ipAddresses = clientIpHeader.split(',');",
        "      for (var j = 0; j < ipAddresses.length; j++) {",
        "        var clientIp = ipAddresses[j].trim();",
        "        logger.message('Checking client IP ' + clientIp);",
        "        for (var k = 0; k < validIpAddresses.length; k++) {",
        "          if (clientIp + '' === validIpAddresses[k]) {",
        "            logger.warning("request from ForgeRock VPN authorized");",
        "            return 'True';",
        "          }",
        "        }",
        "      }",
        "    }",
        "    logger.warning("request from outside the cluster and not from ForgeRock VPN rejected");",
        "    return 'False';",
        "  }();",
        "",
        "} catch (e) {",
        "",
        "  logger.error('ForgeRockVpnOnly failed to check IP');",
        "  logger.error(e);",
        "  outcome = 'Error';",
        "",
        "}",
        "",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Get-Email.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "d6469639-249f-4df1-9e03-335cd3e37b3d": {
      "_id": "d6469639-249f-4df1-9e03-335cd3e37b3d",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Get Email",
      "script": [
        "logger.error("Get Email: start");",
        "outcome = "true";",
        "if (getProfileAttribute("mail")) {",
        "  setSharedObjectAttribute("mail", getProfileAttribute("mail"));",
        "}",
        "logger.error("Get Email: end");",
        "",
        "/*",
        " * Get profile attribute",
        " */",
        "function getProfileAttribute(name) {",
        "    return idRepository.getAttribute(sharedState.get("_id"), name).iterator().next();",
        "}",
        "",
        "/*",
        " * Properly set attributes in shared state for use with the Create/Patch Object nodes.",
        " */",
        "function setSharedObjectAttribute(name, value) {",
        "    if (sharedState.get("objectAttributes")) {",
        "        sharedState.get("objectAttributes").put(name, value);",
        "    }",
        "    else {",
        "        sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":"+value+"}"));",
        "    }",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Get-Lockout-Status.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "cdea92a1-d2bf-4364-a525-fde8b7a95792": {
      "_id": "cdea92a1-d2bf-4364-a525-fde8b7a95792",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Get Lockout Status",
      "script": [
        "outcome = "true";",
        "",
        "var username = sharedState.get("_id")",
        "var lockoutDataAttr = "sunAMAuthInvalidAttemptsData"",
        "var accountStatusAttr = "inetUserStatus"",
        "",
        "var lockoutData = idRepository.getAttribute(username, lockoutDataAttr)",
        "var accountStatus = idRepository.getAttribute(username, accountStatusAttr)",
        "",
        "transientState.put("lockoutData", lockoutData)",
        "transientState.put("accountStatus", accountStatus)",
        "",
        "logger.error(lockoutData.toString())",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./GitHub-Profile-Normalization.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "a7a78773-445b-4eca-bb93-409e86bced81": {
      "_id": "a7a78773-445b-4eca-bb93-409e86bced81",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from GitHub",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "GitHub Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2022 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "return json(object(",
        "        field("id", rawProfile.id),",
        "        field("displayName", rawProfile.name),",
        "        field("username", rawProfile.login)))",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./GitHub-Profile-Normalization-(VS).script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "23143919-6b78-40c3-b25e-beca19b229e0": {
      "_id": "23143919-6b78-40c3-b25e-beca19b229e0",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Normalizes raw profile data from GitHub",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "GitHub Profile Normalization (VS)",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "logger.warning("GitHub rawProfile: "+rawProfile)",
        "",
        "return json(object(",
        "        field("id", rawProfile.id),",
        "        field("displayName", rawProfile.name),",
        "        field("givenName", rawProfile.first_name),",
        "        field("familyName", rawProfile.last_name),",
        "        field("photoUrl", rawProfile.picture.data.url),",
        "        field("email", rawProfile.email),",
        "        field("username", rawProfile.email)))",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Google-Profile-Normalization.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "58d29080-4563-480b-89bb-1e7719776a21": {
      "_id": "58d29080-4563-480b-89bb-1e7719776a21",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from Google",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Google Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "return json(object(",
        "        field("id", rawProfile.sub),",
        "        field("displayName", rawProfile.name),",
        "        field("givenName", rawProfile.given_name),",
        "        field("familyName", rawProfile.family_name),",
        "        field("photoUrl", rawProfile.picture),",
        "        field("email", rawProfile.email),",
        "        field("username", rawProfile.email),",
        "        field("locale", rawProfile.locale)))",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Goto-Specified-Decision.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "2a076e9e-75a9-46b5-b971-10ffafbdf652": {
      "_id": "2a076e9e-75a9-46b5-b971-10ffafbdf652",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Return true if a goto param has been specified, false otherwise.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Goto Specified Decision",
      "script": [
        "/* Goto Specified Decision",
        " * ",
        " * Return true if a goto param has been specified, false otherwise.",
        " * ",
        " * This script does not require configuration. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * - false",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    logger.message("Goto Specified Decision: start");",
        "      outcome = "false";",
        "      var referer = parseUrl(requestHeaders.get("referer").get(0));",
        "      if (referer.searchParam.goto) {",
        "          outcome = "true";",
        "    }",
        "    logger.message("Goto Specified Decision: end [outcome={}]", outcome);",
        "",
        "    /*",
        "     * Parse a URL into its components and make them easily accessible by name",
        "     *",
        "     * Use in a Scripte Decision Node Script as follows:",
        "     * var referer = parseUrl(requestHeaders.get("referer").get(0));",
        "     * var origin = referer.origin;",
        "     * ",
        "     * e.g.: https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/",
        "     * {",
        "     *     hash: '#/',",
        "     *     host: 'openam-volker-dev.forgeblocks.com',",
        "     *     hostname: 'openam-volker-dev.forgeblocks.com',",
        "     *     href: 'https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/',",
        "     *     origin: 'https://openam-volker-dev.forgeblocks.com',",
        "     *     pathname: '/am/XUI/',",
        "     *     port: '',",
        "     *     protocol: 'https',",
        "     *     search: '?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim',",
        "     *     username: '',",
        "     *     password: '',",
        "     *     searchParam: {",
        "     *         realm: '/bravo',",
        "     *         authIndexType: 'service',",
        "     *         authIndexValue: 'InitiateOwnerClaim'",
        "     *     }",
        "     * }",
        "     */",
        "    function parseUrl(href) {",
        "        var m = href.match(/^(([^:\\/?#]+):?(?:\\/\\/((?:([^\\/?#:]*):([^\\/?#:]*)@)?([^\\/?#:]*)(?::([^\\/?#:]*))?)))?([^?#]*)(\\?[^#]*)?(#.*)?$/),",
        "        r = {",
        "            hash: m[10] || "",                      // #/",
        "            host: m[3] || "",                       // openam-volker-dev.forgeblocks.com",
        "            hostname: m[6] || "",                   // openam-volker-dev.forgeblocks.com",
        "            href: m[0] || "",                       // https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/",
        "            origin: m[1] || "",                     // https://openam-volker-dev.forgeblocks.com",
        "            pathname: m[8] || (m[1] ? "/" : ""),    // /am/XUI/",
        "            port: m[7] || "",                       // ",
        "            protocol: m[2] || "",                   // https",
        "            search: m[9] || "",                     // ?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim",
        "            username: m[4] || "",                   // ",
        "            password: m[5] || "",                   // ",
        "            searchParam: {}                         // { realm: '/bravo',",
        "                                                    //   authIndexType: 'service',",
        "                                                    //   authIndexValue: 'InitiateOwnerClaim' }",
        "        };",
        "        if (r.protocol.length == 2) {",
        "            r.protocol = "file:///" + r.protocol.toUpperCase();",
        "            r.origin = r.protocol + "//" + r.host;",
        "        }",
        "        if (r.search.length > 2) {",
        "            var query = (r.search.indexOf('?') === 0) ? r.search.substr(1) : r.search;",
        "            var vars = query.split('&');",
        "            for (var i = 0; i < vars.length; i++) {",
        "            var pair = vars[i].split('=');",
        "            r.searchParam[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1]);",
        "            }",
        "        }",
        "        r.href = r.origin + r.pathname + r.search + r.hash;",
        "        return r;",
        "    };",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./HIBP-Password-Breach-Analysis.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "790045fa-a325-4e3e-96f8-d4a91b32e9de": {
      "_id": "790045fa-a325-4e3e-96f8-d4a91b32e9de",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Use Have I Been Pwned Password to check if password has been breached.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "HIBP Password Breach Analysis",
      "script": [
        "/* HIBP Password Breach Analysis",
        " *",
        " * Authors: jon.knight@forgerock.com, volker.scheuber@forgerock.com",
        " * ",
        " * Use Have I Been Pwned Password to check if password has been breached.",
        " * Calls HIBP API to retrieve the count of matching passwords in breached ",
        " * password database",
        " * ",
        " * This script needs to be parametrized. It will not work properly as is. ",
        " * It requires the Password or Platform Password collector nodes before",
        " * it can operate.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - clear",
        " *   The number of breaches for password was either zero or less than the ",
        " *   value of THRESHOLD",
        " * - breached ",
        " *   The number of incidents of the password in the breached password ",
        " *   database exceeds THRESHOLD",
        " * - failed",
        " *   The API call was rejected.",
        " */",
        "(function () {",
        "    var USER_AGENT="ForgeRock";",
        "    var HIBP_API_KEY=systemEnv.getProperty("esv.hibp.api.key");",
        "    var THRESHOLD=0;",
        "",
        "    function toHexString(byteArray) {",
        "        var s = '';",
        "        byteArray.forEach(function(byte) {",
        "            s += ('0' + (byte & 0xFF).toString(16)).slice(-2);",
        "        });",
        "        return s;",
        "    }",
        "",
        "    outcome = "failed";",
        "",
        "    var md = java.security.MessageDigest.getInstance('SHA-1');",
        "      var password = nodeState.get("password").asString();",
        "//      var password = new java.lang.String("");",
        "//      if (nodeState.get("password")) {",
        "//      password = nodeState.get("password").asString();",
        "//    }",
        "    var byteArray = password.getBytes("UTF-8");",
        "    md.update(byteArray);",
        "    var digest = md.digest();",
        "    var hex = String(toHexString(digest)).toUpperCase();",
        "",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setMethod('GET');",
        "    request.setUri('https://api.pwnedpasswords.com/range/' + hex.substring(0,5));",
        "    request.getHeaders().add("Accept","*/*");",
        "    request.getHeaders().add("Content-Type","application/json");",
        "    request.getHeaders().add("User-Agent", USER_AGENT);",
        "    request.getHeaders().add("hibp-api-key", HIBP_API_KEY);",
        "",
        "    var response = httpClient.send(request).get();",
        "",
        "    if (response.getStatus().getCode() === 200) {",
        "        var max = 0;",
        "        outcome = "clear";",
        "        var result = response.getEntity().getString();",
        "        var lines = result.split('\\n');",
        "        for (i=0; i<lines.length; i++) {",
        "            var prefix = lines[i].split(':')[0];",
        "            if (String(hex.substring(0,5) + prefix) == hex) {",
        "                var count = lines[i].split(':')[1];",
        "                if (count > max) max = count;",
        "            }",
        "        }",
        "        if (max > THRESHOLD) outcome = "breached";",
        "        sharedState.put("hibp_password_count", max);",
        "    }",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Has-Profile-Changed.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "2ada53cd-5d37-4592-9c7f-5711271229c2": {
      "_id": "2ada53cd-5d37-4592-9c7f-5711271229c2",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Has Profile Changed",
      "script": [
        "logger.error("Has Profile Changed: start");",
        "outcome = "unchanged";",
        "if (getObjectAttribute("old_givenName") ||",
        "    getObjectAttribute("old_sn") ||",
        "    getObjectAttribute("frUnindexedString5") ||",
        "    getObjectAttribute("old_telephoneNumber")) {",
        "  outcome = "changed";",
        "}",
        "logger.error("Has Profile Changed: end [outcome=".concat(outcome).concat("]"));",
        "",
        "/*",
        " * Get objectAttribute value",
        " */",
        "function getObjectAttribute(name) {",
        "    if (sharedState.get("objectAttributes") && sharedState.get("objectAttributes").get(name)) {",
        "        return sharedState.get("objectAttributes").get(name).toString();",
        "    }",
        "    else {",
        "        return null;",
        "    }",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./IDP-Integrity-Check.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "988c10fa-98da-4bf7-8ac9-a558d2fef1fd": {
      "_id": "988c10fa-98da-4bf7-8ac9-a558d2fef1fd",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Protection from malicious IDPs. Only allow white-listed email domains (usernames are email addresses).",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "IDP Integrity Check",
      "script": [
        "/* IDP Integrity Check",
        " * ",
        " * Protection from malicious IDPs. Only allow white-listed email domains (usernames are email addresses).",
        " * ",
        " * This script does not require cofiguration. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * - false",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    outcome = "false";",
        "      var routedIDP = sharedState.get("routedIDPs").get(0);",
        "      var validDomains = [];",
        "      if (routedIDP) {",
        "          validDomains = routedIDP.get("idpDomains");",
        "    }",
        "      ",
        "      var username = sharedState.get("username");",
        "      var domain = username.substr(username.lastIndexOf("@")+1);",
        "      if (validDomains.indexOf(domain) > -1) {",
        "          outcome = "true";",
        "    }",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./IDP-Lookup.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "68d5a8e7-fcc9-4215-9e63-a01afe8fa849": {
      "_id": "68d5a8e7-fcc9-4215-9e63-a01afe8fa849",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Perform IDP lookup based on email domain. Set users' external IDP in shared state or continue to local authentication.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "IDP Lookup",
      "script": [
        "/* IDP Lookup",
        " * ",
        " * Perform IDP lookup based on email domain. Set users' external IDP in shared state or continue to local authentication.",
        " * ",
        " * This script requires parametrization. Make sure you carefully review the configuration parameters.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - one",
        " * - multiple",
        " * - none",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    logger.message("IDP Lookup: start");",
        "      outcome = "none";",
        "      var username = sharedState.get("username");",
        "      var domain = username.substr(username.lastIndexOf("@")+1);",
        "      var referer = parseUrl(requestHeaders.get("referer").get(0));",
        "",
        "      /* Begin Configuration */",
        "  ",
        "    // long-lived token",
        "    var IDM_API_TOKEN = systemEnv.getProperty("esv.admin.token");",
        "  ",
        "    // IDM API Configuration",
        "    var IDM_API_URI = referer.origin + "/openidm/managed/alpha_organization?_queryFilter=idpDomains+co+'" + domain + "'&_fields=name,description,idpName,idpType,idpDomains,idpJourney,idpTheme,idpPersist,samlConfig";",
        "",
        "      /* End Configuration */",
        "",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setMethod('GET');",
        "    request.setUri(IDM_API_URI);",
        "    request.getHeaders().add("Content-Type", "application/json; charset=UTF-8");",
        "    request.getHeaders().add("Authorization", "Bearer " + IDM_API_TOKEN);",
        "",
        "    var response = httpClient.send(request).get();",
        "    var result = JSON.parse(response.getEntity().getString());",
        "    logger.message("IDP Lookup: JSON result: " + JSON.stringify(result));",
        "    ",
        "      var routedIDPs = result.result.length ? result.result : [{}];",
        "      // stringify the samlConfig property",
        "      routedIDPs.forEach(function (routedIDP, index) {",
        "          routedIDPs[index].samlConfig = JSON.stringify(routedIDP.samlConfig);",
        "    });",
        "      sharedState.put("routedIDPs", routedIDPs);",
        "    if (result.resultCount === 1) {",
        "        logger.message("IDP Lookup: Found exactly 1 IDP");",
        "        outcome = "one";",
        "    }",
        "      else if (result.resultCount > 1) {",
        "        logger.message("IDP Lookup: Found {} IDPs", result.resultCount);",
        "        outcome = "multiple";",
        "    }",
        "      else {",
        "        logger.message("IDP Lookup: Found no IDPs");",
        "    }",
        "    logger.message("IDP Lookup: end [outcome={}]", outcome);",
        "",
        "    /*",
        "     * Parse a URL into its components and make them easily accessible by name",
        "     *",
        "     * Use in a Scripte Decision Node Script as follows:",
        "     * var referer = parseUrl(requestHeaders.get("referer").get(0));",
        "     * var origin = referer.origin;",
        "     * ",
        "     * e.g.: https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/",
        "     * {",
        "     *     hash: '#/',",
        "     *     host: 'openam-volker-dev.forgeblocks.com',",
        "     *     hostname: 'openam-volker-dev.forgeblocks.com',",
        "     *     href: 'https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/',",
        "     *     origin: 'https://openam-volker-dev.forgeblocks.com',",
        "     *     pathname: '/am/XUI/',",
        "     *     port: '',",
        "     *     protocol: 'https',",
        "     *     search: '?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim',",
        "     *     username: '',",
        "     *     password: '',",
        "     *     searchParam: {",
        "     *         realm: '/bravo',",
        "     *         authIndexType: 'service',",
        "     *         authIndexValue: 'InitiateOwnerClaim'",
        "     *     }",
        "     * }",
        "     */",
        "    function parseUrl(href) {",
        "        var m = href.match(/^(([^:\\/?#]+):?(?:\\/\\/((?:([^\\/?#:]*):([^\\/?#:]*)@)?([^\\/?#:]*)(?::([^\\/?#:]*))?)))?([^?#]*)(\\?[^#]*)?(#.*)?$/),",
        "        r = {",
        "            hash: m[10] || "",                      // #/",
        "            host: m[3] || "",                       // openam-volker-dev.forgeblocks.com",
        "            hostname: m[6] || "",                   // openam-volker-dev.forgeblocks.com",
        "            href: m[0] || "",                       // https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/",
        "            origin: m[1] || "",                     // https://openam-volker-dev.forgeblocks.com",
        "            pathname: m[8] || (m[1] ? "/" : ""),    // /am/XUI/",
        "            port: m[7] || "",                       // ",
        "            protocol: m[2] || "",                   // https",
        "            search: m[9] || "",                     // ?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim",
        "            username: m[4] || "",                   // ",
        "            password: m[5] || "",                   // ",
        "            searchParam: {}                         // { realm: '/bravo',",
        "                                                    //   authIndexType: 'service',",
        "                                                    //   authIndexValue: 'InitiateOwnerClaim' }",
        "        };",
        "        if (r.protocol.length == 2) {",
        "            r.protocol = "file:///" + r.protocol.toUpperCase();",
        "            r.origin = r.protocol + "//" + r.host;",
        "        }",
        "        if (r.search.length > 2) {",
        "            var query = (r.search.indexOf('?') === 0) ? r.search.substr(1) : r.search;",
        "            var vars = query.split('&');",
        "            for (var i = 0; i < vars.length; i++) {",
        "            var pair = vars[i].split('=');",
        "            r.searchParam[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1]);",
        "            }",
        "        }",
        "        r.href = r.origin + r.pathname + r.search + r.hash;",
        "        return r;",
        "    };",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./IDP-Re-Lookup.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "ab917dad-6fdb-46c2-8c8c-42f094ebeea1": {
      "_id": "ab917dad-6fdb-46c2-8c8c-42f094ebeea1",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Perform IDP re-lookup based on the Organization ID from the initial lookup. Set users' external IDP in shared state for further processing.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "IDP Re-Lookup",
      "script": [
        "/* IDP Re-Lookup",
        " * ",
        " * Perform IDP re-lookup based on the Organization ID from the initial lookup. ",
        " * Set users' external IDP in shared state for further processing.",
        " * ",
        " * This script requires parametrization. Make sure you carefully review the configuration parameters.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * - false",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    logger.message("IDP Re-Lookup: start");",
        "      outcome = "false";",
        "      var referer = parseUrl(requestHeaders.get("referer").get(0));",
        "      var orgId = referer.searchParam.o;",
        "      sharedState.put("username", referer.searchParam.u);",
        "",
        "      /* Begin Configuration */",
        "  ",
        "    // long-lived token, expires: Friday, January 16, 2032 9:45:14 PM GMT-06:00",
        "    var IDM_API_TOKEN = "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJlMWE1YzU5OC04MGUyLTRhZGMtYjM0NS0zMWQwMmUyOThjNGIiLCJjdHMiOiJPQVVUSDJfR1JBTlRfU0VUIiwiYXV0aF9sZXZlbCI6MCwiYXVkaXRUcmFja2luZ0lkIjoiNGYzMDkxYTktZjU0Ni00MDdiLTkzNjMtM2RiZGJiZjYzMDc0LTM1NzcwOSIsInN1Ym5hbWUiOiJlMWE1YzU5OC04MGUyLTRhZGMtYjM0NS0zMWQwMmUyOThjNGIiLCJpc3MiOiJodHRwczovL29wZW5hbS12b2xrZXItZGV2LmZvcmdlYmxvY2tzLmNvbTo0NDMvYW0vb2F1dGgyL2FscGhhIiwidG9rZW5OYW1lIjoiYWNjZXNzX3Rva2VuIiwidG9rZW5fdHlwZSI6IkJlYXJlciIsImF1dGhHcmFudElkIjoiLUIxQlRUM3FqNi04Zkd3a2d6bzgzNzlSRjVJLjA4NkNJdTFyOUNCNlROcEIwV3Q5OFEyNTJYcyIsImF1ZCI6IjY5ZDA1YzExLWU4ZmUtNGFlNS1hN2M5LTIyNTJhNGQ4NWRmNCIsIm5iZiI6MTY0MjU2MzkxNCwiZ3JhbnRfdHlwZSI6InBhc3N3b3JkIiwic2NvcGUiOlsiZnI6aWRtOioiXSwiYXV0aF90aW1lIjoxNjQyNTYzOTE0LCJyZWFsbSI6Ii9hbHBoYSIsImV4cCI6MTk1NzkyMzkxNCwiaWF0IjoxNjQyNTYzOTE0LCJleHBpcmVzX2luIjozMTUzNjAwMDAsImp0aSI6Ii1CMUJUVDNxajYtOGZHd2tnem84Mzc5UkY1SS5CSHFZNVp3c0lGNVpMbEtvcGNvUlVGVHNLUjAiLCJtYXlfYWN0Ijp7ImNsaWVudF9pZCI6WyI2OWQwNWMxMS1lOGZlLTRhZTUtYTdjOS0yMjUyYTRkODVkZjQiXX19.f2NmwHVtekH93jO7-jM6mkFRcuvEN3WzcKsH-RAPnlc";",
        "",
        "    // IDM API Configuration",
        "    var IDM_API_URI = referer.origin + "/openidm/managed/alpha_organization/"+ orgId + "?_fields=name,description,idpName,idpType,idpDomains,idpJourney,idpTheme,idpPersist";",
        "",
        "      /* End Configuration */",
        "",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setMethod('GET');",
        "    request.setUri(IDM_API_URI);",
        "    request.getHeaders().add("Content-Type", "application/json; charset=UTF-8");",
        "    request.getHeaders().add("Authorization", "Bearer " + IDM_API_TOKEN);",
        "",
        "    var response = httpClient.send(request).get();",
        "    var result = JSON.parse(response.getEntity().getString());",
        "    logger.message("IDP Re-Lookup: JSON result: " + JSON.stringify(result));",
        "    ",
        "      if (result) {",
        "          outcome = "true";",
        "        var routedIDPs = [result];",
        "        sharedState.put("routedIDPs", routedIDPs);",
        "        logger.message("IDP Re-Lookup: Found IDP");",
        "    }",
        "    logger.message("IDP Re-Lookup: end [outcome={}]", outcome);",
        "",
        "    /*",
        "     * Parse a URL into its components and make them easily accessible by name",
        "     *",
        "     * Use in a Scripte Decision Node Script as follows:",
        "     * var referer = parseUrl(requestHeaders.get("referer").get(0));",
        "     * var origin = referer.origin;",
        "     * ",
        "     * e.g.: https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/",
        "     * {",
        "     *     hash: '#/',",
        "     *     host: 'openam-volker-dev.forgeblocks.com',",
        "     *     hostname: 'openam-volker-dev.forgeblocks.com',",
        "     *     href: 'https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/',",
        "     *     origin: 'https://openam-volker-dev.forgeblocks.com',",
        "     *     pathname: '/am/XUI/',",
        "     *     port: '',",
        "     *     protocol: 'https',",
        "     *     search: '?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim',",
        "     *     username: '',",
        "     *     password: '',",
        "     *     searchParam: {",
        "     *         realm: '/bravo',",
        "     *         authIndexType: 'service',",
        "     *         authIndexValue: 'InitiateOwnerClaim'",
        "     *     }",
        "     * }",
        "     */",
        "    function parseUrl(href) {",
        "        var m = href.match(/^(([^:\\/?#]+):?(?:\\/\\/((?:([^\\/?#:]*):([^\\/?#:]*)@)?([^\\/?#:]*)(?::([^\\/?#:]*))?)))?([^?#]*)(\\?[^#]*)?(#.*)?$/),",
        "        r = {",
        "            hash: m[10] || "",                      // #/",
        "            host: m[3] || "",                       // openam-volker-dev.forgeblocks.com",
        "            hostname: m[6] || "",                   // openam-volker-dev.forgeblocks.com",
        "            href: m[0] || "",                       // https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/",
        "            origin: m[1] || "",                     // https://openam-volker-dev.forgeblocks.com",
        "            pathname: m[8] || (m[1] ? "/" : ""),    // /am/XUI/",
        "            port: m[7] || "",                       // ",
        "            protocol: m[2] || "",                   // https",
        "            search: m[9] || "",                     // ?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim",
        "            username: m[4] || "",                   // ",
        "            password: m[5] || "",                   // ",
        "            searchParam: {}                         // { realm: '/bravo',",
        "                                                    //   authIndexType: 'service',",
        "                                                    //   authIndexValue: 'InitiateOwnerClaim' }",
        "        };",
        "        if (r.protocol.length == 2) {",
        "            r.protocol = "file:///" + r.protocol.toUpperCase();",
        "            r.origin = r.protocol + "//" + r.host;",
        "        }",
        "        if (r.search.length > 2) {",
        "            var query = (r.search.indexOf('?') === 0) ? r.search.substr(1) : r.search;",
        "            var vars = query.split('&');",
        "            for (var i = 0; i < vars.length; i++) {",
        "            var pair = vars[i].split('=');",
        "            r.searchParam[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1]);",
        "            }",
        "        }",
        "        r.href = r.origin + r.pathname + r.search + r.hash;",
        "        return r;",
        "    };",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./IDP-Router.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "aef262d0-7a42-4a34-9826-e7dbc2ea6eb9": {
      "_id": "aef262d0-7a42-4a34-9826-e7dbc2ea6eb9",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Route users to their organization's IDP of type saml, oidc, local, or custom and apply the organization's theme, if specified",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "IDP Router",
      "script": [
        "/* IDP Router",
        " * ",
        " * Route users to their organization's IDP of type saml, oidc, local, ",
        " * or custom and apply the organization's theme, if specified.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - saml",
        " * - oidc",
        " * - local",
        " * - custom",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "      logger.message("IDP Router: Start");",
        "    outcome = "local";",
        "      var referer = parseUrl(requestHeaders.get("referer").get(0));",
        "      var routedIDP = sharedState.get("routedIDPs").get(0);",
        "      if (routedIDP) {",
        "        outcome = routedIDP.get("idpType");",
        "        logger.message("IDP Router: Routed IDP: " + routedIDP);",
        "          sharedState.put("selectedIdp", routedIDP.get("idpName"));",
        "        var nodeConfig = {};",
        "          // load samlConfig",
        "          if (routedIDP.get("samlConfig")) {",
        "              nodeConfig = JSON.parse(routedIDP.get("samlConfig"));",
        "        }",
        "          // route to a custom journey",
        "        if (routedIDP.get("idpJourney")) {",
        "            logger.message("IDP Router: Route to custom IDP {}, journey: {}", routedIDP.get("idpName"), routedIDP.get("idpJourney"));",
        "              nodeConfig.tree = routedIDP.get("idpJourney");",
        "              outcome = "custom";",
        "        }",
        "          sharedState.put("nodeConfig", nodeConfig);",
        "          // only send callback if the org/idp requires a custom theme",
        "        if (routedIDP.get("idpTheme") && callbacks.isEmpty()) {",
        "            var stage = "themeId="+routedIDP.get("idpTheme");",
        "            var fr = JavaImporter(",
        "                org.forgerock.openam.auth.node.api.Action,",
        "                org.forgerock.openam.authentication.callbacks.PollingWaitCallback",
        "            )",
        "              action = fr.Action.send(",
        "                  new fr.PollingWaitCallback("0", "Please wait ...")",
        "            ).withStage(stage).build();",
        "          }",
        "    }",
        "      logger.message("IDP Router: Done [outcome={}]", outcome);",
        "",
        "    /*",
        "     * Parse a URL into its components and make them easily accessible by name",
        "     *",
        "     * Use in a Scripte Decision Node Script as follows:",
        "     * var referer = parseUrl(requestHeaders.get("referer").get(0));",
        "     * var origin = referer.origin;",
        "     * ",
        "     * e.g.: https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/",
        "     * {",
        "     *     hash: '#/',",
        "     *     host: 'openam-volker-dev.forgeblocks.com',",
        "     *     hostname: 'openam-volker-dev.forgeblocks.com',",
        "     *     href: 'https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/',",
        "     *     origin: 'https://openam-volker-dev.forgeblocks.com',",
        "     *     pathname: '/am/XUI/',",
        "     *     port: '',",
        "     *     protocol: 'https',",
        "     *     search: '?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim',",
        "     *     username: '',",
        "     *     password: '',",
        "     *     searchParam: {",
        "     *         realm: '/bravo',",
        "     *         authIndexType: 'service',",
        "     *         authIndexValue: 'InitiateOwnerClaim'",
        "     *     }",
        "     * }",
        "     */",
        "    function parseUrl(href) {",
        "        var m = href.match(/^(([^:\\/?#]+):?(?:\\/\\/((?:([^\\/?#:]*):([^\\/?#:]*)@)?([^\\/?#:]*)(?::([^\\/?#:]*))?)))?([^?#]*)(\\?[^#]*)?(#.*)?$/),",
        "        r = {",
        "            hash: m[10] || "",                      // #/",
        "            host: m[3] || "",                       // openam-volker-dev.forgeblocks.com",
        "            hostname: m[6] || "",                   // openam-volker-dev.forgeblocks.com",
        "            href: m[0] || "",                       // https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/",
        "            origin: m[1] || "",                     // https://openam-volker-dev.forgeblocks.com",
        "            pathname: m[8] || (m[1] ? "/" : ""),    // /am/XUI/",
        "            port: m[7] || "",                       // ",
        "            protocol: m[2] || "",                   // https",
        "            search: m[9] || "",                     // ?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim",
        "            username: m[4] || "",                   // ",
        "            password: m[5] || "",                   // ",
        "            searchParam: {}                         // { realm: '/bravo',",
        "                                                    //   authIndexType: 'service',",
        "                                                    //   authIndexValue: 'InitiateOwnerClaim' }",
        "        };",
        "        if (r.protocol.length == 2) {",
        "            r.protocol = "file:///" + r.protocol.toUpperCase();",
        "            r.origin = r.protocol + "//" + r.host;",
        "        }",
        "        if (r.search.length > 2) {",
        "            var query = (r.search.indexOf('?') === 0) ? r.search.substr(1) : r.search;",
        "            var vars = query.split('&');",
        "            for (var i = 0; i < vars.length; i++) {",
        "            var pair = vars[i].split('=');",
        "            r.searchParam[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1]);",
        "            }",
        "        }",
        "        r.href = r.origin + r.pathname + r.search + r.hash;",
        "        return r;",
        "    };",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./IPv4-CIDR-Rules-Engine.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "7fb962a5-9f20-41d3-a077-b424a29c1198": {
      "_id": "7fb962a5-9f20-41d3-a077-b424a29c1198",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Evaluate IPv4 CIDR access rules from "esv-ipv4-cidr-access-rules".",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "IPv4 CIDR Rules Engine",
      "script": [
        "/* IPv4 CIDR Rules Engine",
        " *",
        " * Author: volker.scheuber@forgerock.com, justin.chin@forgerock.com",
        " * ",
        " * Evaluate IPv4 CIDR access rules from "esv-ipv4-cidr-access-rules". ",
        " * Access rules must have the following format:",
        " * {",
        " *   "allow": [",
        " *     "140.118.0.0/16",",
        " *     "110.35.0.0/16",",
        " *     "131.26.0.0/16",",
        " *     "92.61.21.153/32"",
        " *   ]",
        " * }",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - allow",
        " * - deny",
        " */",
        "(function () {",
        "  outcome = "deny";",
        "  ",
        "  var rules = JSON.parse(systemEnv.getProperty("esv.ipv4.cidr.access.rules"));",
        "  var allow = rules['allow'];",
        "",
        "  /*",
        "   * Returns the value of the requested header",
        "   */",
        "  function getHeader(headerName) {",
        "    return requestHeaders.get(headerName).get(0);",
        "  }",
        "",
        "  /*",
        "   * Returns the client's IP address",
        "   */",
        "  function getClientIPAddress() {",
        "    return getHeader("x-forwarded-for").split(',')[0];",
        "  }",
        "",
        "  function IPnumber(IPaddress) {",
        "    var ip = IPaddress.match(/^(\\d+)\\.(\\d+)\\.(\\d+)\\.(\\d+)$/);",
        "    if (ip) {",
        "      return (+ip[1] << 24) + (+ip[2] << 16) + (+ip[3] << 8) + +ip[4];",
        "    }",
        "    // else ... ?",
        "    return null;",
        "  }",
        "",
        "  function IPmask(maskSize) {",
        "    return -1 << (32 - maskSize);",
        "  }",
        "",
        "  function isAllowed(ip) {",
        "    var allowed = false;",
        "    allow.forEach((cidr) => {",
        "      if (",
        "        (IPnumber(ip) & IPmask(cidr.split('/')[1])) ==",
        "        IPnumber(cidr.split('/')[0])",
        "      ) {",
        "        allowed = true;",
        "      }",
        "    });",
        "    return allowed;",
        "  }",
        "  ",
        "  if (isAllowed(getClientIPAddress())) {",
        "    outcome = "allow";",
        "  }",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Impersonate:-Extract-Actors-And-Become-Impersonator.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "d6f3befb-c73a-437e-b02a-66d9b4c93f8b": {
      "_id": "d6f3befb-c73a-437e-b02a-66d9b4c93f8b",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Extract impersonatee and impersonator from headers and become impersonator.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Impersonate: Extract Actors And Become Impersonator",
      "script": [
        "/* Impersonate: Extract Actors And Become Impersonator",
        " *",
        " * Extract impersonatee and impersonator from headers and become impersonatee.",
        " *",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * - false",
        " */",
        "",
        "(function () {",
        "    logger.warning("Impersonate: Extract Actors: start");",
        "    outcome = "false";",
        "",
        "    /*",
        "     * BEGIN SCRIPT CONFIGURATION",
        "     */",
        "    var IMPERSONATEE_HEADER_NAME = "X-Impersonatee";",
        "    var IMPERSONATOR_HEADER_NAME = "X-Impersonator";",
        "    /*",
        "     * END SCRIPT CONFIGURATION",
        "     */",
        "",
        "    var impersonatee = getHeader(IMPERSONATEE_HEADER_NAME);",
        "    var impersonator = getHeader(IMPERSONATOR_HEADER_NAME);",
        "    if (impersonatee && impersonator) {",
        "        outcome = "true";",
        "        sharedState.put("impersonatee", impersonatee);",
        "        sharedState.put("impersonator", impersonator);",
        "        sharedState.put("username", impersonator);",
        "        setSharedObjectAttribute("userName", impersonator);",
        "    }",
        "",
        "    logger.warning("Impersonate: Extract Actors: finish [outcome=".concat(outcome).concat("]"));",
        "",
        "    /*",
        "     * Returns the value of the requested header",
        "     */",
        "    function getHeader(headerName) {",
        "        if (requestHeaders.get(headerName) && requestHeaders.get(headerName).get(0)) {",
        "            return requestHeaders.get(headerName).get(0).toString();",
        "        }",
        "        return null;",
        "    }",
        "",
        "    /*",
        "     * Store attributes in shared state for use with the Create/Patch Object nodes.",
        "     */",
        "    function setSharedObjectAttribute(name, value) {",
        "         var storage = sharedState.get("objectAttributes");",
        "        if (storage && value) {",
        "            if (storage.put) {",
        "                  storage.put(name, value);",
        "            }",
        "            else {",
        "                storage[name] = value;",
        "            }",
        "        }",
        "        else if (value) {",
        "            sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "        }",
        "    }",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Impersonate:-Switch-Actors-And-Become-Impersonatee.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "878816b3-2bb4-4b43-8001-10f926ddefff": {
      "_id": "878816b3-2bb4-4b43-8001-10f926ddefff",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Switch Actors And Become Impersonatee.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Impersonate: Switch Actors And Become Impersonatee",
      "script": [
        "/* Impersonate: Switch Actors And Become Impersonatee",
        " *",
        " * Switch Actors And Become Impersonatee.",
        " *",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * - false",
        " */",
        "",
        "(function () {",
        "    logger.warning("Impersonate: Switch Actors: start");",
        "    outcome = "false";",
        "",
        "    var impersonatee = sharedState.get("impersonatee");",
        "    var impersonator = sharedState.get("impersonator");",
        "    if (impersonatee && impersonator) {",
        "        outcome = "true";",
        "        sharedState.put("username", impersonatee);",
        "        setSharedObjectAttribute("userName", impersonatee);",
        "    }",
        "",
        "    logger.warning("Impersonate: Switch Actors: finish [outcome=".concat(outcome).concat("]"));",
        "  ",
        "    /*",
        "     * Store attributes in shared state for use with the Create/Patch Object nodes.",
        "     */",
        "    function setSharedObjectAttribute(name, value) {",
        "         var storage = sharedState.get("objectAttributes");",
        "        if (storage && value) {",
        "            if (storage.put) {",
        "                  storage.put(name, value);",
        "            }",
        "            else {",
        "                storage[name] = value;",
        "            }",
        "        }",
        "        else if (value) {",
        "            sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "        }",
        "    }",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Impersonate:-Update-Session-Properties.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "7dd80834-e7b2-4737-85a7-40434bb19dde": {
      "_id": "7dd80834-e7b2-4737-85a7-40434bb19dde",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Store the impersontor and impersonatee profile information in session properties.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Impersonate: Update Session Properties",
      "script": [
        "/* Impersonate: Update Session Properties",
        " * ",
        " * Store the impersontor and impersonatee profile information in session properties.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: jake.feasel@forgerock.com, volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "      logger.message("Impersonate: Update Session Properties: start");",
        "      outcome = "true";",
        "  ",
        "    var goTo = org.forgerock.openam.auth.node.api.Action.goTo;",
        "    myGoto = goTo(outcome);",
        "    myGoto.putSessionProperty("userName", sharedState.get("username"));",
        "    myGoto.putSessionProperty("impersonator", sharedState.get("impersonator"));",
        "",
        "      logger.message("Impersonate: Update Session Properties: done [outcome={}]", outcome);",
        "    action = myGoto.build();",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Instagram-Profile-Normalization.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "1244e639-4a31-401d-ab61-d75133d8dc9e": {
      "_id": "1244e639-4a31-401d-ab61-d75133d8dc9e",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from Instagram",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Instagram Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "return json(object(",
        "        field("id", rawProfile.id),",
        "        field("username", rawProfile.username)))",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Itsme-Profile-Normalization.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "3d97c436-42c0-4dd0-a571-ea6f34f752b3": {
      "_id": "3d97c436-42c0-4dd0-a571-ea6f34f752b3",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from Itsme",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Itsme Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2020-2021 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "import org.forgerock.json.JsonValue",
        "",
        "JsonValue managedUser = json(object(",
        "        field("id", rawProfile.sub),",
        "        field("displayName", rawProfile.name),",
        "        field("givenName", rawProfile.given_name),",
        "        field("familyName", rawProfile.family_name),",
        "        field("username", rawProfile.email),",
        "        field("email", rawProfile.email)))",
        "return managedUser",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./KerberosLogin:-Extract-Username.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "355a8b7c-9e3c-40c1-a873-68127e483adf": {
      "_id": "355a8b7c-9e3c-40c1-a873-68127e483adf",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Extract Username from request.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "KerberosLogin: Extract Username",
      "script": [
        "/* KerberosLogin: Extract Username",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * - false",
        " */",
        "",
        "logger.warning("KerberosLogin: Extract Username: start");",
        "outcome = "false";",
        "",
        "/*",
        " * BEGIN SCRIPT CONFIGURATION",
        " */",
        "var USERNAME_HEADER_NAME = "X-OpenAM-Username";",
        "/*",
        " * END SCRIPT CONFIGURATION",
        " */",
        "",
        "var username = getHeader(USERNAME_HEADER_NAME);",
        "if (username) {",
        "    ",
        "      outcome = "true";",
        "    sharedState.put("username", username);",
        "    setSharedObjectAttribute("userName", username);",
        "}",
        "",
        "logger.warning("KerberosLogin: Extract Username: finish [outcome=".concat(outcome).concat("]"));",
        "",
        "/*",
        " * Returns the value of the requested header",
        " */",
        "function getHeader(headerName) {",
        "      if (requestHeaders.get(headerName) && requestHeaders.get(headerName).get(0)) {",
        "        return requestHeaders.get(headerName).get(0).toString();",
        "    }",
        "      return null;",
        "}",
        "",
        "/*",
        " * Store attributes in shared state for use with the Create/Patch Object nodes.",
        " */",
        "function setSharedObjectAttribute(name, value) {",
        "       var storage = sharedState.get("objectAttributes");",
        "    if (storage && value) {",
        "          if (storage.put) {",
        "              storage.put(name, value);",
        "        }",
        "          else {",
        "              storage[name] = value;",
        "        }",
        "    }",
        "    else if (value) {",
        "        sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "    }",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./LinkedIn-Profile-Normalization.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "8862ca8f-7770-4af5-a888-ac0df0947f36": {
      "_id": "8862ca8f-7770-4af5-a888-ac0df0947f36",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from LinkedIn",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "LinkedIn Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "return json(object(",
        "        field("id", rawProfile.id),",
        "        field("givenName", rawProfile.firstName.localized.get(0)),",
        "        field("familyName", rawProfile.lastName.localized.get(0)),",
        "        field("photoUrl", rawProfile.profilePicture.displayImage),",
        "        field("email", rawProfile.elements.get(0).get("handle~").emailAddress),",
        "        field("username", rawProfile.elements.get(0).get("handle~").emailAddress)))",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./MFA-Status.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "ac9fc25e-3ad9-4f80-a796-2d9093795439": {
      "_id": "ac9fc25e-3ad9-4f80-a796-2d9093795439",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Check if MFA has already been performed for this journey. This allows journeys and inner journeys not to perform MFA multiple times.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "MFA Status",
      "script": [
        "/* MFA Status",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Check if MFA has already been performed for this journey. ",
        " * This allows journeys and inner journeys not to perform MFA multiple times.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * - false",
        " */",
        "outcome = "false";",
        "if (sharedState.get("mfaPerformed")=="true") {",
        "      outcome = "true";",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Microsoft-Profile-Normalization.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "73cecbfc-dad0-4395-be6a-6858ee3a80e5": {
      "_id": "73cecbfc-dad0-4395-be6a-6858ee3a80e5",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from Microsoft",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Microsoft Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        "{",
        "    "@odata.context": "https://graph.microsoft.com/v1.0/$metadata#users/$entity",",
        "    "@odata.id": "https://graph.microsoft.com/v2/711ffa9c-5972-4713-ace3-688c9732614a/directoryObjects/7d7759e2-36d8-4e64-b173-3f890d7d46d6/Microsoft.DirectoryServices.User",",
        "    "businessPhones": [",
        "        "18014735451"",
        "    ],",
        "    "displayName": "Volker Scheuber",",
        "    "givenName": "Volker",",
        "    "jobTitle": null,",
        "    "mail": "vscheuber@vscheuber.onmicrosoft.com",",
        "    "mobilePhone": null,",
        "    "officeLocation": null,",
        "    "preferredLanguage": null,",
        "    "surname": "Scheuber",",
        "    "userPrincipalName": "vscheuber@vscheuber.onmicrosoft.com",",
        "    "id": "7d7759e2-36d8-4e64-b173-3f890d7d46d6"",
        "}",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "logger.message("Kauai Microsoft Profile Normalization: rawProfile={}", rawProfile)",
        "",
        "return json(object(",
        "        field("id", rawProfile.id),",
        "        field("displayName", rawProfile.displayName),",
        "        field("givenName", rawProfile.givenName),",
        "        field("familyName", rawProfile.surname),",
        "        field("email", rawProfile.userPrincipalName),",
        "        field("username", rawProfile.userPrincipalName),",
        "        field("groups", rawProfile.groups)))",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./MobileOTP:-Extract-Username-Password-OTP.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "57807349-630f-496a-bccb-ea1011b8e945": {
      "_id": "57807349-630f-496a-bccb-ea1011b8e945",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Extract username, password, and OTP from request headers and put them in shared state for validation.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "MobileOTP: Extract Username, Password, OTP",
      "script": [
        "logger.warning("MobileOTP: Extract Username, Password, OTP: start");",
        "",
        "/*",
        " * BEGIN SCRIPT CONFIGURATION",
        " */",
        "var USERNAME_HEADER_NAME = "X-OpenAM-Username";",
        "var PASSWORD_HEADER_NAME = "X-OpenAM-Password";",
        "var OTP_HEADER_NAME = "X-OpenAM-MobileOTP";",
        "/*",
        " * END SCRIPT CONFIGURATION",
        " */",
        "",
        "outcome = "false";",
        "",
        "var username = getHeader(USERNAME_HEADER_NAME) || null;",
        "var password = getHeader(PASSWORD_HEADER_NAME) || null;",
        "var mobileOTP = getHeader(OTP_HEADER_NAME) || null;",
        "",
        "if (username && password && mobileOTP) {",
        "      sharedState.put("username", username);",
        "      transientState.put("password", password);",
        "      transientState.put("mobileOTP", mobileOTP);",
        "    outcome = "true";",
        "}",
        "",
        "logger.warning("MobileOTP: Extract Username, Password, OTP: finish [outcome=".concat(outcome).concat("]"));",
        "",
        "/*",
        " * Returns the value of the requested header",
        " */",
        "function getHeader(headerName) {",
        "      if (requestHeaders.get(headerName) && requestHeaders.get(headerName).get(0)) {",
        "        return requestHeaders.get(headerName).get(0).toString();",
        "    }",
        "      return null;",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./MobileOTP:-Prepare-Reset-Of-OTP-Profile-Attribute.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "d25a1315-8beb-4a0c-84bf-534214fed087": {
      "_id": "d25a1315-8beb-4a0c-84bf-534214fed087",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Prepare Reset Of OTP Profile Attribute",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "MobileOTP: Prepare Reset Of OTP Profile Attribute",
      "script": [
        "/*",
        " * Reset OTP profile attribute in ObjectAttributes so it can be patched to the user profile.",
        " */",
        "outcome = "true";",
        "",
        "setSharedObjectAttribute("fr-attr-int5", "0");",
        "",
        "/*",
        " * Store attributes in shared state for use with the Create/Patch Object nodes.",
        " */",
        "function setSharedObjectAttribute(name, value) {",
        "      var storage = sharedState.get("objectAttributes");",
        "    if (storage && value) {",
        "          if (storage.put) {",
        "              storage.put(name, value);",
        "        }",
        "          else {",
        "              storage[name] = value;",
        "        }",
        "    }",
        "    else if (value) {",
        "        sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "    }",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./MobileOTP:-Validate-OTP-In-Profile-Attribute.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "ce6fbbcf-5d9a-471b-bcc1-448758a6374a": {
      "_id": "ce6fbbcf-5d9a-471b-bcc1-448758a6374a",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Validate OTP in profile attribute",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "MobileOTP: Validate OTP In Profile Attribute",
      "script": [
        "/*",
        " * Validate OTP in user profile attribute against OTP in shared state",
        " */",
        "outcome = "false";",
        "var OTP_LENGTH = 8;",
        "",
        "if (sharedState.get("mobileOTP")) {",
        "      var profileOTP = idRepository.getAttribute(username, "fr-attr-int5");",
        "}",
        "",
        "function checkPassword(profileOTP, password) {",
        "    var oneTimePassword = profileOTP.substring(0,7);",
        "    var passwordTimestamp = Number(profileOTP.substring(8));",
        "",
        "    var passwordMatches = oneTimePassword",
        "        && (oneTimePassword == password)",
        "        && passwordTimestamp != null",
        "        && isWithinExpiryTime(passwordTimestamp);",
        "    return passwordMatches;",
        "}",
        "",
        "function isWithinExpiryTime(passwordTimestamp) {",
        "        Instant previous = Instant.ofEpochSecond(passwordTimestamp);",
        "        Duration passwordExpiry = Duration.ofMinutes(config.passwordExpiryTime());",
        "        Instant now = Time.getClock().instant();",
        "        logger.debug("previous {} \\n passwordExpiry {} \\n now {}", previous, passwordExpiry, now);",
        "        boolean withinExpiryTime = Duration.between(previous.plus(passwordExpiry), now).isNegative();",
        "        logger.debug("withinExpiryTime {}", withinExpiryTime);",
        "        return withinExpiryTime;",
        "}",
        "",
        "/*",
        "    private Action checkPassword(TreeContext context, String password) {",
        "        JsonValue oneTimePassword = context.getState(ONE_TIME_PASSWORD);",
        "        JsonValue passwordTimestamp = context.getState(ONE_TIME_PASSWORD_TIMESTAMP);",
        "",
        "        boolean passwordMatches = oneTimePassword != null && oneTimePassword.isString()",
        "                && oneTimePassword.asString().equals(password)",
        "                && passwordTimestamp != null && passwordTimestamp.isNumber()",
        "                && isWithinExpiryTime(passwordTimestamp.asLong());",
        "        logger.debug("passwordMatches {}", passwordMatches);",
        "        return goTo(passwordMatches).build();",
        "    }",
        "",
        "    private boolean isWithinExpiryTime(long passwordTimestamp) {",
        "        Instant previous = Instant.ofEpochSecond(passwordTimestamp);",
        "        Duration passwordExpiry = Duration.ofMinutes(config.passwordExpiryTime());",
        "        Instant now = Time.getClock().instant();",
        "        logger.debug("previous {} \\n passwordExpiry {} \\n now {}", previous, passwordExpiry, now);",
        "        boolean withinExpiryTime = Duration.between(previous.plus(passwordExpiry), now).isNegative();",
        "        logger.debug("withinExpiryTime {}", withinExpiryTime);",
        "        return withinExpiryTime;",
        "    }",
        "    */",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Normalized-ADFS-Profile-to-Managed-User.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "3156d7e9-1589-4ffb-a659-37a1647ee03d": {
      "_id": "3156d7e9-1589-4ffb-a659-37a1647ee03d",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Converts a normalized social profile coming from ADFS into a managed user",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Normalized ADFS Profile to Managed User",
      "script": [
        "/*",
        " * Copyright 2022 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "import org.forgerock.json.JsonValue",
        "",
        "JsonValue managedUser = json(object(",
        "        field("givenName", normalizedProfile.givenName),",
        "        field("sn", normalizedProfile.familyName),",
        "        field("mail", normalizedProfile.email),",
        "        field("userName", normalizedProfile.username)))",
        "",
        "if (normalizedProfile.postalAddress.isNotNull()) managedUser.put("postalAddress", normalizedProfile.postalAddress)",
        "if (normalizedProfile.addressLocality.isNotNull()) managedUser.put("city", normalizedProfile.addressLocality)",
        "if (normalizedProfile.addressRegion.isNotNull()) managedUser.put("stateProvince", normalizedProfile.addressRegion)",
        "if (normalizedProfile.postalCode.isNotNull()) managedUser.put("postalCode", normalizedProfile.postalCode)",
        "if (normalizedProfile.country.isNotNull()) managedUser.put("country", normalizedProfile.country)",
        "if (normalizedProfile.phone.isNotNull()) managedUser.put("telephoneNumber", normalizedProfile.phone)",
        "managedUser.put("accountStatus", (normalizedProfile.roles.asString() == "fidc-volker-dev-admins") ? 'Active' : 'Inactive')",
        "",
        "// if the givenName and familyName is null or empty",
        "// then add a boolean flag to the shared state to indicate names are not present",
        "// this could be used elsewhere",
        "// for eg. this could be used in a scripted decision node to by-pass patching",
        "// the user object with blank values when givenName  and familyName is not present",
        "boolean noGivenName = normalizedProfile.givenName.isNull() || (!normalizedProfile.givenName.asString()?.trim())",
        "boolean noFamilyName = normalizedProfile.familyName.isNull() || (!normalizedProfile.familyName.asString()?.trim())",
        "sharedState.put("nameEmptyOrNull", noGivenName && noFamilyName)",
        "",
        "return managedUser",
        "",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Normalized-Profile-to-Identity.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "ed685f9f-5909-4726-86e8-22bd38b47663": {
      "_id": "ed685f9f-5909-4726-86e8-22bd38b47663",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Converts a normalized social profile into an Identity",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Normalized Profile to Identity",
      "script": [
        "/*",
        " * Copyright 2021 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "import org.forgerock.json.JsonValue",
        "",
        "JsonValue identity = json(object(",
        "        field("givenName", normalizedProfile.givenName),",
        "        field("sn", normalizedProfile.familyName),",
        "        field("mail", normalizedProfile.email),",
        "        field("cn", normalizedProfile.displayName),",
        "        field("userName", normalizedProfile.username),",
        "        field("iplanet-am-user-alias-list", selectedIdp + '-' + normalizedProfile.id.asString())))",
        "",
        "return identity",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Normalized-Profile-to-Managed-User.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "58c824ae-84ed-4724-82cd-db128fc3f6c": {
      "_id": "58c824ae-84ed-4724-82cd-db128fc3f6c",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Converts a normalized social profile into a managed user",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Normalized Profile to Managed User",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "import org.forgerock.json.JsonValue",
        "",
        "JsonValue managedUser = json(object(",
        "        field("givenName", normalizedProfile.givenName),",
        "        field("sn", normalizedProfile.familyName),",
        "        field("mail", normalizedProfile.email),",
        "        field("userName", normalizedProfile.username)))",
        "",
        "if (normalizedProfile.postalAddress.isNotNull()) managedUser.put("postalAddress", normalizedProfile.postalAddress)",
        "if (normalizedProfile.addressLocality.isNotNull()) managedUser.put("city", normalizedProfile.addressLocality)",
        "if (normalizedProfile.addressRegion.isNotNull()) managedUser.put("stateProvince", normalizedProfile.addressRegion)",
        "if (normalizedProfile.postalCode.isNotNull()) managedUser.put("postalCode", normalizedProfile.postalCode)",
        "if (normalizedProfile.country.isNotNull()) managedUser.put("country", normalizedProfile.country)",
        "if (normalizedProfile.phone.isNotNull()) managedUser.put("telephoneNumber", normalizedProfile.phone)",
        "",
        "// if the givenName and familyName is null or empty",
        "// then add a boolean flag to the shared state to indicate names are not present",
        "// this could be used elsewhere",
        "// for eg. this could be used in a scripted decision node to by-pass patching",
        "// the user object with blank values when givenName  and familyName is not present",
        "boolean noGivenName = normalizedProfile.givenName.isNull() || (!normalizedProfile.givenName.asString()?.trim())",
        "boolean noFamilyName = normalizedProfile.familyName.isNull() || (!normalizedProfile.familyName.asString()?.trim())",
        "sharedState.put("nameEmptyOrNull", noGivenName && noFamilyName)",
        "",
        "return managedUser",
        "",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Normalized-idddataweb-Profile-to-Managed-User.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "809330cf-874c-4d57-a8f1-5882c6dd855b": {
      "_id": "809330cf-874c-4d57-a8f1-5882c6dd855b",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Converts a normalized social profile for iddataweb into a Managed user",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Normalized idddataweb Profile to Managed User",
      "script": [
        "/* Normalized idddataweb Profile to Managed User",
        " * Copyright 2022 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS. Not for production use.",
        " * Modified by Stephen Payne, 2021-Mar-30",
        " */",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "import org.forgerock.json.JsonValue",
        "logger.error("Normalized_Profile_IDDataWeb: Start " + normalizedProfile);",
        "",
        "JsonValue managedUser = json(object(",
        "        field("givenName", normalizedProfile.givenName),",
        "        field("sn", normalizedProfile.familyName),",
        "        field("userName", normalizedProfile.username)))",
        "if (normalizedProfile.postalAddress.isNotNull()) managedUser.put("postalAddress", normalizedProfile.postalAddress)",
        "if (normalizedProfile.addressLocality.isNotNull()) managedUser.put("city", normalizedProfile.addressLocality)",
        "if (normalizedProfile.addressRegion.isNotNull()) managedUser.put("stateProvince", normalizedProfile.addressRegion)",
        "if (normalizedProfile.postalCode.isNotNull()) managedUser.put("postalCode", normalizedProfile.postalCode)",
        "if (normalizedProfile.country.isNotNull()) managedUser.put("country", normalizedProfile.country)",
        "if (normalizedProfile.phone.isNotNull()) managedUser.put("telephoneNumber", normalizedProfile.phone)",
        "if (normalizedProfile.DOB.isNotNull()) managedUser.put("frIndexedString2", normalizedProfile.DOB)",
        "",
        "return managedUser",
        "",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./OAuth2-Access-Token-Modification-Script.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "d22f9a0c-426a-4466-b95e-d0f125b0d5fa": {
      "_id": "d22f9a0c-426a-4466-b95e-d0f125b0d5fa",
      "context": "OAUTH2_ACCESS_TOKEN_MODIFICATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Default global script for OAuth2 Access Token Modification",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "OAuth2 Access Token Modification Script",
      "script": [
        "/*",
        " * Copyright 2019-2021 ForgeRock AS. All Rights Reserved.",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        " * This script lets you modify information associated with an OAuth2 access token",
        " * with methods provided by the AccessToken (1) interface.",
        " * The changes made to OAuth2 access tokens will directly impact the size of the CTS tokens,",
        " * and, similarly, the size of the JWTs if client-based OAuth2 tokens are utilized.",
        " * When adding/updating fields make sure that the token size remains within client/user-agent limits.",
        " *",
        " * Defined variables:",
        " * accessToken - AccessToken (1).",
        " *               The access token to be updated.",
        " *               Mutable object, all changes to the access token will be reflected.",
        " * scopes - Set<String> (6).",
        " *          Always present, the requested scopes.",
        " * requestProperties - Unmodifiable Map (5).",
        " *                     Always present, contains a map of request properties:",
        " *                     requestUri - The request URI.",
        " *                     realm - The realm that the request relates to.",
        " *                     requestParams - A map of the request params and/or posted data.",
        " *                                     Each value is a list of one or more properties.",
        " *                                     Please note that these should be handled in accordance with OWASP best practices:",
        " *                                     https://owasp.org/www-community/vulnerabilities/Unsafe_use_of_Reflection.",
        " * clientProperties - Unmodifiable Map (5).",
        " *                    Present if the client specified in the request was identified, contains a map of client properties:",
        " *                    clientId - The client's URI for the request locale.",
        " *                    allowedGrantTypes - List of the allowed grant types (org.forgerock.oauth2.core.GrantType) for the client.",
        " *                    allowedResponseTypes - List of the allowed response types for the client.",
        " *                    allowedScopes - List of the allowed scopes for the client.",
        " *                    customProperties - A map of the custom properties of the client.",
        " *                                       Lists or maps will be included as sub-maps; for example:",
        " *                                       customMap[Key1]=Value1 will be returned as customMap -> Key1 -> Value1.",
        " *                                       To add custom properties to a client, update the Custom Properties field",
        " *                                       in AM Console > Realm Name > Applications > OAuth 2.0 > Clients > Client ID > Advanced.",
        " * identity - AMIdentity (3).",
        " *            Always present, the identity of the resource owner.",
        " * session - SSOToken (4).",
        " *           Present if the request contains the session cookie, the user's session object.",
        " * scriptName - String (primitive).",
        " *              Always present, the display name of the script.",
        " * logger - Always present, the "OAuth2Provider" debug logger instance:",
        " *          https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.",
        " *          Corresponding log files will be prefixed with: scripts.OAUTH2_ACCESS_TOKEN_MODIFICATION.",
        " * httpClient - HTTP Client (8).",
        " *              Always present, the HTTP Client instance:",
        " *              https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-http-client.html#scripting-api-global-http-client.",
        " *",
        " * Return - no value is expected, changes shall be made to the accessToken parameter directly.",
        " *",
        " * Class reference:",
        " * (1) AccessToken - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/AccessToken.html.",
        " * (3) AMIdentity - https://backstage.forgerock.com/docs/am/7/apidocs/com/sun/identity/idm/AMIdentity.html.",
        " * (4) SSOToken - https://backstage.forgerock.com/docs/am/7/apidocs/com/iplanet/sso/SSOToken.html.",
        " * (5) Map - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashMap.html,",
        " *           or https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/LinkedHashMap.html.",
        " * (6) Set - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashSet.html.",
        " * (8) Client - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/http/Client.html.",
        " */",
        "",
        "(function () {",
        "  // Adds new fields containing the session property values.",
        "  // NOTE: session may not be available for non-interactive authorization grants.",
        "  if (session) {",
        "    try {",
        "      accessToken.setField('ip_address', session.getProperty('Host'));",
        "    } catch (e) {",
        "      logger.error('Unable to retrieve session property value. ' + e);",
        "    }",
        "  }",
        "}());",
        "",
        "/* EXAMPLE",
        "(function () {",
        "    var frJava = JavaImporter(",
        "        org.forgerock.http.protocol.Request,",
        "        org.forgerock.http.protocol.Response",
        "    );",
        "",
        "    // Always includes this field in the token.",
        "    accessToken.setField('key1', 'value1');",
        "",
        "    // Receives and adds to the access token additional values by performing a REST call to an external service.",
        "    // WARNING: Below, you will find a reference to a third-party site, which is provided only as an example.",
        "    var uri = 'https://jsonplaceholder.typicode.com/posts';",
        "",
        "    try {",
        "        var request = new frJava.Request();",
        "",
        "        // You can chain methods that return the request object.",
        "        request.setUri(uri)",
        "            .setMethod('POST')",
        "            .setEntity(JSON.stringify({",
        "                updatedFields: {",
        "                    key2: 'value2',",
        "                    key3: 'value3'",
        "                }",
        "            }));",
        "",
        "        // You can call a method when chaining is not possible.",
        "        request.getHeaders().add('Content-Type', 'application/json; charset=UTF-8');",
        "",
        "        // Sends the request and receives the response.",
        "        var response = httpClient.send(request).getOrThrow();",
        "",
        "        // Checks if the response status is as expected.",
        "        if (response.getStatus() === org.forgerock.http.protocol.Status.CREATED) {",
        "            var result = JSON.parse(response.getEntity().getString());",
        "",
        "            // Set multiple token fields at once.",
        "            accessToken.setFields(result.updatedFields);",
        "        } else {",
        "            logger.error('Unable to obtain access token modifications. Status: ' + response.getStatus() + '. Content: ' + response.getEntity().getString());",
        "        }",
        "    } catch (e) {",
        "        logger.error('The request processing was interrupted. ' + e);",
        "",
        "        // The access token request fails with the HTTP 500 error in this case.",
        "        throw ('Unable to obtain response from: ' + uri);",
        "    }",
        "",
        "    // Adds new fields containing identity attribute values to the access token.",
        "    accessToken.setField('mail', identity.getAttribute('mail'));",
        "    accessToken.setField('phone', identity.getAttribute('telephoneNumber').toArray()[0]);",
        "",
        "    // Adds new fields containing the session property values.",
        "    // NOTE: session may not be available for non-interactive authorization grants.",
        "    if (session) {",
        "        try {",
        "            accessToken.setField('ipAddress', session.getProperty('Host'));",
        "        } catch (e) {",
        "            logger.error('Unable to retrieve session property value. ' + e);",
        "        }",
        "    }",
        "",
        "    // Removes a native field from the token entry, that was set by AM.",
        "    // WARNING: removing native fields from the token may result in loss of functionality.",
        "    // accessToken.removeTokenName()",
        "",
        "    // No return value is expected. Let it be undefined.",
        "}());",
        "*/",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./OIDC-Claims-Script.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "36863ffb-40ec-48b9-94b1-9a99f71cc3b5": {
      "_id": "36863ffb-40ec-48b9-94b1-9a99f71cc3b5",
      "context": "OIDC_CLAIMS",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Default global script for OIDC claims",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "OIDC Claims Script",
      "script": [
        "/*",
        " * Copyright 2014-2021 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        " * This script computes claim values returned in ID tokens and/or at the UserInfo Endpoint.",
        " * The claim values are computed for:",
        " * the claims derived from the requested scopes,",
        " * the claims provided by the authorization server,",
        " * and the claims requested by the client via the claims parameter.",
        " *",
        " * In the CONFIGURATION AND CUSTOMIZATION section, you can",
        " * define the scope-to-claims mapping, and",
        " * assign to each claim a resolver function that will compute the claim value.",
        " *",
        " * Defined variables (class references are provided below):",
        " * scopes - Set<String> (6).",
        " *          Always present, the requested scopes.",
        " * claims - Map<String, Object> (5).",
        " *          Always present, default server provided claims.",
        " * claimObjects - List<Claim> (7, 2).",
        " *                Always present, the default server provided claims.",
        " * requestedClaims - Map<String, Set<String>> (5).",
        " *                   Always present, not empty if the request contains the claims parameter and the server has enabled",
        " *                   claims_parameter_supported. A map of the requested claims to possible values, otherwise empty;",
        " *                   requested claims with no requested values will have a key but no value in the map. A key with",
        " *                   a single value in its Set (6) indicates that this is the only value that should be returned.",
        " * requestedTypedClaims - List<Claim> (7, 2).",
        " *                        Always present, the requested claims.",
        " *                        Requested claims with no requested values will have a claim with no values.",
        " *                        A claim with a single value indicates this is the only value that should be returned.",
        " * claimsLocales - List<String> (7).",
        " *                 The values from the 'claims_locales' parameter.",
        " *                 See https://openid.net/specs/openid-connect-core-1_0.html#ClaimsLanguagesAndScripts for the OIDC specification details.",
        " * requestProperties - Unmodifiable Map (5).",
        " *                     Always present, contains a map of request properties:",
        " *                     requestUri - The request URI.",
        " *                     realm - The realm that the request relates to.",
        " *                     requestParams - A map of the request params and/or posted data.",
        " *                                     Each value is a list of one or more properties.",
        " *                                     Please note that these should be handled in accordance with OWASP best practices:",
        " *                                     https://owasp.org/www-community/vulnerabilities/Unsafe_use_of_Reflection.",
        " * clientProperties - Unmodifiable Map (5).",
        " *                    Present if the client specified in the request was identified, contains a map of client properties:",
        " *                    clientId - The client's URI for the request locale.",
        " *                    allowedGrantTypes - List of the allowed grant types (org.forgerock.oauth2.core.GrantType) for the client.",
        " *                    allowedResponseTypes - List of the allowed response types for the client.",
        " *                    allowedScopes - List of the allowed scopes for the client.",
        " *                    customProperties - A map of the custom properties of the client.",
        " *                                       Lists or maps will be included as sub-maps; for example:",
        " *                                       customMap[Key1]=Value1 will be returned as customMap -> Key1 -> Value1.",
        " *                                       To add custom properties to a client, update the Custom Properties field",
        " *                                       in AM Console > Realm Name > Applications > OAuth 2.0 > Clients > Client ID > Advanced.",
        " * identity - AMIdentity (3).",
        " *            Always present, the identity of the resource owner.",
        " * session - SSOToken (4).",
        " *           Present if the request contains the session cookie, the user's session object.",
        " * scriptName - String (primitive).",
        " *              Always present, the display name of the script.",
        " * logger - Always present, the "OAuth2Provider" debug logger instance:",
        " *          https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.",
        " *          Corresponding files will be prefixed with: scripts.OIDC_CLAIMS.",
        " * httpClient - HTTP Client (8).",
        " *              Always present, the HTTP Client instance:",
        " *              https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-http-client.html#scripting-api-global-http-client.",
        " *              In order to use the client, you may need to add",
        " *              org.forgerock.http.Client,",
        " *              org.forgerock.http.protocol.*,",
        " *              and org.forgerock.util.promise.PromiseImpl",
        " *              to the allowed Java classes in the scripting engine configuration, as described in:",
        " *              https://backstage.forgerock.com/docs/am/7/scripting-guide/script-engine-security.html",
        " *",
        " * Return - a new UserInfoClaims(Map<String, Object> values, Map<String, List<String>> compositeScopes) (1) object.",
        " *          The result of the last statement in the script is returned to the server.",
        " *          Currently, the Immediately Invoked Function Expression (also known as Self-Executing Anonymous Function)",
        " *          is the last (and only) statement in this script, and its return value will become the script result.",
        " *          Do not use "return variable" statement outside of a function definition.",
        " *          See RESULTS section for additional details.",
        " *",
        " * Class reference:",
        " * (1) UserInfoClaims - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html.",
        " * (2) Claim - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html).",
        " *         An instance of org.forgerock.openidconnect.Claim has methods to access",
        " *         the claim name, requested values, locale, and whether the claim is essential.",
        " * (3) AMIdentity - https://backstage.forgerock.com/docs/am/7/apidocs/com/sun/identity/idm/AMIdentity.html.",
        " * (4) SSOToken - https://backstage.forgerock.com/docs/am/7/apidocs/com/iplanet/sso/SSOToken.html.",
        " * (5) Map - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashMap.html,",
        " *           or https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/LinkedHashMap.html.",
        " * (6) Set - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashSet.html.",
        " * (7) List - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/ArrayList.html.",
        " * (8) Client - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/http/Client.html.",
        "*/",
        "",
        "(function () {",
        "    // SETUP",
        "",
        "    /**",
        "     * Claim processing utilities.",
        "     * An object that contains reusable functions for processing claims.",
        "     * @see CLAIM PROCESSING UTILITIES section for details.",
        "     */",
        "    var utils = getUtils();",
        "",
        "    // CONFIGURATION AND CUSTOMIZATION",
        "",
        "    /**",
        "     * OAuth 2.0 scope values (scopes) can be used by the Client to request OIDC claims.",
        "     *",
        "     * Call this configuration method, and pass in as the first argument",
        "     * an object that maps a scope value to an array of claim names",
        "     * to specify which claims need to be processed and returned for the requested scopes.",
        "     * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#ScopeClaims}",
        "     * for the scope values that could be used to request claims as defined in the OIDC specification.",
        "     *",
        "     * Below, find a default configuration that is expected to work in the current environment.",
        "     *",
        "     * CUSTOMIZATION",
        "     * You can choose the claim names returned for a scope.",
        "     */",
        "    utils.setScopeClaimsMap({",
        "        profile: [",
        "            'name',",
        "            'family_name',",
        "            'given_name',",
        "            'zoneinfo',",
        "            'locale'",
        "        ],",
        "        email: ['email'],",
        "        address: ['address'],",
        "        phone: ['phone_number']",
        "    });",
        "",
        "    /**",
        "     * In this script, each claim",
        "     * derived from the requested scopes,",
        "     * provided by the authorization server, and",
        "     * requested by the client via the claims parameter",
        "     * will be processed by a function associated with the claim name.",
        "     *",
        "     * Call this configuration method, and pass in as the first argument",
        "     * an object that maps a claim name to a resolver function,",
        "     * which will be automatically executed for each claim processed by the script.",
        "     *",
        "     * The claim resolver function will receive the requested claim information",
        "     * in an instance of org.forgerock.openidconnect.Claim as the first argument.",
        "     * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html}",
        "     * for details on the Claim class.",
        "     *",
        "     * If the claim resolver function returns a value,",
        "     * other than undefined or null,",
        "     * the claim will be included in the script's results.",
        "     *",
        "     * The Claim instance provides methods to check",
        "     * what the name of the claim is,",
        "     * which values the claim request contains,",
        "     * whether the claim is essential, and",
        "     * which locale the claim is associated with.",
        "     * The resolver function can consider this information when computing and returning the claim value.",
        "     *",
        "     * Below, find a default configuration that is expected to work in the current environment.",
        "     * A reusable function, utils.getUserProfileClaimResolver(String attribute-name),",
        "     * is called to return a claim resolver function based on a user profile attribute.",
        "     * @see CLAIM RESOLVERS section for the implementation details and examples.",
        "     * For the address claim, an example of a claim resolver that uses another claim resolver is provided.",
        "     *",
        "     * CUSTOMIZATION",
        "     * You can reuse the predefined utils methods with your custom arguments.",
        "     * You can also specify a custom resolver function for a claim name,",
        "     * that will compute and return the claim value—as shown in the commented out example below.",
        "     */",
        "    utils.setClaimResolvers({",
        "        /*",
        "        // An example of a simple claim resolver function that is defined for a claim",
        "        // directly in the configuration object:",
        "        custom-claim-name: function (requestedClaim) {",
        "            // In this case, initially, the claim value comes straight from a user profile attribute value:",
        "            var claimValue = identity.getAttribute('custom-attribute-name').toArray()[0]",
        "",
        "            // Optionally, provide additional logic for processing (filtering, formatting, etc.) the claim value.",
        "            // You can use:",
        "            // requestedClaim.getName()",
        "            // requestedClaim.getValues()",
        "            // requestedClaim.getLocale()",
        "            // requestedClaim.isEssential()",
        "",
        "            return claimValue",
        "        },",
        "        */",
        "        /**",
        "         * The use of utils.getUserProfileClaimResolver shows how",
        "         * an argument passed to a function that returns a claim resolver",
        "         * becomes available to the resolver function (via its lexical context).",
        "         */",
        "        name: utils.getUserProfileClaimResolver('cn'),",
        "        family_name: utils.getUserProfileClaimResolver('sn'),",
        "        given_name: utils.getUserProfileClaimResolver('givenname'),",
        "        zoneinfo: utils.getUserProfileClaimResolver('preferredtimezone'),",
        "        locale: utils.getUserProfileClaimResolver('preferredlocale'),",
        "        email: utils.getUserProfileClaimResolver('mail'),",
        "        address: utils.getAddressClaimResolver(",
        "            /**",
        "             * The passed in user profile claim resolver function",
        "             * can be used by the address claim resolver function",
        "             * to obtain the claim value to be formatted as per the OIDC specification:",
        "             * @see https://openid.net/specs/openid-connect-core-1_0.html#AddressClaim.",
        "             */",
        "            utils.getUserProfileClaimResolver('postaladdress')",
        "        ),",
        "        phone_number: utils.getUserProfileClaimResolver('telephonenumber')",
        "    });",
        "",
        "    // CLAIM PROCESSING UTILITIES",
        "",
        "    /**",
        "     * @returns {object} An object that contains reusable claim processing utilities.",
        "     * @see PUBLIC METHODS section and the return statement for the list of exported functions.",
        "     */",
        "    function getUtils () {",
        "        // IMPORT JAVA",
        "",
        "        /**",
        "         * Provides Java scripting functionality.",
        "         * @see {@link https://developer.mozilla.org/en-US/docs/Mozilla/Projects/Rhino/Scripting_Java#javaimporter_constructor}.",
        "         */",
        "        var frJava = JavaImporter(",
        "            org.forgerock.oauth2.core.exceptions.InvalidRequestException,",
        "            org.forgerock.oauth2.core.UserInfoClaims,",
        "            org.forgerock.openidconnect.Claim,",
        "",
        "            java.util.LinkedHashMap,",
        "            java.util.ArrayList",
        "        );",
        "",
        "        // SET UP CONFIGURATION",
        "",
        "        /**",
        "         * Placeholder for a configuration option that contains",
        "         * an object that maps the supported scope values (scopes)",
        "         * and the corresponding claim names for each scope value.",
        "         */",
        "        var scopeClaimsMap;",
        "",
        "        /**",
        "         * Placeholder for a configuration option that contains",
        "         * an object that maps the supported claim names",
        "         * and the resolver functions returning the claim value.",
        "         */",
        "        var claimResolvers;",
        "",
        "        /**",
        "         * A (public) method that accepts an object that maps the supported scopes and the corresponding claim names,",
        "         * and assigns it to a (private) variable that serves as a configuration option.",
        "         * @param {object} params - An object that maps each supported scope value to an array of claim names,",
        "         * in order to specify which claims need to be processed for the requested scopes.",
        "         * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#ScopeClaims} for details.",
        "         * @param {string[]} [params.profile] - An array of claim names to be returned if the profile scope is requested.",
        "         * @param {string[]} [params.email] - An array of claim names to be returned if the email scope is requested.",
        "         * @param {string[]} [params.address] - An array of claim names to be returned if the address scope is requested.",
        "         * @param {string[]} [params.phone] - An array of claim names to be returned if the phone scope is requested.",
        "         * @returns {undefined}",
        "         */",
        "        function setScopeClaimsMap(params) {",
        "            scopeClaimsMap = params;",
        "        }",
        "",
        "        /**",
        "         * A (public) method that accepts an object that maps the supported claim names",
        "         * and the resolver functions returning the claim value,",
        "         * and assigns it to a (private) variable that serves as a configuration option.",
        "         * @param {object} params - An object that maps",
        "         * each supported claim name to a function that computes and returns the claim value.",
        "         */",
        "        function setClaimResolvers(params) {",
        "            claimResolvers = params;",
        "        }",
        "",
        "        // CLAIM RESOLVERS",
        "",
        "        /**",
        "         * Claim resolvers are functions that return a claim value.",
        "         * @param {*}",
        "         * @returns {*}",
        "         */",
        "",
        "        /**",
        "         * Defines a claim resolver based on a user profile attribute.",
        "         * @param {string} attributeName - Name of the user profile attribute.",
        "         * @returns {function} A function that will determine the claim value",
        "         * based on the user profile attribute and the (requested) claim properties.",
        "         */",
        "        function getUserProfileClaimResolver (attributeName) {",
        "            /**",
        "             * Resolves a claim with a user profile attribute value.",
        "             * Returns undefined if the identity attribute is not populated,",
        "             * OR if the claim has requested values that do not contain the identity attribute value.",
        "             * ATTENTION: the aforementioned comparison is case-sensitive.",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {string|HashSet|undefined}",
        "             */",
        "            function resolveClaim(claim) {",
        "                var userProfileValue;",
        "",
        "                if (identity) {",
        "                    userProfileValue = getClaimValueFromSet(claim, identity.getAttribute(attributeName));",
        "",
        "                    if (userProfileValue && !userProfileValue.isEmpty()) {",
        "                        if (!claim.getValues() || claim.getValues().isEmpty() || claim.getValues().contains(userProfileValue)) {",
        "                            return userProfileValue;",
        "                        }",
        "                    }",
        "                }",
        "            }",
        "",
        "            return resolveClaim;",
        "        }",
        "",
        "        /**",
        "         * Returns an address claim resolver based on a claim value obtained with another claim resolver.",
        "         * @param {function} resolveClaim - A function that returns a claim value.",
        "         * @returns {function} A function that will accept a claim as an argument,",
        "         * run the claim resolver function for the claim and obtain the claim value,",
        "         * and apply additional formatting to the value before returning it.",
        "         */",
        "        function getAddressClaimResolver (resolveClaim) {",
        "            /**",
        "             * Creates an address claim object from a value returned by a claim resolver,",
        "             * and returns the address claim object as the claim value.",
        "             * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#AddressClaim}.",
        "             * The claim value is obtained with a claim resolving function available from the closure.",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {java.util.LinkedHashMap|undefined} The address claim object created from a claim value.",
        "             */",
        "            function resolveAddressClaim(claim) {",
        "                var claimValue = resolveClaim(claim);",
        "                var addressObject;",
        "",
        "                if (isClaimValueValid(claimValue)) {",
        "                    addressObject = new frJava.LinkedHashMap();",
        "",
        "                    addressObject.put('formatted', claimValue);",
        "",
        "                    return addressObject;",
        "                }",
        "            }",
        "",
        "            return resolveAddressClaim;",
        "        }",
        "",
        "        /**",
        "         * Returns an essential claim resolver based on a claim value obtained with another claim resolver.",
        "         * @param {function} resolveClaim - A function that returns a claim value.",
        "         * @returns {function} A function that will accept a claim as an argument,",
        "         * run the claim resolver function for the claim and obtain the claim value,",
        "         * and apply additional logic for essential claims.",
        "         */",
        "        function getEssentialClaimResolver (resolveClaim) {",
        "            /**",
        "             * Returns a claim value or throws an error.",
        "             * The claim value is obtained with a claim resolving function available from the closure.",
        "             * Throws an exception if the claim is essential and no value is returned for the claim.",
        "             *",
        "             * Use of this resolver is optional.",
        "             * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#IndividualClaimsRequests} stating:",
        "             * "Note that even if the Claims are not available because the End-User did not authorize their release or they are not present,",
        "             * the Authorization Server MUST NOT generate an error when Claims are not returned, whether they are Essential or Voluntary,",
        "             * unless otherwise specified in the description of the specific claim."",
        "             *",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {*}",
        "             * @throws {org.forgerock.oauth2.core.exceptions.InvalidRequestException}",
        "             */",
        "            function resolveEssentialClaim(claim) {",
        "                var claimValue = resolveClaim(claim);",
        "",
        "                if (claim.isEssential() && !isClaimValueValid(claimValue)) {",
        "                    throw new frJava.InvalidRequestException('Could not provide value for essential claim: ' + claim.getName());",
        "                }",
        "",
        "                return claimValue;",
        "            }",
        "",
        "            return resolveEssentialClaim;",
        "        }",
        "",
        "        /**",
        "         * Provides default resolution for a claim.",
        "         * Use it if a claim-specific resolver is not defined in the configuration.",
        "         * @param {org.forgerock.openidconnect.Claim} claim",
        "         * An object that provides methods to obtain information/requirements associated with a claim.",
        "         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "         * @returns {*} A single value associated with this claim.",
        "         */",
        "        function resolveAnyClaim (claim) {",
        "            if (claim.getValues().size() === 1) {",
        "                return claim.getValues().toArray()[0];",
        "            }",
        "        }",
        "",
        "        // UTILITIES",
        "",
        "        /**",
        "         * Returns claim value from a set.",
        "         * If the set contains a single value, returns the value.",
        "         * If the set contains multiple values, returns the set.",
        "         * Otherwise, returns undefined.",
        "         *",
        "         * @param {org.forgerock.openidconnect.Claim} claim",
        "         * An object that provides methods to obtain information/requirements associated with a claim.",
        "         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "         * @param {java.util.HashSet} set The set—for example, a user profile attribute value.",
        "         * @returns {string|java.util.HashSet|undefined}",
        "         */",
        "        function getClaimValueFromSet (claim, set) {",
        "            if (set && set.size()) {",
        "                if (set.size() === 1) {",
        "                    return set.toArray()[0];",
        "                } else {",
        "                    return set;",
        "                }",
        "            } else if (logger.warningEnabled()) {",
        "                logger.warning('OIDC Claims script. Got an empty set for claim: ' + claim.getName());",
        "            }",
        "        }",
        "",
        "        function isClaimValueValid (claimValue) {",
        "            if (typeof claimValue === 'undefined' || claimValue === null) {",
        "                return false;",
        "            }",
        "",
        "            return true;",
        "        }",
        "",
        "        // CLAIM PROCESSING",
        "",
        "        /**",
        "         * Constructs and returns an object populated with the computed claim values",
        "         * and the requested scopes mapped to the claim names.",
        "         * @returns {org.forgerock.oauth2.core.UserInfoClaims} The object to be returned to the authorization server.",
        "         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html}.",
        "         * @see RESULTS section for the use of this function.",
        "         */",
        "        function getUserInfoClaims () {",
        "            return new frJava.UserInfoClaims(getComputedClaims(), getCompositeScopes());",
        "        }",
        "",
        "        /**",
        "         * Creates a map of (requested) claim names populated with the computed claim values.",
        "         * @returns {java.util.LinkedHashMap}",
        "         * A map of the requested claim names and the corresponding claim values.",
        "         */",
        "        function getComputedClaims () {",
        "            /**",
        "             * Creates a complete list of claim objects from:",
        "             * the claims derived from the scopes,",
        "             * the claims provided by the authorization server,",
        "             * and the claims requested by the client.",
        "             * @returns {java.util.ArrayList}",
        "             * Returns a complete list of org.forgerock.openidconnect.Claim objects available to the script.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for the claim object details.",
        "             */",
        "            function getClaims() {",
        "                /**",
        "                 * Returns a list of claim objects for the requested scopes.",
        "                 * Uses the scopeClaimsMap configuration option to derive the claim names;",
        "                 * no other properties of a claim derived from a scope are populated.",
        "                 * @returns {java.util.ArrayList}",
        "                 * A list of org.forgerock.openidconnect.Claim objects derived from the requested scopes.",
        "                 * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for the claim object details.",
        "                 */",
        "                function convertScopeToClaims() {",
        "                    var claims = new frJava.ArrayList();",
        "",
        "                    scopes.toArray().forEach(function (scope) {",
        "                        if (String(scope) !== 'openid' && scopeClaimsMap[scope]) {",
        "                            scopeClaimsMap[scope].forEach(function (claimName) {",
        "                                claims.add(new frJava.Claim(claimName));",
        "                            });",
        "                        }",
        "                    });",
        "",
        "                    return claims;",
        "                }",
        "",
        "                var claims = new frJava.ArrayList();",
        "",
        "                claims.addAll(convertScopeToClaims());",
        "                claims.addAll(claimObjects);",
        "                claims.addAll(requestedTypedClaims);",
        "",
        "                return claims;",
        "            }",
        "",
        "            /**",
        "             * Computes and returns a claim value.",
        "             * To obtain the claim value, uses the resolver function specified for the claim in the claimResolvers configuration object.",
        "             * @see claimResolvers",
        "             * If no resolver function is found, uses the default claim resolver function.",
        "             *",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {*} Claim value.",
        "             * @throws {org.forgerock.oauth2.core.exceptions.InvalidRequestException}",
        "             * Rethrows this exception if a claim resolver throws it.",
        "             * You can throw org.forgerock.oauth2.core.exceptions.InvalidRequestException from your custom claim resolver",
        "             * if you want to terminate the claim processing.",
        "             */",
        "            function computeClaim(claim) {",
        "                var resolveClaim;",
        "                var message;",
        "",
        "                try {",
        "                    resolveClaim = claimResolvers[claim.getName()] || resolveAnyClaim;",
        "",
        "                    return resolveClaim(claim);",
        "                } catch (e) {",
        "                    message = 'OIDC Claims script exception. Unable to resolve OIDC Claim. ' + e;",
        "",
        "                    if (String(e).indexOf('org.forgerock.oauth2.core.exceptions.InvalidRequestException') !== -1) {",
        "                        throw e;",
        "                    }",
        "",
        "                    if (logger.warningEnabled()) {",
        "                        logger.warning(message);",
        "                    }",
        "                }",
        "            }",
        "",
        "            var computedClaims = new frJava.LinkedHashMap();",
        "",
        "            getClaims().toArray().forEach(function (claim) {",
        "                var claimValue = computeClaim(claim);",
        "",
        "                if (isClaimValueValid(claimValue)) {",
        "                    computedClaims.put(claim.getName(), claimValue);",
        "                } else {",
        "                    /**",
        "                     * If a claim has been processed, but appears in the list again,",
        "                     * and its value cannot be computed under the new conditions,",
        "                     * the claim is removed from the final result.",
        "                     *",
        "                     * For example, a claim could be mapped to a scope and found in the user profile,",
        "                     * but also requested by the client with required values that don't match the computed one.",
        "                     * @see {link https://openid.net/specs/openid-connect-core-1_0.html#IndividualClaimsRequests}.",
        "                     * for the relevant OIDC specification details.",
        "                     */",
        "                    computedClaims.remove(claim.getName());",
        "                }",
        "            });",
        "",
        "            return computedClaims;",
        "        }",
        "",
        "        /**",
        "         * Creates a map of requested scopes and the corresponding claim names.",
        "         * @returns {java.util.LinkedHashMap}",
        "         */",
        "        function getCompositeScopes () {",
        "            var compositeScopes = new frJava.LinkedHashMap();",
        "",
        "            scopes.toArray().forEach(function (scope) {",
        "                var scopeClaims = new frJava.ArrayList();",
        "",
        "                if (scopeClaimsMap[scope]) {",
        "                    scopeClaimsMap[scope].forEach(function (claimName) {",
        "                        scopeClaims.add(claimName);",
        "                    });",
        "                }",
        "",
        "                if (scopeClaims.size()) {",
        "                    compositeScopes.put(scope, scopeClaims);",
        "                }",
        "            });",
        "",
        "            return compositeScopes;",
        "        }",
        "",
        "        // PUBLIC METHODS",
        "",
        "        return {",
        "            setScopeClaimsMap: setScopeClaimsMap,",
        "            setClaimResolvers: setClaimResolvers,",
        "            getUserProfileClaimResolver: getUserProfileClaimResolver,",
        "            getAddressClaimResolver: getAddressClaimResolver,",
        "            getEssentialClaimResolver: getEssentialClaimResolver,",
        "            getUserInfoClaims: getUserInfoClaims",
        "        };",
        "    }",
        "",
        "    // RESULTS",
        "",
        "    /**",
        "     * This script returns an instance of the org.forgerock.oauth2.core.UserInfoClaims class",
        "     * populated with the computed claim values and",
        "     * the requested scopes mapped to the claim names.",
        "     * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html}.",
        "     *",
        "     * Assigning it to a variable gives you an opportunity",
        "     * to log the content of the returned value during development.",
        "     */",
        "    var userInfoClaims = utils.getUserInfoClaims();",
        "",
        "    /*",
        "    logger.error(scriptName + ' results:')",
        "    logger.error('Values: ' + userInfoClaims.getValues())",
        "    logger.error('Scopes: ' + userInfoClaims.getCompositeScopes())",
        "    */",
        "",
        "    return userInfoClaims;",
        "}());",
        "",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./OTP-Invalid.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "89eff37a-2e1e-47c2-8d62-5f7417fbb6b4": {
      "_id": "89eff37a-2e1e-47c2-8d62-5f7417fbb6b4",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Return TextOutputCallback indicating the provided OTP was invalid.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "OTP Invalid",
      "script": [
        "/* OTP Invalid",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Return TextOutputCallback indicating the provided OTP was invalid.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "outcome = "true";",
        "var fr = JavaImporter(",
        "    org.forgerock.openam.auth.node.api.Action,",
        "    javax.security.auth.callback.TextOutputCallback",
        ")",
        "if (callbacks.isEmpty()) {",
        "    action = fr.Action.send(",
        "        new fr.TextOutputCallback(",
        "            fr.TextOutputCallback.INFORMATION,",
        "            "INVALID"",
        "        )",
        "    ).build()",
        "}",
        "else {",
        "  action = fr.Action.goTo(outcome).build();",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./OTP-Valid.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "5dbd53c6-67ff-4a43-84c3-90c5cf5da35a": {
      "_id": "5dbd53c6-67ff-4a43-84c3-90c5cf5da35a",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Return TextOutputCallback indicating the provided OTP was valid.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "OTP Valid",
      "script": [
        "/* OTP Valid",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Return TextOutputCallback indicating the provided OTP was valid.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "outcome = "true";",
        "var fr = JavaImporter(",
        "    org.forgerock.openam.auth.node.api.Action,",
        "    javax.security.auth.callback.TextOutputCallback",
        ")",
        "if (callbacks.isEmpty()) {",
        "    action = fr.Action.send(",
        "        new fr.TextOutputCallback(",
        "            fr.TextOutputCallback.INFORMATION,",
        "            "VALID"",
        "        )",
        "    ).build()",
        "}",
        "else {",
        "  action = fr.Action.goTo(outcome).build();",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Okta-API-AuthN.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "2eb48a0c-24e0-4dac-acaf-02085c142ec5": {
      "_id": "2eb48a0c-24e0-4dac-acaf-02085c142ec5",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Integration to Okta Authentication API okta_url/api/v1/authn",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Okta API AuthN",
      "script": [
        "/* Okta Passthru Authentication",
        " *",
        " * Authors: chico.demettroff@forgerock.com, volker.scheuber@forgerock.com",
        " * ",
        " * Okta pass through authentication using Okta Authentication API.",
        " * ",
        " * This script needs to be parametrized. It will not work properly as is. ",
        " * It requires the Platform Username and Platform Password collector nodes",
        " * before it can operate.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - Success",
        " * - Failure",
        " * - Timeout",
        " * - Error",
        " */",
        "logger.message("Okta Passthru Authentication: start");",
        "",
        "if (sharedState.get("username") && transientState.get("password")) {",
        "      /*",
        "     * BEGIN SCRIPT CONFIGURATION",
        "     *",
        "     * REPLACE WITH YOUR OWN OKTA TENANT SETTINGS",
        "     *",
        "     */",
        "    var OKTA_API_URI = "https://dev-18030933.okta.com/api/v1/authn/";",
        "    /*",
        "     * END SCRIPT CONFIGURATION",
        "     */",
        "",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setMethod('POST');",
        "    request.setUri(OKTA_API_URI);",
        "    request.getHeaders().add("Content-Type", "application/json");",
        "      //var body =     "{\\"username\\":".concat(sharedState.get("username")).concat(",\\"password\\":").concat(transientState.get("password")).concat(",\\"options\\":{\\"multiOptionalFactorEnroll\\":true,\\"warnBeforePasswordExpired\\":true}}");",
        "    var body = {",
        "        "username": sharedState.get("username"),",
        "        "password": transientState.get("password"),",
        "        "options": {",
        "            "multiOptionalFactorEnroll": true,",
        "            "warnBeforePasswordExpired": true",
        "        }",
        "    }",
        "      request.getEntity().setJson(body);",
        "",
        "    var response = httpClient.send(request).get();",
        "    var result = JSON.parse(response.getEntity().getString());",
        "    logger.message("Okta Passthru Authentication: JSON result: " + JSON.stringify(result));",
        "",
        "      if (response.getStatus().getCode() === 200 && result.status === "SUCCESS") {",
        "          outcome = "Success"",
        "        transientState.put("oktaProfile", result._embedded.user.profile);",
        "    } else {",
        "        /* Outcomes:",
        "         * - Success",
        "         * - Failure",
        "         * - Timeout",
        "         * - Error",
        "         *",
        "         * Expected/known Error Codes:",
        "         * E0000004 - Authentication failed.",
        "         * E0000003 - The request body was not well-formed",
        "         */",
        "      ",
        "    /*",
        "{",
        "    "expiresAt": "2021-10-14T22:15:04.000Z",",
        "    "status": "SUCCESS",",
        "    "sessionToken": "20111FNVseT3WyCzBHFBi3dYtx980FHen46QKlWXRNTe1kRef3GQu1W",",
        "    "_embedded": {",
        "        "user": {",
        "            "id": "00u1xqw851dEqM1Y15d7",",
        "            "passwordChanged": "2021-09-21T18:26:25.000Z",",
        "            "profile": {",
        "                "login": "chico@crossfithighvoltage.com",",
        "                "firstName": "chico",",
        "                "lastName": "deme",",
        "                "locale": "en",",
        "                "timeZone": "America/Los_Angeles"",
        "            }",
        "        }",
        "    },",
        "    "_links": {",
        "        "cancel": {",
        "            "href": "https://dev-18030933.okta.com/api/v1/authn/cancel",",
        "            "hints": {",
        "                "allow": [",
        "                    "POST"",
        "                ]",
        "            }",
        "        }",
        "    }",
        "}",
        "*/",
        "",
        "  /*",
        "  FAILED",
        "  {",
        "    "errorCode": "E0000004",",
        "    "errorSummary": "Authentication failed",",
        "    "errorLink": "E0000004",",
        "    "errorId": "oae1Y3Kk_WvRAOBSDeG9qeyHQ",",
        "    "errorCauses": []",
        "}",
        "*/",
        "        transientState.put("oktaResult", result);",
        "        if (result.timed_out) {",
        "            outcome = "Timeout";",
        "        } else if (result.errorCode === "E0000004") {",
        "            outcome = "Failure";",
        "        } else {",
        "            outcome = "Error";",
        "        }",
        "        logger.message("Okta Passthru Authentication: errorCode = ".concat(result.errorCode));",
        "        logger.message("Okta Passthru Authentication: errorSummary = ".concat(result.errorSummary));",
        "        logger.message("Okta Passthru Authentication: errorId = ".concat(result.errorId));",
        "    }",
        "} else {",
        "      outcome = "Error";",
        "      logger.message("Okta Passthru Authentication: No user or password found in shared state! Use username and password collector nodes before this script to populate shared and transient states!'");",
        "}",
        "logger.message("Okta Passthru Authentication: End (outcome=".concat(outcome).concat(")"));",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Okta-Profile-Normalization.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "6325cf19-a49b-471e-8d26-7e4df76df0e2": {
      "_id": "6325cf19-a49b-471e-8d26-7e4df76df0e2",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Normalizes raw profile data from GitHub",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Okta Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2022 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "logger.warning("Okta rawProfile: "+rawProfile)",
        "",
        "return json(object(",
        "        field("id", rawProfile.id),",
        "        field("displayName", rawProfile.name),",
        "        field("givenName", rawProfile.first_name),",
        "        field("familyName", rawProfile.last_name),",
        "        field("photoUrl", rawProfile.picture.data.url),",
        "        field("email", rawProfile.email),",
        "        field("username", rawProfile.preferred_username)))",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Onfido-CaptureEvidence.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "71545db5-ce01-46b1-b79f-d41af36bd548": {
      "_id": "71545db5-ce01-46b1-b79f-d41af36bd548",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Capture Evidence",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Onfido-CaptureEvidence",
      "script": [
        "logger.error("Onfido-CaptureEvidence: Start");",
        "/*",
        " * !!! Extend your authentication session time so your identity proofing flows don't time out !!!",
        " *",
        " * Authentication > Settings > Trees > Max Duration (Minutes)",
        " *",
        " * Set to 15 minutes.",
        " *",
        " */",
        "",
        "/*",
        " * BEGIN SCRIPT CONFIGURATION",
        " */",
        "var onfido_auth_token = String(sharedState.get("onfidoAuthToken"));",
        "var onfido_dialog_title = "Join the Expanse family!";",
        "var onfido_dialog_msg1 = "To open an Expanse account, we will need to verify your identity.";",
        "var onfido_dialog_msg2 = "It will only take a couple of minutes.";",
        "var onfido_country_code = "US";",
        "/*",
        " * END SCRIPT CONFIGURATION",
        " */",
        "",
        "var mobile = idRepository.getAttribute(sharedState.get("_id"), "telephoneNumber");",
        "var smsNumber = "";",
        "if (mobile && mobile.iterator().hasNext()) {",
        "    smsNumber = String(mobile.iterator().next().toString());",
        "}",
        "",
        "// Inject Onfido SDK into login page",
        "onfidoScript = String("var body=document.body;\\n" +",
        "    "var script = document.createElement('script');\\n" +",
        "    "document.getElementById('callbacksPanel').style.display = 'none';\\n" +",
        "    "var onfido_div = document.createElement(\\"div\\");\\n" +",
        "    "onfido_div.id=\\"onfido-mount\\";\\n" +",
        "    "script.src = 'https://assets.onfido.com/web-sdk-releases/5.2.1/onfido.min.js';\\n" +",
        "    "var head = document.head; \\n " +",
        "    "var link = document.createElement(\\"link\\");  \\n" +",
        "    "     link.type = \\"text/css\\"; \\n " +",
        "    "     link.rel = \\"stylesheet\\"; \\n " +",
        "    "     link.href = 'https://assets.onfido.com/web-sdk-releases/5.2.1/style.css'; \\n " +",
        "    "    head.appendChild(link); \\n " +",
        "    ";\\n" +",
        "    "var onfido = {};\\n" +",
        "    "script.onload=function() {\\n" +",
        "    "    onfido=Onfido.init({\\n" +",
        "    "       token: '" + onfido_auth_token + "', \\n" +",
        "    "       useModal: true, \\n" +",
        "    "       isModalOpen: true, \\n" +",
        "    "       smsNumberCountryCode: '" + onfido_country_code + "', \\n" +",
        "    "       userDetails: { \\n" +",
        "    "           smsNumber: '" + smsNumber + "' \\n" +",
        "    "       }, \\n" +",
        "    "       steps: [\\n" +",
        "    "           {\\n" +",
        "    "               type:'welcome',\\n" +",
        "    "               options:{\\n" +",
        "    "                   title:'" + onfido_dialog_title + "',\\n" +",
        "    "                   descriptions:[\\n" +",
        "    "                       '" + onfido_dialog_msg1 + "',\\n" +",
        "    "                       '" + onfido_dialog_msg2 + "',\\n" +",
        "    "                   ]\\n" +",
        "    "               }\\n" +",
        "    "          },\\n" +",
        "    "          'document',\\n" +",
        "    "          'face',\\n" +",
        "    "          'complete',\\n" +",
        "    "       ],\\n" +",
        "    "       onComplete: function(data){ console.log('DONE'); onfido.setOptions({ isModalOpen:false }); document.getElementById('loginButton_0').click(); } \\n" +",
        "    "    })\\n" +",
        "    "};\\n" +",
        "    "document.body.appendChild(script);\\n");",
        "",
        "var fr = JavaImporter(",
        "    org.forgerock.openam.auth.node.api,",
        "    javax.security.auth.callback.NameCallback,",
        "    com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        ");",
        "",
        "with (fr) {",
        "    if (callbacks.isEmpty()) {",
        "        logger.error("Onfido-CaptureEvidence: Sending callbacks");",
        "        action = Action.send(new ScriptTextOutputCallback(onfidoScript)).build();",
        "    } else {",
        "        logger.error("Onfido-CaptureEvidence: End (outcome=true)");",
        "        action = Action.goTo("true").build();",
        "    }",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Onfido-CheckApplicant.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "d2a41d85-d33a-42d9-a7dd-50dfbc9fa7c0": {
      "_id": "d2a41d85-d33a-42d9-a7dd-50dfbc9fa7c0",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Check Applicant",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Onfido-CheckApplicant",
      "script": [
        "logger.error("Onfido-CheckApplicant: Start");",
        "",
        "/*",
        " * !!! Extend your authentication session time so your identity proofing flows don't time out !!!",
        " *",
        " * Authentication > Settings > Trees > Max Duration (Minutes)",
        " *",
        " * Set to 15 minutes.",
        " *",
        " */",
        "",
        "/*",
        " * BEGIN SCRIPT CONFIGURATION",
        " *",
        " * REPLACE WITH YOUR OWN ONFIDO API TOKEN",
        " */",
        "//var ONFIDO_API_TOKEN = "api_live.StUdfxdiCFb.YrzbadxB_R2-qG5lFUc3lWg6JAc3Cnq-"",
        "var ONFIDO_API_TOKEN = "api_live.H5ysRusAomY.nbbkimoWc91cDZAWJZkJt0Tkqdjm1Rjr";",
        "/*",
        " * END SCRIPT CONFIGURATION",
        " */",
        "",
        "var requestBodyJson = {",
        "    "applicant_id": String(sharedState.get("onfidoApplicantID")),",
        "    "report_names": ["document", "facial_similarity_photo"]",
        "}",
        "// var requestBodyJson = {",
        "//     "applicant_id": String(sharedState.get("onfidoApplicantID")),",
        "//     "report_names": ["document"]",
        "// }",
        "",
        "var failure = true",
        "",
        "var fr = JavaImporter(",
        "    org.forgerock.http.protocol.Request",
        ")",
        "",
        "var request = new fr.Request()",
        "request.setUri("https://api.onfido.com/v3/checks")",
        "request.setMethod("POST")",
        "request.getHeaders().add("Content-Type", "application/json; charset=UTF-8")",
        "request.getHeaders().add("Authorization", "Token token=" + ONFIDO_API_TOKEN)",
        "request.getEntity().setString(JSON.stringify(requestBodyJson))",
        "",
        "var response = httpClient.send(request).get()",
        "logger.error("Onfido-CheckApplicant: Initiate checks response: ".concat(response.getEntity().getString()));",
        "",
        "if (response.getStatus().getCode() === 200) {",
        "    var id = JSON.parse(response.getEntity().getString()).id",
        "    failure = !id",
        "    if (!failure) sharedState.put("onfidoAuthToken", id);",
        "} else {",
        "    failure = true",
        "}",
        "",
        "outcome = failure ? "false" : "true";",
        "logger.error("Onfido-CheckApplicant: End (outcome=".concat(outcome).concat(")"));",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Onfido-Meta-Tags.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "8a768bb3-01cd-46b8-881c-b77f5a26c283": {
      "_id": "8a768bb3-01cd-46b8-881c-b77f5a26c283",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Write Onfido HTML Meta Tags",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Onfido-Meta-Tags",
      "script": [
        "/* Write HTML Meta Tags",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * This script writes meta tags to the header.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "(function () {",
        "  var fr = JavaImporter(",
        "      org.forgerock.openam.auth.node.api.Action,",
        "      com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        "  )",
        "",
        "  function createScript() {",
        "    return String("\\n\\",
        "    Array.prototype.slice.call(\\n\\",
        "      document.getElementsByTagName('head')\\n\\",
        "    ).forEach(\\n\\",
        "      function (e) {\\n\\",
        "        var meta = document.createElement('meta'); \\n\\",
        "        meta.name = \\"author\\"; \\n\\",
        "        meta.content = \\"John Doe\\"; \\n\\",
        "        document.getElementsByTagName('head')[0].appendChild(meta); \\n\\",
        "      }\\n\\",
        "    )");",
        "  }",
        "",
        "  if (callbacks.isEmpty()) {",
        "      action = fr.Action.send(",
        "          new fr.ScriptTextOutputCallback(createScript())",
        "      ).build()",
        "  } else {",
        "      action = fr.Action.goTo("true").build();",
        "  }",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Phone-Validator-Line-Type.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "b63981d8-cb73-4e47-8749-e58654dcaa31": {
      "_id": "b63981d8-cb73-4e47-8749-e58654dcaa31",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "This script uses phonevalidator.com to determine the type of phone number stored in the user profile.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Phone Validator - Line Type",
      "script": [
        "/* Phone Validator - Line Type",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * This script uses phonevalidator.com to determine the type of phone number stored in the user profile.",
        " * Get your own API Key at https://www.phonevalidator.com",
        " * ",
        " * This script needs to be parametrized. It will not work properly as is. ",
        " * It requires the Identify Existing User node before it is being called.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - CELL PHONE",
        " * - LANDLINE",
        " * - VOIP",
        " * - TOLL-FREE",
        " * - UNKNOWN",
        " * - failed",
        " */",
        "logger.warning("Phone Validator - Line Type: start");",
        "",
        "if (getSharedObjectAttribute("telephoneNumber") || (sharedState.get("_id") && idRepository.getAttribute(sharedState.get("_id"), "telephoneNumber").iterator().hasNext())) {",
        "",
        "    /* BEGIN SCRIPT CONFIGURATION",
        "     *",
        "     * REPLACE WITH YOUR OWN AZURE AD SETTINGS",
        "     *",
        "       * Phone Validator - Line Type API Configuration",
        "       * Get your own API Key at https://www.phonevalidator.com",
        "     */",
        "    var PV_API_KEY = "849d564a-594d-4bde-b691-afe5ddadd547";",
        "    /*",
        "     * END SCRIPT CONFIGURATION",
        "     */",
        "",
        "      var PV_API_TYPE = "basic";",
        "    var PV_API_PHONE = getSharedObjectAttribute("telephoneNumber") || idRepository.getAttribute(sharedState.get("_id"), "telephoneNumber").iterator().next();",
        "    var PV_API_URI = "https://www.phonevalidator.com/api/v2/phonesearch?apikey=".concat(PV_API_KEY).concat("&phone=").concat(PV_API_PHONE).concat("&type=").concat(PV_API_TYPE);    ",
        "",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setMethod('GET');",
        "    request.setUri(PV_API_URI);",
        "",
        "    var response = httpClient.send(request).get();",
        "    var result = JSON.parse(response.getEntity().getString());",
        "",
        "    if (result["StatusCode"]=="200") {",
        "        outcome = result["PhoneBasic"]["LineType"];",
        "    } else {",
        "        outcome = "failed";",
        "    }",
        "    logger.error("Phone Validator - Line Type: StatusCode = ".concat(result["StatusCode"]));",
        "    logger.error("Phone Validator - Line Type: StatusMessage = ".concat(result["StatusMessage"]));",
        "    logger.error("Phone Validator - Line Type: outcome = ".concat(outcome));",
        "} else {",
        "      outcome = "failed";",
        "      logger.error("Phone Validator - Line Type: No user or phone number found! Use 'Identify Existing User node before this script to populate the user's _id in shared state or put a valid cell phone number into sharedState.objectAttributes.telephoneNumber!'");",
        "    logger.error("Phone Validator - Line Type: outcome = ".concat(outcome));",
        "}",
        "",
        "/*",
        " * Read attributes in shared state for use with the Create/Patch Object nodes.",
        " */",
        "function getSharedObjectAttribute(name) {",
        "    var storage = sharedState.get("objectAttributes");",
        "    if (storage) {",
        "          if (storage.get) {",
        "            return sharedState.get("objectAttributes").get(name);",
        "        }",
        "          else {",
        "            return storage.name;",
        "        }",
        "    }",
        "    return null;",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Populate-Username-From-Email.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "4855aac0-1efd-49c0-a153-3b9aadc911a6": {
      "_id": "4855aac0-1efd-49c0-a153-3b9aadc911a6",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Populate Username From Email",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Populate Username From Email",
      "script": [
        "outcome = "true";",
        "",
        "sharedState.put("username", getSharedObjectAttribute("mail"))",
        "setSharedObjectAttribute("userName", getSharedObjectAttribute("mail"))",
        "",
        "/*",
        " * Store attributes in shared state for use with the Create/Patch Object nodes.",
        " */",
        "function setSharedObjectAttribute(name, value) {",
        "       var storage = sharedState.get("objectAttributes");",
        "    if (storage && value) {",
        "          if (storage.put) {",
        "              storage.put(name, value);",
        "        }",
        "          else {",
        "              storage[name] = value;",
        "        }",
        "    }",
        "    else if (value) {",
        "        sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "    }",
        "}",
        "",
        "/*",
        " * Read attributes in shared state for use with the Create/Patch Object nodes.",
        " */",
        "function getSharedObjectAttribute(name) {",
        "    var storage = sharedState.get("objectAttributes");",
        "    if (storage) {",
        "          if (storage.get) {",
        "            return sharedState.get("objectAttributes").get(name);",
        "        }",
        "          else {",
        "              return storage.name;",
        "        }",
        "    }",
        "    return null;",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Ready-Response.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "1acc5535-13e2-4ed8-83e1-f4fefd86d243": {
      "_id": "1acc5535-13e2-4ed8-83e1-f4fefd86d243",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Readiness probe response",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Ready Response",
      "script": [
        "/* Ready Response",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Return READY in a TextOutputCallback indicating that the journey layer is operational.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "outcome = "true";",
        "var fr = JavaImporter(",
        "    org.forgerock.openam.auth.node.api.Action,",
        "    javax.security.auth.callback.TextOutputCallback",
        ")",
        "if (callbacks.isEmpty()) {",
        "    action = fr.Action.send(",
        "        new fr.TextOutputCallback(",
        "            fr.TextOutputCallback.INFORMATION,",
        "            "READY"",
        "        )",
        "    ).build()",
        "}",
        "else {",
        "  action = fr.Action.goTo(outcome).build();",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Record-MFA.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "a873fcd8-8f17-4675-9dd6-54ab1c11e2df": {
      "_id": "a873fcd8-8f17-4675-9dd6-54ab1c11e2df",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Record that MFA has been performed for this journey and no longer needs to be performed. This allows journeys and inner journeys to check that flag before performing MFA multiple times.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Record MFA",
      "script": [
        "/* MFA Status",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Record that MFA has been performed for this journey and no longer needs ",
        " * to be performed. This allows journeys and inner journeys to check that ",
        " * flag before performing MFA multiple times.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "outcome = "true";",
        "sharedState.put("mfaPerformed", "true");",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Remove-Button.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "9535446c-0ff6-4a76-8576-616599119d64": {
      "_id": "9535446c-0ff6-4a76-8576-616599119d64",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Remove button from page.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Remove Button",
      "script": [
        "/* Remove Button",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Hide buttons on the journey page.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "(function () {",
        "    var script = "Array.prototype.slice.call(document.getElementsByTagName('button')).forEach(function (e) {e.style.display = 'none'})"",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "        javax.security.auth.callback.TextOutputCallback,",
        "        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        "    )",
        "    var message = " "",
        "    if (callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "            new fr.TextOutputCallback(",
        "                fr.TextOutputCallback.INFORMATION,",
        "                message",
        "            ),",
        "            new fr.ScriptTextOutputCallback(script)",
        "        ).build()",
        "    }",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Remove-Button-imported-(1).script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "3814d347-a2f2-4be9-a810-ab41a1e374bd": {
      "_id": "3814d347-a2f2-4be9-a810-ab41a1e374bd",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Hide buttons on the journey page.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Remove Button - imported (1)",
      "script": [
        "/* Remove Button",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Hide buttons on the journey page.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "(function () {",
        "    var script = "Array.prototype.slice.call(document.getElementsByTagName('button')).forEach(function (e) {e.style.display = 'none'})"",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "        javax.security.auth.callback.TextOutputCallback,",
        "        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        "    )",
        "    var message = " "",
        "    if (callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "            new fr.TextOutputCallback(",
        "                fr.TextOutputCallback.INFORMATION,",
        "                message",
        "            ),",
        "            new fr.ScriptTextOutputCallback(script)",
        "        ).build()",
        "    }",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Resend-OTP-Option.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "4ee5b182-1b09-45cc-97a9-0e609f0a2915": {
      "_id": "4ee5b182-1b09-45cc-97a9-0e609f0a2915",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Resend OTP Option",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Resend OTP Option",
      "script": [
        "/* CResend OTP Option",
        " *",
        " * Author: jon.knight@forgerock.com, volker.scheuber@forgerock.com",
        " * ",
        " * Collect OTP and validate the collected OTP. Also offer a resend option.",
        " * Return "true" if collected OTP is valid, "false" if collected OTP is invalid, ",
        " * and resend if the user selected the resend button.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * - false",
        " * - resend",
        " */",
        "(function () {",
        "  // how long until the "resend" button becomes enabled.",
        "  DELAY=20;",
        "  ",
        "  // how long (in seconds) should the OTP be accepted as valid",
        "  OTP_TTL = 30;",
        "",
        "  var fr = JavaImporter(",
        "      org.forgerock.openam.auth.node.api.Action,",
        "      javax.security.auth.callback.NameCallback,",
        "      com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        "  )",
        "",
        "  function createScript() {",
        "      return String(" \\n\\",
        "          var COUNT = " + DELAY + "; \\n\\",
        "          function go(obs) { \\n\\",
        "              const p = document.querySelectorAll('input[data-vv-as=\\"One Time Passcode\\"]')[0]; \\n\\",
        "              if (p) { \\n\\",
        "                  var b = document.createElement('button'); \\n\\",
        "                  b.id = 'resendButton'; \\n\\",
        "                  b.classList.add(\\"btn\\", \\"mt-3\\", \\"btn-secondary\\", \\"btn-sm\\"); \\n\\",
        "                  b.onclick = function() { p.value='___RESEND___'; p.dispatchEvent(new Event('input')); }; \\n\\",
        "                  b.innerHTML = 'Resend Code ... ' + COUNT + 's'; \\n\\",
        "                  b.disabled = true; \\n\\",
        "                  p.parentNode.insertBefore(b, p.nextSibling); \\n\\",
        "                  var t = setInterval(function() { \\n\\",
        "                      if (COUNT == 1) { \\n\\",
        "                          clearInterval(t); \\n\\",
        "                          b.disabled = false; \\n\\",
        "                          b.innerHTML = 'Resend Code'; \\n\\",
        "                      } else { \\n\\",
        "                          COUNT--; \\n\\",
        "                          b.innerHTML = 'Resend Code ... ' + COUNT + 's'; \\n\\",
        "                      } \\n\\",
        "                  }, 1000 ); \\n\\",
        "                  if (obs) obs.disconnect(); \\n\\",
        "                  return; \\n\\",
        "              } \\n\\",
        "          } \\n\\",
        "          if (document.querySelectorAll('input[data-vv-as=\\"One Time Passcode\\"]')[0]) go(); \\n\\",
        "          else { \\n\\",
        "              const observer = new MutationObserver((mutations, obs) => { go(obs); }); \\n\\",
        "              observer.observe(document, { childList: true, subtree: true }); \\n\\",
        "          } \\n\\",
        "      ");",
        "  }",
        "",
        "  if (callbacks.isEmpty()) {",
        "      action = fr.Action.send(",
        "          new fr.ScriptTextOutputCallback(createScript()),",
        "          new fr.NameCallback("One Time Passcode")",
        "      ).build()",
        "  } else {",
        "      var otpTimestamp = Math.floor(new java.util.Date().getTime() / 1000);",
        "      var otp = callbacks.get(1).getName();",
        "      if (otp === "___RESEND___") {",
        "          action = fr.Action.goTo("resend").build();",
        "      } else {",
        "          var sentOtp = sharedState.get("oneTimePassword");",
        "          var sentOtpTimestamp = sharedState.get("oneTimePasswordTimestamp");",
        "          if (sentOtp == otp && otpTimestamp - OTP_TTL >= sentOtpTimestamp) {",
        "              action = fr.Action.goTo("true").build();",
        "            }",
        "          else {",
        "            action = fr.Action.goTo("false").build();",
        "          }",
        "      }",
        "  }",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Reset-Theme.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "199405e4-050e-4f2a-87d1-d9125f74a8df": {
      "_id": "199405e4-050e-4f2a-87d1-d9125f74a8df",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Reset theme to what's preserved in shared state variable "theme-id" or to default theme.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Reset Theme",
      "script": [
        "/* Reset Theme",
        " * ",
        " * Reset theme to what's preserved in shared state variable "themeId" or to default theme.",
        " * ",
        " * This script needs to be parametrized!",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "      /* Begin Script Configuration */",
        "      var defaultTheme = "Expanse";",
        "      /* End Script Configuration */",
        "      ",
        "      outcome = "true";",
        "      ",
        "      var theme = defaultTheme;",
        "      if (sharedState.get("themeId") && ""+sharedState.get("themeId") !== "") {",
        "          theme = sharedState.get("themeId");",
        "    }",
        "",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "        org.forgerock.openam.authentication.callbacks.PollingWaitCallback",
        "    )",
        "    if (callbacks.isEmpty()) {",
        "        var stage = "themeId="+theme;",
        "        action = fr.Action.send(",
        "              new fr.PollingWaitCallback("100", "Please wait ...")",
        "        ).withStage(stage).build();",
        "    } else {",
        "          action = fr.Action.goTo(outcome).build();",
        "    }",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./ResetPasswordReplayCredentials.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "a8f10e93-3f6c-4d6c-b6a3-a8453e3d6b3a": {
      "_id": "a8f10e93-3f6c-4d6c-b6a3-a8453e3d6b3a",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Reset the attributes holding replay credentials for the IG replay use case.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "ResetPasswordReplayCredentials",
      "script": [
        "/* ResetPasswordReplayCredentials",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Reset the attributes holding replay credentials for the IG replay use case.",
        " * ",
        " * This script needs to be parametrized for your env.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "(function () {",
        "  outcome = "true";",
        "  var REPLAY_USERNAME_IDM_ATTR = "frUnindexedString1";",
        "  var REPLAY_PASSWORD_IDM_ATTR = "frUnindexedString2";",
        "  ",
        "  sharedState.get("objectAttributes").put(REPLAY_USERNAME_IDM_ATTR, null);",
        "  sharedState.get("objectAttributes").put(REPLAY_PASSWORD_IDM_ATTR, null);",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Return-OTP.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "d3405f9c-d338-4dc2-b00d-7aacf77b731d": {
      "_id": "d3405f9c-d338-4dc2-b00d-7aacf77b731d",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Return the generated OTP using a TextOutputCallback",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Return OTP",
      "script": [
        "/* Return OTP",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Return the generated OTP using a TextOutputCallback.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "outcome = "true";",
        "var fr = JavaImporter(",
        "    org.forgerock.openam.auth.node.api.Action,",
        "    javax.security.auth.callback.TextOutputCallback",
        ")",
        "if (callbacks.isEmpty()) {",
        "    action = fr.Action.send(",
        "        new fr.TextOutputCallback(",
        "            fr.TextOutputCallback.INFORMATION,",
        "            nodeState.get("oneTimePassword").asString()",
        "        )",
        "    ).build()",
        "}",
        "else {",
        "  action = fr.Action.goTo(outcome).build();",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Routed-IDP-Persist-Decision.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "5b553f58-16bd-42b7-a782-4a981a66dbd4": {
      "_id": "5b553f58-16bd-42b7-a782-4a981a66dbd4",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Branch based on the IDP setting.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Routed IDP Persist Decision",
      "script": [
        "/* Routed IDP Persist Decision",
        " * ",
        " * Branch based on the IDP setting.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * - false",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "      logger.message("Routed IDP Persist Decision: Start");",
        "      outcome = "false";",
        "      var routedIDP = sharedState.get("routedIDPs").get(0);",
        "      if (routedIDP) {",
        "        outcome = "".concat(routedIDP.get("idpPersist"));",
        "    }",
        "      logger.message("Routed IDP Persist Decision: Done [outcome={}]", outcome);",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./ST_healthcare-idc-social-transformation.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "d2cf4f18-651a-4a3c-9b04-ee4fc896d0c3": {
      "_id": "d2cf4f18-651a-4a3c-9b04-ee4fc896d0c3",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Social Identity Provider Profile Transformation for ForgeRock OIDC Providers",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "ST_healthcare-idc-social-transformation",
      "script": [
        "/*",
        " * Copyright 2022 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock. Not for production use.",
        " * Modified by Stephen Payne",
        " */",
        "/* Social Identity Provider Profile Transformation script for Healthcare ID Cloud */",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "logger.error("ST_healthcare-idc-social-transformation Healthcare ID Cloud Identity Provider Profile Transformation script: Start");",
        "",
        "logger.error("ST_healthcare-idc-social-transformation Profile Transformation script: Start");",
        "logger.error("ST_healthcare-idc-social-transformationy: givenName " + rawProfile.givenName);",
        "logger.error("ST_healthcare-idc-social-transformation: sn: " +rawProfile.familyName);",
        "logger.error("ST_healthcare-idc-social-transformation: id: " +rawProfile.id);",
        "logger.error("ST_healthcare-idc-social-transformation: mail: " + rawProfile.email);",
        "logger.error("ST_healthcare-idc-social-transformation: cn: " + rawProfile.displayName);",
        "logger.error("ST_healthcare-idc-social-transformation: userName: " + rawProfile.username);",
        "logger.error("ST_healthcare-idc-social-transformation: id: " + rawProfile.id.asString());",
        "//logger.error("ST_healthcare-idc-social-transformation: iplanet-am-user-alias-list: " + selectedIdp + '-' + rawProfile.id.asString() );",
        "//logger.error("ST_healthcare-idc-social-transformation: selectedIdp: " + selectedIdp);",
        "if (rawProfile.fhirUser.isNotNull()) logger.error("ST_healthcare-idc-social-transformation: fhirUser: " + rawProfile.fhirUser);",
        "if (rawProfile.IAL.isNotNull()) logger.error("ST_healthcare-idc-social-transformatio: IAL: " + rawProfile.IAL);",
        "",
        "",
        "",
        "",
        "return json(object(",
        "        field("id", rawProfile.sub),",
        "        field("displayName", rawProfile.name),",
        "        field("givenName", rawProfile.given_name),",
        "        field("familyName", rawProfile.family_name),",
        "        field("email", rawProfile.email),",
        "        field("username", rawProfile.email),",
        "        field("IAL", rawProfile.IAL),  ",
        "        field("telephoneNumber", rawProfile.phone_number),",
        "        field("fhirUser", rawProfile.fhirUser),",
        "        field("userType", rawProfile.userType),",
        "        )",
        ")",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Salesforce-Profile-Normalization.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "312e951f-70c5-49d2-a9ae-93aef909d5df": {
      "_id": "312e951f-70c5-49d2-a9ae-93aef909d5df",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from Salesforce",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Salesforce Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "return json(object(",
        "        field("id", rawProfile.user_id),",
        "        field("displayName", rawProfile.name),",
        "        field("givenName", rawProfile.given_name),",
        "        field("familyName", rawProfile.family_name),",
        "        field("photoUrl", rawProfile.picture),",
        "        field("email", rawProfile.email),",
        "        field("username", rawProfile.email),",
        "        field("locale", rawProfile.zoneInfo)))",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Saml2-IDP-Adapter-Always-Auth.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "85523e71-2d77-4577-b078-6f9674cc54e2": {
      "_id": "85523e71-2d77-4577-b078-6f9674cc54e2",
      "context": "SAML2_IDP_ADAPTER",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Always redirect browser pre-auth",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Saml2 IDP Adapter Always Auth",
      "script": [
        "/*",
        " * Copyright 2021-2022 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        " * The script has these top level functions that could be executed during a SAML2 flow.",
        " *      - preSingleSignOn",
        " *      - preAuthentication",
        " *      - preSendResponse",
        " *      - preSignResponse",
        " *      - preSendFailureResponse",
        " *",
        " * Please see the javadoc for the interface definition and more information about these methods.",
        " * https://backstage.forgerock.com/docs/am/7.2/apidocs/com/sun/identity/saml2/plugins/SAML2IdentityProviderAdapter.html",
        " * Note that the initialize method is not supported in the scripts.",
        " *",
        " * Defined variables. Check the documentation on the respective functions for the variables available to it.",
        " *",
        " * hostedEntityId - String",
        " *     Entity ID for the hosted IDP",
        " * realm - String",
        " *     Realm of the hosted IDP",
        " * idpAdapterScriptHelper - IdpAdapterScriptHelper (1)",
        " *     An instance of IdpAdapterScriptHelper containing helper methods. See Javadoc for more details.",
        " * request - HttpServletRequest (2)",
        " *     Servlet request object",
        " * response - HttpServletResponse (3)",
        " *     Servlet response object",
        " * authnRequest - AuthnRequest (4)",
        " *     The original authentication request sent from SP",
        " * reqId - String",
        " *     The id to use for continuation of processing if the adapter redirects",
        " * res - Response (5)",
        " *     The SAML Response",
        " * session - SSOToken (6)",
        " *     The single sign-on session. The reference type of this is Object and would need to be casted to SSOToken.",
        " * relayState - String",
        " *     The relayState that will be used in the redirect",
        " * faultCode - String",
        " *     the fault code that will be returned in the SAML response",
        " * faultDetail - String",
        " *     the fault detail that will be returned in the SAML response",
        " * logger - Logger instance",
        " *     https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.",
        " *     Corresponding log files will be prefixed with: scripts.<script name>",
        " *",
        " * Throws SAML2Exception (7):",
        " *     for any exceptions occurring in the adapter. The federation process will continue",
        " *",
        " * Class reference:",
        " * (1) idpAdapterScriptHelper - https://backstage.forgerock.com/docs/am/7.2/apidocs/com/sun/identity/saml2/plugins/scripted/IdpAdapterScriptHelper.html.",
        " * (2) HttpServletRequest - https://tomcat.apache.org/tomcat-7.0-doc/servletapi/javax/servlet/http/HttpServletRequest.html.",
        " * (3) HttpServletResponse - https://tomcat.apache.org/tomcat-7.0-doc/servletapi/javax/servlet/http/HttpServletResponse.html.",
        " * (4) AuthnRequest - https://backstage.forgerock.com/docs/am/7.2/apidocs/com/sun/identity/saml2/protocol/AuthnRequest.html.",
        " * (5) Response - https://backstage.forgerock.com/docs/am/7.2/apidocs/com/sun/identity/saml2/protocol/Response.html.",
        " * (6) SSOToken - https://backstage.forgerock.com/docs/am/7.2/apidocs/com/iplanet/sso/SSOToken.html.",
        " * (7) SAML2Exception - https://backstage.forgerock.com/docs/am/7.2/apidocs/com/sun/identity/saml2/common/SAML2Exception.html.",
        " */",
        "",
        "/*",
        " * Template/default script for SAML2 IDP Adapter scripted plugin.",
        " */",
        "",
        "/*",
        " * Available variables for preSingleSignOn:",
        " *     hostedEntityId",
        " *     realm",
        " *     idpAdapterScriptHelper",
        " *     request",
        " *     authnRequest",
        " *     response",
        " *     reqId",
        " *     logger",
        " *",
        " * Return - true if browser redirection is happening after processing, false otherwise. Default to false.",
        " */",
        "function preSingleSignOn () {",
        "      logger.error("Chicago: preSingleSignOn");",
        "    return true;",
        "}",
        "",
        "/*",
        " * Available variables for preAuthentication:",
        " *     hostedEntityId",
        " *     realm",
        " *     idpAdapterScriptHelper",
        " *     request",
        " *     authnRequest",
        " *     response",
        " *     reqId",
        " *     session",
        " *     relayState",
        " *     logger",
        " *",
        " * Return - true if browser redirection is happening after processing, false otherwise. Default to false.",
        " */",
        "function preAuthentication () {",
        "      logger.error("Chicago: preAuthentication");",
        "    return true;",
        "}",
        "",
        "/*",
        " * Available variables for preSendResponse:",
        " *     hostedEntityId",
        " *     realm",
        " *     idpAdapterScriptHelper",
        " *     request",
        " *     authnRequest",
        " *     response",
        " *     reqId",
        " *     session",
        " *     relayState",
        " *     logger",
        " *",
        " * Return - true if browser redirection happened after processing, false otherwise. Default to false.",
        " */",
        "function preSendResponse () {",
        "      logger.error("Chicago: preSendResponse");",
        "      logger.error("Chicago: authnRequest: "+authnRequest);",
        "      response.sendRedirect("https://idc.scheuber.io/am/XUI/?realm=alpha&authIndexType=service&authIndexValue=Dispatcher&ForceAuth=true&goto="+relayState);",
        "    return true;",
        "}",
        "",
        "/*",
        " * Available variables for preSignResponse:",
        " *     hostedEntityId",
        " *     realm",
        " *     idpAdapterScriptHelper",
        " *     request",
        " *     authnRequest",
        " *     session",
        " *     relayState",
        " *     res",
        " *     logger",
        " */",
        "function preSignResponse () {",
        "      logger.error("Chicago: preSignResponse");",
        "}",
        "",
        "/*",
        " * Available variables for preSendFailureResponse:",
        " *     hostedEntityId",
        " *     realm",
        " *     idpAdapterScriptHelper",
        " *     request",
        " *     response",
        " *     faultCode",
        " *     faultDetail",
        " *     logger",
        " */",
        "function preSendFailureResponse () {",
        "      logger.error("Chicago: preSendFailureResponse");",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Saml2-IDP-Adapter-Script.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "5b29c5b7-b161-4a42-a41f-d6c85316b951": {
      "_id": "5b29c5b7-b161-4a42-a41f-d6c85316b951",
      "context": "SAML2_IDP_ADAPTER",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Saml2 IDP Adapter Script",
      "script": [
        "/*",
        " * Copyright 2021 ForgeRock AS. All Rights Reserved",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        " * The script has these top level functions that could be executed during a SAML2 flow.",
        " *      - preSingleSignOn",
        " *      - preAuthentication",
        " *      - preSendResponse",
        " *      - preSignResponse",
        " *      - preSendFailureResponse",
        " *",
        " * Please see the javadoc for the interface definition and more information about these methods.",
        " * https://backstage.forgerock.com/docs/am/7.2/apidocs/com/sun/identity/saml2/plugins/SAML2IdentityProviderAdapter.html",
        " * Note that the initialize method is not supported in the scripts.",
        " *",
        " * Defined variables. Check the documentation on the respective functions for the variables available to it.",
        " *",
        " * hostedEntityId - String",
        " *     Entity ID for the hosted IDP",
        " * realm - String",
        " *     Realm of the hosted IDP",
        " * idpAdapterScriptHelper - IdpAdapterScriptHelper (1)",
        " *     An instance of IdpAdapterScriptHelper containing helper methods. See Javadoc for more details.",
        " * request - HttpServletRequest (2)",
        " *     Servlet request object",
        " * response - HttpServletResponse (3)",
        " *     Servlet response object",
        " * authnRequest - AuthnRequest (4)",
        " *     The original authentication request sent from SP",
        " * reqId - String",
        " *     The id to use for continuation of processing if the adapter redirects",
        " * res - Response (5)",
        " *     The SAML Response",
        " * session - SSOToken (6)",
        " *     The single sign-on session. The reference type of this is Object and would need to be casted to SSOToken.",
        " * relayState - String",
        " *     The relayState that will be used in the redirect",
        " * faultCode - String",
        " *     the fault code that will be returned in the SAML response",
        " * faultDetail - String",
        " *     the fault detail that will be returned in the SAML response",
        " * logger - Logger instance",
        " *     https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.",
        " *     Corresponding log files will be prefixed with: scripts.<script name>",
        " *",
        " * Throws SAML2Exception (7):",
        " *     for any exceptions occurring in the adapter. The federation process will continue",
        " *",
        " * Class reference:",
        " * (1) idpAdapterScriptHelper - https://backstage.forgerock.com/docs/am/7.2/apidocs/com/sun/identity/saml2/plugins/scripted/IdpAdapterScriptHelper.html.",
        " * (2) HttpServletRequest - https://tomcat.apache.org/tomcat-7.0-doc/servletapi/javax/servlet/http/HttpServletRequest.html.",
        " * (3) HttpServletResponse - https://tomcat.apache.org/tomcat-7.0-doc/servletapi/javax/servlet/http/HttpServletResponse.html.",
        " * (4) AuthnRequest - https://backstage.forgerock.com/docs/am/7.2/apidocs/com/sun/identity/saml2/protocol/AuthnRequest.html.",
        " * (5) Response - https://backstage.forgerock.com/docs/am/7.2/apidocs/com/sun/identity/saml2/protocol/Response.html.",
        " * (6) SSOToken - https://backstage.forgerock.com/docs/am/7.2/apidocs/com/iplanet/sso/SSOToken.html.",
        " * (7) SAML2Exception - https://backstage.forgerock.com/docs/am/7.2/apidocs/com/sun/identity/saml2/common/SAML2Exception.html.",
        " */",
        "",
        "/*",
        " * Template/default script for SAML2 IDP Adapter scripted plugin.",
        " */",
        "",
        "/*",
        " * Available variables for preSingleSignOn:",
        " *     hostedEntityId",
        " *     realm",
        " *     idpAdapterScriptHelper",
        " *     request",
        " *     authnRequest",
        " *     response",
        " *     reqId",
        " *     logger",
        " *",
        " * Return - true if browser redirection is happening after processing, false otherwise. Default to false.",
        " */",
        "function preSingleSignOn () {",
        "    return false;",
        "}",
        "",
        "/*",
        " * Available variables for preAuthentication:",
        " *     hostedEntityId",
        " *     realm",
        " *     idpAdapterScriptHelper",
        " *     request",
        " *     authnRequest",
        " *     response",
        " *     reqId",
        " *     session",
        " *     relayState",
        " *     logger",
        " *",
        " * Return - true if browser redirection is happening after processing, false otherwise. Default to false.",
        " */",
        "function preAuthentication () {",
        "    return false;",
        "}",
        "",
        "/*",
        " * Available variables for preSendResponse:",
        " *     hostedEntityId",
        " *     realm",
        " *     idpAdapterScriptHelper",
        " *     request",
        " *     authnRequest",
        " *     response",
        " *     reqId",
        " *     session",
        " *     relayState",
        " *     logger",
        " *",
        " * Return - true if browser redirection happened after processing, false otherwise. Default to false.",
        " */",
        "function preSendResponse () {",
        "    return false;",
        "}",
        "",
        "/*",
        " * Available variables for preSignResponse:",
        " *     hostedEntityId",
        " *     realm",
        " *     idpAdapterScriptHelper",
        " *     request",
        " *     authnRequest",
        " *     session",
        " *     relayState",
        " *     res",
        " *     logger",
        " */",
        "function preSignResponse () {",
        "}",
        "",
        "/*",
        " * Available variables for preSendFailureResponse:",
        " *     hostedEntityId",
        " *     realm",
        " *     idpAdapterScriptHelper",
        " *     request",
        " *     response",
        " *     faultCode",
        " *     faultDetail",
        " *     logger",
        " */",
        "function preSendFailureResponse () {",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Saml2-IDP-Attribute-Mapper-Script.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "90c4eca5-05f0-42f5-b9bf-88b693eabbbd": {
      "_id": "90c4eca5-05f0-42f5-b9bf-88b693eabbbd",
      "context": "SAML2_IDP_ATTRIBUTE_MAPPER",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Saml2 IDP Attribute Mapper Script",
      "script": [
        "/*",
        " * Copyright 2021 ForgeRock AS. All Rights Reserved",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        " * This script returns a list of SAML Attribute objects for the IDP framework to insert into the generated Assertion.",
        " *",
        " * Defined variables:",
        " * session - SSOToken (1)",
        " *           The single sign-on session.",
        " * hostedEntityId - String (primitive).",
        " *                  The hosted entity ID.",
        " * remoteEntityId - String (primitive).",
        " *                  The remote entity ID.",
        " * realm - String (primitive).",
        " *         The name of the realm the user is authenticating to.",
        " * logger - Always present, the debug logger instance:",
        " *          https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.",
        " *          Corresponding log files will be prefixed with: scripts.SAML2_IDP_ATTRIBUTE_MAPPER",
        " * idpAttributeMapperScriptHelper - IdpAttributeMapperScriptHelper (2)",
        " *                                - An IdpAttributeMapperScriptHelper instance containing methods used for IDP attribute mapping.",
        " *",
        " * Throws SAML2Exception:",
        " *      - on failing to map the IDP attributes.",
        " *",
        " * Return - a list of SAML Attribute (3) objects.",
        " *",
        " * Class reference:",
        " * (1) SSOToken - https://backstage.forgerock.com/docs/am/7/apidocs/com/iplanet/sso/SSOToken.html.",
        " * (2) IdpAttributeMapperScriptHelper - https://backstage.forgerock.com/docs/am/7/apidocs/com/sun/identity/saml2/plugins/scripted/IdpAttributeMapperScriptHelper.html.",
        " * (3) Attribute - https://backstage.forgerock.com/docs/am/7/apidocs/com/sun/identity/saml2/assertion/Attribute.html.",
        " */",
        "",
        "/**",
        " * Default SAML2 IDP Attribute Mapper.",
        " */",
        "function getAttributes() {",
        "    var frJava = JavaImporter(",
        "        com.sun.identity.saml2.common.SAML2Exception",
        "    );",
        "",
        "    const debugMethod = "ScriptedIDPAttributeMapper.getAttributes:: ";",
        "",
        "    try {",
        "",
        "        if (!idpAttributeMapperScriptHelper.isSessionValid(session)) {",
        "            logger.error(debugMethod + "Invalid session.");",
        "            return null;",
        "        }",
        "",
        "        var configMap = idpAttributeMapperScriptHelper.getRemoteSPConfigAttributeMap(realm, remoteEntityId);",
        "        logger.message(debugMethod + "Remote SP attribute map = {}", configMap);",
        "        if (configMap == null || configMap.isEmpty()) {",
        "            configMap = idpAttributeMapperScriptHelper.getHostedIDPConfigAttributeMap(realm, hostedEntityId);",
        "            if (configMap == null || configMap.isEmpty()) {",
        "                logger.message(debugMethod + "Configuration map is not defined.");",
        "                return null;",
        "            }",
        "            logger.message(debugMethod + "Hosted IDP attribute map = {}", configMap);",
        "        }",
        "",
        "        var attributes = new java.util.ArrayList();",
        "        var stringValueMap = new java.util.HashSet();",
        "        var binaryValueMap;",
        "        var localAttribute;",
        "",
        "        // Don't try to read the attributes from the datastore if the ignored profile is enabled in this realm.",
        "        if (!idpAttributeMapperScriptHelper.isIgnoredProfile(session, realm)) {",
        "            try {",
        "                // Resolve attributes to be read from the datastore.",
        "                var stringAttributes = new java.util.HashSet();",
        "                var binaryAttributes = new java.util.HashSet();",
        "                var keyIter = configMap.keySet().iterator();",
        "                while (keyIter.hasNext()) {",
        "                    var key = keyIter.next();",
        "                    localAttribute = configMap.get(key);",
        "                    if (!idpAttributeMapperScriptHelper.isStaticAttribute(localAttribute)) {",
        "                        if (idpAttributeMapperScriptHelper.isBinaryAttribute(localAttribute)) {",
        "                            // add it to the list of attributes to treat as being binary",
        "                            binaryAttributes.add(idpAttributeMapperScriptHelper.removeBinaryAttributeFlag(localAttribute));",
        "                        } else {",
        "                            stringAttributes.add(localAttribute);",
        "                        }",
        "                    }",
        "                }",
        "",
        "                if (!stringAttributes.isEmpty()) {",
        "                    stringValueMap = idpAttributeMapperScriptHelper.getAttributes(session, stringAttributes);",
        "                }",
        "                if (!binaryAttributes.isEmpty()) {",
        "                    binaryValueMap = idpAttributeMapperScriptHelper.getBinaryAttributes(session, binaryAttributes);",
        "                }",
        "            } catch (error) {",
        "                logger.error(debugMethod + "Error accessing the datastore. " + error);",
        "                //continue to check in ssotoken.",
        "            }",
        "        }",
        "",
        "        var keyIter = configMap.keySet().iterator();",
        "        while (keyIter.hasNext()) {",
        "            var key = keyIter.next()",
        "            var nameFormat = null;",
        "            var samlAttribute = key;",
        "            localAttribute = configMap.get(key);",
        "            // check if samlAttribute has format nameFormat|samlAttribute",
        "            var samlAttributes = String(new java.lang.String(samlAttribute));",
        "            var tokens = samlAttributes.split('|');",
        "",
        "            if (tokens.length > 1) {",
        "                nameFormat = tokens[0];",
        "                samlAttribute = tokens[1];",
        "            }",
        "",
        "            var attributeValues = new java.util.HashSet();",
        "            if (idpAttributeMapperScriptHelper.isStaticAttribute(localAttribute)) {",
        "                // Remove the static flag before using it as the static value",
        "                localAttribute = idpAttributeMapperScriptHelper.removeStaticAttributeFlag(localAttribute);",
        "                attributeValues = new java.util.HashSet([localAttribute]);",
        "                logger.message(debugMethod + "Adding static value {} for attribute named {}", localAttribute, samlAttribute);",
        "            } else {",
        "                if (idpAttributeMapperScriptHelper.isBinaryAttribute(localAttribute)) {",
        "                    // Remove the flag as not used for lookup",
        "                    localAttribute = idpAttributeMapperScriptHelper.removeBinaryAttributeFlag(localAttribute);",
        "                    attributeValues = idpAttributeMapperScriptHelper.getBinaryAttributeValues(samlAttribute, localAttribute,",
        "                        binaryValueMap);",
        "                } else {",
        "                    if (stringValueMap != null && !stringValueMap.isEmpty()) {",
        "                        attributeValues = stringValueMap.get(localAttribute);",
        "                    } else {",
        "                        logger.message(debugMethod + "{} string value map was empty or null.", localAttribute);",
        "                    }",
        "                }",
        "",
        "                // If all else fails, try to get the value from the users ssoToken",
        "                if (attributeValues == null || attributeValues.isEmpty()) {",
        "                    logger.message(debugMethod + "User profile does not have value for {}, checking SSOToken.", localAttribute);",
        "                    attributeValues = new java.util.HashSet(idpAttributeMapperScriptHelper.getPropertySet(session, localAttribute));",
        "                }",
        "            }",
        "",
        "            if (attributeValues == null || attributeValues.isEmpty()) {",
        "                logger.message(debugMethod + "{} not found in user profile or SSOToken.", localAttribute);",
        "            } else {",
        "                attributes.add(idpAttributeMapperScriptHelper.createSAMLAttribute(samlAttribute, nameFormat, attributeValues));",
        "            }",
        "        }",
        "",
        "        return attributes;",
        "",
        "    } catch (error) {",
        "        logger.error(debugMethod + "Error mapping IDP attributes. " + error);",
        "        throw new frJava.SAML2Exception(error);",
        "    }",
        "}",
        "",
        "getAttributes();",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Sanitize-objectAttributes.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "a064f7b7-29c5-480b-ac09-d3d122829278": {
      "_id": "a064f7b7-29c5-480b-ac09-d3d122829278",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Sanitize objectAttributes",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Sanitize objectAttributes",
      "script": [
        "/*",
        "{",
        "    "userName": "sholmes",",
        "    "givenName": "Sherlock",",
        "    "sn": "Holmes",",
        "    "mail": "info918@06152alerts.security.org",",
        "    "telephoneNumber": ,",
        "    "postalAddress": "221B Baker Street",",
        "    "city": "London",",
        "    "stateProvince": ,",
        "    "postalCode": "NW1",",
        "    "country": "United States",",
        "    "preferences": {",
        "        "marketing": false,",
        "        "updates": true",
        "    }",
        "}",
        "*/",
        "logger.error("Sanitize objectAttributes: start");",
        "outcome = "true";",
        "var attrs = sharedState.get("objectAttributes");",
        "if (attrs) {",
        "  var keys = [",
        "    "userName",",
        "    "givenName",",
        "    "sn",",
        "    "mail",",
        "    "telephoneNumber",",
        "    "postalAddress",",
        "    "city",",
        "    "stateProvince",",
        "    "postalCode",",
        "    "country",",
        "    "frIndexedString2"",
        "  ]",
        "  keys.forEach(function (key) {",
        "    if (attrs.get(key) && attrs.get(key).toString() == "") {",
        "      logger.error("Sanitize objectAttributes: remove ".concat(key));",
        "      attrs.remove(key);",
        "    }",
        "  })",
        "}",
        "if (transientState.get("objectAttributes") && transientState.get("objectAttributes").get("password").toString() !== "") {",
        "  logger.error("Sanitize objectAttributes: preserve password in shared state");",
        "  setSharedObjectAttribute("password", transientState.get("objectAttributes").get("password").toString());",
        "}",
        "logger.error("Sanitize objectAttributes: end");",
        "",
        "/*",
        " * Properly set attributes in shared state for use with the Create/Patch Object nodes.",
        " */",
        "function setSharedObjectAttribute(name, value) {",
        "    if (sharedState.get("objectAttributes")) {",
        "        sharedState.get("objectAttributes").put(name, value);",
        "    }",
        "    else {",
        "        sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":"+value+"}"));",
        "    }",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Saverestore-perpetrator.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "5b3b2c47-0248-46f4-8a1c-8a495d249037": {
      "_id": "5b3b2c47-0248-46f4-8a1c-8a495d249037",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Save/restore perpetrator",
      "script": [
        "outcome = "true";",
        "if (sharedState.get("perpetrator"))",
        "{",
        "  sharedState.put("username", sharedState.get("perpetrator"));",
        "//  if (sharedState.get("objectAttributes")) {",
        "//    sharedState.remove("objectAttributes");",
        "//  }",
        "  sharedState.put("objectAttributes", {});",
        "}",
        "else",
        "{",
        "  sharedState.put("perpetrator", sharedState.get("username"));",
        "  if (sharedState.get("objectAttributes") && ",
        "      sharedState.get("objectAttributes").get("userName")) {",
        "    sharedState.get("objectAttributes").remove("userName");",
        "  }",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Scripted-Module-Client-Side.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "c827d2b4-3608-4693-868e-bbcf86bd87c7": {
      "_id": "c827d2b4-3608-4693-868e-bbcf86bd87c7",
      "context": "AUTHENTICATION_CLIENT_SIDE",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Default global script for client side Scripted Authentication Module",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Scripted Module - Client Side",
      "script": [
        "/*",
        " * Copyright 2016-2017 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "/* Default Authentication client side script to use as a template for new scripts */",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Scripted-Module-Server-Side.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "7e3d7067-d50f-4674-8c76-a3e13a810c33": {
      "_id": "7e3d7067-d50f-4674-8c76-a3e13a810c33",
      "context": "AUTHENTICATION_SERVER_SIDE",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Default global script for server side Scripted Authentication Module",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Scripted Module - Server Side",
      "script": [
        "/*",
        " * Copyright 2015-2017 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "var START_TIME = 9;  // 9am",
        "var END_TIME   = 17; // 5pm",
        "var longitude, latitude;",
        "var localTime;",
        "",
        "logger.message("Starting scripted authentication");",
        "logger.message("User: " + username);",
        "",
        "var userPostalAddress = getUserPostalAddress();",
        "logger.message("User address: " + userPostalAddress);",
        "",
        "getLongitudeLatitudeFromUserPostalAddress();",
        "getLocalTime();",
        "",
        "logger.message("Current time at the users location: " + localTime.getHours());",
        "if (localTime.getHours() < START_TIME || localTime.getHours() > END_TIME) {",
        "    logger.error("Login forbidden outside work hours!");",
        "    authState = FAILED;",
        "} else {",
        "    logger.message("Authentication allowed!");",
        "    authState = SUCCESS;",
        "}",
        "",
        "function getLongitudeLatitudeFromUserPostalAddress() {",
        "",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setUri("http://maps.googleapis.com/maps/api/geocode/json?address=" + encodeURIComponent(userPostalAddress));",
        "      request.setMethod("GET");",
        "      //the above URI has to be extended with an API_KEY if used in a frequent manner",
        "      //see documentation: https://developers.google.com/maps/documentation/geocoding/intro",
        "",
        "    var response = httpClient.send(request).get();",
        "    logResponse(response);",
        "",
        "    var geocode = JSON.parse(response.getEntity().getString());",
        "    var i;",
        "    for (i = 0; i < geocode.results.length; i++) {",
        "        var result = geocode.results[i];",
        "        latitude = result.geometry.location.lat;",
        "        longitude = result.geometry.location.lng;",
        "      ",
        "           logger.message("latitude:" + latitude + " longitude:" + longitude);",
        "    }",
        "}",
        "",
        "function getLocalTime() {",
        "",
        "    var now = new Date().getTime() / 1000;",
        "    var location = "location=" + latitude + "," + longitude;",
        "    var timestamp = "timestamp=" + now;",
        "        ",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setUri("https://maps.googleapis.com/maps/api/timezone/json?" + location + "&" + timestamp);",
        "      request.setMethod("GET");",
        "      //the above URI has to be extended with an API_KEY if used in a frequent manner",
        "      //see documentation: https://developers.google.com/maps/documentation/timezone/intro",
        "",
        "    var response = httpClient.send(request).get();",
        "    logResponse(response);",
        "",
        "    var timezone = JSON.parse(response.getEntity().getString());",
        "    var localTimestamp = parseInt(now) + parseInt(timezone.dstOffset) + parseInt(timezone.rawOffset);",
        "    localTime = new Date(localTimestamp*1000);",
        "}",
        "",
        "function getUserPostalAddress() {",
        "    var userAddressSet = idRepository.getAttribute(username, "postalAddress");",
        "    if (userAddressSet == null || userAddressSet.isEmpty()) {",
        "        logger.warning("No address specified for user: " + username);",
        "        return false;",
        "    }",
        "    return userAddressSet.iterator().next()",
        "}",
        "",
        "function logResponse(response) {",
        "    logger.message("User REST Call. Status: " + response.getStatus() + ", Body: " + response.getEntity().getString());",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Scripted-Policy-Condition.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "9de3eb62-f131-4fac-a294-7bd170fd4acb": {
      "_id": "9de3eb62-f131-4fac-a294-7bd170fd4acb",
      "context": "POLICY_CONDITION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Default global script for Scripted Policy Conditions",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Scripted Policy Condition",
      "script": [
        "/*",
        " * Copyright 2015-2017 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "/**",
        " * This is a Policy Condition example script. It demonstrates how to access a user's information,",
        " * use that information in external HTTP calls and make a policy decision based on the outcome.",
        " */",
        "",
        "var userAddress, userIP, resourceHost;",
        "",
        "if (validateAndInitializeParameters()) {",
        "",
        "    var countryFromUserAddress = getCountryFromUserAddress();",
        "    logger.message("Country retrieved from user's address: " + countryFromUserAddress);",
        "    var countryFromUserIP = getCountryFromUserIP();",
        "    logger.message("Country retrieved from user's IP: " + countryFromUserIP);",
        "    var countryFromResourceURI = getCountryFromResourceURI();",
        "    logger.message("Country retrieved from resource URI: " + countryFromResourceURI);",
        "",
        "    if (countryFromUserAddress === countryFromUserIP && countryFromUserAddress === countryFromResourceURI) {",
        "        logger.message("Authorization Succeeded");",
        "        responseAttributes.put("countryOfOrigin", [countryFromUserAddress]);",
        "        authorized = true;",
        "    } else {",
        "        logger.message("Authorization Failed");",
        "        authorized = false;",
        "    }",
        "",
        "} else {",
        "    logger.message("Required parameters not found. Authorization Failed.");",
        "    authorized = false;",
        "}",
        "",
        "/**",
        " * Use the user's address to lookup their country of residence.",
        " *",
        " * @returns {*} The user's country of residence.",
        " */",
        "function getCountryFromUserAddress() {",
        "",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setUri("http://maps.googleapis.com/maps/api/geocode/json?address=" + encodeURIComponent(userAddress));",
        "      request.setMethod("GET");",
        "",
        "    var response = httpClient.send(request).get();",
        "    logResponse(response);",
        "",
        "    var geocode = JSON.parse(response.getEntity().getString());",
        "    var i;",
        "    for (i = 0; i < geocode.results.length; i++) {",
        "        var result = geocode.results[i];",
        "        var j;",
        "        for (j = 0; j < result.address_components.length; i++) {",
        "            if (result.address_components[i].types[0] == "country") {",
        "                return result.address_components[i].long_name;",
        "            }",
        "        }",
        "    }",
        "}",
        "",
        "/**",
        " * Use the user's IP to lookup the country from which the request originated.",
        " *",
        " * @returns {*} The country from which the request originated.",
        " */",
        "function getCountryFromUserIP() {",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setUri("http://ip-api.com/json/" + userIP);",
        "      request.setMethod("GET");",
        "",
        "    var response = httpClient.send(request).get();",
        "    logResponse(response);",
        "",
        "    var result = JSON.parse(response.getEntity().getString());",
        "    if (result) {",
        "        return result.country;",
        "    }",
        "}",
        "",
        "/**",
        " * Use the requested resource's host name to lookup the country where the resource is hosted.",
        " *",
        " * @returns {*} The country in which the resource is hosted.",
        " */",
        "function getCountryFromResourceURI() {",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setUri("http://ip-api.com/json/" + encodeURIComponent(resourceHost));",
        "      request.setMethod("GET");",
        "",
        "    var response = httpClient.send(request).get();",
        "    logResponse(response);",
        "",
        "    var result = JSON.parse(response.getEntity().getString());",
        "    if (result) {",
        "        return result.country;",
        "    }",
        "}",
        "",
        "/**",
        " * Retrieve and validate the variables required to make the external HTTP calls.",
        " *",
        " * @returns {boolean} Will be true if validation was successful.",
        " */",
        "function validateAndInitializeParameters() {",
        "    var userAddressSet = identity.getAttribute("postalAddress");",
        "    if (userAddressSet == null || userAddressSet.isEmpty()) {",
        "        logger.warning("No address specified for user: " + username);",
        "        return false;",
        "    }",
        "    userAddress = userAddressSet.iterator().next();",
        "    logger.message("User address: " + userAddress);",
        "",
        "    if (!environment) {",
        "        logger.warning("No environment parameters specified in the evaluation request.");",
        "        return false;",
        "    }",
        "",
        "    var ipSet = environment.get("IP");",
        "    if (ipSet == null || ipSet.isEmpty()) {",
        "        logger.warning("No IP specified in the evaluation request environment parameters.");",
        "        return false;",
        "    }",
        "    userIP = ipSet.iterator().next();",
        "    logger.message("User IP: " + userIP);",
        "",
        "    if (!resourceURI) {",
        "        logger.warning("No resource URI specified.");",
        "        return false;",
        "    }",
        "    resourceHost = resourceURI.match(/^(.*:\\/\\/)(www\\.)?([A-Za-z0-9\\-\\.]+)(:[0-9]+)?(.*)$/)[3];",
        "    logger.message("Resource host: " + resourceHost);",
        "",
        "    return true;",
        "}",
        "",
        "function logResponse(response) {",
        "    logger.message("User REST Call. Status: " + response.getStatus() + ", Body: " + response.getEntity().getString());",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Select-Theme-by-Browser-Language.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "847aab1b-c739-4d64-b26c-180f96cba02b": {
      "_id": "847aab1b-c739-4d64-b26c-180f96cba02b",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Select and apply theme from based on the browser language in the request.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Select Theme by Browser Language",
      "script": [
        "/* Select Theme by Browser Language",
        " * ",
        " * Select and apply theme from based on the browser language in the request.",
        " * ",
        " * This script needs to be parametrized!",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    /******************************/",
        "    /* Begin Script Configuration */",
        "",
        "    // the script expects the themes to be named <baseTheme>_<language>, e.g. "Zardoz_en"",
        "    var baseTheme = "Zardoz";",
        "",
        "    // add all the language codes you want to support",
        "    var supportedLanguages = ["de", "en", "fr"];",
        "",
        "    // specify the default language to fall back on if the browser language is not a supported language",
        "    var defaultLanguage = "en";",
        "",
        "    /* End Script Configuration   */",
        "    /******************************/",
        "",
        "    outcome = "true";",
        "    var theme = getThemeByLanguage(baseTheme);",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "        org.forgerock.openam.authentication.callbacks.PollingWaitCallback",
        "    )",
        "    if (theme && callbacks.isEmpty()) {",
        "        var stage = "themeId=" + theme;",
        "        action = fr.Action.send(",
        "            new fr.PollingWaitCallback("100", "Please wait ...")",
        "        ).withStage(stage).build();",
        "    } else {",
        "        action = fr.Action.goTo(outcome).build();",
        "    }",
        "",
        "    /*",
        "     * Returns the name of the theme to select based on browser language",
        "     */",
        "    function getThemeByLanguage(theme) {",
        "        var languageHeader = getHeader("accept-language");",
        "        var language = languageHeader.split(';')[0].split(',')[0].split('-')[0];",
        "        if (supportedLanguages.indexOf(language) < 0) {",
        "            language = defaultLanguage;",
        "        }",
        "        return theme + "_" + language;",
        "    }",
        "",
        "    /*",
        "     * Returns the value of the requested header",
        "     */",
        "    function getHeader(headerName) {",
        "        return requestHeaders.get(headerName).get(0) + "";",
        "    }",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Select-Theme-from-URL.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "50cde102-d4b6-44c4-9ba7-8564af05ae08": {
      "_id": "50cde102-d4b6-44c4-9ba7-8564af05ae08",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Select and apply theme from query param in the request URL.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Select Theme from URL",
      "script": [
        "/* Select Theme from URL",
        " * ",
        " * Select and apply theme from query param in the request URL.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "      outcome = "true";",
        "      var theme = "";",
        "      if (requestParameters.get("themeId")) {",
        "          theme = requestParameters.get("themeId").get(0);",
        "    }",
        "",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "        org.forgerock.openam.authentication.callbacks.PollingWaitCallback",
        "    )",
        "    if (theme && callbacks.isEmpty()) {",
        "        var stage = "themeId="+theme;",
        "        action = fr.Action.send(",
        "              new fr.PollingWaitCallback("100", "Please wait ...")",
        "        ).withStage(stage).build();",
        "    } else {",
        "          action = fr.Action.goTo(outcome).build();",
        "    }",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Service-Account-Cluster-Internal-Requests-Only.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "58258c2d-46f3-4811-85c4-ea1476dd9cf4": {
      "_id": "58258c2d-46f3-4811-85c4-ea1476dd9cf4",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Service Account - Cluster Internal Requests Only",
      "script": [
        "",
        "try {",
        "  var clientIpAddresses = requestHeaders.get(new java.lang.String('x-forwarded-for'));",
        "  if (!clientIpAddresses) {",
        "    logger.message('No forwarded header; internal cluster request');",
        "    outcome = 'True'",
        "  } else {",
        "    logger.message('Forwarded header {}', clientIpAddresses);",
        "    outcome = 'False';",
        "  }",
        "} catch (e) {",
        "  logger.error('Service Account - Cluster Internal Requests Only - failed deducing header');",
        "  logger.error(e);",
        "  outcome = 'Error';",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Service-Account-JWT-Issuers.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "fff76556-2882-4109-a9a6-c42d546cfe57": {
      "_id": "fff76556-2882-4109-a9a6-c42d546cfe57",
      "context": "OAUTH2_SCRIPTED_JWT_ISSUER",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Service Account - JWT Issuers",
      "script": [
        "(function () {",
        "  var frJava = JavaImporter(",
        "    org.forgerock.oauth2.core.TrustedJwtIssuerConfig,",
        "    java.util.HashSet",
        "  );",
        "",
        "  with (frJava) {",
        "    var iss = idRepository.getIdentity(issuer);",
        "    if (iss == null) {",
        "      logger.message('No issuer found for: ' + issuer);",
        "      return null;",
        "    }",
        "    logger.message('Found issuer: ' + iss);",
        "",
        "    var accountStatus = iss.getAttributeValues('inetUserStatus');",
        "    if (!accountStatus || accountStatus.length === 0) {",
        "      logger.message('No inetUserStatus attribute in issuer');",
        "      return null;",
        "    } else if (accountStatus[0].toLowerCase() != 'active') {",
        "      logger.message('Issuer is not active');",
        "      return null;",
        "    }",
        "",
        "    var jwksAttrs = iss.getAttributeValues('fr-attr-jwks');",
        "    if (!jwksAttrs || jwksAttrs.length === 0) {",
        "      logger.message('No jwks attributes in issuer');",
        "      return null;",
        "    }",
        "",
        "    var jwkSet = jwksAttrs[0];",
        "    if (!jwkSet) {",
        "      logger.message('No jwk set in issuer');",
        "      return null;",
        "    }",
        "",
        "    var config = new TrustedJwtIssuerConfig(",
        "      issuer,",
        "      'sub',",
        "      'scope',",
        "      new HashSet([issuer]),",
        "      jwkSet,",
        "      null, null, null",
        "    );",
        "",
        "    return config;",
        "  }",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Service-Account-Token-Modification.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "3369037a-7a49-4aed-a1dc-7aab7608812b": {
      "_id": "3369037a-7a49-4aed-a1dc-7aab7608812b",
      "context": "OAUTH2_ACCESS_TOKEN_MODIFICATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Service Account - Token Modification",
      "script": [
        "(function () {",
        "  var fr = JavaImporter(",
        "    java.lang.String,",
        "    java.security.MessageDigest,",
        "    java.util.Arrays,",
        "    javax.crypto.Cipher,",
        "    javax.crypto.spec.SecretKeySpec,",
        "    org.forgerock.http.protocol.Request,",
        "    org.forgerock.http.protocol.Response,",
        "    org.forgerock.util.encode.Base64",
        "  );",
        "  ",
        "  var secret = 'FuwwVKpPER9tPSMYUiIkY7IaPzv85aGU';",
        "  ",
        "  function encrypt(str) {",
        "    try {",
        "      var key = new fr.String(secret).getBytes('UTF-8');",
        "      var sha = fr.MessageDigest.getInstance('SHA-256');",
        "      key = sha.digest(key);",
        "      key = fr.Arrays.copyOf(key, 32);",
        "      var secretKey = new fr.SecretKeySpec(key, 'AES');",
        "      var cipher = fr.Cipher.getInstance('AES/ECB/PKCS5Padding');",
        "      cipher.init(fr.Cipher.ENCRYPT_MODE, secretKey);",
        "      var finalBytes = cipher.doFinal(new fr.String(str).getBytes('UTF-8'));",
        "      return fr.Base64.encode(finalBytes);",
        "    } catch (e) {",
        "      logger.error('{}: failed to encrypt: {}', scriptName, e);",
        "      throw e;",
        "    }",
        "  }",
        "",
        "  function hasAmScope(scope) {",
        "    if (!scope) return false;",
        "    for (var i = 0; i < scope.length; i++) {",
        "      if (scope[i].indexOf('fr:am:') > -1) return true;",
        "    }",
        "    return false;",
        "  }",
        "",
        "  try {",
        "    var uri = 'http://am.fr-platform:80/am/json/authenticate?authIndexType=service&authIndexValue=FRServiceAccountInternal';",
        "    var requestParams = requestProperties.get('requestParams');",
        "",
        "    var scope = requestParams.get('scope');",
        "    if (!hasAmScope(scope)) {",
        "      logger.message('AM scope not requested');",
        "      return null;",
        "    }",
        "",
        "    var jwts = requestParams.get('assertion');",
        "    if (!jwts || jwts.isEmpty()) {",
        "      logger.message('No jwt assertion');",
        "      return null;",
        "    }",
        "",
        "    var jwt = jwts[0];",
        "    var uuid = identity.getAttribute('_id').iterator().next();",
        "",
        "    var request = new fr.Request();",
        "    request.getHeaders().add('authorization', 'svcacct ' + uuid + ' ' + jwt);",
        "    request.getHeaders().add('content-type', 'application/json');",
        "    request",
        "      .setUri(uri)",
        "      .setMethod('POST')",
        "      .setEntity('{}');",
        "",
        "    var response = httpClient.send(request).getOrThrow();",
        "    if (response.getStatus() === org.forgerock.http.protocol.Status.OK) {",
        "      var result = JSON.parse(response.getEntity().getString());",
        "      var encryptedTokenId = encrypt(result.tokenId);",
        "      accessToken.setField('sessionToken', encryptedTokenId);",
        "    } else {",
        "      logger.message('Failed to get session from service account tree (status: ' + response.getStatus() + ')');",
        "    }",
        "  } catch (e) {",
        "    throw ('Failed to modify service account token: ' + e);",
        "  }",
        "}());",
        "",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Service-Account-Verify-JWT.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "766ed2a6-29dd-4bd7-a60d-9eabbd63545c": {
      "_id": "766ed2a6-29dd-4bd7-a60d-9eabbd63545c",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Service Account - Verify JWT",
      "script": [
        "var fr = JavaImporter(",
        "  org.forgerock.util.Options,",
        "  org.forgerock.json.jose.jwk.JWKSet,",
        "  org.forgerock.json.jose.jws.SigningManager,",
        "  org.forgerock.json.jose.builders.JwtBuilderFactory,",
        "  org.forgerock.json.jose.jws.SignedJwt",
        ");",
        "",
        "var sm = new fr.SigningManager();",
        "",
        "function getJWKs(svcAcctId) {",
        "  var svcAcct = idRepository.getIdentity(svcAcctId);",
        "  if (svcAcct == null) {",
        "    logger.message('No service account found for {}', svcAcctId);",
        "    return null;",
        "  }",
        "  var jwksAttrs = svcAcct.getAttributeValues('fr-attr-jwks');",
        "  if (!jwksAttrs || jwksAttrs.length === 0) {",
        "    logger.message('No jwks attributes in issuer');",
        "    return null;",
        "  }",
        "  var jwkSet = jwksAttrs[0];",
        "  if (!jwkSet) {",
        "    logger.message('No jwk set in jwks attribute in issuer');",
        "    return null;",
        "  }",
        "  return fr.JWKSet.parse(jwkSet).getJWKsAsList();",
        "}",
        "",
        "outcome = (function () {",
        "  var authz = requestHeaders.get('authorization');",
        "  if (authz === null || authz.length === 0 || authz[0].indexOf('svcacct') !== 0) {",
        "    logger.message('No authorization header');",
        "    return 'False';",
        "  }",
        "",
        "  authz = authz[0].split(' ');",
        "  if (authz.length !== 3) {",
        "    logger.message('Bad authorization header length {}', authz.length);",
        "    return 'False';",
        "  }",
        "  var svcAcctId = authz[1];",
        "  var jwt = authz[2];",
        "  var signedJwt = new fr.JwtBuilderFactory().reconstruct(jwt, fr.SignedJwt);",
        "",
        "  var jwks = getJWKs(svcAcctId);",
        "  for (var i = 0; i < jwks.size(); i++) {",
        "    var verifier = sm.newVerificationHandler(jwks.get(i))",
        "    if (signedJwt.verify(verifier)) {",
        "      nodeState.putShared("username", svcAcctId);",
        "      return 'True';",
        "    }",
        "  }",
        "",
        "  logger.message('Could not verify jwt');",
        "  return 'False';",
        "})();",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Set-OATH-Theme.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "f2107949-22f8-46c4-865d-ae1d1110a9cb": {
      "_id": "f2107949-22f8-46c4-865d-ae1d1110a9cb",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Detect and preserve currently active theme before setting the new theme.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Set OATH Theme",
      "script": [
        "/* Set OATH Theme",
        " * ",
        " * Detect and preserve currently active theme before setting the new theme.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "      outcome = "true";",
        "      ",
        "      var theme = "Expanse_OATH";",
        "",
        "    // do not change, must be a random identifier",
        "    var anchor = generateNumericToken('xxx');",
        "  ",
        "      var script = "";",
        "    script += "document.getElementById(\\"theme-id-"+anchor+"\\").value = localStorage.getItem('theme-id');";",
        "    script += "console.log('theme-id='+document.getElementById(\\"theme-id-"+anchor+"\\").value);";",
        "      script += "document.getElementById(\\"loginButton_0\\").click();";",
        "",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "          org.forgerock.openam.authentication.callbacks.PollingWaitCallback,",
        "        com.sun.identity.authentication.callbacks.HiddenValueCallback,",
        "        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        "    )",
        "    // discover active theme from UI",
        "    if (callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "            new fr.HiddenValueCallback("theme-id-"+anchor, "false"),",
        "            new fr.ScriptTextOutputCallback(script)",
        "        ).build();",
        "    }",
        "      // get active theme from callback and set new theme",
        "      else if (callbacks.size() === 2) {",
        "        // did we get the id of the currently active theme?",
        "        if (callbacks.get(0).getValue() !== "theme-id-"+anchor) {",
        "              sharedState.put("themeId", callbacks.get(0).getValue());",
        "        }",
        "        // set new theme",
        "        var stage = "themeId="+theme;",
        "        action = fr.Action.send(",
        "              new fr.PollingWaitCallback("0", "Please wait ...")",
        "        ).withStage(stage).build();",
        "    }",
        "      else {",
        "        // continue",
        "        action = fr.Action.goTo(outcome).build();",
        "    }",
        "",
        "     /*",
        "      * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "      * ",
        "      * Example:",
        "      * 'xxxxx' produces '28535'",
        "      * 'xxx-xxx' produces '432-521'",
        "      */",
        "    function generateNumericToken(format) {",
        "        return format.replace(/[x]/g, function(c) {",
        "            var r = Math.random()*10|0;",
        "            var v = r;",
        "            return v.toString(10);",
        "        });",
        "    }",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Set-Theme.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "76421cb0-0550-43e7-89f8-51ad1d95d306": {
      "_id": "76421cb0-0550-43e7-89f8-51ad1d95d306",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Detect and preserve currently active theme before setting the new theme.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Set Theme",
      "script": [
        "/* Set Theme",
        " * ",
        " * Detect and preserve currently active theme before setting the new theme.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "      outcome = "true";",
        "      ",
        "      var theme = "Expanse_MFA";",
        "",
        "    // do not change, must be a random identifier",
        "    var anchor = generateNumericToken('xxx');",
        "  ",
        "      var script = "";",
        "    script += "document.getElementById(\\"theme-id-"+anchor+"\\").value = localStorage.getItem('theme-id');";",
        "    script += "console.log('theme-id='+document.getElementById(\\"theme-id-"+anchor+"\\").value);";",
        "      script += "document.getElementById(\\"loginButton_0\\").click();";",
        "",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "          org.forgerock.openam.authentication.callbacks.PollingWaitCallback,",
        "        com.sun.identity.authentication.callbacks.HiddenValueCallback,",
        "        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        "    )",
        "    // discover active theme from UI",
        "    if (callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "            new fr.HiddenValueCallback("theme-id-"+anchor, "false"),",
        "            new fr.ScriptTextOutputCallback(script)",
        "        ).build();",
        "    }",
        "      // get active theme from callback and set new theme",
        "      else if (callbacks.size() === 2) {",
        "        // did we get the id of the currently active theme?",
        "        if (callbacks.get(0).getValue() !== "theme-id-"+anchor) {",
        "              sharedState.put("themeId", callbacks.get(0).getValue());",
        "        }",
        "        // set new theme",
        "        var stage = "themeId="+theme;",
        "        action = fr.Action.send(",
        "              new fr.PollingWaitCallback("100", "Please wait ...")",
        "        ).withStage(stage).build();",
        "    }",
        "      else {",
        "        // continue",
        "        action = fr.Action.goTo(outcome).build();",
        "    }",
        "",
        "     /*",
        "      * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "      * ",
        "      * Example:",
        "      * 'xxxxx' produces '28535'",
        "      * 'xxx-xxx' produces '432-521'",
        "      */",
        "    function generateNumericToken(format) {",
        "        return format.replace(/[x]/g, function(c) {",
        "            var r = Math.random()*10|0;",
        "            var v = r;",
        "            return v.toString(10);",
        "        });",
        "    }",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Setup-MFA-Choice.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "f26cc0de-ee31-4114-8a32-27799bb49357": {
      "_id": "f26cc0de-ee31-4114-8a32-27799bb49357",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Setup MFA Choice",
      "script": [
        "/*",
        " * Adapt the configuration values below",
        " */",
        "",
        "// do not change, must be a random identifier",
        "var anchor = generateNumericToken('xxx');",
        "",
        "// specify the horizontal alignment of the message: left, center, right",
        "var halign = "center";",
        "",
        "// specify the style to apply to the button in the message to make it look like a link",
        "var linkButtonStyle = "border: 0; color: #109CF1; text-decoration: none; background-color: transparent;";",
        "",
        "// specify the link button HTML element. only modify the text between the <button> and </button> tags.",
        "var linkButton = "<button id=\\"skip-link-".concat(anchor).concat("\\" type=\\"submit\\" style=\\"").concat(linkButtonStyle).concat("\\">skip for now.</button>");",
        "",
        "// specify the message you want to display and place the linkButton anywhere",
        "var message = "Please select your prefered factor or".concat(linkButton);",
        "",
        "// specify the choices you want to offer the user.",
        "var choices = ["SMS","Fido","Push"];",
        "",
        "// specify the default choice. this setting must be a valid 0-based index of the choices array above.",
        "var defaultChoice = 0;",
        "",
        "/*",
        " * All the configuration values are above this comment.",
        " *",
        " * DO NOT MAKE ANY CHANGES BELOW!",
        " */",
        "",
        "// find the TextOutputCallback with the message_anchor",
        "// and replace the message_anchor with the message",
        "var displayMessageScript = "".concat(",
        "  "Array.prototype.slice.call(\\n").concat(",
        "  "  document.getElementsByClassName('callback-component')\\n").concat(",
        "  ").forEach(\\n").concat(",
        "  "  function (e) {\\n").concat(",
        "  "    var message = e.firstElementChild;\\n").concat(",
        "  "    if (message.firstChild && message.firstChild.nodeName == '#text' && message.firstChild.nodeValue.trim() == 'message-").concat(anchor).concat("') {\\n").concat(",
        "  "      message.align = \\"").concat(halign).concat("\\";\\n").concat(",
        "  "      message.innerHTML = '").concat(message).concat("';\\n").concat(",
        "  "    }\\n").concat(",
        "  "  }\\n").concat(",
        "  ")")",
        "",
        "// hijack the link button in the message and:",
        "// - find the HiddenValueCallback and set its value to "Skip"",
        "// - then simulate a login button click",
        "var skipOptionScript = "".concat(",
        "  "document.getElementById(\\"skip-link-").concat(anchor).concat("\\").onclick = function(){\\n").concat(",
        "  "  document.getElementById(\\"skip-input-").concat(anchor).concat("\\").value = \\"Skip\\";\\n").concat(",
        "  "  document.getElementById(\\"loginButton_0\\").click();\\n").concat(",
        "  "  return false;\\n").concat(",
        "  "}")",
        "",
        "var fr = JavaImporter(",
        "    org.forgerock.openam.auth.node.api.Action,",
        "    javax.security.auth.callback.ConfirmationCallback,",
        "    javax.security.auth.callback.TextOutputCallback,",
        "    com.sun.identity.authentication.callbacks.HiddenValueCallback,",
        "    com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        ")",
        "",
        "if (callbacks.isEmpty()) {",
        "    action = fr.Action.send(",
        "        new fr.TextOutputCallback(",
        "            fr.TextOutputCallback.INFORMATION,",
        "            "message-".concat(anchor)",
        "        ),",
        "        new fr.ConfirmationCallback(",
        "            fr.ConfirmationCallback.INFORMATION,",
        "            choices,",
        "            defaultChoice",
        "        ),",
        "        new fr.HiddenValueCallback("skip-input-".concat(anchor), "false"),",
        "        new fr.ScriptTextOutputCallback(displayMessageScript),",
        "        new fr.ScriptTextOutputCallback(skipOptionScript)",
        "    ).build()",
        "}",
        "else {",
        "  // did the user skip?",
        "  if (callbacks.get(2).getValue() == "Skip") {",
        "    action = fr.Action.goTo("Skip").build();",
        "  }",
        "  // user didn't skip, pick the right outcome",
        "  else {",
        "    action = fr.Action.goTo(choices[callbacks.get(1).getSelectedIndex()]).build();",
        "  }",
        "}",
        "",
        " /*",
        "  * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "  * ",
        "  * Example:",
        "  * 'xxxxx' produces '28535'",
        "  * 'xxx-xxx' produces '432-521'",
        "  */",
        "function generateNumericToken(format) {",
        "    return format.replace(/[x]/g, function(c) {",
        "        var r = Math.random()*10|0;",
        "        var v = r;",
        "        return v.toString(10);",
        "    });",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Show-Password-Policy.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "021e434f-89b6-45fb-9d67-5147bc1650c3": {
      "_id": "021e434f-89b6-45fb-9d67-5147bc1650c3",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Show Password Policy",
      "script": [
        "var output = true;",
        "var anchor = "anchor-".concat(generateNumericToken('xxx'));",
        "var halign = "left";",
        "var message = "<ul><li>Must be at least 8 characters long</li>".concat(",
        "    "<li>Must be less than 64 characters long</li>").concat(",
        "    "<li>Must not share characters with email, username, first name, last name</li>").concat(",
        "    "<li>Must have at least 1 lowercase letter(s)</li>").concat(",
        "    "<li>Must have at least 1 capital letter(s)</li>").concat(",
        "    "<li>Must have at least 1 number(s)</li>").concat(",
        "    "<li>Must have at least 1 symbol(s)</li></ul>")",
        "var script = "Array.prototype.slice.call(\\n".concat(",
        "  "document.getElementsByClassName('callback-component')).forEach(\\n").concat(",
        "  "function (e) {\\n").concat(",
        "  "  var message = e.firstElementChild;\\n").concat(",
        "  "  if (message.firstChild && message.firstChild.nodeName == '#text' && message.firstChild.nodeValue.trim() == '").concat(anchor).concat("') {\\n").concat(",
        "  "    message.className = \\"text-left\\";\\n").concat(",
        "  "    message.align = \\"").concat(halign).concat("\\";\\n").concat(",
        "  "    message.innerHTML = '").concat(message).concat("';\\n").concat(",
        "  "  }\\n").concat(",
        "  "})")",
        "var fr = JavaImporter(",
        "    org.forgerock.openam.auth.node.api.Action,",
        "    javax.security.auth.callback.TextOutputCallback,",
        "    com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        ")",
        "if (message.length && callbacks.isEmpty()) {",
        "    action = fr.Action.send(",
        "        new fr.TextOutputCallback(",
        "            fr.TextOutputCallback.INFORMATION,",
        "            anchor",
        "        ),",
        "        new fr.ScriptTextOutputCallback(script)",
        "    ).build()",
        "}",
        "else {",
        "  action = fr.Action.goTo("true").build();",
        "}",
        "",
        " /*",
        "  * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "  * ",
        "  * Example:",
        "  * 'xxxxx' produces '28535'",
        "  * 'xxx-xxx' produces '432-521'",
        "  */",
        "function generateNumericToken(format) {",
        "    return format.replace(/[x]/g, function(c) {",
        "        var r = Math.random()*10|0;",
        "        var v = r;",
        "        return v.toString(10);",
        "    });",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Social-Identity-Provider-Profile-Transformation-Script.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "1d475815-72cb-42eb-aafd-4026989d28a7": {
      "_id": "1d475815-72cb-42eb-aafd-4026989d28a7",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Default global script for Social Identity Provider Profile Transformation",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Social Identity Provider Profile Transformation Script",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/* Default Social Identity Provider Profile Transformation script to use as a template for new scripts */",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./TimeStamp_Login.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "b3824c66-2dff-4613-9e54-4a7577fdb765": {
      "_id": "b3824c66-2dff-4613-9e54-4a7577fdb765",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Places a timestamp in the frIndexedMultivalued1 attribute",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "TimeStamp_Login",
      "script": [
        "/*",
        "  - Data made available by nodes that have already executed are available in the sharedState variable.",
        "  - The script should set outcome to either "true" or "false".",
        " */",
        "",
        "",
        "//var timestamps = sharedState.get("objectAttributes").get("frIndexedMultivalued1");",
        "",
        "",
        "var lastLogin = new Date();",
        "/*",
        "var datetime = ""+ currentdate.getDate() + "/"",
        "                + (currentdate.getMonth()+1)  + "/" ",
        "                + currentdate.getFullYear() + " @ "  ",
        "                + currentdate.getHours() + ":"  ",
        "                + currentdate.getMinutes() + ":" ",
        "                + currentdate.getSeconds();",
        "*/",
        "",
        "var objectAttributes = sharedState.get("objectAttributes");",
        "",
        "",
        "sharedState.put("last Login",lastLogin.toString());",
        "",
        "",
        "",
        "",
        "",
        "objectAttributes.put("frUnindexedString1",lastLogin.toString());",
        "",
        "",
        "sharedState.put("objectAttributes",objectAttributes);",
        "",
        "",
        "outcome = "true";",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Twilio-IVR:-Goodbye-Message.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "849ef5f3-7481-4607-a668-f0b5bf47db4c": {
      "_id": "849ef5f3-7481-4607-a668-f0b5bf47db4c",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Goodbye Message",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Twilio IVR: Goodbye Message",
      "script": [
        "/* Twilio IVR: Goodbye Message",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * ",
        " * Depending on the amount of data collected through callbacks and how many of the callParams",
        " * you activate below, you will need to change your authentication session from JWT to CTS or",
        " * Memory.",
        " */",
        "logger.warning("Twilio IVR: Goodbye Message: start");",
        "outcome = "true";",
        "",
        "/* Begin Configuration",
        " */",
        "",
        "// Build out the full message",
        "var message = "Thank you for calling ForgeRock Identity Cloud. Goodbye!";",
        "",
        "/* End Configuration",
        " */",
        "",
        "var fr = JavaImporter(",
        "      org.forgerock.openam.auth.node.api,",
        "      javax.security.auth.callback.TextOutputCallback",
        ");",
        "  ",
        "with (fr) {",
        "      if (callbacks.isEmpty()) {",
        "        var output = new TextOutputCallback(TextOutputCallback.INFORMATION, message);",
        "        action = Action.send(output).build();",
        "      } ",
        "      else {",
        "        logger.warning("Twilio IVR: Goodbye Message: finish [outcome=".concat(outcome).concat("]"));",
        "        action = Action.goTo(outcome).build();",
        "      }",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Twilio-IVR:-Greet-Verified-Caller.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "be6f1f2c-30ee-41fb-9e1e-8da72267fad3": {
      "_id": "be6f1f2c-30ee-41fb-9e1e-8da72267fad3",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Greet verified caller",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Twilio IVR: Greet Verified Caller",
      "script": [
        "/* Twilio IVR: Greet Verified Caller",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * ",
        " * Depending on the amount of data collected through callbacks and how many of the callParams",
        " * you activate below, you will need to change your authentication session from JWT to CTS or",
        " * Memory.",
        " */",
        "outcome = "true";",
        "",
        "/* Begin Configuration",
        " */",
        "",
        "// For ID Cloud use "_id", for classic deployments use "username"",
        "var userid = sharedState.get("_id")",
        "",
        "// Configure how you would like to address the verified caller. The default is the full name.",
        "var name = [idRepository.getAttribute(userid, "givenName").iterator().next(), idRepository.getAttribute(userid, "sn").iterator().next()].join(" ");",
        "",
        "// Build out the full message",
        "var message = ["Hello", name, "! How can I help you today?"].join(" ");",
        "",
        "/* End Configuration",
        " */",
        "",
        "var fr = JavaImporter(",
        "      org.forgerock.openam.auth.node.api,",
        "      javax.security.auth.callback.TextOutputCallback",
        ");",
        "  ",
        "with (fr) {",
        "      if (callbacks.isEmpty()) {",
        "        var output = new TextOutputCallback(TextOutputCallback.INFORMATION, message);",
        "        action = Action.send(output).build();",
        "      } ",
        "      else {",
        "        action = Action.goTo(outcome).build();",
        "      }",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Twilio-IVR:-Parse-Call-Parameters.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "7dce8f07-d9fe-4752-94b9-ff99dfd0433b": {
      "_id": "7dce8f07-d9fe-4752-94b9-ff99dfd0433b",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Parse parameters of the incoming call.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Twilio IVR: Parse Call Parameters",
      "script": [
        "/* Twilio IVR Integration",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * - false",
        " * ",
        " * Depending on the amount of data collected through callbacks and how many of the callParams",
        " * you activate below, you will need to change your authentication session from JWT to CTS or",
        " * Memory.",
        " */",
        "",
        "logger.warning("Twilio IVR: Parse Call Parameters: start");",
        "outcome = "false";",
        "",
        "/* Begin Twilio IVR Configuration Parameters",
        " *",
        " * These are used to protect this journey so it is only being executed by your Twilio account.",
        " */",
        "var TWILIO_ACCOUNT_SID = "AC750415e3163a2e57b7aeea7eed82d944";",
        "var TWILIO_PHONE_NUMBER = "+13176443107";",
        "",
        "// keep the params to a minimum to minimize authentication session size",
        "var callParams = {",
        "  //"CallSid" : decodeURIComponent(requestParameters.get("CallSid").get(0)),",
        "  "AccountSid" : decodeURIComponent(requestParameters.get("AccountSid").get(0)),",
        "  "From" : decodeURIComponent(requestParameters.get("From").get(0)),",
        "  "To" : decodeURIComponent(requestParameters.get("To").get(0)),",
        "  //"CallStatus" : decodeURIComponent(requestParameters.get("CallStatus").get(0)),",
        "  //"ApiVersion" : decodeURIComponent(requestParameters.get("ApiVersion").get(0)),",
        "  //"Direction" : decodeURIComponent(requestParameters.get("Direction").get(0)),",
        "  //"ForwardedFrom" : decodeURIComponent(requestParameters.get("ForwardedFrom").get(0)),",
        "  //"CallerName" : decodeURIComponent(requestParameters.get("CallerNameCallerName").get(0)),",
        "  //"ParentCallSid" : decodeURIComponent(requestParameters.get("ParentCallSid").get(0)),",
        "  //"FromCity" : decodeURIComponent(requestParameters.get("FromCity").get(0)),",
        "  //"FromState" : decodeURIComponent(requestParameters.get("FromState").get(0)),",
        "  //"FromZip" : decodeURIComponent(requestParameters.get("FromZip").get(0)),",
        "  //"FromCountry" : decodeURIComponent(requestParameters.get("FromCountry").get(0)),",
        "  //"ToCity" : decodeURIComponent(requestParameters.get("ToCity").get(0)),",
        "  //"ToState" : decodeURIComponent(requestParameters.get("ToState").get(0)),",
        "  //"ToZip" : decodeURIComponent(requestParameters.get("ToZip").get(0)),",
        "  //"ToCountry" : decodeURIComponent(requestParameters.get("ToCountry").get(0)),",
        "};",
        "",
        "/* End Twilio IVR Configuration Parameters ",
        " */",
        "",
        "if (callParams.AccountSid == TWILIO_ACCOUNT_SID &&",
        "    callParams.To == TWILIO_PHONE_NUMBER) ",
        "{",
        "      outcome = "true";",
        "    sharedState.put("TwilioIVRCallParams", callParams);",
        "    setSharedObjectAttribute("telephoneNumber", callParams.From);",
        "}",
        "",
        "logger.warning("Twilio IVR: Parse Call Parameters: finish [outcome=".concat(outcome).concat("]"));",
        "",
        "/*",
        " * Store attributes in shared state for use with the Create/Patch Object nodes.",
        " */",
        "function setSharedObjectAttribute(name, value) {",
        "       var storage = sharedState.get("objectAttributes");",
        "    if (storage && value) {",
        "          if (storage.put) {",
        "              storage.put(name, value);",
        "        }",
        "          else {",
        "              storage[name] = value;",
        "        }",
        "    }",
        "    else if (value) {",
        "        sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "    }",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Twilio-IVR:-Unverified-Caller-Message.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "4f1273be-9c52-4879-bbe9-9a47068aeed9": {
      "_id": "4f1273be-9c52-4879-bbe9-9a47068aeed9",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Unverified caller message",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Twilio IVR: Unverified Caller Message",
      "script": [
        "/* Twilio IVR: Unverified Caller Message",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * ",
        " * Depending on the amount of data collected through callbacks and how many of the callParams",
        " * you activate below, you will need to change your authentication session from JWT to CTS or",
        " * Memory.",
        " */",
        "outcome = "true";",
        "",
        "/* Begin Configuration",
        " */",
        "",
        "// Build out the full message",
        "var message = "That doesn't match our records. Let us try this another way.";",
        "",
        "/* End Configuration",
        " */",
        "",
        "var fr = JavaImporter(",
        "      org.forgerock.openam.auth.node.api,",
        "      javax.security.auth.callback.TextOutputCallback",
        ");",
        "  ",
        "with (fr) {",
        "      if (callbacks.isEmpty()) {",
        "        var output = new TextOutputCallback(TextOutputCallback.INFORMATION, message);",
        "        action = Action.send(output).build();",
        "      } ",
        "      else {",
        "        action = Action.goTo(outcome).build();",
        "      }",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Twilio-IVR:-Verify-Known-Caller.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "aa2dabff-f5c4-4dc5-b4ac-5909e88a3a8f": {
      "_id": "aa2dabff-f5c4-4dc5-b4ac-5909e88a3a8f",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Verify known caller by first name",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Twilio IVR: Verify Known Caller",
      "script": [
        "/* Twilio IVR: Verify Known Caller",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * - false",
        " * ",
        " * Depending on the amount of data collected through callbacks and how many of the callParams",
        " * you activate below, you will need to change your authentication session from JWT to CTS or",
        " * Memory.",
        " */",
        "logger.warning("Twilio IVR: Verify Known Caller: start");",
        "outcome = "false";",
        "",
        "/* Begin Configuration",
        " */",
        "",
        "// For ID Cloud use "_id", for classic deployments use "username"",
        "var userid = sharedState.get("_id")",
        "",
        "// Retrieve the known caller's first name",
        "var firstName = idRepository.getAttribute(userid, "givenName").iterator().next().replaceAll("[^a-zA-Z ]", "").toLowerCase();",
        "",
        "// Build out the full message",
        "var message = "I see we have a profile associated with your phone number!";",
        "",
        "// Build out the verification prompt",
        "var prompt = "To verify I have the right account, please say your first name.";",
        "",
        "/* End Configuration",
        " */",
        "",
        "var fr = JavaImporter(",
        "      org.forgerock.openam.auth.node.api,",
        "      javax.security.auth.callback.TextOutputCallback,",
        "      javax.security.auth.callback.TextInputCallback",
        ");",
        "  ",
        "with (fr) {",
        "      if (callbacks.isEmpty()) {",
        "        var output = new TextOutputCallback(TextOutputCallback.INFORMATION, message);",
        "        var input = new TextInputCallback(prompt);",
        "        action = Action.send(output, input).build();",
        "      } ",
        "      else {",
        "          var answer = callbacks.get(1).getText().replaceAll("[^a-zA-Z ]", "").toLowerCase();",
        "        logger.warning("Twilio IVR: Verify Known Caller: callbacks received: answer=".concat(answer).concat(" [firstName=").concat(firstName).concat("]"));",
        "        if (answer == firstName) {",
        "              outcome = "true";",
        "        }",
        "          else if (answer.length == 0) {",
        "              outcome = "no input";",
        "        }",
        "        logger.warning("Twilio IVR: Verify Known Caller: finish [outcome=".concat(outcome).concat("]"));",
        "        action = Action.goTo(outcome).build();",
        "      }",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Twilio-IVR:-Verify-Security-PIN.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "c9fa3899-c3ce-4833-af83-64d709202600": {
      "_id": "c9fa3899-c3ce-4833-af83-64d709202600",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Verify security PIN",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Twilio IVR: Verify Security PIN",
      "script": [
        "/* Twilio IVR: Verify Security PIN",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * - false",
        " * ",
        " * Depending on the amount of data collected through callbacks and how many of the callParams",
        " * you activate below, you will need to change your authentication session from JWT to CTS or",
        " * Memory.",
        " */",
        "logger.warning("Twilio IVR: Verify Security PIN: start");",
        "outcome = "false";",
        "",
        "/* Begin Configuration",
        " */",
        "",
        "// For ID Cloud use "_id", for classic deployments use "username"",
        "var userid = sharedState.get("_id")",
        "",
        "// Retrieve the identified caller's PIN (in IDM: frUnindexedInteger5, in AM: fr-attr-int5)",
        "var securityPIN = idRepository.getAttribute(userid, "fr-attr-int5").iterator().next();",
        "",
        "// Build out the verification prompt",
        "var prompt = "To verify I have the right account, please enter your 4-digit security PIN.";",
        "",
        "/* End Configuration",
        " */",
        "",
        "var fr = JavaImporter(",
        "      org.forgerock.openam.auth.node.api,",
        "      javax.security.auth.callback.TextInputCallback",
        ");",
        "  ",
        "with (fr) {",
        "      if (callbacks.isEmpty()) {",
        "        var input = new TextInputCallback(prompt);",
        "        action = Action.send(input).build();",
        "      } ",
        "      else {",
        "          var answer = new String(callbacks.get(0).getText()).replace(/[^0-9]/g, "");",
        "        logger.warning("Twilio IVR: Verify Security PIN: callbacks received");",
        "        if (answer == securityPIN) {",
        "              outcome = "true";",
        "        }",
        "        logger.warning("Twilio IVR: Verify Security PIN: finish [outcome=".concat(outcome).concat("]"));",
        "        action = Action.goTo(outcome).build();",
        "      }",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Twilio-IVR:-Verify-Unknown-Caller.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "1c0c73e8-2be1-41ce-b042-3c39694346b5": {
      "_id": "1c0c73e8-2be1-41ce-b042-3c39694346b5",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Verify unknown caller by account number",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Twilio IVR: Verify Unknown Caller",
      "script": [
        "/* Twilio IVR: Verify Unknown Caller",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * ",
        " * Depending on the amount of data collected through callbacks and how many of the callParams",
        " * you activate below, you will need to change your authentication session from JWT to CTS or",
        " * Memory.",
        " */",
        "logger.warning("Twilio IVR: Verify Unknown Caller: start");",
        "outcome = "true";",
        "",
        "/* Begin Configuration",
        " */",
        "",
        "// Build out the verification prompt",
        "var prompt = "To lookup your account, please enter or say your account number.";",
        "",
        "/* End Configuration",
        " */",
        "",
        "var fr = JavaImporter(",
        "      org.forgerock.openam.auth.node.api,",
        "      javax.security.auth.callback.TextInputCallback",
        ");",
        "  ",
        "with (fr) {",
        "      if (callbacks.isEmpty()) {",
        "        var input = new TextInputCallback(prompt);",
        "        action = Action.send(input).build();",
        "      } ",
        "      else {",
        "          var answer = new String(callbacks.get(0).getText()).replace(/[^0-9]/g, "");",
        "        logger.warning("Twilio IVR: Verify Unknown Caller: callbacks received: answer=".concat(answer));",
        "          setSharedObjectAttribute("frIndexedInteger5", answer);",
        "        logger.warning("Twilio IVR: Verify Unknown Caller: finish [outcome=".concat(outcome).concat("]"));",
        "        action = Action.goTo(outcome).build();",
        "      }",
        "}",
        "",
        "/*",
        " * Store attributes in shared state for use with the Create/Patch Object nodes.",
        " */",
        "function setSharedObjectAttribute(name, value) {",
        "       var storage = sharedState.get("objectAttributes");",
        "    if (storage && value) {",
        "          if (storage.put) {",
        "              storage.put(name, value);",
        "        }",
        "          else {",
        "              storage[name] = value;",
        "        }",
        "    }",
        "    else if (value) {",
        "        sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "    }",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Twilio-IVR:-Welcome-Message.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "53c50dbd-5331-4739-bea1-4c5e9bf553f2": {
      "_id": "53c50dbd-5331-4739-bea1-4c5e9bf553f2",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Welcome message",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Twilio IVR: Welcome Message",
      "script": [
        "/* Twilio IVR: Welcome Message",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * ",
        " * Depending on the amount of data collected through callbacks and how many of the callParams",
        " * you activate below, you will need to change your authentication session from JWT to CTS or",
        " * Memory.",
        " */",
        "logger.warning("Twilio IVR: Welcome Message: start");",
        "outcome = "true";",
        "",
        "/* Begin Configuration",
        " */",
        "",
        "// Build out the full message",
        "var message = "Thank you for calling ForgeRock Identity Cloud!";",
        "",
        "/* End Configuration",
        " */",
        "",
        "var fr = JavaImporter(",
        "      org.forgerock.openam.auth.node.api,",
        "      javax.security.auth.callback.TextOutputCallback",
        ");",
        "  ",
        "with (fr) {",
        "      if (callbacks.isEmpty()) {",
        "        var output = new TextOutputCallback(TextOutputCallback.INFORMATION, message);",
        "        action = Action.send(output).build();",
        "      } ",
        "      else {",
        "        logger.warning("Twilio IVR: Welcome Message: finish [outcome=".concat(outcome).concat("]"));",
        "        action = Action.goTo(outcome).build();",
        "      }",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Twilio-SMS-OTP-Sender.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "91554b10-79a5-4aa8-aca1-59481a734c19": {
      "_id": "91554b10-79a5-4aa8-aca1-59481a734c19",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Twilio SMS OTP Sender",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Twilio SMS OTP Sender",
      "script": [
        "/* Twilio SMS OTP Sender",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * This script will send an SMS containing the OTP to the phone number in the user's profile.",
        " * ",
        " * This script needs to be parametrized. It will not work properly as is. ",
        " * It requires the Identify Existing User node and HOTP Generator node before it is being called.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - sent",
        " * - failed",
        " */",
        "logger.warning("Twilio SMS OTP Sender: start");",
        "",
        "if (sharedState.get("_id") && idRepository.getAttribute(sharedState.get("_id"), "telephoneNumber").iterator().hasNext()) {",
        "    var Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(input){var output="";var chr1,chr2,chr3,enc1,enc2,enc3,enc4;var i=0;input=Base64._utf8_encode(input);while(i<input.length){chr1=input.charCodeAt(i++);chr2=input.charCodeAt(i++);chr3=input.charCodeAt(i++);enc1=chr1>>2;enc2=(chr1&3)<<4|chr2>>4;enc3=(chr2&15)<<2|chr3>>6;enc4=chr3&63;if(isNaN(chr2)){enc3=enc4=64}else if(isNaN(chr3)){enc4=64}output=output+this._keyStr.charAt(enc1)+this._keyStr.charAt(enc2)+this._keyStr.charAt(enc3)+this._keyStr.charAt(enc4)}return output},decode:function(input){var output="";var chr1,chr2,chr3;var enc1,enc2,enc3,enc4;var i=0;input=input.replace(/[^A-Za-z0-9\\+\\/\\=]/g,"");while(i<input.length){enc1=this._keyStr.indexOf(input.charAt(i++));enc2=this._keyStr.indexOf(input.charAt(i++));enc3=this._keyStr.indexOf(input.charAt(i++));enc4=this._keyStr.indexOf(input.charAt(i++));chr1=enc1<<2|enc2>>4;chr2=(enc2&15)<<4|enc3>>2;chr3=(enc3&3)<<6|enc4;output=output+String.fromCharCode(chr1);if(enc3!=64){output=output+String.fromCharCode(chr2)}if(enc4!=64){output=output+String.fromCharCode(chr3)}}output=Base64._utf8_decode(output);return output},_utf8_encode:function(string){string=string.replace(/\\r\\n/g,"\\n");var utftext="";for(var n=0;n<string.length;n++){var c=string.charCodeAt(n);if(c<128){utftext+=String.fromCharCode(c)}else if(c>127&&c<2048){utftext+=String.fromCharCode(c>>6|192);utftext+=String.fromCharCode(c&63|128)}else{utftext+=String.fromCharCode(c>>12|224);utftext+=String.fromCharCode(c>>6&63|128);utftext+=String.fromCharCode(c&63|128)}}return utftext},_utf8_decode:function(utftext){var string="";var i=0;var c=c1=c2=0;while(i<utftext.length){c=utftext.charCodeAt(i);if(c<128){string+=String.fromCharCode(c);i++}else if(c>191&&c<224){c2=utftext.charCodeAt(i+1);string+=String.fromCharCode((c&31)<<6|c2&63);i+=2}else{c2=utftext.charCodeAt(i+1);c3=utftext.charCodeAt(i+2);string+=String.fromCharCode((c&15)<<12|(c2&63)<<6|c3&63);i+=3}}return string}};",
        "",
        "       /* BEGIN SCRIPT CONFIGURATION",
        "     *",
        "     * REPLACE WITH YOUR OWN AZURE AD SETTINGS",
        "     */",
        "    var TWILIO_API_SID = "AC750415e3163a2e57b7aeea7eed82d944";",
        "    var TWILIO_API_TOKEN = "d36a719c94b4be08592d69ec4f80a5bb";",
        "    var TWILIO_API_FROM = "+13176443107";",
        "    /*",
        "     * END SCRIPT CONFIGURATION",
        "     */",
        "  ",
        "    // Twilio SMS Message API Configuration",
        "    var TWILIO_API_URI = "https://api.twilio.com/2010-04-01/Accounts/".concat(TWILIO_API_SID).concat("/Messages.json");    ",
        "    var TWILIO_API_TO = idRepository.getAttribute(sharedState.get("_id"), "telephoneNumber").iterator().next();",
        "    var TWILIO_API_BODY = "OTP for account ".concat(sharedState.get("username")).concat(": ").concat(sharedState.get("oneTimePassword"));",
        "    //logger.warning("Twilio SMS OTP Sender: To: ".concat(TWILIO_API_TO));",
        "    //logger.warning("Twilio SMS OTP Sender: Message: ".concat(TWILIO_API_BODY));",
        "",
        "    var AUTHZ = "Basic ".concat(Base64.encode(TWILIO_API_SID.concat(':').concat(TWILIO_API_TOKEN)));",
        "    //logger.warning("Twilio SMS OTP Sender: AUTHZ - ".concat(AUTHZ));",
        "",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setMethod('POST');",
        "    request.setUri(TWILIO_API_URI);",
        "    request.getHeaders().add("Content-Type", "application/x-www-form-urlencoded");",
        "    request.getHeaders().add("Authorization", AUTHZ);",
        "    var params = request.getForm();",
        "    params.add("From", TWILIO_API_FROM);",
        "    params.add("Body", TWILIO_API_BODY);",
        "    params.add("To", TWILIO_API_TO);",
        "    request.getEntity().setString(params.toString());",
        "",
        "    var response = httpClient.send(request).get();",
        "    var result = JSON.parse(response.getEntity().getString());",
        "    //logger.warning("Twilio SMS OTP Sender: JSON result: " + JSON.stringify(result));",
        "",
        "    if (result["error_code"]) {",
        "        outcome = "failed";",
        "        logger.error("Twilio SMS OTP Sender: error_code = ".concat(result["error_code"]));",
        "        logger.error("Twilio SMS OTP Sender: error_message = ".concat(result["error_message"]));",
        "        logger.error("Twilio SMS OTP Sender: outcome = failed");",
        "    } else if (result["code"]) {",
        "        outcome = "failed";",
        "        logger.error("Twilio SMS OTP Sender: code = ".concat(result["code"]));",
        "        logger.error("Twilio SMS OTP Sender: message = ".concat(result["message"]));",
        "    } else {",
        "        outcome = "sent";",
        "        logger.warning("Twilio SMS OTP Sender: outcome = sent");",
        "    }",
        "} else {",
        "      outcome = "failed";",
        "      logger.error("Twilio SMS OTP Sender: No user or phone number found! Use 'Identify Existing User node before this script to populate the user's _id in shared state!'");",
        "      logger.error("Twilio SMS OTP Sender: outcome = failed");",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Twilio-Voice-OTP-Sender.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "e0666b8b-f625-4047-89d8-e7e91151027f": {
      "_id": "e0666b8b-f625-4047-89d8-e7e91151027f",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Twilio Voice OTP Sender",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Twilio Voice OTP Sender",
      "script": [
        "/* Twilio Voice OTP Sender",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * This script will deliver the OTP via voice to the phone number in the user's profile.",
        " * ",
        " * This script needs to be parametrized. It will not work properly as is. ",
        " * It requires the Identify Existing User node and HOTP Generator node before it is being called.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - sent",
        " * - failed",
        " */",
        "logger.warning("Twilio Voice OTP Sender: start");",
        "",
        "if (sharedState.get("_id") && idRepository.getAttribute(sharedState.get("_id"), "telephoneNumber").iterator().hasNext()) {",
        "    var Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(input){var output="";var chr1,chr2,chr3,enc1,enc2,enc3,enc4;var i=0;input=Base64._utf8_encode(input);while(i<input.length){chr1=input.charCodeAt(i++);chr2=input.charCodeAt(i++);chr3=input.charCodeAt(i++);enc1=chr1>>2;enc2=(chr1&3)<<4|chr2>>4;enc3=(chr2&15)<<2|chr3>>6;enc4=chr3&63;if(isNaN(chr2)){enc3=enc4=64}else if(isNaN(chr3)){enc4=64}output=output+this._keyStr.charAt(enc1)+this._keyStr.charAt(enc2)+this._keyStr.charAt(enc3)+this._keyStr.charAt(enc4)}return output},decode:function(input){var output="";var chr1,chr2,chr3;var enc1,enc2,enc3,enc4;var i=0;input=input.replace(/[^A-Za-z0-9\\+\\/\\=]/g,"");while(i<input.length){enc1=this._keyStr.indexOf(input.charAt(i++));enc2=this._keyStr.indexOf(input.charAt(i++));enc3=this._keyStr.indexOf(input.charAt(i++));enc4=this._keyStr.indexOf(input.charAt(i++));chr1=enc1<<2|enc2>>4;chr2=(enc2&15)<<4|enc3>>2;chr3=(enc3&3)<<6|enc4;output=output+String.fromCharCode(chr1);if(enc3!=64){output=output+String.fromCharCode(chr2)}if(enc4!=64){output=output+String.fromCharCode(chr3)}}output=Base64._utf8_decode(output);return output},_utf8_encode:function(string){string=string.replace(/\\r\\n/g,"\\n");var utftext="";for(var n=0;n<string.length;n++){var c=string.charCodeAt(n);if(c<128){utftext+=String.fromCharCode(c)}else if(c>127&&c<2048){utftext+=String.fromCharCode(c>>6|192);utftext+=String.fromCharCode(c&63|128)}else{utftext+=String.fromCharCode(c>>12|224);utftext+=String.fromCharCode(c>>6&63|128);utftext+=String.fromCharCode(c&63|128)}}return utftext},_utf8_decode:function(utftext){var string="";var i=0;var c=c1=c2=0;while(i<utftext.length){c=utftext.charCodeAt(i);if(c<128){string+=String.fromCharCode(c);i++}else if(c>191&&c<224){c2=utftext.charCodeAt(i+1);string+=String.fromCharCode((c&31)<<6|c2&63);i+=2}else{c2=utftext.charCodeAt(i+1);c3=utftext.charCodeAt(i+2);string+=String.fromCharCode((c&15)<<12|(c2&63)<<6|c3&63);i+=3}}return string}};",
        "",
        "    /* BEGIN SCRIPT CONFIGURATION",
        "     *",
        "     * REPLACE WITH YOUR OWN AZURE AD SETTINGS",
        "     */",
        "    var TWILIO_API_SID = "AC750415e3163a2e57b7aeea7eed82d944";",
        "    var TWILIO_API_TOKEN = "d36a719c94b4be08592d69ec4f80a5bb";",
        "    var TWILIO_API_FROM = "+13176443107";",
        "    /*",
        "     * END SCRIPT CONFIGURATION",
        "     */",
        "  ",
        "    // Twilio SMS Message API Configuration",
        "    var TWILIO_API_URI = "https://api.twilio.com/2010-04-01/Accounts/".concat(TWILIO_API_SID).concat("/Calls.json");    ",
        "    var TWILIO_API_TO = idRepository.getAttribute(sharedState.get("_id"), "telephoneNumber").iterator().next();",
        "      var OTP = sharedState.get("oneTimePassword").split("").join("; ");",
        "    var TWILIO_API_TWIML = "<Response><Pause length='1'/><Say voice='alice'>Your one-time password is ".concat(OTP).concat("</Say><Pause length='1'/><Say>Your one-time password is ").concat(OTP).concat("</Say><Pause length='1'/><Say>Goodbye</Say></Response>");",
        "    //logger.warning("Twilio Voice OTP Sender: To: ".concat(TWILIO_API_TO));",
        "    //logger.warning("Twilio Voice OTP Sender: Twiml: ".concat(TWILIO_API_TWIML));",
        "",
        "    var AUTHZ = "Basic ".concat(Base64.encode(TWILIO_API_SID.concat(':').concat(TWILIO_API_TOKEN)));",
        "    //logger.warning("Twilio SMS OTP Sender: AUTHZ - ".concat(AUTHZ));",
        "",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setMethod('POST');",
        "    request.setUri(TWILIO_API_URI);",
        "    request.getHeaders().add("Content-Type", "application/x-www-form-urlencoded");",
        "    request.getHeaders().add("Authorization", AUTHZ);",
        "    var params = request.getForm();",
        "    params.add("From", TWILIO_API_FROM);",
        "    params.add("Twiml", TWILIO_API_TWIML);",
        "    params.add("To", TWILIO_API_TO);",
        "    request.getEntity().setString(params.toString());",
        "",
        "    var response = httpClient.send(request).get();",
        "    var result = JSON.parse(response.getEntity().getString());",
        "    //logger.warning("Twilio SMS OTP Sender: JSON result: " + JSON.stringify(result));",
        "",
        "    if (result["status"]=="queued") {",
        "        outcome = result["status"];",
        "        logger.error("Twilio Voice OTP Sender: status = ".concat(result["status"]));",
        "        logger.error("Twilio Voice OTP Sender: subresource_uris = ".concat(result["subresource_uris"]));",
        "        logger.error("Twilio Voice OTP Sender: outcome = ".concat(outcome));",
        "    } else {",
        "        outcome = "failed";",
        "        logger.error("Twilio Voice OTP Sender: status = ".concat(result["status"]));",
        "        logger.error("Twilio Voice OTP Sender: code = ".concat(result["code"]));",
        "        logger.error("Twilio Voice OTP Sender: more_info = ".concat(result["more_info"]));",
        "        logger.error("Twilio Voice OTP Sender: message = ".concat(result["message"]));",
        "        logger.error("Twilio Voice OTP Sender: outcome = ".concat(outcome));",
        "    }",
        "} else {",
        "      outcome = "failed";",
        "      logger.error("Twilio Voice OTP Sender: No user or phone number found! Use 'Identify Existing User node before this script to populate the user's _id in shared state!'");",
        "    logger.error("Twilio Voice OTP Sender: outcome = ".concat(outcome));",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Twitter-Profile-Normalization.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "8e298710-b55e-4085-a464-88a375a4004b": {
      "_id": "8e298710-b55e-4085-a464-88a375a4004b",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from Twitter",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Twitter Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "return json(object(",
        "        field("id", rawProfile.id_str),",
        "        field("displayName", rawProfile.name),",
        "        field("photoUrl", rawProfile.profile_image_url),",
        "        field("email", rawProfile.email),",
        "        field("username", rawProfile.screen_name)))",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./UOP-Enrich-Session.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "743351b3-001a-4ec8-b3ac-a674ddb8de22": {
      "_id": "743351b3-001a-4ec8-b3ac-a674ddb8de22",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Enrich user session with UOP class ID.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "UOP Enrich Session",
      "script": [
        "/* UOP Enrich Session",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Add current class ID to user session.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is. ",
        " * It requires the Identify Existing User node before it is being called.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * - false",
        " */",
        "logger.warning("UOP Enrich Session: start");",
        "outcome = "false";",
        "",
        "if (sharedState.get("uopCurrentClassID")) {",
        "    outcome = "true";",
        "    logger.warning("UOP Enrich Session: going to enrich session with class id: ".concat(sharedState.get("uopCurrentClassID")));",
        "  ",
        "    var fr = JavaImporter(",
        "      org.forgerock.openam.auth.node.api",
        "    );",
        "",
        "    with (fr) {",
        "        logger.warning("UOP Enrich Session: End (outcome=".concat(outcome).concat(")"));",
        "        action = Action.goTo(outcome).putSessionProperty("UOPClassID", sharedState.get("uopCurrentClassID")).build();",
        "    }",
        "  ",
        "} else {",
        "    logger.error("UOP Enrich Session: no classes!");",
        "    logger.warning("UOP Enrich Session: End (outcome=".concat(outcome).concat(")"));",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./UOP-Get-Course-ID.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "6ad22934-5d12-43a6-96a7-a2fba8d999bf": {
      "_id": "6ad22934-5d12-43a6-96a7-a2fba8d999bf",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Call out to University of Phoenix Course Registration System and get current course.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "UOP Get Course ID",
      "script": [
        "/* UOP Get Course ID",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Call out to University of Phoenix Course Registration System and get current class.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is. ",
        " * It requires the Identify Existing User node before it is being called.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - has classes",
        " * - no classes",
        " * - error",
        " */",
        "logger.warning("UOP Get Course ID: start now");",
        "",
        "outcome = "error";",
        "",
        "if (sharedState.get("_id") && idRepository.getAttribute(sharedState.get("_id"), "mail").iterator().hasNext()) {",
        "",
        "       /* BEGIN SCRIPT CONFIGURATION",
        "     *",
        "     * REPLACE WITH YOUR OWN API SETTINGS",
        "     */",
        "      var email = idRepository.getAttribute(sharedState.get("_id"), "mail").iterator().next();",
        "    var UOP_CLASS_API_URI = "https://dy4rpew5va.execute-api.us-east-1.amazonaws.com/forgerock/course?courseId=CES422";",
        "      //var UOP_CLASS_API_URI = "https://dy4rpew5va.execute-api.us-east-1.amazonaws.com/forgerock/course?emailId=".concat(email);",
        "    /*",
        "     * END SCRIPT CONFIGURATION",
        "     */",
        "",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setMethod('GET');",
        "    request.setUri(UOP_CLASS_API_URI);",
        "",
        "    var response = httpClient.send(request).get();",
        "    var UOPClassID = response.getEntity().getString();",
        "    logger.warning("UOP Get Course ID: API call result: Course ID=".concat(UOPClassID));",
        "",
        "    /* Sample API response",
        "    CES421",
        "    */",
        "",
        "    if (UOPClassID) {",
        "        outcome = "has classes";",
        "",
        "        // preserve result in shared state",
        "        sharedState.put("uopCurrentClassID", UOPClassID);",
        "    } ",
        "    else if (UOPClassID === "") {",
        "        outcome = "no classes";",
        "    }",
        "    else {",
        "        outcome = "error";",
        "    }",
        "",
        "} else {",
        "    logger.error("UOP Get Course ID: no classes!");",
        "}",
        "",
        "logger.warning("UOP Get Course ID: End (outcome=".concat(outcome).concat(")"));",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./VKontakte-Profile-Normalization.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "403cf226-6051-4368-8b72-9ba14f9a5140": {
      "_id": "403cf226-6051-4368-8b72-9ba14f9a5140",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from VKontakte",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "VKontakte Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "return json(object(",
        "        field("id", rawProfile.id),",
        "        field("displayName", rawProfile.first_name),",
        "        field("givenName", rawProfile.first_name),",
        "        field("familyName", rawProfile.last_name),",
        "        field("photoUrl", rawProfile.photo_50),",
        "        field("email", rawProfile.email),",
        "        field("username", rawProfile.email)))",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./WeChat-Profile-Normalization.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "472534ec-a25f-468d-a606-3fb1935190df": {
      "_id": "472534ec-a25f-468d-a606-3fb1935190df",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from WeChat",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "WeChat Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "return json(object(",
        "        field("id", rawProfile.openid),",
        "        field("displayName", rawProfile.nickname),",
        "        field("photoUrl", rawProfile.headimgurl),",
        "        field("username", rawProfile.nickname)))",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./WordPress-Profile-Normalization.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "91d197de-5916-4dca-83b5-9a4df26e7159": {
      "_id": "91d197de-5916-4dca-83b5-9a4df26e7159",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from WordPress",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "WordPress Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "return json(object(",
        "        field("id", rawProfile.username),",
        "        field("displayName", rawProfile.display_name),",
        "        field("photoUrl", rawProfile.avatar_URL),",
        "        field("email", rawProfile.email),",
        "        field("username", rawProfile.username)))",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./Yahoo-Profile-Normalization.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "424da748-82cc-4b54-be6f-82bd64d82a74": {
      "_id": "424da748-82cc-4b54-be6f-82bd64d82a74",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from Yahoo",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Yahoo Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "return json(object(",
        "        field("id", rawProfile.sub),",
        "        field("displayName", rawProfile.name),",
        "        field("givenName", rawProfile.given_name),",
        "        field("familyName", rawProfile.family_name),",
        "        field("photoUrl", rawProfile.picture),",
        "        field("email", rawProfile.email),",
        "        field("username", rawProfile.email),",
        "        field("locale", rawProfile.locale)))",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./debug.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "3cb43516-ae69-433a-8787-501d45db14e9": {
      "_id": "3cb43516-ae69-433a-8787-501d45db14e9",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Display sharedState, transientState, and headers.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "debug",
      "script": [
        "/* debug",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Display sharedState, transientState, and headers.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "var anchor = "anchor-".concat(generateNumericToken('xxx'));",
        "var halign = "left";",
        "var message = "<p><b>Shared State</b>:<br/>".concat(",
        "      sharedState.toString()).concat("</p>").concat(",
        "    "<p><b>Transient State</b>:<br/>").concat(",
        "      transientState.toString()).concat("</p>").concat(",
        "    "<p><b>Request Headers</b>:<br/>").concat(",
        "      requestHeaders.toString()).concat("</p>")",
        "var script = "Array.prototype.slice.call(\\n".concat(",
        "  "document.getElementsByClassName('callback-component')).forEach(\\n").concat(",
        "  "function (e) {\\n").concat(",
        "  "  var message = e.firstElementChild;\\n").concat(",
        "  "  if (message.firstChild && message.firstChild.nodeName == '#text' && message.firstChild.nodeValue.trim() == '").concat(anchor).concat("') {\\n").concat(",
        "  "    message.className = \\"text-left\\";\\n").concat(",
        "  "    message.align = \\"").concat(halign).concat("\\";\\n").concat(",
        "  "    message.innerHTML = '").concat(message).concat("';\\n").concat(",
        "  "  }\\n").concat(",
        "  "})")",
        "var fr = JavaImporter(",
        "    org.forgerock.openam.auth.node.api.Action,",
        "    javax.security.auth.callback.TextOutputCallback,",
        "    com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        ")",
        "if (message.length && callbacks.isEmpty()) {",
        "    action = fr.Action.send(",
        "        new fr.TextOutputCallback(",
        "            fr.TextOutputCallback.INFORMATION,",
        "            anchor",
        "        ),",
        "        new fr.ScriptTextOutputCallback(script)",
        "    ).build()",
        "}",
        "else {",
        "  action = fr.Action.goTo("true").build();",
        "}",
        "",
        " /*",
        "  * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "  * ",
        "  * Example:",
        "  * 'xxxxx' produces '28535'",
        "  * 'xxx-xxx' produces '432-521'",
        "  */",
        "function generateNumericToken(format) {",
        "    return format.replace(/[x]/g, function(c) {",
        "        var r = Math.random()*10|0;",
        "        var v = r;",
        "        return v.toString(10);",
        "    });",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./deviceprofile_to_attribute.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "123725a9-2119-4efd-a6b0-456f3ccd34b7": {
      "_id": "123725a9-2119-4efd-a6b0-456f3ccd34b7",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "deviceprofile_to_attribute",
      "script": [
        "var objectAttributes = sharedState.get("objectAttributes");",
        "var deviceHash = sharedState.get("deviceHash");",
        "",
        "sharedState.put("frIndexedString1" , deviceHash );",
        "",
        "",
        "",
        "if(objectAttributes === null || objectAttributes === undefined)",
        "{",
        "",
        "",
        " objectAttributes = {",
        "                        "userName" : "anon-".concat(deviceHash),",
        "                     "givenName" : " ",",
        "                     "sn" : " ",",
        "                     "mail" : "anon-".concat(deviceHash).concat("@mytestrun.com"),",
        "                     "frIndexedString1" : deviceHash",
        "                    }",
        "}",
        "else",
        "{",
        "",
        "    objectAttributes.put("userName",  "anon-".concat(deviceHash));",
        "    objectAttributes.put("givenName", " ");",
        "    objectAttributes.put("sn", " ");",
        "    objectAttributes.put("mail", "anon-".concat(deviceHash).concat("@mytestrun.com"));",
        "    objectAttributes.put("frIndexedString1", deviceHash);",
        "   ",
        "}",
        "",
        "",
        "sharedState.put("objectAttributes",objectAttributes);",
        "    ",
        "outcome = "true";",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./display-country.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "8bccfdd0-5556-4562-a1ca-6d725a449556": {
      "_id": "8bccfdd0-5556-4562-a1ca-6d725a449556",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "display country",
      "script": [
        "var fr = JavaImporter(",
        "  org.forgerock.openam.auth.node.api,",
        "  javax.security.auth.callback.TextOutputCallback",
        ");",
        "  ",
        "outcome = "true";",
        "",
        "var country = "unknown";",
        "if (transientState.get("ipstack")) {",
        "    country = JSON.parse(transientState.get("ipstack")).country_code;",
        "}",
        "  ",
        "with (fr) {",
        "  if (callbacks.isEmpty()) {",
        "    var callback = new TextOutputCallback(TextOutputCallback.INFORMATION, "Country: ".concat(country));",
        "    action = Action.send(callback).build();",
        "  } else {",
        "    action = Action.goTo("true").build();",
        "  }",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./hashdeviceProfile.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "e15a13ee-9168-40cf-934f-656a5f568a6a": {
      "_id": "e15a13ee-9168-40cf-934f-656a5f568a6a",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "hashdeviceProfile",
      "script": [
        "/*",
        "  - Data made available by nodes that have already executed are available in the sharedState variable.",
        "  - The script should set outcome to either "true" or "false".",
        " */",
        "",
        "//<script type="text/javascript" src="http://www.myersdaily.org/joseph/javascript/md5.js" />",
        "",
        "function hashCode(r){var e,h=0;for(e=0;e<r.length;e++)h=(h<<5)-h+r.charCodeAt(e),h|=0;return h>>>0}",
        "",
        "",
        "var hashMe = sharedState.get("forgeRock.device.profile");",
        "var hashMe = sharedState.put("forgeRock.device.profile","deleted in script - hashdeviceProfile");",
        "//var hashMeStr = JSON.stringify(hashMe);",
        "//logger.error("HashMeStr: " + hashMeStr);",
        "",
        "sharedState.put("deviceHash",hashCode(escape(hashMe)).toString());",
        "sharedState.put("frIndexedString1",hashCode(escape(hashMe)).toString());",
        "",
        "outcome = "true";",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./iddataweb-Profile-Normalization.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "2997bd4d-14be-4dc6-8701-27f08d10b8b7": {
      "_id": "2997bd4d-14be-4dc6-8701-27f08d10b8b7",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Profile Normalization Script for idddataweb",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "iddataweb Profile Normalization",
      "script": [
        "/*/*",
        " * Copyright 2022 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS. Not for Production use. ",
        " * Modified by Stephen Payne",
        " */",
        "/* Social Identity Provider Profile Transformation script for ID DataWeb */",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "logger.error("iddataweb_Social Identity Provider Profile Transformation script: Start");",
        "userName = sharedState.get("objectAttributes").get("mail");",
        "logger.error("iddataweb_Social Identity Provider Profile Transformation script: userName" + userName );",
        "username = userName;",
        "sharedState.put("userName", userName);",
        "",
        "return json(object(",
        "        field("id", rawProfile.sub),",
        "        field("displayName", rawProfile.acquiredAttributes_AcquiredFullName_fname.asString() + " " + rawProfile.acquiredAttributes_AcquiredFullName_lname.asString().toLowerCase().capitalize() ),",
        "        field("givenName", rawProfile.acquiredAttributes_AcquiredFullName_fname.asString().toLowerCase().capitalize() ),",
        "        field("familyName", rawProfile.acquiredAttributes_AcquiredFullName_lname.asString().toLowerCase().capitalize() ),",
        "        field("postalAddress", rawProfile.acquiredAttributes_AcquiredAddress_address),",
        "        field("addressLocality", rawProfile.acquiredAttributes_AcquiredAddress_locality),",
        "        field("addressRegion", rawProfile.acquiredAttributes_AcquiredAddress_administrative_area_level_1),",
        "        field("postalCode", rawProfile.acquiredAttributes_AcquiredAddress_postal_code),",
        "        field("country", rawProfile.acquiredAttributes_AcquiredAddress_country),",
        "        field("driversLicense", rawProfile.acquiredAttributes_AcquiredDriversLicenseNumber_acquiredDriversLicenseNumber),",
        "        field("driversLicenseIssuer", rawProfile.acquiredAttributes_DriversLicenseIssuerCode_DriversLicenseIssuerCode),",
        "          field("DOB", rawProfile.acquiredAttributes_AcquiredDOB_month.asString() + "/" + rawProfile.acquiredAttributes_AcquiredDOB_day.asString() + "/" + rawProfile.acquiredAttributes_AcquiredDOB_year.asString() ),",
        "",
        "        field("IDWScore", rawProfile.acquiredAttributes_IDWScore),",
        "        field("policyDecision", rawProfile.policyDecision_conclusion),",
        "        field("phone", rawProfile.userAttributes_InternationalTelephone_dialCode.asString() + rawProfile.userAttributes_InternationalTelephone_telephone.asString()),",
        "        field("username", userName )",
        "       //field("username", rawProfile.acquiredAttributes_AcquiredFullName_fname.asString() + "." + rawProfile.acquiredAttributes_AcquiredFullName_lname.asString() )",
        "",
        "   )",
        ")",
        "",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./ipstack.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "87497360-d89c-412a-a99e-c8a9bec465cc": {
      "_id": "87497360-d89c-412a-a99e-c8a9bec465cc",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "ipstack",
      "script": [
        "logger.warning("ipstack: start");",
        "",
        "outcome = "unknown";",
        "",
        "var ip = getClientIPAddress();",
        "logger.warning("ipstack: ip=".concat(ip));",
        "",
        "if (ip) {",
        "",
        "      // ipstack API Configuration",
        "    var IPSTACK_ACCESS_KEY = "efc2f8d9796b9feff5f03359d6fbccc9";",
        "    var IPSTACK_API_URI = "http://api.ipstack.com/".concat(ip).concat("?access_key=").concat(IPSTACK_ACCESS_KEY);    ",
        "",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setMethod('GET');",
        "    request.setUri(IPSTACK_API_URI);",
        "",
        "    var response = httpClient.send(request).get();",
        "    var result = JSON.parse(response.getEntity().getString());",
        "    logger.warning("ipstack: JSON result: " + JSON.stringify(result));",
        "",
        "      /*",
        "    {",
        "        "ip": "99.72.28.182",",
        "        "type": "ipv4",",
        "        "continent_code": "NA",",
        "        "continent_name": "North America",",
        "        "country_code": "US",",
        "        "country_name": "United States",",
        "        "region_code": "TX",",
        "        "region_name": "Texas",",
        "        "city": "Georgetown",",
        "        "zip": "78626",",
        "        "latitude": 30.592500686645508,",
        "        "longitude": -97.66710662841797,",
        "        "location": {",
        "            "geoname_id": 4693342,",
        "            "capital": "Washington D.C.",",
        "            "languages": [",
        "                {",
        "                    "code": "en",",
        "                    "name": "English",",
        "                    "native": "English"",
        "                }",
        "            ],",
        "            "country_flag": "http://assets.ipstack.com/flags/us.svg",",
        "            "country_flag_emoji": "🇺🇸",",
        "            "country_flag_emoji_unicode": "U+1F1FA U+1F1F8",",
        "            "calling_code": "1",",
        "            "is_eu": false",
        "        }",
        "    }",
        "    */",
        "  ",
        "      // preserve result in transient state",
        "      transientState.put("ipstack", JSON.stringify(result));",
        "",
        "    switch(result.country_code) {",
        "      case "CA":",
        "        outcome = result.country_code;",
        "        break;",
        "      case "UK":",
        "        outcome = result.country_code;",
        "        break;",
        "      case "US":",
        "        outcome = result.country_code;",
        "        break;",
        "      default:",
        "        outcome = "other";",
        "    }",
        "",
        "} else {",
        "      logger.error("ipstack: no client ip!");",
        "}",
        "",
        "logger.warning("ipstack: finish");",
        "",
        " /*",
        "  * !!! ASSUMES ID CLOUD !!!",
        "  *",
        "  * Returns the client's IP address",
        "  */",
        " function getClientIPAddress() {",
        "    return requestHeaders.get("x-forwarded-for").get(0).split(',')[0];",
        " }",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./level.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "41c24257-d7fc-4654-8b46-c2666dc5b56d": {
      "_id": "41c24257-d7fc-4654-8b46-c2666dc5b56d",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "set per level shared state variable",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "level",
      "script": [
        "(function () {",
        "  outcome = 'true';",
        "  var level = nodeState.get('level').asInteger();",
        "  sharedState.put('level' + level + 'Value', 'Level ' + level + ': This is a longer string value set at each level of the nested journeys. It contains an indicator in which level it was set.');",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./mode.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "5bbdaeff-ddee-44b9-b608-8d413d7d65a6": {
      "_id": "5bbdaeff-ddee-44b9-b608-8d413d7d65a6",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Check if mode has already been set.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "mode",
      "script": [
        "/* mode",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Collect mode if not already set and set outcome to mode.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - 'shared and level'",
        " * - 'shared only'",
        " * - 'level only'",
        " * - 'none'",
        " */",
        "(function () {",
        "  var mode = nodeState.get('mode');",
        "  if (mode) {",
        "    outcome = mode.asString();",
        "    var level = nodeState.get('level').asInteger() + 1;",
        "    logger.error('mode: mode=' + mode.asString() + ', level=' + level);",
        "    sharedState.put('level', level);",
        "  }",
        "  else {",
        "    var choices = ['shared and level', 'shared only', 'level only', 'none'];",
        "  ",
        "    var fr = JavaImporter(",
        "      org.forgerock.openam.auth.node.api.Action,",
        "      javax.security.auth.callback.ChoiceCallback",
        "    )",
        "",
        "    if (callbacks.isEmpty()) {",
        "      action = fr.Action.send([",
        "        new fr.ChoiceCallback('Choose test mode', choices, 0, false)",
        "      ]).build();",
        "    } else {",
        "      var choice = parseInt(callbacks.get(0).getSelectedIndexes()[0]);",
        "      nodeState.putShared('mode', choices[choice]);",
        "      nodeState.putShared('level', 0);",
        "      action = fr.Action.goTo(choices[choice]).build();",
        "    }",
        "  }",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./shared.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "1b52a7e0-4019-40fa-958a-15a49870e901": {
      "_id": "1b52a7e0-4019-40fa-958a-15a49870e901",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "set the same shared state variable",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "shared",
      "script": [
        "(function () {",
        "  outcome = 'true';",
        "  var level = nodeState.get('level').asInteger();",
        "  sharedState.put('sharedValue', 'Level ' + level + ': This is a longer string value shared across all nested journeys. It contains an indicator in which level it was last set.');",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./shared-State-Printer.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "b6fce769-cf21-4963-a8dc-7c5370a4d15b": {
      "_id": "b6fce769-cf21-4963-a8dc-7c5370a4d15b",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "shared State Printer",
      "script": [
        "var fr = JavaImporter(",
        "  org.forgerock.openam.auth.node.api,",
        "  javax.security.auth.callback.TextOutputCallback",
        ");",
        "outcome = "true";",
        "with (fr) {",
        "  if (callbacks.isEmpty()) {",
        "    var callback = new TextOutputCallback(TextOutputCallback.INFORMATION, "sharedState: ".concat(sharedState.toString()));",
        "    action = Action.send(callback).build();",
        "  } else {",
        "    action = Action.goTo("true").build();",
        "  }",
        "}",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -A": should export all scripts to separate files: ./temp.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "2aaa8076-5d0b-4433-9660-fec1ba51b608": {
      "_id": "2aaa8076-5d0b-4433-9660-fec1ba51b608",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "temp",
      "script": [
        "/*",
        "  - Data made available by nodes that have already executed are available in the sharedState variable.",
        "  - The script should set outcome to either "true" or "false".",
        " */",
        "outcome = "false";",
        "if(sharedState.get("userName"))",
        "{",
        "var username = sharedState.get("userName")",
        "var id = sharedState.get("_id")",
        "var persona = existingSession.get('persona')",
        "",
        "sharedState.put("debug",username);",
        "sharedState.put("debug_id",id);",
        "sharedState.put("persona",persona);",
        "",
        "if(username!=='')",
        "{",
        "  outcome = "true";",
        "}}",
        "",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files 1`] = `""`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./AA-Custom-Policy-Engine.script.js 1`] = `
"/* AA Custom Policy Engine
 *
 * Author: marcin.zimny@forgerock.com
 * Adaptations: volker.scheuber@forgerock.com
 * 
 * Custom policy engine combining the Autonomous Access risk engine output with external systems and custom policy output:
 * 
 * - use multiple risk scoring policies (currently it's part of risk config file and used across all evaluations)
 * - deliver custom logic of delivering outcome (we can sum the signals instead of returning the highest)
 * - use custom signals as part of the (single) risk node (for example anonymisation detection)
 * - exceptions/overrides (i.e. if we have to allow a flow with high risk for whatever reason) 
 * 
 * This script needs to be parametrized. It will NOT work properly as is!
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - low
 * - medium
 * - high
 * - failed
 */
(function () {
  /* 
   * MUST CONFIGURE THIS SECTION
   * Custom signals parameters
   */
  
  // IPQualityScore API
  var USER_AGENT = "ForgeRock"
  var API_KEY = systemEnv.getProperty("esv.ipqs.api.key");
  
  /*
   * END MANDATORY CONFIGURATION
   */
  
  outcome = "failed"; //default outcome
  /*
    Risk Policy - Signal Scores
  */
  var aa_impossible_travel_score = 21;
  var aa_credential_stuffing_score = 100;
  var aa_automated_user_agent_score = 25;
  var aa_brute_force_score = 100;
  var aa_suspicious_ip_score = 35;
  /*
    Risk Policy - Custom Signals
  */
  var aa_use_anonymizer_detection = 1;
  var custom_aa_tor_detected_score = 50;
  var custom_aa_vpn_detected_score = 20;
  var custom_aa_proxy_detected_score = 20;
  /*
    Risk Policy - Thresholds And Extra Features
  */
  var aa_medium_risk_threshold = 30;
  var aa_high_risk_threshold = 75;
  var aa_max_signal_count_high_risk_override = 99;
  /*
    Risk Policy - Method
      0 - highest score out of all triggered signals
      1 - summary of all triggered signals
  */
  var aa_risk_method=1;
  /*
    Risk Policy - UEBA method
      0 - highest score out of 3 models
      1 - average score out of 3 models
  */
  var aa_ueba_method=0;
  /*
    Risk Policy - Overrides

    Whitelist - false positive control
    Blacklist - preventative block
    Example - ip_whitelist or ip_blacklist = ["62.21.63.30-62.21.63.30","82.21.168.1-82.21.168.255"];
  */
  var ip_whitelist = [];
  var ip_blacklist = [];
  
  /********************************************************
    The engine *
  */
  //Define variables
  var signal_count = 0;
  var pos = 0;
  var arr_scores = [];
  var arr_scores_models = [];
  var score = 0;
  var predictionResultChopped;
  var predictionResultChoppedVal;
  //Define signal variables and assign defaults (negative)
  var is_impossible_travel = 0;
  var is_credential_stuffing = 0;
  var is_automated_user_agent = 0;
  var is_brute_force = 0;
  var is_suspicious_ip = 0;
  var model1_score = 0;
  var model2_score = 0;
  var model3_score = 0;
  var isAnonymizedResult;
  //Get risk data
  var predictionResultRaw = sharedState.get("predictionResult");
  var predictionResultString = predictionResultRaw.toString();

  var result;

  function inet_aton (ip)
  {
      return ip.split(".").reduce((int, v) => int * 256 + +v);
  }


  function isAnonymized()
  {
    var payload = sharedState.get("IPQualityScore")

    if (payload)
    {
      var jsonResult = JSON.parse(payload);
    }
    else
    {
      var ipaddress = requestHeaders.get("X-FORWARDED-FOR").get(0).split(",")[0].trim();

      var request = new org.forgerock.http.protocol.Request();
      request.setMethod("GET");
      request.setUri("https://ipqualityscore.com/api/json/ip/" + API_KEY + "/" + ipaddress + "?strictness=0&allow_public_access_points=false&fast=false&lighter_penalties=false&mobile=false");
      request.getHeaders().add("Accept","application/json");
      request.getHeaders().add("User-Agent", USER_AGENT);

      var response = httpClient.send(request).get();
      if (response.getStatus().getCode() === 200) {
        var payload = response.getEntity().getString();
        var jsonResult = JSON.parse(payload)
          if (jsonResult.success === true) {
          sharedState.put("Debug-IPQualityScore", payload);
        }
      }
    }

    if (jsonResult) {
      if (jsonResult.tor === true) {
        isAnonymizedResult = "tor";
      } else if (jsonResult.vpn === true) {
        isAnonymizedResult= "vpn";
      } else if (jsonResult.proxy === true) {
        isAnonymizedResult = "proxy";
      } else {
        isAnonymizedResult = "not_detected";
      }
    }
  }


  if(aa_use_anonymizer_detection==1)
  {
    isAnonymized();
    sharedState.put("custom_aa_isAnonymized",isAnonymizedResult);
    if(isAnonymizedResult=="vpn")
    {
      arr_scores.push(custom_aa_vpn_detected_score);
    }
    else if(isAnonymizedResult=="proxy")
    {
      arr_scores.push(custom_aa_proxy_detected_score);
    }
    else if(isAnonymizedResult=="tor")
    {
      arr_scores.push(custom_aa_tor_detected_score);
    }
    else
    {
      arr_scores.push(0);
    }
  }

  if(predictionResultString.search("risk_score_data")>=0)
  {
    outcome = "low"; //default if there's data from risk API
  }

  //Check if we're assessing impossible travel and assign result
  pos = predictionResultString.search("impossibleTravellerCheck=true");
  if(pos>0)
  {
    pos = predictionResultString.search("is_impossible_travel=false");
    if(pos<0)
    {
      signal_count++;
      is_impossible_travel=1;
      arr_scores.push(aa_impossible_travel_score);
    }
  }
  //Check if we're assessing credential stuffing and assign result
  pos = predictionResultString.search("credentialStuffing=true");
  if(pos>0)
  {
    pos = predictionResultString.search("is_credential_stuffing=false");
    if(pos<0)
    {
      signal_count++;
      is_credential_stuffing=1;
      arr_scores.push(aa_credential_stuffing_score);
    }
  }
  //Check if we're assessing automated user angent (antibot) and assign result
  pos = predictionResultString.search("automatedUserAgentsFilter=true");
  if(pos>0)
  {
    pos = predictionResultString.search("is_automated_user_agent=false");
    if(pos<0)
    {
      signal_count++;
      is_automated_user_agent=1;
      arr_scores.push(aa_automated_user_agent_score);
    }
  }
  //Check if we're assessing brute-force and assign result
  pos = predictionResultString.search("bruteForcePreventionCheck=true");
  if(pos>0)
  {
    pos = predictionResultString.search("is_brute_force=false");
    if(pos<0)
    {
      signal_count++;
      is_brute_force=1;
      arr_scores.push(aa_brute_force_score);
    }
  }
  //Check if we're assessing suspicious IP and assign result
  pos = predictionResultString.search("suspiciousIPCheck=true");
  if(pos>0)
  {
    pos = predictionResultString.search("is_suspicious_ip=false");
    if(pos<0)
    {
      signal_count++;
      is_suspicious_ip=1;
      arr_scores.push(aa_suspicious_ip_score);
    }
  }
  //Check if we're assessing UEBA and assign result
  pos = predictionResultString.search("anomalyDetection=true");
  if(pos>0)
  {
    pos = predictionResultString.search("clustering_result=");
    if(pos>0)
    {
        predictionResultChopped=predictionResultString.substring(pos);
        predictionResultChopped=predictionResultChopped.substring(predictionResultChopped.search("risk_score="));
        predictionResultChoppedVal=predictionResultChopped.substring(11,predictionResultChopped.search(","));
        predictionResultChopped=predictionResultChopped.substring(11);
        model1score=parseInt(predictionResultChoppedVal,10);

        predictionResultChopped=predictionResultChopped.substring(predictionResultChopped.search("risk_score="));
        predictionResultChoppedVal=predictionResultChopped.substring(11,predictionResultChopped.search(","));
        predictionResultChopped=predictionResultChopped.substring(11);
        model2score=parseInt(predictionResultChoppedVal,10);

        predictionResultChopped=predictionResultChopped.substring(predictionResultChopped.search("risk_score="));
        predictionResultChoppedVal=predictionResultChopped.substring(11,predictionResultChopped.search(","));
        predictionResultChopped=predictionResultChopped.substring(11);
        model3score=parseInt(predictionResultChoppedVal,10);

        arr_scores_models.push(model1score,model2score,model3score);
    }
  }

  //Deliver risk score
  if(aa_ueba_method==0)
  {
    score = Math.max.apply(null, arr_scores_models);
  }
  else if(aa_ueba_method==1)
  {
    score = arr_scores_models.reduce((a, b) => a + b, 0)/arr_scores_models.length;
  }
  arr_scores.push(score);


  if(aa_risk_method==0)
  {
    score = Math.max.apply(null, arr_scores);
  }
  else if (aa_risk_method===1)
  {
    score = arr_scores.reduce((a, b) => a + b, 0);
  }
  //Deliver risk outcome
  if(score>aa_medium_risk_threshold)
  {
    outcome="medium";
  }
  if(score>aa_high_risk_threshold)
  {
    outcome="high";
  }
  if(signal_count>=aa_max_signal_count_high_risk_override && outcome=="medium")
  {
    outcome="high";
    sharedState.put("debug-signal-count-override","true");
  }

  //process the blacklist and whitelist
  var src_ipaddress;
  var src_ipaddress_dec;
  var list_first_ipaddress_dec;
  var list_last_ipaddress_dec;
  var list_entry;
  var logmessage;
  src_ipaddress = requestHeaders.get("X-FORWARDED-FOR").get(0).split(",")[0].trim();
  src_ipaddress_dec = inet_aton(src_ipaddress);

  if(ip_blacklist.length>0)
  {
    for (var i = 0; i < ip_blacklist.length; i++)
    {
      list_entry = ip_blacklist[i].split("-");
      list_first_ipaddress_dec=inet_aton(list_entry[0]);
      list_last_ipaddress_dec=inet_aton(list_entry[1]);

      if(src_ipaddress_dec>=list_first_ipaddress_dec && src_ipaddress_dec<=list_last_ipaddress_dec)
      {
          sharedState.put("debug-blacklist","condition met for: " + src_ipaddress + ", " + outcome + "->high");
           outcome="high";
      }
    }
  }
  if(ip_whitelist.length>0)
  {
    for (var i = 0; i < ip_whitelist.length; i++)
    {
      //list_entry = ip_whitelist[i].split("-");
      list_entry = ip_whitelist[i].split("-");
      list_first_ipaddress_dec=inet_aton(list_entry[0]);
      list_last_ipaddress_dec=inet_aton(list_entry[1]);
      if(src_ipaddress_dec>=list_first_ipaddress_dec && src_ipaddress_dec<=list_last_ipaddress_dec)
      {
        sharedState.put("debug-whitelist","condition met for: " + src_ipaddress + ", " + outcome + "->low");
        outcome = "low";
      }
    }
  }



  sharedState.put('debug-score',score.toString());
  sharedState.put('debug-signal-count',signal_count.toString());
  sharedState.put('debug-outcome',outcome);
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./AA-Custom-Policy-Engine.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "9e9c6c4d-5d9d-4990-9f05-d8b2b25ad52b": {
      "_id": "9e9c6c4d-5d9d-4990-9f05-d8b2b25ad52b",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Custom risk policy engine combining Autonomous Access signals with external signals.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "AA Custom Policy Engine",
      "script": "file://AA-Custom-Policy-Engine.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./AAD-Passthru-ROPC.script.js 1`] = `
"/* AAD Passthru ROPC
 *
 * Author: volker.scheuber@forgerock.com
 * 
 * Azure AD pass through authentication using Resource Owner Password Credential flow
 * 
 * This script needs to be parametrized. It will not work properly as is. 
 * It requires the Platform Username and Platform Password collector nodes
 * before it can operate.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - Valid
 * - Invalid
 * - Expired
 * - Disabled
 * - Error
 */
logger.message("AAD Passthru ROPC: start");

if (sharedState.get("username") && transientState.get("password")) {
      /*
     * BEGIN SCRIPT CONFIGURATION
     *
     * REPLACE WITH YOUR OWN AZURE AD SETTINGS
     *
     * AAD_TENANT_ID is your tenant ID: https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/active-directory-how-to-find-tenant
     * AAD_CLIENT_ID is your registered app ID: https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-register-app
     */
    var AAD_TENANT_ID = "711ffa9c-5972-4713-ace3-688c9732614a";
    var AAD_CLIENT_ID = "51f130ec-d29d-4419-a492-0011d09c1a16";
    /*
     * END SCRIPT CONFIGURATION
     */
      
    // Azure AD ROPC Configuration
    var AAD_SCOPE = "profile";
      var AAD_RESOURCE = "https://graph.microsoft.com/"
    var AAD_OAUTH2_TOKEN_URI = "https://login.windows.net/".concat(AAD_TENANT_ID).concat("/oauth2/token");

    var request = new org.forgerock.http.protocol.Request();
    request.setMethod('POST');
    request.setUri(AAD_OAUTH2_TOKEN_URI);
    request.getHeaders().add("Content-Type", "application/x-www-form-urlencoded");
    var params = request.getForm();
    params.add("resource", AAD_RESOURCE);
    params.add("client_id", AAD_CLIENT_ID);
    params.add("grant_type", "password");
    params.add("scope", AAD_SCOPE);
    params.add("username", sharedState.get("username"));
    params.add("password", transientState.get("password"));
    request.getEntity().setString(params.toString());

    var response = httpClient.send(request).get();
    var result = JSON.parse(response.getEntity().getString());
    //logger.message("AAD Passthru ROPC: JSON result: " + JSON.stringify(result));

      if (response.getStatus().getCode() === 200) {
          outcome = "Valid"
        transientState.put("aadAccessToken", result.access_token);
    } else {
        /* Outcomes:
         * - Valid
         * - Invalid
         * - Expired
         * - Disabled
         * - Error
         *
         * Expected Error Codes:
         * 50126 - Error validating credentials due to invalid username or password.
         * 50055 - The password is expired.
         * 50057 - The user account is disabled.
         * 50196 - The server terminated an operation because it encountered a client request loop. Please contact your app vendor.
         */
        if (result.error_codes.includes(50126)) {
            outcome = "Invalid";
        } else if (result.error_codes.includes(50055)) {
            outcome = "Expired";
        } else if (result.error_codes.includes(50057)) {
            outcome = "Disabled";
        } else {
            outcome = "Error";
        }
        logger.message("AAD Passthru ROPC: error = ".concat(result.error));
        logger.message("AAD Passthru ROPC: error_description = ".concat(result.error_description));
        logger.message("AAD Passthru ROPC: error_codes = ".concat(result.error_codes));
    }
} else {
      outcome = "Error";
      logger.message("AAD Passthru ROPC: No user or password found in shared state! Use username and password collector nodes before this script to populate shared and transient states!'");
}
logger.message("AAD Passthru ROPC: End (outcome=".concat(outcome).concat(")"));"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./AAD-Passthru-ROPC.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "13cd3c60-a04b-4455-b028-fbfd01ed88b1": {
      "_id": "13cd3c60-a04b-4455-b028-fbfd01ed88b1",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Azure AD pass through authentication using Resource Owner Password Credential flow",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "AAD Passthru ROPC",
      "script": "file://AAD-Passthru-ROPC.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./AAcustomLogic.script.js 1`] = `
"/*
  - Data made available by nodes that have already executed are available in the sharedState variable.
  - The script should set outcome to either "true" or "false".
 */
outcome = "false";
var predictionResult = sharedState.get("predictionResult");
var predictionResultString = predictionResult.toString();

var is_impossible_travel = 0;
var is_credential_stuffing = 0;
var is_automated_user_agent = 0;
var is_brute_force = 0;
var is_suspicious_ip = 0;

var signal_count = 0;
var position = 0;

position = predictionResultString.search("is_impossible_travel=false");
if(position<0)
{
  signal_count++;
  is_impossible_travel=1;
}
position = predictionResultString.search("is_credential_stuffing=false");
if(position<0)
{
  signal_count++;
  is_credential_stuffing=1;
}
position = predictionResultString.search("is_automated_user_agent=false");
if(position<0)
{
  signal_count++;
  is_automated_user_agent=1;
}
position = predictionResultString.search("is_brute_force=false");
if(position<0)
{
  signal_count++;
  is_brute_force=1;
}
position = predictionResultString.search("is_suspicious_ip=false");
if(position<0)
{
  signal_count++;
  is_suspicious_ip=1;
}

sharedState.put("debug-signal-count",signal_count);
if(signal_count>1)
{
     outcome="true"; 
}


"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./AAcustomLogic.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "71e3b4ae-52c1-49d6-98fd-c279f43ea3ce": {
      "_id": "71e3b4ae-52c1-49d6-98fd-c279f43ea3ce",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "AAcustomLogic",
      "script": "file://AAcustomLogic.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./ADFS-Profile-Normalization-(JS).script.js 1`] = `
"/*
 * Copyright 2022 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

/*
 * This script returns the social identity profile information for the authenticating user
 * in a standard form expected by the Social Provider Handler Node.
 *
 * Defined variables:
 * rawProfile - The social identity provider profile information for the authenticating user.
 *              JsonValue (1).
 * logger - The debug logger instance:
 *          https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.
 * realm - String (primitive).
 *         The name of the realm the user is authenticating to.
 * requestHeaders - TreeMap (2).
 *                  The object that provides methods for accessing headers in the login request:
 *                  https://backstage.forgerock.com/docs/am/7/authentication-guide/scripting-api-node.html#scripting-api-node-requestHeaders.
 * requestParameters - TreeMap (2).
 *                     The object that contains the authentication request parameters.
 * selectedIdp - String (primitive).
 *               The social identity provider name. For example: google.
 * sharedState - LinkedHashMap (3).
 *               The object that holds the state of the authentication tree and allows data exchange between the stateless nodes:
 *               https://backstage.forgerock.com/docs/am/7/auth-nodes/core-action.html#accessing-tree-state.
 * transientState - LinkedHashMap (3).
 *                  The object for storing sensitive information that must not leave the server unencrypted,
 *                  and that may not need to persist between authentication requests during the authentication session:
 *                  https://backstage.forgerock.com/docs/am/7/auth-nodes/core-action.html#accessing-tree-state.
 *
 * Return - a JsonValue (1).
 *          The result of the last statement in the script is returned to the server.
 *          Currently, the Immediately Invoked Function Expression (also known as Self-Executing Anonymous Function)
 *          is the last (and only) statement in this script, and its return value will become the script result.
 *          Do not use "return variable" statement outside of a function definition.
 *
 *          This script's last statement should result in a JsonValue (1) with the following keys:
 *          {
 *              {"displayName": "corresponding-social-identity-provider-value"},
 *              {"email": "corresponding-social-identity-provider-value"},
 *              {"familyName": "corresponding-social-identity-provider-value"},
 *              {"givenName": "corresponding-social-identity-provider-value"},
 *              {"id": "corresponding-social-identity-provider-value"},
 *              {"locale": "corresponding-social-identity-provider-value"},
 *              {"photoUrl": "corresponding-social-identity-provider-value"},
 *              {"username": "corresponding-social-identity-provider-value"}
 *          }
 *
 *          The consumer of this data defines which keys are required and which are optional.
 *          For example, the script associated with the Social Provider Handler Node and,
 *          ultimately, the managed object created/updated with this data
 *          will expect certain keys to be populated.
 *          In some common default configurations, the following keys are required to be not empty:
 *          username, givenName, familyName, email.
 *
 *          From RFC4517: A value of the Directory String syntax is a string of one or more
 *          arbitrary characters from the Universal Character Set (UCS).
 *          A zero-length character string is not permitted.
 *
 * (1) JsonValue - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/json/JsonValue.html.
 * (2) TreeMap - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/TreeMap.html.
 * (3) LinkedHashMap - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/LinkedHashMap.html.
 */

(function () {
    var frJava = JavaImporter(
        org.forgerock.json.JsonValue
    );

    var normalizedProfileData = frJava.JsonValue.json(frJava.JsonValue.object());
  
      //logger.message('Seguin rawProfile: '+rawProfile);

    normalizedProfileData.put('id', rawProfile.get('sub').asString());
    normalizedProfileData.put('displayName', rawProfile.get('givenName').asString() + ' ' + rawProfile.get('sn').asString());
    normalizedProfileData.put('email', rawProfile.get('mail').asString());
    normalizedProfileData.put('givenName', rawProfile.get('givenName').asString());
    normalizedProfileData.put('familyName', rawProfile.get('sn').asString());
    normalizedProfileData.put('username', rawProfile.get('upn').asString());
    normalizedProfileData.put('roles', rawProfile.get('roles').asString());
  
      //logger.message('Seguin normalizedProfileData: '+normalizedProfileData);

    return normalizedProfileData;
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./ADFS-Profile-Normalization-(JS).script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "dbe0bf9a-72aa-49d5-8483-9db147985a47": {
      "_id": "dbe0bf9a-72aa-49d5-8483-9db147985a47",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Normalizes raw profile data from ADFS",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "ADFS Profile Normalization (JS)",
      "script": "file://ADFS-Profile-Normalization-(JS).script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./APIProtection:-Get-Key-And-Secret.script.js 1`] = `
"logger.warning("APIProtection: Get Key And Secret: start");

/*
 * BEGIN SCRIPT CONFIGURATION
 */
var KEY_HEADER_NAME = "x-api-key";
var SECRET_HEADER_NAME = "x-api-secret";
var USERNAME_HEADER_NAME = "X-OpenAM-Username";
var PASSWORD_HEADER_NAME = "X-OpenAM-Password";
/*
 * END SCRIPT CONFIGURATION
 */

outcome = "false";

var key = getHeader(KEY_HEADER_NAME) || readValue(KEY_HEADER_NAME) || null;
var secret = getHeader(SECRET_HEADER_NAME) || readTransientValue(SECRET_HEADER_NAME) || null;

var username = sharedState.get("username") || null;
var password = transientState.get("password") || null;

if (key && secret) {
    logger.warning("APIProtection: Get Key And Secret: key=".concat(key));
  
      storeValue(KEY_HEADER_NAME, key);
      storeValue("username", username);
      sharedState.put("username", key);
      
      storeTransientValue(SECRET_HEADER_NAME, secret);
      storeTransientValue("password", password);
      transientState.put("password", secret);
  
    outcome = "true";
}

logger.warning("APIProtection: Get Key And Secret: finish [outcome=".concat(outcome).concat("]"));

/*
 * Returns the value of the requested header
 */
function getHeader(headerName) {
      if (requestHeaders.get(headerName) && requestHeaders.get(headerName).get(0)) {
        return requestHeaders.get(headerName).get(0).toString();
    }
      return null;
}

/*
 * Store value for APIProtection script use
 */
function storeValue(name, value) {
      var storage = sharedState.get("APIProtection");
    if (storage && value) {
          if (storage.put) {
            storage.put(name, value);
        }
          else {
              storage[name] = value;
        }
    }
    else if (value) {
        sharedState.put("APIProtection", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));
    }
}

/*
 * Read value from storage for APIProtection script use
 */
function readValue(name) {
      var storage = sharedState.get("APIProtection");
    if (storage) {
          if (storage.get) {
            return sharedState.get("APIProtection").get(name);
        }
          else {
              return storage.name;
        }
    }
      return null;
}

/*
 * Store transient value for APIProtection script use
 */
function storeTransientValue(name, value) {
    var transientStorage = transientState.get("APIProtection");
    if (transientStorage && value) {
          if (transientStorage.put) {
            transientStorage.put(name, value);
        }
          else {
              transientStorage[name] = value;
        }
    }
    else if (value) {
        transientState.put("APIProtection", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));
    }
}

/*
 * Read transient value from storage for APIProtection script use
 */
function readTransientValue(name) {
      var transientStorage = transientState.get("APIProtection");
    if (transientStorage) {
          if (transientStorage.get) {
            return transientState.get("APIProtection").get(name);
        }
          else {
              return transientStorage.name;
        }
    }
      return null;
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./APIProtection:-Get-Key-And-Secret.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "9399ac8b-3a6e-423b-95a2-6e0fd07262b1": {
      "_id": "9399ac8b-3a6e-423b-95a2-6e0fd07262b1",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "APIProtection: Get Key And Secret",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "APIProtection: Get Key And Secret",
      "script": "file://APIProtection:-Get-Key-And-Secret.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./APIProtection:-Reset-States.script.js 1`] = `
"logger.warning("APIProtection: Reset States: start");

/*
 * BEGIN SCRIPT CONFIGURATION
 *
 * Outcomes:
 * - "true"
 */
var KEY_HEADER_NAME = "x-api-key";
var SECRET_HEADER_NAME = "x-api-secret";
/*
 * END SCRIPT CONFIGURATION
 */

outcome = "true";

if (sharedState.get("username") == readValue(KEY_HEADER_NAME)) {
    logger.warning("APIProtection: Reset States: resetting username to:".concat(readValue("username")));
      sharedState.put("username", readValue("username"));
}

if (transientState.get("password") == readTransientValue(SECRET_HEADER_NAME)) {
    logger.warning("APIProtection: Reset States: resetting password");
      transientState.put("password", readTransientValue("password"));
}

logger.warning("APIProtection: Reset States: finish [outcome=".concat(outcome).concat("]"));

/*
 * Read value from storage for APIProtection script use
 */
function readValue(name) {
      var storage = sharedState.get("APIProtection");
    if (storage) {
          if (storage.get) {
            return sharedState.get("APIProtection").get(name);
        }
          else {
              return storage.name;
        }
    }
      return null;
}

/*
 * Read transient value from storage for APIProtection script use
 */
function readTransientValue(name) {
      var transientStorage = transientState.get("APIProtection");
    if (transientStorage) {
          if (transientStorage.get) {
            return transientState.get("APIProtection").get(name);
        }
          else {
              return transientStorage.name;
        }
    }
      return null;
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./APIProtection:-Reset-States.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "f1a2764b-d05a-4480-8f5f-78fda7814227": {
      "_id": "f1a2764b-d05a-4480-8f5f-78fda7814227",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "APIProtection: Reset State",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "APIProtection: Reset States",
      "script": "file://APIProtection:-Reset-States.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_AmadminCheck.script.js 1`] = `
"/*
 * Copyright 2023 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

var fr = new JavaImporter(
  java.util.HashMap
);

with (fr) {
  try {
    
    if (sharedState.get('username').toLowerCase() == 'amadmin') {
      outcome = 'True';
    } else {
      outcome = 'False';
    }
    
  } catch (e) {

    logger.error('Failed to determine if user is amadmin: {}', e);
    outcome = 'Error';

  }
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_AmadminCheck.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "b7ce17a1-e41d-42b0-bedc-f88a4d5e1c3a": {
      "_id": "b7ce17a1-e41d-42b0-bedc-f88a4d5e1c3a",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Prepares onboarding check if not amadmin",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_AmadminCheck",
      "script": "file://Admin_AmadminCheck.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_AttributeCollectionWorkaroundCleanup.script.js 1`] = `
"/*
 * Copyright 2023 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

/*
This is the second part of a workaround began in Admin_AttributeCollectionWorkaround.
*/

var objAttrs = sharedState.get('objectAttributes') || new HashMap();

if (objAttrs.containsKey('groups')) {
  var groups = objAttrs.get('groups');
  if (groups.length == 1 && groups[0] == 'fake') {
    objAttrs.remove('groups');
  }
}

if (objAttrs.containsKey('inviteDate') && objAttrs.get('inviteDate') == 'fake') {
   objAttrs.remove('inviteDate');
}

sharedState.put('objectAttributes', objAttrs);

outcome = 'True';"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_AttributeCollectionWorkaroundCleanup.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "fd536b1f-6ee4-4505-b148-71160414ddcc": {
      "_id": "fd536b1f-6ee4-4505-b148-71160414ddcc",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_AttributeCollectionWorkaroundCleanup",
      "script": "file://Admin_AttributeCollectionWorkaroundCleanup.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_CanBeInvited.script.js 1`] = `
"/*
 * Copyright 2023 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

(function() {
  var fr = new JavaImporter(
    org.forgerock.openam.auth.nodes,
    org.forgerock.guice.core
  );

  with (fr) {
    try {

      outcome = 'False';

      var realm = sharedState.get('realm');
      var uuid = sharedState.get('username');
      var identityProvider = InjectorHolder.getInstance(IdentityProvider);
      var identity = identityProvider.getIdentity(uuid, realm);
      var attrs = identity.getAttributes();

      if (!attrs.containsKey('fr-idm-inviteDate')) {
        logger.message('Admin cannot be invited: no invite date');
        return;
      }

      if (attrs.containsKey('fr-idm-onboardDate')) {
        logger.message('Admin cannot be invited: already onboarded');
        return;
      }

      var email = attrs.get('mail').iterator().next();
      var objAttrs = {
        mail: email,
        userName: email,
      };
      sharedState.put('objectAttributes', objAttrs);

      logger.message('Admin can be invited');
      outcome = 'True';

    } catch (e) {

      logger.error('Failed to determine if admin can be invited: {}', e);

    }
  }
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_CanBeInvited.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "0d471aff-81f3-41ce-8bf9-35c27cdc0a26": {
      "_id": "0d471aff-81f3-41ce-8bf9-35c27cdc0a26",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_CanBeInvited",
      "script": "file://Admin_CanBeInvited.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_ClearCurrentYear.script.js 1`] = `
"if (sharedState.containsKey('objectAttributes')) {
  sharedState.get('objectAttributes').remove('currentYear');
}

outcome = 'True';
"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_ClearCurrentYear.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "4a9aefc4-be0e-4625-95c3-ee8f354bce35": {
      "_id": "4a9aefc4-be0e-4625-95c3-ee8f354bce35",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_ClearCurrentYear",
      "script": "file://Admin_ClearCurrentYear.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_CollectUsernameOrEmail.script.js 1`] = `
"var fr = JavaImporter(
  org.forgerock.json.JsonValue,
  org.forgerock.openam.auth.node.api.Action,
  javax.security.auth.callback.NameCallback,
  java.util.HashMap
);

with (fr) {
  try {
    
    if (callbacks.isEmpty()) {
      
      action = Action.send(new NameCallback('Username or email address')).build();
      
    } else {

      // If a value is provided, store it as username and an object attribute
      var callback = callbacks.iterator().next();
      var name = callback.getName().trim();
      if (name) {
        var objAttrs = sharedState.get('objectAttributes') || new HashMap();
        objAttrs.put('mail', name);
        sharedState.put('username', name);
        sharedState.put('objectAttributes', objAttrs);

        action = Action.goTo('Collected').build();
      }
      
    }
    
  } catch (e) {
    
    logger.error('Admin_CollectUsernameOrEmail: {}', e);
    action = Action.goTo('Error').build();
    
  }
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_CollectUsernameOrEmail.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "e9c9d940-30d9-4a0c-a834-7de69a0600cf": {
      "_id": "e9c9d940-30d9-4a0c-a834-7de69a0600cf",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_CollectUsernameOrEmail",
      "script": "file://Admin_CollectUsernameOrEmail.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_EnableEmailClaimCheck.script.js 1`] = `
"/*
 * Copyright 2023 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

nodeState.putShared('checkEmailClaim', true);

outcome = 'True';"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_EnableEmailClaimCheck.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "cfb208d8-241c-4953-b87b-bf59d1ab3d05": {
      "_id": "cfb208d8-241c-4953-b87b-bf59d1ab3d05",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_EnableEmailClaimCheck",
      "script": "file://Admin_EnableEmailClaimCheck.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_ForgotUsernameMailCheck.script.js 1`] = `
"var fr = new JavaImporter(
  org.forgerock.openam.auth.nodes,
  org.forgerock.guice.core,
  java.util.HashMap
);

// This confirms the Identify Existing User node was able to find the
// admin, otherwise we remove the mail attribute so no email can be sent
with (fr) {
  try {

    var objAttrs = sharedState.get('objectAttributes') || new HashMap();
    var username = objAttrs.get('userName');
    outcome = username ? 'Valid' : 'Invalid';
    if (username) {
      outcome = 'Valid';
    } else {
      objAttrs.remove('mail');
      sharedState.put('objectAttributes', objAttrs);
      outcome = 'Invalid';
    }

    logger.message('Admin_ForgotUsernameMailCheck: ' + outcome);

  } catch (e) {

    logger.error('Admin_ForgotUsernameMailCheck: Failed to determine mail validity');
    logger.error(e);
    outcome = 'Error';

  }
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_ForgotUsernameMailCheck.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "5e68fee3-047d-4fff-8e99-89fb5908f068": {
      "_id": "5e68fee3-047d-4fff-8e99-89fb5908f068",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_ForgotUsernameMailCheck",
      "script": "file://Admin_ForgotUsernameMailCheck.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_GetIdPGroupsClaimConfig.script.js 1`] = `
"/*
 * Copyright 2023 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

/*
 * This script is used to retrieve optional custom IdP configuration from IDM as an admin
 * completes a login journey. This needs to happen after an IdP has been selected so that
 * the \`selectedIdp\` exists in shared state. The result will be stored in a shared state
 * key of \`idpCustomConfig\`. The value will be \`null\` if no config was found in IDM.
 */

var AM_INTERNAL_URL = 'http://am.fr-platform:80/am';
var IDM_INTERNAL_URL = 'http://idm.fr-platform:80/openidm';
var RSFILTER_PROVISIONING_CLIENT_ID = 'idm-provisioning';
var RSFILTER_PROVISIONING_SECRET = 'DKNK5K2m5Q98tBTt0yei';

var SHARED_STATE_KEY = 'idpCustomConfig';
var TXN_ID_HEADER = 'x-forgerock-transactionid';

// Helper for returning the request transaction ID
function getTransId() {
  var transIds = requestHeaders.get(TXN_ID_HEADER);
  if (transIds) {
    return java.lang.String(transIds.get(0));
  }
  return null;
}

// Retrieves an access token using a client credentials grant
function getAccessToken(txnId, clientId, clientSecret, scope) {
  var fr = JavaImporter(
    java.lang.String,
    org.forgerock.http.protocol.Request,
    org.forgerock.http.protocol.Response,
    org.forgerock.util.encode.Base64
  );

  var basicAuthCreds = fr.Base64.encode(new fr.String(clientId + ':' + clientSecret).getBytes('UTF-8'));

  var request = new fr.Request();
  request.getHeaders().add('authorization', 'Basic ' + basicAuthCreds);
  request.getHeaders().add('content-type', 'application/x-www-form-urlencoded');
  if (txnId) {
    request.getHeaders().add(TXN_ID_HEADER, txnId);
  }
  request
    .setEntity('grant_type=client_credentials&scope=' + scope)
    .setMethod('POST')
    .setUri(AM_INTERNAL_URL + '/oauth2/access_token');

  var response = httpClient.send(request).getOrThrow();
  if (response.getStatus() === org.forgerock.http.protocol.Status.OK) {
    var result = JSON.parse(response.getEntity().getString());
    logger.message('got access token for client {}', clientId);
    return result.access_token;
  }
  
  logger.error('failed to get access token for client {}; received status {}', clientId, response.getStatus());
  throw 'failed to get access token';
}

// Retrieves the IdP custom configuration from IDM
function getConfigFromIDM(txnId, accessToken, idp) {
  var fr = JavaImporter(
    org.forgerock.http.protocol.Request,
    org.forgerock.http.protocol.Response,
    org.forgerock.json.JsonValue,
    org.forgerock.openam.placeholder.substitution.PlaceholderSubstitution,
    org.forgerock.guice.core.InjectorHolder
  );

  var request = new fr.Request();
  request.getHeaders().add('authorization', 'Bearer ' + accessToken);
  if (txnId) {
    request.getHeaders().add(TXN_ID_HEADER, txnId);
  }
  request
    .setMethod('GET')
    .setUri(IDM_INTERNAL_URL + '/config/fidc/federation-' + idp);

  var response = httpClient.send(request).getOrThrow();
  if (response.getStatus() === org.forgerock.http.protocol.Status.OK) {
    var rawConfig = JSON.parse(response.getEntity().getString());
    var placeholder = fr.InjectorHolder.getInstance(fr.PlaceholderSubstitution);
    var finalConfig = JSON.parse(placeholder.substitute(fr.JsonValue.json(rawConfig)));
    return finalConfig;
  } else if (response.getStatus() === org.forgerock.http.protocol.Status.NOT_FOUND) {
    return null;
  }
  
  logger.error('failed to get groups claim config for IdP {}; received status {}', idp, response.getStatus());
  throw 'failed to get groups claim config';
}

(function () {
  try {
    var idp = nodeState.get('selectedIdp');
    if (!idp.isString()) {
      throw 'selectedIdp not found in shared state';
    }

    var txnId = getTransId();
    var accessToken = getAccessToken(txnId, RSFILTER_PROVISIONING_CLIENT_ID, RSFILTER_PROVISIONING_SECRET, 'fr:idm:*');

    var config = getConfigFromIDM(txnId, accessToken, idp.asString())
    if (config) {
      nodeState.putShared(SHARED_STATE_KEY, config);
      logger.message('found groups claim config for IdP {}', idp.asString());
    } else {
      logger.message('no groups claim config found for IdP {}', idp.asString());
    }
 
    outcome = 'Success';
  } catch (e) {
    logger.error('failed to get federation config from IDM: {}', e);
    outcome = 'Error';
  }
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_GetIdPGroupsClaimConfig.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "fd560219-00ad-4763-9a29-f65aa9ecf776": {
      "_id": "fd560219-00ad-4763-9a29-f65aa9ecf776",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_GetIdPGroupsClaimConfig",
      "script": "file://Admin_GetIdPGroupsClaimConfig.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_HasOnboarded.script.js 1`] = `
"/*
 * Copyright 2023 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

(function() {
  var fr = new JavaImporter(
    org.forgerock.openam.auth.nodes,
    org.forgerock.guice.core
  );

  with (fr) {
    try {

      outcome = 'False';

      var realm = sharedState.get('realm');
      var uuid = sharedState.get('_id');
      var identityProvider = InjectorHolder.getInstance(IdentityProvider);
      var identity = identityProvider.getIdentity(uuid, realm);
      var attrs = identity.getAttributes();

      if (attrs.containsKey('fr-idm-onboardDate')) {
        logger.message('Admin has onboard date');
        outcome = 'True';
      }

    } catch (e) {

      logger.error('Failed to determine if admin has onboarded: {}', e);
      outcome = 'Error';

    }
  }
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_HasOnboarded.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "13b6a418-4ccc-41b6-86ce-0a13f352da22": {
      "_id": "13b6a418-4ccc-41b6-86ce-0a13f352da22",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_HasOnboarded",
      "script": "file://Admin_HasOnboarded.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_IdPNormalization.script.js 1`] = `
"/*
 * Copyright 2023 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

/*
 * This script maps token claim values to managed object attributes. It uses a "claim map" that defines
 * several common claim names for a given attribute so that this same script can be used for all IdPs.
 * For example, the attribute \`familyName\` can be populated from claims \`familyName\`, \`family_name\`, or \`sn\`.
 * 
 * Also, if custom IdP config exists in shared state and defines IdP-to-IDC group membership mappings,
 * those will be applied/enforced by this script. 
 */

var SHARED_STATE_KEY = 'idpCustomConfig';

// Helper to avoid strict comparison of string objects
function containsGroup(jsArray, javaString) {
  for (var i = 0; i < jsArray.length; i++) {
    if (jsArray[i] == javaString) {
      return true;
    }
  }
  return false;
}

(function () {
  var fr = JavaImporter(
    java.lang.String,
    java.util.ArrayList,
    org.forgerock.json.JsonValue
  );
  
  var normalizedProfileData = fr.JsonValue.json(fr.JsonValue.object());
  var idpConfig = sharedState.get(SHARED_STATE_KEY);

  // If we have config that defines a groups claim map for this IdP, ensure the claim value matches one that's in the map
  if (idpConfig && idpConfig.groups) {

    logger.message('enforcing groups claim config');

    // Get the groups claim from the IdP profile
    var groupsClaim = rawProfile.get(idpConfig.groups.claim);
    if (groupsClaim.isNull()) {
      logger.error('groups claim map was enabled for "{}", but claim "{}" was not found in the raw profile', selectedIdp, idpConfig.groups.claim);
      throw 'Required groups claim is missing from raw profile';
    }

    logger.message('received group claim value {}', groupsClaim);

    // Validate the claim type and convert strings to single-value collection
    var groupsClaimList;
    if (groupsClaim.isCollection()) {
      groupsClaimList = groupsClaim;
    } else if (groupsClaim.isString()) {
      groupsClaimList = new fr.ArrayList();
      groupsClaimList.add(groupsClaim);
    } else {
      throw 'Groups claim was not a string or collection';
    }
    
    // Assert the claim contains at least one group
    var groupsClaimLen = groupsClaimList.size();
    if (groupsClaimLen < 1) {
      throw 'An empty groups claim was found in raw profile';
    }

    // Loop through each IDC group name in the map. If the raw profile groups claim contains
    // a value that matches the map for that IDC group, add that IDC group to the list for this admin.
    var groups = [];
    for (var idcGroupName in idpConfig.groups.mappings) {
      for (var i = 0; i < groupsClaimLen; i++) {
        var claimGroupId = groupsClaimList.get(i).asString();

        logger.message('checking if mapping for IDC group "{}" contains claim value "{}"', idcGroupName, claimGroupId);

        if (containsGroup(idpConfig.groups.mappings[idcGroupName], claimGroupId)) {
          groups.push(idcGroupName);
        }
      }
    }

    // Assert at least one group was mapped to the claim
    if (groups.length == 0) {
      logger.error('groups claim map was enabled for "{}", but the value of claim "{}" did not match a group mapping', selectedIdp, idpConfig.groups.claim);
      throw 'Raw profile groups claim value does not match a configured mapping';
    }

    normalizedProfileData.put('groups', groups);
    sharedState.put('groups', groups);
  } else {
    logger.message('no enabled groups claim config to enforce');
  }

  // Maps normalized profile keys to the possible raw profile keys that values can come from
  var claimMap = {
    email: ['email', 'mail'],
    familyName: ['familyName', 'family_name', 'sn'],
    givenName: ['givenName', 'given_name']
  };

  // Try to populate each normalized profile property
  var keys = Object.keys(claimMap);
  for (var i = 0; i < keys.length; i++) {
    var normalizedProp = keys[i];
    // Try each mapped raw profile key until a value is found
    for (var j = 0; j < claimMap[normalizedProp].length; j++) {
      var rawProp = claimMap[normalizedProp][j];
      if (!rawProfile.get(rawProp).isNull()) {
        normalizedProfileData.put(normalizedProp, rawProfile.get(rawProp));
        break;
      }
    }
  }

  return normalizedProfileData;
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_IdPNormalization.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "dc0c9905-4a58-4f61-8562-337514e610a7": {
      "_id": "dc0c9905-4a58-4f61-8562-337514e610a7",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_IdPNormalization",
      "script": "file://Admin_IdPNormalization.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_IsFederationEnforcedForUser.script.js 1`] = `
"/*
 * Copyright 2023 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

var fr = new JavaImporter(
  org.forgerock.openam.auth.nodes,
  org.forgerock.guice.core
);

with (fr) {
  var enforcement = 'none';

  function isSuperAdmin() {
    var uuid = sharedState.get('_id');
    var realm = sharedState.get('realm');
    var identityProvider = InjectorHolder.getInstance(IdentityProvider);
    var identity = identityProvider.getIdentity(uuid, realm);
    var groups = identity.getAttribute('fr-attr-group').toArray();
    for (var i = 0; i < groups.length; i++) {
      if (groups[i] == 'super-admins') {
        return true;
      }
    }
    return false;
  }

  try {
    switch (enforcement) {
      case 'none':
        outcome = 'False';
        break;
      case 'all':
        outcome = 'True';
        break;
      default:
        outcome = isSuperAdmin() ? 'False' : 'True';
        break;
    }
  } catch (e) {
    logger.error('Failed to determine if federation is enforced for user: {}', e);
    outcome = 'Error';
  }
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_IsFederationEnforcedForUser.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "1e8175a2-6114-415f-9b72-9fe15bdf3661": {
      "_id": "1e8175a2-6114-415f-9b72-9fe15bdf3661",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_IsFederationEnforcedForUser",
      "script": "file://Admin_IsFederationEnforcedForUser.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_IsInvited.script.js 1`] = `
"/*
 * Copyright 2023 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

if (sharedState.get('invited') == true) {
  outcome = 'True';
} else {
  outcome = 'False';
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_IsInvited.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "6dfc6de4-64cb-4d47-8269-6c5ced44344d": {
      "_id": "6dfc6de4-64cb-4d47-8269-6c5ced44344d",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_IsInvited",
      "script": "file://Admin_IsInvited.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_LoadObjectByID.script.js 1`] = `
"/*
 * Copyright 2023 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

/*
 * This is a utility script to simplify access to admin identity properties. It
 * requires that \`sharedState._id\` be populated, which can be loaded using an
 * Identify Existing User node.
 */

function val(attrs, name) {
  if (attrs.containsKey(name)) {
    return attrs.get(name).iterator().next();
  }
  return '';
}

(function() {
  var fr = new JavaImporter(
    org.forgerock.openam.auth.nodes,
    org.forgerock.guice.core
  );

  with (fr) {
    try {

      outcome = 'False';

      if (!sharedState.containsKey('_id')) {
        throw 'Required sharedState property _id is missing';
      }      
      
      var realm = sharedState.get('realm');
      var uuid = sharedState.get('_id');
      
      var identityProvider = InjectorHolder.getInstance(IdentityProvider);
      var identity = identityProvider.getIdentity(uuid, realm);
      var attrs = identity.getAttributes();
      
      sharedState.put('adminObject', {
        givenName: val(attrs, 'givenName'),        
        sn: val(attrs, 'sn'),
        mail: val(attrs, 'mail'),
        inviteDate: val(attrs, 'fr-idm-inviteDate'),
        onboardDate: val(attrs, 'fr-idm-onboardDate')        
      });

      logger.message('Loaded admin object for id: {}', uuid);

      outcome = 'True';

    } catch (e) {
      logger.error('Failed to load admin object: {}', e);
    }
  }
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_LoadObjectByID.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "b88ce1fe-2480-4fd5-8062-2bd1f4659e2e": {
      "_id": "b88ce1fe-2480-4fd5-8062-2bd1f4659e2e",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_LoadObjectByID",
      "script": "file://Admin_LoadObjectByID.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_LocalRegistrationPrep.script.js 1`] = `
"/*
 * Copyright 2023 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

/*
When an admin managed object is created at the time of invitation, the email address
is used to populate the required first/last names.  This script clears those attributes
(if set to the email address) so the UI doesn't display the email address in the first/last
name input fields.

It also populates other required attributes with fake values to ensure password policy
validation works correctly when AM calls IDM.
*/

var objAttrs = sharedState.get('objectAttributes') || new java.util.HashMap();
objAttrs.put('givenName', '');
objAttrs.put('sn', '');
objAttrs.put('groups', ['fake']);
objAttrs.put('inviteDate', 'fake');
sharedState.put('objectAttributes', objAttrs);

outcome = 'True';
"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_LocalRegistrationPrep.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "a316aedd-8b3b-4f68-b6e8-65859f1e87be": {
      "_id": "a316aedd-8b3b-4f68-b6e8-65859f1e87be",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_LocalRegistrationPrep",
      "script": "file://Admin_LocalRegistrationPrep.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_MfaGetApp.script.js 1`] = `
"/*
This creates the following callbacks:
- TextOutputCallback: Display the step title and description
- ConfirmationCallback: Display the "Next" button
- HiddenValueCallback: Captures the "Get app" option, if selected
- ScriptTextOutputCallback: Creates a "Download the app" link button and positions it below the "Next" button
*/

var token = generateNumericToken('xxx');
var loadingMessage = 'Loading...';
var linkButton = "<button id='getapp-link-".concat(token).concat("' class='btn btn-block btn-link' type='submit'>Download the app</button>");
var message = "<h2 class='h2'>Set up the ForgeRock Authenticator</h2><div style='margin-bottom:1em'>To get started, you need to register your device using the ForgeRock Authenticator app.</div>";
var choices = ['Next'];
var defaultChoice = 0;
var getAppValue = 'Get app';
var getAppInputId = 'getapp-input-'.concat(token);

var setupPageScript =
  'var setupPage = function() {'.concat(
  '  var getAppInputElem = document.getElementById("').concat(getAppInputId).concat('");').concat(
  '  var messageElem;').concat(
  '  document.getElementsByClassName("callback-component").forEach(').concat(
  '    function (e) {').concat(
  '      var m = e.firstElementChild;').concat(
  '      if (m.firstChild && m.firstChild.nodeName == "#text" && m.firstChild.nodeValue.trim() == "').concat(loadingMessage).concat('") {').concat(
  '        messageElem = m;').concat(
  '      }').concat(
  '    }').concat(
  '  );').concat(
  '  if (!getAppInputElem || !messageElem) {').concat(
  '    return setTimeout(setupPage, 50);').concat(
  '  }').concat(
  '  var skipContainer = document.createElement("div");').concat(
  '  skipContainer.style = "width:100%";').concat(
  '  skipContainer.innerHTML = "').concat(linkButton).concat('";').concat(
  '  getAppInputElem.parentNode.append(skipContainer);').concat(
  '  messageElem.align = "center";').concat(
  '  messageElem.innerHTML = "').concat(message).concat('";').concat(
  '  var bindGetAppLink = function() {').concat(
  '    document.getElementById("getapp-link-').concat(token).concat('").onclick = function() {').concat(
  '      getAppInputElem.value = "').concat(getAppValue).concat('";').concat(
  '      document.getElementById("loginButton_0").click();').concat(
  '      return false;').concat(
  '    };').concat(
  '  };').concat(
  '  setTimeout(bindGetAppLink, 100);').concat(
  '};').concat(
  'setupPage();');

var fr = JavaImporter(
  org.forgerock.openam.auth.node.api.Action,
  javax.security.auth.callback.ConfirmationCallback,
  javax.security.auth.callback.TextOutputCallback,
  com.sun.identity.authentication.callbacks.HiddenValueCallback,
  com.sun.identity.authentication.callbacks.ScriptTextOutputCallback
)

with (fr) {
  if (callbacks.isEmpty()) {
    action = Action.send(
      new TextOutputCallback(
          TextOutputCallback.INFORMATION,
          loadingMessage
      ),
      new ConfirmationCallback(
          ConfirmationCallback.INFORMATION,
          choices,
          defaultChoice
      ),
      new HiddenValueCallback(getAppInputId, 'false'),
      new ScriptTextOutputCallback(setupPageScript)
    ).build()
  } else {
    if (callbacks.get(2).getValue() == getAppValue) {
      action = Action.goTo(getAppValue).build();
    } else {
      action = Action.goTo(choices[callbacks.get(1).getSelectedIndex()]).build();
    }
  }
}

 /*
  * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.
  * 
  * Example:
  * 'xxxxx' produces '28535'
  * 'xxx-xxx' produces '432-521'
  */
function generateNumericToken(format) {
  return format.replace(/[x]/g, function(c) {
    var r = Math.random()*10|0;
    var v = r;
    return v.toString(10);
  });
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_MfaGetApp.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "fe35a8fb-31b1-441c-bb9b-27932565061c": {
      "_id": "fe35a8fb-31b1-441c-bb9b-27932565061c",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_MfaGetApp",
      "script": "file://Admin_MfaGetApp.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_MfaOptIn.script.js 1`] = `
"/*
This creates the following callbacks:
- TextOutputCallback: Display the step title and description
- ConfirmationCallback: Display a list of buttons for choices
- HiddenValueCallback: Captures the "skip" option, if selected
- ScriptTextOutputCallback: Creates a "Skip for now" link button and positions it below the buttons 
*/

var token = generateNumericToken('xxx');
var loadingMessage = 'Loading...';
var linkButton = "<button id='skip-link-".concat(token).concat("' class='btn btn-block btn-link' type=submit>Skip for now</button>");
var message = "<h2 class=h2>Set up 2-step verification</h2><div style='margin-bottom:1em'>Protect your account by adding a second step after entering your password to verify it's you signing in.</div>";
var choices = ['Set up'];
var defaultChoice = 0;
var skipValue = 'Skip';

// This will run recursively in the browser until references can be obtained to key DOM elements, at which point.
// it will customize the DOM.  This is to avoid race conditions with the UI rendering callbacks.
var setupPageScript =
  'var setupPage = function() {'.concat(
  '  var skipInputElem = document.getElementById("skip-input-').concat(token).concat('");').concat(
  '  var messageElem;').concat(
  '  document.getElementsByClassName("callback-component").forEach(').concat(
  '    function (e) {').concat(
  '      var m = e.firstElementChild;').concat(
  '      if (m.firstChild && m.firstChild.nodeName == "#text" && m.firstChild.nodeValue.trim() == "').concat(loadingMessage).concat('") {').concat(
  '        messageElem = m;').concat(
  '      }').concat(
  '    }').concat(
  '  );').concat(
  '  if (!skipInputElem || !messageElem) {').concat(
  '    return setTimeout(setupPage, 50);').concat(
  '  }').concat(
  '  var skipContainer = document.createElement("div");').concat(
  '  skipContainer.style = "width:100%";').concat(
  '  skipContainer.innerHTML = "').concat(linkButton).concat('";').concat(
  '  skipInputElem.parentNode.append(skipContainer);').concat(
  '  messageElem.align = "center";').concat(
  '  messageElem.innerHTML = "').concat(message).concat('";').concat(
  '  var bindSkipLink = function() {').concat(
  '    document.getElementById("skip-link-').concat(token).concat('").onclick = function() {').concat(
  '      skipInputElem.value = "').concat(skipValue).concat('";').concat(
  '      document.getElementById("loginButton_0").click();').concat(
  '      return false;').concat(
  '    };').concat(
  '  };').concat(
  '  setTimeout(bindSkipLink, 100);').concat(
  '};').concat(
  'setupPage();');

var fr = JavaImporter(
  org.forgerock.openam.auth.node.api.Action,
  javax.security.auth.callback.ConfirmationCallback,
  javax.security.auth.callback.TextOutputCallback,
  com.sun.identity.authentication.callbacks.HiddenValueCallback,
  com.sun.identity.authentication.callbacks.ScriptTextOutputCallback
)

with (fr) {
  if (callbacks.isEmpty()) {
    action = Action.send(
      new TextOutputCallback(
          TextOutputCallback.INFORMATION,
          loadingMessage
      ),
      new ConfirmationCallback(
          ConfirmationCallback.INFORMATION,
          choices,
          defaultChoice
      ),
      new HiddenValueCallback('skip-input-'.concat(token), 'false'),
      new ScriptTextOutputCallback(setupPageScript)
    ).build()
  } else {
    if (callbacks.get(2).getValue() == skipValue) {
      action = Action.goTo(skipValue).build();
    } else {
      action = Action.goTo(choices[callbacks.get(1).getSelectedIndex()]).build();
    }
  }
}

 /*
  * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.
  * 
  * Example:
  * 'xxxxx' produces '28535'
  * 'xxx-xxx' produces '432-521'
  */
function generateNumericToken(format) {
  return format.replace(/[x]/g, function(c) {
    var r = Math.random()*10|0;
    var v = r;
    return v.toString(10);
  });
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_MfaOptIn.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "158e500b-8180-4641-ad48-23577fe9d976": {
      "_id": "158e500b-8180-4641-ad48-23577fe9d976",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_MfaOptIn",
      "script": "file://Admin_MfaOptIn.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_MfaRequiredCheck.script.js 1`] = `
"if ("false" == "true") {
  outcome = "Required";
} else {
  outcome = "Optional";
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_MfaRequiredCheck.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "4c7bb7bb-c5d6-47ac-92dc-256fb8121fa9": {
      "_id": "4c7bb7bb-c5d6-47ac-92dc-256fb8121fa9",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_MfaRequiredCheck",
      "script": "file://Admin_MfaRequiredCheck.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_PasswordFixEnd.script.js 1`] = `
"/*
 * Copyright 2023 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

/*
This restores sharedState.objectAttributes temporarily overwritten to fix an issue with password policy.
*/

//var password = '';
//var objAttrs = sharedState.get('objectAttributes');
//if (objAttrs && objAttrs.containsKey('password')) {
//  password = objAttrs.get('password');
//}

// Restore original object attributes
var origObjAttrs = sharedState.get('originalObjectAttributes');
if (origObjAttrs) {
//  if (password) {
//    origObjAttrs.put('password', password);
//  }
  sharedState.put('objectAttributes', origObjAttrs);
}

outcome = 'True';
"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_PasswordFixEnd.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "27f1b5a3-9446-4e5c-b965-f195a99fa666": {
      "_id": "27f1b5a3-9446-4e5c-b965-f195a99fa666",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_PasswordFixEnd",
      "script": "file://Admin_PasswordFixEnd.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_PasswordFixStart.script.js 1`] = `
"/*
 * Copyright 2023 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

/*
This is a workaround that fixes an issue with password policy.

The Platform Password node attempts to validate a password by calling IDM's validateProperty action, and it uses
sharedState.objectAttributes as the \`object\` property of that request payload.  If the request is missing required properties
or contains properties not in the object's schema, DS will error and IDM will swallow that error, returning an empty 
list of failed policies instead.

This workaround provides fake values for required properties. It also ensures first/last name is in objectAttributes so the
"can't contain" policy can be evaluated. This workaround is cleaned up by Admin_PasswordFixEnd.js.
*/

// Capture existing object attributes so we can restore them later
if (sharedState.containsKey('objectAttributes')) {
  sharedState.put('originalObjectAttributes', sharedState.get('objectAttributes'));
}

// Define the object to use for policy evaluation
var policyObject = {
  givenName: '',
  sn: '',
  groups: ['fake'],
  inviteDate: 'fake'
};

// If we've loaded the admin object, add first/last name to support
// evaluation of the full policy
if (sharedState.containsKey('adminObject')) {
  var adminObject = sharedState.get('adminObject');
  policyObject.givenName = adminObject.get('givenName');
  policyObject.sn = adminObject.get('sn');
}

// Replace objectAttributes with our policy object
sharedState.put('objectAttributes', policyObject);

outcome = 'True';
"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_PasswordFixStart.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "4accb4d0-56ec-4a28-a769-5275dbac3147": {
      "_id": "4accb4d0-56ec-4a28-a769-5275dbac3147",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_PasswordFixStart",
      "script": "file://Admin_PasswordFixStart.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_PrivacyPolicy.script.js 1`] = `
"var jurisdictions = [
  {
    name: 'Australia',
    url: 'https://backstage.forgerock.com/knowledge/identity-cloud/article/a92472578'
  },
  {
    name: 'Brazil',
    url: 'https://www.forgerock.com/privacy-policy'
  },
  {
    name: 'California',
    url: 'https://backstage.forgerock.com/knowledge/identity-cloud/article/a67552843'
  },
  {
    name: 'Canada',
    url: 'https://backstage.forgerock.com/knowledge/identity-cloud/article/a92472578'
  },
  {
    name: 'European Union',
    url: 'https://backstage.forgerock.com/knowledge/identity-cloud/article/a28580828'
  },
  {
    name: 'Hong Kong',
    url: 'https://www.forgerock.com/resources/view/109827462/overview/identity-cloud-privacy.pdf'
  },
  {
    name: 'Indonesia',
    url: 'https://www.forgerock.com/resources/view/109827462/overview/identity-cloud-privacy.pdf'
  },
  {
    name: 'New Zealand',
    url: 'https://backstage.forgerock.com/knowledge/identity-cloud/article/a92472578'
  },
  {
    name: 'Singapore',
    url: 'https://backstage.forgerock.com/knowledge/identity-cloud/article/a92472578'
  },
  {
    name: 'United Kingdom',
    url: 'https://backstage.forgerock.com/knowledge/identity-cloud/article/a28580828'
  },
  {
    name: 'United States',
    url: 'https://www.forgerock.com/privacy-policy'
  },
  {
    name: 'Rest of the World',
    url: 'https://www.forgerock.com/privacy-policy'
  }
];

var token = generateNumericToken('xxx');
var inputId = 'jurisdiction-input-'.concat(token);
var selectId = 'jurisdiction-select-'.concat(token);

// Build the header and instructions
var message = "<h2 class='h2'>Accept Privacy Policy</h2><div style='margin-bottom:1em'>Select your region of residence to review the applicable privacy policy.</div>";

// Build the jurisdiction dropdown
var dropdown = "<select id='".concat(selectId).concat("' class='custom-select' onchange='document._onJurisdictionChange()'><option value=''>Region of residence</option>");
for (var i = 0; i < jurisdictions.length; i++) {
  var j = jurisdictions[i];
  dropdown = dropdown.concat("<option value='").concat(j.name).concat("' data-url='").concat(j.url).concat("'>").concat(j.name).concat("</option>");
}
dropdown = dropdown.concat("</select>");

// Build the confirmation checkbox with policy link
var confirm = "<div id='confirm-wrapper' class='custom-control custom-checkbox' style='padding:1rem;visibility:hidden'>".concat(
  "<input id='confirm-check' type='checkbox' class='custom-control-input' onchange='document._setNextButton()'>").concat(
  "<label class='custom-control-label' for='confirm-check'>").concat(
  "I agree to ForgeRock's <a id='policy-link' target=_blank href='" + jurisdictions[0].url + "'>Privacy Policy</a>").concat(
  "</label>").concat(
"</div>");

var html = message + dropdown + confirm;

var script =
  'document._onJurisdictionChange = function() {'.concat(
  '  var jurisdiction = getJurisdiction();').concat(
  '  console.log(jurisdiction);').concat(
  '  if (jurisdiction) {').concat(
  '    setPolicyLink(jurisdiction.url);').concat(
  '    setJurisdiction(jurisdiction.name);').concat(
  '    setConfirmVisibility(true);').concat(
  '  } else {').concat(
  '    setJurisdiction("");').concat(
  '    setConfirmVisibility(false);').concat(
  '  }').concat(
  '  document._setNextButton();').concat(
  '};').concat(
    
  'document._setNextButton = function() {').concat(
  '  var jurisdiction = getJurisdiction();').concat(
  '  var cb = getCheckbox();').concat(
  '  loginHelpers.disableNextButton(!jurisdiction || !cb.checked);').concat(
  '};').concat(
    
  'var getJurisdiction = function() {').concat(
  '  var sel = document.getElementById("').concat(selectId).concat('");').concat(
  '  var opt = sel.options[sel.selectedIndex];').concat(
  '  return opt.value ? { name: opt.value, url: opt.getAttribute("data-url") } : null;').concat(
  '};').concat(
    
  'var getCheckbox = function() {').concat(
  '  return document.getElementById("confirm-check");').concat(
  '};').concat(
    
  'var setConfirmVisibility = function(show) {').concat(
  '  var el = document.getElementById("confirm-wrapper");').concat(
  '  el.style.visibility = show ? "visible" : "hidden";').concat(
  '};').concat(
    
  'var setPolicyLink = function(url) {').concat(
  '  document.getElementById("policy-link").setAttribute("href", url);').concat(
  '};').concat(

  'var setJurisdiction = function(name) {').concat(
  '  loginHelpers.setHiddenCallback("').concat(inputId).concat('", name);').concat(
  '};').concat(
    
  'var isPageReady = function() {').concat(
  '  return document.getElementById("callback_0") != null;').concat(
  '};').concat(
    
  'var setupPage = function() {').concat(
  '  if (!isPageReady()) {').concat(
  '    return setTimeout(setupPage, 100);').concat(
  '  }').concat(
  '  loginHelpers.disableNextButton(true);').concat(
  '  var container = document.getElementById("callback_0");').concat(
  '  container.insertAdjacentHTML("beforeend", "').concat(html).concat('");').concat(
  '};').concat(
    
  'setupPage();');

function isValidJurisdiction(name) {
  for (var i = 0; i < jurisdictions.length; i++) {
    if (jurisdictions[i].name == name) {
      return true;
    }
  }
  return false;
}

var fr = JavaImporter(
  org.forgerock.openam.auth.node.api.Action,
  com.sun.identity.authentication.callbacks.HiddenValueCallback,
  com.sun.identity.authentication.callbacks.ScriptTextOutputCallback,
  java.util.HashMap
)

with (fr) {
  if (callbacks.isEmpty() || !isValidJurisdiction(callbacks.get(0).getValue())) {
    action = Action.send(
      new HiddenValueCallback(inputId, ''),
      new ScriptTextOutputCallback(script)
    ).build();
  } else {
    var OBJ_ATTRS = 'objectAttributes';
    var attrs = sharedState.containsKey(OBJ_ATTRS) ? sharedState.get(OBJ_ATTRS) : new HashMap();
    attrs.put('jurisdiction', callbacks.get(0).getValue());
    sharedState.put(OBJ_ATTRS, attrs);
    action = Action.goTo('True').build();
  }
}

 /*
  * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.
  * 
  * Example:
  * 'xxxxx' produces '28535'
  * 'xxx-xxx' produces '432-521'
  */
function generateNumericToken(format) {
  return format.replace(/[x]/g, function(c) {
    var r = Math.random()*10|0;
    var v = r;
    return v.toString(10);
  });
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_PrivacyPolicy.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "653b70b0-a23d-403a-933b-911371cf84c0": {
      "_id": "653b70b0-a23d-403a-933b-911371cf84c0",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Returns privacy policy collection",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_PrivacyPolicy",
      "script": "file://Admin_PrivacyPolicy.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_ProfileToManagedObject.script.js 1`] = `
"/*
 * Copyright 2023 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

function setIfValidString(managedData, managedKey, profileKey) {
  var normalizedValue = normalizedProfile.get(profileKey);
  if (normalizedValue && !normalizedValue.isNull() && normalizedValue.asString() != '') {
    managedData.put(managedKey, normalizedValue);
  }
}

(function () {
  var frJava = JavaImporter(
    org.forgerock.json.JsonValue,
    java.util.HashMap
  );

  var OBJ_ATTR = 'objectAttributes';

  // We should have objectAttributes during onboarding because the user is established earlier in
  // the journey.  We won't have objectAttributes during login, though.
  var objAttrs = sharedState.containsKey(OBJ_ATTR) ? sharedState.get(OBJ_ATTR) : new frJava.HashMap();

  // If this flow requires email matching, confirm the IdP user email address matches the FR email address
  if (sharedState.checkEmailClaim == true) {
    var idpEmail = normalizedProfile.get('email').asString();
    var frEmail = objAttrs.get('mail');
    if (idpEmail != frEmail) {
      throw 'Email claim from IDP does not match identity mail attribute';
    }
  }

  // Update user with first/last name from IDP, if available
  var managedUserData = frJava.JsonValue.json(frJava.JsonValue.object());
  setIfValidString(managedUserData, 'givenName', 'givenName');
  setIfValidString(managedUserData, 'sn', 'familyName');
  
  // For login: Ensure the mail attribute is set in case we have to look up the admin using
  // their email.  This will occur when an existing admin is federating for the first time.
  if (!objAttrs.containsKey('mail')) {
    managedUserData.put('mail', normalizedProfile.get('email').asString());
  }

  if (!normalizedProfile.get('groups').isNull()) {
    managedUserData.put('groups', normalizedProfile.get('groups').asList());
  }
  
  // Merge anything we've put into \`managedUserData\` into sharedState.objectAttributes because
  // \`managedUserData\` goes into transient state, which isn't used by our downstream nodes
  var keys = managedUserData.keys().toArray();
  for (var i = 0; i < keys.length; i++) {
    objAttrs.put(keys[i], managedUserData.get(keys[i]));
  }
  sharedState.put(OBJ_ATTR, objAttrs);

  return managedUserData;
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_ProfileToManagedObject.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "ab78dcb5-85cb-41a6-813e-e07a77761376": {
      "_id": "ab78dcb5-85cb-41a6-813e-e07a77761376",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_ProfileToManagedObject",
      "script": "file://Admin_ProfileToManagedObject.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_SetCurrentYear.script.js 1`] = `
"var currentYear = new Date().getFullYear().toString();

var objAttrs = sharedState.get('objectAttributes') || new java.util.HashMap();
objAttrs.put('currentYear', currentYear);
sharedState.put('objectAttributes', objAttrs);

outcome = 'True';
"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_SetCurrentYear.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "6963d84e-e2f0-4db1-a746-116604189602": {
      "_id": "6963d84e-e2f0-4db1-a746-116604189602",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_SetCurrentYear",
      "script": "file://Admin_SetCurrentYear.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_SetInviteMailVars.script.js 1`] = `
"/*
 * Copyright 2023 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

var objAttrs = sharedState.get('objectAttributes') || new HashMap();
objAttrs.put('currentYear', new Date().getFullYear().toString());
sharedState.put('objectAttributes', objAttrs);

outcome = 'True';
"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_SetInviteMailVars.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "db854830-a069-471f-875a-8dc67d45ea2d": {
      "_id": "db854830-a069-471f-875a-8dc67d45ea2d",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_SetInviteMailVars",
      "script": "file://Admin_SetInviteMailVars.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_SetOnboardingAttributes.script.js 1`] = `
"/*
 * Copyright 2023 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

function utcNow() {
  return new Date().toISOString();
}

try {
  
  var OBJECT_ATTRS = 'objectAttributes';

  // Start by getting object attributes from shared state
  var sharedObjAttrs = sharedState.get(OBJECT_ATTRS);
  sharedObjAttrs.put('accountStatus', 'Active');
  sharedObjAttrs.put('onboardDate', utcNow());
  
  // Copy attributes from transient state
  var transientObjAttrs = nodeState.get(OBJECT_ATTRS);
  var attrs = ['aliasList', 'givenName', 'password', 'sn'];
  for (var i = 0; i < attrs.length; i++) {
    var val = transientObjAttrs.get(attrs[i]);
    if (val.isNotNull()) {
      sharedObjAttrs.put(attrs[i], val);
    }
  }
  
  // Ensure object attributes match in both shared and transient state
  nodeState.putTransient(OBJECT_ATTRS, sharedObjAttrs);
  sharedState.put(OBJECT_ATTRS, sharedObjAttrs);
  outcome = 'Success';

} catch (e) {

  logger.error('Failed to set attributes to complete onboarding: {}', e);
  outcome = 'Error';

}
"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Admin_SetOnboardingAttributes.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "80c3e733-ae51-4851-a01d-1cbf193c80e9": {
      "_id": "80c3e733-ae51-4851-a01d-1cbf193c80e9",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Activates the admin's account",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_SetOnboardingAttributes",
      "script": "file://Admin_SetOnboardingAttributes.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Alpha-OAuth2-Access-Token-Modification-Script.script.js 1`] = `
"/*
 * Copyright 2019-2021 ForgeRock AS. All Rights Reserved.
 *
 * Use of this code requires a commercial software license with ForgeRock AS
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

/*
 * This script lets you modify information associated with an OAuth2 access token
 * with methods provided by the AccessToken (1) interface.
 * The changes made to OAuth2 access tokens will directly impact the size of the CTS tokens,
 * and, similarly, the size of the JWTs if client-based OAuth2 tokens are utilized.
 * When adding/updating fields make sure that the token size remains within client/user-agent limits.
 *
 * Defined variables:
 * accessToken - AccessToken (1).
 *               The access token to be updated.
 *               Mutable object, all changes to the access token will be reflected.
 * scopes - Set<String> (6).
 *          Always present, the requested scopes.
 * requestProperties - Unmodifiable Map (5).
 *                     Always present, contains a map of request properties:
 *                     requestUri - The request URI.
 *                     realm - The realm that the request relates to.
 *                     requestParams - A map of the request params and/or posted data.
 *                                     Each value is a list of one or more properties.
 *                                     Please note that these should be handled in accordance with OWASP best practices:
 *                                     https://owasp.org/www-community/vulnerabilities/Unsafe_use_of_Reflection.
 * clientProperties - Unmodifiable Map (5).
 *                    Present if the client specified in the request was identified, contains a map of client properties:
 *                    clientId - The client's URI for the request locale.
 *                    allowedGrantTypes - List of the allowed grant types (org.forgerock.oauth2.core.GrantType) for the client.
 *                    allowedResponseTypes - List of the allowed response types for the client.
 *                    allowedScopes - List of the allowed scopes for the client.
 *                    customProperties - A map of the custom properties of the client.
 *                                       Lists or maps will be included as sub-maps; for example:
 *                                       customMap[Key1]=Value1 will be returned as customMap -> Key1 -> Value1.
 *                                       To add custom properties to a client, update the Custom Properties field
 *                                       in AM Console > Realm Name > Applications > OAuth 2.0 > Clients > Client ID > Advanced.
 * identity - AMIdentity (3).
 *            Always present, the identity of the resource owner.
 * session - SSOToken (4).
 *           Present if the request contains the session cookie, the user's session object.
 * scriptName - String (primitive).
 *              Always present, the display name of the script.
 * logger - Always present, the "OAuth2Provider" debug logger instance:
 *          https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.
 *          Corresponding log files will be prefixed with: scripts.OAUTH2_ACCESS_TOKEN_MODIFICATION.
 * httpClient - HTTP Client (8).
 *              Always present, the HTTP Client instance:
 *              https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-http-client.html#scripting-api-global-http-client.
 *
 * Return - no value is expected, changes shall be made to the accessToken parameter directly.
 *
 * Class reference:
 * (1) AccessToken - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/AccessToken.html.
 * (3) AMIdentity - https://backstage.forgerock.com/docs/am/7/apidocs/com/sun/identity/idm/AMIdentity.html.
 * (4) SSOToken - https://backstage.forgerock.com/docs/am/7/apidocs/com/iplanet/sso/SSOToken.html.
 * (5) Map - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashMap.html,
 *           or https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/LinkedHashMap.html.
 * (6) Set - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashSet.html.
 * (8) Client - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/http/Client.html.
 */

/* EXAMPLE
(function () {
    var frJava = JavaImporter(
        org.forgerock.http.protocol.Request,
        org.forgerock.http.protocol.Response
    );

    // Always includes this field in the token.
    accessToken.setField('key1', 'value1');

    // Receives and adds to the access token additional values by performing a REST call to an external service.
    // WARNING: Below, you will find a reference to a third-party site, which is provided only as an example.
    var uri = 'https://jsonplaceholder.typicode.com/posts';

    try {
        var request = new frJava.Request();

        // You can chain methods that return the request object.
        request.setUri(uri)
            .setMethod('POST')
            .setEntity(JSON.stringify({
                updatedFields: {
                    key2: 'value2',
                    key3: 'value3'
                }
            }));

        // You can call a method when chaining is not possible.
        request.getHeaders().add('Content-Type', 'application/json; charset=UTF-8');

        // Sends the request and receives the response.
        var response = httpClient.send(request).getOrThrow();

        // Checks if the response status is as expected.
        if (response.getStatus() === org.forgerock.http.protocol.Status.CREATED) {
            var result = JSON.parse(response.getEntity().getString());

            // Set multiple token fields at once.
            accessToken.setFields(result.updatedFields);
        } else {
            logger.error('Unable to obtain access token modifications. Status: ' + response.getStatus() + '. Content: ' + response.getEntity().getString());
        }
    } catch (e) {
        logger.error('The request processing was interrupted. ' + e);

        // The access token request fails with the HTTP 500 error in this case.
        throw ('Unable to obtain response from: ' + uri);
    }

    // Adds new fields containing identity attribute values to the access token.
    accessToken.setField('mail', identity.getAttribute('mail'));
    accessToken.setField('phone', identity.getAttribute('telephoneNumber').toArray()[0]);

    // Adds new fields containing the session property values.
    // NOTE: session may not be available for non-interactive authorization grants.
    if (session) {
        try {
            accessToken.setField('ipAddress', session.getProperty('Host'));
        } catch (e) {
            logger.error('Unable to retrieve session property value. ' + e);
        }
    }

    // Removes a native field from the token entry, that was set by AM.
    // WARNING: removing native fields from the token may result in loss of functionality.
    // accessToken.removeTokenName()

    // No return value is expected. Let it be undefined.
}());
*/"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Alpha-OAuth2-Access-Token-Modification-Script.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "39c08084-1238-43e8-857f-2e11005eac49": {
      "_id": "39c08084-1238-43e8-857f-2e11005eac49",
      "context": "OAUTH2_ACCESS_TOKEN_MODIFICATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Default alpha realm script for OAuth2 Access Token Modification",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Alpha OAuth2 Access Token Modification Script",
      "script": "file://Alpha-OAuth2-Access-Token-Modification-Script.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Alpha-OIDC-Claims-Script.script.js 1`] = `
"/*
 * Copyright 2014-2021 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

/*
 * This script computes claim values returned in ID tokens and/or at the UserInfo Endpoint.
 * The claim values are computed for:
 * the claims derived from the requested scopes,
 * the claims provided by the authorization server,
 * and the claims requested by the client via the claims parameter.
 *
 * In the CONFIGURATION AND CUSTOMIZATION section, you can
 * define the scope-to-claims mapping, and
 * assign to each claim a resolver function that will compute the claim value.
 *
 * Defined variables (class references are provided below):
 * scopes - Set<String> (6).
 *          Always present, the requested scopes.
 * claims - Map<String, Object> (5).
 *          Always present, default server provided claims.
 * claimObjects - List<Claim> (7, 2).
 *                Always present, the default server provided claims.
 * requestedClaims - Map<String, Set<String>> (5).
 *                   Always present, not empty if the request contains the claims parameter and the server has enabled
 *                   claims_parameter_supported. A map of the requested claims to possible values, otherwise empty;
 *                   requested claims with no requested values will have a key but no value in the map. A key with
 *                   a single value in its Set (6) indicates that this is the only value that should be returned.
 * requestedTypedClaims - List<Claim> (7, 2).
 *                        Always present, the requested claims.
 *                        Requested claims with no requested values will have a claim with no values.
 *                        A claim with a single value indicates this is the only value that should be returned.
 * claimsLocales - List<String> (7).
 *                 The values from the 'claims_locales' parameter.
 *                 See https://openid.net/specs/openid-connect-core-1_0.html#ClaimsLanguagesAndScripts for the OIDC specification details.
 * requestProperties - Unmodifiable Map (5).
 *                     Always present, contains a map of request properties:
 *                     requestUri - The request URI.
 *                     realm - The realm that the request relates to.
 *                     requestParams - A map of the request params and/or posted data.
 *                                     Each value is a list of one or more properties.
 *                                     Please note that these should be handled in accordance with OWASP best practices:
 *                                     https://owasp.org/www-community/vulnerabilities/Unsafe_use_of_Reflection.
 * clientProperties - Unmodifiable Map (5).
 *                    Present if the client specified in the request was identified, contains a map of client properties:
 *                    clientId - The client's URI for the request locale.
 *                    allowedGrantTypes - List of the allowed grant types (org.forgerock.oauth2.core.GrantType) for the client.
 *                    allowedResponseTypes - List of the allowed response types for the client.
 *                    allowedScopes - List of the allowed scopes for the client.
 *                    customProperties - A map of the custom properties of the client.
 *                                       Lists or maps will be included as sub-maps; for example:
 *                                       customMap[Key1]=Value1 will be returned as customMap -> Key1 -> Value1.
 *                                       To add custom properties to a client, update the Custom Properties field
 *                                       in AM Console > Realm Name > Applications > OAuth 2.0 > Clients > Client ID > Advanced.
 * identity - AMIdentity (3).
 *            Always present, the identity of the resource owner.
 * session - SSOToken (4).
 *           Present if the request contains the session cookie, the user's session object.
 * scriptName - String (primitive).
 *              Always present, the display name of the script.
 * logger - Always present, the "OAuth2Provider" debug logger instance:
 *          https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.
 *          Corresponding files will be prefixed with: scripts.OIDC_CLAIMS.
 * httpClient - HTTP Client (8).
 *              Always present, the HTTP Client instance:
 *              https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-http-client.html#scripting-api-global-http-client.
 *              In order to use the client, you may need to add
 *              org.forgerock.http.Client,
 *              org.forgerock.http.protocol.*,
 *              and org.forgerock.util.promise.PromiseImpl
 *              to the allowed Java classes in the scripting engine configuration, as described in:
 *              https://backstage.forgerock.com/docs/am/7/scripting-guide/script-engine-security.html
 *
 * Return - a new UserInfoClaims(Map<String, Object> values, Map<String, List<String>> compositeScopes) (1) object.
 *          The result of the last statement in the script is returned to the server.
 *          Currently, the Immediately Invoked Function Expression (also known as Self-Executing Anonymous Function)
 *          is the last (and only) statement in this script, and its return value will become the script result.
 *          Do not use "return variable" statement outside of a function definition.
 *          See RESULTS section for additional details.
 *
 * Class reference:
 * (1) UserInfoClaims - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html.
 * (2) Claim - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html).
 *         An instance of org.forgerock.openidconnect.Claim has methods to access
 *         the claim name, requested values, locale, and whether the claim is essential.
 * (3) AMIdentity - https://backstage.forgerock.com/docs/am/7/apidocs/com/sun/identity/idm/AMIdentity.html.
 * (4) SSOToken - https://backstage.forgerock.com/docs/am/7/apidocs/com/iplanet/sso/SSOToken.html.
 * (5) Map - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashMap.html,
 *           or https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/LinkedHashMap.html.
 * (6) Set - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashSet.html.
 * (7) List - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/ArrayList.html.
 * (8) Client - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/http/Client.html.
*/

(function () {
    // SETUP

    /**
     * Claim processing utilities.
     * An object that contains reusable functions for processing claims.
     * @see CLAIM PROCESSING UTILITIES section for details.
     */
    var utils = getUtils();

    // CONFIGURATION AND CUSTOMIZATION

    /**
     * OAuth 2.0 scope values (scopes) can be used by the Client to request OIDC claims.
     *
     * Call this configuration method, and pass in as the first argument
     * an object that maps a scope value to an array of claim names
     * to specify which claims need to be processed and returned for the requested scopes.
     * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#ScopeClaims}
     * for the scope values that could be used to request claims as defined in the OIDC specification.
     *
     * Below, find a default configuration that is expected to work in the current environment.
     *
     * CUSTOMIZATION
     * You can choose the claim names returned for a scope.
     */
    utils.setScopeClaimsMap({
        profile: [
            'name',
            'family_name',
            'given_name',
            'zoneinfo',
            'locale'
        ],
        email: ['email'],
        address: ['address'],
        phone: ['phone_number']
    });

    /**
     * In this script, each claim
     * derived from the requested scopes,
     * provided by the authorization server, and
     * requested by the client via the claims parameter
     * will be processed by a function associated with the claim name.
     *
     * Call this configuration method, and pass in as the first argument
     * an object that maps a claim name to a resolver function,
     * which will be automatically executed for each claim processed by the script.
     *
     * The claim resolver function will receive the requested claim information
     * in an instance of org.forgerock.openidconnect.Claim as the first argument.
     * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html}
     * for details on the Claim class.
     *
     * If the claim resolver function returns a value,
     * other than undefined or null,
     * the claim will be included in the script's results.
     *
     * The Claim instance provides methods to check
     * what the name of the claim is,
     * which values the claim request contains,
     * whether the claim is essential, and
     * which locale the claim is associated with.
     * The resolver function can consider this information when computing and returning the claim value.
     *
     * Below, find a default configuration that is expected to work in the current environment.
     * A reusable function, utils.getUserProfileClaimResolver(String attribute-name),
     * is called to return a claim resolver function based on a user profile attribute.
     * @see CLAIM RESOLVERS section for the implementation details and examples.
     * For the address claim, an example of a claim resolver that uses another claim resolver is provided.
     *
     * CUSTOMIZATION
     * You can reuse the predefined utils methods with your custom arguments.
     * You can also specify a custom resolver function for a claim name,
     * that will compute and return the claim value—as shown in the commented out example below.
     */
    utils.setClaimResolvers({
        /*
        // An example of a simple claim resolver function that is defined for a claim
        // directly in the configuration object:
        custom-claim-name: function (requestedClaim) {
            // In this case, initially, the claim value comes straight from a user profile attribute value:
            var claimValue = identity.getAttribute('custom-attribute-name').toArray()[0]

            // Optionally, provide additional logic for processing (filtering, formatting, etc.) the claim value.
            // You can use:
            // requestedClaim.getName()
            // requestedClaim.getValues()
            // requestedClaim.getLocale()
            // requestedClaim.isEssential()

            return claimValue
        },
        */
        /**
         * The use of utils.getUserProfileClaimResolver shows how
         * an argument passed to a function that returns a claim resolver
         * becomes available to the resolver function (via its lexical context).
         */
        name: utils.getUserProfileClaimResolver('cn'),
        family_name: utils.getUserProfileClaimResolver('sn'),
        given_name: utils.getUserProfileClaimResolver('givenname'),
        zoneinfo: utils.getUserProfileClaimResolver('preferredtimezone'),
        locale: utils.getUserProfileClaimResolver('preferredlocale'),
        email: utils.getUserProfileClaimResolver('mail'),
        address: utils.getAddressClaimResolver(
            /**
             * The passed in user profile claim resolver function
             * can be used by the address claim resolver function
             * to obtain the claim value to be formatted as per the OIDC specification:
             * @see https://openid.net/specs/openid-connect-core-1_0.html#AddressClaim.
             */
            utils.getUserProfileClaimResolver('postaladdress')
        ),
        phone_number: utils.getUserProfileClaimResolver('telephonenumber')
    });

    // CLAIM PROCESSING UTILITIES

    /**
     * @returns {object} An object that contains reusable claim processing utilities.
     * @see PUBLIC METHODS section and the return statement for the list of exported functions.
     */
    function getUtils () {
        // IMPORT JAVA

        /**
         * Provides Java scripting functionality.
         * @see {@link https://developer.mozilla.org/en-US/docs/Mozilla/Projects/Rhino/Scripting_Java#javaimporter_constructor}.
         */
        var frJava = JavaImporter(
            org.forgerock.oauth2.core.exceptions.InvalidRequestException,
            org.forgerock.oauth2.core.UserInfoClaims,
            org.forgerock.openidconnect.Claim,

            java.util.LinkedHashMap,
            java.util.ArrayList
        );

        // SET UP CONFIGURATION

        /**
         * Placeholder for a configuration option that contains
         * an object that maps the supported scope values (scopes)
         * and the corresponding claim names for each scope value.
         */
        var scopeClaimsMap;

        /**
         * Placeholder for a configuration option that contains
         * an object that maps the supported claim names
         * and the resolver functions returning the claim value.
         */
        var claimResolvers;

        /**
         * A (public) method that accepts an object that maps the supported scopes and the corresponding claim names,
         * and assigns it to a (private) variable that serves as a configuration option.
         * @param {object} params - An object that maps each supported scope value to an array of claim names,
         * in order to specify which claims need to be processed for the requested scopes.
         * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#ScopeClaims} for details.
         * @param {string[]} [params.profile] - An array of claim names to be returned if the profile scope is requested.
         * @param {string[]} [params.email] - An array of claim names to be returned if the email scope is requested.
         * @param {string[]} [params.address] - An array of claim names to be returned if the address scope is requested.
         * @param {string[]} [params.phone] - An array of claim names to be returned if the phone scope is requested.
         * @returns {undefined}
         */
        function setScopeClaimsMap(params) {
            scopeClaimsMap = params;
        }

        /**
         * A (public) method that accepts an object that maps the supported claim names
         * and the resolver functions returning the claim value,
         * and assigns it to a (private) variable that serves as a configuration option.
         * @param {object} params - An object that maps
         * each supported claim name to a function that computes and returns the claim value.
         */
        function setClaimResolvers(params) {
            claimResolvers = params;
        }

        // CLAIM RESOLVERS

        /**
         * Claim resolvers are functions that return a claim value.
         * @param {*}
         * @returns {*}
         */

        /**
         * Defines a claim resolver based on a user profile attribute.
         * @param {string} attributeName - Name of the user profile attribute.
         * @returns {function} A function that will determine the claim value
         * based on the user profile attribute and the (requested) claim properties.
         */
        function getUserProfileClaimResolver (attributeName) {
            /**
             * Resolves a claim with a user profile attribute value.
             * Returns undefined if the identity attribute is not populated,
             * OR if the claim has requested values that do not contain the identity attribute value.
             * ATTENTION: the aforementioned comparison is case-sensitive.
             * @param {org.forgerock.openidconnect.Claim} claim
             * An object that provides methods to obtain information/requirements associated with a claim.
             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.
             * @returns {string|HashSet|undefined}
             */
            function resolveClaim(claim) {
                var userProfileValue;

                if (identity) {
                    userProfileValue = getClaimValueFromSet(claim, identity.getAttribute(attributeName));

                    if (userProfileValue && !userProfileValue.isEmpty()) {
                        if (!claim.getValues() || claim.getValues().isEmpty() || claim.getValues().contains(userProfileValue)) {
                            return userProfileValue;
                        }
                    }
                }
            }

            return resolveClaim;
        }

        /**
         * Returns an address claim resolver based on a claim value obtained with another claim resolver.
         * @param {function} resolveClaim - A function that returns a claim value.
         * @returns {function} A function that will accept a claim as an argument,
         * run the claim resolver function for the claim and obtain the claim value,
         * and apply additional formatting to the value before returning it.
         */
        function getAddressClaimResolver (resolveClaim) {
            /**
             * Creates an address claim object from a value returned by a claim resolver,
             * and returns the address claim object as the claim value.
             * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#AddressClaim}.
             * The claim value is obtained with a claim resolving function available from the closure.
             * @param {org.forgerock.openidconnect.Claim} claim
             * An object that provides methods to obtain information/requirements associated with a claim.
             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.
             * @returns {java.util.LinkedHashMap|undefined} The address claim object created from a claim value.
             */
            function resolveAddressClaim(claim) {
                var claimValue = resolveClaim(claim);
                var addressObject;

                if (isClaimValueValid(claimValue)) {
                    addressObject = new frJava.LinkedHashMap();

                    addressObject.put('formatted', claimValue);

                    return addressObject;
                }
            }

            return resolveAddressClaim;
        }

        /**
         * Returns an essential claim resolver based on a claim value obtained with another claim resolver.
         * @param {function} resolveClaim - A function that returns a claim value.
         * @returns {function} A function that will accept a claim as an argument,
         * run the claim resolver function for the claim and obtain the claim value,
         * and apply additional logic for essential claims.
         */
        function getEssentialClaimResolver (resolveClaim) {
            /**
             * Returns a claim value or throws an error.
             * The claim value is obtained with a claim resolving function available from the closure.
             * Throws an exception if the claim is essential and no value is returned for the claim.
             *
             * Use of this resolver is optional.
             * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#IndividualClaimsRequests} stating:
             * "Note that even if the Claims are not available because the End-User did not authorize their release or they are not present,
             * the Authorization Server MUST NOT generate an error when Claims are not returned, whether they are Essential or Voluntary,
             * unless otherwise specified in the description of the specific claim."
             *
             * @param {org.forgerock.openidconnect.Claim} claim
             * An object that provides methods to obtain information/requirements associated with a claim.
             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.
             * @returns {*}
             * @throws {org.forgerock.oauth2.core.exceptions.InvalidRequestException}
             */
            function resolveEssentialClaim(claim) {
                var claimValue = resolveClaim(claim);

                if (claim.isEssential() && !isClaimValueValid(claimValue)) {
                    throw new frJava.InvalidRequestException('Could not provide value for essential claim: ' + claim.getName());
                }

                return claimValue;
            }

            return resolveEssentialClaim;
        }

        /**
         * Provides default resolution for a claim.
         * Use it if a claim-specific resolver is not defined in the configuration.
         * @param {org.forgerock.openidconnect.Claim} claim
         * An object that provides methods to obtain information/requirements associated with a claim.
         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.
         * @returns {*} A single value associated with this claim.
         */
        function resolveAnyClaim (claim) {
            if (claim.getValues().size() === 1) {
                return claim.getValues().toArray()[0];
            }
        }

        // UTILITIES

        /**
         * Returns claim value from a set.
         * If the set contains a single value, returns the value.
         * If the set contains multiple values, returns the set.
         * Otherwise, returns undefined.
         *
         * @param {org.forgerock.openidconnect.Claim} claim
         * An object that provides methods to obtain information/requirements associated with a claim.
         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.
         * @param {java.util.HashSet} set The set—for example, a user profile attribute value.
         * @returns {string|java.util.HashSet|undefined}
         */
        function getClaimValueFromSet (claim, set) {
            if (set && set.size()) {
                if (set.size() === 1) {
                    return set.toArray()[0];
                } else {
                    return set;
                }
            } else if (logger.warningEnabled()) {
                logger.warning('OIDC Claims script. Got an empty set for claim: ' + claim.getName());
            }
        }

        function isClaimValueValid (claimValue) {
            if (typeof claimValue === 'undefined' || claimValue === null) {
                return false;
            }

            return true;
        }

        // CLAIM PROCESSING

        /**
         * Constructs and returns an object populated with the computed claim values
         * and the requested scopes mapped to the claim names.
         * @returns {org.forgerock.oauth2.core.UserInfoClaims} The object to be returned to the authorization server.
         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html}.
         * @see RESULTS section for the use of this function.
         */
        function getUserInfoClaims () {
            return new frJava.UserInfoClaims(getComputedClaims(), getCompositeScopes());
        }

        /**
         * Creates a map of (requested) claim names populated with the computed claim values.
         * @returns {java.util.LinkedHashMap}
         * A map of the requested claim names and the corresponding claim values.
         */
        function getComputedClaims () {
            /**
             * Creates a complete list of claim objects from:
             * the claims derived from the scopes,
             * the claims provided by the authorization server,
             * and the claims requested by the client.
             * @returns {java.util.ArrayList}
             * Returns a complete list of org.forgerock.openidconnect.Claim objects available to the script.
             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for the claim object details.
             */
            function getClaims() {
                /**
                 * Returns a list of claim objects for the requested scopes.
                 * Uses the scopeClaimsMap configuration option to derive the claim names;
                 * no other properties of a claim derived from a scope are populated.
                 * @returns {java.util.ArrayList}
                 * A list of org.forgerock.openidconnect.Claim objects derived from the requested scopes.
                 * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for the claim object details.
                 */
                function convertScopeToClaims() {
                    var claims = new frJava.ArrayList();

                    scopes.toArray().forEach(function (scope) {
                        if (String(scope) !== 'openid' && scopeClaimsMap[scope]) {
                            scopeClaimsMap[scope].forEach(function (claimName) {
                                claims.add(new frJava.Claim(claimName));
                            });
                        }
                    });

                    return claims;
                }

                var claims = new frJava.ArrayList();

                claims.addAll(convertScopeToClaims());
                claims.addAll(claimObjects);
                claims.addAll(requestedTypedClaims);

                return claims;
            }

            /**
             * Computes and returns a claim value.
             * To obtain the claim value, uses the resolver function specified for the claim in the claimResolvers configuration object.
             * @see claimResolvers
             * If no resolver function is found, uses the default claim resolver function.
             *
             * @param {org.forgerock.openidconnect.Claim} claim
             * An object that provides methods to obtain information/requirements associated with a claim.
             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.
             * @returns {*} Claim value.
             * @throws {org.forgerock.oauth2.core.exceptions.InvalidRequestException}
             * Rethrows this exception if a claim resolver throws it.
             * You can throw org.forgerock.oauth2.core.exceptions.InvalidRequestException from your custom claim resolver
             * if you want to terminate the claim processing.
             */
            function computeClaim(claim) {
                var resolveClaim;
                var message;

                try {
                    resolveClaim = claimResolvers[claim.getName()] || resolveAnyClaim;

                    return resolveClaim(claim);
                } catch (e) {
                    message = 'OIDC Claims script exception. Unable to resolve OIDC Claim. ' + e;

                    if (String(e).indexOf('org.forgerock.oauth2.core.exceptions.InvalidRequestException') !== -1) {
                        throw e;
                    }

                    if (logger.warningEnabled()) {
                        logger.warning(message);
                    }
                }
            }

            var computedClaims = new frJava.LinkedHashMap();

            getClaims().toArray().forEach(function (claim) {
                var claimValue = computeClaim(claim);

                if (isClaimValueValid(claimValue)) {
                    computedClaims.put(claim.getName(), claimValue);
                } else {
                    /**
                     * If a claim has been processed, but appears in the list again,
                     * and its value cannot be computed under the new conditions,
                     * the claim is removed from the final result.
                     *
                     * For example, a claim could be mapped to a scope and found in the user profile,
                     * but also requested by the client with required values that don't match the computed one.
                     * @see {link https://openid.net/specs/openid-connect-core-1_0.html#IndividualClaimsRequests}.
                     * for the relevant OIDC specification details.
                     */
                    computedClaims.remove(claim.getName());
                }
            });

            return computedClaims;
        }

        /**
         * Creates a map of requested scopes and the corresponding claim names.
         * @returns {java.util.LinkedHashMap}
         */
        function getCompositeScopes () {
            var compositeScopes = new frJava.LinkedHashMap();

            scopes.toArray().forEach(function (scope) {
                var scopeClaims = new frJava.ArrayList();

                if (scopeClaimsMap[scope]) {
                    scopeClaimsMap[scope].forEach(function (claimName) {
                        scopeClaims.add(claimName);
                    });
                }

                if (scopeClaims.size()) {
                    compositeScopes.put(scope, scopeClaims);
                }
            });

            return compositeScopes;
        }

        // PUBLIC METHODS

        return {
            setScopeClaimsMap: setScopeClaimsMap,
            setClaimResolvers: setClaimResolvers,
            getUserProfileClaimResolver: getUserProfileClaimResolver,
            getAddressClaimResolver: getAddressClaimResolver,
            getEssentialClaimResolver: getEssentialClaimResolver,
            getUserInfoClaims: getUserInfoClaims
        };
    }

    // RESULTS

    /**
     * This script returns an instance of the org.forgerock.oauth2.core.UserInfoClaims class
     * populated with the computed claim values and
     * the requested scopes mapped to the claim names.
     * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html}.
     *
     * Assigning it to a variable gives you an opportunity
     * to log the content of the returned value during development.
     */
    var userInfoClaims = utils.getUserInfoClaims();

    /*
    logger.error(scriptName + ' results:')
    logger.error('Values: ' + userInfoClaims.getValues())
    logger.error('Scopes: ' + userInfoClaims.getCompositeScopes())
    */

    return userInfoClaims;
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Alpha-OIDC-Claims-Script.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "cf3515f0-8278-4ee3-a530-1bad7424c416": {
      "_id": "cf3515f0-8278-4ee3-a530-1bad7424c416",
      "context": "OIDC_CLAIMS",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Default alpha realm script for OIDC claims",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Alpha OIDC Claims Script",
      "script": "file://Alpha-OIDC-Claims-Script.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Alpha-endUserUIClient-OAuth2-Access-Token-Modification-Script.script.js 1`] = `
"(function () {
  if (scopes.contains('fr:autoaccess:*') || scopes.contains('fr:iga:*')) {
    var fr = JavaImporter(
      com.sun.identity.idm.IdType
    );
    var groups = [];
    identity.getMemberships(fr.IdType.GROUP).toArray().forEach(function (group) {
      groups.push(group.getAttribute('cn').toArray()[0]);
    });
    accessToken.setField('groups', groups);
  }
}());
"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Alpha-endUserUIClient-OAuth2-Access-Token-Modification-Script.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "e232cff3-2460-47cd-80b2-36c86c0d0f06": {
      "_id": "e232cff3-2460-47cd-80b2-36c86c0d0f06",
      "context": "OAUTH2_ACCESS_TOKEN_MODIFICATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Used by endUserUIClient",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Alpha endUserUIClient OAuth2 Access Token Modification Script",
      "script": "file://Alpha-endUserUIClient-OAuth2-Access-Token-Modification-Script.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Alpha-endUserUIClient-OIDC-Claims-Script.script.js 1`] = `
"/*
 * Copyright 2014-2021 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

/*
 * This script computes claim values returned in ID tokens and/or at the UserInfo Endpoint.
 * The claim values are computed for:
 * the claims derived from the requested scopes,
 * the claims provided by the authorization server,
 * and the claims requested by the client via the claims parameter.
 *
 * In the CONFIGURATION AND CUSTOMIZATION section, you can
 * define the scope-to-claims mapping, and
 * assign to each claim a resolver function that will compute the claim value.
 *
 * Defined variables (class references are provided below):
 * scopes - Set<String> (6).
 *          Always present, the requested scopes.
 * claims - Map<String, Object> (5).
 *          Always present, default server provided claims.
 * claimObjects - List<Claim> (7, 2).
 *                Always present, the default server provided claims.
 * requestedClaims - Map<String, Set<String>> (5).
 *                   Always present, not empty if the request contains the claims parameter and the server has enabled
 *                   claims_parameter_supported. A map of the requested claims to possible values, otherwise empty;
 *                   requested claims with no requested values will have a key but no value in the map. A key with
 *                   a single value in its Set (6) indicates that this is the only value that should be returned.
 * requestedTypedClaims - List<Claim> (7, 2).
 *                        Always present, the requested claims.
 *                        Requested claims with no requested values will have a claim with no values.
 *                        A claim with a single value indicates this is the only value that should be returned.
 * claimsLocales - List<String> (7).
 *                 The values from the 'claims_locales' parameter.
 *                 See https://openid.net/specs/openid-connect-core-1_0.html#ClaimsLanguagesAndScripts for the OIDC specification details.
 * requestProperties - Unmodifiable Map (5).
 *                     Always present, contains a map of request properties:
 *                     requestUri - The request URI.
 *                     realm - The realm that the request relates to.
 *                     requestParams - A map of the request params and/or posted data.
 *                                     Each value is a list of one or more properties.
 *                                     Please note that these should be handled in accordance with OWASP best practices:
 *                                     https://owasp.org/www-community/vulnerabilities/Unsafe_use_of_Reflection.
 * clientProperties - Unmodifiable Map (5).
 *                    Present if the client specified in the request was identified, contains a map of client properties:
 *                    clientId - The client's URI for the request locale.
 *                    allowedGrantTypes - List of the allowed grant types (org.forgerock.oauth2.core.GrantType) for the client.
 *                    allowedResponseTypes - List of the allowed response types for the client.
 *                    allowedScopes - List of the allowed scopes for the client.
 *                    customProperties - A map of the custom properties of the client.
 *                                       Lists or maps will be included as sub-maps; for example:
 *                                       customMap[Key1]=Value1 will be returned as customMap -> Key1 -> Value1.
 *                                       To add custom properties to a client, update the Custom Properties field
 *                                       in AM Console > Realm Name > Applications > OAuth 2.0 > Clients > Client ID > Advanced.
 * identity - AMIdentity (3).
 *            Always present, the identity of the resource owner.
 * session - SSOToken (4).
 *           Present if the request contains the session cookie, the user's session object.
 * scriptName - String (primitive).
 *              Always present, the display name of the script.
 * logger - Always present, the "OAuth2Provider" debug logger instance:
 *          https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.
 *          Corresponding files will be prefixed with: scripts.OIDC_CLAIMS.
 * httpClient - HTTP Client (8).
 *              Always present, the HTTP Client instance:
 *              https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-http-client.html#scripting-api-global-http-client.
 *              In order to use the client, you may need to add
 *              org.forgerock.http.Client,
 *              org.forgerock.http.protocol.*,
 *              and org.forgerock.util.promise.PromiseImpl
 *              to the allowed Java classes in the scripting engine configuration, as described in:
 *              https://backstage.forgerock.com/docs/am/7/scripting-guide/script-engine-security.html
 *
 * Return - a new UserInfoClaims(Map<String, Object> values, Map<String, List<String>> compositeScopes) (1) object.
 *          The result of the last statement in the script is returned to the server.
 *          Currently, the Immediately Invoked Function Expression (also known as Self-Executing Anonymous Function)
 *          is the last (and only) statement in this script, and its return value will become the script result.
 *          Do not use "return variable" statement outside of a function definition.
 *          See RESULTS section for additional details.
 *
 * Class reference:
 * (1) UserInfoClaims - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html.
 * (2) Claim - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html).
 *         An instance of org.forgerock.openidconnect.Claim has methods to access
 *         the claim name, requested values, locale, and whether the claim is essential.
 * (3) AMIdentity - https://backstage.forgerock.com/docs/am/7/apidocs/com/sun/identity/idm/AMIdentity.html.
 * (4) SSOToken - https://backstage.forgerock.com/docs/am/7/apidocs/com/iplanet/sso/SSOToken.html.
 * (5) Map - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashMap.html,
 *           or https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/LinkedHashMap.html.
 * (6) Set - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashSet.html.
 * (7) List - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/ArrayList.html.
 * (8) Client - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/http/Client.html.
*/

(function () {
    // SETUP

    /**
     * Claim processing utilities.
     * An object that contains reusable functions for processing claims.
     * @see CLAIM PROCESSING UTILITIES section for details.
     */
    var utils = getUtils();

    // CONFIGURATION AND CUSTOMIZATION

    /**
     * OAuth 2.0 scope values (scopes) can be used by the Client to request OIDC claims.
     *
     * Call this configuration method, and pass in as the first argument
     * an object that maps a scope value to an array of claim names
     * to specify which claims need to be processed and returned for the requested scopes.
     * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#ScopeClaims}
     * for the scope values that could be used to request claims as defined in the OIDC specification.
     *
     * Below, find a default configuration that is expected to work in the current environment.
     *
     * CUSTOMIZATION
     * You can choose the claim names returned for a scope.
     */
    utils.setScopeClaimsMap({
        profile: [
            'name',
            'family_name',
            'given_name',
            'zoneinfo',
            'locale'
        ],
        email: ['email'],
        address: ['address'],
        phone: ['phone_number']
    });

    /**
     * In this script, each claim
     * derived from the requested scopes,
     * provided by the authorization server, and
     * requested by the client via the claims parameter
     * will be processed by a function associated with the claim name.
     *
     * Call this configuration method, and pass in as the first argument
     * an object that maps a claim name to a resolver function,
     * which will be automatically executed for each claim processed by the script.
     *
     * The claim resolver function will receive the requested claim information
     * in an instance of org.forgerock.openidconnect.Claim as the first argument.
     * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html}
     * for details on the Claim class.
     *
     * If the claim resolver function returns a value,
     * other than undefined or null,
     * the claim will be included in the script's results.
     *
     * The Claim instance provides methods to check
     * what the name of the claim is,
     * which values the claim request contains,
     * whether the claim is essential, and
     * which locale the claim is associated with.
     * The resolver function can consider this information when computing and returning the claim value.
     *
     * Below, find a default configuration that is expected to work in the current environment.
     * A reusable function, utils.getUserProfileClaimResolver(String attribute-name),
     * is called to return a claim resolver function based on a user profile attribute.
     * @see CLAIM RESOLVERS section for the implementation details and examples.
     * For the address claim, an example of a claim resolver that uses another claim resolver is provided.
     *
     * CUSTOMIZATION
     * You can reuse the predefined utils methods with your custom arguments.
     * You can also specify a custom resolver function for a claim name,
     * that will compute and return the claim value—as shown in the commented out example below.
     */
    utils.setClaimResolvers({
        /*
        // An example of a simple claim resolver function that is defined for a claim
        // directly in the configuration object:
        custom-claim-name: function (requestedClaim) {
            // In this case, initially, the claim value comes straight from a user profile attribute value:
            var claimValue = identity.getAttribute('custom-attribute-name').toArray()[0]

            // Optionally, provide additional logic for processing (filtering, formatting, etc.) the claim value.
            // You can use:
            // requestedClaim.getName()
            // requestedClaim.getValues()
            // requestedClaim.getLocale()
            // requestedClaim.isEssential()

            return claimValue
        },
        */
        /**
         * The use of utils.getUserProfileClaimResolver shows how
         * an argument passed to a function that returns a claim resolver
         * becomes available to the resolver function (via its lexical context).
         */
        name: utils.getUserProfileClaimResolver('cn'),
        family_name: utils.getUserProfileClaimResolver('sn'),
        given_name: utils.getUserProfileClaimResolver('givenname'),
        zoneinfo: utils.getUserProfileClaimResolver('preferredtimezone'),
        locale: utils.getUserProfileClaimResolver('preferredlocale'),
        email: utils.getUserProfileClaimResolver('mail'),
        address: utils.getAddressClaimResolver(
            /**
             * The passed in user profile claim resolver function
             * can be used by the address claim resolver function
             * to obtain the claim value to be formatted as per the OIDC specification:
             * @see https://openid.net/specs/openid-connect-core-1_0.html#AddressClaim.
             */
            utils.getUserProfileClaimResolver('postaladdress')
        ),
        phone_number: utils.getUserProfileClaimResolver('telephonenumber')
    });

    // CLAIM PROCESSING UTILITIES

    /**
     * @returns {object} An object that contains reusable claim processing utilities.
     * @see PUBLIC METHODS section and the return statement for the list of exported functions.
     */
    function getUtils () {
        // IMPORT JAVA

        /**
         * Provides Java scripting functionality.
         * @see {@link https://developer.mozilla.org/en-US/docs/Mozilla/Projects/Rhino/Scripting_Java#javaimporter_constructor}.
         */
        var frJava = JavaImporter(
            org.forgerock.oauth2.core.exceptions.InvalidRequestException,
            org.forgerock.oauth2.core.UserInfoClaims,
            org.forgerock.openidconnect.Claim,

            java.util.LinkedHashMap,
            java.util.ArrayList
        );

        // SET UP CONFIGURATION

        /**
         * Placeholder for a configuration option that contains
         * an object that maps the supported scope values (scopes)
         * and the corresponding claim names for each scope value.
         */
        var scopeClaimsMap;

        /**
         * Placeholder for a configuration option that contains
         * an object that maps the supported claim names
         * and the resolver functions returning the claim value.
         */
        var claimResolvers;

        /**
         * A (public) method that accepts an object that maps the supported scopes and the corresponding claim names,
         * and assigns it to a (private) variable that serves as a configuration option.
         * @param {object} params - An object that maps each supported scope value to an array of claim names,
         * in order to specify which claims need to be processed for the requested scopes.
         * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#ScopeClaims} for details.
         * @param {string[]} [params.profile] - An array of claim names to be returned if the profile scope is requested.
         * @param {string[]} [params.email] - An array of claim names to be returned if the email scope is requested.
         * @param {string[]} [params.address] - An array of claim names to be returned if the address scope is requested.
         * @param {string[]} [params.phone] - An array of claim names to be returned if the phone scope is requested.
         * @returns {undefined}
         */
        function setScopeClaimsMap(params) {
            scopeClaimsMap = params;
        }

        /**
         * A (public) method that accepts an object that maps the supported claim names
         * and the resolver functions returning the claim value,
         * and assigns it to a (private) variable that serves as a configuration option.
         * @param {object} params - An object that maps
         * each supported claim name to a function that computes and returns the claim value.
         */
        function setClaimResolvers(params) {
            claimResolvers = params;
        }

        // CLAIM RESOLVERS

        /**
         * Claim resolvers are functions that return a claim value.
         * @param {*}
         * @returns {*}
         */

        /**
         * Defines a claim resolver based on a user profile attribute.
         * @param {string} attributeName - Name of the user profile attribute.
         * @returns {function} A function that will determine the claim value
         * based on the user profile attribute and the (requested) claim properties.
         */
        function getUserProfileClaimResolver (attributeName) {
            /**
             * Resolves a claim with a user profile attribute value.
             * Returns undefined if the identity attribute is not populated,
             * OR if the claim has requested values that do not contain the identity attribute value.
             * ATTENTION: the aforementioned comparison is case-sensitive.
             * @param {org.forgerock.openidconnect.Claim} claim
             * An object that provides methods to obtain information/requirements associated with a claim.
             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.
             * @returns {string|HashSet|undefined}
             */
            function resolveClaim(claim) {
                var userProfileValue;

                if (identity) {
                    userProfileValue = getClaimValueFromSet(claim, identity.getAttribute(attributeName));

                    if (userProfileValue && !userProfileValue.isEmpty()) {
                        if (!claim.getValues() || claim.getValues().isEmpty() || claim.getValues().contains(userProfileValue)) {
                            return userProfileValue;
                        }
                    }
                }
            }

            return resolveClaim;
        }

        /**
         * Returns an address claim resolver based on a claim value obtained with another claim resolver.
         * @param {function} resolveClaim - A function that returns a claim value.
         * @returns {function} A function that will accept a claim as an argument,
         * run the claim resolver function for the claim and obtain the claim value,
         * and apply additional formatting to the value before returning it.
         */
        function getAddressClaimResolver (resolveClaim) {
            /**
             * Creates an address claim object from a value returned by a claim resolver,
             * and returns the address claim object as the claim value.
             * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#AddressClaim}.
             * The claim value is obtained with a claim resolving function available from the closure.
             * @param {org.forgerock.openidconnect.Claim} claim
             * An object that provides methods to obtain information/requirements associated with a claim.
             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.
             * @returns {java.util.LinkedHashMap|undefined} The address claim object created from a claim value.
             */
            function resolveAddressClaim(claim) {
                var claimValue = resolveClaim(claim);
                var addressObject;

                if (isClaimValueValid(claimValue)) {
                    addressObject = new frJava.LinkedHashMap();

                    addressObject.put('formatted', claimValue);

                    return addressObject;
                }
            }

            return resolveAddressClaim;
        }

        /**
         * Returns an essential claim resolver based on a claim value obtained with another claim resolver.
         * @param {function} resolveClaim - A function that returns a claim value.
         * @returns {function} A function that will accept a claim as an argument,
         * run the claim resolver function for the claim and obtain the claim value,
         * and apply additional logic for essential claims.
         */
        function getEssentialClaimResolver (resolveClaim) {
            /**
             * Returns a claim value or throws an error.
             * The claim value is obtained with a claim resolving function available from the closure.
             * Throws an exception if the claim is essential and no value is returned for the claim.
             *
             * Use of this resolver is optional.
             * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#IndividualClaimsRequests} stating:
             * "Note that even if the Claims are not available because the End-User did not authorize their release or they are not present,
             * the Authorization Server MUST NOT generate an error when Claims are not returned, whether they are Essential or Voluntary,
             * unless otherwise specified in the description of the specific claim."
             *
             * @param {org.forgerock.openidconnect.Claim} claim
             * An object that provides methods to obtain information/requirements associated with a claim.
             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.
             * @returns {*}
             * @throws {org.forgerock.oauth2.core.exceptions.InvalidRequestException}
             */
            function resolveEssentialClaim(claim) {
                var claimValue = resolveClaim(claim);

                if (claim.isEssential() && !isClaimValueValid(claimValue)) {
                    throw new frJava.InvalidRequestException('Could not provide value for essential claim: ' + claim.getName());
                }

                return claimValue;
            }

            return resolveEssentialClaim;
        }

        /**
         * Provides default resolution for a claim.
         * Use it if a claim-specific resolver is not defined in the configuration.
         * @param {org.forgerock.openidconnect.Claim} claim
         * An object that provides methods to obtain information/requirements associated with a claim.
         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.
         * @returns {*} A single value associated with this claim.
         */
        function resolveAnyClaim (claim) {
            if (claim.getValues().size() === 1) {
                return claim.getValues().toArray()[0];
            }
        }

        // UTILITIES

        /**
         * Returns claim value from a set.
         * If the set contains a single value, returns the value.
         * If the set contains multiple values, returns the set.
         * Otherwise, returns undefined.
         *
         * @param {org.forgerock.openidconnect.Claim} claim
         * An object that provides methods to obtain information/requirements associated with a claim.
         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.
         * @param {java.util.HashSet} set The set—for example, a user profile attribute value.
         * @returns {string|java.util.HashSet|undefined}
         */
        function getClaimValueFromSet (claim, set) {
            if (set && set.size()) {
                if (set.size() === 1) {
                    return set.toArray()[0];
                } else {
                    return set;
                }
            } else if (logger.warningEnabled()) {
                logger.warning('OIDC Claims script. Got an empty set for claim: ' + claim.getName());
            }
        }

        function isClaimValueValid (claimValue) {
            if (typeof claimValue === 'undefined' || claimValue === null) {
                return false;
            }

            return true;
        }

        // CLAIM PROCESSING

        /**
         * Constructs and returns an object populated with the computed claim values
         * and the requested scopes mapped to the claim names.
         * @returns {org.forgerock.oauth2.core.UserInfoClaims} The object to be returned to the authorization server.
         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html}.
         * @see RESULTS section for the use of this function.
         */
        function getUserInfoClaims () {
            return new frJava.UserInfoClaims(getComputedClaims(), getCompositeScopes());
        }

        /**
         * Creates a map of (requested) claim names populated with the computed claim values.
         * @returns {java.util.LinkedHashMap}
         * A map of the requested claim names and the corresponding claim values.
         */
        function getComputedClaims () {
            /**
             * Creates a complete list of claim objects from:
             * the claims derived from the scopes,
             * the claims provided by the authorization server,
             * and the claims requested by the client.
             * @returns {java.util.ArrayList}
             * Returns a complete list of org.forgerock.openidconnect.Claim objects available to the script.
             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for the claim object details.
             */
            function getClaims() {
                /**
                 * Returns a list of claim objects for the requested scopes.
                 * Uses the scopeClaimsMap configuration option to derive the claim names;
                 * no other properties of a claim derived from a scope are populated.
                 * @returns {java.util.ArrayList}
                 * A list of org.forgerock.openidconnect.Claim objects derived from the requested scopes.
                 * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for the claim object details.
                 */
                function convertScopeToClaims() {
                    var claims = new frJava.ArrayList();

                    scopes.toArray().forEach(function (scope) {
                        if (String(scope) !== 'openid' && scopeClaimsMap[scope]) {
                            scopeClaimsMap[scope].forEach(function (claimName) {
                                claims.add(new frJava.Claim(claimName));
                            });
                        }
                    });

                    return claims;
                }

                var claims = new frJava.ArrayList();

                claims.addAll(convertScopeToClaims());
                claims.addAll(claimObjects);
                claims.addAll(requestedTypedClaims);

                return claims;
            }

            /**
             * Computes and returns a claim value.
             * To obtain the claim value, uses the resolver function specified for the claim in the claimResolvers configuration object.
             * @see claimResolvers
             * If no resolver function is found, uses the default claim resolver function.
             *
             * @param {org.forgerock.openidconnect.Claim} claim
             * An object that provides methods to obtain information/requirements associated with a claim.
             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.
             * @returns {*} Claim value.
             * @throws {org.forgerock.oauth2.core.exceptions.InvalidRequestException}
             * Rethrows this exception if a claim resolver throws it.
             * You can throw org.forgerock.oauth2.core.exceptions.InvalidRequestException from your custom claim resolver
             * if you want to terminate the claim processing.
             */
            function computeClaim(claim) {
                var resolveClaim;
                var message;

                try {
                    resolveClaim = claimResolvers[claim.getName()] || resolveAnyClaim;

                    return resolveClaim(claim);
                } catch (e) {
                    message = 'OIDC Claims script exception. Unable to resolve OIDC Claim. ' + e;

                    if (String(e).indexOf('org.forgerock.oauth2.core.exceptions.InvalidRequestException') !== -1) {
                        throw e;
                    }

                    if (logger.warningEnabled()) {
                        logger.warning(message);
                    }
                }
            }

            var computedClaims = new frJava.LinkedHashMap();

            getClaims().toArray().forEach(function (claim) {
                var claimValue = computeClaim(claim);

                if (isClaimValueValid(claimValue)) {
                    computedClaims.put(claim.getName(), claimValue);
                } else {
                    /**
                     * If a claim has been processed, but appears in the list again,
                     * and its value cannot be computed under the new conditions,
                     * the claim is removed from the final result.
                     *
                     * For example, a claim could be mapped to a scope and found in the user profile,
                     * but also requested by the client with required values that don't match the computed one.
                     * @see {link https://openid.net/specs/openid-connect-core-1_0.html#IndividualClaimsRequests}.
                     * for the relevant OIDC specification details.
                     */
                    computedClaims.remove(claim.getName());
                }
            });

            return computedClaims;
        }

        /**
         * Creates a map of requested scopes and the corresponding claim names.
         * @returns {java.util.LinkedHashMap}
         */
        function getCompositeScopes () {
            var compositeScopes = new frJava.LinkedHashMap();

            scopes.toArray().forEach(function (scope) {
                var scopeClaims = new frJava.ArrayList();

                if (scopeClaimsMap[scope]) {
                    scopeClaimsMap[scope].forEach(function (claimName) {
                        scopeClaims.add(claimName);
                    });
                }

                if (scopeClaims.size()) {
                    compositeScopes.put(scope, scopeClaims);
                }
            });

            return compositeScopes;
        }

        // PUBLIC METHODS

        return {
            setScopeClaimsMap: setScopeClaimsMap,
            setClaimResolvers: setClaimResolvers,
            getUserProfileClaimResolver: getUserProfileClaimResolver,
            getAddressClaimResolver: getAddressClaimResolver,
            getEssentialClaimResolver: getEssentialClaimResolver,
            getUserInfoClaims: getUserInfoClaims
        };
    }

    // RESULTS

    /**
     * This script returns an instance of the org.forgerock.oauth2.core.UserInfoClaims class
     * populated with the computed claim values and
     * the requested scopes mapped to the claim names.
     * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html}.
     *
     * Assigning it to a variable gives you an opportunity
     * to log the content of the returned value during development.
     */
    var userInfoClaims = utils.getUserInfoClaims();

    /*
    logger.error(scriptName + ' results:')
    logger.error('Values: ' + userInfoClaims.getValues())
    logger.error('Scopes: ' + userInfoClaims.getCompositeScopes())
    */

    return userInfoClaims;
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Alpha-endUserUIClient-OIDC-Claims-Script.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "e1db8a0a-0329-4962-a5bf-ecffaca376ae": {
      "_id": "e1db8a0a-0329-4962-a5bf-ecffaca376ae",
      "context": "OIDC_CLAIMS",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Used by endUserUIClient",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Alpha endUserUIClient OIDC Claims Script",
      "script": "file://Alpha-endUserUIClient-OIDC-Claims-Script.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Amazon-Profile-Normalization.script.groovy 1`] = `
"/*
 * Copyright 2020 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

import static org.forgerock.json.JsonValue.field
import static org.forgerock.json.JsonValue.json
import static org.forgerock.json.JsonValue.object

return json(object(
        field("id", rawProfile.user_id),
        field("displayName", rawProfile.name),
        field("email", rawProfile.email),
        field("username", rawProfile.email)))"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Amazon-Profile-Normalization.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "6b3cfd48-62d3-48ff-a96f-fe8f3a22ab30": {
      "_id": "6b3cfd48-62d3-48ff-a96f-fe8f3a22ab30",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from Amazon",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Amazon Profile Normalization",
      "script": "file://Amazon-Profile-Normalization.script.groovy",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Apple-Profile-Normalization.script.groovy 1`] = `
"/*
 * Copyright 2021-2022 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 *
 * In some common default configurations, the following keys are required to be not empty:
 * username, givenName, familyName, email.
 *
 * From RFC4517: A value of the Directory String syntax is a string of one or more
 * arbitrary characters from the Universal Character Set (UCS).
 * A zero-length character string is not permitted.
 */

import static org.forgerock.json.JsonValue.field
import static org.forgerock.json.JsonValue.json
import static org.forgerock.json.JsonValue.object

String email = "change@me.com"
String subjectId = rawProfile.sub
String firstName = " "
String lastName = " "
String username = subjectId
String name

if (rawProfile.isDefined("email") && rawProfile.email.isNotNull()){ // User can elect to not share their email
    email = rawProfile.email.asString()
    username = email
}
if (rawProfile.isDefined("name") && rawProfile.name.isNotNull()) {
    if (rawProfile.name.isDefined("firstName") && rawProfile.name.firstName.isNotNull()) {
        firstName = rawProfile.name.firstName.asString()
    }
    if (rawProfile.name.isDefined("lastName") && rawProfile.name.lastName.isNotNull()) {
        lastName = rawProfile.name.lastName.asString()
    }
}

name = (firstName?.trim() ? firstName : "") + (lastName?.trim() ? ((firstName?.trim() ? " " : "") + lastName) : "")
name =  (!name?.trim()) ? " " : name

return json(object(
        field("id", subjectId),
        field("displayName", name),
        field("email", email),
        field("givenName", firstName),
        field("familyName", lastName),
        field("username", username)))"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Apple-Profile-Normalization.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "484e6246-dbc6-4288-97e6-54e55431402e": {
      "_id": "484e6246-dbc6-4288-97e6-54e55431402e",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from Apple",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Apple Profile Normalization",
      "script": "file://Apple-Profile-Normalization.script.groovy",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Authentication-Tree-Decision-Node-Script.script.js 1`] = `
"/*
  - Data made available by nodes that have already executed are available in the sharedState variable.
  - The script should set outcome to either "true" or "false".
 */

outcome = "true";"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Authentication-Tree-Decision-Node-Script.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "01e1a3c0-038b-4c16-956a-6c9d89328cff": {
      "_id": "01e1a3c0-038b-4c16-956a-6c9d89328cff",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Default global script for a scripted decision node",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Authentication Tree Decision Node Script",
      "script": "file://Authentication-Tree-Decision-Node-Script.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Browser-Language-Decision.script.js 1`] = `
"/* Browser Language Decision
 * 
 * Detect the browser language in the request and branch out to its named exit (e.g.: "de" or "en" or "fr") 
 * if it is part of the supportedLanguages array, otherwise take the "other" exit.
 * 
 * This script does not need to be parametrized. It will work properly as is.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - other
 * - <all of the items in the supportedLanguages array>
 *
 * Author: volker.scheuber@forgerock.com
 */
(function () {
      /******************************/
      /* Begin Script Configuration */
      
      // add all the language codes you want to support
      var supportedLanguages = ["de","en","fr"];
      
      /* End Script Configuration   */
      /******************************/
  
      outcome = getBrowserLanguage();
      
    /*
     * Returns the supported browser language or "other"
     */
    function getBrowserLanguage() {
          var languageHeader = getHeader("accept-language");
          var language = languageHeader.split(';')[0].split(',')[0].split('-')[0];
          if (supportedLanguages.indexOf(language) < 0) {
              return "other";
        }
        return language;
    }

    /*
     * Returns the value of the requested header
     */
    function getHeader(headerName) {
        return requestHeaders.get(headerName).get(0)+"";
    }
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Browser-Language-Decision.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "8508a00e-ad45-4310-b3c7-c6871b6a41a9": {
      "_id": "8508a00e-ad45-4310-b3c7-c6871b6a41a9",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Browser Language Decision",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Browser Language Decision",
      "script": "file://Browser-Language-Decision.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./CP-ITE-static-inner1.script.js 1`] = `
"/*
 * Copyright 2021 ForgeRock AS. All Rights Reserved
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

/**
 * The following script is a simplified template for understanding how to build
 * up a config Map object with custom values. The Config Provider Node will then
 * provide this config Map to the desired node type. It is important that the Map
 * you build here is named 'config'.
 *
 * Defined variables:
 *
 * nodeState - Node State (1)
 *           Always present, this represents the current values stored in the node state.
 *
 * idRepository - Profile Data (2)
 *           Always present, a repository to retrieve user information.
 *
 * secrets - Credentials and Secrets (3)
 *           Always present, an interface to access the Secrets API from a scripting context.
 *
 * requestHeaders (4) - Map (5)
 *           Always present, an object that provides methods for accessing headers in the login request.
 *
 * logger - Debug Logging (6)
 *          Always present, the debug logger instance.
 *
 * httpClient - HTTP Client (7)
 *          Always present, the HTTP client that can be used to make external HTTP requests.
 *
 * realm - String (primitive).
 *          Always present, the name of the realm the user is authenticating to.
 *
 * existingSession - Map<String, String> (5)
 *          Present if the request contains the session cookie, the user's session object. The returned map from
 *          SSOToken.getProperties() (8)
 *
 * requestParameters - Map (5)
 *          Always present, the object that contains the authentication request parameters.
 *
 *
 * Outputs:
 *
 * config - Map (5)
 *           Define and fill a Map object named 'config' with custom values, this will define the configuration for the
 *           associated node selected in the ConfigProviderNode.
 *
 * Reference:
 * (1) Node State - https://backstage.forgerock.com/docs/idcloud-am/latest/authentication-guide/scripting-api-node.html#scripting-api-node-nodeState
 * (2) Profile Data - https://backstage.forgerock.com/docs/am/7.1/authentication-guide/scripting-api-node.html#scripting-api-node-id-repo
 * (3) Credentials and Secrets - https://backstage.forgerock.com/docs/am/7.1/authentication-guide/scripting-api-node.html#scripting-api-authn-secrets
 * (4) Request Headers - https://backstage.forgerock.com/docs/am/7/authentication-guide/scripting-api-node.html#scripting-api-node-requestHeaders.
 * (5) Map - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/Map.html
 * (6) Debug Logging - https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.
 * (7) HTTP Client - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/http/Client.html.
 * (8) SSOToken - https://backstage.forgerock.com/docs/am/7/apidocs/com/iplanet/sso/SSOToken.html.
 */

config = {
  tree: 'inner1'
};"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./CP-ITE-static-inner1.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "638c865e-d393-4503-a517-535b9c74e010": {
      "_id": "638c865e-d393-4503-a517-535b9c74e010",
      "context": "CONFIG_PROVIDER_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "CP-InnerTreeEvaluator-static-inner1",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "CP-ITE-static-inner1",
      "script": "file://CP-ITE-static-inner1.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./CP-ITE-static-inner2.script.js 1`] = `
"/*
 * Copyright 2021 ForgeRock AS. All Rights Reserved
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

/**
 * The following script is a simplified template for understanding how to build
 * up a config Map object with custom values. The Config Provider Node will then
 * provide this config Map to the desired node type. It is important that the Map
 * you build here is named 'config'.
 *
 * Defined variables:
 *
 * nodeState - Node State (1)
 *           Always present, this represents the current values stored in the node state.
 *
 * idRepository - Profile Data (2)
 *           Always present, a repository to retrieve user information.
 *
 * secrets - Credentials and Secrets (3)
 *           Always present, an interface to access the Secrets API from a scripting context.
 *
 * requestHeaders (4) - Map (5)
 *           Always present, an object that provides methods for accessing headers in the login request.
 *
 * logger - Debug Logging (6)
 *          Always present, the debug logger instance.
 *
 * httpClient - HTTP Client (7)
 *          Always present, the HTTP client that can be used to make external HTTP requests.
 *
 * realm - String (primitive).
 *          Always present, the name of the realm the user is authenticating to.
 *
 * existingSession - Map<String, String> (5)
 *          Present if the request contains the session cookie, the user's session object. The returned map from
 *          SSOToken.getProperties() (8)
 *
 * requestParameters - Map (5)
 *          Always present, the object that contains the authentication request parameters.
 *
 *
 * Outputs:
 *
 * config - Map (5)
 *           Define and fill a Map object named 'config' with custom values, this will define the configuration for the
 *           associated node selected in the ConfigProviderNode.
 *
 * Reference:
 * (1) Node State - https://backstage.forgerock.com/docs/idcloud-am/latest/authentication-guide/scripting-api-node.html#scripting-api-node-nodeState
 * (2) Profile Data - https://backstage.forgerock.com/docs/am/7.1/authentication-guide/scripting-api-node.html#scripting-api-node-id-repo
 * (3) Credentials and Secrets - https://backstage.forgerock.com/docs/am/7.1/authentication-guide/scripting-api-node.html#scripting-api-authn-secrets
 * (4) Request Headers - https://backstage.forgerock.com/docs/am/7/authentication-guide/scripting-api-node.html#scripting-api-node-requestHeaders.
 * (5) Map - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/Map.html
 * (6) Debug Logging - https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.
 * (7) HTTP Client - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/http/Client.html.
 * (8) SSOToken - https://backstage.forgerock.com/docs/am/7/apidocs/com/iplanet/sso/SSOToken.html.
 */

config = {
  tree: 'inner2'
};"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./CP-ITE-static-inner2.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "740cf6fa-a173-4e9d-b17c-44758e9b19ec": {
      "_id": "740cf6fa-a173-4e9d-b17c-44758e9b19ec",
      "context": "CONFIG_PROVIDER_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "CP-InnerTreeEvaluator-static-inner2",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "CP-ITE-static-inner2",
      "script": "file://CP-ITE-static-inner2.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Check-Existing-Session.script.js 1`] = `
"if (typeof existingSession !== 'undefined')
{
  outcome = "hasSession";
  sharedState.put("username", existingSession.get("UserId"));
  sharedState.put("_id", existingSession.get("UserId"));
  if (sharedState.get("objectAttributes")) {
    sharedState.get("objectAttributes").put("userName", existingSession.get("UserId"));
  }
  else {
    sharedState.put("objectAttributes", {userName: existingSession.get("UserId")});
  }
}
else
{
  outcome = "noSession";
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Check-Existing-Session.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "0ab1dd57-eafd-4063-8e60-65bfac8108b7": {
      "_id": "0ab1dd57-eafd-4063-8e60-65bfac8108b7",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Check existing session and set username",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Check Existing Session",
      "script": "file://Check-Existing-Session.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Check-Username.script.js 1`] = `
"/* Check Username
 *
 * Author: volker.scheuber@forgerock.com
 * 
 * Check if username has already been collected.
 * Return "known" if yes, "unknown" otherwise.
 * 
 * This script does not need to be parametrized. It will work properly as is.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - known
 * - unknown
 */
(function () {
    if (null != sharedState.get("username")) {
        outcome = "known";
    }
    else {
        outcome = "unknown";
    }
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Check-Username.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "739bdc48-fd24-4c52-b353-88706d75558a": {
      "_id": "739bdc48-fd24-4c52-b353-88706d75558a",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Check if username has already been collected.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Check Username",
      "script": "file://Check-Username.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Choice-inner1-inner2.script.js 1`] = `
"/* Choice inner1, inner2
 *
 * Author: volker.scheuber@forgerock.com
 * 
 * Render a dropdown selector
 * 
 * This script must be parametrized. It will not work properly as is.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 */
(function () {
  outcome = "true";
  var choices = ["inner1", "inner2"];
  
  var fr = JavaImporter(
    org.forgerock.openam.auth.node.api.Action,
    javax.security.auth.callback.ChoiceCallback
  )

  if (callbacks.isEmpty()) {
    action = fr.Action.send([
      new fr.ChoiceCallback("Select a journey", choices, 0, false)
    ]).build();
  } else {
    var choice = parseInt(callbacks.get(0).getSelectedIndexes()[0]);
    nodeState.putShared("nodeConfig", {tree: choices[choice]});
    action = fr.Action.goTo(outcome).build();
  }
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Choice-inner1-inner2.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "14f14ad3-f35f-455b-a7ba-d7cd939c6921": {
      "_id": "14f14ad3-f35f-455b-a7ba-d7cd939c6921",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Dropdown selector",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Choice inner1, inner2",
      "script": "file://Choice-inner1-inner2.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Collect-Extra-Fields.script.js 1`] = `
"/* Collect Extra Fields
 * 
 * Collect extra fields not part of the user profile.
 * 
 * This script does not need to be parametrized. It will work properly as is.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 *
 * Author: volker.scheuber@forgerock.com
 */
(function () {
    outcome = 'true';
    var fr = JavaImporter(
        org.forgerock.openam.auth.node.api.Action,
          javax.security.auth.callback.NameCallback
    )
    if (callbacks.isEmpty()) {
        action = fr.Action.send(
            new fr.NameCallback('modality'),
            new fr.NameCallback('jwtToken')
        ).build();
    }
    else {
          var modality = callbacks.get(0).getName();
          var jwtToken = callbacks.get(1).getName();
          nodeState.putShared('modality', modality);
          nodeState.putShared('jwtToken', jwtToken);
        action = fr.Action.goTo(outcome).build();
    }
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Collect-Extra-Fields.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "92edf2c7-0bab-412c-a0da-82ad4f04505b": {
      "_id": "92edf2c7-0bab-412c-a0da-82ad4f04505b",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Collect Extra Fields",
      "script": "file://Collect-Extra-Fields.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Collect-Inner-Tree-Evaluator-Config.script.js 1`] = `
"/* Collect Inner Tree Evaluator Config
 * 
 * Collect all the configuration items required for the Inner Tree Evaluator to function properly.
 * 
 * This script does not need to be parametrized. It will work properly as is.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 *
 * Author: volker.scheuber@forgerock.com
 */
(function () {
    outcome = "true";
      var config = {
        "tree": "Login",
    };
      var script = "";
    script += "Array.prototype.slice.call(";
    script += "    document.getElementsByTagName('input')";
    script += ").forEach(";
    script += "    function (input,i) {";
    script += "        console.log('input '+i);"
    script += "        var config = JSON.parse('"+JSON.stringify(config)+"');";
    script += "        var keys = Object.keys(config);";
    script += "        if (input.type === 'text') {";
    script += "            input.setAttribute('value', config[keys[i]]);";
    script += "            input.dispatchEvent(new KeyboardEvent( 'input' , {'key':'Enter'} ));";
    script += "        }";
    script += "    }";
    script += ");";
    var fr = JavaImporter(
        org.forgerock.openam.auth.node.api.Action,
          javax.security.auth.callback.NameCallback,
        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback
    )
    if (callbacks.isEmpty()) {
        action = fr.Action.send(
            new fr.NameCallback("tree", config.tree),
              new fr.ScriptTextOutputCallback(script)
        ).build();
    }
    else {
          config[callbacks.get(0).getPrompt()] = callbacks.get(0).getName();
          nodeState.putShared("nodeConfig", config);
        action = fr.Action.goTo(outcome).build();
    }
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Collect-Inner-Tree-Evaluator-Config.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "d70df7a8-6390-409d-b821-166272a9a9c8": {
      "_id": "d70df7a8-6390-409d-b821-166272a9a9c8",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Collect all the configuration items required for the Inner Tree Evaluator to function properly.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Collect Inner Tree Evaluator Config",
      "script": "file://Collect-Inner-Tree-Evaluator-Config.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Collect-Message-Node-Config.script.js 1`] = `
"/* Collect Message Node Config
 * 
 * Collect all the configuration items required for the Message Node to function properly.
 * 
 * This script does not need to be parametrized. It will work properly as is.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 *
 * Author: volker.scheuber@forgerock.com
 */
(function () {
    outcome = "true";
      var config = {
        "message": {"en": "I believe I can fly!"},
        "messageYes": {"en": "Glorious!"},
        "messageNo": {"en": "Inconceivable!"}
    };
      var script = "";
    script += "Array.prototype.slice.call(";
    script += "    document.getElementsByTagName('input')";
    script += ").forEach(";
    script += "    function (input,i) {";
    script += "        console.log('input '+i);"
    script += "        var config = JSON.parse('"+JSON.stringify(config)+"');";
    script += "        var keys = Object.keys(config);";
    script += "        if (input.type === 'text') {";
    script += "            input.setAttribute('value', config[keys[i]].en);";
    script += "            input.dispatchEvent(new KeyboardEvent( 'input' , {'key':'Enter'} ));";
    script += "        }";
    script += "    }";
    script += ");";
    var fr = JavaImporter(
        org.forgerock.openam.auth.node.api.Action,
          javax.security.auth.callback.NameCallback,
        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback
    )
    if (callbacks.isEmpty()) {
        action = fr.Action.send(
            new fr.NameCallback("message", config.message.en),
            new fr.NameCallback("messageYes", config.messageYes.en),
            new fr.NameCallback("messageNo", config.messageNo.en),
              new fr.ScriptTextOutputCallback(script)
        ).build();
    }
    else {
          config[callbacks.get(0).getPrompt()].en = callbacks.get(0).getName();
          config[callbacks.get(1).getPrompt()].en = callbacks.get(1).getName();
          config[callbacks.get(2).getPrompt()].en = callbacks.get(2).getName();
          nodeState.putShared("nodeConfig", config);
        action = fr.Action.goTo(outcome).build();
    }
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Collect-Message-Node-Config.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "169150da-0bd1-4866-8095-eae0bbc269e4": {
      "_id": "169150da-0bd1-4866-8095-eae0bbc269e4",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Collect all the configuration items required for the Message Node to function properly.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Collect Message Node Config",
      "script": "file://Collect-Message-Node-Config.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Collect-PIN.script.js 1`] = `
"/* Collect PIN
 * 
 * Collect PIN using password callback and store in user profile.
 * 
 * This script must be parametrized. It may not work properly as is.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 *
 * Author: volker.scheuber@forgerock.com
 */
(function () {
  
  /*** BEGIN PARAMETRIZATION ***/
  var pinAttrName = 'frUnindexedString3';
  var pinPrompt = 'New PIN';
  /**** END PARAMETRIZATION ****/
  
  outcome = 'true';
  var fr = JavaImporter(
    org.forgerock.openam.auth.node.api.Action,
      javax.security.auth.callback.PasswordCallback
  )
  if (callbacks.isEmpty()) {
    action = fr.Action.send(
      new fr.PasswordCallback(pinPrompt, false)
    ).build();
  }
  else {
      var pin = new java.lang.String(callbacks.get(0).getPassword());
    setTransientObjectAttribute(pinAttrName, pin);
    action = fr.Action.goTo(outcome).build();
  }

  /*
   * Store attributes in transient state for use with the Create/Patch Object nodes.
   */
  function setTransientObjectAttribute(name, value) {
    var transientStorage = transientState.get("objectAttributes");
    if (transientStorage && value) {
      if (transientStorage.put) {
        transientStorage.put(name, value);
      }
      else {
        transientStorage[name] = value;
      }
    }
    else if (value) {
      transientState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));
    }
  }
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Collect-PIN.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "e4417108-4dc9-4ffc-9995-3cd490adf2ed": {
      "_id": "e4417108-4dc9-4ffc-9995-3cd490adf2ed",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Collect PIN",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Collect PIN",
      "script": "file://Collect-PIN.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Collect-Replay-Password-(frUnindexedString2).script.js 1`] = `
"/* Collect And Encrypt Custom Password
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 * 
 * See copyright notices, conditions, and disclaimers at the bottom of this script.
 * 
 * volker.scheuber@forgerock.com
 */
(function () {
    "use strict";var sjcl={cipher:{},hash:{},keyexchange:{},mode:{},misc:{},codec:{},exception:{corrupt:function(message){this.toString=function(){return"CORRUPT: "+this.message};this.message=message},invalid:function(message){this.toString=function(){return"INVALID: "+this.message};this.message=message},bug:function(message){this.toString=function(){return"BUG: "+this.message};this.message=message},notReady:function(message){this.toString=function(){return"NOT READY: "+this.message};this.message=message}}};sjcl.cipher.aes=function(key){if(!this._tables[0][0][0]){this._precompute()}var i,j,tmp,encKey,decKey,sbox=this._tables[0][4],decTable=this._tables[1],keyLen=key.length,rcon=1;if(keyLen!==4&&keyLen!==6&&keyLen!==8){throw new sjcl.exception.invalid("invalid aes key size")}this._key=[encKey=key.slice(0),decKey=[]];for(i=keyLen;i<4*keyLen+28;i++){tmp=encKey[i-1];if(i%keyLen===0||keyLen===8&&i%keyLen===4){tmp=sbox[tmp>>>24]<<24^sbox[tmp>>16&255]<<16^sbox[tmp>>8&255]<<8^sbox[tmp&255];if(i%keyLen===0){tmp=tmp<<8^tmp>>>24^rcon<<24;rcon=rcon<<1^(rcon>>7)*283}}encKey[i]=encKey[i-keyLen]^tmp}for(j=0;i;j++,i--){tmp=encKey[j&3?i:i-4];if(i<=4||j<4){decKey[j]=tmp}else{decKey[j]=decTable[0][sbox[tmp>>>24]]^decTable[1][sbox[tmp>>16&255]]^decTable[2][sbox[tmp>>8&255]]^decTable[3][sbox[tmp&255]]}}};sjcl.cipher.aes.prototype={encrypt:function(data){return this._crypt(data,0)},decrypt:function(data){return this._crypt(data,1)},_tables:[[[],[],[],[],[]],[[],[],[],[],[]]],_precompute:function(){var encTable=this._tables[0],decTable=this._tables[1],sbox=encTable[4],sboxInv=decTable[4],i,x,xInv,d=[],th=[],x2,x4,x8,s,tEnc,tDec;for(i=0;i<256;i++){th[(d[i]=i<<1^(i>>7)*283)^i]=i}for(x=xInv=0;!sbox[x];x^=x2||1,xInv=th[xInv]||1){s=xInv^xInv<<1^xInv<<2^xInv<<3^xInv<<4;s=s>>8^s&255^99;sbox[x]=s;sboxInv[s]=x;x8=d[x4=d[x2=d[x]]];tDec=x8*16843009^x4*65537^x2*257^x*16843008;tEnc=d[s]*257^s*16843008;for(i=0;i<4;i++){encTable[i][x]=tEnc=tEnc<<24^tEnc>>>8;decTable[i][s]=tDec=tDec<<24^tDec>>>8}}for(i=0;i<5;i++){encTable[i]=encTable[i].slice(0);decTable[i]=decTable[i].slice(0)}},_crypt:function(input,dir){if(input.length!==4){throw new sjcl.exception.invalid("invalid aes block size")}var key=this._key[dir],a=input[0]^key[0],b=input[dir?3:1]^key[1],c=input[2]^key[2],d=input[dir?1:3]^key[3],a2,b2,c2,nInnerRounds=key.length/4-2,i,kIndex=4,out=[0,0,0,0],table=this._tables[dir],t0=table[0],t1=table[1],t2=table[2],t3=table[3],sbox=table[4];for(i=0;i<nInnerRounds;i++){a2=t0[a>>>24]^t1[b>>16&255]^t2[c>>8&255]^t3[d&255]^key[kIndex];b2=t0[b>>>24]^t1[c>>16&255]^t2[d>>8&255]^t3[a&255]^key[kIndex+1];c2=t0[c>>>24]^t1[d>>16&255]^t2[a>>8&255]^t3[b&255]^key[kIndex+2];d=t0[d>>>24]^t1[a>>16&255]^t2[b>>8&255]^t3[c&255]^key[kIndex+3];kIndex+=4;a=a2;b=b2;c=c2}for(i=0;i<4;i++){out[dir?3&-i:i]=sbox[a>>>24]<<24^sbox[b>>16&255]<<16^sbox[c>>8&255]<<8^sbox[d&255]^key[kIndex++];a2=a;a=b;b=c;c=d;d=a2}return out}};sjcl.bitArray={bitSlice:function(a,bstart,bend){a=sjcl.bitArray._shiftRight(a.slice(bstart/32),32-(bstart&31)).slice(1);return bend===undefined?a:sjcl.bitArray.clamp(a,bend-bstart)},extract:function(a,bstart,blength){var x,sh=Math.floor(-bstart-blength&31);if((bstart+blength-1^bstart)&-32){x=a[bstart/32|0]<<32-sh^a[bstart/32+1|0]>>>sh}else{x=a[bstart/32|0]>>>sh}return x&(1<<blength)-1},concat:function(a1,a2){if(a1.length===0||a2.length===0){return a1.concat(a2)}var last=a1[a1.length-1],shift=sjcl.bitArray.getPartial(last);if(shift===32){return a1.concat(a2)}else{return sjcl.bitArray._shiftRight(a2,shift,last|0,a1.slice(0,a1.length-1))}},bitLength:function(a){var l=a.length,x;if(l===0){return 0}x=a[l-1];return(l-1)*32+sjcl.bitArray.getPartial(x)},clamp:function(a,len){if(a.length*32<len){return a}a=a.slice(0,Math.ceil(len/32));var l=a.length;len=len&31;if(l>0&&len){a[l-1]=sjcl.bitArray.partial(len,a[l-1]&2147483648>>len-1,1)}return a},partial:function(len,x,_end){if(len===32){return x}return(_end?x|0:x<<32-len)+len*1099511627776},getPartial:function(x){return Math.round(x/1099511627776)||32},equal:function(a,b){if(sjcl.bitArray.bitLength(a)!==sjcl.bitArray.bitLength(b)){return false}var x=0,i;for(i=0;i<a.length;i++){x|=a[i]^b[i]}return x===0},_shiftRight:function(a,shift,carry,out){var i,last2=0,shift2;if(out===undefined){out=[]}for(;shift>=32;shift-=32){out.push(carry);carry=0}if(shift===0){return out.concat(a)}for(i=0;i<a.length;i++){out.push(carry|a[i]>>>shift);carry=a[i]<<32-shift}last2=a.length?a[a.length-1]:0;shift2=sjcl.bitArray.getPartial(last2);out.push(sjcl.bitArray.partial(shift+shift2&31,shift+shift2>32?carry:out.pop(),1));return out},_xor4:function(x,y){return[x[0]^y[0],x[1]^y[1],x[2]^y[2],x[3]^y[3]]},byteswapM:function(a){var i,v,m=65280;for(i=0;i<a.length;++i){v=a[i];a[i]=v>>>24|v>>>8&m|(v&m)<<8|v<<24}return a}};sjcl.codec.utf8String={fromBits:function(arr){var out="",bl=sjcl.bitArray.bitLength(arr),i,tmp;for(i=0;i<bl/8;i++){if((i&3)===0){tmp=arr[i/4]}out+=String.fromCharCode(tmp>>>8>>>8>>>8);tmp<<=8}return decodeURIComponent(escape(out))},toBits:function(str){str=unescape(encodeURIComponent(str));var out=[],i,tmp=0;for(i=0;i<str.length;i++){tmp=tmp<<8|str.charCodeAt(i);if((i&3)===3){out.push(tmp);tmp=0}}if(i&3){out.push(sjcl.bitArray.partial(8*(i&3),tmp))}return out}};sjcl.codec.base64={_chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",fromBits:function(arr,_noEquals,_url){var out="",i,bits=0,c=sjcl.codec.base64._chars,ta=0,bl=sjcl.bitArray.bitLength(arr);if(_url){c=c.substr(0,62)+"-_"}for(i=0;out.length*6<bl;){out+=c.charAt((ta^arr[i]>>>bits)>>>26);if(bits<6){ta=arr[i]<<6-bits;bits+=26;i++}else{ta<<=6;bits-=6}}while(out.length&3&&!_noEquals){out+="="}return out},toBits:function(str,_url){str=str.replace(/\\s|=/g,"");var out=[],i,bits=0,c=sjcl.codec.base64._chars,ta=0,x;if(_url){c=c.substr(0,62)+"-_"}for(i=0;i<str.length;i++){x=c.indexOf(str.charAt(i));if(x<0){throw new sjcl.exception.invalid("this isn't base64!")}if(bits>26){bits-=26;out.push(ta^x>>>bits);ta=x<<32-bits}else{bits+=6;ta^=x<<32-bits}}if(bits&56){out.push(sjcl.bitArray.partial(bits&56,ta,1))}return out}};sjcl.codec.base64url={fromBits:function(arr){return sjcl.codec.base64.fromBits(arr,1,1)},toBits:function(str){return sjcl.codec.base64.toBits(str,1)}};sjcl.hash.sha256=function(hash){if(!this._key[0]){this._precompute()}if(hash){this._h=hash._h.slice(0);this._buffer=hash._buffer.slice(0);this._length=hash._length}else{this.reset()}};sjcl.hash.sha256.hash=function(data){return(new sjcl.hash.sha256).update(data).finalize()};sjcl.hash.sha256.prototype={blockSize:512,reset:function(){this._h=this._init.slice(0);this._buffer=[];this._length=0;return this},update:function(data){if(typeof data==="string"){data=sjcl.codec.utf8String.toBits(data)}var i,b=this._buffer=sjcl.bitArray.concat(this._buffer,data),ol=this._length,nl=this._length=ol+sjcl.bitArray.bitLength(data);if(nl>9007199254740991){throw new sjcl.exception.invalid("Cannot hash more than 2^53 - 1 bits")}if(typeof Uint32Array!=="undefined"){var c=new Uint32Array(b);var j=0;for(i=512+ol-(512+ol&511);i<=nl;i+=512){this._block(c.subarray(16*j,16*(j+1)));j+=1}b.splice(0,16*j)}else{for(i=512+ol-(512+ol&511);i<=nl;i+=512){this._block(b.splice(0,16))}}return this},finalize:function(){var i,b=this._buffer,h=this._h;b=sjcl.bitArray.concat(b,[sjcl.bitArray.partial(1,1)]);for(i=b.length+2;i&15;i++){b.push(0)}b.push(Math.floor(this._length/4294967296));b.push(this._length|0);while(b.length){this._block(b.splice(0,16))}this.reset();return h},_init:[],_key:[],_precompute:function(){var i=0,prime=2,factor,isPrime;function frac(x){return(x-Math.floor(x))*4294967296|0}for(;i<64;prime++){isPrime=true;for(factor=2;factor*factor<=prime;factor++){if(prime%factor===0){isPrime=false;break}}if(isPrime){if(i<8){this._init[i]=frac(Math.pow(prime,1/2))}this._key[i]=frac(Math.pow(prime,1/3));i++}}},_block:function(w){var i,tmp,a,b,h=this._h,k=this._key,h0=h[0],h1=h[1],h2=h[2],h3=h[3],h4=h[4],h5=h[5],h6=h[6],h7=h[7];for(i=0;i<64;i++){if(i<16){tmp=w[i]}else{a=w[i+1&15];b=w[i+14&15];tmp=w[i&15]=(a>>>7^a>>>18^a>>>3^a<<25^a<<14)+(b>>>17^b>>>19^b>>>10^b<<15^b<<13)+w[i&15]+w[i+9&15]|0}tmp=tmp+h7+(h4>>>6^h4>>>11^h4>>>25^h4<<26^h4<<21^h4<<7)+(h6^h4&(h5^h6))+k[i];h7=h6;h6=h5;h5=h4;h4=h3+tmp|0;h3=h2;h2=h1;h1=h0;h0=tmp+(h1&h2^h3&(h1^h2))+(h1>>>2^h1>>>13^h1>>>22^h1<<30^h1<<19^h1<<10)|0}h[0]=h[0]+h0|0;h[1]=h[1]+h1|0;h[2]=h[2]+h2|0;h[3]=h[3]+h3|0;h[4]=h[4]+h4|0;h[5]=h[5]+h5|0;h[6]=h[6]+h6|0;h[7]=h[7]+h7|0}};sjcl.mode.ccm={name:"ccm",_progressListeners:[],listenProgress:function(cb){sjcl.mode.ccm._progressListeners.push(cb)},unListenProgress:function(cb){var index=sjcl.mode.ccm._progressListeners.indexOf(cb);if(index>-1){sjcl.mode.ccm._progressListeners.splice(index,1)}},_callProgressListener:function(val){var p=sjcl.mode.ccm._progressListeners.slice(),i;for(i=0;i<p.length;i+=1){p[i](val)}},encrypt:function(prf,plaintext,iv,adata,tlen){var L,out=plaintext.slice(0),tag,w=sjcl.bitArray,ivl=w.bitLength(iv)/8,ol=w.bitLength(out)/8;tlen=tlen||64;adata=adata||[];if(ivl<7){throw new sjcl.exception.invalid("ccm: iv must be at least 7 bytes")}for(L=2;L<4&&ol>>>8*L;L++){}if(L<15-ivl){L=15-ivl}iv=w.clamp(iv,8*(15-L));tag=sjcl.mode.ccm._computeTag(prf,plaintext,iv,adata,tlen,L);out=sjcl.mode.ccm._ctrMode(prf,out,iv,tag,tlen,L);return w.concat(out.data,out.tag)},decrypt:function(prf,ciphertext,iv,adata,tlen){tlen=tlen||64;adata=adata||[];var L,w=sjcl.bitArray,ivl=w.bitLength(iv)/8,ol=w.bitLength(ciphertext),out=w.clamp(ciphertext,ol-tlen),tag=w.bitSlice(ciphertext,ol-tlen),tag2;ol=(ol-tlen)/8;if(ivl<7){throw new sjcl.exception.invalid("ccm: iv must be at least 7 bytes")}for(L=2;L<4&&ol>>>8*L;L++){}if(L<15-ivl){L=15-ivl}iv=w.clamp(iv,8*(15-L));out=sjcl.mode.ccm._ctrMode(prf,out,iv,tag,tlen,L);tag2=sjcl.mode.ccm._computeTag(prf,out.data,iv,adata,tlen,L);if(!w.equal(out.tag,tag2)){throw new sjcl.exception.corrupt("ccm: tag doesn't match")}return out.data},_macAdditionalData:function(prf,adata,iv,tlen,ol,L){var mac,tmp,i,macData=[],w=sjcl.bitArray,xor=w._xor4;mac=[w.partial(8,(adata.length?1<<6:0)|tlen-2<<2|L-1)];mac=w.concat(mac,iv);mac[3]|=ol;mac=prf.encrypt(mac);if(adata.length){tmp=w.bitLength(adata)/8;if(tmp<=65279){macData=[w.partial(16,tmp)]}else if(tmp<=4294967295){macData=w.concat([w.partial(16,65534)],[tmp])}macData=w.concat(macData,adata);for(i=0;i<macData.length;i+=4){mac=prf.encrypt(xor(mac,macData.slice(i,i+4).concat([0,0,0])))}}return mac},_computeTag:function(prf,plaintext,iv,adata,tlen,L){var mac,i,w=sjcl.bitArray,xor=w._xor4;tlen/=8;if(tlen%2||tlen<4||tlen>16){throw new sjcl.exception.invalid("ccm: invalid tag length")}if(adata.length>4294967295||plaintext.length>4294967295){throw new sjcl.exception.bug("ccm: can't deal with 4GiB or more data")}mac=sjcl.mode.ccm._macAdditionalData(prf,adata,iv,tlen,w.bitLength(plaintext)/8,L);for(i=0;i<plaintext.length;i+=4){mac=prf.encrypt(xor(mac,plaintext.slice(i,i+4).concat([0,0,0])))}return w.clamp(mac,tlen*8)},_ctrMode:function(prf,data,iv,tag,tlen,L){var enc,i,w=sjcl.bitArray,xor=w._xor4,ctr,l=data.length,bl=w.bitLength(data),n=l/50,p=n;ctr=w.concat([w.partial(8,L-1)],iv).concat([0,0,0]).slice(0,4);tag=w.bitSlice(xor(tag,prf.encrypt(ctr)),0,tlen);if(!l){return{tag:tag,data:[]}}for(i=0;i<l;i+=4){if(i>n){sjcl.mode.ccm._callProgressListener(i/l);n+=p}ctr[3]++;enc=prf.encrypt(ctr);data[i]^=enc[0];data[i+1]^=enc[1];data[i+2]^=enc[2];data[i+3]^=enc[3]}return{tag:tag,data:w.clamp(data,bl)}}};sjcl.misc.hmac=function(key,Hash){this._hash=Hash=Hash||sjcl.hash.sha256;var exKey=[[],[]],i,bs=Hash.prototype.blockSize/32;this._baseHash=[new Hash,new Hash];if(key.length>bs){key=Hash.hash(key)}for(i=0;i<bs;i++){exKey[0][i]=key[i]^909522486;exKey[1][i]=key[i]^1549556828}this._baseHash[0].update(exKey[0]);this._baseHash[1].update(exKey[1]);this._resultHash=new Hash(this._baseHash[0])};sjcl.misc.hmac.prototype.encrypt=sjcl.misc.hmac.prototype.mac=function(data){if(!this._updated){this.update(data);return this.digest(data)}else{throw new sjcl.exception.invalid("encrypt on already updated hmac called!")}};sjcl.misc.hmac.prototype.reset=function(){this._resultHash=new this._hash(this._baseHash[0]);this._updated=false};sjcl.misc.hmac.prototype.update=function(data){this._updated=true;this._resultHash.update(data)};sjcl.misc.hmac.prototype.digest=function(){var w=this._resultHash.finalize(),result=new this._hash(this._baseHash[1]).update(w).finalize();this.reset();return result};sjcl.misc.pbkdf2=function(password,salt,count,length,Prff){count=count||1e4;if(length<0||count<0){throw new sjcl.exception.invalid("invalid params to pbkdf2")}if(typeof password==="string"){password=sjcl.codec.utf8String.toBits(password)}if(typeof salt==="string"){salt=sjcl.codec.utf8String.toBits(salt)}Prff=Prff||sjcl.misc.hmac;var prf=new Prff(password),u,ui,i,j,k,out=[],b=sjcl.bitArray;for(k=1;32*out.length<(length||1);k++){u=ui=prf.encrypt(b.concat(salt,[k]));for(i=1;i<count;i++){ui=prf.encrypt(ui);for(j=0;j<ui.length;j++){u[j]^=ui[j]}}out=out.concat(u)}if(length){out=b.clamp(out,length)}return out};sjcl.prng=function(defaultParanoia){this._pools=[new sjcl.hash.sha256];this._poolEntropy=[0];this._reseedCount=0;this._robins={};this._eventId=0;this._collectorIds={};this._collectorIdNext=0;this._strength=0;this._poolStrength=0;this._nextReseed=0;this._key=[0,0,0,0,0,0,0,0];this._counter=[0,0,0,0];this._cipher=undefined;this._defaultParanoia=defaultParanoia;this._collectorsStarted=false;this._callbacks={progress:{},seeded:{}};this._callbackI=0;this._NOT_READY=0;this._READY=1;this._REQUIRES_RESEED=2;this._MAX_WORDS_PER_BURST=65536;this._PARANOIA_LEVELS=[0,48,64,96,128,192,256,384,512,768,1024];this._MILLISECONDS_PER_RESEED=3e4;this._BITS_PER_RESEED=80};sjcl.prng.prototype={randomWords:function(nwords,paranoia){var out=[],i,readiness=this.isReady(paranoia),g;if(readiness===this._NOT_READY){throw new sjcl.exception.notReady("generator isn't seeded")}else if(readiness&this._REQUIRES_RESEED){this._reseedFromPools(!(readiness&this._READY))}for(i=0;i<nwords;i+=4){if((i+1)%this._MAX_WORDS_PER_BURST===0){this._gate()}g=this._gen4words();out.push(g[0],g[1],g[2],g[3])}this._gate();return out.slice(0,nwords)},setDefaultParanoia:function(paranoia,allowZeroParanoia){if(paranoia===0&&allowZeroParanoia!=="Setting paranoia=0 will ruin your security; use it only for testing"){throw new sjcl.exception.invalid("Setting paranoia=0 will ruin your security; use it only for testing")}this._defaultParanoia=paranoia},addEntropy:function(data,estimatedEntropy,source){source=source||"user";var id,i,tmp,t=(new Date).valueOf(),robin=this._robins[source],oldReady=this.isReady(),err=0,objName;id=this._collectorIds[source];if(id===undefined){id=this._collectorIds[source]=this._collectorIdNext++}if(robin===undefined){robin=this._robins[source]=0}this._robins[source]=(this._robins[source]+1)%this._pools.length;switch(typeof data){case"number":if(estimatedEntropy===undefined){estimatedEntropy=1}this._pools[robin].update([id,this._eventId++,1,estimatedEntropy,t,1,data|0]);break;case"object":objName=Object.prototype.toString.call(data);if(objName==="[object Uint32Array]"){tmp=[];for(i=0;i<data.length;i++){tmp.push(data[i])}data=tmp}else{if(objName!=="[object Array]"){err=1}for(i=0;i<data.length&&!err;i++){if(typeof data[i]!=="number"){err=1}}}if(!err){if(estimatedEntropy===undefined){estimatedEntropy=0;for(i=0;i<data.length;i++){tmp=data[i];while(tmp>0){estimatedEntropy++;tmp=tmp>>>1}}}this._pools[robin].update([id,this._eventId++,2,estimatedEntropy,t,data.length].concat(data))}break;case"string":if(estimatedEntropy===undefined){estimatedEntropy=data.length}this._pools[robin].update([id,this._eventId++,3,estimatedEntropy,t,data.length]);this._pools[robin].update(data);break;default:err=1}if(err){throw new sjcl.exception.bug("random: addEntropy only supports number, array of numbers or string")}this._poolEntropy[robin]+=estimatedEntropy;this._poolStrength+=estimatedEntropy;if(oldReady===this._NOT_READY){if(this.isReady()!==this._NOT_READY){this._fireEvent("seeded",Math.max(this._strength,this._poolStrength))}this._fireEvent("progress",this.getProgress())}},isReady:function(paranoia){var entropyRequired=this._PARANOIA_LEVELS[paranoia!==undefined?paranoia:this._defaultParanoia];if(this._strength&&this._strength>=entropyRequired){return this._poolEntropy[0]>this._BITS_PER_RESEED&&(new Date).valueOf()>this._nextReseed?this._REQUIRES_RESEED|this._READY:this._READY}else{return this._poolStrength>=entropyRequired?this._REQUIRES_RESEED|this._NOT_READY:this._NOT_READY}},getProgress:function(paranoia){var entropyRequired=this._PARANOIA_LEVELS[paranoia?paranoia:this._defaultParanoia];if(this._strength>=entropyRequired){return 1}else{return this._poolStrength>entropyRequired?1:this._poolStrength/entropyRequired}},startCollectors:function(){if(this._collectorsStarted){return}this._eventListener={loadTimeCollector:this._bind(this._loadTimeCollector),mouseCollector:this._bind(this._mouseCollector),keyboardCollector:this._bind(this._keyboardCollector),accelerometerCollector:this._bind(this._accelerometerCollector),touchCollector:this._bind(this._touchCollector)};if(window.addEventListener){window.addEventListener("load",this._eventListener.loadTimeCollector,false);window.addEventListener("mousemove",this._eventListener.mouseCollector,false);window.addEventListener("keypress",this._eventListener.keyboardCollector,false);window.addEventListener("devicemotion",this._eventListener.accelerometerCollector,false);window.addEventListener("touchmove",this._eventListener.touchCollector,false)}else if(document.attachEvent){document.attachEvent("onload",this._eventListener.loadTimeCollector);document.attachEvent("onmousemove",this._eventListener.mouseCollector);document.attachEvent("keypress",this._eventListener.keyboardCollector)}else{throw new sjcl.exception.bug("can't attach event")}this._collectorsStarted=true},stopCollectors:function(){if(!this._collectorsStarted){return}if(window.removeEventListener){window.removeEventListener("load",this._eventListener.loadTimeCollector,false);window.removeEventListener("mousemove",this._eventListener.mouseCollector,false);window.removeEventListener("keypress",this._eventListener.keyboardCollector,false);window.removeEventListener("devicemotion",this._eventListener.accelerometerCollector,false);window.removeEventListener("touchmove",this._eventListener.touchCollector,false)}else if(document.detachEvent){document.detachEvent("onload",this._eventListener.loadTimeCollector);document.detachEvent("onmousemove",this._eventListener.mouseCollector);document.detachEvent("keypress",this._eventListener.keyboardCollector)}this._collectorsStarted=false},addEventListener:function(name,callback){this._callbacks[name][this._callbackI++]=callback},removeEventListener:function(name,cb){var i,j,cbs=this._callbacks[name],jsTemp=[];for(j in cbs){if(cbs.hasOwnProperty(j)&&cbs[j]===cb){jsTemp.push(j)}}for(i=0;i<jsTemp.length;i++){j=jsTemp[i];delete cbs[j]}},_bind:function(func){var that=this;return function(){func.apply(that,arguments)}},_gen4words:function(){for(var i=0;i<4;i++){this._counter[i]=this._counter[i]+1|0;if(this._counter[i]){break}}return this._cipher.encrypt(this._counter)},_gate:function(){this._key=this._gen4words().concat(this._gen4words());this._cipher=new sjcl.cipher.aes(this._key)},_reseed:function(seedWords){this._key=sjcl.hash.sha256.hash(this._key.concat(seedWords));this._cipher=new sjcl.cipher.aes(this._key);for(var i=0;i<4;i++){this._counter[i]=this._counter[i]+1|0;if(this._counter[i]){break}}},_reseedFromPools:function(full){var reseedData=[],strength=0,i;this._nextReseed=reseedData[0]=(new Date).valueOf()+this._MILLISECONDS_PER_RESEED;for(i=0;i<16;i++){reseedData.push(Math.random()*4294967296|0)}for(i=0;i<this._pools.length;i++){reseedData=reseedData.concat(this._pools[i].finalize());strength+=this._poolEntropy[i];this._poolEntropy[i]=0;if(!full&&this._reseedCount&1<<i){break}}if(this._reseedCount>=1<<this._pools.length){this._pools.push(new sjcl.hash.sha256);this._poolEntropy.push(0)}this._poolStrength-=strength;if(strength>this._strength){this._strength=strength}this._reseedCount++;this._reseed(reseedData)},_keyboardCollector:function(){this._addCurrentTimeToEntropy(1)},_mouseCollector:function(ev){var x,y;try{x=ev.x||ev.clientX||ev.offsetX||0;y=ev.y||ev.clientY||ev.offsetY||0}catch(err){x=0;y=0}if(x!=0&&y!=0){this.addEntropy([x,y],2,"mouse")}this._addCurrentTimeToEntropy(0)},_touchCollector:function(ev){var touch=ev.touches[0]||ev.changedTouches[0];var x=touch.pageX||touch.clientX,y=touch.pageY||touch.clientY;this.addEntropy([x,y],1,"touch");this._addCurrentTimeToEntropy(0)},_loadTimeCollector:function(){this._addCurrentTimeToEntropy(2)},_addCurrentTimeToEntropy:function(estimatedEntropy){if(typeof window!=="undefined"&&window.performance&&typeof window.performance.now==="function"){this.addEntropy(window.performance.now(),estimatedEntropy,"loadtime")}else{this.addEntropy((new Date).valueOf(),estimatedEntropy,"loadtime")}},_accelerometerCollector:function(ev){var ac=ev.accelerationIncludingGravity.x||ev.accelerationIncludingGravity.y||ev.accelerationIncludingGravity.z;if(window.orientation){var or=window.orientation;if(typeof or==="number"){this.addEntropy(or,1,"accelerometer")}}if(ac){this.addEntropy(ac,2,"accelerometer")}this._addCurrentTimeToEntropy(0)},_fireEvent:function(name,arg){var j,cbs=sjcl.random._callbacks[name],cbsTemp=[];for(j in cbs){if(cbs.hasOwnProperty(j)){cbsTemp.push(cbs[j])}}for(j=0;j<cbsTemp.length;j++){cbsTemp[j](arg)}}};sjcl.random=new sjcl.prng(6);(function(){function getCryptoModule(){try{return require("crypto")}catch(e){return null}}try{var buf,crypt,ab;if(typeof module!=="undefined"&&module.exports&&(crypt=getCryptoModule())&&crypt.randomBytes){buf=crypt.randomBytes(1024/8);buf=new Uint32Array(new Uint8Array(buf).buffer);sjcl.random.addEntropy(buf,1024,"crypto.randomBytes")}else if(typeof window!=="undefined"&&typeof Uint32Array!=="undefined"){ab=new Uint32Array(32);if(window.crypto&&window.crypto.getRandomValues){window.crypto.getRandomValues(ab)}else if(window.msCrypto&&window.msCrypto.getRandomValues){window.msCrypto.getRandomValues(ab)}else{return}sjcl.random.addEntropy(ab,1024,"crypto.getRandomValues")}else{}}catch(e){if(typeof window!=="undefined"&&window.console){console.log("There was an error collecting entropy from the browser:");console.log(e)}}})();sjcl.json={defaults:{v:1,iter:1e4,ks:128,ts:64,mode:"ccm",adata:"",cipher:"aes"},_encrypt:function(password,plaintext,params,rp){params=params||{};rp=rp||{};var j=sjcl.json,p=j._add({iv:sjcl.random.randomWords(4,0)},j.defaults),tmp,prp,adata;j._add(p,params);adata=p.adata;if(typeof p.salt==="string"){p.salt=sjcl.codec.base64.toBits(p.salt)}if(typeof p.iv==="string"){p.iv=sjcl.codec.base64.toBits(p.iv)}if(!sjcl.mode[p.mode]||!sjcl.cipher[p.cipher]||typeof password==="string"&&p.iter<=100||p.ts!==64&&p.ts!==96&&p.ts!==128||p.ks!==128&&p.ks!==192&&p.ks!==256||(p.iv.length<2||p.iv.length>4)){throw new sjcl.exception.invalid("json encrypt: invalid parameters")}if(typeof password==="string"){tmp=sjcl.misc.cachedPbkdf2(password,p);password=tmp.key.slice(0,p.ks/32);p.salt=tmp.salt}else if(sjcl.ecc&&password instanceof sjcl.ecc.elGamal.publicKey){tmp=password.kem();p.kemtag=tmp.tag;password=tmp.key.slice(0,p.ks/32)}if(typeof plaintext==="string"){plaintext=sjcl.codec.utf8String.toBits(plaintext)}if(typeof adata==="string"){p.adata=adata=sjcl.codec.utf8String.toBits(adata)}prp=new sjcl.cipher[p.cipher](password);j._add(rp,p);rp.key=password;if(p.mode==="ccm"&&sjcl.arrayBuffer&&sjcl.arrayBuffer.ccm&&plaintext instanceof ArrayBuffer){p.ct=sjcl.arrayBuffer.ccm.encrypt(prp,plaintext,p.iv,adata,p.ts)}else{p.ct=sjcl.mode[p.mode].encrypt(prp,plaintext,p.iv,adata,p.ts)}return p},encrypt:function(password,plaintext,params,rp){var j=sjcl.json,p=j._encrypt.apply(j,arguments);return j.encode(p)},_decrypt:function(password,ciphertext,params,rp){params=params||{};rp=rp||{};var j=sjcl.json,p=j._add(j._add(j._add({},j.defaults),ciphertext),params,true),ct,tmp,prp,adata=p.adata;if(typeof p.salt==="string"){p.salt=sjcl.codec.base64.toBits(p.salt)}if(typeof p.iv==="string"){p.iv=sjcl.codec.base64.toBits(p.iv)}if(!sjcl.mode[p.mode]||!sjcl.cipher[p.cipher]||typeof password==="string"&&p.iter<=100||p.ts!==64&&p.ts!==96&&p.ts!==128||p.ks!==128&&p.ks!==192&&p.ks!==256||!p.iv||(p.iv.length<2||p.iv.length>4)){throw new sjcl.exception.invalid("json decrypt: invalid parameters")}if(typeof password==="string"){tmp=sjcl.misc.cachedPbkdf2(password,p);password=tmp.key.slice(0,p.ks/32);p.salt=tmp.salt}else if(sjcl.ecc&&password instanceof sjcl.ecc.elGamal.secretKey){password=password.unkem(sjcl.codec.base64.toBits(p.kemtag)).slice(0,p.ks/32)}if(typeof adata==="string"){adata=sjcl.codec.utf8String.toBits(adata)}prp=new sjcl.cipher[p.cipher](password);if(p.mode==="ccm"&&sjcl.arrayBuffer&&sjcl.arrayBuffer.ccm&&p.ct instanceof ArrayBuffer){ct=sjcl.arrayBuffer.ccm.decrypt(prp,p.ct,p.iv,p.tag,adata,p.ts)}else{ct=sjcl.mode[p.mode].decrypt(prp,p.ct,p.iv,adata,p.ts)}j._add(rp,p);rp.key=password;if(params.raw===1){return ct}else{return sjcl.codec.utf8String.fromBits(ct)}},decrypt:function(password,ciphertext,params,rp){var j=sjcl.json;return j._decrypt(password,j.decode(ciphertext),params,rp)},encode:function(obj){var i,out="{",comma="";for(i in obj){if(obj.hasOwnProperty(i)){if(!i.match(/^[a-z0-9]+$/i)){throw new sjcl.exception.invalid("json encode: invalid property name")}out+=comma+'"'+i+'":';comma=",";switch(typeof obj[i]){case"number":case"boolean":out+=obj[i];break;case"string":out+='"'+escape(obj[i])+'"';break;case"object":out+='"'+sjcl.codec.base64.fromBits(obj[i],0)+'"';break;default:throw new sjcl.exception.bug("json encode: unsupported type")}}}return out+"}"},decode:function(str){str=str.replace(/\\s/g,"");if(!str.match(/^\\{.*}$/)){throw new sjcl.exception.invalid("json decode: this isn't json!")}var a=str.replace(/^\\{|}$/g,"").split(/,/),out={},i,m;for(i=0;i<a.length;i++){if(!(m=a[i].match(/^\\s*(?:(["']?)([a-z][a-z0-9]*)\\1)\\s*:\\s*(?:(-?\\d+)|"([a-z0-9+\\/%*_.@=\\-]*)"|(true|false))$/i))){throw new sjcl.exception.invalid("json decode: this isn't json!")}if(m[3]!=null){out[m[2]]=parseInt(m[3],10)}else if(m[4]!=null){out[m[2]]=m[2].match(/^(ct|adata|salt|iv)$/)?sjcl.codec.base64.toBits(m[4]):unescape(m[4])}else if(m[5]!=null){out[m[2]]=m[5]==="true"}}return out},_add:function(target,src,requireSame){if(target===undefined){target={}}if(src===undefined){return target}var i;for(i in src){if(src.hasOwnProperty(i)){if(requireSame&&target[i]!==undefined&&target[i]!==src[i]){throw new sjcl.exception.invalid("required parameter overridden")}target[i]=src[i]}}return target},_subtract:function(plus,minus){var out={},i;for(i in plus){if(plus.hasOwnProperty(i)&&plus[i]!==minus[i]){out[i]=plus[i]}}return out},_filter:function(src,filter){var out={},i;for(i=0;i<filter.length;i++){if(src[filter[i]]!==undefined){out[filter[i]]=src[filter[i]]}}return out}};sjcl.encrypt=sjcl.json.encrypt;sjcl.decrypt=sjcl.json.decrypt;sjcl.misc._pbkdf2Cache={};sjcl.misc.cachedPbkdf2=function(password,obj){var cache=sjcl.misc._pbkdf2Cache,c,cp,str,salt,iter;obj=obj||{};iter=obj.iter||1e3;cp=cache[password]=cache[password]||{};c=cp[iter]=cp[iter]||{firstSalt:obj.salt&&obj.salt.length?obj.salt.slice(0):sjcl.random.randomWords(2,0)};salt=obj.salt===undefined?c.firstSalt:obj.salt;c[salt]=c[salt]||sjcl.misc.pbkdf2(password,salt,obj.iter);return{key:c[salt].slice(0),salt:salt.slice(0)}};if(typeof module!=="undefined"&&module.exports){module.exports=sjcl}if(typeof define==="function"){define([],function(){return sjcl})}
    var Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(input){var output="";var chr1,chr2,chr3,enc1,enc2,enc3,enc4;var i=0;input=Base64._utf8_encode(input);while(i<input.length){chr1=input.charCodeAt(i++);chr2=input.charCodeAt(i++);chr3=input.charCodeAt(i++);enc1=chr1>>2;enc2=(chr1&3)<<4|chr2>>4;enc3=(chr2&15)<<2|chr3>>6;enc4=chr3&63;if(isNaN(chr2)){enc3=enc4=64}else if(isNaN(chr3)){enc4=64}output=output+this._keyStr.charAt(enc1)+this._keyStr.charAt(enc2)+this._keyStr.charAt(enc3)+this._keyStr.charAt(enc4)}return output},decode:function(input){var output="";var chr1,chr2,chr3;var enc1,enc2,enc3,enc4;var i=0;input=input.replace(/[^A-Za-z0-9\\+\\/\\=]/g,"");while(i<input.length){enc1=this._keyStr.indexOf(input.charAt(i++));enc2=this._keyStr.indexOf(input.charAt(i++));enc3=this._keyStr.indexOf(input.charAt(i++));enc4=this._keyStr.indexOf(input.charAt(i++));chr1=enc1<<2|enc2>>4;chr2=(enc2&15)<<4|enc3>>2;chr3=(enc3&3)<<6|enc4;output=output+String.fromCharCode(chr1);if(enc3!=64){output=output+String.fromCharCode(chr2)}if(enc4!=64){output=output+String.fromCharCode(chr3)}}output=Base64._utf8_decode(output);return output},_utf8_encode:function(string){string=string.replace(/\\r\\n/g,"\\n");var utftext="";for(var n=0;n<string.length;n++){var c=string.charCodeAt(n);if(c<128){utftext+=String.fromCharCode(c)}else if(c>127&&c<2048){utftext+=String.fromCharCode(c>>6|192);utftext+=String.fromCharCode(c&63|128)}else{utftext+=String.fromCharCode(c>>12|224);utftext+=String.fromCharCode(c>>6&63|128);utftext+=String.fromCharCode(c&63|128)}}return utftext},_utf8_decode:function(utftext){var string="";var i=0;var c=c1=c2=0;while(i<utftext.length){c=utftext.charCodeAt(i);if(c<128){string+=String.fromCharCode(c);i++}else if(c>191&&c<224){c2=utftext.charCodeAt(i+1);string+=String.fromCharCode((c&31)<<6|c2&63);i+=2}else{c2=utftext.charCodeAt(i+1);c3=utftext.charCodeAt(i+2);string+=String.fromCharCode((c&15)<<12|(c2&63)<<6|c3&63);i+=3}}return string}};

      logger.message("Collect And Encrypt Custom Password: start");
    outcome = "true";
  
    /* Begin Configuration */
      
      // Attribute name
      var idmAttrName = "frUnindexedString2"; // AM: "fr-attr-str2"
      
      // Pick a shared secret to use for encryption and decryption
    var sharedSecret = "RainbowPoniesHaveNoStripes";

      // Fine-tune encryption settings. Default iterations are 10k, to speed up the process, it's reduced to 1k here.
      var encryptionParameters = { "iter" : 1000 };
      
    // Build out the password prompt
    var prompt = "Replay Password";

    /* End Configuration */
  
    var fr = JavaImporter(
        org.forgerock.openam.auth.node.api.Action,
        javax.security.auth.callback.PasswordCallback,
          java.lang.String
    )
    
    if (callbacks.isEmpty()) {
        action = fr.Action.send(
          new fr.PasswordCallback(prompt, false)
        ).build();
    } 
    else {
          // PasswordCallback returns the password as a char[], which is not the same as a JS char array. It must be converted to a proper string using the java.lang.Sting.valueOf(char[]) method.
        var password = new String(fr.String.valueOf(callbacks.get(0).getPassword()));
        logger.message("Collect And Encrypt Custom Password: callbacks received");

          /*
        var cipherPasswordJson = sjcl.encrypt(sharedSecret, password, encryptionParameters);
        //setSharedObjectAttribute(idmAttrName, Base64.encode(JSON.stringify(cipherPasswordJson)));
        setSharedObjectAttribute(idmAttrName, JSON.stringify(cipherPasswordJson));
        logger.message("Collect And Encrypt Custom Password: cipherPasswordJson="+JSON.stringify(cipherPasswordJson));
        */
      
        logger.message("Collect And Encrypt Custom Password: password="+Base64.encode(password));
        setSharedObjectAttribute(idmAttrName, Base64.encode(password));

        logger.message("Collect And Encrypt Custom Password: finish [outcome=".concat(outcome).concat("]"));
        action = fr.Action.goTo(outcome).build();
    }

    /*
     * Store attributes in shared state for use with the Create/Patch Object nodes.
     */
    function setSharedObjectAttribute(name, value) {
        var storage = sharedState.get("objectAttributes");
        if (storage && value) {
            if (storage.put) {
                  storage.put(name, value);
            }
            else {
                storage[name] = value;
            }
        }
        else if (value) {
              var object = {
                  name: value
            };
            sharedState.put("objectAttributes", object);
            //sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));
        }
    }
}());
/* SJCL is open. You can use, modify and redistribute it under a BSD
license or under the GNU GPL, version 2.0.

---------------------------------------------------------------------

http://opensource.org/licenses/BSD-2-Clause

Copyright (c) 2009-2015, Emily Stark, Mike Hamburg and Dan Boneh at
Stanford University. All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are
met:

1. Redistributions of source code must retain the above copyright
notice, this list of conditions and the following disclaimer.

2. Redistributions in binary form must reproduce the above copyright
notice, this list of conditions and the following disclaimer in the
documentation and/or other materials provided with the distribution.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS
IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED
TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A
PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

---------------------------------------------------------------------

http://opensource.org/licenses/GPL-2.0

The Stanford Javascript Crypto Library (hosted here on GitHub) is a
project by the Stanford Computer Security Lab to build a secure,
powerful, fast, small, easy-to-use, cross-browser library for
cryptography in Javascript.

Copyright (c) 2009-2015, Emily Stark, Mike Hamburg and Dan Boneh at
Stanford University.

This program is free software; you can redistribute it and/or modify it
under the terms of the GNU General Public License as published by the
Free Software Foundation; either version 2 of the License, or (at your
option) any later version.

This program is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General
Public License for more details.

You should have received a copy of the GNU General Public License along
with this program; if not, write to the Free Software Foundation, Inc.,
59 Temple Place, Suite 330, Boston, MA 02111-1307 USA */

/*
 * Base64 encode / decode
 *  http://www.webtoolkit.info/
 * 
 * Example:
 * Base64.encode('some string')
 * Base64.decode('some encoded string')
 */"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Collect-Replay-Password-(frUnindexedString2).script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "d82a4ad6-cd8a-437b-af55-7373e50d685b": {
      "_id": "d82a4ad6-cd8a-437b-af55-7373e50d685b",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Collect Replay Password (frUnindexedString2).",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Collect Replay Password (frUnindexedString2)",
      "script": "file://Collect-Replay-Password-(frUnindexedString2).script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Collect-SAML2-Node-Config.script.js 1`] = `
"/* Collect SAML2 Node Config
 * 
 * Collect all the configuration items required for the SAML2 Node to function properly.
 * 
 * This script does not need to be parametrized. It will work properly as is.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 *
 * Author: volker.scheuber@forgerock.com
 */
(function () {
    outcome = "true";
      var config = {
        "metaAlias": "/iSPAzure",
        "allowCreate": false,
        "sloEnabled": false,
        "authnContextClassRef": [],
        "authnContextDeclRef": [],
        "authComparison": "EXACT",
        "nameIdFormat": "urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified",
        "requestBinding": "HTTP_REDIRECT",
        "binding": "HTTP_POST",
        "forceAuthn": false,
        "idpEntityId": "https://sts.windows.net/711ffa9c-5972-4713-ace3-688c9732614a/",
        "isPassive": false,
        "sloRelayState": ""
    };
      var script = "";
    script += "Array.prototype.slice.call(";
    script += "    document.getElementsByTagName('input')";
    script += ").forEach(";
    script += "    function (input,i) {";
    script += "        console.log('input '+i);"
    script += "        var config = JSON.parse('"+JSON.stringify(config)+"');";
    script += "        var keys = Object.keys(config);";
    script += "        if (input.type === 'text') {";
    script += "            input.setAttribute('value', config[keys[i]]);";
    script += "            input.dispatchEvent(new KeyboardEvent( 'input' , {'key':'Enter'} ));";
    script += "        }";
    script += "    }";
    script += ");";
    var fr = JavaImporter(
        org.forgerock.openam.auth.node.api.Action,
          javax.security.auth.callback.NameCallback,
        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback
    )
    if (callbacks.isEmpty()) {
        action = fr.Action.send(
            new fr.NameCallback("metaAlias"),
            new fr.NameCallback("allowCreate"),
            new fr.NameCallback("sloEnabled"),
            new fr.NameCallback("authnContextClassRef"),
            new fr.NameCallback("authnContextDeclRef"),
            new fr.NameCallback("authComparison"),
            new fr.NameCallback("nameIdFormat"),
            new fr.NameCallback("requestBinding"),
            new fr.NameCallback("binding"),
            new fr.NameCallback("forceAuthn"),
            new fr.NameCallback("idpEntityId"),
            new fr.NameCallback("isPassive"),
            new fr.NameCallback("sloRelayState"),
              new fr.ScriptTextOutputCallback(script)
        ).build();
    }
    else {
          config[callbacks.get(0).getPrompt()] = callbacks.get(0).getName();
          config[callbacks.get(1).getPrompt()] = (callbacks.get(1).getName() === 'true');
          config[callbacks.get(2).getPrompt()] = (callbacks.get(2).getName() === 'true');
          config[callbacks.get(3).getPrompt()] = [callbacks.get(3).getName()];
          config[callbacks.get(4).getPrompt()] = [callbacks.get(4).getName()];
          config[callbacks.get(5).getPrompt()] = callbacks.get(5).getName();
          config[callbacks.get(6).getPrompt()] = callbacks.get(6).getName();
          config[callbacks.get(7).getPrompt()] = callbacks.get(7).getName();
          config[callbacks.get(8).getPrompt()] = callbacks.get(8).getName();
          config[callbacks.get(9).getPrompt()] = (callbacks.get(9).getName() === 'true');
          config[callbacks.get(10).getPrompt()] = callbacks.get(10).getName();
          config[callbacks.get(11).getPrompt()] = (callbacks.get(11).getName() === 'true');
          config[callbacks.get(12).getPrompt()] = callbacks.get(12).getName();
          nodeState.putShared("nodeConfig", config);
        action = fr.Action.goTo(outcome).build();
    }
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Collect-SAML2-Node-Config.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "48f17202-039f-4d40-b7fc-4ce380f1b929": {
      "_id": "48f17202-039f-4d40-b7fc-4ce380f1b929",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Collect all the configuration items required for the SAML2 Node to function properly.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Collect SAML2 Node Config",
      "script": "file://Collect-SAML2-Node-Config.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Collect-Set-Custom-Cookie-Node-Config.script.js 1`] = `
"/* Collect Set Custom Cookie Node Config
 * 
 * Collect all the configuration items required for the Set Custom Cookie node to function properly.
 * 
 * This script does not need to be parametrized. It will work properly as is.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 *
 * Author: volker.scheuber@forgerock.com
 */
(function () {
    outcome = "true";
      var config = {
        "name": "oreo",
        "value": "original",
        "domain": ".scheuber.io",
        "path": "/",
        "maxAge": 3600,
        "useHttpOnlyCookie": true,
        "useSecureCookie": true,
        "sameSite": "NONE"
    };
  
      var script = "";
    script += "Array.prototype.slice.call(";
    script += "    document.getElementsByTagName('input')";
    script += ").forEach(";
    script += "    function (input,i) {";
    script += "        console.log('input '+i);"
    script += "        var config = JSON.parse('"+JSON.stringify(config)+"');";
    script += "        var keys = Object.keys(config);";
    script += "        if (input.type === 'text') {";
    script += "            input.setAttribute('value', config[keys[i]]);";
    script += "            input.dispatchEvent(new KeyboardEvent( 'input' , {'key':'Enter'} ));";
    script += "        }";
    script += "    }";
    script += ");";
    var fr = JavaImporter(
        org.forgerock.openam.auth.node.api.Action,
          javax.security.auth.callback.NameCallback,
        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback
    )
    if (callbacks.isEmpty()) {
        action = fr.Action.send(
            new fr.NameCallback("name"),
            new fr.NameCallback("value"),
            new fr.NameCallback("domain"),
            new fr.NameCallback("path"),
            new fr.NameCallback("maxAge"),
            new fr.NameCallback("useHttpOnlyCookie"),
            new fr.NameCallback("useSecureCookie"),
            new fr.NameCallback("sameSite"),
              new fr.ScriptTextOutputCallback(script)
        ).build();
    }
    else {
          config[callbacks.get(0).getPrompt()] = callbacks.get(0).getName();
          config[callbacks.get(1).getPrompt()] = callbacks.get(1).getName();
          config[callbacks.get(2).getPrompt()] = callbacks.get(2).getName();
          config[callbacks.get(3).getPrompt()] = callbacks.get(3).getName();
          config[callbacks.get(4).getPrompt()] = parseInt(callbacks.get(4).getName(), 10).toFixed();
          config[callbacks.get(5).getPrompt()] = (""+callbacks.get(5).getName() === 'true');
          config[callbacks.get(6).getPrompt()] = (""+callbacks.get(6).getName() === 'true');
          config[callbacks.get(7).getPrompt()] = callbacks.get(7).getName();
          nodeState.putShared("nodeConfig", config);
        action = fr.Action.goTo(outcome).build();
    }
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Collect-Set-Custom-Cookie-Node-Config.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "a31a1796-8410-46b8-82ca-eb0c6e901775": {
      "_id": "a31a1796-8410-46b8-82ca-eb0c6e901775",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Collect all the configuration items required for the Set Custom Cookie node to function properly.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Collect Set Custom Cookie Node Config",
      "script": "file://Collect-Set-Custom-Cookie-Node-Config.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Config-Provider.script.js 1`] = `
"/*
 * Copyright 2021 ForgeRock AS. All Rights Reserved
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

/**
 * The following script is a simplified template for understanding how to build
 * up a config Map object with custom values. The Config Provider Node will then
 * provide this config Map to the desired node type. It is important that the Map
 * you build here is named 'config'.
 *
 * Defined variables:
 *
 * nodeState - Node State (1)
 *           Always present, this represents the current values stored in the node state.
 *
 * idRepository - Profile Data (2)
 *           Always present, a repository to retrieve user information.
 *
 * secrets - Credentials and Secrets (3)
 *           Always present, an interface to access the Secrets API from a scripting context.
 *
 * requestHeaders (4) - Map (5)
 *           Always present, an object that provides methods for accessing headers in the login request.
 *
 * logger - Debug Logging (6)
 *          Always present, the debug logger instance.
 *
 * httpClient - HTTP Client (7)
 *          Always present, the HTTP client that can be used to make external HTTP requests.
 *
 * realm - String (primitive).
 *          Always present, the name of the realm the user is authenticating to.
 *
 * existingSession - Map<String, String> (5)
 *          Present if the request contains the session cookie, the user's session object. The returned map from
 *          SSOToken.getProperties() (8)
 *
 * requestParameters - Map (5)
 *          Always present, the object that contains the authentication request parameters.
 *
 *
 * Outputs:
 *
 * config - Map (5)
 *           Define and fill a Map object named 'config' with custom values, this will define the configuration for the
 *           associated node selected in the ConfigProviderNode.
 *
 * Reference:
 * (1) Node State - https://backstage.forgerock.com/docs/idcloud-am/latest/authentication-guide/scripting-api-node.html#scripting-api-node-nodeState
 * (2) Profile Data - https://backstage.forgerock.com/docs/am/7.1/authentication-guide/scripting-api-node.html#scripting-api-node-id-repo
 * (3) Credentials and Secrets - https://backstage.forgerock.com/docs/am/7.1/authentication-guide/scripting-api-node.html#scripting-api-authn-secrets
 * (4) Request Headers - https://backstage.forgerock.com/docs/am/7/authentication-guide/scripting-api-node.html#scripting-api-node-requestHeaders.
 * (5) Map - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/Map.html
 * (6) Debug Logging - https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.
 * (7) HTTP Client - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/http/Client.html.
 * (8) SSOToken - https://backstage.forgerock.com/docs/am/7/apidocs/com/iplanet/sso/SSOToken.html.
 */

config = nodeState.get('nodeConfig').asMap();"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Config-Provider.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "5e854779-6ec1-4c39-aeba-0477e0986646": {
      "_id": "5e854779-6ec1-4c39-aeba-0477e0986646",
      "context": "CONFIG_PROVIDER_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Default global script for Config Provider",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Config Provider",
      "script": "file://Config-Provider.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Configure-Email-Template-Node.script.js 1`] = `
"/* Configure Email Template Node
 * 
 * Create a configuration object for the Email Template Node.
 * 
 * This script does not need to be parametrized. It will work properly as is.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 * - error
 *
 * Author: volker.scheuber@forgerock.com
 */
(function () {
  try {
  outcome = 'true';
  var config = {
    emailAttribute: 'mail',
    emailTemplateName: 'welcome',
    identityAttribute: 'userName'
  };
  nodeState.putShared('nodeConfig', config);
  } catch (error) {
      outcome = 'error';
    nodeState.putShared('error', error.message);
  }
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Configure-Email-Template-Node.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "22ab12ac-d1d9-414b-ab51-cfae30de8c0a": {
      "_id": "22ab12ac-d1d9-414b-ab51-cfae30de8c0a",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Create a configuration object for the Email Template Node.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Configure Email Template Node",
      "script": "file://Configure-Email-Template-Node.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Copy-to-transientState.script.js 1`] = `
"outcome = "true";
if (sharedState.get("objectAttributes")) {
    transientState.put("objectAttributes", sharedState.get("objectAttributes"))
}
if (sharedState.get("username")) {
    transientState.put("username", sharedState.get("username"))
}
if (sharedState.get("_id")) {
    transientState.put("_id", sharedState.get("_id"))
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Copy-to-transientState.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "452d73ee-c6f3-4f4e-9dae-e75bb3886cbd": {
      "_id": "452d73ee-c6f3-4f4e-9dae-e75bb3886cbd",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Copy sharedState to transientState",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Copy to transientState",
      "script": "file://Copy-to-transientState.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./CopyIDToObjectAttributes.script.js 1`] = `
"/*
  - Data made available by nodes that have already executed are available in the sharedState variable.
  - The script should set outcome to either "true" or "false".
 */

sharedState.get("objectAttributes").put("_id", sharedState.get("_id"));

outcome = "true";"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./CopyIDToObjectAttributes.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "c253a7ac-ebc9-4268-9e62-89f38f98e4ab": {
      "_id": "c253a7ac-ebc9-4268-9e62-89f38f98e4ab",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "CopyIDToObjectAttributes",
      "script": "file://CopyIDToObjectAttributes.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./CopyOTPToObjectAttributes.script.js 1`] = `
"/* CopyOTPToObjectAttributes
 *
 * Author: volker.scheuber@forgerock.com
 * 
 * Copy an OTP generated by the "HOTP Generator" node to the IDM profile 
 * shared state so it can be patched to the user profile.
 * 
 * This script does not need to be parametrized. It will work properly as is.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 */
if (sharedState.get("objectAttributes")) {
    sharedState.get("objectAttributes").put("description", sharedState.get("oneTimePassword"))
}
else {
    sharedState.put("objectAttributes", {description: sharedState.get("oneTimePassword")});
}
outcome = "true";"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./CopyOTPToObjectAttributes.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "5561a45f-bf00-4ec5-bab4-f069bac9a38b": {
      "_id": "5561a45f-bf00-4ec5-bab4-f069bac9a38b",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Copy an OTP generated by the "HOTP Generator" node to the IDM profile shared state so it can be patched to the user profile.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "CopyOTPToObjectAttributes",
      "script": "file://CopyOTPToObjectAttributes.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./CopySAMLDataToObjectAttributes.script.js 1`] = `
"/* CopySAMLDataToObjectAttributes
 *
 * Author: volker.scheuber@forgerock.com
 * 
 * Copy SAML Data To ObjectAttributes.
 * 
 * This script does not need to be parametrized. It will work properly as is.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 */
outcome = "true";
if (sharedState.get("userInfo")) {
    if (sharedState.get("objectAttributes")) {
          sharedState.remove("objectAttributes");
    }
    var userName=null,givenName=null,sn=null,mail=null,telephoneNumber=null,roles=null;

    try { userName=sharedState.get("userInfo").get("userNames").get("uid").get(0).toString(); } catch (e) {}
    try { givenName=sharedState.get("userInfo").get("attributes").get("givenName").get(0).toString(); } catch (e) {}
    try { sn=sharedState.get("userInfo").get("attributes").get("sn").get(0).toString(); } catch (e) {}
    try { mail=sharedState.get("userInfo").get("attributes").get("mail").get(0).toString(); } catch (e) {}
    try { telephoneNumber=sharedState.get("userInfo").get("attributes").get("telephoneNumber").get(0).toString(); } catch (e) {}
    //try { roles=sharedState.get("userInfo").get("attributes").get("roles").get(0).toString(); } catch (e) {}
    try { roles=sharedState.get("userInfo").get("attributes").get("roles").toArray().join("|"); } catch (e) {}

    sharedState.put("objectAttributes", {"userName":userName,"givenName":givenName,"sn":sn,"mail":mail,"telephoneNumber":telephoneNumber,"roles":roles});
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./CopySAMLDataToObjectAttributes.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "8e03eb43-ed5d-4c12-9e15-2051cc9be578": {
      "_id": "8e03eb43-ed5d-4c12-9e15-2051cc9be578",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Copy SAML Data To ObjectAttributes",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "CopySAMLDataToObjectAttributes",
      "script": "file://CopySAMLDataToObjectAttributes.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Device-Id-(Match)-Client-Side.script.js 1`] = `
"var fontDetector = (function () {
    /**
     * JavaScript code to detect available availability of a
     * particular font in a browser using JavaScript and CSS.
     *
     * Author : Lalit Patel
     * Website: http://www.lalit.org/lab/javascript-css-font-detect/
     * License: Apache Software License 2.0
     *          http://www.apache.org/licenses/LICENSE-2.0
     * Version: 0.15 (21 Sep 2009)
     *          Changed comparision font to default from sans-default-default,
     *          as in FF3.0 font of child element didn't fallback
     *          to parent element if the font is missing.
     * Version: 0.2 (04 Mar 2012)
     *          Comparing font against all the 3 generic font families ie,
     *          'monospace', 'sans-serif' and 'sans'. If it doesn't match all 3
     *          then that font is 100% not available in the system
     * Version: 0.3 (24 Mar 2012)
     *          Replaced sans with serif in the list of baseFonts
     */
    /*
     * Portions Copyrighted 2013 ForgeRock AS.
     */
    var detector = {}, baseFonts, testString, testSize, h, s, defaultWidth = {}, defaultHeight = {}, index;

    // a font will be compared against all the three default fonts.
    // and if it doesn't match all 3 then that font is not available.
    baseFonts = ['monospace', 'sans-serif', 'serif'];

    //we use m or w because these two characters take up the maximum width.
    // And we use a LLi so that the same matching fonts can get separated
    testString = "mmmmmmmmmmlli";

    //we test using 72px font size, we may use any size. I guess larger the better.
    testSize = '72px';

    h = document.getElementsByTagName("body")[0];

    // create a SPAN in the document to get the width of the text we use to test
    s = document.createElement("span");
    s.style.fontSize = testSize;
    s.innerHTML = testString;
    for (index in baseFonts) {
        //get the default width for the three base fonts
        s.style.fontFamily = baseFonts[index];
        h.appendChild(s);
        defaultWidth[baseFonts[index]] = s.offsetWidth; //width for the default font
        defaultHeight[baseFonts[index]] = s.offsetHeight; //height for the defualt font
        h.removeChild(s);
    }

    detector.detect = function(font) {
        var detected = false, index, matched;
        for (index in baseFonts) {
            s.style.fontFamily = font + ',' + baseFonts[index]; // name of the font along with the base font for fallback.
            h.appendChild(s);
            matched = (s.offsetWidth !== defaultWidth[baseFonts[index]] || s.offsetHeight !== defaultHeight[baseFonts[index]]);
            h.removeChild(s);
            detected = detected || matched;
        }
        return detected;
    };

    return detector;
}());
/*
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS HEADER.
 *
 * Copyright (c) 2009 Sun Microsystems Inc. All Rights Reserved
 *
 * The contents of this file are subject to the terms
 * of the Common Development and Distribution License
 * (the License). You may not use this file except in
 * compliance with the License.
 *
 * You can obtain a copy of the License at
 * https://opensso.dev.java.net/public/CDDLv1.0.html or
 * opensso/legal/CDDLv1.0.txt
 * See the License for the specific language governing
 * permission and limitations under the License.
 *
 * When distributing Covered Code, include this CDDL
 * Header Notice in each file and include the License file
 * at opensso/legal/CDDLv1.0.txt.
 * If applicable, add the following below the CDDL Header,
 * with the fields enclosed by brackets [] replaced by
 * your own identifying information:
 * "Portions Copyrighted [year] [name of copyright owner]"
 *
 */
/*
 * Portions Copyrighted 2013 Syntegrity.
 * Portions Copyrighted 2013-2014 ForgeRock AS.
 */

var collectScreenInfo = function () {
        var screenInfo = {};
        if (screen) {
            if (screen.width) {
                screenInfo.screenWidth = screen.width;
            }

            if (screen.height) {
                screenInfo.screenHeight = screen.height;
            }

            if (screen.pixelDepth) {
                screenInfo.screenColourDepth = screen.pixelDepth;
            }
        } else {
            console.warn("Cannot collect screen information. screen is not defined.");
        }
        return screenInfo;
    },
    collectTimezoneInfo = function () {
        var timezoneInfo =  {}, offset = new Date().getTimezoneOffset();

        if (offset) {
            timezoneInfo.timezone = offset;
        } else {
            console.warn("Cannot collect timezone information. timezone is not defined.");
        }

        return timezoneInfo;
    },
    collectBrowserPluginsInfo = function () {

        if (navigator && navigator.plugins) {
            var pluginsInfo = {}, i, plugins = navigator.plugins;
            pluginsInfo.installedPlugins = "";

            for (i = 0; i < plugins.length; i++) {
                pluginsInfo.installedPlugins = pluginsInfo.installedPlugins + plugins[i].filename + ";";
            }

            return pluginsInfo;
        } else {
            console.warn("Cannot collect browser plugin information. navigator.plugins is not defined.");
            return {};
        }

    },
// Getting geolocation takes some time and is done asynchronously, hence need a callback which is called once geolocation is retrieved.
    collectGeolocationInfo = function (callback) {
        var geolocationInfo = {},
            successCallback = function(position) {
                geolocationInfo.longitude = position.coords.longitude;
                geolocationInfo.latitude = position.coords.latitude;
                callback(geolocationInfo);
            }, errorCallback = function(error) {
                console.warn("Cannot collect geolocation information. " + error.code + ": " + error.message);
                callback(geolocationInfo);
            };
        if (navigator && navigator.geolocation) {
            // NB: If user chooses 'Not now' on Firefox neither callback gets called
            //     https://bugzilla.mozilla.org/show_bug.cgi?id=675533
            navigator.geolocation.getCurrentPosition(successCallback, errorCallback);
        } else {
            console.warn("Cannot collect geolocation information. navigator.geolocation is not defined.");
            callback(geolocationInfo);
        }
    },
    collectBrowserFontsInfo = function () {
        var fontsInfo = {}, i, fontsList = ["cursive","monospace","serif","sans-serif","fantasy","default","Arial","Arial Black",
            "Arial Narrow","Arial Rounded MT Bold","Bookman Old Style","Bradley Hand ITC","Century","Century Gothic",
            "Comic Sans MS","Courier","Courier New","Georgia","Gentium","Impact","King","Lucida Console","Lalit",
            "Modena","Monotype Corsiva","Papyrus","Tahoma","TeX","Times","Times New Roman","Trebuchet MS","Verdana",
            "Verona"];
        fontsInfo.installedFonts = "";

        for (i = 0; i < fontsList.length; i++) {
            if (fontDetector.detect(fontsList[i])) {
                fontsInfo.installedFonts = fontsInfo.installedFonts + fontsList[i] + ";";
            }
        }
        return fontsInfo;
    },
    devicePrint = {};

devicePrint.screen = collectScreenInfo();
devicePrint.timezone = collectTimezoneInfo();
devicePrint.plugins = collectBrowserPluginsInfo();
devicePrint.fonts = collectBrowserFontsInfo();

if (navigator.userAgent) {
    devicePrint.userAgent = navigator.userAgent;
}
if (navigator.appName) {
    devicePrint.appName = navigator.appName;
}
if (navigator.appCodeName) {
    devicePrint.appCodeName = navigator.appCodeName;
}
if (navigator.appVersion) {
    devicePrint.appVersion = navigator.appVersion;
}
if (navigator.appMinorVersion) {
    devicePrint.appMinorVersion = navigator.appMinorVersion;
}
if (navigator.buildID) {
    devicePrint.buildID = navigator.buildID;
}
if (navigator.platform) {
    devicePrint.platform = navigator.platform;
}
if (navigator.cpuClass) {
    devicePrint.cpuClass = navigator.cpuClass;
}
if (navigator.oscpu) {
    devicePrint.oscpu = navigator.oscpu;
}
if (navigator.product) {
    devicePrint.product = navigator.product;
}
if (navigator.productSub) {
    devicePrint.productSub = navigator.productSub;
}
if (navigator.vendor) {
    devicePrint.vendor = navigator.vendor;
}
if (navigator.vendorSub) {
    devicePrint.vendorSub = navigator.vendorSub;
}
if (navigator.language) {
    devicePrint.language = navigator.language;
}
if (navigator.userLanguage) {
    devicePrint.userLanguage = navigator.userLanguage;
}
if (navigator.browserLanguage) {
    devicePrint.browserLanguage = navigator.browserLanguage;
}
if (navigator.systemLanguage) {
    devicePrint.systemLanguage = navigator.systemLanguage;
}

// Attempt to collect geo-location information and return this with the data collected so far.
// Otherwise, if geo-location fails or takes longer than 30 seconds, auto-submit the data collected so far.
autoSubmitDelay = 30000;
output.value = JSON.stringify(devicePrint);
collectGeolocationInfo(function(geolocationInfo) {
    devicePrint.geolocation = geolocationInfo;
    output.value = JSON.stringify(devicePrint);
    submit();
});"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Device-Id-(Match)-Client-Side.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "157298c0-7d31-4059-a95b-eeb08473b7e5": {
      "_id": "157298c0-7d31-4059-a95b-eeb08473b7e5",
      "context": "AUTHENTICATION_CLIENT_SIDE",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Default global script for client side Device Id (Match) Authentication Module",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Device Id (Match) - Client Side",
      "script": "file://Device-Id-(Match)-Client-Side.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Device-Id-(Match)-Server-Side.script.js 1`] = `
"/*
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS HEADER.
 *
 * Copyright (c) 2009 Sun Microsystems Inc. All Rights Reserved
 *
 * The contents of this file are subject to the terms
 * of the Common Development and Distribution License
 * (the License). You may not use this file except in
 * compliance with the License.
 *
 * You can obtain a copy of the License at
 * https://opensso.dev.java.net/public/CDDLv1.0.html or
 * opensso/legal/CDDLv1.0.txt
 * See the License for the specific language governing
 * permission and limitations under the License.
 *
 * When distributing Covered Code, include this CDDL
 * Header Notice in each file and include the License file
 * at opensso/legal/CDDLv1.0.txt.
 * If applicable, add the following below the CDDL Header,
 * with the fields enclosed by brackets [] replaced by
 * your own identifying information:
 * "Portions Copyrighted [year] [name of copyright owner]"
 *
 */
/*
 * Portions Copyrighted 2013 Syntegrity.
 * Portions Copyrighted 2013-2018 ForgeRock AS.
 */

var ScalarComparator = {}, ScreenComparator = {}, MultiValueComparator = {}, UserAgentComparator = {}, GeolocationComparator = {};

var config = {
    profileExpiration: 30,              //in days
    maxProfilesAllowed: 5,
    maxPenaltyPoints: 0,
    attributes: {
        screen: {
            required: true,
            comparator: ScreenComparator,
            args: {
                penaltyPoints: 50
            }
        },
        plugins: {
            installedPlugins: {
                required: false,
                comparator: MultiValueComparator,
                args: {
                    maxPercentageDifference: 10,
                    maxDifferences: 5,
                    penaltyPoints: 100
                }
            }
        },
        fonts: {
            installedFonts: {
                required: false,
                comparator: MultiValueComparator,
                args: {
                    maxPercentageDifference: 10,
                    maxDifferences: 5,
                    penaltyPoints: 100
                }
            }
        },
        timezone: {
            timezone: {
                required: false,
                comparator: ScalarComparator,
                args: {
                    penaltyPoints: 100
                }
            }
        },
        userAgent: {
            required: true,
            comparator: UserAgentComparator,
            args: {
                ignoreVersion: true,
                penaltyPoints: 100
            }
        },
        geolocation: {
            required: false,
            comparator: GeolocationComparator,
            args: {
                allowedRange: 100,            //in miles
                penaltyPoints: 100
            }
        }
    }
};

//---------------------------------------------------------------------------//
//                           Comparator functions                            //
//---------------------------------------------------------------------------//

var all, any, calculateDistance, calculateIntersection, calculatePercentage, nullOrUndefined, splitAndTrim,
    undefinedLocation;

// ComparisonResult

/**
 * Constructs an instance of a ComparisonResult with the given penalty points.
 *
 * @param penaltyPoints (Number) The penalty points for the comparison (defaults to 0).
 * @param additionalInfoInCurrentValue (boolean) Whether the current value contains more information
 *                                               than the stored value (defaults to false).
 */
function ComparisonResult() {

    var penaltyPoints = 0,
        additionalInfoInCurrentValue = false;

    if (arguments[0] !== undefined && arguments[1] !== undefined) {
        penaltyPoints = arguments[0];
        additionalInfoInCurrentValue = arguments[1];
    }

    if (arguments[0] !== undefined && arguments[1] === undefined) {
        if (typeof(arguments[0]) === "boolean") {
            additionalInfoInCurrentValue = arguments[0];
        } else {
            penaltyPoints = arguments[0];
        }
    }

    this.penaltyPoints = penaltyPoints;
    this.additionalInfoInCurrentValue = additionalInfoInCurrentValue;

}

ComparisonResult.ZERO_PENALTY_POINTS = new ComparisonResult(0);

/**
 * Static method for functional programming.
 *
 * @return boolean true if comparisonResult.isSuccessful().
 */
ComparisonResult.isSuccessful =  function(comparisonResult) {
    return comparisonResult.isSuccessful();
};


/**
 * Static method for functional programming.
 *
 * @return boolean true if comparisonResult.additionalInfoInCurrentValue.
 */
ComparisonResult.additionalInfoInCurrentValue =  function(comparisonResult) {
    return comparisonResult.additionalInfoInCurrentValue;
};

/**
 * Comparison function that can be provided as an argument to array.sort
 */
ComparisonResult.compare = function(first, second) {
    if (nullOrUndefined(first) && nullOrUndefined(second)) {
        return 0;
    } else if (nullOrUndefined(first)) {
        return -1;
    } else if (nullOrUndefined(second)) {
        return 1;
    } else {
        if (first.penaltyPoints !== second.penaltyPoints) {
            return first.penaltyPoints - second.penaltyPoints;
        } else {
            return (first.additionalInfoInCurrentValue ? 1 : 0) - (second.additionalInfoInCurrentValue ? 1 : 0);
        }
    }
};

/**
 * Amalgamates the given ComparisonResult into this ComparisonResult.
 *
 * @param comparisonResult The ComparisonResult to include.
 */
ComparisonResult.prototype.addComparisonResult = function(comparisonResult) {
    this.penaltyPoints += comparisonResult.penaltyPoints;
    if (comparisonResult.additionalInfoInCurrentValue) {
        this.additionalInfoInCurrentValue = comparisonResult.additionalInfoInCurrentValue;
    }
};

/**
 * Returns true if no penalty points have been assigned for the comparison.
 *
 * @return boolean true if the comparison was successful.
 */
ComparisonResult.prototype.isSuccessful = function() {
    return nullOrUndefined(this.penaltyPoints) || this.penaltyPoints === 0;
};

/**
 * Compares two simple objects (String|Number) and if they are equal then returns a ComparisonResult with zero
 * penalty points assigned, otherwise returns a ComparisonResult with the given number of penalty points assigned.
 *
 * @param currentValue (String|Number) The current value.
 * @param storedValue (String|Number) The stored value.
 * @param config: {
 *            "penaltyPoints": (Number) The number of penalty points.
 *        }
 * @return ComparisonResult.
 */
ScalarComparator.compare = function (currentValue, storedValue, config) {
    if (logger.messageEnabled()) {
        logger.message("StringComparator.compare:currentValue: " + JSON.stringify(currentValue));
        logger.message("StringComparator.compare:storedValue: " + JSON.stringify(storedValue));
        logger.message("StringComparator.compare:config: " + JSON.stringify(config));
    }
    if (config.penaltyPoints === 0) {
        return ComparisonResult.ZERO_PENALTY_POINTS;
    }

    if (!nullOrUndefined(storedValue)) {
        if (nullOrUndefined(currentValue) || currentValue !== storedValue) {
            return new ComparisonResult(config.penaltyPoints);
        }
    } else if (!nullOrUndefined(currentValue)) {
        return new ComparisonResult(true);
    }

    return ComparisonResult.ZERO_PENALTY_POINTS;
};

/**
 * Compares two screens and if they are equal then returns a ComparisonResult with zero penalty points assigned,
 * otherwise returns a ComparisonResult with the given number of penalty points assigned.
 *
 * @param currentValue: {
 *            "screenWidth": (Number) The current client screen width.
 *            "screenHeight": (Number) The current client screen height.
 *            "screenColourDepth": (Number) The current client screen colour depth.
 *        }
 * @param storedValue: {
 *            "screenWidth": (Number) The stored client screen width.
 *            "screenHeight": (Number) The stored client screen height.
 *            "screenColourDepth": (Number) The stored client screen colour depth.
 *        }
 * @param config: {
 *            "penaltyPoints": (Number) The number of penalty points.
 *        }
 * @return ComparisonResult
 */
ScreenComparator.compare = function (currentValue, storedValue, config) {
    if (logger.messageEnabled()) {
        logger.message("ScreenComparator.compare:currentValue: " + JSON.stringify(currentValue));
        logger.message("ScreenComparator.compare:storedValue: " + JSON.stringify(storedValue));
        logger.message("ScreenComparator.compare:config: " + JSON.stringify(config));
    }

    if (nullOrUndefined(currentValue)) {
        currentValue = {screenWidth: null, screenHeight: null, screenColourDepth: null};
    }
    if (nullOrUndefined(storedValue)) {
        storedValue = {screenWidth: null, screenHeight: null, screenColourDepth: null};
    }

    var comparisonResults = [
        ScalarComparator.compare(currentValue.screenWidth, storedValue.screenWidth, config),
        ScalarComparator.compare(currentValue.screenHeight, storedValue.screenHeight, config),
        ScalarComparator.compare(currentValue.screenColourDepth, storedValue.screenColourDepth, config)];

    if (all(comparisonResults, ComparisonResult.isSuccessful)) {
        return new ComparisonResult(any(comparisonResults, ComparisonResult.additionalInfoInCurrentValue));
    } else {
        return new ComparisonResult(config.penaltyPoints);
    }
};

/**
 * Splits both values using delimiter, trims every value and compares collections of values.
 * Returns zero-result for same multi-value attributes.
 *
 * If collections are not same checks if number of differences is less or equal maxDifferences or
 * percentage of difference is less or equal maxPercentageDifference.
 *
 * If yes then returns zero-result with additional info, else returns penaltyPoints-result.
 *
 * @param currentValue: (String) The current value.
 * @param storedValue: (String) The stored value.
 * @param config: {
 *            "maxPercentageDifference": (Number) The max difference percentage in the values,
 *                                                before the penalty is assigned.
 *            "maxDifferences": (Number) The max number of differences in the values,
 *                                       before the penalty points are assigned.
 *            "penaltyPoints": (Number) The number of penalty points.
  *        }
 * @return ComparisonResult
 */
MultiValueComparator.compare = function (currentValue, storedValue, config) {
    if (logger.messageEnabled()) {
        logger.message("MultiValueComparator.compare:currentValue: " + JSON.stringify(currentValue));
        logger.message("MultiValueComparator.compare:storedValue: " + JSON.stringify(storedValue));
        logger.message("MultiValueComparator.compare:config: " + JSON.stringify(config));
    }

    var delimiter = ";",
        currentValues = splitAndTrim(currentValue, delimiter),
        storedValues = splitAndTrim(storedValue, delimiter),
        maxNumberOfElements = Math.max(currentValues.length, storedValues.length),
        numberOfTheSameElements = calculateIntersection(currentValues, storedValues).length,
        numberOfDifferences = maxNumberOfElements - numberOfTheSameElements,
        percentageOfDifferences = calculatePercentage(numberOfDifferences, maxNumberOfElements);

    if (nullOrUndefined(storedValue) && !nullOrUndefined(currentValue)) {
        return new ComparisonResult(true);
    }

    if (logger.messageEnabled()) {
        logger.message(numberOfTheSameElements + " of " + maxNumberOfElements + " are same");
    }

    if (maxNumberOfElements === 0) {
        logger.message("Ignored because no attributes found in both profiles");
        return ComparisonResult.ZERO_PENALTY_POINTS;
    }

    if (numberOfTheSameElements === maxNumberOfElements) {
        logger.message("Ignored because all attributes are same");
        return ComparisonResult.ZERO_PENALTY_POINTS;
    }

    if (numberOfDifferences > config.maxDifferences) {
        if (logger.messageEnabled()) {
            logger.message("Would be ignored if not more than " + config.maxDifferences + " differences");
        }
        return new ComparisonResult(config.penaltyPoints);
    }

    if (percentageOfDifferences > config.maxPercentageDifference) {
        if (logger.messageEnabled()) {
            logger.message(percentageOfDifferences + " percents are different");
            logger.message("Would be ignored if not more than " + config.maxPercentageDifference + " percent");
        }
        return new ComparisonResult(config.penaltyPoints);
    }

    if (logger.messageEnabled()) {
        logger.message("Ignored because number of differences(" + numberOfDifferences + ") not more than "
            + config.maxDifferences);
        logger.message(percentageOfDifferences + " percents are different");
        logger.message("Ignored because not more than " + config.maxPercentageDifference + " percent");
    }
    return new ComparisonResult(true);
};

/**
 * Compares two User Agent Strings and if they are equal then returns a ComparisonResult with zero penalty
 * points assigned, otherwise returns a ComparisonResult with the given number of penalty points assigned.
 *
 * @param currentValue (String) The current value.
 * @param storedValue (String) The stored value.
 * @param config: {
 *            "ignoreVersion": (boolean) If the version numbers in the User Agent Strings should be ignore
 *                                       in the comparison.
 *            "penaltyPoints": (Number) The number of penalty points.
 *        }
 * @return A ComparisonResult.
 */
UserAgentComparator.compare = function (currentValue, storedValue, config) {
    if (logger.messageEnabled()) {
        logger.message("UserAgentComparator.compare:currentValue: " + JSON.stringify(currentValue));
        logger.message("UserAgentComparator.compare:storedValue: " + JSON.stringify(storedValue));
        logger.message("UserAgentComparator.compare:config: " + JSON.stringify(config));
    }

    if (config.ignoreVersion) {
        // remove version number
        currentValue = nullOrUndefined(currentValue) ? null : currentValue.replace(/[\\d\\.]+/g, "").trim();
        storedValue = nullOrUndefined(storedValue) ? null : storedValue.replace(/[\\d\\.]+/g, "").trim();
    }

    return ScalarComparator.compare(currentValue, storedValue, config);
};

/**
 * Compares two locations, taking into account a degree of difference.
 *
 * @param currentValue: {
 *            "latitude": (Number) The current latitude.
 *            "longitude": (Number) The current longitude.
 *        }
 * @param storedValue: {
 *            "latitude": (Number) The stored latitude.
 *            "longitude": (Number) The stored longitude.
 *        }
 * @param config: {
 *            "allowedRange": (Number) The max difference allowed in the two locations, before the penalty is assigned.
 *            "penaltyPoints": (Number) The number of penalty points.
*         }
 * @return ComparisonResult
 */
GeolocationComparator.compare = function (currentValue, storedValue, config) {
    if (logger.messageEnabled()) {
        logger.message("GeolocationComparator.compare:currentValue: " + JSON.stringify(currentValue));
        logger.message("GeolocationComparator.compare:storedValue: " + JSON.stringify(storedValue));
        logger.message("GeolocationComparator.compare:config: " + JSON.stringify(config));
    }

    // Check for undefined stored or current locations

    if (undefinedLocation(currentValue) && undefinedLocation(storedValue)) {
        return ComparisonResult.ZERO_PENALTY_POINTS;
    }
    if (undefinedLocation(currentValue) && !undefinedLocation(storedValue)) {
        return new ComparisonResult(config.penaltyPoints);
    }
    if (!undefinedLocation(currentValue) && undefinedLocation(storedValue)) {
        return new ComparisonResult(true);
    }

    // Both locations defined, therefore perform comparison

    var distance = calculateDistance(currentValue, storedValue);

    if (logger.messageEnabled()) {
        logger.message("Distance between (" + currentValue.latitude + "," + currentValue.longitude + ") and (" +
            storedValue.latitude + "," + storedValue.longitude + ") is " + distance + " miles");
    }

    if (parseFloat(distance.toPrecision(5)) === 0) {
        logger.message("Location is the same");
        return ComparisonResult.ZERO_PENALTY_POINTS;
    }

    if (distance <= config.allowedRange) {
        if (logger.messageEnabled()) {
            logger.message("Tolerated because distance not more then " + config.allowedRange);
        }
        return new ComparisonResult(true);
    } else {
        if (logger.messageEnabled()) {
            logger.message("Would be ignored if distance not more then " + config.allowedRange);
        }
        return new ComparisonResult(config.penaltyPoints);
    }
};


//---------------------------------------------------------------------------//
//                    Device Print Logic - DO NOT MODIFY                     //
//---------------------------------------------------------------------------//

// Utility functions

/**
 * Returns true if evaluating function f on each element of the Array a returns true.
 *
 * @param a: (Array) The array of elements to evaluate
 * @param f: (Function) A single argument function for mapping elements of the array to boolean.
 * @return boolean.
 */
all = function(a, f) {
    var i;
    for (i = 0; i < a.length; i++) {
        if (f(a[i]) === false) {
            return false;
        }
    }
    return true;
};

/**
 * Returns true if evaluating function f on any element of the Array a returns true.
 *
 * @param a: (Array) The array of elements to evaluate
 * @param f: (Function) A single argument function for mapping elements of the array to boolean.
 * @return boolean.
 */
any = function(a, f) {
    var i;
    for (i = 0; i < a.length; i++) {
        if (f(a[i]) === true) {
            return true;
        }
    }
    return false;
};

/**
 * Returns true if the provided location is null or has undefined longitude or latitude values.
 *
 * @param location: {
 *            "latitude": (Number) The latitude.
 *            "longitude": (Number) The longitude.
 *        }
 * @return boolean
 */
undefinedLocation = function(location) {
    return nullOrUndefined(location) || nullOrUndefined(location.latitude) || nullOrUndefined(location.longitude);
};

/**
 * Returns true if the provided value is null or undefined.
 *
 * @param value: a value of any type
 * @return boolean
 */
nullOrUndefined = function(value) {
    return value === null || value === undefined;
};

/**
 * Calculates the distances between the two locations.
 *
 * @param first: {
 *            "latitude": (Number) The first latitude.
 *            "longitude": (Number) The first longitude.
 *        }
 * @param second: {
 *            "latitude": (Number) The second latitude.
 *            "longitude": (Number) The second longitude.
 *        }
 * @return Number The distance between the two locations.
 */
calculateDistance = function(first, second) {
    var factor = (Math.PI / 180),
        theta,
        dist;
    function degreesToRadians(degrees) {
        return degrees * factor;
    }
    function radiansToDegrees(radians) {
        return radians / factor;
    }
    theta = first.longitude - second.longitude;
    dist = Math.sin(degreesToRadians(first.latitude)) * Math.sin(degreesToRadians(second.latitude))
        + Math.cos(degreesToRadians(first.latitude)) * Math.cos(degreesToRadians(second.latitude))
        * Math.cos(degreesToRadians(theta));
    dist = Math.acos(dist);
    dist = radiansToDegrees(dist);
    dist = dist * 60 * 1.1515;
    return dist;
};

/**
 * Converts a String holding a delimited sequence of values into an array.
 *
 * @param text (String) The String representation of a delimited sequence of values.
 * @param delimiter (String) The character delimiting values within the text String.
 * @return (Array) The comma separated values.
 */
splitAndTrim = function(text, delimiter) {

    var results = [],
        i,
        values,
        value;
    if (text === null) {
        return results;
    }

    values = text.split(delimiter);
    for (i = 0; i < values.length; i++) {
        value = values[i].trim();
        if (value !== "") {
            results.push(value);
        }
    }

    return results;
};

/**
 * Converts value to a percentage of range.
 *
 * @param value (Number) The actual number to be converted to a percentage.
 * @param range (Number) The total number of values (i.e. represents 100%).
 * @return (Number) The percentage.
 */
calculatePercentage = function(value, range) {
    if (range === 0) {
        return 0;
    }
    return parseFloat((value / range).toPrecision(2)) * 100;
};

/**
 * Creates a new array containing only those elements found in both arrays received as arguments.
 *
 * @param first (Array) The first array.
 * @param second (Array) The second array.
 * @return (Array) The elements that found in first and second.
 */
calculateIntersection = function(first, second) {
    return first.filter(function(element) {
        return second.indexOf(element) !== -1;
    });
};

function getValue(obj, attributePath) {
    var value = obj,
        i;
    for (i = 0; i < attributePath.length; i++) {
        if (value === undefined) {
            return null;
        }
        value = value[attributePath[i]];
    }
    return value;
}


function isLeafNode(attributeConfig) {
    return attributeConfig.comparator !== undefined;
}

function getAttributePaths(attributeConfig, attributePath) {

    var attributePaths = [],
        attributeName,
        attrPaths,
        attrPath,
        i;

    for (attributeName in attributeConfig) {
        if (attributeConfig.hasOwnProperty(attributeName)) {

            if (isLeafNode(attributeConfig[attributeName])) {
                attrPath = attributePath.slice();
                attrPath.push(attributeName);
                attributePaths.push(attrPath);
            } else {
                attrPath = attributePath.slice();
                attrPath.push(attributeName);
                attrPaths = getAttributePaths(attributeConfig[attributeName], attrPath);
                for (i = 0; i < attrPaths.length; i++) {
                    attributePaths.push(attrPaths[i]);
                }
            }
        }
    }

    return attributePaths;
}

function getDevicePrintAttributePaths(attributeConfig) {
    return getAttributePaths(attributeConfig, []);
}

function hasRequiredAttributes(devicePrint, attributeConfig) {

    var attributePaths = getDevicePrintAttributePaths(attributeConfig),
        i,
        attrValue,
        attrConfig;

    for (i = 0; i < attributePaths.length; i++) {

        attrValue = getValue(devicePrint, attributePaths[i]);
        attrConfig = getValue(attributeConfig, attributePaths[i]);

        if (attrConfig.required && attrValue === undefined) {
            logger.warning("Device Print profile missing required attribute, " + attributePaths[i]);
            return false;
        }
    }

    logger.message("device print has required attributes");
    return true;
}

function compareDevicePrintProfiles(attributeConfig, devicePrint, devicePrintProfiles, maxPenaltyPoints) {

    var attributePaths = getDevicePrintAttributePaths(attributeConfig),
        dao = sharedState.get('_DeviceIdDao'),
        results,
        j,
        aggregatedComparisonResult,
        i,
        currentValue,
        storedValue,
        attrConfig,
        comparisonResult,
        selectedComparisonResult,
        selectedProfile,
        curDevicePrintProfile,
        vals;

    results = [];
    for (j = 0; j < devicePrintProfiles.length; j++) {
        curDevicePrintProfile = JSON.parse(org.forgerock.json.JsonValue.json(devicePrintProfiles[j]));
        aggregatedComparisonResult = new ComparisonResult();
        for (i = 0; i < attributePaths.length; i++) {

            currentValue = getValue(devicePrint, attributePaths[i]);
            storedValue = getValue(curDevicePrintProfile.devicePrint, attributePaths[i]);
            attrConfig = getValue(attributeConfig, attributePaths[i]);

            if (storedValue === null) {
                comparisonResult = new ComparisonResult(attrConfig.penaltyPoints);
            } else {
                comparisonResult = attrConfig.comparator.compare(currentValue, storedValue, attrConfig.args);
            }

            if (logger.messageEnabled()) {
                logger.message("Comparing attribute path: " + attributePaths[i]
                    + ", Comparison result: successful=" + comparisonResult.isSuccessful() + ", penaltyPoints="
                    + comparisonResult.penaltyPoints + ", additionalInfoInCurrentValue="
                    + comparisonResult.additionalInfoInCurrentValue);
            }
            aggregatedComparisonResult.addComparisonResult(comparisonResult);
        }
        if (logger.messageEnabled()) {
            logger.message("Aggregated comparison result: successful="
                + aggregatedComparisonResult.isSuccessful() + ", penaltyPoints="
                + aggregatedComparisonResult.penaltyPoints + ", additionalInfoInCurrentValue="
                + aggregatedComparisonResult.additionalInfoInCurrentValue);
        }

        results.push({
            key: aggregatedComparisonResult,
            value: devicePrintProfiles[j]
        });
    }

    if (results.length === 0) {
        return null;
    }

    results.sort(function(a, b) {
        return ComparisonResult.compare(a.key, b.key);
    });
    selectedComparisonResult = results[0].key;
    if (logger.messageEnabled()) {
        logger.message("Selected comparison result: successful=" + selectedComparisonResult.isSuccessful()
            + ", penaltyPoints=" + selectedComparisonResult.penaltyPoints + ", additionalInfoInCurrentValue="
            + selectedComparisonResult.additionalInfoInCurrentValue);
    }

    selectedProfile = null;
    if (selectedComparisonResult.penaltyPoints <= maxPenaltyPoints) {
        selectedProfile = results[0].value;
        if (logger.messageEnabled()) {
            logger.message("Selected profile: " + selectedProfile +
                " with " + selectedComparisonResult.penaltyPoints + " penalty points");
        }
    }

    if (selectedProfile === null) {
        return false;
    }

    /* update profile */
    selectedProfile.put("selectionCounter",
        java.lang.Integer.valueOf(parseInt(selectedProfile.get("selectionCounter"), 10) + 1));
    selectedProfile.put("lastSelectedDate", java.lang.Long.valueOf(new Date().getTime()));
    selectedProfile.put("devicePrint", devicePrint);

    vals = [];
    for (i = 0; i < devicePrintProfiles.length; i++) {
        vals.push(org.forgerock.json.JsonValue.json(devicePrintProfiles[i]));
    }

    dao.saveDeviceProfiles(username, realm, vals);

    return true;
}

function matchDevicePrint() {

    if (!username) {
        logger.error("Username not set. Cannot compare user's device print profiles.");
        authState = FAILED;
    } else {

        if (logger.messageEnabled()) {
            logger.message("client devicePrint: " + clientScriptOutputData);
        }

        var getProfiles = function () {

                function isExpiredProfile(devicePrintProfile) {
                    var expirationDate = new Date(),
                        lastSelectedDate;
                    expirationDate.setDate(expirationDate.getDate() - config.profileExpiration);

                    lastSelectedDate = new Date(devicePrintProfile.lastSelectedDate);

                    return lastSelectedDate < expirationDate;
                }

                function getNotExpiredProfiles() {
                    var profile,
                        dao = sharedState.get('_DeviceIdDao'),
                        results = [],
                        profiles,
                        iter;

                    profiles = dao.getDeviceProfiles(username, realm);

                    if (profiles) {
                        iter = profiles.iterator();

                        while (iter.hasNext()) {
                            profile = iter.next().getObject();
                            if (!isExpiredProfile(profile)) {
                                results.push(profile);
                            }
                        }
                    }
                    if (logger.messageEnabled()) {
                        logger.message("stored non-expired profiles: " + results);
                    }
                    return results;
                }

                return getNotExpiredProfiles();
            },
            devicePrint = JSON.parse(clientScriptOutputData),
            devicePrintProfiles = getProfiles();

        if (!hasRequiredAttributes(devicePrint, config.attributes)) {
            logger.message("devicePrint.hasRequiredAttributes: false");
            // Will fail this module but fall-through to next module. Which should be OTP.
            authState = FAILED;
        } else if (compareDevicePrintProfiles(config.attributes, devicePrint, devicePrintProfiles, config.maxPenaltyPoints)) {
            logger.message("devicePrint.hasValidProfile: true");
            authState = SUCCESS;
        } else {
            logger.message("devicePrint.hasValidProfile: false");
            sharedState.put('devicePrintProfile', JSON.stringify(devicePrint));
            // Will fail this module but fall-through to next module. Which should be OTP.
            authState = FAILED;
        }
    }
}

matchDevicePrint();"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Device-Id-(Match)-Server-Side.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "703dab1a-1921-4981-98dd-b8e5349d8548": {
      "_id": "703dab1a-1921-4981-98dd-b8e5349d8548",
      "context": "AUTHENTICATION_SERVER_SIDE",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Default global script for server side Device Id (Match) Authentication Module",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Device Id (Match) - Server Side",
      "script": "file://Device-Id-(Match)-Server-Side.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Display-Password.script.js 1`] = `
"/* Display Password
 *
 * Author: volker.scheuber@forgerock.com
 * 
 * Display Password collected via Platform Password node.
 * 
 * This script does not need to be parametrized. It will work properly as is.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 */
var password = "unable to retrieve!";
if (nodeState.get("password")) {
  password = nodeState.get("password").asString();
}
var fr = JavaImporter(
    org.forgerock.openam.auth.node.api.Action,
    javax.security.auth.callback.TextOutputCallback
)
if (callbacks.isEmpty()) {
    action = fr.Action.send(
        new fr.TextOutputCallback(
            fr.TextOutputCallback.INFORMATION,
            password
        )
    ).build()
}
else {
  action = fr.Action.goTo("true").build();
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Display-Password.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "ec8b314c-8e11-4364-93b9-a3e82d2a074a": {
      "_id": "ec8b314c-8e11-4364-93b9-a3e82d2a074a",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Display Password from nodeState",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Display Password",
      "script": "file://Display-Password.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Display-Session-Info.script.js 1`] = `
"/* Display Session Info
 * 
 * Display Session Info.
 * 
 * This script does not need to be parametrized. It will work properly as is.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 *
 * Author: volker.scheuber@forgerock.com
 */
(function () {
    outcome = "true";

    var anchor = "anchor-".concat(generateNumericToken('xxx'));
    var halign = "left";

    var choices = [];
      var defaultChoice = 0;
  
      var include = ["org","idp","saas","profileType","givenName","sn","mail","roles","userName","UserId","Locale","authInstant","AuthLevel","Host","Service"];
    var message = "";
    if (typeof existingSession !== "undefined") {
          message = "<h4>Session Info</h4><p style=\\"font-family:courier;\\">";
          include.forEach(function (key) {
              message += "<b>" + key + "</b>: " + existingSession.get(key) + "<br/>";
        });
         message += "</p><p style=\\"font-size:70%;font-family:courier;\\">"
          var entries = existingSession.keySet().toArray();
        entries.forEach(function (key) {
              if (include.indexOf(""+key)===-1) {
                message += "<b>" + key + "</b>: " + existingSession.get(key) + "<br/>";
            }
        });
         message += "</p>"
          choices.push("Goto SAML App");
          choices.push("Goto OIDC App");
          if (""+existingSession.get("profileType") === "persistent") {
              choices.push("Goto Profile Page");
        }
          choices.push("Logout");
    } else {
          message = "<h4>No Session!</h4><p>"
          choices.push("Login");
    }
    var script = "Array.prototype.slice.call(\\n".concat(
      "document.getElementsByClassName('callback-component')).forEach(\\n").concat(
      "function (e) {\\n").concat(
      "  var message = e.firstElementChild;\\n").concat(
      "  if (message.firstChild && message.firstChild.nodeName == '#text' && message.firstChild.nodeValue.trim() == '").concat(anchor).concat("') {\\n").concat(
      "    message.className = \\"\\";\\n").concat(
      "    message.style = \\"text-align: left; inline-size: 430px; overflow-wrap: break-word;\\";\\n").concat(
      "    message.align = \\"").concat(halign).concat("\\";\\n").concat(
      "    message.innerHTML = '").concat(message).concat("';\\n").concat(
      "  }\\n").concat(
      "})")
  
    var fr = JavaImporter(
        org.forgerock.openam.auth.node.api.Action,
        javax.security.auth.callback.TextOutputCallback,
        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback,
        javax.security.auth.callback.ConfirmationCallback
    )
    if (callbacks.isEmpty()) {
        action = fr.Action.send(
            new fr.TextOutputCallback(
                fr.TextOutputCallback.INFORMATION,
                anchor
            ),
            new fr.ScriptTextOutputCallback(script),
            new fr.ConfirmationCallback(
                fr.ConfirmationCallback.INFORMATION,
                choices,
                defaultChoice
            )
        ).build()
    }
    else {
      outcome = choices[callbacks.get(2).getSelectedIndex()];
      action = fr.Action.goTo(outcome).build();
    }

     /*
      * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.
      * 
      * Example:
      * 'xxxxx' produces '28535'
      * 'xxx-xxx' produces '432-521'
      */
    function generateNumericToken(format) {
        return format.replace(/[x]/g, function(c) {
            var r = Math.random()*10|0;
            var v = r;
            return v.toString(10);
        });
    }
}());

/*
Locale: en_US
authInstant: 2021-09-25T17:28:38Z
Organization: o=alpha,ou=services,ou=am-config
mail: volker@scheuber.name
Principals: volker@scheuber.name
UserProfile: Ignore
CharSet: UTF-8
FullLoginURL: /am/UI/Login?code=4%2F0AX4XfWjiEfbrfIstsFUKoaibPCQmTbuPonLfuhpYhjfj-N5QEe9u2P5Os9wNadGaPsQVBA&scope=email+profile+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.email+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.profile+openid&realm=%2Falpha&state=fykprtfmeclrgwszmomvqxnlirrehcs&hd=scheuber.name&prompt=none&authuser=2
clientType: genericHTML
goto: /am/XUI/?realm=/alpha&authIndexType=service&authIndexValue=SessionInfo&ForceAuth=true#/
AMCtxId: d3188938-d07e-4134-95db-f1cc97fc6c40-503275
loginURL: /am/UI/Login
sn: Scheuber
amlbcookie: 01
HostName: 99.72.28.182
UserToken: volker@scheuber.name
givenName: Volker
successURL: /am/XUI/?realm=/alpha&authIndexType=service&authIndexValue=SessionInfo&ForceAuth=true#/
Service: Router
Host: 99.72.28.182
AuthLevel: 0
idp: google
UserId: volker@scheuber.name
sun.am.UniversalIdentifier: id=volker@scheuber.name,ou=user,o=alpha,ou=services,ou=am-config
OidcSid: ACuTQIObj0tajPYhLOjMlWc2urM
Principal: id=volker@scheuber.name,ou=user,o=alpha,ou=services,ou=am-config
 */"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Display-Session-Info.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "37bf200a-158f-4a45-8ee5-81516e4593f8": {
      "_id": "37bf200a-158f-4a45-8ee5-81516e4593f8",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Display session info.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Display Session Info",
      "script": "file://Display-Session-Info.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Display-States.script.js 1`] = `
"/* Display States
 * 
 * Display sharedState and transientState.
 * 
 * This script does not need to be parametrized. It will work properly as is.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 *
 * Author: volker.scheuber@forgerock.com
 */
(function () {
    outcome = "true";

    var anchor = "anchor-".concat(generateNumericToken('xxx'));
    var halign = "left";
    var message = "<h4>Current State Values</h4>".concat(
        "<p><b>Shared State</b>:<br/>").concat(
        sharedState.toString()).concat("</p>").concat(
        "<p><b>Transient State</b>:<br/>").concat(
        transientState.toString()).concat("</p>").concat(
        "<p><b>Request Headers</b>:<br/>").concat(
        requestHeaders.toString()).concat("</p>")
    var script = "Array.prototype.slice.call(\\n".concat(
      "document.getElementsByClassName('callback-component')).forEach(\\n").concat(
      "function (e) {\\n").concat(
      "  var message = e.firstElementChild;\\n").concat(
      "  if (message.firstChild && message.firstChild.nodeName == '#text' && message.firstChild.nodeValue.trim() == '").concat(anchor).concat("') {\\n").concat(
      "    message.className = \\"\\";\\n").concat(
      "    message.style = \\"text-align: left; inline-size: 430px; overflow-wrap: break-word;\\";\\n").concat(
      "    message.align = \\"").concat(halign).concat("\\";\\n").concat(
      "    message.innerHTML = '").concat(message).concat("';\\n").concat(
      "  }\\n").concat(
      "})")
    var fr = JavaImporter(
        org.forgerock.openam.auth.node.api.Action,
        javax.security.auth.callback.TextOutputCallback,
        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback
    )
    if (message.length && callbacks.isEmpty()) {
        action = fr.Action.send(
            new fr.TextOutputCallback(
                fr.TextOutputCallback.INFORMATION,
                anchor
            ),
            new fr.ScriptTextOutputCallback(script)
        ).build()
    }
    else {
      action = fr.Action.goTo(outcome).build();
    }

     /*
      * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.
      * 
      * Example:
      * 'xxxxx' produces '28535'
      * 'xxx-xxx' produces '432-521'
      */
    function generateNumericToken(format) {
        return format.replace(/[x]/g, function(c) {
            var r = Math.random()*10|0;
            var v = r;
            return v.toString(10);
        });
    }
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Display-States.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "b703581a-e112-42b9-bc24-6db8bced5a13": {
      "_id": "b703581a-e112-42b9-bc24-6db8bced5a13",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Display sharedState and transientState.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Display States",
      "script": "file://Display-States.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Display-States-imported-(1).script.js 1`] = `
"/* Display States
 * 
 * Display sharedState and transientState.
 * 
 * This script does not need to be parametrized. It will work properly as is.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 *
 * Author: volker.scheuber@forgerock.com
 */
(function () {
    outcome = "true";

    var anchor = "anchor-".concat(generateNumericToken('xxx'));
    var halign = "left";
    var message = "<h4>Current State Values</h4>".concat(
        "<p><b>Shared State</b>:<br/>").concat(
        sharedState.toString()).concat("</p>").concat(
        "<p><b>Transient State</b>:<br/>").concat(
        transientState.toString()).concat("</p>").concat(
        "<p><b>Request Headers</b>:<br/>").concat(
        requestHeaders.toString()).concat("</p>")
    var script = "Array.prototype.slice.call(\\n".concat(
      "document.getElementsByClassName('callback-component')).forEach(\\n").concat(
      "function (e) {\\n").concat(
      "  var message = e.firstElementChild;\\n").concat(
      "  if (message.firstChild && message.firstChild.nodeName == '#text' && message.firstChild.nodeValue.trim() == '").concat(anchor).concat("') {\\n").concat(
      "    message.className = \\"\\";\\n").concat(
      "    message.style = \\"text-align: left; inline-size: 430px; overflow-wrap: break-word;\\";\\n").concat(
      "    message.align = \\"").concat(halign).concat("\\";\\n").concat(
      "    message.innerHTML = '").concat(message).concat("';\\n").concat(
      "  }\\n").concat(
      "})")
    var fr = JavaImporter(
        org.forgerock.openam.auth.node.api.Action,
        javax.security.auth.callback.TextOutputCallback,
        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback
    )
    if (message.length && callbacks.isEmpty()) {
        action = fr.Action.send(
            new fr.TextOutputCallback(
                fr.TextOutputCallback.INFORMATION,
                anchor
            ),
            new fr.ScriptTextOutputCallback(script)
        ).build()
    }
    else {
      action = fr.Action.goTo(outcome).build();
    }

     /*
      * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.
      * 
      * Example:
      * 'xxxxx' produces '28535'
      * 'xxx-xxx' produces '432-521'
      */
    function generateNumericToken(format) {
        return format.replace(/[x]/g, function(c) {
            var r = Math.random()*10|0;
            var v = r;
            return v.toString(10);
        });
    }
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Display-States-imported-(1).script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "e49225eb-e7ad-4699-bf2a-d57689f9cd6e": {
      "_id": "e49225eb-e7ad-4699-bf2a-d57689f9cd6e",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Display sharedState and transientState.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Display States - imported (1)",
      "script": "file://Display-States-imported-(1).script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Display-States-imported-(2).script.js 1`] = `
"/* Display States
 * 
 * Display sharedState and transientState.
 * 
 * This script does not need to be parametrized. It will work properly as is.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 *
 * Author: volker.scheuber@forgerock.com
 */
(function () {
    outcome = "true";

    var anchor = "anchor-".concat(generateNumericToken('xxx'));
    var halign = "left";
    var message = "<h4>Current State Values</h4>".concat(
        "<p><b>Shared State</b>:<br/>").concat(
        sharedState.toString()).concat("</p>").concat(
        "<p><b>Transient State</b>:<br/>").concat(
        transientState.toString()).concat("</p>")
    var script = "Array.prototype.slice.call(\\n".concat(
      "document.getElementsByClassName('callback-component')).forEach(\\n").concat(
      "function (e) {\\n").concat(
      "  var message = e.firstElementChild;\\n").concat(
      "  if (message.firstChild && message.firstChild.nodeName == '#text' && message.firstChild.nodeValue.trim() == '").concat(anchor).concat("') {\\n").concat(
      "    message.className = \\"\\";\\n").concat(
      "    message.style = \\"text-align: left; inline-size: 430px; overflow-wrap: break-word;\\";\\n").concat(
      "    message.align = \\"").concat(halign).concat("\\";\\n").concat(
      "    message.innerHTML = '").concat(message).concat("';\\n").concat(
      "  }\\n").concat(
      "})")
    var fr = JavaImporter(
        org.forgerock.openam.auth.node.api.Action,
        javax.security.auth.callback.TextOutputCallback,
        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback
    )
    if (message.length && callbacks.isEmpty()) {
        action = fr.Action.send(
            new fr.TextOutputCallback(
                fr.TextOutputCallback.INFORMATION,
                anchor
            ),
            new fr.ScriptTextOutputCallback(script)
        ).build()
    }
    else {
      action = fr.Action.goTo(outcome).build();
    }

     /*
      * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.
      * 
      * Example:
      * 'xxxxx' produces '28535'
      * 'xxx-xxx' produces '432-521'
      */
    function generateNumericToken(format) {
        return format.replace(/[x]/g, function(c) {
            var r = Math.random()*10|0;
            var v = r;
            return v.toString(10);
        });
    }
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Display-States-imported-(2).script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "6d6c2202-725b-4196-9436-92ec11a0b385": {
      "_id": "6d6c2202-725b-4196-9436-92ec11a0b385",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Display sharedState and transientState.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Display States - imported (2)",
      "script": "file://Display-States-imported-(2).script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Display-Username.script.js 1`] = `
"/* Display Username
 *
 * Author: volker.scheuber@forgerock.com
 * 
 * Display the username.
 * 
 * This script does not need to be parametrized. It will work properly as is.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 */
(function () {
  try {
    var outcome = 'true';
    var username = nodeState.get('username').asString();

    // Specify the message you want to display. You may use HTML for formatting. Avoid line breaks! Use <br> instead.
    var message = '<h5>'+username+'</h5>';

    var anchor = 'anchor-'+generateNumericToken('xxx');
    var script = "Array.prototype.slice.call(\\n \\
      document.getElementsByClassName('callback-component')).forEach(\\n \\
      function (e) {\\n \\
        var message = e.firstElementChild;\\n \\
        if (message.firstChild && message.firstChild.nodeName == '#text' && message.firstChild.nodeValue.trim() == '"+anchor+"') {\\n \\
          message.innerHTML = '"+message+"';\\n \\
        }\\n \\
      })";
    var fr = JavaImporter(
        org.forgerock.openam.auth.node.api.Action,
        javax.security.auth.callback.TextOutputCallback,
        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback
    )
    if (message.length && callbacks.isEmpty()) {
        action = fr.Action.send(
            new fr.TextOutputCallback(
                fr.TextOutputCallback.INFORMATION,
                anchor
            ),
            new fr.ScriptTextOutputCallback(script)
        ).build()
    }
    else {
      action = fr.Action.goTo(outcome).build();
    }
  } catch (error) {
    logger.error('Error: ' + error);
    nodeState.putShared('error', error.message);
  }

   /*
    * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.
    * 
    * Example:
    * 'xxxxx' produces '28535'
    * 'xxx-xxx' produces '432-521'
    */
  function generateNumericToken(format) {
      return format.replace(/[x]/g, function(c) {
          var r = Math.random()*10|0;
          var v = r;
          return v.toString(10);
      });
  }
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Display-Username.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "fe5e303b-9ed7-4853-84fe-0ae43e2254d5": {
      "_id": "fe5e303b-9ed7-4853-84fe-0ae43e2254d5",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Display the username in an HTML dialog.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Display Username",
      "script": "file://Display-Username.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Dropdown.script.js 1`] = `
"/* Dropdown
 *
 * Author: volker.scheuber@forgerock.com
 * 
 * Render a dropdown selector
 * 
 * This script does not need to be parametrized. It will work properly as is.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 */
(function () {
  outcome = "true";
  var choices = [" ", "Red pill", "Blue pill", "Steak", "Rabbit hole"];
  
  var fr = JavaImporter(
    org.forgerock.openam.auth.node.api.Action,
    javax.security.auth.callback.ChoiceCallback
  )

  if (callbacks.isEmpty()) {
    action = fr.Action.send([
      new fr.ChoiceCallback("Make your choice", choices, 0, false)
    ]).build();
  } else {
    var choice = parseInt(callbacks.get(0).getSelectedIndexes()[0]);
    nodeState.putShared("choice", choices[choice]);
    action = fr.Action.goTo(outcome).build();
  }
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Dropdown.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "71b3c70b-920c-464b-a918-4c86eaaddccd": {
      "_id": "71b3c70b-920c-464b-a918-4c86eaaddccd",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Render a dropdown",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Dropdown",
      "script": "file://Dropdown.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./FRAAS-7955-Both-States.script.js 1`] = `
"outcome = "true";

setSharedObjectAttribute("userName", "FRAAS-7955");
setSharedObjectAttribute("givenName", "First-shared");
setSharedObjectAttribute("sn", "Last-shared");
setSharedObjectAttribute("mail", "first.last-shared@company.com");

setTransientObjectAttribute("userName", "FRAAS-7955");
setTransientObjectAttribute("givenName", "First-transient");
setTransientObjectAttribute("sn", "Last-transient");
setTransientObjectAttribute("mail", "first.last-transient@company.com");

/*
 * Store attributes in shared state for use with the Create/Patch Object nodes.
 */
function setSharedObjectAttribute(name, value) {
       var storage = sharedState.get("objectAttributes");
    if (storage && value) {
          if (storage.put) {
              storage.put(name, value);
        }
          else {
              storage[name] = value;
        }
    }
    else if (value) {
        sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));
    }
}

/*
 * Store attributes in transient state for use with the Create/Patch Object nodes.
 */
function setTransientObjectAttribute(name, value) {
    var transientStorage = transientState.get("objectAttributes");
    if (transientStorage && value) {
          if (transientStorage.put) {
            transientStorage.put(name, value);
        }
          else {
            transientStorage[name] = value;
        }
    }
    else if (value) {
    transientState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));
    }
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./FRAAS-7955-Both-States.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "38f698de-fe11-43d2-8480-44e1312d121d": {
      "_id": "38f698de-fe11-43d2-8480-44e1312d121d",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "FRAAS-7955 Both States",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "FRAAS-7955 Both States",
      "script": "file://FRAAS-7955-Both-States.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./FRAAS-7955-Display-States.script.js 1`] = `
"/* debug
 *
 * Author: volker.scheuber@forgerock.com
 * 
 * Display sharedState and transientState.
 * 
 * This script does not need to be parametrized. It will work properly as is.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 */
var output = true;

var anchor = "anchor-".concat(generateNumericToken('xxx'));
var halign = "left";
var message = "<h4>Current State Values</h4>".concat(
    "<p><b>Shared State</b>:<br/>").concat(
      sharedState.toString()).concat("</p>").concat(
    "<p><b>Transient State</b>:<br/>").concat(
      transientState.toString()).concat("</p>")
var script = "Array.prototype.slice.call(\\n".concat(
  "document.getElementsByClassName('callback-component')).forEach(\\n").concat(
  "function (e) {\\n").concat(
  "  var message = e.firstElementChild;\\n").concat(
  "  if (message.firstChild && message.firstChild.nodeName == '#text' && message.firstChild.nodeValue.trim() == '").concat(anchor).concat("') {\\n").concat(
  "    message.className = \\"\\";\\n").concat(
  "    message.style = \\"text-align: left; inline-size: 430px; overflow-wrap: break-word;\\";\\n").concat(
  "    message.align = \\"").concat(halign).concat("\\";\\n").concat(
  "    message.innerHTML = '").concat(message).concat("';\\n").concat(
  "  }\\n").concat(
  "})")
var fr = JavaImporter(
    org.forgerock.openam.auth.node.api.Action,
    javax.security.auth.callback.TextOutputCallback,
    com.sun.identity.authentication.callbacks.ScriptTextOutputCallback
)
if (message.length && callbacks.isEmpty()) {
    action = fr.Action.send(
        new fr.TextOutputCallback(
            fr.TextOutputCallback.INFORMATION,
            anchor
        ),
        new fr.ScriptTextOutputCallback(script)
    ).build()
}
else {
  action = fr.Action.goTo("true").build();
}

 /*
  * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.
  * 
  * Example:
  * 'xxxxx' produces '28535'
  * 'xxx-xxx' produces '432-521'
  */
function generateNumericToken(format) {
    return format.replace(/[x]/g, function(c) {
        var r = Math.random()*10|0;
        var v = r;
        return v.toString(10);
    });
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./FRAAS-7955-Display-States.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "164fe425-01e7-4b0b-9f60-fb41f6bf362b": {
      "_id": "164fe425-01e7-4b0b-9f60-fb41f6bf362b",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "FRAAS-7955 Display sharedState and transientState.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "FRAAS-7955 Display States",
      "script": "file://FRAAS-7955-Display-States.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./FRAAS-7955-Shared-State-Only.script.js 1`] = `
"outcome = "true";

setSharedObjectAttribute("userName", "FRAAS-7955");
setSharedObjectAttribute("givenName", "First-shared");
setSharedObjectAttribute("sn", "Last-shared");
setSharedObjectAttribute("mail", "first.last-shared@company.com");

/*
 * Store attributes in shared state for use with the Create/Patch Object nodes.
 */
function setSharedObjectAttribute(name, value) {
       var storage = sharedState.get("objectAttributes");
    if (storage && value) {
          if (storage.put) {
              storage.put(name, value);
        }
          else {
              storage[name] = value;
        }
    }
    else if (value) {
        sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));
    }
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./FRAAS-7955-Shared-State-Only.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "dedbc9f6-7fc9-4332-a330-55f7aeb95e78": {
      "_id": "dedbc9f6-7fc9-4332-a330-55f7aeb95e78",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "FRAAS-7955 Shared State Only",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "FRAAS-7955 Shared State Only",
      "script": "file://FRAAS-7955-Shared-State-Only.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./FRAAS-7955-Show-Object-Values.script.js 1`] = `
"var outcome = true;

// Requires Identify Existing User auth node to retrieve real user ID from IDM
var userid = sharedState.get("_id");

// Retrieve user profile attributes
var userName = idRepository.getAttribute(userid, "uid").iterator().next().toString();
var firstName = idRepository.getAttribute(userid, "givenName").iterator().next().toString();
var lastName = idRepository.getAttribute(userid, "sn").iterator().next().toString();
var email = idRepository.getAttribute(userid, "mail").iterator().next().toString();

var anchor = "anchor-".concat(generateNumericToken('xxx'));
var halign = "left";
var message = "<h4>Object Values</h4>".concat(
    "<p><b>Username</b>: ").concat(userName).concat("</p>").concat(
    "<p><b>First Name</b>: ").concat(firstName).concat("</p>").concat(
    "<p><b>Last Name</b>: ").concat(lastName).concat("</p>").concat(
    "<p><b>Email</b>: ").concat(email).concat("</p>")
var script = "Array.prototype.slice.call(\\n".concat(
  "document.getElementsByClassName('callback-component')).forEach(\\n").concat(
  "function (e) {\\n").concat(
  "  var message = e.firstElementChild;\\n").concat(
  "  if (message.firstChild && message.firstChild.nodeName == '#text' && message.firstChild.nodeValue.trim() == '").concat(anchor).concat("') {\\n").concat(
  "    message.className = \\"text-left\\";\\n").concat(
  "    message.align = \\"").concat(halign).concat("\\";\\n").concat(
  "    message.innerHTML = '").concat(message).concat("';\\n").concat(
  "  }\\n").concat(
  "})")
var fr = JavaImporter(
    org.forgerock.openam.auth.node.api.Action,
    javax.security.auth.callback.TextOutputCallback,
    com.sun.identity.authentication.callbacks.ScriptTextOutputCallback
)
if (message.length && callbacks.isEmpty()) {
    action = fr.Action.send(
        new fr.TextOutputCallback(
            fr.TextOutputCallback.INFORMATION,
            anchor
        ),
        new fr.ScriptTextOutputCallback(script)
    ).build()
}
else {
  action = fr.Action.goTo(outcome).build();
}

 /*
  * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.
  * 
  * Example:
  * 'xxxxx' produces '28535'
  * 'xxx-xxx' produces '432-521'
  */
function generateNumericToken(format) {
    return format.replace(/[x]/g, function(c) {
        var r = Math.random()*10|0;
        var v = r;
        return v.toString(10);
    });
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./FRAAS-7955-Show-Object-Values.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "fbc563cb-eced-4e1b-9cd4-022680347668": {
      "_id": "fbc563cb-eced-4e1b-9cd4-022680347668",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "FRAAS-7955 Show Object Values",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "FRAAS-7955 Show Object Values",
      "script": "file://FRAAS-7955-Show-Object-Values.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./FRAAS-7955-Transient-State-Only.script.js 1`] = `
"outcome = "true";

setTransientObjectAttribute("userName", "FRAAS-7955");
setTransientObjectAttribute("givenName", "First-transient");
setTransientObjectAttribute("sn", "Last-transient");
setTransientObjectAttribute("mail", "first.last-transient@company.com");

/*
 * Store attributes in transient state for use with the Create/Patch Object nodes.
 */
function setTransientObjectAttribute(name, value) {
    var transientStorage = transientState.get("objectAttributes");
    if (transientStorage && value) {
          if (transientStorage.put) {
            transientStorage.put(name, value);
        }
          else {
            transientStorage[name] = value;
        }
    }
    else if (value) {
    transientState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));
    }
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./FRAAS-7955-Transient-State-Only.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "073a64d4-37c9-486d-8c59-6583494644b9": {
      "_id": "073a64d4-37c9-486d-8c59-6583494644b9",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "FRAAS-7955 Transient State Only",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "FRAAS-7955 Transient State Only",
      "script": "file://FRAAS-7955-Transient-State-Only.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./FRAAS-7955-Workaround.script.js 1`] = `
"outcome = "true";
var attrs = sharedState.get("objectAttributes");
if (attrs) {
      setTransientObjectAttribute("givenName", attrs.get("givenName").concat("-workaround"));
      setTransientObjectAttribute("sn", attrs.get("sn").concat("-workaround"));
      setTransientObjectAttribute("mail", attrs.get("mail").concat("-workaround"));
}

/*
 * Store attributes in transient state for use with the Create/Patch Object nodes.
 */
function setTransientObjectAttribute(name, value) {
    var transientStorage = transientState.get("objectAttributes");
    if (transientStorage && value) {
          if (transientStorage.put) {
            transientStorage.put(name, value);
        }
          else {
            transientStorage[name] = value;
        }
    }
    else if (value) {
    transientState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));
    }
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./FRAAS-7955-Workaround.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "e0ba741b-c952-4062-9899-0b1c19237ee4": {
      "_id": "e0ba741b-c952-4062-9899-0b1c19237ee4",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "FRAAS-7955 Workaround: Copy sharedState to transientState",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "FRAAS-7955 Workaround",
      "script": "file://FRAAS-7955-Workaround.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Facebook-Profile-Normalization.script.groovy 1`] = `
"/*
 * Copyright 2020 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

import static org.forgerock.json.JsonValue.field
import static org.forgerock.json.JsonValue.json
import static org.forgerock.json.JsonValue.object

return json(object(
        field("id", rawProfile.id),
        field("displayName", rawProfile.name),
        field("givenName", rawProfile.first_name),
        field("familyName", rawProfile.last_name),
        field("photoUrl", rawProfile.picture.data.url),
        field("email", rawProfile.email),
        field("username", rawProfile.email)))"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Facebook-Profile-Normalization.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "bae1d54a-e97d-4997-aa5d-c027f21af82c": {
      "_id": "bae1d54a-e97d-4997-aa5d-c027f21af82c",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from Facebook",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Facebook Profile Normalization",
      "script": "file://Facebook-Profile-Normalization.script.groovy",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./ForgeRock-Internal:-OAuth2-Access-Token-Modification-Script.script.js 1`] = `
"/*
 * Copyright 2023 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */
// Script is intentionally empty
"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./ForgeRock-Internal:-OAuth2-Access-Token-Modification-Script.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "c234ba0b-58a1-4cfd-9567-09edde980745": {
      "_id": "c234ba0b-58a1-4cfd-9567-09edde980745",
      "context": "OAUTH2_ACCESS_TOKEN_MODIFICATION",
      "createdBy": "null",
      "creationDate": 1433147666269,
      "default": true,
      "description": "Internal token modification script",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "ForgeRock Internal: OAuth2 Access Token Modification Script",
      "script": "file://ForgeRock-Internal:-OAuth2-Access-Token-Modification-Script.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./ForgeRock-Internal:-OIDC-Claims-Script.script.js 1`] = `
"/*
 * Copyright 2014-2023 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

/*
 * This script computes claim values returned in ID tokens and/or at the UserInfo Endpoint.
 * The claim values are computed for:
 * the claims derived from the requested scopes,
 * the claims provided by the authorization server,
 * and the claims requested by the client via the claims parameter.
 *
 * In the CONFIGURATION AND CUSTOMIZATION section, you can
 * define the scope-to-claims mapping, and
 * assign to each claim a resolver function that will compute the claim value.
 *
 * Defined variables (class references are provided below):
 * scopes - Set<String> (6).
 *          Always present, the requested scopes.
 * claims - Map<String, Object> (5).
 *          Always present, default server provided claims.
 * claimObjects - List<Claim> (7, 2).
 *                Always present, the default server provided claims.
 * requestedClaims - Map<String, Set<String>> (5).
 *                   Always present, not empty if the request contains the claims parameter and the server has enabled
 *                   claims_parameter_supported. A map of the requested claims to possible values, otherwise empty;
 *                   requested claims with no requested values will have a key but no value in the map. A key with
 *                   a single value in its Set (6) indicates that this is the only value that should be returned.
 * requestedTypedClaims - List<Claim> (7, 2).
 *                        Always present, the requested claims.
 *                        Requested claims with no requested values will have a claim with no values.
 *                        A claim with a single value indicates this is the only value that should be returned.
 * claimsLocales - List<String> (7).
 *                 The values from the 'claims_locales' parameter.
 *                 See https://openid.net/specs/openid-connect-core-1_0.html#ClaimsLanguagesAndScripts for the OIDC specification details.
 * requestProperties - Unmodifiable Map (5).
 *                     Always present, contains a map of request properties:
 *                     requestUri - The request URI.
 *                     realm - The realm that the request relates to.
 *                     requestParams - A map of the request params and/or posted data.
 *                                     Each value is a list of one or more properties.
 *                                     Please note that these should be handled in accordance with OWASP best practices:
 *                                     https://owasp.org/www-community/vulnerabilities/Unsafe_use_of_Reflection.
 * clientProperties - Unmodifiable Map (5).
 *                    Present if the client specified in the request was identified, contains a map of client properties:
 *                    clientId - The client's URI for the request locale.
 *                    allowedGrantTypes - List of the allowed grant types (org.forgerock.oauth2.core.GrantType) for the client.
 *                    allowedResponseTypes - List of the allowed response types for the client.
 *                    allowedScopes - List of the allowed scopes for the client.
 *                    customProperties - A map of the custom properties of the client.
 *                                       Lists or maps will be included as sub-maps; for example:
 *                                       customMap[Key1]=Value1 will be returned as customMap -> Key1 -> Value1.
 *                                       To add custom properties to a client, update the Custom Properties field
 *                                       in AM Console > Realm Name > Applications > OAuth 2.0 > Clients > Client ID > Advanced.
 * identity - AMIdentity (3).
 *            Always present, the identity of the resource owner.
 * session - SSOToken (4).
 *           Present if the request contains the session cookie, the user's session object.
 * scriptName - String (primitive).
 *              Always present, the display name of the script.
 * logger - Always present, the "OAuth2Provider" debug logger instance:
 *          https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.
 *          Corresponding files will be prefixed with: scripts.OIDC_CLAIMS.
 * httpClient - HTTP Client (8).
 *              Always present, the HTTP Client instance:
 *              https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-http-client.html#scripting-api-global-http-client.
 *              In order to use the client, you may need to add
 *              org.forgerock.http.Client,
 *              org.forgerock.http.protocol.*,
 *              and org.forgerock.util.promise.PromiseImpl
 *              to the allowed Java classes in the scripting engine configuration, as described in:
 *              https://backstage.forgerock.com/docs/am/7/scripting-guide/script-engine-security.html
 *
 * Return - a new UserInfoClaims(Map<String, Object> values, Map<String, List<String>> compositeScopes) (1) object.
 *          The result of the last statement in the script is returned to the server.
 *          Currently, the Immediately Invoked Function Expression (also known as Self-Executing Anonymous Function)
 *          is the last (and only) statement in this script, and its return value will become the script result.
 *          Do not use "return variable" statement outside of a function definition.
 *          See RESULTS section for additional details.
 *
 * Class reference:
 * (1) UserInfoClaims - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html.
 * (2) Claim - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html).
 *         An instance of org.forgerock.openidconnect.Claim has methods to access
 *         the claim name, requested values, locale, and whether the claim is essential.
 * (3) AMIdentity - https://backstage.forgerock.com/docs/am/7/apidocs/com/sun/identity/idm/AMIdentity.html.
 * (4) SSOToken - https://backstage.forgerock.com/docs/am/7/apidocs/com/iplanet/sso/SSOToken.html.
 * (5) Map - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashMap.html,
 *           or https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/LinkedHashMap.html.
 * (6) Set - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashSet.html.
 * (7) List - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/ArrayList.html.
 * (8) Client - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/http/Client.html.
*/

(function () {
    // SETUP

    /**
     * Claim processing utilities.
     * An object that contains reusable functions for processing claims.
     * @see CLAIM PROCESSING UTILITIES section for details.
     */
    var utils = getUtils();

    // CONFIGURATION AND CUSTOMIZATION

    /**
     * OAuth 2.0 scope values (scopes) can be used by the Client to request OIDC claims.
     *
     * Call this configuration method, and pass in as the first argument
     * an object that maps a scope value to an array of claim names
     * to specify which claims need to be processed and returned for the requested scopes.
     * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#ScopeClaims}
     * for the scope values that could be used to request claims as defined in the OIDC specification.
     *
     * Below, find a default configuration that is expected to work in the current environment.
     *
     * CUSTOMIZATION
     * You can choose the claim names returned for a scope.
     */
    utils.setScopeClaimsMap({
        profile: [
            'name',
            'family_name',
            'given_name',
            'zoneinfo',
            'locale'
        ],
        email: ['email'],
        address: ['address'],
        phone: ['phone_number']
    });

    /**
     * In this script, each claim
     * derived from the requested scopes,
     * provided by the authorization server, and
     * requested by the client via the claims parameter
     * will be processed by a function associated with the claim name.
     *
     * Call this configuration method, and pass in as the first argument
     * an object that maps a claim name to a resolver function,
     * which will be automatically executed for each claim processed by the script.
     *
     * The claim resolver function will receive the requested claim information
     * in an instance of org.forgerock.openidconnect.Claim as the first argument.
     * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html}
     * for details on the Claim class.
     *
     * If the claim resolver function returns a value,
     * other than undefined or null,
     * the claim will be included in the script's results.
     *
     * The Claim instance provides methods to check
     * what the name of the claim is,
     * which values the claim request contains,
     * whether the claim is essential, and
     * which locale the claim is associated with.
     * The resolver function can consider this information when computing and returning the claim value.
     *
     * Below, find a default configuration that is expected to work in the current environment.
     * A reusable function, utils.getUserProfileClaimResolver(String attribute-name),
     * is called to return a claim resolver function based on a user profile attribute.
     * @see CLAIM RESOLVERS section for the implementation details and examples.
     * For the address claim, an example of a claim resolver that uses another claim resolver is provided.
     *
     * CUSTOMIZATION
     * You can reuse the predefined utils methods with your custom arguments.
     * You can also specify a custom resolver function for a claim name,
     * that will compute and return the claim value—as shown in the commented out example below.
     */
    utils.setClaimResolvers({
        /*
        // An example of a simple claim resolver function that is defined for a claim
        // directly in the configuration object:
        custom-claim-name: function (requestedClaim) {
            // In this case, initially, the claim value comes straight from a user profile attribute value:
            var claimValue = identity.getAttribute('custom-attribute-name').toArray()[0]

            // Optionally, provide additional logic for processing (filtering, formatting, etc.) the claim value.
            // You can use:
            // requestedClaim.getName()
            // requestedClaim.getValues()
            // requestedClaim.getLocale()
            // requestedClaim.isEssential()

            return claimValue
        },
        */
        /**
         * The use of utils.getUserProfileClaimResolver shows how
         * an argument passed to a function that returns a claim resolver
         * becomes available to the resolver function (via its lexical context).
         */
        name: utils.getUserProfileClaimResolver('cn'),
        family_name: utils.getUserProfileClaimResolver('sn'),
        given_name: utils.getUserProfileClaimResolver('givenname'),
        zoneinfo: utils.getUserProfileClaimResolver('preferredtimezone'),
        locale: utils.getUserProfileClaimResolver('preferredlocale'),
        email: utils.getUserProfileClaimResolver('mail'),
        address: utils.getAddressClaimResolver(
            /**
             * The passed in user profile claim resolver function
             * can be used by the address claim resolver function
             * to obtain the claim value to be formatted as per the OIDC specification:
             * @see https://openid.net/specs/openid-connect-core-1_0.html#AddressClaim.
             */
            utils.getUserProfileClaimResolver('postaladdress')
        ),
        phone_number: utils.getUserProfileClaimResolver('telephonenumber')
    });

    // CLAIM PROCESSING UTILITIES

    /**
     * @returns {object} An object that contains reusable claim processing utilities.
     * @see PUBLIC METHODS section and the return statement for the list of exported functions.
     */
    function getUtils () {
        // IMPORT JAVA

        /**
         * Provides Java scripting functionality.
         * @see {@link https://developer.mozilla.org/en-US/docs/Mozilla/Projects/Rhino/Scripting_Java#javaimporter_constructor}.
         */
        var frJava = JavaImporter(
            org.forgerock.oauth2.core.exceptions.InvalidRequestException,
            org.forgerock.oauth2.core.UserInfoClaims,
            org.forgerock.openidconnect.Claim,

            java.util.LinkedHashMap,
            java.util.ArrayList
        );

        // SET UP CONFIGURATION

        /**
         * Placeholder for a configuration option that contains
         * an object that maps the supported scope values (scopes)
         * and the corresponding claim names for each scope value.
         */
        var scopeClaimsMap;

        /**
         * Placeholder for a configuration option that contains
         * an object that maps the supported claim names
         * and the resolver functions returning the claim value.
         */
        var claimResolvers;

        /**
         * A (public) method that accepts an object that maps the supported scopes and the corresponding claim names,
         * and assigns it to a (private) variable that serves as a configuration option.
         * @param {object} params - An object that maps each supported scope value to an array of claim names,
         * in order to specify which claims need to be processed for the requested scopes.
         * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#ScopeClaims} for details.
         * @param {string[]} [params.profile] - An array of claim names to be returned if the profile scope is requested.
         * @param {string[]} [params.email] - An array of claim names to be returned if the email scope is requested.
         * @param {string[]} [params.address] - An array of claim names to be returned if the address scope is requested.
         * @param {string[]} [params.phone] - An array of claim names to be returned if the phone scope is requested.
         * @returns {undefined}
         */
        function setScopeClaimsMap(params) {
            scopeClaimsMap = params;
        }

        /**
         * A (public) method that accepts an object that maps the supported claim names
         * and the resolver functions returning the claim value,
         * and assigns it to a (private) variable that serves as a configuration option.
         * @param {object} params - An object that maps
         * each supported claim name to a function that computes and returns the claim value.
         */
        function setClaimResolvers(params) {
            claimResolvers = params;
        }

        // CLAIM RESOLVERS

        /**
         * Claim resolvers are functions that return a claim value.
         * @param {*}
         * @returns {*}
         */

        /**
         * Defines a claim resolver based on a user profile attribute.
         * @param {string} attributeName - Name of the user profile attribute.
         * @returns {function} A function that will determine the claim value
         * based on the user profile attribute and the (requested) claim properties.
         */
        function getUserProfileClaimResolver (attributeName) {
            /**
             * Resolves a claim with a user profile attribute value.
             * Returns undefined if the identity attribute is not populated,
             * OR if the claim has requested values that do not contain the identity attribute value.
             * ATTENTION: the aforementioned comparison is case-sensitive.
             * @param {org.forgerock.openidconnect.Claim} claim
             * An object that provides methods to obtain information/requirements associated with a claim.
             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.
             * @returns {string|HashSet|undefined}
             */
            function resolveClaim(claim) {
                var userProfileValue;

                if (identity) {
                    userProfileValue = getClaimValueFromSet(claim, identity.getAttribute(attributeName));

                    if (userProfileValue && !userProfileValue.isEmpty()) {
                        if (!claim.getValues() || claim.getValues().isEmpty() || claim.getValues().contains(userProfileValue)) {
                            return userProfileValue;
                        }
                    }
                }
            }

            return resolveClaim;
        }

        /**
         * Returns an address claim resolver based on a claim value obtained with another claim resolver.
         * @param {function} resolveClaim - A function that returns a claim value.
         * @returns {function} A function that will accept a claim as an argument,
         * run the claim resolver function for the claim and obtain the claim value,
         * and apply additional formatting to the value before returning it.
         */
        function getAddressClaimResolver (resolveClaim) {
            /**
             * Creates an address claim object from a value returned by a claim resolver,
             * and returns the address claim object as the claim value.
             * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#AddressClaim}.
             * The claim value is obtained with a claim resolving function available from the closure.
             * @param {org.forgerock.openidconnect.Claim} claim
             * An object that provides methods to obtain information/requirements associated with a claim.
             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.
             * @returns {java.util.LinkedHashMap|undefined} The address claim object created from a claim value.
             */
            function resolveAddressClaim(claim) {
                var claimValue = resolveClaim(claim);
                var addressObject;

                if (isClaimValueValid(claimValue)) {
                    addressObject = new frJava.LinkedHashMap();

                    addressObject.put('formatted', claimValue);

                    return addressObject;
                }
            }

            return resolveAddressClaim;
        }

        /**
         * Returns an essential claim resolver based on a claim value obtained with another claim resolver.
         * @param {function} resolveClaim - A function that returns a claim value.
         * @returns {function} A function that will accept a claim as an argument,
         * run the claim resolver function for the claim and obtain the claim value,
         * and apply additional logic for essential claims.
         */
        function getEssentialClaimResolver (resolveClaim) {
            /**
             * Returns a claim value or throws an error.
             * The claim value is obtained with a claim resolving function available from the closure.
             * Throws an exception if the claim is essential and no value is returned for the claim.
             *
             * Use of this resolver is optional.
             * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#IndividualClaimsRequests} stating:
             * "Note that even if the Claims are not available because the End-User did not authorize their release or they are not present,
             * the Authorization Server MUST NOT generate an error when Claims are not returned, whether they are Essential or Voluntary,
             * unless otherwise specified in the description of the specific claim."
             *
             * @param {org.forgerock.openidconnect.Claim} claim
             * An object that provides methods to obtain information/requirements associated with a claim.
             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.
             * @returns {*}
             * @throws {org.forgerock.oauth2.core.exceptions.InvalidRequestException}
             */
            function resolveEssentialClaim(claim) {
                var claimValue = resolveClaim(claim);

                if (claim.isEssential() && !isClaimValueValid(claimValue)) {
                    throw new frJava.InvalidRequestException('Could not provide value for essential claim: ' + claim.getName());
                }

                return claimValue;
            }

            return resolveEssentialClaim;
        }

        /**
         * Provides default resolution for a claim.
         * Use it if a claim-specific resolver is not defined in the configuration.
         * @param {org.forgerock.openidconnect.Claim} claim
         * An object that provides methods to obtain information/requirements associated with a claim.
         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.
         * @returns {*} A single value associated with this claim.
         */
        function resolveAnyClaim (claim) {
            if (claim.getValues().size() === 1) {
                return claim.getValues().toArray()[0];
            }
        }

        // UTILITIES

        /**
         * Returns claim value from a set.
         * If the set contains a single value, returns the value.
         * If the set contains multiple values, returns the set.
         * Otherwise, returns undefined.
         *
         * @param {org.forgerock.openidconnect.Claim} claim
         * An object that provides methods to obtain information/requirements associated with a claim.
         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.
         * @param {java.util.HashSet} set The set—for example, a user profile attribute value.
         * @returns {string|java.util.HashSet|undefined}
         */
        function getClaimValueFromSet (claim, set) {
            if (set && set.size()) {
                if (set.size() === 1) {
                    return set.toArray()[0];
                } else {
                    return set;
                }
            } else if (logger.warningEnabled()) {
                logger.warning('OIDC Claims script. Got an empty set for claim: ' + claim.getName());
            }
        }

        function isClaimValueValid (claimValue) {
            if (typeof claimValue === 'undefined' || claimValue === null) {
                return false;
            }

            return true;
        }

        // CLAIM PROCESSING

        /**
         * Constructs and returns an object populated with the computed claim values
         * and the requested scopes mapped to the claim names.
         * @returns {org.forgerock.oauth2.core.UserInfoClaims} The object to be returned to the authorization server.
         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html}.
         * @see RESULTS section for the use of this function.
         */
        function getUserInfoClaims () {
            return new frJava.UserInfoClaims(getComputedClaims(), getCompositeScopes());
        }

        /**
         * Creates a map of (requested) claim names populated with the computed claim values.
         * @returns {java.util.LinkedHashMap}
         * A map of the requested claim names and the corresponding claim values.
         */
        function getComputedClaims () {
            /**
             * Creates a complete list of claim objects from:
             * the claims derived from the scopes,
             * the claims provided by the authorization server,
             * and the claims requested by the client.
             * @returns {java.util.ArrayList}
             * Returns a complete list of org.forgerock.openidconnect.Claim objects available to the script.
             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for the claim object details.
             */
            function getClaims() {
                /**
                 * Returns a list of claim objects for the requested scopes.
                 * Uses the scopeClaimsMap configuration option to derive the claim names;
                 * no other properties of a claim derived from a scope are populated.
                 * @returns {java.util.ArrayList}
                 * A list of org.forgerock.openidconnect.Claim objects derived from the requested scopes.
                 * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for the claim object details.
                 */
                function convertScopeToClaims() {
                    var claims = new frJava.ArrayList();

                    scopes.toArray().forEach(function (scope) {
                        if (String(scope) !== 'openid' && scopeClaimsMap[scope]) {
                            scopeClaimsMap[scope].forEach(function (claimName) {
                                claims.add(new frJava.Claim(claimName));
                            });
                        }
                    });

                    return claims;
                }

                var claims = new frJava.ArrayList();

                claims.addAll(convertScopeToClaims());
                claims.addAll(claimObjects);
                claims.addAll(requestedTypedClaims);

                return claims;
            }

            /**
             * Computes and returns a claim value.
             * To obtain the claim value, uses the resolver function specified for the claim in the claimResolvers configuration object.
             * @see claimResolvers
             * If no resolver function is found, uses the default claim resolver function.
             *
             * @param {org.forgerock.openidconnect.Claim} claim
             * An object that provides methods to obtain information/requirements associated with a claim.
             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.
             * @returns {*} Claim value.
             * @throws {org.forgerock.oauth2.core.exceptions.InvalidRequestException}
             * Rethrows this exception if a claim resolver throws it.
             * You can throw org.forgerock.oauth2.core.exceptions.InvalidRequestException from your custom claim resolver
             * if you want to terminate the claim processing.
             */
            function computeClaim(claim) {
                var resolveClaim;
                var message;

                try {
                    resolveClaim = claimResolvers[claim.getName()] || resolveAnyClaim;

                    return resolveClaim(claim);
                } catch (e) {
                    message = 'OIDC Claims script exception. Unable to resolve OIDC Claim. ' + e;

                    if (String(e).indexOf('org.forgerock.oauth2.core.exceptions.InvalidRequestException') !== -1) {
                        throw e;
                    }

                    if (logger.warningEnabled()) {
                        logger.warning(message);
                    }
                }
            }

            var computedClaims = new frJava.LinkedHashMap();

            getClaims().toArray().forEach(function (claim) {
                var claimValue = computeClaim(claim);

                if (isClaimValueValid(claimValue)) {
                    computedClaims.put(claim.getName(), claimValue);
                } else {
                    /**
                     * If a claim has been processed, but appears in the list again,
                     * and its value cannot be computed under the new conditions,
                     * the claim is removed from the final result.
                     *
                     * For example, a claim could be mapped to a scope and found in the user profile,
                     * but also requested by the client with required values that don't match the computed one.
                     * @see {link https://openid.net/specs/openid-connect-core-1_0.html#IndividualClaimsRequests}.
                     * for the relevant OIDC specification details.
                     */
                    computedClaims.remove(claim.getName());
                }
            });

            return computedClaims;
        }

        /**
         * Creates a map of requested scopes and the corresponding claim names.
         * @returns {java.util.LinkedHashMap}
         */
        function getCompositeScopes () {
            var compositeScopes = new frJava.LinkedHashMap();

            scopes.toArray().forEach(function (scope) {
                var scopeClaims = new frJava.ArrayList();

                if (scopeClaimsMap[scope]) {
                    scopeClaimsMap[scope].forEach(function (claimName) {
                        scopeClaims.add(claimName);
                    });
                }

                if (scopeClaims.size()) {
                    compositeScopes.put(scope, scopeClaims);
                }
            });

            return compositeScopes;
        }

        // PUBLIC METHODS

        return {
            setScopeClaimsMap: setScopeClaimsMap,
            setClaimResolvers: setClaimResolvers,
            getUserProfileClaimResolver: getUserProfileClaimResolver,
            getAddressClaimResolver: getAddressClaimResolver,
            getEssentialClaimResolver: getEssentialClaimResolver,
            getUserInfoClaims: getUserInfoClaims
        };
    }

    // RESULTS

    /**
     * This script returns an instance of the org.forgerock.oauth2.core.UserInfoClaims class
     * populated with the computed claim values and
     * the requested scopes mapped to the claim names.
     * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html}.
     *
     * Assigning it to a variable gives you an opportunity
     * to log the content of the returned value during development.
     */
    var userInfoClaims = utils.getUserInfoClaims();

    /*
    logger.error(scriptName + ' results:')
    logger.error('Values: ' + userInfoClaims.getValues())
    logger.error('Scopes: ' + userInfoClaims.getCompositeScopes())
    */

    return userInfoClaims;
}());
"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./ForgeRock-Internal:-OIDC-Claims-Script.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "1f389a3d-21cf-417c-a6d3-42ea620071f0": {
      "_id": "1f389a3d-21cf-417c-a6d3-42ea620071f0",
      "context": "OIDC_CLAIMS",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Internal OIDC Claims script",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "ForgeRock Internal: OIDC Claims Script",
      "script": "file://ForgeRock-Internal:-OIDC-Claims-Script.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./ForgeRockVpnOnly.script.js 1`] = `
"/*
  - Data made available by nodes that have already executed are available in the sharedState variable.
  - The script should set outcome to either "true" or "false".
 */

var validIpAddresses = [
  "37.71.148.92", // FR Grenoble
  "84.214.156.50", // FR Oslo
  "180.255.64.26", // FR Singapore
  "128.106.105.136", // FR Singapore Sales
  "188.39.235.130", // FR Bristol
  "78.33.22.162", // FR Bristol Marsh Street
  "65.113.98.10", // FR San Francisco
  "24.155.146.18" // FR Austin
];

try {
  outcome = function() {
    logger.message(requestHeaders);
    var vpnBypassSecret = systemEnv.getProperty('esv.amadmin.vpn.bypass.secret', '') + '';
    var bypassHeader = requestHeaders.get(new java.lang.String('x-forgerock-tests-bearer'));
    logger.message("checking for VPN bypass - header {} to match secret {}", bypassHeader, vpnBypassSecret);
    if (vpnBypassSecret && bypassHeader && bypassHeader.size() === 1) {
      logger.message("bypass header is present");
      if (bypassHeader.get(0) + '' === vpnBypassSecret + '') {
        logger.warning("bypassing VPN check - request from tests authorized");
        return 'True';
      }
    }
    var clientIpAddresses = requestHeaders.get(new java.lang.String('x-forwarded-for'));
    logger.message(clientIpAddresses);
    if (!clientIpAddresses) {
      logger.message("No forwarded header - internal cluster request");
      return 'True';
    }
    for (var i = 0; i < clientIpAddresses.size(); i++) {
      var clientIpHeader = clientIpAddresses.get(i);
      var ipAddresses = clientIpHeader.split(',');
      for (var j = 0; j < ipAddresses.length; j++) {
        var clientIp = ipAddresses[j].trim();
        logger.message('Checking client IP ' + clientIp);
        for (var k = 0; k < validIpAddresses.length; k++) {
          if (clientIp + '' === validIpAddresses[k]) {
            logger.warning("request from ForgeRock VPN authorized");
            return 'True';
          }
        }
      }
    }
    logger.warning("request from outside the cluster and not from ForgeRock VPN rejected");
    return 'False';
  }();

} catch (e) {

  logger.error('ForgeRockVpnOnly failed to check IP');
  logger.error(e);
  outcome = 'Error';

}
"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./ForgeRockVpnOnly.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "779bb956-676d-4e44-b828-b9efa3c866d4": {
      "_id": "779bb956-676d-4e44-b828-b9efa3c866d4",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "ForgeRockVpnOnly",
      "script": "file://ForgeRockVpnOnly.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Get-Email.script.js 1`] = `
"logger.error("Get Email: start");
outcome = "true";
if (getProfileAttribute("mail")) {
  setSharedObjectAttribute("mail", getProfileAttribute("mail"));
}
logger.error("Get Email: end");

/*
 * Get profile attribute
 */
function getProfileAttribute(name) {
    return idRepository.getAttribute(sharedState.get("_id"), name).iterator().next();
}

/*
 * Properly set attributes in shared state for use with the Create/Patch Object nodes.
 */
function setSharedObjectAttribute(name, value) {
    if (sharedState.get("objectAttributes")) {
        sharedState.get("objectAttributes").put(name, value);
    }
    else {
        sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":"+value+"}"));
    }
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Get-Email.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "d6469639-249f-4df1-9e03-335cd3e37b3d": {
      "_id": "d6469639-249f-4df1-9e03-335cd3e37b3d",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Get Email",
      "script": "file://Get-Email.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Get-Lockout-Status.script.js 1`] = `
"outcome = "true";

var username = sharedState.get("_id")
var lockoutDataAttr = "sunAMAuthInvalidAttemptsData"
var accountStatusAttr = "inetUserStatus"

var lockoutData = idRepository.getAttribute(username, lockoutDataAttr)
var accountStatus = idRepository.getAttribute(username, accountStatusAttr)

transientState.put("lockoutData", lockoutData)
transientState.put("accountStatus", accountStatus)

logger.error(lockoutData.toString())"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Get-Lockout-Status.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "cdea92a1-d2bf-4364-a525-fde8b7a95792": {
      "_id": "cdea92a1-d2bf-4364-a525-fde8b7a95792",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Get Lockout Status",
      "script": "file://Get-Lockout-Status.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./GitHub-Profile-Normalization.script.groovy 1`] = `
"/*
 * Copyright 2022 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

import static org.forgerock.json.JsonValue.field
import static org.forgerock.json.JsonValue.json
import static org.forgerock.json.JsonValue.object

return json(object(
        field("id", rawProfile.id),
        field("displayName", rawProfile.name),
        field("username", rawProfile.login)))"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./GitHub-Profile-Normalization.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "a7a78773-445b-4eca-bb93-409e86bced81": {
      "_id": "a7a78773-445b-4eca-bb93-409e86bced81",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from GitHub",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "GitHub Profile Normalization",
      "script": "file://GitHub-Profile-Normalization.script.groovy",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./GitHub-Profile-Normalization-(VS).script.groovy 1`] = `
"/*
 * Copyright 2020 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

import static org.forgerock.json.JsonValue.field
import static org.forgerock.json.JsonValue.json
import static org.forgerock.json.JsonValue.object

logger.warning("GitHub rawProfile: "+rawProfile)

return json(object(
        field("id", rawProfile.id),
        field("displayName", rawProfile.name),
        field("givenName", rawProfile.first_name),
        field("familyName", rawProfile.last_name),
        field("photoUrl", rawProfile.picture.data.url),
        field("email", rawProfile.email),
        field("username", rawProfile.email)))"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./GitHub-Profile-Normalization-(VS).script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "23143919-6b78-40c3-b25e-beca19b229e0": {
      "_id": "23143919-6b78-40c3-b25e-beca19b229e0",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Normalizes raw profile data from GitHub",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "GitHub Profile Normalization (VS)",
      "script": "file://GitHub-Profile-Normalization-(VS).script.groovy",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Google-Profile-Normalization.script.groovy 1`] = `
"/*
 * Copyright 2020 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

import static org.forgerock.json.JsonValue.field
import static org.forgerock.json.JsonValue.json
import static org.forgerock.json.JsonValue.object

return json(object(
        field("id", rawProfile.sub),
        field("displayName", rawProfile.name),
        field("givenName", rawProfile.given_name),
        field("familyName", rawProfile.family_name),
        field("photoUrl", rawProfile.picture),
        field("email", rawProfile.email),
        field("username", rawProfile.email),
        field("locale", rawProfile.locale)))"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Google-Profile-Normalization.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "58d29080-4563-480b-89bb-1e7719776a21": {
      "_id": "58d29080-4563-480b-89bb-1e7719776a21",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from Google",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Google Profile Normalization",
      "script": "file://Google-Profile-Normalization.script.groovy",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Goto-Specified-Decision.script.js 1`] = `
"/* Goto Specified Decision
 * 
 * Return true if a goto param has been specified, false otherwise.
 * 
 * This script does not require configuration. It will work properly as is.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 * - false
 *
 * Author: volker.scheuber@forgerock.com
 */
(function () {
    logger.message("Goto Specified Decision: start");
      outcome = "false";
      var referer = parseUrl(requestHeaders.get("referer").get(0));
      if (referer.searchParam.goto) {
          outcome = "true";
    }
    logger.message("Goto Specified Decision: end [outcome={}]", outcome);

    /*
     * Parse a URL into its components and make them easily accessible by name
     *
     * Use in a Scripte Decision Node Script as follows:
     * var referer = parseUrl(requestHeaders.get("referer").get(0));
     * var origin = referer.origin;
     * 
     * e.g.: https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/
     * {
     *     hash: '#/',
     *     host: 'openam-volker-dev.forgeblocks.com',
     *     hostname: 'openam-volker-dev.forgeblocks.com',
     *     href: 'https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/',
     *     origin: 'https://openam-volker-dev.forgeblocks.com',
     *     pathname: '/am/XUI/',
     *     port: '',
     *     protocol: 'https',
     *     search: '?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim',
     *     username: '',
     *     password: '',
     *     searchParam: {
     *         realm: '/bravo',
     *         authIndexType: 'service',
     *         authIndexValue: 'InitiateOwnerClaim'
     *     }
     * }
     */
    function parseUrl(href) {
        var m = href.match(/^(([^:\\/?#]+):?(?:\\/\\/((?:([^\\/?#:]*):([^\\/?#:]*)@)?([^\\/?#:]*)(?::([^\\/?#:]*))?)))?([^?#]*)(\\?[^#]*)?(#.*)?$/),
        r = {
            hash: m[10] || "",                      // #/
            host: m[3] || "",                       // openam-volker-dev.forgeblocks.com
            hostname: m[6] || "",                   // openam-volker-dev.forgeblocks.com
            href: m[0] || "",                       // https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/
            origin: m[1] || "",                     // https://openam-volker-dev.forgeblocks.com
            pathname: m[8] || (m[1] ? "/" : ""),    // /am/XUI/
            port: m[7] || "",                       // 
            protocol: m[2] || "",                   // https
            search: m[9] || "",                     // ?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim
            username: m[4] || "",                   // 
            password: m[5] || "",                   // 
            searchParam: {}                         // { realm: '/bravo',
                                                    //   authIndexType: 'service',
                                                    //   authIndexValue: 'InitiateOwnerClaim' }
        };
        if (r.protocol.length == 2) {
            r.protocol = "file:///" + r.protocol.toUpperCase();
            r.origin = r.protocol + "//" + r.host;
        }
        if (r.search.length > 2) {
            var query = (r.search.indexOf('?') === 0) ? r.search.substr(1) : r.search;
            var vars = query.split('&');
            for (var i = 0; i < vars.length; i++) {
            var pair = vars[i].split('=');
            r.searchParam[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1]);
            }
        }
        r.href = r.origin + r.pathname + r.search + r.hash;
        return r;
    };
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Goto-Specified-Decision.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "2a076e9e-75a9-46b5-b971-10ffafbdf652": {
      "_id": "2a076e9e-75a9-46b5-b971-10ffafbdf652",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Return true if a goto param has been specified, false otherwise.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Goto Specified Decision",
      "script": "file://Goto-Specified-Decision.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./HIBP-Password-Breach-Analysis.script.js 1`] = `
"/* HIBP Password Breach Analysis
 *
 * Authors: jon.knight@forgerock.com, volker.scheuber@forgerock.com
 * 
 * Use Have I Been Pwned Password to check if password has been breached.
 * Calls HIBP API to retrieve the count of matching passwords in breached 
 * password database
 * 
 * This script needs to be parametrized. It will not work properly as is. 
 * It requires the Password or Platform Password collector nodes before
 * it can operate.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - clear
 *   The number of breaches for password was either zero or less than the 
 *   value of THRESHOLD
 * - breached 
 *   The number of incidents of the password in the breached password 
 *   database exceeds THRESHOLD
 * - failed
 *   The API call was rejected.
 */
(function () {
    var USER_AGENT="ForgeRock";
    var HIBP_API_KEY=systemEnv.getProperty("esv.hibp.api.key");
    var THRESHOLD=0;

    function toHexString(byteArray) {
        var s = '';
        byteArray.forEach(function(byte) {
            s += ('0' + (byte & 0xFF).toString(16)).slice(-2);
        });
        return s;
    }

    outcome = "failed";

    var md = java.security.MessageDigest.getInstance('SHA-1');
      var password = nodeState.get("password").asString();
//      var password = new java.lang.String("");
//      if (nodeState.get("password")) {
//      password = nodeState.get("password").asString();
//    }
    var byteArray = password.getBytes("UTF-8");
    md.update(byteArray);
    var digest = md.digest();
    var hex = String(toHexString(digest)).toUpperCase();

    var request = new org.forgerock.http.protocol.Request();
    request.setMethod('GET');
    request.setUri('https://api.pwnedpasswords.com/range/' + hex.substring(0,5));
    request.getHeaders().add("Accept","*/*");
    request.getHeaders().add("Content-Type","application/json");
    request.getHeaders().add("User-Agent", USER_AGENT);
    request.getHeaders().add("hibp-api-key", HIBP_API_KEY);

    var response = httpClient.send(request).get();

    if (response.getStatus().getCode() === 200) {
        var max = 0;
        outcome = "clear";
        var result = response.getEntity().getString();
        var lines = result.split('\\n');
        for (i=0; i<lines.length; i++) {
            var prefix = lines[i].split(':')[0];
            if (String(hex.substring(0,5) + prefix) == hex) {
                var count = lines[i].split(':')[1];
                if (count > max) max = count;
            }
        }
        if (max > THRESHOLD) outcome = "breached";
        sharedState.put("hibp_password_count", max);
    }
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./HIBP-Password-Breach-Analysis.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "790045fa-a325-4e3e-96f8-d4a91b32e9de": {
      "_id": "790045fa-a325-4e3e-96f8-d4a91b32e9de",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Use Have I Been Pwned Password to check if password has been breached.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "HIBP Password Breach Analysis",
      "script": "file://HIBP-Password-Breach-Analysis.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Has-Profile-Changed.script.js 1`] = `
"logger.error("Has Profile Changed: start");
outcome = "unchanged";
if (getObjectAttribute("old_givenName") ||
    getObjectAttribute("old_sn") ||
    getObjectAttribute("frUnindexedString5") ||
    getObjectAttribute("old_telephoneNumber")) {
  outcome = "changed";
}
logger.error("Has Profile Changed: end [outcome=".concat(outcome).concat("]"));

/*
 * Get objectAttribute value
 */
function getObjectAttribute(name) {
    if (sharedState.get("objectAttributes") && sharedState.get("objectAttributes").get(name)) {
        return sharedState.get("objectAttributes").get(name).toString();
    }
    else {
        return null;
    }
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Has-Profile-Changed.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "2ada53cd-5d37-4592-9c7f-5711271229c2": {
      "_id": "2ada53cd-5d37-4592-9c7f-5711271229c2",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Has Profile Changed",
      "script": "file://Has-Profile-Changed.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./IDP-Integrity-Check.script.js 1`] = `
"/* IDP Integrity Check
 * 
 * Protection from malicious IDPs. Only allow white-listed email domains (usernames are email addresses).
 * 
 * This script does not require cofiguration. It will work properly as is.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 * - false
 *
 * Author: volker.scheuber@forgerock.com
 */
(function () {
    outcome = "false";
      var routedIDP = sharedState.get("routedIDPs").get(0);
      var validDomains = [];
      if (routedIDP) {
          validDomains = routedIDP.get("idpDomains");
    }
      
      var username = sharedState.get("username");
      var domain = username.substr(username.lastIndexOf("@")+1);
      if (validDomains.indexOf(domain) > -1) {
          outcome = "true";
    }
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./IDP-Integrity-Check.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "988c10fa-98da-4bf7-8ac9-a558d2fef1fd": {
      "_id": "988c10fa-98da-4bf7-8ac9-a558d2fef1fd",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Protection from malicious IDPs. Only allow white-listed email domains (usernames are email addresses).",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "IDP Integrity Check",
      "script": "file://IDP-Integrity-Check.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./IDP-Lookup.script.js 1`] = `
"/* IDP Lookup
 * 
 * Perform IDP lookup based on email domain. Set users' external IDP in shared state or continue to local authentication.
 * 
 * This script requires parametrization. Make sure you carefully review the configuration parameters.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - one
 * - multiple
 * - none
 *
 * Author: volker.scheuber@forgerock.com
 */
(function () {
    logger.message("IDP Lookup: start");
      outcome = "none";
      var username = sharedState.get("username");
      var domain = username.substr(username.lastIndexOf("@")+1);
      var referer = parseUrl(requestHeaders.get("referer").get(0));

      /* Begin Configuration */
  
    // long-lived token
    var IDM_API_TOKEN = systemEnv.getProperty("esv.admin.token");
  
    // IDM API Configuration
    var IDM_API_URI = referer.origin + "/openidm/managed/alpha_organization?_queryFilter=idpDomains+co+'" + domain + "'&_fields=name,description,idpName,idpType,idpDomains,idpJourney,idpTheme,idpPersist,samlConfig";

      /* End Configuration */

    var request = new org.forgerock.http.protocol.Request();
    request.setMethod('GET');
    request.setUri(IDM_API_URI);
    request.getHeaders().add("Content-Type", "application/json; charset=UTF-8");
    request.getHeaders().add("Authorization", "Bearer " + IDM_API_TOKEN);

    var response = httpClient.send(request).get();
    var result = JSON.parse(response.getEntity().getString());
    logger.message("IDP Lookup: JSON result: " + JSON.stringify(result));
    
      var routedIDPs = result.result.length ? result.result : [{}];
      // stringify the samlConfig property
      routedIDPs.forEach(function (routedIDP, index) {
          routedIDPs[index].samlConfig = JSON.stringify(routedIDP.samlConfig);
    });
      sharedState.put("routedIDPs", routedIDPs);
    if (result.resultCount === 1) {
        logger.message("IDP Lookup: Found exactly 1 IDP");
        outcome = "one";
    }
      else if (result.resultCount > 1) {
        logger.message("IDP Lookup: Found {} IDPs", result.resultCount);
        outcome = "multiple";
    }
      else {
        logger.message("IDP Lookup: Found no IDPs");
    }
    logger.message("IDP Lookup: end [outcome={}]", outcome);

    /*
     * Parse a URL into its components and make them easily accessible by name
     *
     * Use in a Scripte Decision Node Script as follows:
     * var referer = parseUrl(requestHeaders.get("referer").get(0));
     * var origin = referer.origin;
     * 
     * e.g.: https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/
     * {
     *     hash: '#/',
     *     host: 'openam-volker-dev.forgeblocks.com',
     *     hostname: 'openam-volker-dev.forgeblocks.com',
     *     href: 'https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/',
     *     origin: 'https://openam-volker-dev.forgeblocks.com',
     *     pathname: '/am/XUI/',
     *     port: '',
     *     protocol: 'https',
     *     search: '?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim',
     *     username: '',
     *     password: '',
     *     searchParam: {
     *         realm: '/bravo',
     *         authIndexType: 'service',
     *         authIndexValue: 'InitiateOwnerClaim'
     *     }
     * }
     */
    function parseUrl(href) {
        var m = href.match(/^(([^:\\/?#]+):?(?:\\/\\/((?:([^\\/?#:]*):([^\\/?#:]*)@)?([^\\/?#:]*)(?::([^\\/?#:]*))?)))?([^?#]*)(\\?[^#]*)?(#.*)?$/),
        r = {
            hash: m[10] || "",                      // #/
            host: m[3] || "",                       // openam-volker-dev.forgeblocks.com
            hostname: m[6] || "",                   // openam-volker-dev.forgeblocks.com
            href: m[0] || "",                       // https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/
            origin: m[1] || "",                     // https://openam-volker-dev.forgeblocks.com
            pathname: m[8] || (m[1] ? "/" : ""),    // /am/XUI/
            port: m[7] || "",                       // 
            protocol: m[2] || "",                   // https
            search: m[9] || "",                     // ?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim
            username: m[4] || "",                   // 
            password: m[5] || "",                   // 
            searchParam: {}                         // { realm: '/bravo',
                                                    //   authIndexType: 'service',
                                                    //   authIndexValue: 'InitiateOwnerClaim' }
        };
        if (r.protocol.length == 2) {
            r.protocol = "file:///" + r.protocol.toUpperCase();
            r.origin = r.protocol + "//" + r.host;
        }
        if (r.search.length > 2) {
            var query = (r.search.indexOf('?') === 0) ? r.search.substr(1) : r.search;
            var vars = query.split('&');
            for (var i = 0; i < vars.length; i++) {
            var pair = vars[i].split('=');
            r.searchParam[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1]);
            }
        }
        r.href = r.origin + r.pathname + r.search + r.hash;
        return r;
    };
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./IDP-Lookup.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "68d5a8e7-fcc9-4215-9e63-a01afe8fa849": {
      "_id": "68d5a8e7-fcc9-4215-9e63-a01afe8fa849",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Perform IDP lookup based on email domain. Set users' external IDP in shared state or continue to local authentication.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "IDP Lookup",
      "script": "file://IDP-Lookup.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./IDP-Re-Lookup.script.js 1`] = `
"/* IDP Re-Lookup
 * 
 * Perform IDP re-lookup based on the Organization ID from the initial lookup. 
 * Set users' external IDP in shared state for further processing.
 * 
 * This script requires parametrization. Make sure you carefully review the configuration parameters.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 * - false
 *
 * Author: volker.scheuber@forgerock.com
 */
(function () {
    logger.message("IDP Re-Lookup: start");
      outcome = "false";
      var referer = parseUrl(requestHeaders.get("referer").get(0));
      var orgId = referer.searchParam.o;
      sharedState.put("username", referer.searchParam.u);

      /* Begin Configuration */
  
    // long-lived token, expires: Friday, January 16, 2032 9:45:14 PM GMT-06:00
    var IDM_API_TOKEN = "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJlMWE1YzU5OC04MGUyLTRhZGMtYjM0NS0zMWQwMmUyOThjNGIiLCJjdHMiOiJPQVVUSDJfR1JBTlRfU0VUIiwiYXV0aF9sZXZlbCI6MCwiYXVkaXRUcmFja2luZ0lkIjoiNGYzMDkxYTktZjU0Ni00MDdiLTkzNjMtM2RiZGJiZjYzMDc0LTM1NzcwOSIsInN1Ym5hbWUiOiJlMWE1YzU5OC04MGUyLTRhZGMtYjM0NS0zMWQwMmUyOThjNGIiLCJpc3MiOiJodHRwczovL29wZW5hbS12b2xrZXItZGV2LmZvcmdlYmxvY2tzLmNvbTo0NDMvYW0vb2F1dGgyL2FscGhhIiwidG9rZW5OYW1lIjoiYWNjZXNzX3Rva2VuIiwidG9rZW5fdHlwZSI6IkJlYXJlciIsImF1dGhHcmFudElkIjoiLUIxQlRUM3FqNi04Zkd3a2d6bzgzNzlSRjVJLjA4NkNJdTFyOUNCNlROcEIwV3Q5OFEyNTJYcyIsImF1ZCI6IjY5ZDA1YzExLWU4ZmUtNGFlNS1hN2M5LTIyNTJhNGQ4NWRmNCIsIm5iZiI6MTY0MjU2MzkxNCwiZ3JhbnRfdHlwZSI6InBhc3N3b3JkIiwic2NvcGUiOlsiZnI6aWRtOioiXSwiYXV0aF90aW1lIjoxNjQyNTYzOTE0LCJyZWFsbSI6Ii9hbHBoYSIsImV4cCI6MTk1NzkyMzkxNCwiaWF0IjoxNjQyNTYzOTE0LCJleHBpcmVzX2luIjozMTUzNjAwMDAsImp0aSI6Ii1CMUJUVDNxajYtOGZHd2tnem84Mzc5UkY1SS5CSHFZNVp3c0lGNVpMbEtvcGNvUlVGVHNLUjAiLCJtYXlfYWN0Ijp7ImNsaWVudF9pZCI6WyI2OWQwNWMxMS1lOGZlLTRhZTUtYTdjOS0yMjUyYTRkODVkZjQiXX19.f2NmwHVtekH93jO7-jM6mkFRcuvEN3WzcKsH-RAPnlc";

    // IDM API Configuration
    var IDM_API_URI = referer.origin + "/openidm/managed/alpha_organization/"+ orgId + "?_fields=name,description,idpName,idpType,idpDomains,idpJourney,idpTheme,idpPersist";

      /* End Configuration */

    var request = new org.forgerock.http.protocol.Request();
    request.setMethod('GET');
    request.setUri(IDM_API_URI);
    request.getHeaders().add("Content-Type", "application/json; charset=UTF-8");
    request.getHeaders().add("Authorization", "Bearer " + IDM_API_TOKEN);

    var response = httpClient.send(request).get();
    var result = JSON.parse(response.getEntity().getString());
    logger.message("IDP Re-Lookup: JSON result: " + JSON.stringify(result));
    
      if (result) {
          outcome = "true";
        var routedIDPs = [result];
        sharedState.put("routedIDPs", routedIDPs);
        logger.message("IDP Re-Lookup: Found IDP");
    }
    logger.message("IDP Re-Lookup: end [outcome={}]", outcome);

    /*
     * Parse a URL into its components and make them easily accessible by name
     *
     * Use in a Scripte Decision Node Script as follows:
     * var referer = parseUrl(requestHeaders.get("referer").get(0));
     * var origin = referer.origin;
     * 
     * e.g.: https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/
     * {
     *     hash: '#/',
     *     host: 'openam-volker-dev.forgeblocks.com',
     *     hostname: 'openam-volker-dev.forgeblocks.com',
     *     href: 'https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/',
     *     origin: 'https://openam-volker-dev.forgeblocks.com',
     *     pathname: '/am/XUI/',
     *     port: '',
     *     protocol: 'https',
     *     search: '?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim',
     *     username: '',
     *     password: '',
     *     searchParam: {
     *         realm: '/bravo',
     *         authIndexType: 'service',
     *         authIndexValue: 'InitiateOwnerClaim'
     *     }
     * }
     */
    function parseUrl(href) {
        var m = href.match(/^(([^:\\/?#]+):?(?:\\/\\/((?:([^\\/?#:]*):([^\\/?#:]*)@)?([^\\/?#:]*)(?::([^\\/?#:]*))?)))?([^?#]*)(\\?[^#]*)?(#.*)?$/),
        r = {
            hash: m[10] || "",                      // #/
            host: m[3] || "",                       // openam-volker-dev.forgeblocks.com
            hostname: m[6] || "",                   // openam-volker-dev.forgeblocks.com
            href: m[0] || "",                       // https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/
            origin: m[1] || "",                     // https://openam-volker-dev.forgeblocks.com
            pathname: m[8] || (m[1] ? "/" : ""),    // /am/XUI/
            port: m[7] || "",                       // 
            protocol: m[2] || "",                   // https
            search: m[9] || "",                     // ?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim
            username: m[4] || "",                   // 
            password: m[5] || "",                   // 
            searchParam: {}                         // { realm: '/bravo',
                                                    //   authIndexType: 'service',
                                                    //   authIndexValue: 'InitiateOwnerClaim' }
        };
        if (r.protocol.length == 2) {
            r.protocol = "file:///" + r.protocol.toUpperCase();
            r.origin = r.protocol + "//" + r.host;
        }
        if (r.search.length > 2) {
            var query = (r.search.indexOf('?') === 0) ? r.search.substr(1) : r.search;
            var vars = query.split('&');
            for (var i = 0; i < vars.length; i++) {
            var pair = vars[i].split('=');
            r.searchParam[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1]);
            }
        }
        r.href = r.origin + r.pathname + r.search + r.hash;
        return r;
    };
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./IDP-Re-Lookup.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "ab917dad-6fdb-46c2-8c8c-42f094ebeea1": {
      "_id": "ab917dad-6fdb-46c2-8c8c-42f094ebeea1",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Perform IDP re-lookup based on the Organization ID from the initial lookup. Set users' external IDP in shared state for further processing.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "IDP Re-Lookup",
      "script": "file://IDP-Re-Lookup.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./IDP-Router.script.js 1`] = `
"/* IDP Router
 * 
 * Route users to their organization's IDP of type saml, oidc, local, 
 * or custom and apply the organization's theme, if specified.
 * 
 * This script does not need to be parametrized. It will work properly as is.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - saml
 * - oidc
 * - local
 * - custom
 *
 * Author: volker.scheuber@forgerock.com
 */
(function () {
      logger.message("IDP Router: Start");
    outcome = "local";
      var referer = parseUrl(requestHeaders.get("referer").get(0));
      var routedIDP = sharedState.get("routedIDPs").get(0);
      if (routedIDP) {
        outcome = routedIDP.get("idpType");
        logger.message("IDP Router: Routed IDP: " + routedIDP);
          sharedState.put("selectedIdp", routedIDP.get("idpName"));
        var nodeConfig = {};
          // load samlConfig
          if (routedIDP.get("samlConfig")) {
              nodeConfig = JSON.parse(routedIDP.get("samlConfig"));
        }
          // route to a custom journey
        if (routedIDP.get("idpJourney")) {
            logger.message("IDP Router: Route to custom IDP {}, journey: {}", routedIDP.get("idpName"), routedIDP.get("idpJourney"));
              nodeConfig.tree = routedIDP.get("idpJourney");
              outcome = "custom";
        }
          sharedState.put("nodeConfig", nodeConfig);
          // only send callback if the org/idp requires a custom theme
        if (routedIDP.get("idpTheme") && callbacks.isEmpty()) {
            var stage = "themeId="+routedIDP.get("idpTheme");
            var fr = JavaImporter(
                org.forgerock.openam.auth.node.api.Action,
                org.forgerock.openam.authentication.callbacks.PollingWaitCallback
            )
              action = fr.Action.send(
                  new fr.PollingWaitCallback("0", "Please wait ...")
            ).withStage(stage).build();
          }
    }
      logger.message("IDP Router: Done [outcome={}]", outcome);

    /*
     * Parse a URL into its components and make them easily accessible by name
     *
     * Use in a Scripte Decision Node Script as follows:
     * var referer = parseUrl(requestHeaders.get("referer").get(0));
     * var origin = referer.origin;
     * 
     * e.g.: https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/
     * {
     *     hash: '#/',
     *     host: 'openam-volker-dev.forgeblocks.com',
     *     hostname: 'openam-volker-dev.forgeblocks.com',
     *     href: 'https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/',
     *     origin: 'https://openam-volker-dev.forgeblocks.com',
     *     pathname: '/am/XUI/',
     *     port: '',
     *     protocol: 'https',
     *     search: '?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim',
     *     username: '',
     *     password: '',
     *     searchParam: {
     *         realm: '/bravo',
     *         authIndexType: 'service',
     *         authIndexValue: 'InitiateOwnerClaim'
     *     }
     * }
     */
    function parseUrl(href) {
        var m = href.match(/^(([^:\\/?#]+):?(?:\\/\\/((?:([^\\/?#:]*):([^\\/?#:]*)@)?([^\\/?#:]*)(?::([^\\/?#:]*))?)))?([^?#]*)(\\?[^#]*)?(#.*)?$/),
        r = {
            hash: m[10] || "",                      // #/
            host: m[3] || "",                       // openam-volker-dev.forgeblocks.com
            hostname: m[6] || "",                   // openam-volker-dev.forgeblocks.com
            href: m[0] || "",                       // https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/
            origin: m[1] || "",                     // https://openam-volker-dev.forgeblocks.com
            pathname: m[8] || (m[1] ? "/" : ""),    // /am/XUI/
            port: m[7] || "",                       // 
            protocol: m[2] || "",                   // https
            search: m[9] || "",                     // ?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim
            username: m[4] || "",                   // 
            password: m[5] || "",                   // 
            searchParam: {}                         // { realm: '/bravo',
                                                    //   authIndexType: 'service',
                                                    //   authIndexValue: 'InitiateOwnerClaim' }
        };
        if (r.protocol.length == 2) {
            r.protocol = "file:///" + r.protocol.toUpperCase();
            r.origin = r.protocol + "//" + r.host;
        }
        if (r.search.length > 2) {
            var query = (r.search.indexOf('?') === 0) ? r.search.substr(1) : r.search;
            var vars = query.split('&');
            for (var i = 0; i < vars.length; i++) {
            var pair = vars[i].split('=');
            r.searchParam[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1]);
            }
        }
        r.href = r.origin + r.pathname + r.search + r.hash;
        return r;
    };
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./IDP-Router.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "aef262d0-7a42-4a34-9826-e7dbc2ea6eb9": {
      "_id": "aef262d0-7a42-4a34-9826-e7dbc2ea6eb9",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Route users to their organization's IDP of type saml, oidc, local, or custom and apply the organization's theme, if specified",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "IDP Router",
      "script": "file://IDP-Router.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./IPv4-CIDR-Rules-Engine.script.js 1`] = `
"/* IPv4 CIDR Rules Engine
 *
 * Author: volker.scheuber@forgerock.com, justin.chin@forgerock.com
 * 
 * Evaluate IPv4 CIDR access rules from "esv-ipv4-cidr-access-rules". 
 * Access rules must have the following format:
 * {
 *   "allow": [
 *     "140.118.0.0/16",
 *     "110.35.0.0/16",
 *     "131.26.0.0/16",
 *     "92.61.21.153/32"
 *   ]
 * }
 * 
 * This script does not need to be parametrized. It will work properly as is.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - allow
 * - deny
 */
(function () {
  outcome = "deny";
  
  var rules = JSON.parse(systemEnv.getProperty("esv.ipv4.cidr.access.rules"));
  var allow = rules['allow'];

  /*
   * Returns the value of the requested header
   */
  function getHeader(headerName) {
    return requestHeaders.get(headerName).get(0);
  }

  /*
   * Returns the client's IP address
   */
  function getClientIPAddress() {
    return getHeader("x-forwarded-for").split(',')[0];
  }

  function IPnumber(IPaddress) {
    var ip = IPaddress.match(/^(\\d+)\\.(\\d+)\\.(\\d+)\\.(\\d+)$/);
    if (ip) {
      return (+ip[1] << 24) + (+ip[2] << 16) + (+ip[3] << 8) + +ip[4];
    }
    // else ... ?
    return null;
  }

  function IPmask(maskSize) {
    return -1 << (32 - maskSize);
  }

  function isAllowed(ip) {
    var allowed = false;
    allow.forEach((cidr) => {
      if (
        (IPnumber(ip) & IPmask(cidr.split('/')[1])) ==
        IPnumber(cidr.split('/')[0])
      ) {
        allowed = true;
      }
    });
    return allowed;
  }
  
  if (isAllowed(getClientIPAddress())) {
    outcome = "allow";
  }
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./IPv4-CIDR-Rules-Engine.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "7fb962a5-9f20-41d3-a077-b424a29c1198": {
      "_id": "7fb962a5-9f20-41d3-a077-b424a29c1198",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Evaluate IPv4 CIDR access rules from "esv-ipv4-cidr-access-rules".",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "IPv4 CIDR Rules Engine",
      "script": "file://IPv4-CIDR-Rules-Engine.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Impersonate:-Extract-Actors-And-Become-Impersonator.script.js 1`] = `
"/* Impersonate: Extract Actors And Become Impersonator
 *
 * Extract impersonatee and impersonator from headers and become impersonatee.
 *
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 * - false
 */

(function () {
    logger.warning("Impersonate: Extract Actors: start");
    outcome = "false";

    /*
     * BEGIN SCRIPT CONFIGURATION
     */
    var IMPERSONATEE_HEADER_NAME = "X-Impersonatee";
    var IMPERSONATOR_HEADER_NAME = "X-Impersonator";
    /*
     * END SCRIPT CONFIGURATION
     */

    var impersonatee = getHeader(IMPERSONATEE_HEADER_NAME);
    var impersonator = getHeader(IMPERSONATOR_HEADER_NAME);
    if (impersonatee && impersonator) {
        outcome = "true";
        sharedState.put("impersonatee", impersonatee);
        sharedState.put("impersonator", impersonator);
        sharedState.put("username", impersonator);
        setSharedObjectAttribute("userName", impersonator);
    }

    logger.warning("Impersonate: Extract Actors: finish [outcome=".concat(outcome).concat("]"));

    /*
     * Returns the value of the requested header
     */
    function getHeader(headerName) {
        if (requestHeaders.get(headerName) && requestHeaders.get(headerName).get(0)) {
            return requestHeaders.get(headerName).get(0).toString();
        }
        return null;
    }

    /*
     * Store attributes in shared state for use with the Create/Patch Object nodes.
     */
    function setSharedObjectAttribute(name, value) {
         var storage = sharedState.get("objectAttributes");
        if (storage && value) {
            if (storage.put) {
                  storage.put(name, value);
            }
            else {
                storage[name] = value;
            }
        }
        else if (value) {
            sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));
        }
    }
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Impersonate:-Extract-Actors-And-Become-Impersonator.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "d6f3befb-c73a-437e-b02a-66d9b4c93f8b": {
      "_id": "d6f3befb-c73a-437e-b02a-66d9b4c93f8b",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Extract impersonatee and impersonator from headers and become impersonator.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Impersonate: Extract Actors And Become Impersonator",
      "script": "file://Impersonate:-Extract-Actors-And-Become-Impersonator.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Impersonate:-Switch-Actors-And-Become-Impersonatee.script.js 1`] = `
"/* Impersonate: Switch Actors And Become Impersonatee
 *
 * Switch Actors And Become Impersonatee.
 *
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 * - false
 */

(function () {
    logger.warning("Impersonate: Switch Actors: start");
    outcome = "false";

    var impersonatee = sharedState.get("impersonatee");
    var impersonator = sharedState.get("impersonator");
    if (impersonatee && impersonator) {
        outcome = "true";
        sharedState.put("username", impersonatee);
        setSharedObjectAttribute("userName", impersonatee);
    }

    logger.warning("Impersonate: Switch Actors: finish [outcome=".concat(outcome).concat("]"));
  
    /*
     * Store attributes in shared state for use with the Create/Patch Object nodes.
     */
    function setSharedObjectAttribute(name, value) {
         var storage = sharedState.get("objectAttributes");
        if (storage && value) {
            if (storage.put) {
                  storage.put(name, value);
            }
            else {
                storage[name] = value;
            }
        }
        else if (value) {
            sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));
        }
    }
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Impersonate:-Switch-Actors-And-Become-Impersonatee.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "878816b3-2bb4-4b43-8001-10f926ddefff": {
      "_id": "878816b3-2bb4-4b43-8001-10f926ddefff",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Switch Actors And Become Impersonatee.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Impersonate: Switch Actors And Become Impersonatee",
      "script": "file://Impersonate:-Switch-Actors-And-Become-Impersonatee.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Impersonate:-Update-Session-Properties.script.js 1`] = `
"/* Impersonate: Update Session Properties
 * 
 * Store the impersontor and impersonatee profile information in session properties.
 * 
 * This script does not need to be parametrized. It will work properly as is.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 *
 * Author: jake.feasel@forgerock.com, volker.scheuber@forgerock.com
 */
(function () {
      logger.message("Impersonate: Update Session Properties: start");
      outcome = "true";
  
    var goTo = org.forgerock.openam.auth.node.api.Action.goTo;
    myGoto = goTo(outcome);
    myGoto.putSessionProperty("userName", sharedState.get("username"));
    myGoto.putSessionProperty("impersonator", sharedState.get("impersonator"));

      logger.message("Impersonate: Update Session Properties: done [outcome={}]", outcome);
    action = myGoto.build();
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Impersonate:-Update-Session-Properties.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "7dd80834-e7b2-4737-85a7-40434bb19dde": {
      "_id": "7dd80834-e7b2-4737-85a7-40434bb19dde",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Store the impersontor and impersonatee profile information in session properties.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Impersonate: Update Session Properties",
      "script": "file://Impersonate:-Update-Session-Properties.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Instagram-Profile-Normalization.script.groovy 1`] = `
"/*
 * Copyright 2020 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

import static org.forgerock.json.JsonValue.field
import static org.forgerock.json.JsonValue.json
import static org.forgerock.json.JsonValue.object

return json(object(
        field("id", rawProfile.id),
        field("username", rawProfile.username)))"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Instagram-Profile-Normalization.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "1244e639-4a31-401d-ab61-d75133d8dc9e": {
      "_id": "1244e639-4a31-401d-ab61-d75133d8dc9e",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from Instagram",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Instagram Profile Normalization",
      "script": "file://Instagram-Profile-Normalization.script.groovy",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Itsme-Profile-Normalization.script.groovy 1`] = `
"/*
 * Copyright 2020-2021 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

import static org.forgerock.json.JsonValue.field
import static org.forgerock.json.JsonValue.json
import static org.forgerock.json.JsonValue.object

import org.forgerock.json.JsonValue

JsonValue managedUser = json(object(
        field("id", rawProfile.sub),
        field("displayName", rawProfile.name),
        field("givenName", rawProfile.given_name),
        field("familyName", rawProfile.family_name),
        field("username", rawProfile.email),
        field("email", rawProfile.email)))
return managedUser"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Itsme-Profile-Normalization.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "3d97c436-42c0-4dd0-a571-ea6f34f752b3": {
      "_id": "3d97c436-42c0-4dd0-a571-ea6f34f752b3",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from Itsme",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Itsme Profile Normalization",
      "script": "file://Itsme-Profile-Normalization.script.groovy",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./KerberosLogin:-Extract-Username.script.js 1`] = `
"/* KerberosLogin: Extract Username
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 * - false
 */

logger.warning("KerberosLogin: Extract Username: start");
outcome = "false";

/*
 * BEGIN SCRIPT CONFIGURATION
 */
var USERNAME_HEADER_NAME = "X-OpenAM-Username";
/*
 * END SCRIPT CONFIGURATION
 */

var username = getHeader(USERNAME_HEADER_NAME);
if (username) {
    
      outcome = "true";
    sharedState.put("username", username);
    setSharedObjectAttribute("userName", username);
}

logger.warning("KerberosLogin: Extract Username: finish [outcome=".concat(outcome).concat("]"));

/*
 * Returns the value of the requested header
 */
function getHeader(headerName) {
      if (requestHeaders.get(headerName) && requestHeaders.get(headerName).get(0)) {
        return requestHeaders.get(headerName).get(0).toString();
    }
      return null;
}

/*
 * Store attributes in shared state for use with the Create/Patch Object nodes.
 */
function setSharedObjectAttribute(name, value) {
       var storage = sharedState.get("objectAttributes");
    if (storage && value) {
          if (storage.put) {
              storage.put(name, value);
        }
          else {
              storage[name] = value;
        }
    }
    else if (value) {
        sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));
    }
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./KerberosLogin:-Extract-Username.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "355a8b7c-9e3c-40c1-a873-68127e483adf": {
      "_id": "355a8b7c-9e3c-40c1-a873-68127e483adf",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Extract Username from request.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "KerberosLogin: Extract Username",
      "script": "file://KerberosLogin:-Extract-Username.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./LinkedIn-Profile-Normalization.script.groovy 1`] = `
"/*
 * Copyright 2020 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

import static org.forgerock.json.JsonValue.field
import static org.forgerock.json.JsonValue.json
import static org.forgerock.json.JsonValue.object

return json(object(
        field("id", rawProfile.id),
        field("givenName", rawProfile.firstName.localized.get(0)),
        field("familyName", rawProfile.lastName.localized.get(0)),
        field("photoUrl", rawProfile.profilePicture.displayImage),
        field("email", rawProfile.elements.get(0).get("handle~").emailAddress),
        field("username", rawProfile.elements.get(0).get("handle~").emailAddress)))"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./LinkedIn-Profile-Normalization.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "8862ca8f-7770-4af5-a888-ac0df0947f36": {
      "_id": "8862ca8f-7770-4af5-a888-ac0df0947f36",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from LinkedIn",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "LinkedIn Profile Normalization",
      "script": "file://LinkedIn-Profile-Normalization.script.groovy",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./MFA-Status.script.js 1`] = `
"/* MFA Status
 *
 * Author: volker.scheuber@forgerock.com
 * 
 * Check if MFA has already been performed for this journey. 
 * This allows journeys and inner journeys not to perform MFA multiple times.
 * 
 * This script does not need to be parametrized. It will work properly as is.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 * - false
 */
outcome = "false";
if (sharedState.get("mfaPerformed")=="true") {
      outcome = "true";
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./MFA-Status.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "ac9fc25e-3ad9-4f80-a796-2d9093795439": {
      "_id": "ac9fc25e-3ad9-4f80-a796-2d9093795439",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Check if MFA has already been performed for this journey. This allows journeys and inner journeys not to perform MFA multiple times.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "MFA Status",
      "script": "file://MFA-Status.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Microsoft-Profile-Normalization.script.groovy 1`] = `
"/*
 * Copyright 2020 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

/*
{
    "@odata.context": "https://graph.microsoft.com/v1.0/$metadata#users/$entity",
    "@odata.id": "https://graph.microsoft.com/v2/711ffa9c-5972-4713-ace3-688c9732614a/directoryObjects/7d7759e2-36d8-4e64-b173-3f890d7d46d6/Microsoft.DirectoryServices.User",
    "businessPhones": [
        "18014735451"
    ],
    "displayName": "Volker Scheuber",
    "givenName": "Volker",
    "jobTitle": null,
    "mail": "vscheuber@vscheuber.onmicrosoft.com",
    "mobilePhone": null,
    "officeLocation": null,
    "preferredLanguage": null,
    "surname": "Scheuber",
    "userPrincipalName": "vscheuber@vscheuber.onmicrosoft.com",
    "id": "7d7759e2-36d8-4e64-b173-3f890d7d46d6"
}
 */

import static org.forgerock.json.JsonValue.field
import static org.forgerock.json.JsonValue.json
import static org.forgerock.json.JsonValue.object

logger.message("Kauai Microsoft Profile Normalization: rawProfile={}", rawProfile)

return json(object(
        field("id", rawProfile.id),
        field("displayName", rawProfile.displayName),
        field("givenName", rawProfile.givenName),
        field("familyName", rawProfile.surname),
        field("email", rawProfile.userPrincipalName),
        field("username", rawProfile.userPrincipalName),
        field("groups", rawProfile.groups)))"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Microsoft-Profile-Normalization.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "73cecbfc-dad0-4395-be6a-6858ee3a80e5": {
      "_id": "73cecbfc-dad0-4395-be6a-6858ee3a80e5",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from Microsoft",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Microsoft Profile Normalization",
      "script": "file://Microsoft-Profile-Normalization.script.groovy",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./MobileOTP:-Extract-Username-Password-OTP.script.js 1`] = `
"logger.warning("MobileOTP: Extract Username, Password, OTP: start");

/*
 * BEGIN SCRIPT CONFIGURATION
 */
var USERNAME_HEADER_NAME = "X-OpenAM-Username";
var PASSWORD_HEADER_NAME = "X-OpenAM-Password";
var OTP_HEADER_NAME = "X-OpenAM-MobileOTP";
/*
 * END SCRIPT CONFIGURATION
 */

outcome = "false";

var username = getHeader(USERNAME_HEADER_NAME) || null;
var password = getHeader(PASSWORD_HEADER_NAME) || null;
var mobileOTP = getHeader(OTP_HEADER_NAME) || null;

if (username && password && mobileOTP) {
      sharedState.put("username", username);
      transientState.put("password", password);
      transientState.put("mobileOTP", mobileOTP);
    outcome = "true";
}

logger.warning("MobileOTP: Extract Username, Password, OTP: finish [outcome=".concat(outcome).concat("]"));

/*
 * Returns the value of the requested header
 */
function getHeader(headerName) {
      if (requestHeaders.get(headerName) && requestHeaders.get(headerName).get(0)) {
        return requestHeaders.get(headerName).get(0).toString();
    }
      return null;
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./MobileOTP:-Extract-Username-Password-OTP.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "57807349-630f-496a-bccb-ea1011b8e945": {
      "_id": "57807349-630f-496a-bccb-ea1011b8e945",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Extract username, password, and OTP from request headers and put them in shared state for validation.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "MobileOTP: Extract Username, Password, OTP",
      "script": "file://MobileOTP:-Extract-Username-Password-OTP.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./MobileOTP:-Prepare-Reset-Of-OTP-Profile-Attribute.script.js 1`] = `
"/*
 * Reset OTP profile attribute in ObjectAttributes so it can be patched to the user profile.
 */
outcome = "true";

setSharedObjectAttribute("fr-attr-int5", "0");

/*
 * Store attributes in shared state for use with the Create/Patch Object nodes.
 */
function setSharedObjectAttribute(name, value) {
      var storage = sharedState.get("objectAttributes");
    if (storage && value) {
          if (storage.put) {
              storage.put(name, value);
        }
          else {
              storage[name] = value;
        }
    }
    else if (value) {
        sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));
    }
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./MobileOTP:-Prepare-Reset-Of-OTP-Profile-Attribute.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "d25a1315-8beb-4a0c-84bf-534214fed087": {
      "_id": "d25a1315-8beb-4a0c-84bf-534214fed087",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Prepare Reset Of OTP Profile Attribute",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "MobileOTP: Prepare Reset Of OTP Profile Attribute",
      "script": "file://MobileOTP:-Prepare-Reset-Of-OTP-Profile-Attribute.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./MobileOTP:-Validate-OTP-In-Profile-Attribute.script.js 1`] = `
"/*
 * Validate OTP in user profile attribute against OTP in shared state
 */
outcome = "false";
var OTP_LENGTH = 8;

if (sharedState.get("mobileOTP")) {
      var profileOTP = idRepository.getAttribute(username, "fr-attr-int5");
}

function checkPassword(profileOTP, password) {
    var oneTimePassword = profileOTP.substring(0,7);
    var passwordTimestamp = Number(profileOTP.substring(8));

    var passwordMatches = oneTimePassword
        && (oneTimePassword == password)
        && passwordTimestamp != null
        && isWithinExpiryTime(passwordTimestamp);
    return passwordMatches;
}

function isWithinExpiryTime(passwordTimestamp) {
        Instant previous = Instant.ofEpochSecond(passwordTimestamp);
        Duration passwordExpiry = Duration.ofMinutes(config.passwordExpiryTime());
        Instant now = Time.getClock().instant();
        logger.debug("previous {} \\n passwordExpiry {} \\n now {}", previous, passwordExpiry, now);
        boolean withinExpiryTime = Duration.between(previous.plus(passwordExpiry), now).isNegative();
        logger.debug("withinExpiryTime {}", withinExpiryTime);
        return withinExpiryTime;
}

/*
    private Action checkPassword(TreeContext context, String password) {
        JsonValue oneTimePassword = context.getState(ONE_TIME_PASSWORD);
        JsonValue passwordTimestamp = context.getState(ONE_TIME_PASSWORD_TIMESTAMP);

        boolean passwordMatches = oneTimePassword != null && oneTimePassword.isString()
                && oneTimePassword.asString().equals(password)
                && passwordTimestamp != null && passwordTimestamp.isNumber()
                && isWithinExpiryTime(passwordTimestamp.asLong());
        logger.debug("passwordMatches {}", passwordMatches);
        return goTo(passwordMatches).build();
    }

    private boolean isWithinExpiryTime(long passwordTimestamp) {
        Instant previous = Instant.ofEpochSecond(passwordTimestamp);
        Duration passwordExpiry = Duration.ofMinutes(config.passwordExpiryTime());
        Instant now = Time.getClock().instant();
        logger.debug("previous {} \\n passwordExpiry {} \\n now {}", previous, passwordExpiry, now);
        boolean withinExpiryTime = Duration.between(previous.plus(passwordExpiry), now).isNegative();
        logger.debug("withinExpiryTime {}", withinExpiryTime);
        return withinExpiryTime;
    }
    */"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./MobileOTP:-Validate-OTP-In-Profile-Attribute.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "ce6fbbcf-5d9a-471b-bcc1-448758a6374a": {
      "_id": "ce6fbbcf-5d9a-471b-bcc1-448758a6374a",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Validate OTP in profile attribute",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "MobileOTP: Validate OTP In Profile Attribute",
      "script": "file://MobileOTP:-Validate-OTP-In-Profile-Attribute.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Normalized-ADFS-Profile-to-Managed-User.script.groovy 1`] = `
"/*
 * Copyright 2022 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

import static org.forgerock.json.JsonValue.field
import static org.forgerock.json.JsonValue.json
import static org.forgerock.json.JsonValue.object

import org.forgerock.json.JsonValue

JsonValue managedUser = json(object(
        field("givenName", normalizedProfile.givenName),
        field("sn", normalizedProfile.familyName),
        field("mail", normalizedProfile.email),
        field("userName", normalizedProfile.username)))

if (normalizedProfile.postalAddress.isNotNull()) managedUser.put("postalAddress", normalizedProfile.postalAddress)
if (normalizedProfile.addressLocality.isNotNull()) managedUser.put("city", normalizedProfile.addressLocality)
if (normalizedProfile.addressRegion.isNotNull()) managedUser.put("stateProvince", normalizedProfile.addressRegion)
if (normalizedProfile.postalCode.isNotNull()) managedUser.put("postalCode", normalizedProfile.postalCode)
if (normalizedProfile.country.isNotNull()) managedUser.put("country", normalizedProfile.country)
if (normalizedProfile.phone.isNotNull()) managedUser.put("telephoneNumber", normalizedProfile.phone)
managedUser.put("accountStatus", (normalizedProfile.roles.asString() == "fidc-volker-dev-admins") ? 'Active' : 'Inactive')

// if the givenName and familyName is null or empty
// then add a boolean flag to the shared state to indicate names are not present
// this could be used elsewhere
// for eg. this could be used in a scripted decision node to by-pass patching
// the user object with blank values when givenName  and familyName is not present
boolean noGivenName = normalizedProfile.givenName.isNull() || (!normalizedProfile.givenName.asString()?.trim())
boolean noFamilyName = normalizedProfile.familyName.isNull() || (!normalizedProfile.familyName.asString()?.trim())
sharedState.put("nameEmptyOrNull", noGivenName && noFamilyName)

return managedUser
"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Normalized-ADFS-Profile-to-Managed-User.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "3156d7e9-1589-4ffb-a659-37a1647ee03d": {
      "_id": "3156d7e9-1589-4ffb-a659-37a1647ee03d",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Converts a normalized social profile coming from ADFS into a managed user",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Normalized ADFS Profile to Managed User",
      "script": "file://Normalized-ADFS-Profile-to-Managed-User.script.groovy",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Normalized-Profile-to-Identity.script.groovy 1`] = `
"/*
 * Copyright 2021 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

import static org.forgerock.json.JsonValue.field
import static org.forgerock.json.JsonValue.json
import static org.forgerock.json.JsonValue.object

import org.forgerock.json.JsonValue

JsonValue identity = json(object(
        field("givenName", normalizedProfile.givenName),
        field("sn", normalizedProfile.familyName),
        field("mail", normalizedProfile.email),
        field("cn", normalizedProfile.displayName),
        field("userName", normalizedProfile.username),
        field("iplanet-am-user-alias-list", selectedIdp + '-' + normalizedProfile.id.asString())))

return identity"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Normalized-Profile-to-Identity.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "ed685f9f-5909-4726-86e8-22bd38b47663": {
      "_id": "ed685f9f-5909-4726-86e8-22bd38b47663",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Converts a normalized social profile into an Identity",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Normalized Profile to Identity",
      "script": "file://Normalized-Profile-to-Identity.script.groovy",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Normalized-Profile-to-Managed-User.script.groovy 1`] = `
"/*
 * Copyright 2020 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

import static org.forgerock.json.JsonValue.field
import static org.forgerock.json.JsonValue.json
import static org.forgerock.json.JsonValue.object

import org.forgerock.json.JsonValue

JsonValue managedUser = json(object(
        field("givenName", normalizedProfile.givenName),
        field("sn", normalizedProfile.familyName),
        field("mail", normalizedProfile.email),
        field("userName", normalizedProfile.username)))

if (normalizedProfile.postalAddress.isNotNull()) managedUser.put("postalAddress", normalizedProfile.postalAddress)
if (normalizedProfile.addressLocality.isNotNull()) managedUser.put("city", normalizedProfile.addressLocality)
if (normalizedProfile.addressRegion.isNotNull()) managedUser.put("stateProvince", normalizedProfile.addressRegion)
if (normalizedProfile.postalCode.isNotNull()) managedUser.put("postalCode", normalizedProfile.postalCode)
if (normalizedProfile.country.isNotNull()) managedUser.put("country", normalizedProfile.country)
if (normalizedProfile.phone.isNotNull()) managedUser.put("telephoneNumber", normalizedProfile.phone)

// if the givenName and familyName is null or empty
// then add a boolean flag to the shared state to indicate names are not present
// this could be used elsewhere
// for eg. this could be used in a scripted decision node to by-pass patching
// the user object with blank values when givenName  and familyName is not present
boolean noGivenName = normalizedProfile.givenName.isNull() || (!normalizedProfile.givenName.asString()?.trim())
boolean noFamilyName = normalizedProfile.familyName.isNull() || (!normalizedProfile.familyName.asString()?.trim())
sharedState.put("nameEmptyOrNull", noGivenName && noFamilyName)

return managedUser
"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Normalized-Profile-to-Managed-User.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "58c824ae-84ed-4724-82cd-db128fc3f6c": {
      "_id": "58c824ae-84ed-4724-82cd-db128fc3f6c",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Converts a normalized social profile into a managed user",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Normalized Profile to Managed User",
      "script": "file://Normalized-Profile-to-Managed-User.script.groovy",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Normalized-idddataweb-Profile-to-Managed-User.script.groovy 1`] = `
"/* Normalized idddataweb Profile to Managed User
 * Copyright 2022 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS. Not for production use.
 * Modified by Stephen Payne, 2021-Mar-30
 */
import static org.forgerock.json.JsonValue.field
import static org.forgerock.json.JsonValue.json
import static org.forgerock.json.JsonValue.object
import org.forgerock.json.JsonValue
logger.error("Normalized_Profile_IDDataWeb: Start " + normalizedProfile);

JsonValue managedUser = json(object(
        field("givenName", normalizedProfile.givenName),
        field("sn", normalizedProfile.familyName),
        field("userName", normalizedProfile.username)))
if (normalizedProfile.postalAddress.isNotNull()) managedUser.put("postalAddress", normalizedProfile.postalAddress)
if (normalizedProfile.addressLocality.isNotNull()) managedUser.put("city", normalizedProfile.addressLocality)
if (normalizedProfile.addressRegion.isNotNull()) managedUser.put("stateProvince", normalizedProfile.addressRegion)
if (normalizedProfile.postalCode.isNotNull()) managedUser.put("postalCode", normalizedProfile.postalCode)
if (normalizedProfile.country.isNotNull()) managedUser.put("country", normalizedProfile.country)
if (normalizedProfile.phone.isNotNull()) managedUser.put("telephoneNumber", normalizedProfile.phone)
if (normalizedProfile.DOB.isNotNull()) managedUser.put("frIndexedString2", normalizedProfile.DOB)

return managedUser
"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Normalized-idddataweb-Profile-to-Managed-User.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "809330cf-874c-4d57-a8f1-5882c6dd855b": {
      "_id": "809330cf-874c-4d57-a8f1-5882c6dd855b",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Converts a normalized social profile for iddataweb into a Managed user",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Normalized idddataweb Profile to Managed User",
      "script": "file://Normalized-idddataweb-Profile-to-Managed-User.script.groovy",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./OAuth2-Access-Token-Modification-Script.script.js 1`] = `
"/*
 * Copyright 2019-2021 ForgeRock AS. All Rights Reserved.
 *
 * Use of this code requires a commercial software license with ForgeRock AS
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

/*
 * This script lets you modify information associated with an OAuth2 access token
 * with methods provided by the AccessToken (1) interface.
 * The changes made to OAuth2 access tokens will directly impact the size of the CTS tokens,
 * and, similarly, the size of the JWTs if client-based OAuth2 tokens are utilized.
 * When adding/updating fields make sure that the token size remains within client/user-agent limits.
 *
 * Defined variables:
 * accessToken - AccessToken (1).
 *               The access token to be updated.
 *               Mutable object, all changes to the access token will be reflected.
 * scopes - Set<String> (6).
 *          Always present, the requested scopes.
 * requestProperties - Unmodifiable Map (5).
 *                     Always present, contains a map of request properties:
 *                     requestUri - The request URI.
 *                     realm - The realm that the request relates to.
 *                     requestParams - A map of the request params and/or posted data.
 *                                     Each value is a list of one or more properties.
 *                                     Please note that these should be handled in accordance with OWASP best practices:
 *                                     https://owasp.org/www-community/vulnerabilities/Unsafe_use_of_Reflection.
 * clientProperties - Unmodifiable Map (5).
 *                    Present if the client specified in the request was identified, contains a map of client properties:
 *                    clientId - The client's URI for the request locale.
 *                    allowedGrantTypes - List of the allowed grant types (org.forgerock.oauth2.core.GrantType) for the client.
 *                    allowedResponseTypes - List of the allowed response types for the client.
 *                    allowedScopes - List of the allowed scopes for the client.
 *                    customProperties - A map of the custom properties of the client.
 *                                       Lists or maps will be included as sub-maps; for example:
 *                                       customMap[Key1]=Value1 will be returned as customMap -> Key1 -> Value1.
 *                                       To add custom properties to a client, update the Custom Properties field
 *                                       in AM Console > Realm Name > Applications > OAuth 2.0 > Clients > Client ID > Advanced.
 * identity - AMIdentity (3).
 *            Always present, the identity of the resource owner.
 * session - SSOToken (4).
 *           Present if the request contains the session cookie, the user's session object.
 * scriptName - String (primitive).
 *              Always present, the display name of the script.
 * logger - Always present, the "OAuth2Provider" debug logger instance:
 *          https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.
 *          Corresponding log files will be prefixed with: scripts.OAUTH2_ACCESS_TOKEN_MODIFICATION.
 * httpClient - HTTP Client (8).
 *              Always present, the HTTP Client instance:
 *              https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-http-client.html#scripting-api-global-http-client.
 *
 * Return - no value is expected, changes shall be made to the accessToken parameter directly.
 *
 * Class reference:
 * (1) AccessToken - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/AccessToken.html.
 * (3) AMIdentity - https://backstage.forgerock.com/docs/am/7/apidocs/com/sun/identity/idm/AMIdentity.html.
 * (4) SSOToken - https://backstage.forgerock.com/docs/am/7/apidocs/com/iplanet/sso/SSOToken.html.
 * (5) Map - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashMap.html,
 *           or https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/LinkedHashMap.html.
 * (6) Set - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashSet.html.
 * (8) Client - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/http/Client.html.
 */

(function () {
  // Adds new fields containing the session property values.
  // NOTE: session may not be available for non-interactive authorization grants.
  if (session) {
    try {
      accessToken.setField('ip_address', session.getProperty('Host'));
    } catch (e) {
      logger.error('Unable to retrieve session property value. ' + e);
    }
  }
}());

/* EXAMPLE
(function () {
    var frJava = JavaImporter(
        org.forgerock.http.protocol.Request,
        org.forgerock.http.protocol.Response
    );

    // Always includes this field in the token.
    accessToken.setField('key1', 'value1');

    // Receives and adds to the access token additional values by performing a REST call to an external service.
    // WARNING: Below, you will find a reference to a third-party site, which is provided only as an example.
    var uri = 'https://jsonplaceholder.typicode.com/posts';

    try {
        var request = new frJava.Request();

        // You can chain methods that return the request object.
        request.setUri(uri)
            .setMethod('POST')
            .setEntity(JSON.stringify({
                updatedFields: {
                    key2: 'value2',
                    key3: 'value3'
                }
            }));

        // You can call a method when chaining is not possible.
        request.getHeaders().add('Content-Type', 'application/json; charset=UTF-8');

        // Sends the request and receives the response.
        var response = httpClient.send(request).getOrThrow();

        // Checks if the response status is as expected.
        if (response.getStatus() === org.forgerock.http.protocol.Status.CREATED) {
            var result = JSON.parse(response.getEntity().getString());

            // Set multiple token fields at once.
            accessToken.setFields(result.updatedFields);
        } else {
            logger.error('Unable to obtain access token modifications. Status: ' + response.getStatus() + '. Content: ' + response.getEntity().getString());
        }
    } catch (e) {
        logger.error('The request processing was interrupted. ' + e);

        // The access token request fails with the HTTP 500 error in this case.
        throw ('Unable to obtain response from: ' + uri);
    }

    // Adds new fields containing identity attribute values to the access token.
    accessToken.setField('mail', identity.getAttribute('mail'));
    accessToken.setField('phone', identity.getAttribute('telephoneNumber').toArray()[0]);

    // Adds new fields containing the session property values.
    // NOTE: session may not be available for non-interactive authorization grants.
    if (session) {
        try {
            accessToken.setField('ipAddress', session.getProperty('Host'));
        } catch (e) {
            logger.error('Unable to retrieve session property value. ' + e);
        }
    }

    // Removes a native field from the token entry, that was set by AM.
    // WARNING: removing native fields from the token may result in loss of functionality.
    // accessToken.removeTokenName()

    // No return value is expected. Let it be undefined.
}());
*/"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./OAuth2-Access-Token-Modification-Script.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "d22f9a0c-426a-4466-b95e-d0f125b0d5fa": {
      "_id": "d22f9a0c-426a-4466-b95e-d0f125b0d5fa",
      "context": "OAUTH2_ACCESS_TOKEN_MODIFICATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Default global script for OAuth2 Access Token Modification",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "OAuth2 Access Token Modification Script",
      "script": "file://OAuth2-Access-Token-Modification-Script.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./OIDC-Claims-Script.script.js 1`] = `
"/*
 * Copyright 2014-2021 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

/*
 * This script computes claim values returned in ID tokens and/or at the UserInfo Endpoint.
 * The claim values are computed for:
 * the claims derived from the requested scopes,
 * the claims provided by the authorization server,
 * and the claims requested by the client via the claims parameter.
 *
 * In the CONFIGURATION AND CUSTOMIZATION section, you can
 * define the scope-to-claims mapping, and
 * assign to each claim a resolver function that will compute the claim value.
 *
 * Defined variables (class references are provided below):
 * scopes - Set<String> (6).
 *          Always present, the requested scopes.
 * claims - Map<String, Object> (5).
 *          Always present, default server provided claims.
 * claimObjects - List<Claim> (7, 2).
 *                Always present, the default server provided claims.
 * requestedClaims - Map<String, Set<String>> (5).
 *                   Always present, not empty if the request contains the claims parameter and the server has enabled
 *                   claims_parameter_supported. A map of the requested claims to possible values, otherwise empty;
 *                   requested claims with no requested values will have a key but no value in the map. A key with
 *                   a single value in its Set (6) indicates that this is the only value that should be returned.
 * requestedTypedClaims - List<Claim> (7, 2).
 *                        Always present, the requested claims.
 *                        Requested claims with no requested values will have a claim with no values.
 *                        A claim with a single value indicates this is the only value that should be returned.
 * claimsLocales - List<String> (7).
 *                 The values from the 'claims_locales' parameter.
 *                 See https://openid.net/specs/openid-connect-core-1_0.html#ClaimsLanguagesAndScripts for the OIDC specification details.
 * requestProperties - Unmodifiable Map (5).
 *                     Always present, contains a map of request properties:
 *                     requestUri - The request URI.
 *                     realm - The realm that the request relates to.
 *                     requestParams - A map of the request params and/or posted data.
 *                                     Each value is a list of one or more properties.
 *                                     Please note that these should be handled in accordance with OWASP best practices:
 *                                     https://owasp.org/www-community/vulnerabilities/Unsafe_use_of_Reflection.
 * clientProperties - Unmodifiable Map (5).
 *                    Present if the client specified in the request was identified, contains a map of client properties:
 *                    clientId - The client's URI for the request locale.
 *                    allowedGrantTypes - List of the allowed grant types (org.forgerock.oauth2.core.GrantType) for the client.
 *                    allowedResponseTypes - List of the allowed response types for the client.
 *                    allowedScopes - List of the allowed scopes for the client.
 *                    customProperties - A map of the custom properties of the client.
 *                                       Lists or maps will be included as sub-maps; for example:
 *                                       customMap[Key1]=Value1 will be returned as customMap -> Key1 -> Value1.
 *                                       To add custom properties to a client, update the Custom Properties field
 *                                       in AM Console > Realm Name > Applications > OAuth 2.0 > Clients > Client ID > Advanced.
 * identity - AMIdentity (3).
 *            Always present, the identity of the resource owner.
 * session - SSOToken (4).
 *           Present if the request contains the session cookie, the user's session object.
 * scriptName - String (primitive).
 *              Always present, the display name of the script.
 * logger - Always present, the "OAuth2Provider" debug logger instance:
 *          https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.
 *          Corresponding files will be prefixed with: scripts.OIDC_CLAIMS.
 * httpClient - HTTP Client (8).
 *              Always present, the HTTP Client instance:
 *              https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-http-client.html#scripting-api-global-http-client.
 *              In order to use the client, you may need to add
 *              org.forgerock.http.Client,
 *              org.forgerock.http.protocol.*,
 *              and org.forgerock.util.promise.PromiseImpl
 *              to the allowed Java classes in the scripting engine configuration, as described in:
 *              https://backstage.forgerock.com/docs/am/7/scripting-guide/script-engine-security.html
 *
 * Return - a new UserInfoClaims(Map<String, Object> values, Map<String, List<String>> compositeScopes) (1) object.
 *          The result of the last statement in the script is returned to the server.
 *          Currently, the Immediately Invoked Function Expression (also known as Self-Executing Anonymous Function)
 *          is the last (and only) statement in this script, and its return value will become the script result.
 *          Do not use "return variable" statement outside of a function definition.
 *          See RESULTS section for additional details.
 *
 * Class reference:
 * (1) UserInfoClaims - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html.
 * (2) Claim - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html).
 *         An instance of org.forgerock.openidconnect.Claim has methods to access
 *         the claim name, requested values, locale, and whether the claim is essential.
 * (3) AMIdentity - https://backstage.forgerock.com/docs/am/7/apidocs/com/sun/identity/idm/AMIdentity.html.
 * (4) SSOToken - https://backstage.forgerock.com/docs/am/7/apidocs/com/iplanet/sso/SSOToken.html.
 * (5) Map - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashMap.html,
 *           or https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/LinkedHashMap.html.
 * (6) Set - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashSet.html.
 * (7) List - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/ArrayList.html.
 * (8) Client - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/http/Client.html.
*/

(function () {
    // SETUP

    /**
     * Claim processing utilities.
     * An object that contains reusable functions for processing claims.
     * @see CLAIM PROCESSING UTILITIES section for details.
     */
    var utils = getUtils();

    // CONFIGURATION AND CUSTOMIZATION

    /**
     * OAuth 2.0 scope values (scopes) can be used by the Client to request OIDC claims.
     *
     * Call this configuration method, and pass in as the first argument
     * an object that maps a scope value to an array of claim names
     * to specify which claims need to be processed and returned for the requested scopes.
     * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#ScopeClaims}
     * for the scope values that could be used to request claims as defined in the OIDC specification.
     *
     * Below, find a default configuration that is expected to work in the current environment.
     *
     * CUSTOMIZATION
     * You can choose the claim names returned for a scope.
     */
    utils.setScopeClaimsMap({
        profile: [
            'name',
            'family_name',
            'given_name',
            'zoneinfo',
            'locale'
        ],
        email: ['email'],
        address: ['address'],
        phone: ['phone_number']
    });

    /**
     * In this script, each claim
     * derived from the requested scopes,
     * provided by the authorization server, and
     * requested by the client via the claims parameter
     * will be processed by a function associated with the claim name.
     *
     * Call this configuration method, and pass in as the first argument
     * an object that maps a claim name to a resolver function,
     * which will be automatically executed for each claim processed by the script.
     *
     * The claim resolver function will receive the requested claim information
     * in an instance of org.forgerock.openidconnect.Claim as the first argument.
     * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html}
     * for details on the Claim class.
     *
     * If the claim resolver function returns a value,
     * other than undefined or null,
     * the claim will be included in the script's results.
     *
     * The Claim instance provides methods to check
     * what the name of the claim is,
     * which values the claim request contains,
     * whether the claim is essential, and
     * which locale the claim is associated with.
     * The resolver function can consider this information when computing and returning the claim value.
     *
     * Below, find a default configuration that is expected to work in the current environment.
     * A reusable function, utils.getUserProfileClaimResolver(String attribute-name),
     * is called to return a claim resolver function based on a user profile attribute.
     * @see CLAIM RESOLVERS section for the implementation details and examples.
     * For the address claim, an example of a claim resolver that uses another claim resolver is provided.
     *
     * CUSTOMIZATION
     * You can reuse the predefined utils methods with your custom arguments.
     * You can also specify a custom resolver function for a claim name,
     * that will compute and return the claim value—as shown in the commented out example below.
     */
    utils.setClaimResolvers({
        /*
        // An example of a simple claim resolver function that is defined for a claim
        // directly in the configuration object:
        custom-claim-name: function (requestedClaim) {
            // In this case, initially, the claim value comes straight from a user profile attribute value:
            var claimValue = identity.getAttribute('custom-attribute-name').toArray()[0]

            // Optionally, provide additional logic for processing (filtering, formatting, etc.) the claim value.
            // You can use:
            // requestedClaim.getName()
            // requestedClaim.getValues()
            // requestedClaim.getLocale()
            // requestedClaim.isEssential()

            return claimValue
        },
        */
        /**
         * The use of utils.getUserProfileClaimResolver shows how
         * an argument passed to a function that returns a claim resolver
         * becomes available to the resolver function (via its lexical context).
         */
        name: utils.getUserProfileClaimResolver('cn'),
        family_name: utils.getUserProfileClaimResolver('sn'),
        given_name: utils.getUserProfileClaimResolver('givenname'),
        zoneinfo: utils.getUserProfileClaimResolver('preferredtimezone'),
        locale: utils.getUserProfileClaimResolver('preferredlocale'),
        email: utils.getUserProfileClaimResolver('mail'),
        address: utils.getAddressClaimResolver(
            /**
             * The passed in user profile claim resolver function
             * can be used by the address claim resolver function
             * to obtain the claim value to be formatted as per the OIDC specification:
             * @see https://openid.net/specs/openid-connect-core-1_0.html#AddressClaim.
             */
            utils.getUserProfileClaimResolver('postaladdress')
        ),
        phone_number: utils.getUserProfileClaimResolver('telephonenumber')
    });

    // CLAIM PROCESSING UTILITIES

    /**
     * @returns {object} An object that contains reusable claim processing utilities.
     * @see PUBLIC METHODS section and the return statement for the list of exported functions.
     */
    function getUtils () {
        // IMPORT JAVA

        /**
         * Provides Java scripting functionality.
         * @see {@link https://developer.mozilla.org/en-US/docs/Mozilla/Projects/Rhino/Scripting_Java#javaimporter_constructor}.
         */
        var frJava = JavaImporter(
            org.forgerock.oauth2.core.exceptions.InvalidRequestException,
            org.forgerock.oauth2.core.UserInfoClaims,
            org.forgerock.openidconnect.Claim,

            java.util.LinkedHashMap,
            java.util.ArrayList
        );

        // SET UP CONFIGURATION

        /**
         * Placeholder for a configuration option that contains
         * an object that maps the supported scope values (scopes)
         * and the corresponding claim names for each scope value.
         */
        var scopeClaimsMap;

        /**
         * Placeholder for a configuration option that contains
         * an object that maps the supported claim names
         * and the resolver functions returning the claim value.
         */
        var claimResolvers;

        /**
         * A (public) method that accepts an object that maps the supported scopes and the corresponding claim names,
         * and assigns it to a (private) variable that serves as a configuration option.
         * @param {object} params - An object that maps each supported scope value to an array of claim names,
         * in order to specify which claims need to be processed for the requested scopes.
         * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#ScopeClaims} for details.
         * @param {string[]} [params.profile] - An array of claim names to be returned if the profile scope is requested.
         * @param {string[]} [params.email] - An array of claim names to be returned if the email scope is requested.
         * @param {string[]} [params.address] - An array of claim names to be returned if the address scope is requested.
         * @param {string[]} [params.phone] - An array of claim names to be returned if the phone scope is requested.
         * @returns {undefined}
         */
        function setScopeClaimsMap(params) {
            scopeClaimsMap = params;
        }

        /**
         * A (public) method that accepts an object that maps the supported claim names
         * and the resolver functions returning the claim value,
         * and assigns it to a (private) variable that serves as a configuration option.
         * @param {object} params - An object that maps
         * each supported claim name to a function that computes and returns the claim value.
         */
        function setClaimResolvers(params) {
            claimResolvers = params;
        }

        // CLAIM RESOLVERS

        /**
         * Claim resolvers are functions that return a claim value.
         * @param {*}
         * @returns {*}
         */

        /**
         * Defines a claim resolver based on a user profile attribute.
         * @param {string} attributeName - Name of the user profile attribute.
         * @returns {function} A function that will determine the claim value
         * based on the user profile attribute and the (requested) claim properties.
         */
        function getUserProfileClaimResolver (attributeName) {
            /**
             * Resolves a claim with a user profile attribute value.
             * Returns undefined if the identity attribute is not populated,
             * OR if the claim has requested values that do not contain the identity attribute value.
             * ATTENTION: the aforementioned comparison is case-sensitive.
             * @param {org.forgerock.openidconnect.Claim} claim
             * An object that provides methods to obtain information/requirements associated with a claim.
             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.
             * @returns {string|HashSet|undefined}
             */
            function resolveClaim(claim) {
                var userProfileValue;

                if (identity) {
                    userProfileValue = getClaimValueFromSet(claim, identity.getAttribute(attributeName));

                    if (userProfileValue && !userProfileValue.isEmpty()) {
                        if (!claim.getValues() || claim.getValues().isEmpty() || claim.getValues().contains(userProfileValue)) {
                            return userProfileValue;
                        }
                    }
                }
            }

            return resolveClaim;
        }

        /**
         * Returns an address claim resolver based on a claim value obtained with another claim resolver.
         * @param {function} resolveClaim - A function that returns a claim value.
         * @returns {function} A function that will accept a claim as an argument,
         * run the claim resolver function for the claim and obtain the claim value,
         * and apply additional formatting to the value before returning it.
         */
        function getAddressClaimResolver (resolveClaim) {
            /**
             * Creates an address claim object from a value returned by a claim resolver,
             * and returns the address claim object as the claim value.
             * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#AddressClaim}.
             * The claim value is obtained with a claim resolving function available from the closure.
             * @param {org.forgerock.openidconnect.Claim} claim
             * An object that provides methods to obtain information/requirements associated with a claim.
             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.
             * @returns {java.util.LinkedHashMap|undefined} The address claim object created from a claim value.
             */
            function resolveAddressClaim(claim) {
                var claimValue = resolveClaim(claim);
                var addressObject;

                if (isClaimValueValid(claimValue)) {
                    addressObject = new frJava.LinkedHashMap();

                    addressObject.put('formatted', claimValue);

                    return addressObject;
                }
            }

            return resolveAddressClaim;
        }

        /**
         * Returns an essential claim resolver based on a claim value obtained with another claim resolver.
         * @param {function} resolveClaim - A function that returns a claim value.
         * @returns {function} A function that will accept a claim as an argument,
         * run the claim resolver function for the claim and obtain the claim value,
         * and apply additional logic for essential claims.
         */
        function getEssentialClaimResolver (resolveClaim) {
            /**
             * Returns a claim value or throws an error.
             * The claim value is obtained with a claim resolving function available from the closure.
             * Throws an exception if the claim is essential and no value is returned for the claim.
             *
             * Use of this resolver is optional.
             * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#IndividualClaimsRequests} stating:
             * "Note that even if the Claims are not available because the End-User did not authorize their release or they are not present,
             * the Authorization Server MUST NOT generate an error when Claims are not returned, whether they are Essential or Voluntary,
             * unless otherwise specified in the description of the specific claim."
             *
             * @param {org.forgerock.openidconnect.Claim} claim
             * An object that provides methods to obtain information/requirements associated with a claim.
             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.
             * @returns {*}
             * @throws {org.forgerock.oauth2.core.exceptions.InvalidRequestException}
             */
            function resolveEssentialClaim(claim) {
                var claimValue = resolveClaim(claim);

                if (claim.isEssential() && !isClaimValueValid(claimValue)) {
                    throw new frJava.InvalidRequestException('Could not provide value for essential claim: ' + claim.getName());
                }

                return claimValue;
            }

            return resolveEssentialClaim;
        }

        /**
         * Provides default resolution for a claim.
         * Use it if a claim-specific resolver is not defined in the configuration.
         * @param {org.forgerock.openidconnect.Claim} claim
         * An object that provides methods to obtain information/requirements associated with a claim.
         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.
         * @returns {*} A single value associated with this claim.
         */
        function resolveAnyClaim (claim) {
            if (claim.getValues().size() === 1) {
                return claim.getValues().toArray()[0];
            }
        }

        // UTILITIES

        /**
         * Returns claim value from a set.
         * If the set contains a single value, returns the value.
         * If the set contains multiple values, returns the set.
         * Otherwise, returns undefined.
         *
         * @param {org.forgerock.openidconnect.Claim} claim
         * An object that provides methods to obtain information/requirements associated with a claim.
         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.
         * @param {java.util.HashSet} set The set—for example, a user profile attribute value.
         * @returns {string|java.util.HashSet|undefined}
         */
        function getClaimValueFromSet (claim, set) {
            if (set && set.size()) {
                if (set.size() === 1) {
                    return set.toArray()[0];
                } else {
                    return set;
                }
            } else if (logger.warningEnabled()) {
                logger.warning('OIDC Claims script. Got an empty set for claim: ' + claim.getName());
            }
        }

        function isClaimValueValid (claimValue) {
            if (typeof claimValue === 'undefined' || claimValue === null) {
                return false;
            }

            return true;
        }

        // CLAIM PROCESSING

        /**
         * Constructs and returns an object populated with the computed claim values
         * and the requested scopes mapped to the claim names.
         * @returns {org.forgerock.oauth2.core.UserInfoClaims} The object to be returned to the authorization server.
         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html}.
         * @see RESULTS section for the use of this function.
         */
        function getUserInfoClaims () {
            return new frJava.UserInfoClaims(getComputedClaims(), getCompositeScopes());
        }

        /**
         * Creates a map of (requested) claim names populated with the computed claim values.
         * @returns {java.util.LinkedHashMap}
         * A map of the requested claim names and the corresponding claim values.
         */
        function getComputedClaims () {
            /**
             * Creates a complete list of claim objects from:
             * the claims derived from the scopes,
             * the claims provided by the authorization server,
             * and the claims requested by the client.
             * @returns {java.util.ArrayList}
             * Returns a complete list of org.forgerock.openidconnect.Claim objects available to the script.
             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for the claim object details.
             */
            function getClaims() {
                /**
                 * Returns a list of claim objects for the requested scopes.
                 * Uses the scopeClaimsMap configuration option to derive the claim names;
                 * no other properties of a claim derived from a scope are populated.
                 * @returns {java.util.ArrayList}
                 * A list of org.forgerock.openidconnect.Claim objects derived from the requested scopes.
                 * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for the claim object details.
                 */
                function convertScopeToClaims() {
                    var claims = new frJava.ArrayList();

                    scopes.toArray().forEach(function (scope) {
                        if (String(scope) !== 'openid' && scopeClaimsMap[scope]) {
                            scopeClaimsMap[scope].forEach(function (claimName) {
                                claims.add(new frJava.Claim(claimName));
                            });
                        }
                    });

                    return claims;
                }

                var claims = new frJava.ArrayList();

                claims.addAll(convertScopeToClaims());
                claims.addAll(claimObjects);
                claims.addAll(requestedTypedClaims);

                return claims;
            }

            /**
             * Computes and returns a claim value.
             * To obtain the claim value, uses the resolver function specified for the claim in the claimResolvers configuration object.
             * @see claimResolvers
             * If no resolver function is found, uses the default claim resolver function.
             *
             * @param {org.forgerock.openidconnect.Claim} claim
             * An object that provides methods to obtain information/requirements associated with a claim.
             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.
             * @returns {*} Claim value.
             * @throws {org.forgerock.oauth2.core.exceptions.InvalidRequestException}
             * Rethrows this exception if a claim resolver throws it.
             * You can throw org.forgerock.oauth2.core.exceptions.InvalidRequestException from your custom claim resolver
             * if you want to terminate the claim processing.
             */
            function computeClaim(claim) {
                var resolveClaim;
                var message;

                try {
                    resolveClaim = claimResolvers[claim.getName()] || resolveAnyClaim;

                    return resolveClaim(claim);
                } catch (e) {
                    message = 'OIDC Claims script exception. Unable to resolve OIDC Claim. ' + e;

                    if (String(e).indexOf('org.forgerock.oauth2.core.exceptions.InvalidRequestException') !== -1) {
                        throw e;
                    }

                    if (logger.warningEnabled()) {
                        logger.warning(message);
                    }
                }
            }

            var computedClaims = new frJava.LinkedHashMap();

            getClaims().toArray().forEach(function (claim) {
                var claimValue = computeClaim(claim);

                if (isClaimValueValid(claimValue)) {
                    computedClaims.put(claim.getName(), claimValue);
                } else {
                    /**
                     * If a claim has been processed, but appears in the list again,
                     * and its value cannot be computed under the new conditions,
                     * the claim is removed from the final result.
                     *
                     * For example, a claim could be mapped to a scope and found in the user profile,
                     * but also requested by the client with required values that don't match the computed one.
                     * @see {link https://openid.net/specs/openid-connect-core-1_0.html#IndividualClaimsRequests}.
                     * for the relevant OIDC specification details.
                     */
                    computedClaims.remove(claim.getName());
                }
            });

            return computedClaims;
        }

        /**
         * Creates a map of requested scopes and the corresponding claim names.
         * @returns {java.util.LinkedHashMap}
         */
        function getCompositeScopes () {
            var compositeScopes = new frJava.LinkedHashMap();

            scopes.toArray().forEach(function (scope) {
                var scopeClaims = new frJava.ArrayList();

                if (scopeClaimsMap[scope]) {
                    scopeClaimsMap[scope].forEach(function (claimName) {
                        scopeClaims.add(claimName);
                    });
                }

                if (scopeClaims.size()) {
                    compositeScopes.put(scope, scopeClaims);
                }
            });

            return compositeScopes;
        }

        // PUBLIC METHODS

        return {
            setScopeClaimsMap: setScopeClaimsMap,
            setClaimResolvers: setClaimResolvers,
            getUserProfileClaimResolver: getUserProfileClaimResolver,
            getAddressClaimResolver: getAddressClaimResolver,
            getEssentialClaimResolver: getEssentialClaimResolver,
            getUserInfoClaims: getUserInfoClaims
        };
    }

    // RESULTS

    /**
     * This script returns an instance of the org.forgerock.oauth2.core.UserInfoClaims class
     * populated with the computed claim values and
     * the requested scopes mapped to the claim names.
     * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html}.
     *
     * Assigning it to a variable gives you an opportunity
     * to log the content of the returned value during development.
     */
    var userInfoClaims = utils.getUserInfoClaims();

    /*
    logger.error(scriptName + ' results:')
    logger.error('Values: ' + userInfoClaims.getValues())
    logger.error('Scopes: ' + userInfoClaims.getCompositeScopes())
    */

    return userInfoClaims;
}());
"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./OIDC-Claims-Script.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "36863ffb-40ec-48b9-94b1-9a99f71cc3b5": {
      "_id": "36863ffb-40ec-48b9-94b1-9a99f71cc3b5",
      "context": "OIDC_CLAIMS",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Default global script for OIDC claims",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "OIDC Claims Script",
      "script": "file://OIDC-Claims-Script.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./OTP-Invalid.script.js 1`] = `
"/* OTP Invalid
 *
 * Author: volker.scheuber@forgerock.com
 * 
 * Return TextOutputCallback indicating the provided OTP was invalid.
 * 
 * This script does not need to be parametrized. It will work properly as is.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 */
outcome = "true";
var fr = JavaImporter(
    org.forgerock.openam.auth.node.api.Action,
    javax.security.auth.callback.TextOutputCallback
)
if (callbacks.isEmpty()) {
    action = fr.Action.send(
        new fr.TextOutputCallback(
            fr.TextOutputCallback.INFORMATION,
            "INVALID"
        )
    ).build()
}
else {
  action = fr.Action.goTo(outcome).build();
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./OTP-Invalid.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "89eff37a-2e1e-47c2-8d62-5f7417fbb6b4": {
      "_id": "89eff37a-2e1e-47c2-8d62-5f7417fbb6b4",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Return TextOutputCallback indicating the provided OTP was invalid.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "OTP Invalid",
      "script": "file://OTP-Invalid.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./OTP-Valid.script.js 1`] = `
"/* OTP Valid
 *
 * Author: volker.scheuber@forgerock.com
 * 
 * Return TextOutputCallback indicating the provided OTP was valid.
 * 
 * This script does not need to be parametrized. It will work properly as is.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 */
outcome = "true";
var fr = JavaImporter(
    org.forgerock.openam.auth.node.api.Action,
    javax.security.auth.callback.TextOutputCallback
)
if (callbacks.isEmpty()) {
    action = fr.Action.send(
        new fr.TextOutputCallback(
            fr.TextOutputCallback.INFORMATION,
            "VALID"
        )
    ).build()
}
else {
  action = fr.Action.goTo(outcome).build();
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./OTP-Valid.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "5dbd53c6-67ff-4a43-84c3-90c5cf5da35a": {
      "_id": "5dbd53c6-67ff-4a43-84c3-90c5cf5da35a",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Return TextOutputCallback indicating the provided OTP was valid.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "OTP Valid",
      "script": "file://OTP-Valid.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Okta-API-AuthN.script.js 1`] = `
"/* Okta Passthru Authentication
 *
 * Authors: chico.demettroff@forgerock.com, volker.scheuber@forgerock.com
 * 
 * Okta pass through authentication using Okta Authentication API.
 * 
 * This script needs to be parametrized. It will not work properly as is. 
 * It requires the Platform Username and Platform Password collector nodes
 * before it can operate.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - Success
 * - Failure
 * - Timeout
 * - Error
 */
logger.message("Okta Passthru Authentication: start");

if (sharedState.get("username") && transientState.get("password")) {
      /*
     * BEGIN SCRIPT CONFIGURATION
     *
     * REPLACE WITH YOUR OWN OKTA TENANT SETTINGS
     *
     */
    var OKTA_API_URI = "https://dev-18030933.okta.com/api/v1/authn/";
    /*
     * END SCRIPT CONFIGURATION
     */

    var request = new org.forgerock.http.protocol.Request();
    request.setMethod('POST');
    request.setUri(OKTA_API_URI);
    request.getHeaders().add("Content-Type", "application/json");
      //var body =     "{\\"username\\":".concat(sharedState.get("username")).concat(",\\"password\\":").concat(transientState.get("password")).concat(",\\"options\\":{\\"multiOptionalFactorEnroll\\":true,\\"warnBeforePasswordExpired\\":true}}");
    var body = {
        "username": sharedState.get("username"),
        "password": transientState.get("password"),
        "options": {
            "multiOptionalFactorEnroll": true,
            "warnBeforePasswordExpired": true
        }
    }
      request.getEntity().setJson(body);

    var response = httpClient.send(request).get();
    var result = JSON.parse(response.getEntity().getString());
    logger.message("Okta Passthru Authentication: JSON result: " + JSON.stringify(result));

      if (response.getStatus().getCode() === 200 && result.status === "SUCCESS") {
          outcome = "Success"
        transientState.put("oktaProfile", result._embedded.user.profile);
    } else {
        /* Outcomes:
         * - Success
         * - Failure
         * - Timeout
         * - Error
         *
         * Expected/known Error Codes:
         * E0000004 - Authentication failed.
         * E0000003 - The request body was not well-formed
         */
      
    /*
{
    "expiresAt": "2021-10-14T22:15:04.000Z",
    "status": "SUCCESS",
    "sessionToken": "20111FNVseT3WyCzBHFBi3dYtx980FHen46QKlWXRNTe1kRef3GQu1W",
    "_embedded": {
        "user": {
            "id": "00u1xqw851dEqM1Y15d7",
            "passwordChanged": "2021-09-21T18:26:25.000Z",
            "profile": {
                "login": "chico@crossfithighvoltage.com",
                "firstName": "chico",
                "lastName": "deme",
                "locale": "en",
                "timeZone": "America/Los_Angeles"
            }
        }
    },
    "_links": {
        "cancel": {
            "href": "https://dev-18030933.okta.com/api/v1/authn/cancel",
            "hints": {
                "allow": [
                    "POST"
                ]
            }
        }
    }
}
*/

  /*
  FAILED
  {
    "errorCode": "E0000004",
    "errorSummary": "Authentication failed",
    "errorLink": "E0000004",
    "errorId": "oae1Y3Kk_WvRAOBSDeG9qeyHQ",
    "errorCauses": []
}
*/
        transientState.put("oktaResult", result);
        if (result.timed_out) {
            outcome = "Timeout";
        } else if (result.errorCode === "E0000004") {
            outcome = "Failure";
        } else {
            outcome = "Error";
        }
        logger.message("Okta Passthru Authentication: errorCode = ".concat(result.errorCode));
        logger.message("Okta Passthru Authentication: errorSummary = ".concat(result.errorSummary));
        logger.message("Okta Passthru Authentication: errorId = ".concat(result.errorId));
    }
} else {
      outcome = "Error";
      logger.message("Okta Passthru Authentication: No user or password found in shared state! Use username and password collector nodes before this script to populate shared and transient states!'");
}
logger.message("Okta Passthru Authentication: End (outcome=".concat(outcome).concat(")"));"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Okta-API-AuthN.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "2eb48a0c-24e0-4dac-acaf-02085c142ec5": {
      "_id": "2eb48a0c-24e0-4dac-acaf-02085c142ec5",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Integration to Okta Authentication API okta_url/api/v1/authn",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Okta API AuthN",
      "script": "file://Okta-API-AuthN.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Okta-Profile-Normalization.script.groovy 1`] = `
"/*
 * Copyright 2022 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

import static org.forgerock.json.JsonValue.field
import static org.forgerock.json.JsonValue.json
import static org.forgerock.json.JsonValue.object

logger.warning("Okta rawProfile: "+rawProfile)

return json(object(
        field("id", rawProfile.id),
        field("displayName", rawProfile.name),
        field("givenName", rawProfile.first_name),
        field("familyName", rawProfile.last_name),
        field("photoUrl", rawProfile.picture.data.url),
        field("email", rawProfile.email),
        field("username", rawProfile.preferred_username)))"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Okta-Profile-Normalization.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "6325cf19-a49b-471e-8d26-7e4df76df0e2": {
      "_id": "6325cf19-a49b-471e-8d26-7e4df76df0e2",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Normalizes raw profile data from GitHub",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Okta Profile Normalization",
      "script": "file://Okta-Profile-Normalization.script.groovy",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Onfido-CaptureEvidence.script.js 1`] = `
"logger.error("Onfido-CaptureEvidence: Start");
/*
 * !!! Extend your authentication session time so your identity proofing flows don't time out !!!
 *
 * Authentication > Settings > Trees > Max Duration (Minutes)
 *
 * Set to 15 minutes.
 *
 */

/*
 * BEGIN SCRIPT CONFIGURATION
 */
var onfido_auth_token = String(sharedState.get("onfidoAuthToken"));
var onfido_dialog_title = "Join the Expanse family!";
var onfido_dialog_msg1 = "To open an Expanse account, we will need to verify your identity.";
var onfido_dialog_msg2 = "It will only take a couple of minutes.";
var onfido_country_code = "US";
/*
 * END SCRIPT CONFIGURATION
 */

var mobile = idRepository.getAttribute(sharedState.get("_id"), "telephoneNumber");
var smsNumber = "";
if (mobile && mobile.iterator().hasNext()) {
    smsNumber = String(mobile.iterator().next().toString());
}

// Inject Onfido SDK into login page
onfidoScript = String("var body=document.body;\\n" +
    "var script = document.createElement('script');\\n" +
    "document.getElementById('callbacksPanel').style.display = 'none';\\n" +
    "var onfido_div = document.createElement(\\"div\\");\\n" +
    "onfido_div.id=\\"onfido-mount\\";\\n" +
    "script.src = 'https://assets.onfido.com/web-sdk-releases/5.2.1/onfido.min.js';\\n" +
    "var head = document.head; \\n " +
    "var link = document.createElement(\\"link\\");  \\n" +
    "     link.type = \\"text/css\\"; \\n " +
    "     link.rel = \\"stylesheet\\"; \\n " +
    "     link.href = 'https://assets.onfido.com/web-sdk-releases/5.2.1/style.css'; \\n " +
    "    head.appendChild(link); \\n " +
    ";\\n" +
    "var onfido = {};\\n" +
    "script.onload=function() {\\n" +
    "    onfido=Onfido.init({\\n" +
    "       token: '" + onfido_auth_token + "', \\n" +
    "       useModal: true, \\n" +
    "       isModalOpen: true, \\n" +
    "       smsNumberCountryCode: '" + onfido_country_code + "', \\n" +
    "       userDetails: { \\n" +
    "           smsNumber: '" + smsNumber + "' \\n" +
    "       }, \\n" +
    "       steps: [\\n" +
    "           {\\n" +
    "               type:'welcome',\\n" +
    "               options:{\\n" +
    "                   title:'" + onfido_dialog_title + "',\\n" +
    "                   descriptions:[\\n" +
    "                       '" + onfido_dialog_msg1 + "',\\n" +
    "                       '" + onfido_dialog_msg2 + "',\\n" +
    "                   ]\\n" +
    "               }\\n" +
    "          },\\n" +
    "          'document',\\n" +
    "          'face',\\n" +
    "          'complete',\\n" +
    "       ],\\n" +
    "       onComplete: function(data){ console.log('DONE'); onfido.setOptions({ isModalOpen:false }); document.getElementById('loginButton_0').click(); } \\n" +
    "    })\\n" +
    "};\\n" +
    "document.body.appendChild(script);\\n");

var fr = JavaImporter(
    org.forgerock.openam.auth.node.api,
    javax.security.auth.callback.NameCallback,
    com.sun.identity.authentication.callbacks.ScriptTextOutputCallback
);

with (fr) {
    if (callbacks.isEmpty()) {
        logger.error("Onfido-CaptureEvidence: Sending callbacks");
        action = Action.send(new ScriptTextOutputCallback(onfidoScript)).build();
    } else {
        logger.error("Onfido-CaptureEvidence: End (outcome=true)");
        action = Action.goTo("true").build();
    }
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Onfido-CaptureEvidence.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "71545db5-ce01-46b1-b79f-d41af36bd548": {
      "_id": "71545db5-ce01-46b1-b79f-d41af36bd548",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Capture Evidence",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Onfido-CaptureEvidence",
      "script": "file://Onfido-CaptureEvidence.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Onfido-CheckApplicant.script.js 1`] = `
"logger.error("Onfido-CheckApplicant: Start");

/*
 * !!! Extend your authentication session time so your identity proofing flows don't time out !!!
 *
 * Authentication > Settings > Trees > Max Duration (Minutes)
 *
 * Set to 15 minutes.
 *
 */

/*
 * BEGIN SCRIPT CONFIGURATION
 *
 * REPLACE WITH YOUR OWN ONFIDO API TOKEN
 */
//var ONFIDO_API_TOKEN = "api_live.StUdfxdiCFb.YrzbadxB_R2-qG5lFUc3lWg6JAc3Cnq-"
var ONFIDO_API_TOKEN = "api_live.H5ysRusAomY.nbbkimoWc91cDZAWJZkJt0Tkqdjm1Rjr";
/*
 * END SCRIPT CONFIGURATION
 */

var requestBodyJson = {
    "applicant_id": String(sharedState.get("onfidoApplicantID")),
    "report_names": ["document", "facial_similarity_photo"]
}
// var requestBodyJson = {
//     "applicant_id": String(sharedState.get("onfidoApplicantID")),
//     "report_names": ["document"]
// }

var failure = true

var fr = JavaImporter(
    org.forgerock.http.protocol.Request
)

var request = new fr.Request()
request.setUri("https://api.onfido.com/v3/checks")
request.setMethod("POST")
request.getHeaders().add("Content-Type", "application/json; charset=UTF-8")
request.getHeaders().add("Authorization", "Token token=" + ONFIDO_API_TOKEN)
request.getEntity().setString(JSON.stringify(requestBodyJson))

var response = httpClient.send(request).get()
logger.error("Onfido-CheckApplicant: Initiate checks response: ".concat(response.getEntity().getString()));

if (response.getStatus().getCode() === 200) {
    var id = JSON.parse(response.getEntity().getString()).id
    failure = !id
    if (!failure) sharedState.put("onfidoAuthToken", id);
} else {
    failure = true
}

outcome = failure ? "false" : "true";
logger.error("Onfido-CheckApplicant: End (outcome=".concat(outcome).concat(")"));"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Onfido-CheckApplicant.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "d2a41d85-d33a-42d9-a7dd-50dfbc9fa7c0": {
      "_id": "d2a41d85-d33a-42d9-a7dd-50dfbc9fa7c0",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Check Applicant",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Onfido-CheckApplicant",
      "script": "file://Onfido-CheckApplicant.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Onfido-Meta-Tags.script.js 1`] = `
"/* Write HTML Meta Tags
 *
 * Author: volker.scheuber@forgerock.com
 * 
 * This script writes meta tags to the header.
 * 
 * This script does not need to be parametrized. It will work properly as is.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 */
(function () {
  var fr = JavaImporter(
      org.forgerock.openam.auth.node.api.Action,
      com.sun.identity.authentication.callbacks.ScriptTextOutputCallback
  )

  function createScript() {
    return String("\\n\\
    Array.prototype.slice.call(\\n\\
      document.getElementsByTagName('head')\\n\\
    ).forEach(\\n\\
      function (e) {\\n\\
        var meta = document.createElement('meta'); \\n\\
        meta.name = \\"author\\"; \\n\\
        meta.content = \\"John Doe\\"; \\n\\
        document.getElementsByTagName('head')[0].appendChild(meta); \\n\\
      }\\n\\
    )");
  }

  if (callbacks.isEmpty()) {
      action = fr.Action.send(
          new fr.ScriptTextOutputCallback(createScript())
      ).build()
  } else {
      action = fr.Action.goTo("true").build();
  }
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Onfido-Meta-Tags.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "8a768bb3-01cd-46b8-881c-b77f5a26c283": {
      "_id": "8a768bb3-01cd-46b8-881c-b77f5a26c283",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Write Onfido HTML Meta Tags",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Onfido-Meta-Tags",
      "script": "file://Onfido-Meta-Tags.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Phone-Validator-Line-Type.script.js 1`] = `
"/* Phone Validator - Line Type
 *
 * Author: volker.scheuber@forgerock.com
 * 
 * This script uses phonevalidator.com to determine the type of phone number stored in the user profile.
 * Get your own API Key at https://www.phonevalidator.com
 * 
 * This script needs to be parametrized. It will not work properly as is. 
 * It requires the Identify Existing User node before it is being called.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - CELL PHONE
 * - LANDLINE
 * - VOIP
 * - TOLL-FREE
 * - UNKNOWN
 * - failed
 */
logger.warning("Phone Validator - Line Type: start");

if (getSharedObjectAttribute("telephoneNumber") || (sharedState.get("_id") && idRepository.getAttribute(sharedState.get("_id"), "telephoneNumber").iterator().hasNext())) {

    /* BEGIN SCRIPT CONFIGURATION
     *
     * REPLACE WITH YOUR OWN AZURE AD SETTINGS
     *
       * Phone Validator - Line Type API Configuration
       * Get your own API Key at https://www.phonevalidator.com
     */
    var PV_API_KEY = "849d564a-594d-4bde-b691-afe5ddadd547";
    /*
     * END SCRIPT CONFIGURATION
     */

      var PV_API_TYPE = "basic";
    var PV_API_PHONE = getSharedObjectAttribute("telephoneNumber") || idRepository.getAttribute(sharedState.get("_id"), "telephoneNumber").iterator().next();
    var PV_API_URI = "https://www.phonevalidator.com/api/v2/phonesearch?apikey=".concat(PV_API_KEY).concat("&phone=").concat(PV_API_PHONE).concat("&type=").concat(PV_API_TYPE);    

    var request = new org.forgerock.http.protocol.Request();
    request.setMethod('GET');
    request.setUri(PV_API_URI);

    var response = httpClient.send(request).get();
    var result = JSON.parse(response.getEntity().getString());

    if (result["StatusCode"]=="200") {
        outcome = result["PhoneBasic"]["LineType"];
    } else {
        outcome = "failed";
    }
    logger.error("Phone Validator - Line Type: StatusCode = ".concat(result["StatusCode"]));
    logger.error("Phone Validator - Line Type: StatusMessage = ".concat(result["StatusMessage"]));
    logger.error("Phone Validator - Line Type: outcome = ".concat(outcome));
} else {
      outcome = "failed";
      logger.error("Phone Validator - Line Type: No user or phone number found! Use 'Identify Existing User node before this script to populate the user's _id in shared state or put a valid cell phone number into sharedState.objectAttributes.telephoneNumber!'");
    logger.error("Phone Validator - Line Type: outcome = ".concat(outcome));
}

/*
 * Read attributes in shared state for use with the Create/Patch Object nodes.
 */
function getSharedObjectAttribute(name) {
    var storage = sharedState.get("objectAttributes");
    if (storage) {
          if (storage.get) {
            return sharedState.get("objectAttributes").get(name);
        }
          else {
            return storage.name;
        }
    }
    return null;
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Phone-Validator-Line-Type.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "b63981d8-cb73-4e47-8749-e58654dcaa31": {
      "_id": "b63981d8-cb73-4e47-8749-e58654dcaa31",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "This script uses phonevalidator.com to determine the type of phone number stored in the user profile.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Phone Validator - Line Type",
      "script": "file://Phone-Validator-Line-Type.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Populate-Username-From-Email.script.js 1`] = `
"outcome = "true";

sharedState.put("username", getSharedObjectAttribute("mail"))
setSharedObjectAttribute("userName", getSharedObjectAttribute("mail"))

/*
 * Store attributes in shared state for use with the Create/Patch Object nodes.
 */
function setSharedObjectAttribute(name, value) {
       var storage = sharedState.get("objectAttributes");
    if (storage && value) {
          if (storage.put) {
              storage.put(name, value);
        }
          else {
              storage[name] = value;
        }
    }
    else if (value) {
        sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));
    }
}

/*
 * Read attributes in shared state for use with the Create/Patch Object nodes.
 */
function getSharedObjectAttribute(name) {
    var storage = sharedState.get("objectAttributes");
    if (storage) {
          if (storage.get) {
            return sharedState.get("objectAttributes").get(name);
        }
          else {
              return storage.name;
        }
    }
    return null;
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Populate-Username-From-Email.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "4855aac0-1efd-49c0-a153-3b9aadc911a6": {
      "_id": "4855aac0-1efd-49c0-a153-3b9aadc911a6",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Populate Username From Email",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Populate Username From Email",
      "script": "file://Populate-Username-From-Email.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Ready-Response.script.js 1`] = `
"/* Ready Response
 *
 * Author: volker.scheuber@forgerock.com
 * 
 * Return READY in a TextOutputCallback indicating that the journey layer is operational.
 * 
 * This script does not need to be parametrized. It will work properly as is.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 */
outcome = "true";
var fr = JavaImporter(
    org.forgerock.openam.auth.node.api.Action,
    javax.security.auth.callback.TextOutputCallback
)
if (callbacks.isEmpty()) {
    action = fr.Action.send(
        new fr.TextOutputCallback(
            fr.TextOutputCallback.INFORMATION,
            "READY"
        )
    ).build()
}
else {
  action = fr.Action.goTo(outcome).build();
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Ready-Response.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "1acc5535-13e2-4ed8-83e1-f4fefd86d243": {
      "_id": "1acc5535-13e2-4ed8-83e1-f4fefd86d243",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Readiness probe response",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Ready Response",
      "script": "file://Ready-Response.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Record-MFA.script.js 1`] = `
"/* MFA Status
 *
 * Author: volker.scheuber@forgerock.com
 * 
 * Record that MFA has been performed for this journey and no longer needs 
 * to be performed. This allows journeys and inner journeys to check that 
 * flag before performing MFA multiple times.
 * 
 * This script does not need to be parametrized. It will work properly as is.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 */
outcome = "true";
sharedState.put("mfaPerformed", "true");"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Record-MFA.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "a873fcd8-8f17-4675-9dd6-54ab1c11e2df": {
      "_id": "a873fcd8-8f17-4675-9dd6-54ab1c11e2df",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Record that MFA has been performed for this journey and no longer needs to be performed. This allows journeys and inner journeys to check that flag before performing MFA multiple times.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Record MFA",
      "script": "file://Record-MFA.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Remove-Button.script.js 1`] = `
"/* Remove Button
 *
 * Author: volker.scheuber@forgerock.com
 * 
 * Hide buttons on the journey page.
 * 
 * This script does not need to be parametrized. It will work properly as is.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 */
(function () {
    var script = "Array.prototype.slice.call(document.getElementsByTagName('button')).forEach(function (e) {e.style.display = 'none'})"
    var fr = JavaImporter(
        org.forgerock.openam.auth.node.api.Action,
        javax.security.auth.callback.TextOutputCallback,
        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback
    )
    var message = " "
    if (callbacks.isEmpty()) {
        action = fr.Action.send(
            new fr.TextOutputCallback(
                fr.TextOutputCallback.INFORMATION,
                message
            ),
            new fr.ScriptTextOutputCallback(script)
        ).build()
    }
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Remove-Button.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "9535446c-0ff6-4a76-8576-616599119d64": {
      "_id": "9535446c-0ff6-4a76-8576-616599119d64",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Remove button from page.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Remove Button",
      "script": "file://Remove-Button.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Remove-Button-imported-(1).script.js 1`] = `
"/* Remove Button
 *
 * Author: volker.scheuber@forgerock.com
 * 
 * Hide buttons on the journey page.
 * 
 * This script does not need to be parametrized. It will work properly as is.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 */
(function () {
    var script = "Array.prototype.slice.call(document.getElementsByTagName('button')).forEach(function (e) {e.style.display = 'none'})"
    var fr = JavaImporter(
        org.forgerock.openam.auth.node.api.Action,
        javax.security.auth.callback.TextOutputCallback,
        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback
    )
    var message = " "
    if (callbacks.isEmpty()) {
        action = fr.Action.send(
            new fr.TextOutputCallback(
                fr.TextOutputCallback.INFORMATION,
                message
            ),
            new fr.ScriptTextOutputCallback(script)
        ).build()
    }
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Remove-Button-imported-(1).script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "3814d347-a2f2-4be9-a810-ab41a1e374bd": {
      "_id": "3814d347-a2f2-4be9-a810-ab41a1e374bd",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Hide buttons on the journey page.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Remove Button - imported (1)",
      "script": "file://Remove-Button-imported-(1).script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Resend-OTP-Option.script.js 1`] = `
"/* CResend OTP Option
 *
 * Author: jon.knight@forgerock.com, volker.scheuber@forgerock.com
 * 
 * Collect OTP and validate the collected OTP. Also offer a resend option.
 * Return "true" if collected OTP is valid, "false" if collected OTP is invalid, 
 * and resend if the user selected the resend button.
 * 
 * This script does not need to be parametrized. It will work properly as is.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 * - false
 * - resend
 */
(function () {
  // how long until the "resend" button becomes enabled.
  DELAY=20;
  
  // how long (in seconds) should the OTP be accepted as valid
  OTP_TTL = 30;

  var fr = JavaImporter(
      org.forgerock.openam.auth.node.api.Action,
      javax.security.auth.callback.NameCallback,
      com.sun.identity.authentication.callbacks.ScriptTextOutputCallback
  )

  function createScript() {
      return String(" \\n\\
          var COUNT = " + DELAY + "; \\n\\
          function go(obs) { \\n\\
              const p = document.querySelectorAll('input[data-vv-as=\\"One Time Passcode\\"]')[0]; \\n\\
              if (p) { \\n\\
                  var b = document.createElement('button'); \\n\\
                  b.id = 'resendButton'; \\n\\
                  b.classList.add(\\"btn\\", \\"mt-3\\", \\"btn-secondary\\", \\"btn-sm\\"); \\n\\
                  b.onclick = function() { p.value='___RESEND___'; p.dispatchEvent(new Event('input')); }; \\n\\
                  b.innerHTML = 'Resend Code ... ' + COUNT + 's'; \\n\\
                  b.disabled = true; \\n\\
                  p.parentNode.insertBefore(b, p.nextSibling); \\n\\
                  var t = setInterval(function() { \\n\\
                      if (COUNT == 1) { \\n\\
                          clearInterval(t); \\n\\
                          b.disabled = false; \\n\\
                          b.innerHTML = 'Resend Code'; \\n\\
                      } else { \\n\\
                          COUNT--; \\n\\
                          b.innerHTML = 'Resend Code ... ' + COUNT + 's'; \\n\\
                      } \\n\\
                  }, 1000 ); \\n\\
                  if (obs) obs.disconnect(); \\n\\
                  return; \\n\\
              } \\n\\
          } \\n\\
          if (document.querySelectorAll('input[data-vv-as=\\"One Time Passcode\\"]')[0]) go(); \\n\\
          else { \\n\\
              const observer = new MutationObserver((mutations, obs) => { go(obs); }); \\n\\
              observer.observe(document, { childList: true, subtree: true }); \\n\\
          } \\n\\
      ");
  }

  if (callbacks.isEmpty()) {
      action = fr.Action.send(
          new fr.ScriptTextOutputCallback(createScript()),
          new fr.NameCallback("One Time Passcode")
      ).build()
  } else {
      var otpTimestamp = Math.floor(new java.util.Date().getTime() / 1000);
      var otp = callbacks.get(1).getName();
      if (otp === "___RESEND___") {
          action = fr.Action.goTo("resend").build();
      } else {
          var sentOtp = sharedState.get("oneTimePassword");
          var sentOtpTimestamp = sharedState.get("oneTimePasswordTimestamp");
          if (sentOtp == otp && otpTimestamp - OTP_TTL >= sentOtpTimestamp) {
              action = fr.Action.goTo("true").build();
            }
          else {
            action = fr.Action.goTo("false").build();
          }
      }
  }
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Resend-OTP-Option.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "4ee5b182-1b09-45cc-97a9-0e609f0a2915": {
      "_id": "4ee5b182-1b09-45cc-97a9-0e609f0a2915",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Resend OTP Option",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Resend OTP Option",
      "script": "file://Resend-OTP-Option.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Reset-Theme.script.js 1`] = `
"/* Reset Theme
 * 
 * Reset theme to what's preserved in shared state variable "themeId" or to default theme.
 * 
 * This script needs to be parametrized!
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 *
 * Author: volker.scheuber@forgerock.com
 */
(function () {
      /* Begin Script Configuration */
      var defaultTheme = "Expanse";
      /* End Script Configuration */
      
      outcome = "true";
      
      var theme = defaultTheme;
      if (sharedState.get("themeId") && ""+sharedState.get("themeId") !== "") {
          theme = sharedState.get("themeId");
    }

    var fr = JavaImporter(
        org.forgerock.openam.auth.node.api.Action,
        org.forgerock.openam.authentication.callbacks.PollingWaitCallback
    )
    if (callbacks.isEmpty()) {
        var stage = "themeId="+theme;
        action = fr.Action.send(
              new fr.PollingWaitCallback("100", "Please wait ...")
        ).withStage(stage).build();
    } else {
          action = fr.Action.goTo(outcome).build();
    }
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Reset-Theme.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "199405e4-050e-4f2a-87d1-d9125f74a8df": {
      "_id": "199405e4-050e-4f2a-87d1-d9125f74a8df",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Reset theme to what's preserved in shared state variable "theme-id" or to default theme.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Reset Theme",
      "script": "file://Reset-Theme.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./ResetPasswordReplayCredentials.script.js 1`] = `
"/* ResetPasswordReplayCredentials
 *
 * Author: volker.scheuber@forgerock.com
 * 
 * Reset the attributes holding replay credentials for the IG replay use case.
 * 
 * This script needs to be parametrized for your env.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 */
(function () {
  outcome = "true";
  var REPLAY_USERNAME_IDM_ATTR = "frUnindexedString1";
  var REPLAY_PASSWORD_IDM_ATTR = "frUnindexedString2";
  
  sharedState.get("objectAttributes").put(REPLAY_USERNAME_IDM_ATTR, null);
  sharedState.get("objectAttributes").put(REPLAY_PASSWORD_IDM_ATTR, null);
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./ResetPasswordReplayCredentials.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "a8f10e93-3f6c-4d6c-b6a3-a8453e3d6b3a": {
      "_id": "a8f10e93-3f6c-4d6c-b6a3-a8453e3d6b3a",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Reset the attributes holding replay credentials for the IG replay use case.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "ResetPasswordReplayCredentials",
      "script": "file://ResetPasswordReplayCredentials.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Return-OTP.script.js 1`] = `
"/* Return OTP
 *
 * Author: volker.scheuber@forgerock.com
 * 
 * Return the generated OTP using a TextOutputCallback.
 * 
 * This script does not need to be parametrized. It will work properly as is.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 */
outcome = "true";
var fr = JavaImporter(
    org.forgerock.openam.auth.node.api.Action,
    javax.security.auth.callback.TextOutputCallback
)
if (callbacks.isEmpty()) {
    action = fr.Action.send(
        new fr.TextOutputCallback(
            fr.TextOutputCallback.INFORMATION,
            nodeState.get("oneTimePassword").asString()
        )
    ).build()
}
else {
  action = fr.Action.goTo(outcome).build();
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Return-OTP.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "d3405f9c-d338-4dc2-b00d-7aacf77b731d": {
      "_id": "d3405f9c-d338-4dc2-b00d-7aacf77b731d",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Return the generated OTP using a TextOutputCallback",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Return OTP",
      "script": "file://Return-OTP.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Routed-IDP-Persist-Decision.script.js 1`] = `
"/* Routed IDP Persist Decision
 * 
 * Branch based on the IDP setting.
 * 
 * This script does not need to be parametrized. It will work properly as is.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 * - false
 *
 * Author: volker.scheuber@forgerock.com
 */
(function () {
      logger.message("Routed IDP Persist Decision: Start");
      outcome = "false";
      var routedIDP = sharedState.get("routedIDPs").get(0);
      if (routedIDP) {
        outcome = "".concat(routedIDP.get("idpPersist"));
    }
      logger.message("Routed IDP Persist Decision: Done [outcome={}]", outcome);
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Routed-IDP-Persist-Decision.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "5b553f58-16bd-42b7-a782-4a981a66dbd4": {
      "_id": "5b553f58-16bd-42b7-a782-4a981a66dbd4",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Branch based on the IDP setting.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Routed IDP Persist Decision",
      "script": "file://Routed-IDP-Persist-Decision.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./ST_healthcare-idc-social-transformation.script.groovy 1`] = `
"/*
 * Copyright 2022 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock. Not for production use.
 * Modified by Stephen Payne
 */
/* Social Identity Provider Profile Transformation script for Healthcare ID Cloud */
import static org.forgerock.json.JsonValue.field
import static org.forgerock.json.JsonValue.json
import static org.forgerock.json.JsonValue.object

logger.error("ST_healthcare-idc-social-transformation Healthcare ID Cloud Identity Provider Profile Transformation script: Start");

logger.error("ST_healthcare-idc-social-transformation Profile Transformation script: Start");
logger.error("ST_healthcare-idc-social-transformationy: givenName " + rawProfile.givenName);
logger.error("ST_healthcare-idc-social-transformation: sn: " +rawProfile.familyName);
logger.error("ST_healthcare-idc-social-transformation: id: " +rawProfile.id);
logger.error("ST_healthcare-idc-social-transformation: mail: " + rawProfile.email);
logger.error("ST_healthcare-idc-social-transformation: cn: " + rawProfile.displayName);
logger.error("ST_healthcare-idc-social-transformation: userName: " + rawProfile.username);
logger.error("ST_healthcare-idc-social-transformation: id: " + rawProfile.id.asString());
//logger.error("ST_healthcare-idc-social-transformation: iplanet-am-user-alias-list: " + selectedIdp + '-' + rawProfile.id.asString() );
//logger.error("ST_healthcare-idc-social-transformation: selectedIdp: " + selectedIdp);
if (rawProfile.fhirUser.isNotNull()) logger.error("ST_healthcare-idc-social-transformation: fhirUser: " + rawProfile.fhirUser);
if (rawProfile.IAL.isNotNull()) logger.error("ST_healthcare-idc-social-transformatio: IAL: " + rawProfile.IAL);




return json(object(
        field("id", rawProfile.sub),
        field("displayName", rawProfile.name),
        field("givenName", rawProfile.given_name),
        field("familyName", rawProfile.family_name),
        field("email", rawProfile.email),
        field("username", rawProfile.email),
        field("IAL", rawProfile.IAL),  
        field("telephoneNumber", rawProfile.phone_number),
        field("fhirUser", rawProfile.fhirUser),
        field("userType", rawProfile.userType),
        )
)"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./ST_healthcare-idc-social-transformation.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "d2cf4f18-651a-4a3c-9b04-ee4fc896d0c3": {
      "_id": "d2cf4f18-651a-4a3c-9b04-ee4fc896d0c3",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Social Identity Provider Profile Transformation for ForgeRock OIDC Providers",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "ST_healthcare-idc-social-transformation",
      "script": "file://ST_healthcare-idc-social-transformation.script.groovy",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Salesforce-Profile-Normalization.script.groovy 1`] = `
"/*
 * Copyright 2020 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

import static org.forgerock.json.JsonValue.field
import static org.forgerock.json.JsonValue.json
import static org.forgerock.json.JsonValue.object

return json(object(
        field("id", rawProfile.user_id),
        field("displayName", rawProfile.name),
        field("givenName", rawProfile.given_name),
        field("familyName", rawProfile.family_name),
        field("photoUrl", rawProfile.picture),
        field("email", rawProfile.email),
        field("username", rawProfile.email),
        field("locale", rawProfile.zoneInfo)))"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Salesforce-Profile-Normalization.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "312e951f-70c5-49d2-a9ae-93aef909d5df": {
      "_id": "312e951f-70c5-49d2-a9ae-93aef909d5df",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from Salesforce",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Salesforce Profile Normalization",
      "script": "file://Salesforce-Profile-Normalization.script.groovy",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Saml2-IDP-Adapter-Always-Auth.script.js 1`] = `
"/*
 * Copyright 2021-2022 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

/*
 * The script has these top level functions that could be executed during a SAML2 flow.
 *      - preSingleSignOn
 *      - preAuthentication
 *      - preSendResponse
 *      - preSignResponse
 *      - preSendFailureResponse
 *
 * Please see the javadoc for the interface definition and more information about these methods.
 * https://backstage.forgerock.com/docs/am/7.2/apidocs/com/sun/identity/saml2/plugins/SAML2IdentityProviderAdapter.html
 * Note that the initialize method is not supported in the scripts.
 *
 * Defined variables. Check the documentation on the respective functions for the variables available to it.
 *
 * hostedEntityId - String
 *     Entity ID for the hosted IDP
 * realm - String
 *     Realm of the hosted IDP
 * idpAdapterScriptHelper - IdpAdapterScriptHelper (1)
 *     An instance of IdpAdapterScriptHelper containing helper methods. See Javadoc for more details.
 * request - HttpServletRequest (2)
 *     Servlet request object
 * response - HttpServletResponse (3)
 *     Servlet response object
 * authnRequest - AuthnRequest (4)
 *     The original authentication request sent from SP
 * reqId - String
 *     The id to use for continuation of processing if the adapter redirects
 * res - Response (5)
 *     The SAML Response
 * session - SSOToken (6)
 *     The single sign-on session. The reference type of this is Object and would need to be casted to SSOToken.
 * relayState - String
 *     The relayState that will be used in the redirect
 * faultCode - String
 *     the fault code that will be returned in the SAML response
 * faultDetail - String
 *     the fault detail that will be returned in the SAML response
 * logger - Logger instance
 *     https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.
 *     Corresponding log files will be prefixed with: scripts.<script name>
 *
 * Throws SAML2Exception (7):
 *     for any exceptions occurring in the adapter. The federation process will continue
 *
 * Class reference:
 * (1) idpAdapterScriptHelper - https://backstage.forgerock.com/docs/am/7.2/apidocs/com/sun/identity/saml2/plugins/scripted/IdpAdapterScriptHelper.html.
 * (2) HttpServletRequest - https://tomcat.apache.org/tomcat-7.0-doc/servletapi/javax/servlet/http/HttpServletRequest.html.
 * (3) HttpServletResponse - https://tomcat.apache.org/tomcat-7.0-doc/servletapi/javax/servlet/http/HttpServletResponse.html.
 * (4) AuthnRequest - https://backstage.forgerock.com/docs/am/7.2/apidocs/com/sun/identity/saml2/protocol/AuthnRequest.html.
 * (5) Response - https://backstage.forgerock.com/docs/am/7.2/apidocs/com/sun/identity/saml2/protocol/Response.html.
 * (6) SSOToken - https://backstage.forgerock.com/docs/am/7.2/apidocs/com/iplanet/sso/SSOToken.html.
 * (7) SAML2Exception - https://backstage.forgerock.com/docs/am/7.2/apidocs/com/sun/identity/saml2/common/SAML2Exception.html.
 */

/*
 * Template/default script for SAML2 IDP Adapter scripted plugin.
 */

/*
 * Available variables for preSingleSignOn:
 *     hostedEntityId
 *     realm
 *     idpAdapterScriptHelper
 *     request
 *     authnRequest
 *     response
 *     reqId
 *     logger
 *
 * Return - true if browser redirection is happening after processing, false otherwise. Default to false.
 */
function preSingleSignOn () {
      logger.error("Chicago: preSingleSignOn");
    return true;
}

/*
 * Available variables for preAuthentication:
 *     hostedEntityId
 *     realm
 *     idpAdapterScriptHelper
 *     request
 *     authnRequest
 *     response
 *     reqId
 *     session
 *     relayState
 *     logger
 *
 * Return - true if browser redirection is happening after processing, false otherwise. Default to false.
 */
function preAuthentication () {
      logger.error("Chicago: preAuthentication");
    return true;
}

/*
 * Available variables for preSendResponse:
 *     hostedEntityId
 *     realm
 *     idpAdapterScriptHelper
 *     request
 *     authnRequest
 *     response
 *     reqId
 *     session
 *     relayState
 *     logger
 *
 * Return - true if browser redirection happened after processing, false otherwise. Default to false.
 */
function preSendResponse () {
      logger.error("Chicago: preSendResponse");
      logger.error("Chicago: authnRequest: "+authnRequest);
      response.sendRedirect("https://idc.scheuber.io/am/XUI/?realm=alpha&authIndexType=service&authIndexValue=Dispatcher&ForceAuth=true&goto="+relayState);
    return true;
}

/*
 * Available variables for preSignResponse:
 *     hostedEntityId
 *     realm
 *     idpAdapterScriptHelper
 *     request
 *     authnRequest
 *     session
 *     relayState
 *     res
 *     logger
 */
function preSignResponse () {
      logger.error("Chicago: preSignResponse");
}

/*
 * Available variables for preSendFailureResponse:
 *     hostedEntityId
 *     realm
 *     idpAdapterScriptHelper
 *     request
 *     response
 *     faultCode
 *     faultDetail
 *     logger
 */
function preSendFailureResponse () {
      logger.error("Chicago: preSendFailureResponse");
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Saml2-IDP-Adapter-Always-Auth.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "85523e71-2d77-4577-b078-6f9674cc54e2": {
      "_id": "85523e71-2d77-4577-b078-6f9674cc54e2",
      "context": "SAML2_IDP_ADAPTER",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Always redirect browser pre-auth",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Saml2 IDP Adapter Always Auth",
      "script": "file://Saml2-IDP-Adapter-Always-Auth.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Saml2-IDP-Adapter-Script.script.js 1`] = `
"/*
 * Copyright 2021 ForgeRock AS. All Rights Reserved
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

/*
 * The script has these top level functions that could be executed during a SAML2 flow.
 *      - preSingleSignOn
 *      - preAuthentication
 *      - preSendResponse
 *      - preSignResponse
 *      - preSendFailureResponse
 *
 * Please see the javadoc for the interface definition and more information about these methods.
 * https://backstage.forgerock.com/docs/am/7.2/apidocs/com/sun/identity/saml2/plugins/SAML2IdentityProviderAdapter.html
 * Note that the initialize method is not supported in the scripts.
 *
 * Defined variables. Check the documentation on the respective functions for the variables available to it.
 *
 * hostedEntityId - String
 *     Entity ID for the hosted IDP
 * realm - String
 *     Realm of the hosted IDP
 * idpAdapterScriptHelper - IdpAdapterScriptHelper (1)
 *     An instance of IdpAdapterScriptHelper containing helper methods. See Javadoc for more details.
 * request - HttpServletRequest (2)
 *     Servlet request object
 * response - HttpServletResponse (3)
 *     Servlet response object
 * authnRequest - AuthnRequest (4)
 *     The original authentication request sent from SP
 * reqId - String
 *     The id to use for continuation of processing if the adapter redirects
 * res - Response (5)
 *     The SAML Response
 * session - SSOToken (6)
 *     The single sign-on session. The reference type of this is Object and would need to be casted to SSOToken.
 * relayState - String
 *     The relayState that will be used in the redirect
 * faultCode - String
 *     the fault code that will be returned in the SAML response
 * faultDetail - String
 *     the fault detail that will be returned in the SAML response
 * logger - Logger instance
 *     https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.
 *     Corresponding log files will be prefixed with: scripts.<script name>
 *
 * Throws SAML2Exception (7):
 *     for any exceptions occurring in the adapter. The federation process will continue
 *
 * Class reference:
 * (1) idpAdapterScriptHelper - https://backstage.forgerock.com/docs/am/7.2/apidocs/com/sun/identity/saml2/plugins/scripted/IdpAdapterScriptHelper.html.
 * (2) HttpServletRequest - https://tomcat.apache.org/tomcat-7.0-doc/servletapi/javax/servlet/http/HttpServletRequest.html.
 * (3) HttpServletResponse - https://tomcat.apache.org/tomcat-7.0-doc/servletapi/javax/servlet/http/HttpServletResponse.html.
 * (4) AuthnRequest - https://backstage.forgerock.com/docs/am/7.2/apidocs/com/sun/identity/saml2/protocol/AuthnRequest.html.
 * (5) Response - https://backstage.forgerock.com/docs/am/7.2/apidocs/com/sun/identity/saml2/protocol/Response.html.
 * (6) SSOToken - https://backstage.forgerock.com/docs/am/7.2/apidocs/com/iplanet/sso/SSOToken.html.
 * (7) SAML2Exception - https://backstage.forgerock.com/docs/am/7.2/apidocs/com/sun/identity/saml2/common/SAML2Exception.html.
 */

/*
 * Template/default script for SAML2 IDP Adapter scripted plugin.
 */

/*
 * Available variables for preSingleSignOn:
 *     hostedEntityId
 *     realm
 *     idpAdapterScriptHelper
 *     request
 *     authnRequest
 *     response
 *     reqId
 *     logger
 *
 * Return - true if browser redirection is happening after processing, false otherwise. Default to false.
 */
function preSingleSignOn () {
    return false;
}

/*
 * Available variables for preAuthentication:
 *     hostedEntityId
 *     realm
 *     idpAdapterScriptHelper
 *     request
 *     authnRequest
 *     response
 *     reqId
 *     session
 *     relayState
 *     logger
 *
 * Return - true if browser redirection is happening after processing, false otherwise. Default to false.
 */
function preAuthentication () {
    return false;
}

/*
 * Available variables for preSendResponse:
 *     hostedEntityId
 *     realm
 *     idpAdapterScriptHelper
 *     request
 *     authnRequest
 *     response
 *     reqId
 *     session
 *     relayState
 *     logger
 *
 * Return - true if browser redirection happened after processing, false otherwise. Default to false.
 */
function preSendResponse () {
    return false;
}

/*
 * Available variables for preSignResponse:
 *     hostedEntityId
 *     realm
 *     idpAdapterScriptHelper
 *     request
 *     authnRequest
 *     session
 *     relayState
 *     res
 *     logger
 */
function preSignResponse () {
}

/*
 * Available variables for preSendFailureResponse:
 *     hostedEntityId
 *     realm
 *     idpAdapterScriptHelper
 *     request
 *     response
 *     faultCode
 *     faultDetail
 *     logger
 */
function preSendFailureResponse () {
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Saml2-IDP-Adapter-Script.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "5b29c5b7-b161-4a42-a41f-d6c85316b951": {
      "_id": "5b29c5b7-b161-4a42-a41f-d6c85316b951",
      "context": "SAML2_IDP_ADAPTER",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Saml2 IDP Adapter Script",
      "script": "file://Saml2-IDP-Adapter-Script.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Saml2-IDP-Attribute-Mapper-Script.script.js 1`] = `
"/*
 * Copyright 2021 ForgeRock AS. All Rights Reserved
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

/*
 * This script returns a list of SAML Attribute objects for the IDP framework to insert into the generated Assertion.
 *
 * Defined variables:
 * session - SSOToken (1)
 *           The single sign-on session.
 * hostedEntityId - String (primitive).
 *                  The hosted entity ID.
 * remoteEntityId - String (primitive).
 *                  The remote entity ID.
 * realm - String (primitive).
 *         The name of the realm the user is authenticating to.
 * logger - Always present, the debug logger instance:
 *          https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.
 *          Corresponding log files will be prefixed with: scripts.SAML2_IDP_ATTRIBUTE_MAPPER
 * idpAttributeMapperScriptHelper - IdpAttributeMapperScriptHelper (2)
 *                                - An IdpAttributeMapperScriptHelper instance containing methods used for IDP attribute mapping.
 *
 * Throws SAML2Exception:
 *      - on failing to map the IDP attributes.
 *
 * Return - a list of SAML Attribute (3) objects.
 *
 * Class reference:
 * (1) SSOToken - https://backstage.forgerock.com/docs/am/7/apidocs/com/iplanet/sso/SSOToken.html.
 * (2) IdpAttributeMapperScriptHelper - https://backstage.forgerock.com/docs/am/7/apidocs/com/sun/identity/saml2/plugins/scripted/IdpAttributeMapperScriptHelper.html.
 * (3) Attribute - https://backstage.forgerock.com/docs/am/7/apidocs/com/sun/identity/saml2/assertion/Attribute.html.
 */

/**
 * Default SAML2 IDP Attribute Mapper.
 */
function getAttributes() {
    var frJava = JavaImporter(
        com.sun.identity.saml2.common.SAML2Exception
    );

    const debugMethod = "ScriptedIDPAttributeMapper.getAttributes:: ";

    try {

        if (!idpAttributeMapperScriptHelper.isSessionValid(session)) {
            logger.error(debugMethod + "Invalid session.");
            return null;
        }

        var configMap = idpAttributeMapperScriptHelper.getRemoteSPConfigAttributeMap(realm, remoteEntityId);
        logger.message(debugMethod + "Remote SP attribute map = {}", configMap);
        if (configMap == null || configMap.isEmpty()) {
            configMap = idpAttributeMapperScriptHelper.getHostedIDPConfigAttributeMap(realm, hostedEntityId);
            if (configMap == null || configMap.isEmpty()) {
                logger.message(debugMethod + "Configuration map is not defined.");
                return null;
            }
            logger.message(debugMethod + "Hosted IDP attribute map = {}", configMap);
        }

        var attributes = new java.util.ArrayList();
        var stringValueMap = new java.util.HashSet();
        var binaryValueMap;
        var localAttribute;

        // Don't try to read the attributes from the datastore if the ignored profile is enabled in this realm.
        if (!idpAttributeMapperScriptHelper.isIgnoredProfile(session, realm)) {
            try {
                // Resolve attributes to be read from the datastore.
                var stringAttributes = new java.util.HashSet();
                var binaryAttributes = new java.util.HashSet();
                var keyIter = configMap.keySet().iterator();
                while (keyIter.hasNext()) {
                    var key = keyIter.next();
                    localAttribute = configMap.get(key);
                    if (!idpAttributeMapperScriptHelper.isStaticAttribute(localAttribute)) {
                        if (idpAttributeMapperScriptHelper.isBinaryAttribute(localAttribute)) {
                            // add it to the list of attributes to treat as being binary
                            binaryAttributes.add(idpAttributeMapperScriptHelper.removeBinaryAttributeFlag(localAttribute));
                        } else {
                            stringAttributes.add(localAttribute);
                        }
                    }
                }

                if (!stringAttributes.isEmpty()) {
                    stringValueMap = idpAttributeMapperScriptHelper.getAttributes(session, stringAttributes);
                }
                if (!binaryAttributes.isEmpty()) {
                    binaryValueMap = idpAttributeMapperScriptHelper.getBinaryAttributes(session, binaryAttributes);
                }
            } catch (error) {
                logger.error(debugMethod + "Error accessing the datastore. " + error);
                //continue to check in ssotoken.
            }
        }

        var keyIter = configMap.keySet().iterator();
        while (keyIter.hasNext()) {
            var key = keyIter.next()
            var nameFormat = null;
            var samlAttribute = key;
            localAttribute = configMap.get(key);
            // check if samlAttribute has format nameFormat|samlAttribute
            var samlAttributes = String(new java.lang.String(samlAttribute));
            var tokens = samlAttributes.split('|');

            if (tokens.length > 1) {
                nameFormat = tokens[0];
                samlAttribute = tokens[1];
            }

            var attributeValues = new java.util.HashSet();
            if (idpAttributeMapperScriptHelper.isStaticAttribute(localAttribute)) {
                // Remove the static flag before using it as the static value
                localAttribute = idpAttributeMapperScriptHelper.removeStaticAttributeFlag(localAttribute);
                attributeValues = new java.util.HashSet([localAttribute]);
                logger.message(debugMethod + "Adding static value {} for attribute named {}", localAttribute, samlAttribute);
            } else {
                if (idpAttributeMapperScriptHelper.isBinaryAttribute(localAttribute)) {
                    // Remove the flag as not used for lookup
                    localAttribute = idpAttributeMapperScriptHelper.removeBinaryAttributeFlag(localAttribute);
                    attributeValues = idpAttributeMapperScriptHelper.getBinaryAttributeValues(samlAttribute, localAttribute,
                        binaryValueMap);
                } else {
                    if (stringValueMap != null && !stringValueMap.isEmpty()) {
                        attributeValues = stringValueMap.get(localAttribute);
                    } else {
                        logger.message(debugMethod + "{} string value map was empty or null.", localAttribute);
                    }
                }

                // If all else fails, try to get the value from the users ssoToken
                if (attributeValues == null || attributeValues.isEmpty()) {
                    logger.message(debugMethod + "User profile does not have value for {}, checking SSOToken.", localAttribute);
                    attributeValues = new java.util.HashSet(idpAttributeMapperScriptHelper.getPropertySet(session, localAttribute));
                }
            }

            if (attributeValues == null || attributeValues.isEmpty()) {
                logger.message(debugMethod + "{} not found in user profile or SSOToken.", localAttribute);
            } else {
                attributes.add(idpAttributeMapperScriptHelper.createSAMLAttribute(samlAttribute, nameFormat, attributeValues));
            }
        }

        return attributes;

    } catch (error) {
        logger.error(debugMethod + "Error mapping IDP attributes. " + error);
        throw new frJava.SAML2Exception(error);
    }
}

getAttributes();"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Saml2-IDP-Attribute-Mapper-Script.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "90c4eca5-05f0-42f5-b9bf-88b693eabbbd": {
      "_id": "90c4eca5-05f0-42f5-b9bf-88b693eabbbd",
      "context": "SAML2_IDP_ATTRIBUTE_MAPPER",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Saml2 IDP Attribute Mapper Script",
      "script": "file://Saml2-IDP-Attribute-Mapper-Script.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Sanitize-objectAttributes.script.js 1`] = `
"/*
{
    "userName": "sholmes",
    "givenName": "Sherlock",
    "sn": "Holmes",
    "mail": "info918@06152alerts.security.org",
    "telephoneNumber": ,
    "postalAddress": "221B Baker Street",
    "city": "London",
    "stateProvince": ,
    "postalCode": "NW1",
    "country": "United States",
    "preferences": {
        "marketing": false,
        "updates": true
    }
}
*/
logger.error("Sanitize objectAttributes: start");
outcome = "true";
var attrs = sharedState.get("objectAttributes");
if (attrs) {
  var keys = [
    "userName",
    "givenName",
    "sn",
    "mail",
    "telephoneNumber",
    "postalAddress",
    "city",
    "stateProvince",
    "postalCode",
    "country",
    "frIndexedString2"
  ]
  keys.forEach(function (key) {
    if (attrs.get(key) && attrs.get(key).toString() == "") {
      logger.error("Sanitize objectAttributes: remove ".concat(key));
      attrs.remove(key);
    }
  })
}
if (transientState.get("objectAttributes") && transientState.get("objectAttributes").get("password").toString() !== "") {
  logger.error("Sanitize objectAttributes: preserve password in shared state");
  setSharedObjectAttribute("password", transientState.get("objectAttributes").get("password").toString());
}
logger.error("Sanitize objectAttributes: end");

/*
 * Properly set attributes in shared state for use with the Create/Patch Object nodes.
 */
function setSharedObjectAttribute(name, value) {
    if (sharedState.get("objectAttributes")) {
        sharedState.get("objectAttributes").put(name, value);
    }
    else {
        sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":"+value+"}"));
    }
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Sanitize-objectAttributes.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "a064f7b7-29c5-480b-ac09-d3d122829278": {
      "_id": "a064f7b7-29c5-480b-ac09-d3d122829278",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Sanitize objectAttributes",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Sanitize objectAttributes",
      "script": "file://Sanitize-objectAttributes.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Saverestore-perpetrator.script.js 1`] = `
"outcome = "true";
if (sharedState.get("perpetrator"))
{
  sharedState.put("username", sharedState.get("perpetrator"));
//  if (sharedState.get("objectAttributes")) {
//    sharedState.remove("objectAttributes");
//  }
  sharedState.put("objectAttributes", {});
}
else
{
  sharedState.put("perpetrator", sharedState.get("username"));
  if (sharedState.get("objectAttributes") && 
      sharedState.get("objectAttributes").get("userName")) {
    sharedState.get("objectAttributes").remove("userName");
  }
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Saverestore-perpetrator.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "5b3b2c47-0248-46f4-8a1c-8a495d249037": {
      "_id": "5b3b2c47-0248-46f4-8a1c-8a495d249037",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Save/restore perpetrator",
      "script": "file://Saverestore-perpetrator.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Scripted-Module-Client-Side.script.js 1`] = `
"/*
 * Copyright 2016-2017 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */
/* Default Authentication client side script to use as a template for new scripts */"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Scripted-Module-Client-Side.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "c827d2b4-3608-4693-868e-bbcf86bd87c7": {
      "_id": "c827d2b4-3608-4693-868e-bbcf86bd87c7",
      "context": "AUTHENTICATION_CLIENT_SIDE",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Default global script for client side Scripted Authentication Module",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Scripted Module - Client Side",
      "script": "file://Scripted-Module-Client-Side.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Scripted-Module-Server-Side.script.js 1`] = `
"/*
 * Copyright 2015-2017 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

var START_TIME = 9;  // 9am
var END_TIME   = 17; // 5pm
var longitude, latitude;
var localTime;

logger.message("Starting scripted authentication");
logger.message("User: " + username);

var userPostalAddress = getUserPostalAddress();
logger.message("User address: " + userPostalAddress);

getLongitudeLatitudeFromUserPostalAddress();
getLocalTime();

logger.message("Current time at the users location: " + localTime.getHours());
if (localTime.getHours() < START_TIME || localTime.getHours() > END_TIME) {
    logger.error("Login forbidden outside work hours!");
    authState = FAILED;
} else {
    logger.message("Authentication allowed!");
    authState = SUCCESS;
}

function getLongitudeLatitudeFromUserPostalAddress() {

    var request = new org.forgerock.http.protocol.Request();
    request.setUri("http://maps.googleapis.com/maps/api/geocode/json?address=" + encodeURIComponent(userPostalAddress));
      request.setMethod("GET");
      //the above URI has to be extended with an API_KEY if used in a frequent manner
      //see documentation: https://developers.google.com/maps/documentation/geocoding/intro

    var response = httpClient.send(request).get();
    logResponse(response);

    var geocode = JSON.parse(response.getEntity().getString());
    var i;
    for (i = 0; i < geocode.results.length; i++) {
        var result = geocode.results[i];
        latitude = result.geometry.location.lat;
        longitude = result.geometry.location.lng;
      
           logger.message("latitude:" + latitude + " longitude:" + longitude);
    }
}

function getLocalTime() {

    var now = new Date().getTime() / 1000;
    var location = "location=" + latitude + "," + longitude;
    var timestamp = "timestamp=" + now;
        
    var request = new org.forgerock.http.protocol.Request();
    request.setUri("https://maps.googleapis.com/maps/api/timezone/json?" + location + "&" + timestamp);
      request.setMethod("GET");
      //the above URI has to be extended with an API_KEY if used in a frequent manner
      //see documentation: https://developers.google.com/maps/documentation/timezone/intro

    var response = httpClient.send(request).get();
    logResponse(response);

    var timezone = JSON.parse(response.getEntity().getString());
    var localTimestamp = parseInt(now) + parseInt(timezone.dstOffset) + parseInt(timezone.rawOffset);
    localTime = new Date(localTimestamp*1000);
}

function getUserPostalAddress() {
    var userAddressSet = idRepository.getAttribute(username, "postalAddress");
    if (userAddressSet == null || userAddressSet.isEmpty()) {
        logger.warning("No address specified for user: " + username);
        return false;
    }
    return userAddressSet.iterator().next()
}

function logResponse(response) {
    logger.message("User REST Call. Status: " + response.getStatus() + ", Body: " + response.getEntity().getString());
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Scripted-Module-Server-Side.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "7e3d7067-d50f-4674-8c76-a3e13a810c33": {
      "_id": "7e3d7067-d50f-4674-8c76-a3e13a810c33",
      "context": "AUTHENTICATION_SERVER_SIDE",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Default global script for server side Scripted Authentication Module",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Scripted Module - Server Side",
      "script": "file://Scripted-Module-Server-Side.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Scripted-Policy-Condition.script.js 1`] = `
"/*
 * Copyright 2015-2017 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */
/**
 * This is a Policy Condition example script. It demonstrates how to access a user's information,
 * use that information in external HTTP calls and make a policy decision based on the outcome.
 */

var userAddress, userIP, resourceHost;

if (validateAndInitializeParameters()) {

    var countryFromUserAddress = getCountryFromUserAddress();
    logger.message("Country retrieved from user's address: " + countryFromUserAddress);
    var countryFromUserIP = getCountryFromUserIP();
    logger.message("Country retrieved from user's IP: " + countryFromUserIP);
    var countryFromResourceURI = getCountryFromResourceURI();
    logger.message("Country retrieved from resource URI: " + countryFromResourceURI);

    if (countryFromUserAddress === countryFromUserIP && countryFromUserAddress === countryFromResourceURI) {
        logger.message("Authorization Succeeded");
        responseAttributes.put("countryOfOrigin", [countryFromUserAddress]);
        authorized = true;
    } else {
        logger.message("Authorization Failed");
        authorized = false;
    }

} else {
    logger.message("Required parameters not found. Authorization Failed.");
    authorized = false;
}

/**
 * Use the user's address to lookup their country of residence.
 *
 * @returns {*} The user's country of residence.
 */
function getCountryFromUserAddress() {

    var request = new org.forgerock.http.protocol.Request();
    request.setUri("http://maps.googleapis.com/maps/api/geocode/json?address=" + encodeURIComponent(userAddress));
      request.setMethod("GET");

    var response = httpClient.send(request).get();
    logResponse(response);

    var geocode = JSON.parse(response.getEntity().getString());
    var i;
    for (i = 0; i < geocode.results.length; i++) {
        var result = geocode.results[i];
        var j;
        for (j = 0; j < result.address_components.length; i++) {
            if (result.address_components[i].types[0] == "country") {
                return result.address_components[i].long_name;
            }
        }
    }
}

/**
 * Use the user's IP to lookup the country from which the request originated.
 *
 * @returns {*} The country from which the request originated.
 */
function getCountryFromUserIP() {
    var request = new org.forgerock.http.protocol.Request();
    request.setUri("http://ip-api.com/json/" + userIP);
      request.setMethod("GET");

    var response = httpClient.send(request).get();
    logResponse(response);

    var result = JSON.parse(response.getEntity().getString());
    if (result) {
        return result.country;
    }
}

/**
 * Use the requested resource's host name to lookup the country where the resource is hosted.
 *
 * @returns {*} The country in which the resource is hosted.
 */
function getCountryFromResourceURI() {
    var request = new org.forgerock.http.protocol.Request();
    request.setUri("http://ip-api.com/json/" + encodeURIComponent(resourceHost));
      request.setMethod("GET");

    var response = httpClient.send(request).get();
    logResponse(response);

    var result = JSON.parse(response.getEntity().getString());
    if (result) {
        return result.country;
    }
}

/**
 * Retrieve and validate the variables required to make the external HTTP calls.
 *
 * @returns {boolean} Will be true if validation was successful.
 */
function validateAndInitializeParameters() {
    var userAddressSet = identity.getAttribute("postalAddress");
    if (userAddressSet == null || userAddressSet.isEmpty()) {
        logger.warning("No address specified for user: " + username);
        return false;
    }
    userAddress = userAddressSet.iterator().next();
    logger.message("User address: " + userAddress);

    if (!environment) {
        logger.warning("No environment parameters specified in the evaluation request.");
        return false;
    }

    var ipSet = environment.get("IP");
    if (ipSet == null || ipSet.isEmpty()) {
        logger.warning("No IP specified in the evaluation request environment parameters.");
        return false;
    }
    userIP = ipSet.iterator().next();
    logger.message("User IP: " + userIP);

    if (!resourceURI) {
        logger.warning("No resource URI specified.");
        return false;
    }
    resourceHost = resourceURI.match(/^(.*:\\/\\/)(www\\.)?([A-Za-z0-9\\-\\.]+)(:[0-9]+)?(.*)$/)[3];
    logger.message("Resource host: " + resourceHost);

    return true;
}

function logResponse(response) {
    logger.message("User REST Call. Status: " + response.getStatus() + ", Body: " + response.getEntity().getString());
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Scripted-Policy-Condition.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "9de3eb62-f131-4fac-a294-7bd170fd4acb": {
      "_id": "9de3eb62-f131-4fac-a294-7bd170fd4acb",
      "context": "POLICY_CONDITION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Default global script for Scripted Policy Conditions",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Scripted Policy Condition",
      "script": "file://Scripted-Policy-Condition.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Select-Theme-by-Browser-Language.script.js 1`] = `
"/* Select Theme by Browser Language
 * 
 * Select and apply theme from based on the browser language in the request.
 * 
 * This script needs to be parametrized!
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 *
 * Author: volker.scheuber@forgerock.com
 */
(function () {
    /******************************/
    /* Begin Script Configuration */

    // the script expects the themes to be named <baseTheme>_<language>, e.g. "Zardoz_en"
    var baseTheme = "Zardoz";

    // add all the language codes you want to support
    var supportedLanguages = ["de", "en", "fr"];

    // specify the default language to fall back on if the browser language is not a supported language
    var defaultLanguage = "en";

    /* End Script Configuration   */
    /******************************/

    outcome = "true";
    var theme = getThemeByLanguage(baseTheme);
    var fr = JavaImporter(
        org.forgerock.openam.auth.node.api.Action,
        org.forgerock.openam.authentication.callbacks.PollingWaitCallback
    )
    if (theme && callbacks.isEmpty()) {
        var stage = "themeId=" + theme;
        action = fr.Action.send(
            new fr.PollingWaitCallback("100", "Please wait ...")
        ).withStage(stage).build();
    } else {
        action = fr.Action.goTo(outcome).build();
    }

    /*
     * Returns the name of the theme to select based on browser language
     */
    function getThemeByLanguage(theme) {
        var languageHeader = getHeader("accept-language");
        var language = languageHeader.split(';')[0].split(',')[0].split('-')[0];
        if (supportedLanguages.indexOf(language) < 0) {
            language = defaultLanguage;
        }
        return theme + "_" + language;
    }

    /*
     * Returns the value of the requested header
     */
    function getHeader(headerName) {
        return requestHeaders.get(headerName).get(0) + "";
    }
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Select-Theme-by-Browser-Language.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "847aab1b-c739-4d64-b26c-180f96cba02b": {
      "_id": "847aab1b-c739-4d64-b26c-180f96cba02b",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Select and apply theme from based on the browser language in the request.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Select Theme by Browser Language",
      "script": "file://Select-Theme-by-Browser-Language.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Select-Theme-from-URL.script.js 1`] = `
"/* Select Theme from URL
 * 
 * Select and apply theme from query param in the request URL.
 * 
 * This script does not need to be parametrized. It will work properly as is.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 *
 * Author: volker.scheuber@forgerock.com
 */
(function () {
      outcome = "true";
      var theme = "";
      if (requestParameters.get("themeId")) {
          theme = requestParameters.get("themeId").get(0);
    }

    var fr = JavaImporter(
        org.forgerock.openam.auth.node.api.Action,
        org.forgerock.openam.authentication.callbacks.PollingWaitCallback
    )
    if (theme && callbacks.isEmpty()) {
        var stage = "themeId="+theme;
        action = fr.Action.send(
              new fr.PollingWaitCallback("100", "Please wait ...")
        ).withStage(stage).build();
    } else {
          action = fr.Action.goTo(outcome).build();
    }
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Select-Theme-from-URL.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "50cde102-d4b6-44c4-9ba7-8564af05ae08": {
      "_id": "50cde102-d4b6-44c4-9ba7-8564af05ae08",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Select and apply theme from query param in the request URL.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Select Theme from URL",
      "script": "file://Select-Theme-from-URL.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Service-Account-Cluster-Internal-Requests-Only.script.js 1`] = `
"
try {
  var clientIpAddresses = requestHeaders.get(new java.lang.String('x-forwarded-for'));
  if (!clientIpAddresses) {
    logger.message('No forwarded header; internal cluster request');
    outcome = 'True'
  } else {
    logger.message('Forwarded header {}', clientIpAddresses);
    outcome = 'False';
  }
} catch (e) {
  logger.error('Service Account - Cluster Internal Requests Only - failed deducing header');
  logger.error(e);
  outcome = 'Error';
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Service-Account-Cluster-Internal-Requests-Only.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "58258c2d-46f3-4811-85c4-ea1476dd9cf4": {
      "_id": "58258c2d-46f3-4811-85c4-ea1476dd9cf4",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Service Account - Cluster Internal Requests Only",
      "script": "file://Service-Account-Cluster-Internal-Requests-Only.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Service-Account-JWT-Issuers.script.js 1`] = `
"(function () {
  var frJava = JavaImporter(
    org.forgerock.oauth2.core.TrustedJwtIssuerConfig,
    java.util.HashSet
  );

  with (frJava) {
    var iss = idRepository.getIdentity(issuer);
    if (iss == null) {
      logger.message('No issuer found for: ' + issuer);
      return null;
    }
    logger.message('Found issuer: ' + iss);

    var accountStatus = iss.getAttributeValues('inetUserStatus');
    if (!accountStatus || accountStatus.length === 0) {
      logger.message('No inetUserStatus attribute in issuer');
      return null;
    } else if (accountStatus[0].toLowerCase() != 'active') {
      logger.message('Issuer is not active');
      return null;
    }

    var jwksAttrs = iss.getAttributeValues('fr-attr-jwks');
    if (!jwksAttrs || jwksAttrs.length === 0) {
      logger.message('No jwks attributes in issuer');
      return null;
    }

    var jwkSet = jwksAttrs[0];
    if (!jwkSet) {
      logger.message('No jwk set in issuer');
      return null;
    }

    var config = new TrustedJwtIssuerConfig(
      issuer,
      'sub',
      'scope',
      new HashSet([issuer]),
      jwkSet,
      null, null, null
    );

    return config;
  }
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Service-Account-JWT-Issuers.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "fff76556-2882-4109-a9a6-c42d546cfe57": {
      "_id": "fff76556-2882-4109-a9a6-c42d546cfe57",
      "context": "OAUTH2_SCRIPTED_JWT_ISSUER",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Service Account - JWT Issuers",
      "script": "file://Service-Account-JWT-Issuers.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Service-Account-Token-Modification.script.js 1`] = `
"(function () {
  var fr = JavaImporter(
    java.lang.String,
    java.security.MessageDigest,
    java.util.Arrays,
    javax.crypto.Cipher,
    javax.crypto.spec.SecretKeySpec,
    org.forgerock.http.protocol.Request,
    org.forgerock.http.protocol.Response,
    org.forgerock.util.encode.Base64
  );
  
  var secret = 'FuwwVKpPER9tPSMYUiIkY7IaPzv85aGU';
  
  function encrypt(str) {
    try {
      var key = new fr.String(secret).getBytes('UTF-8');
      var sha = fr.MessageDigest.getInstance('SHA-256');
      key = sha.digest(key);
      key = fr.Arrays.copyOf(key, 32);
      var secretKey = new fr.SecretKeySpec(key, 'AES');
      var cipher = fr.Cipher.getInstance('AES/ECB/PKCS5Padding');
      cipher.init(fr.Cipher.ENCRYPT_MODE, secretKey);
      var finalBytes = cipher.doFinal(new fr.String(str).getBytes('UTF-8'));
      return fr.Base64.encode(finalBytes);
    } catch (e) {
      logger.error('{}: failed to encrypt: {}', scriptName, e);
      throw e;
    }
  }

  function hasAmScope(scope) {
    if (!scope) return false;
    for (var i = 0; i < scope.length; i++) {
      if (scope[i].indexOf('fr:am:') > -1) return true;
    }
    return false;
  }

  try {
    var uri = 'http://am.fr-platform:80/am/json/authenticate?authIndexType=service&authIndexValue=FRServiceAccountInternal';
    var requestParams = requestProperties.get('requestParams');

    var scope = requestParams.get('scope');
    if (!hasAmScope(scope)) {
      logger.message('AM scope not requested');
      return null;
    }

    var jwts = requestParams.get('assertion');
    if (!jwts || jwts.isEmpty()) {
      logger.message('No jwt assertion');
      return null;
    }

    var jwt = jwts[0];
    var uuid = identity.getAttribute('_id').iterator().next();

    var request = new fr.Request();
    request.getHeaders().add('authorization', 'svcacct ' + uuid + ' ' + jwt);
    request.getHeaders().add('content-type', 'application/json');
    request
      .setUri(uri)
      .setMethod('POST')
      .setEntity('{}');

    var response = httpClient.send(request).getOrThrow();
    if (response.getStatus() === org.forgerock.http.protocol.Status.OK) {
      var result = JSON.parse(response.getEntity().getString());
      var encryptedTokenId = encrypt(result.tokenId);
      accessToken.setField('sessionToken', encryptedTokenId);
    } else {
      logger.message('Failed to get session from service account tree (status: ' + response.getStatus() + ')');
    }
  } catch (e) {
    throw ('Failed to modify service account token: ' + e);
  }
}());
"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Service-Account-Token-Modification.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "3369037a-7a49-4aed-a1dc-7aab7608812b": {
      "_id": "3369037a-7a49-4aed-a1dc-7aab7608812b",
      "context": "OAUTH2_ACCESS_TOKEN_MODIFICATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Service Account - Token Modification",
      "script": "file://Service-Account-Token-Modification.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Service-Account-Verify-JWT.script.js 1`] = `
"var fr = JavaImporter(
  org.forgerock.util.Options,
  org.forgerock.json.jose.jwk.JWKSet,
  org.forgerock.json.jose.jws.SigningManager,
  org.forgerock.json.jose.builders.JwtBuilderFactory,
  org.forgerock.json.jose.jws.SignedJwt
);

var sm = new fr.SigningManager();

function getJWKs(svcAcctId) {
  var svcAcct = idRepository.getIdentity(svcAcctId);
  if (svcAcct == null) {
    logger.message('No service account found for {}', svcAcctId);
    return null;
  }
  var jwksAttrs = svcAcct.getAttributeValues('fr-attr-jwks');
  if (!jwksAttrs || jwksAttrs.length === 0) {
    logger.message('No jwks attributes in issuer');
    return null;
  }
  var jwkSet = jwksAttrs[0];
  if (!jwkSet) {
    logger.message('No jwk set in jwks attribute in issuer');
    return null;
  }
  return fr.JWKSet.parse(jwkSet).getJWKsAsList();
}

outcome = (function () {
  var authz = requestHeaders.get('authorization');
  if (authz === null || authz.length === 0 || authz[0].indexOf('svcacct') !== 0) {
    logger.message('No authorization header');
    return 'False';
  }

  authz = authz[0].split(' ');
  if (authz.length !== 3) {
    logger.message('Bad authorization header length {}', authz.length);
    return 'False';
  }
  var svcAcctId = authz[1];
  var jwt = authz[2];
  var signedJwt = new fr.JwtBuilderFactory().reconstruct(jwt, fr.SignedJwt);

  var jwks = getJWKs(svcAcctId);
  for (var i = 0; i < jwks.size(); i++) {
    var verifier = sm.newVerificationHandler(jwks.get(i))
    if (signedJwt.verify(verifier)) {
      nodeState.putShared("username", svcAcctId);
      return 'True';
    }
  }

  logger.message('Could not verify jwt');
  return 'False';
})();"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Service-Account-Verify-JWT.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "766ed2a6-29dd-4bd7-a60d-9eabbd63545c": {
      "_id": "766ed2a6-29dd-4bd7-a60d-9eabbd63545c",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Service Account - Verify JWT",
      "script": "file://Service-Account-Verify-JWT.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Set-OATH-Theme.script.js 1`] = `
"/* Set OATH Theme
 * 
 * Detect and preserve currently active theme before setting the new theme.
 * 
 * This script does not need to be parametrized. It will work properly as is.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 *
 * Author: volker.scheuber@forgerock.com
 */
(function () {
      outcome = "true";
      
      var theme = "Expanse_OATH";

    // do not change, must be a random identifier
    var anchor = generateNumericToken('xxx');
  
      var script = "";
    script += "document.getElementById(\\"theme-id-"+anchor+"\\").value = localStorage.getItem('theme-id');";
    script += "console.log('theme-id='+document.getElementById(\\"theme-id-"+anchor+"\\").value);";
      script += "document.getElementById(\\"loginButton_0\\").click();";

    var fr = JavaImporter(
        org.forgerock.openam.auth.node.api.Action,
          org.forgerock.openam.authentication.callbacks.PollingWaitCallback,
        com.sun.identity.authentication.callbacks.HiddenValueCallback,
        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback
    )
    // discover active theme from UI
    if (callbacks.isEmpty()) {
        action = fr.Action.send(
            new fr.HiddenValueCallback("theme-id-"+anchor, "false"),
            new fr.ScriptTextOutputCallback(script)
        ).build();
    }
      // get active theme from callback and set new theme
      else if (callbacks.size() === 2) {
        // did we get the id of the currently active theme?
        if (callbacks.get(0).getValue() !== "theme-id-"+anchor) {
              sharedState.put("themeId", callbacks.get(0).getValue());
        }
        // set new theme
        var stage = "themeId="+theme;
        action = fr.Action.send(
              new fr.PollingWaitCallback("0", "Please wait ...")
        ).withStage(stage).build();
    }
      else {
        // continue
        action = fr.Action.goTo(outcome).build();
    }

     /*
      * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.
      * 
      * Example:
      * 'xxxxx' produces '28535'
      * 'xxx-xxx' produces '432-521'
      */
    function generateNumericToken(format) {
        return format.replace(/[x]/g, function(c) {
            var r = Math.random()*10|0;
            var v = r;
            return v.toString(10);
        });
    }
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Set-OATH-Theme.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "f2107949-22f8-46c4-865d-ae1d1110a9cb": {
      "_id": "f2107949-22f8-46c4-865d-ae1d1110a9cb",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Detect and preserve currently active theme before setting the new theme.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Set OATH Theme",
      "script": "file://Set-OATH-Theme.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Set-Theme.script.js 1`] = `
"/* Set Theme
 * 
 * Detect and preserve currently active theme before setting the new theme.
 * 
 * This script does not need to be parametrized. It will work properly as is.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 *
 * Author: volker.scheuber@forgerock.com
 */
(function () {
      outcome = "true";
      
      var theme = "Expanse_MFA";

    // do not change, must be a random identifier
    var anchor = generateNumericToken('xxx');
  
      var script = "";
    script += "document.getElementById(\\"theme-id-"+anchor+"\\").value = localStorage.getItem('theme-id');";
    script += "console.log('theme-id='+document.getElementById(\\"theme-id-"+anchor+"\\").value);";
      script += "document.getElementById(\\"loginButton_0\\").click();";

    var fr = JavaImporter(
        org.forgerock.openam.auth.node.api.Action,
          org.forgerock.openam.authentication.callbacks.PollingWaitCallback,
        com.sun.identity.authentication.callbacks.HiddenValueCallback,
        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback
    )
    // discover active theme from UI
    if (callbacks.isEmpty()) {
        action = fr.Action.send(
            new fr.HiddenValueCallback("theme-id-"+anchor, "false"),
            new fr.ScriptTextOutputCallback(script)
        ).build();
    }
      // get active theme from callback and set new theme
      else if (callbacks.size() === 2) {
        // did we get the id of the currently active theme?
        if (callbacks.get(0).getValue() !== "theme-id-"+anchor) {
              sharedState.put("themeId", callbacks.get(0).getValue());
        }
        // set new theme
        var stage = "themeId="+theme;
        action = fr.Action.send(
              new fr.PollingWaitCallback("100", "Please wait ...")
        ).withStage(stage).build();
    }
      else {
        // continue
        action = fr.Action.goTo(outcome).build();
    }

     /*
      * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.
      * 
      * Example:
      * 'xxxxx' produces '28535'
      * 'xxx-xxx' produces '432-521'
      */
    function generateNumericToken(format) {
        return format.replace(/[x]/g, function(c) {
            var r = Math.random()*10|0;
            var v = r;
            return v.toString(10);
        });
    }
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Set-Theme.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "76421cb0-0550-43e7-89f8-51ad1d95d306": {
      "_id": "76421cb0-0550-43e7-89f8-51ad1d95d306",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Detect and preserve currently active theme before setting the new theme.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Set Theme",
      "script": "file://Set-Theme.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Setup-MFA-Choice.script.js 1`] = `
"/*
 * Adapt the configuration values below
 */

// do not change, must be a random identifier
var anchor = generateNumericToken('xxx');

// specify the horizontal alignment of the message: left, center, right
var halign = "center";

// specify the style to apply to the button in the message to make it look like a link
var linkButtonStyle = "border: 0; color: #109CF1; text-decoration: none; background-color: transparent;";

// specify the link button HTML element. only modify the text between the <button> and </button> tags.
var linkButton = "<button id=\\"skip-link-".concat(anchor).concat("\\" type=\\"submit\\" style=\\"").concat(linkButtonStyle).concat("\\">skip for now.</button>");

// specify the message you want to display and place the linkButton anywhere
var message = "Please select your prefered factor or".concat(linkButton);

// specify the choices you want to offer the user.
var choices = ["SMS","Fido","Push"];

// specify the default choice. this setting must be a valid 0-based index of the choices array above.
var defaultChoice = 0;

/*
 * All the configuration values are above this comment.
 *
 * DO NOT MAKE ANY CHANGES BELOW!
 */

// find the TextOutputCallback with the message_anchor
// and replace the message_anchor with the message
var displayMessageScript = "".concat(
  "Array.prototype.slice.call(\\n").concat(
  "  document.getElementsByClassName('callback-component')\\n").concat(
  ").forEach(\\n").concat(
  "  function (e) {\\n").concat(
  "    var message = e.firstElementChild;\\n").concat(
  "    if (message.firstChild && message.firstChild.nodeName == '#text' && message.firstChild.nodeValue.trim() == 'message-").concat(anchor).concat("') {\\n").concat(
  "      message.align = \\"").concat(halign).concat("\\";\\n").concat(
  "      message.innerHTML = '").concat(message).concat("';\\n").concat(
  "    }\\n").concat(
  "  }\\n").concat(
  ")")

// hijack the link button in the message and:
// - find the HiddenValueCallback and set its value to "Skip"
// - then simulate a login button click
var skipOptionScript = "".concat(
  "document.getElementById(\\"skip-link-").concat(anchor).concat("\\").onclick = function(){\\n").concat(
  "  document.getElementById(\\"skip-input-").concat(anchor).concat("\\").value = \\"Skip\\";\\n").concat(
  "  document.getElementById(\\"loginButton_0\\").click();\\n").concat(
  "  return false;\\n").concat(
  "}")

var fr = JavaImporter(
    org.forgerock.openam.auth.node.api.Action,
    javax.security.auth.callback.ConfirmationCallback,
    javax.security.auth.callback.TextOutputCallback,
    com.sun.identity.authentication.callbacks.HiddenValueCallback,
    com.sun.identity.authentication.callbacks.ScriptTextOutputCallback
)

if (callbacks.isEmpty()) {
    action = fr.Action.send(
        new fr.TextOutputCallback(
            fr.TextOutputCallback.INFORMATION,
            "message-".concat(anchor)
        ),
        new fr.ConfirmationCallback(
            fr.ConfirmationCallback.INFORMATION,
            choices,
            defaultChoice
        ),
        new fr.HiddenValueCallback("skip-input-".concat(anchor), "false"),
        new fr.ScriptTextOutputCallback(displayMessageScript),
        new fr.ScriptTextOutputCallback(skipOptionScript)
    ).build()
}
else {
  // did the user skip?
  if (callbacks.get(2).getValue() == "Skip") {
    action = fr.Action.goTo("Skip").build();
  }
  // user didn't skip, pick the right outcome
  else {
    action = fr.Action.goTo(choices[callbacks.get(1).getSelectedIndex()]).build();
  }
}

 /*
  * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.
  * 
  * Example:
  * 'xxxxx' produces '28535'
  * 'xxx-xxx' produces '432-521'
  */
function generateNumericToken(format) {
    return format.replace(/[x]/g, function(c) {
        var r = Math.random()*10|0;
        var v = r;
        return v.toString(10);
    });
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Setup-MFA-Choice.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "f26cc0de-ee31-4114-8a32-27799bb49357": {
      "_id": "f26cc0de-ee31-4114-8a32-27799bb49357",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Setup MFA Choice",
      "script": "file://Setup-MFA-Choice.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Show-Password-Policy.script.js 1`] = `
"var output = true;
var anchor = "anchor-".concat(generateNumericToken('xxx'));
var halign = "left";
var message = "<ul><li>Must be at least 8 characters long</li>".concat(
    "<li>Must be less than 64 characters long</li>").concat(
    "<li>Must not share characters with email, username, first name, last name</li>").concat(
    "<li>Must have at least 1 lowercase letter(s)</li>").concat(
    "<li>Must have at least 1 capital letter(s)</li>").concat(
    "<li>Must have at least 1 number(s)</li>").concat(
    "<li>Must have at least 1 symbol(s)</li></ul>")
var script = "Array.prototype.slice.call(\\n".concat(
  "document.getElementsByClassName('callback-component')).forEach(\\n").concat(
  "function (e) {\\n").concat(
  "  var message = e.firstElementChild;\\n").concat(
  "  if (message.firstChild && message.firstChild.nodeName == '#text' && message.firstChild.nodeValue.trim() == '").concat(anchor).concat("') {\\n").concat(
  "    message.className = \\"text-left\\";\\n").concat(
  "    message.align = \\"").concat(halign).concat("\\";\\n").concat(
  "    message.innerHTML = '").concat(message).concat("';\\n").concat(
  "  }\\n").concat(
  "})")
var fr = JavaImporter(
    org.forgerock.openam.auth.node.api.Action,
    javax.security.auth.callback.TextOutputCallback,
    com.sun.identity.authentication.callbacks.ScriptTextOutputCallback
)
if (message.length && callbacks.isEmpty()) {
    action = fr.Action.send(
        new fr.TextOutputCallback(
            fr.TextOutputCallback.INFORMATION,
            anchor
        ),
        new fr.ScriptTextOutputCallback(script)
    ).build()
}
else {
  action = fr.Action.goTo("true").build();
}

 /*
  * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.
  * 
  * Example:
  * 'xxxxx' produces '28535'
  * 'xxx-xxx' produces '432-521'
  */
function generateNumericToken(format) {
    return format.replace(/[x]/g, function(c) {
        var r = Math.random()*10|0;
        var v = r;
        return v.toString(10);
    });
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Show-Password-Policy.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "021e434f-89b6-45fb-9d67-5147bc1650c3": {
      "_id": "021e434f-89b6-45fb-9d67-5147bc1650c3",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Show Password Policy",
      "script": "file://Show-Password-Policy.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Social-Identity-Provider-Profile-Transformation-Script.script.groovy 1`] = `
"/*
 * Copyright 2020 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

/* Default Social Identity Provider Profile Transformation script to use as a template for new scripts */"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Social-Identity-Provider-Profile-Transformation-Script.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "1d475815-72cb-42eb-aafd-4026989d28a7": {
      "_id": "1d475815-72cb-42eb-aafd-4026989d28a7",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Default global script for Social Identity Provider Profile Transformation",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Social Identity Provider Profile Transformation Script",
      "script": "file://Social-Identity-Provider-Profile-Transformation-Script.script.groovy",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./TimeStamp_Login.script.js 1`] = `
"/*
  - Data made available by nodes that have already executed are available in the sharedState variable.
  - The script should set outcome to either "true" or "false".
 */


//var timestamps = sharedState.get("objectAttributes").get("frIndexedMultivalued1");


var lastLogin = new Date();
/*
var datetime = ""+ currentdate.getDate() + "/"
                + (currentdate.getMonth()+1)  + "/" 
                + currentdate.getFullYear() + " @ "  
                + currentdate.getHours() + ":"  
                + currentdate.getMinutes() + ":" 
                + currentdate.getSeconds();
*/

var objectAttributes = sharedState.get("objectAttributes");


sharedState.put("last Login",lastLogin.toString());





objectAttributes.put("frUnindexedString1",lastLogin.toString());


sharedState.put("objectAttributes",objectAttributes);


outcome = "true";"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./TimeStamp_Login.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "b3824c66-2dff-4613-9e54-4a7577fdb765": {
      "_id": "b3824c66-2dff-4613-9e54-4a7577fdb765",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Places a timestamp in the frIndexedMultivalued1 attribute",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "TimeStamp_Login",
      "script": "file://TimeStamp_Login.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Twilio-IVR:-Goodbye-Message.script.js 1`] = `
"/* Twilio IVR: Goodbye Message
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 * 
 * Depending on the amount of data collected through callbacks and how many of the callParams
 * you activate below, you will need to change your authentication session from JWT to CTS or
 * Memory.
 */
logger.warning("Twilio IVR: Goodbye Message: start");
outcome = "true";

/* Begin Configuration
 */

// Build out the full message
var message = "Thank you for calling ForgeRock Identity Cloud. Goodbye!";

/* End Configuration
 */

var fr = JavaImporter(
      org.forgerock.openam.auth.node.api,
      javax.security.auth.callback.TextOutputCallback
);
  
with (fr) {
      if (callbacks.isEmpty()) {
        var output = new TextOutputCallback(TextOutputCallback.INFORMATION, message);
        action = Action.send(output).build();
      } 
      else {
        logger.warning("Twilio IVR: Goodbye Message: finish [outcome=".concat(outcome).concat("]"));
        action = Action.goTo(outcome).build();
      }
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Twilio-IVR:-Goodbye-Message.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "849ef5f3-7481-4607-a668-f0b5bf47db4c": {
      "_id": "849ef5f3-7481-4607-a668-f0b5bf47db4c",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Goodbye Message",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Twilio IVR: Goodbye Message",
      "script": "file://Twilio-IVR:-Goodbye-Message.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Twilio-IVR:-Greet-Verified-Caller.script.js 1`] = `
"/* Twilio IVR: Greet Verified Caller
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 * 
 * Depending on the amount of data collected through callbacks and how many of the callParams
 * you activate below, you will need to change your authentication session from JWT to CTS or
 * Memory.
 */
outcome = "true";

/* Begin Configuration
 */

// For ID Cloud use "_id", for classic deployments use "username"
var userid = sharedState.get("_id")

// Configure how you would like to address the verified caller. The default is the full name.
var name = [idRepository.getAttribute(userid, "givenName").iterator().next(), idRepository.getAttribute(userid, "sn").iterator().next()].join(" ");

// Build out the full message
var message = ["Hello", name, "! How can I help you today?"].join(" ");

/* End Configuration
 */

var fr = JavaImporter(
      org.forgerock.openam.auth.node.api,
      javax.security.auth.callback.TextOutputCallback
);
  
with (fr) {
      if (callbacks.isEmpty()) {
        var output = new TextOutputCallback(TextOutputCallback.INFORMATION, message);
        action = Action.send(output).build();
      } 
      else {
        action = Action.goTo(outcome).build();
      }
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Twilio-IVR:-Greet-Verified-Caller.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "be6f1f2c-30ee-41fb-9e1e-8da72267fad3": {
      "_id": "be6f1f2c-30ee-41fb-9e1e-8da72267fad3",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Greet verified caller",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Twilio IVR: Greet Verified Caller",
      "script": "file://Twilio-IVR:-Greet-Verified-Caller.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Twilio-IVR:-Parse-Call-Parameters.script.js 1`] = `
"/* Twilio IVR Integration
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 * - false
 * 
 * Depending on the amount of data collected through callbacks and how many of the callParams
 * you activate below, you will need to change your authentication session from JWT to CTS or
 * Memory.
 */

logger.warning("Twilio IVR: Parse Call Parameters: start");
outcome = "false";

/* Begin Twilio IVR Configuration Parameters
 *
 * These are used to protect this journey so it is only being executed by your Twilio account.
 */
var TWILIO_ACCOUNT_SID = "AC750415e3163a2e57b7aeea7eed82d944";
var TWILIO_PHONE_NUMBER = "+13176443107";

// keep the params to a minimum to minimize authentication session size
var callParams = {
  //"CallSid" : decodeURIComponent(requestParameters.get("CallSid").get(0)),
  "AccountSid" : decodeURIComponent(requestParameters.get("AccountSid").get(0)),
  "From" : decodeURIComponent(requestParameters.get("From").get(0)),
  "To" : decodeURIComponent(requestParameters.get("To").get(0)),
  //"CallStatus" : decodeURIComponent(requestParameters.get("CallStatus").get(0)),
  //"ApiVersion" : decodeURIComponent(requestParameters.get("ApiVersion").get(0)),
  //"Direction" : decodeURIComponent(requestParameters.get("Direction").get(0)),
  //"ForwardedFrom" : decodeURIComponent(requestParameters.get("ForwardedFrom").get(0)),
  //"CallerName" : decodeURIComponent(requestParameters.get("CallerNameCallerName").get(0)),
  //"ParentCallSid" : decodeURIComponent(requestParameters.get("ParentCallSid").get(0)),
  //"FromCity" : decodeURIComponent(requestParameters.get("FromCity").get(0)),
  //"FromState" : decodeURIComponent(requestParameters.get("FromState").get(0)),
  //"FromZip" : decodeURIComponent(requestParameters.get("FromZip").get(0)),
  //"FromCountry" : decodeURIComponent(requestParameters.get("FromCountry").get(0)),
  //"ToCity" : decodeURIComponent(requestParameters.get("ToCity").get(0)),
  //"ToState" : decodeURIComponent(requestParameters.get("ToState").get(0)),
  //"ToZip" : decodeURIComponent(requestParameters.get("ToZip").get(0)),
  //"ToCountry" : decodeURIComponent(requestParameters.get("ToCountry").get(0)),
};

/* End Twilio IVR Configuration Parameters 
 */

if (callParams.AccountSid == TWILIO_ACCOUNT_SID &&
    callParams.To == TWILIO_PHONE_NUMBER) 
{
      outcome = "true";
    sharedState.put("TwilioIVRCallParams", callParams);
    setSharedObjectAttribute("telephoneNumber", callParams.From);
}

logger.warning("Twilio IVR: Parse Call Parameters: finish [outcome=".concat(outcome).concat("]"));

/*
 * Store attributes in shared state for use with the Create/Patch Object nodes.
 */
function setSharedObjectAttribute(name, value) {
       var storage = sharedState.get("objectAttributes");
    if (storage && value) {
          if (storage.put) {
              storage.put(name, value);
        }
          else {
              storage[name] = value;
        }
    }
    else if (value) {
        sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));
    }
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Twilio-IVR:-Parse-Call-Parameters.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "7dce8f07-d9fe-4752-94b9-ff99dfd0433b": {
      "_id": "7dce8f07-d9fe-4752-94b9-ff99dfd0433b",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Parse parameters of the incoming call.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Twilio IVR: Parse Call Parameters",
      "script": "file://Twilio-IVR:-Parse-Call-Parameters.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Twilio-IVR:-Unverified-Caller-Message.script.js 1`] = `
"/* Twilio IVR: Unverified Caller Message
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 * 
 * Depending on the amount of data collected through callbacks and how many of the callParams
 * you activate below, you will need to change your authentication session from JWT to CTS or
 * Memory.
 */
outcome = "true";

/* Begin Configuration
 */

// Build out the full message
var message = "That doesn't match our records. Let us try this another way.";

/* End Configuration
 */

var fr = JavaImporter(
      org.forgerock.openam.auth.node.api,
      javax.security.auth.callback.TextOutputCallback
);
  
with (fr) {
      if (callbacks.isEmpty()) {
        var output = new TextOutputCallback(TextOutputCallback.INFORMATION, message);
        action = Action.send(output).build();
      } 
      else {
        action = Action.goTo(outcome).build();
      }
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Twilio-IVR:-Unverified-Caller-Message.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "4f1273be-9c52-4879-bbe9-9a47068aeed9": {
      "_id": "4f1273be-9c52-4879-bbe9-9a47068aeed9",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Unverified caller message",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Twilio IVR: Unverified Caller Message",
      "script": "file://Twilio-IVR:-Unverified-Caller-Message.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Twilio-IVR:-Verify-Known-Caller.script.js 1`] = `
"/* Twilio IVR: Verify Known Caller
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 * - false
 * 
 * Depending on the amount of data collected through callbacks and how many of the callParams
 * you activate below, you will need to change your authentication session from JWT to CTS or
 * Memory.
 */
logger.warning("Twilio IVR: Verify Known Caller: start");
outcome = "false";

/* Begin Configuration
 */

// For ID Cloud use "_id", for classic deployments use "username"
var userid = sharedState.get("_id")

// Retrieve the known caller's first name
var firstName = idRepository.getAttribute(userid, "givenName").iterator().next().replaceAll("[^a-zA-Z ]", "").toLowerCase();

// Build out the full message
var message = "I see we have a profile associated with your phone number!";

// Build out the verification prompt
var prompt = "To verify I have the right account, please say your first name.";

/* End Configuration
 */

var fr = JavaImporter(
      org.forgerock.openam.auth.node.api,
      javax.security.auth.callback.TextOutputCallback,
      javax.security.auth.callback.TextInputCallback
);
  
with (fr) {
      if (callbacks.isEmpty()) {
        var output = new TextOutputCallback(TextOutputCallback.INFORMATION, message);
        var input = new TextInputCallback(prompt);
        action = Action.send(output, input).build();
      } 
      else {
          var answer = callbacks.get(1).getText().replaceAll("[^a-zA-Z ]", "").toLowerCase();
        logger.warning("Twilio IVR: Verify Known Caller: callbacks received: answer=".concat(answer).concat(" [firstName=").concat(firstName).concat("]"));
        if (answer == firstName) {
              outcome = "true";
        }
          else if (answer.length == 0) {
              outcome = "no input";
        }
        logger.warning("Twilio IVR: Verify Known Caller: finish [outcome=".concat(outcome).concat("]"));
        action = Action.goTo(outcome).build();
      }
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Twilio-IVR:-Verify-Known-Caller.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "aa2dabff-f5c4-4dc5-b4ac-5909e88a3a8f": {
      "_id": "aa2dabff-f5c4-4dc5-b4ac-5909e88a3a8f",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Verify known caller by first name",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Twilio IVR: Verify Known Caller",
      "script": "file://Twilio-IVR:-Verify-Known-Caller.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Twilio-IVR:-Verify-Security-PIN.script.js 1`] = `
"/* Twilio IVR: Verify Security PIN
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 * - false
 * 
 * Depending on the amount of data collected through callbacks and how many of the callParams
 * you activate below, you will need to change your authentication session from JWT to CTS or
 * Memory.
 */
logger.warning("Twilio IVR: Verify Security PIN: start");
outcome = "false";

/* Begin Configuration
 */

// For ID Cloud use "_id", for classic deployments use "username"
var userid = sharedState.get("_id")

// Retrieve the identified caller's PIN (in IDM: frUnindexedInteger5, in AM: fr-attr-int5)
var securityPIN = idRepository.getAttribute(userid, "fr-attr-int5").iterator().next();

// Build out the verification prompt
var prompt = "To verify I have the right account, please enter your 4-digit security PIN.";

/* End Configuration
 */

var fr = JavaImporter(
      org.forgerock.openam.auth.node.api,
      javax.security.auth.callback.TextInputCallback
);
  
with (fr) {
      if (callbacks.isEmpty()) {
        var input = new TextInputCallback(prompt);
        action = Action.send(input).build();
      } 
      else {
          var answer = new String(callbacks.get(0).getText()).replace(/[^0-9]/g, "");
        logger.warning("Twilio IVR: Verify Security PIN: callbacks received");
        if (answer == securityPIN) {
              outcome = "true";
        }
        logger.warning("Twilio IVR: Verify Security PIN: finish [outcome=".concat(outcome).concat("]"));
        action = Action.goTo(outcome).build();
      }
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Twilio-IVR:-Verify-Security-PIN.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "c9fa3899-c3ce-4833-af83-64d709202600": {
      "_id": "c9fa3899-c3ce-4833-af83-64d709202600",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Verify security PIN",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Twilio IVR: Verify Security PIN",
      "script": "file://Twilio-IVR:-Verify-Security-PIN.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Twilio-IVR:-Verify-Unknown-Caller.script.js 1`] = `
"/* Twilio IVR: Verify Unknown Caller
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 * 
 * Depending on the amount of data collected through callbacks and how many of the callParams
 * you activate below, you will need to change your authentication session from JWT to CTS or
 * Memory.
 */
logger.warning("Twilio IVR: Verify Unknown Caller: start");
outcome = "true";

/* Begin Configuration
 */

// Build out the verification prompt
var prompt = "To lookup your account, please enter or say your account number.";

/* End Configuration
 */

var fr = JavaImporter(
      org.forgerock.openam.auth.node.api,
      javax.security.auth.callback.TextInputCallback
);
  
with (fr) {
      if (callbacks.isEmpty()) {
        var input = new TextInputCallback(prompt);
        action = Action.send(input).build();
      } 
      else {
          var answer = new String(callbacks.get(0).getText()).replace(/[^0-9]/g, "");
        logger.warning("Twilio IVR: Verify Unknown Caller: callbacks received: answer=".concat(answer));
          setSharedObjectAttribute("frIndexedInteger5", answer);
        logger.warning("Twilio IVR: Verify Unknown Caller: finish [outcome=".concat(outcome).concat("]"));
        action = Action.goTo(outcome).build();
      }
}

/*
 * Store attributes in shared state for use with the Create/Patch Object nodes.
 */
function setSharedObjectAttribute(name, value) {
       var storage = sharedState.get("objectAttributes");
    if (storage && value) {
          if (storage.put) {
              storage.put(name, value);
        }
          else {
              storage[name] = value;
        }
    }
    else if (value) {
        sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));
    }
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Twilio-IVR:-Verify-Unknown-Caller.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "1c0c73e8-2be1-41ce-b042-3c39694346b5": {
      "_id": "1c0c73e8-2be1-41ce-b042-3c39694346b5",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Verify unknown caller by account number",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Twilio IVR: Verify Unknown Caller",
      "script": "file://Twilio-IVR:-Verify-Unknown-Caller.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Twilio-IVR:-Welcome-Message.script.js 1`] = `
"/* Twilio IVR: Welcome Message
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 * 
 * Depending on the amount of data collected through callbacks and how many of the callParams
 * you activate below, you will need to change your authentication session from JWT to CTS or
 * Memory.
 */
logger.warning("Twilio IVR: Welcome Message: start");
outcome = "true";

/* Begin Configuration
 */

// Build out the full message
var message = "Thank you for calling ForgeRock Identity Cloud!";

/* End Configuration
 */

var fr = JavaImporter(
      org.forgerock.openam.auth.node.api,
      javax.security.auth.callback.TextOutputCallback
);
  
with (fr) {
      if (callbacks.isEmpty()) {
        var output = new TextOutputCallback(TextOutputCallback.INFORMATION, message);
        action = Action.send(output).build();
      } 
      else {
        logger.warning("Twilio IVR: Welcome Message: finish [outcome=".concat(outcome).concat("]"));
        action = Action.goTo(outcome).build();
      }
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Twilio-IVR:-Welcome-Message.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "53c50dbd-5331-4739-bea1-4c5e9bf553f2": {
      "_id": "53c50dbd-5331-4739-bea1-4c5e9bf553f2",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Welcome message",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Twilio IVR: Welcome Message",
      "script": "file://Twilio-IVR:-Welcome-Message.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Twilio-SMS-OTP-Sender.script.js 1`] = `
"/* Twilio SMS OTP Sender
 *
 * Author: volker.scheuber@forgerock.com
 * 
 * This script will send an SMS containing the OTP to the phone number in the user's profile.
 * 
 * This script needs to be parametrized. It will not work properly as is. 
 * It requires the Identify Existing User node and HOTP Generator node before it is being called.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - sent
 * - failed
 */
logger.warning("Twilio SMS OTP Sender: start");

if (sharedState.get("_id") && idRepository.getAttribute(sharedState.get("_id"), "telephoneNumber").iterator().hasNext()) {
    var Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(input){var output="";var chr1,chr2,chr3,enc1,enc2,enc3,enc4;var i=0;input=Base64._utf8_encode(input);while(i<input.length){chr1=input.charCodeAt(i++);chr2=input.charCodeAt(i++);chr3=input.charCodeAt(i++);enc1=chr1>>2;enc2=(chr1&3)<<4|chr2>>4;enc3=(chr2&15)<<2|chr3>>6;enc4=chr3&63;if(isNaN(chr2)){enc3=enc4=64}else if(isNaN(chr3)){enc4=64}output=output+this._keyStr.charAt(enc1)+this._keyStr.charAt(enc2)+this._keyStr.charAt(enc3)+this._keyStr.charAt(enc4)}return output},decode:function(input){var output="";var chr1,chr2,chr3;var enc1,enc2,enc3,enc4;var i=0;input=input.replace(/[^A-Za-z0-9\\+\\/\\=]/g,"");while(i<input.length){enc1=this._keyStr.indexOf(input.charAt(i++));enc2=this._keyStr.indexOf(input.charAt(i++));enc3=this._keyStr.indexOf(input.charAt(i++));enc4=this._keyStr.indexOf(input.charAt(i++));chr1=enc1<<2|enc2>>4;chr2=(enc2&15)<<4|enc3>>2;chr3=(enc3&3)<<6|enc4;output=output+String.fromCharCode(chr1);if(enc3!=64){output=output+String.fromCharCode(chr2)}if(enc4!=64){output=output+String.fromCharCode(chr3)}}output=Base64._utf8_decode(output);return output},_utf8_encode:function(string){string=string.replace(/\\r\\n/g,"\\n");var utftext="";for(var n=0;n<string.length;n++){var c=string.charCodeAt(n);if(c<128){utftext+=String.fromCharCode(c)}else if(c>127&&c<2048){utftext+=String.fromCharCode(c>>6|192);utftext+=String.fromCharCode(c&63|128)}else{utftext+=String.fromCharCode(c>>12|224);utftext+=String.fromCharCode(c>>6&63|128);utftext+=String.fromCharCode(c&63|128)}}return utftext},_utf8_decode:function(utftext){var string="";var i=0;var c=c1=c2=0;while(i<utftext.length){c=utftext.charCodeAt(i);if(c<128){string+=String.fromCharCode(c);i++}else if(c>191&&c<224){c2=utftext.charCodeAt(i+1);string+=String.fromCharCode((c&31)<<6|c2&63);i+=2}else{c2=utftext.charCodeAt(i+1);c3=utftext.charCodeAt(i+2);string+=String.fromCharCode((c&15)<<12|(c2&63)<<6|c3&63);i+=3}}return string}};

       /* BEGIN SCRIPT CONFIGURATION
     *
     * REPLACE WITH YOUR OWN AZURE AD SETTINGS
     */
    var TWILIO_API_SID = "AC750415e3163a2e57b7aeea7eed82d944";
    var TWILIO_API_TOKEN = "d36a719c94b4be08592d69ec4f80a5bb";
    var TWILIO_API_FROM = "+13176443107";
    /*
     * END SCRIPT CONFIGURATION
     */
  
    // Twilio SMS Message API Configuration
    var TWILIO_API_URI = "https://api.twilio.com/2010-04-01/Accounts/".concat(TWILIO_API_SID).concat("/Messages.json");    
    var TWILIO_API_TO = idRepository.getAttribute(sharedState.get("_id"), "telephoneNumber").iterator().next();
    var TWILIO_API_BODY = "OTP for account ".concat(sharedState.get("username")).concat(": ").concat(sharedState.get("oneTimePassword"));
    //logger.warning("Twilio SMS OTP Sender: To: ".concat(TWILIO_API_TO));
    //logger.warning("Twilio SMS OTP Sender: Message: ".concat(TWILIO_API_BODY));

    var AUTHZ = "Basic ".concat(Base64.encode(TWILIO_API_SID.concat(':').concat(TWILIO_API_TOKEN)));
    //logger.warning("Twilio SMS OTP Sender: AUTHZ - ".concat(AUTHZ));

    var request = new org.forgerock.http.protocol.Request();
    request.setMethod('POST');
    request.setUri(TWILIO_API_URI);
    request.getHeaders().add("Content-Type", "application/x-www-form-urlencoded");
    request.getHeaders().add("Authorization", AUTHZ);
    var params = request.getForm();
    params.add("From", TWILIO_API_FROM);
    params.add("Body", TWILIO_API_BODY);
    params.add("To", TWILIO_API_TO);
    request.getEntity().setString(params.toString());

    var response = httpClient.send(request).get();
    var result = JSON.parse(response.getEntity().getString());
    //logger.warning("Twilio SMS OTP Sender: JSON result: " + JSON.stringify(result));

    if (result["error_code"]) {
        outcome = "failed";
        logger.error("Twilio SMS OTP Sender: error_code = ".concat(result["error_code"]));
        logger.error("Twilio SMS OTP Sender: error_message = ".concat(result["error_message"]));
        logger.error("Twilio SMS OTP Sender: outcome = failed");
    } else if (result["code"]) {
        outcome = "failed";
        logger.error("Twilio SMS OTP Sender: code = ".concat(result["code"]));
        logger.error("Twilio SMS OTP Sender: message = ".concat(result["message"]));
    } else {
        outcome = "sent";
        logger.warning("Twilio SMS OTP Sender: outcome = sent");
    }
} else {
      outcome = "failed";
      logger.error("Twilio SMS OTP Sender: No user or phone number found! Use 'Identify Existing User node before this script to populate the user's _id in shared state!'");
      logger.error("Twilio SMS OTP Sender: outcome = failed");
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Twilio-SMS-OTP-Sender.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "91554b10-79a5-4aa8-aca1-59481a734c19": {
      "_id": "91554b10-79a5-4aa8-aca1-59481a734c19",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Twilio SMS OTP Sender",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Twilio SMS OTP Sender",
      "script": "file://Twilio-SMS-OTP-Sender.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Twilio-Voice-OTP-Sender.script.js 1`] = `
"/* Twilio Voice OTP Sender
 *
 * Author: volker.scheuber@forgerock.com
 * 
 * This script will deliver the OTP via voice to the phone number in the user's profile.
 * 
 * This script needs to be parametrized. It will not work properly as is. 
 * It requires the Identify Existing User node and HOTP Generator node before it is being called.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - sent
 * - failed
 */
logger.warning("Twilio Voice OTP Sender: start");

if (sharedState.get("_id") && idRepository.getAttribute(sharedState.get("_id"), "telephoneNumber").iterator().hasNext()) {
    var Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(input){var output="";var chr1,chr2,chr3,enc1,enc2,enc3,enc4;var i=0;input=Base64._utf8_encode(input);while(i<input.length){chr1=input.charCodeAt(i++);chr2=input.charCodeAt(i++);chr3=input.charCodeAt(i++);enc1=chr1>>2;enc2=(chr1&3)<<4|chr2>>4;enc3=(chr2&15)<<2|chr3>>6;enc4=chr3&63;if(isNaN(chr2)){enc3=enc4=64}else if(isNaN(chr3)){enc4=64}output=output+this._keyStr.charAt(enc1)+this._keyStr.charAt(enc2)+this._keyStr.charAt(enc3)+this._keyStr.charAt(enc4)}return output},decode:function(input){var output="";var chr1,chr2,chr3;var enc1,enc2,enc3,enc4;var i=0;input=input.replace(/[^A-Za-z0-9\\+\\/\\=]/g,"");while(i<input.length){enc1=this._keyStr.indexOf(input.charAt(i++));enc2=this._keyStr.indexOf(input.charAt(i++));enc3=this._keyStr.indexOf(input.charAt(i++));enc4=this._keyStr.indexOf(input.charAt(i++));chr1=enc1<<2|enc2>>4;chr2=(enc2&15)<<4|enc3>>2;chr3=(enc3&3)<<6|enc4;output=output+String.fromCharCode(chr1);if(enc3!=64){output=output+String.fromCharCode(chr2)}if(enc4!=64){output=output+String.fromCharCode(chr3)}}output=Base64._utf8_decode(output);return output},_utf8_encode:function(string){string=string.replace(/\\r\\n/g,"\\n");var utftext="";for(var n=0;n<string.length;n++){var c=string.charCodeAt(n);if(c<128){utftext+=String.fromCharCode(c)}else if(c>127&&c<2048){utftext+=String.fromCharCode(c>>6|192);utftext+=String.fromCharCode(c&63|128)}else{utftext+=String.fromCharCode(c>>12|224);utftext+=String.fromCharCode(c>>6&63|128);utftext+=String.fromCharCode(c&63|128)}}return utftext},_utf8_decode:function(utftext){var string="";var i=0;var c=c1=c2=0;while(i<utftext.length){c=utftext.charCodeAt(i);if(c<128){string+=String.fromCharCode(c);i++}else if(c>191&&c<224){c2=utftext.charCodeAt(i+1);string+=String.fromCharCode((c&31)<<6|c2&63);i+=2}else{c2=utftext.charCodeAt(i+1);c3=utftext.charCodeAt(i+2);string+=String.fromCharCode((c&15)<<12|(c2&63)<<6|c3&63);i+=3}}return string}};

    /* BEGIN SCRIPT CONFIGURATION
     *
     * REPLACE WITH YOUR OWN AZURE AD SETTINGS
     */
    var TWILIO_API_SID = "AC750415e3163a2e57b7aeea7eed82d944";
    var TWILIO_API_TOKEN = "d36a719c94b4be08592d69ec4f80a5bb";
    var TWILIO_API_FROM = "+13176443107";
    /*
     * END SCRIPT CONFIGURATION
     */
  
    // Twilio SMS Message API Configuration
    var TWILIO_API_URI = "https://api.twilio.com/2010-04-01/Accounts/".concat(TWILIO_API_SID).concat("/Calls.json");    
    var TWILIO_API_TO = idRepository.getAttribute(sharedState.get("_id"), "telephoneNumber").iterator().next();
      var OTP = sharedState.get("oneTimePassword").split("").join("; ");
    var TWILIO_API_TWIML = "<Response><Pause length='1'/><Say voice='alice'>Your one-time password is ".concat(OTP).concat("</Say><Pause length='1'/><Say>Your one-time password is ").concat(OTP).concat("</Say><Pause length='1'/><Say>Goodbye</Say></Response>");
    //logger.warning("Twilio Voice OTP Sender: To: ".concat(TWILIO_API_TO));
    //logger.warning("Twilio Voice OTP Sender: Twiml: ".concat(TWILIO_API_TWIML));

    var AUTHZ = "Basic ".concat(Base64.encode(TWILIO_API_SID.concat(':').concat(TWILIO_API_TOKEN)));
    //logger.warning("Twilio SMS OTP Sender: AUTHZ - ".concat(AUTHZ));

    var request = new org.forgerock.http.protocol.Request();
    request.setMethod('POST');
    request.setUri(TWILIO_API_URI);
    request.getHeaders().add("Content-Type", "application/x-www-form-urlencoded");
    request.getHeaders().add("Authorization", AUTHZ);
    var params = request.getForm();
    params.add("From", TWILIO_API_FROM);
    params.add("Twiml", TWILIO_API_TWIML);
    params.add("To", TWILIO_API_TO);
    request.getEntity().setString(params.toString());

    var response = httpClient.send(request).get();
    var result = JSON.parse(response.getEntity().getString());
    //logger.warning("Twilio SMS OTP Sender: JSON result: " + JSON.stringify(result));

    if (result["status"]=="queued") {
        outcome = result["status"];
        logger.error("Twilio Voice OTP Sender: status = ".concat(result["status"]));
        logger.error("Twilio Voice OTP Sender: subresource_uris = ".concat(result["subresource_uris"]));
        logger.error("Twilio Voice OTP Sender: outcome = ".concat(outcome));
    } else {
        outcome = "failed";
        logger.error("Twilio Voice OTP Sender: status = ".concat(result["status"]));
        logger.error("Twilio Voice OTP Sender: code = ".concat(result["code"]));
        logger.error("Twilio Voice OTP Sender: more_info = ".concat(result["more_info"]));
        logger.error("Twilio Voice OTP Sender: message = ".concat(result["message"]));
        logger.error("Twilio Voice OTP Sender: outcome = ".concat(outcome));
    }
} else {
      outcome = "failed";
      logger.error("Twilio Voice OTP Sender: No user or phone number found! Use 'Identify Existing User node before this script to populate the user's _id in shared state!'");
    logger.error("Twilio Voice OTP Sender: outcome = ".concat(outcome));
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Twilio-Voice-OTP-Sender.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "e0666b8b-f625-4047-89d8-e7e91151027f": {
      "_id": "e0666b8b-f625-4047-89d8-e7e91151027f",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Twilio Voice OTP Sender",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Twilio Voice OTP Sender",
      "script": "file://Twilio-Voice-OTP-Sender.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Twitter-Profile-Normalization.script.groovy 1`] = `
"/*
 * Copyright 2020 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

import static org.forgerock.json.JsonValue.field
import static org.forgerock.json.JsonValue.json
import static org.forgerock.json.JsonValue.object

return json(object(
        field("id", rawProfile.id_str),
        field("displayName", rawProfile.name),
        field("photoUrl", rawProfile.profile_image_url),
        field("email", rawProfile.email),
        field("username", rawProfile.screen_name)))"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Twitter-Profile-Normalization.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "8e298710-b55e-4085-a464-88a375a4004b": {
      "_id": "8e298710-b55e-4085-a464-88a375a4004b",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from Twitter",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Twitter Profile Normalization",
      "script": "file://Twitter-Profile-Normalization.script.groovy",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./UOP-Enrich-Session.script.js 1`] = `
"/* UOP Enrich Session
 *
 * Author: volker.scheuber@forgerock.com
 * 
 * Add current class ID to user session.
 * 
 * This script does not need to be parametrized. It will work properly as is. 
 * It requires the Identify Existing User node before it is being called.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 * - false
 */
logger.warning("UOP Enrich Session: start");
outcome = "false";

if (sharedState.get("uopCurrentClassID")) {
    outcome = "true";
    logger.warning("UOP Enrich Session: going to enrich session with class id: ".concat(sharedState.get("uopCurrentClassID")));
  
    var fr = JavaImporter(
      org.forgerock.openam.auth.node.api
    );

    with (fr) {
        logger.warning("UOP Enrich Session: End (outcome=".concat(outcome).concat(")"));
        action = Action.goTo(outcome).putSessionProperty("UOPClassID", sharedState.get("uopCurrentClassID")).build();
    }
  
} else {
    logger.error("UOP Enrich Session: no classes!");
    logger.warning("UOP Enrich Session: End (outcome=".concat(outcome).concat(")"));
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./UOP-Enrich-Session.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "743351b3-001a-4ec8-b3ac-a674ddb8de22": {
      "_id": "743351b3-001a-4ec8-b3ac-a674ddb8de22",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Enrich user session with UOP class ID.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "UOP Enrich Session",
      "script": "file://UOP-Enrich-Session.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./UOP-Get-Course-ID.script.js 1`] = `
"/* UOP Get Course ID
 *
 * Author: volker.scheuber@forgerock.com
 * 
 * Call out to University of Phoenix Course Registration System and get current class.
 * 
 * This script does not need to be parametrized. It will work properly as is. 
 * It requires the Identify Existing User node before it is being called.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - has classes
 * - no classes
 * - error
 */
logger.warning("UOP Get Course ID: start now");

outcome = "error";

if (sharedState.get("_id") && idRepository.getAttribute(sharedState.get("_id"), "mail").iterator().hasNext()) {

       /* BEGIN SCRIPT CONFIGURATION
     *
     * REPLACE WITH YOUR OWN API SETTINGS
     */
      var email = idRepository.getAttribute(sharedState.get("_id"), "mail").iterator().next();
    var UOP_CLASS_API_URI = "https://dy4rpew5va.execute-api.us-east-1.amazonaws.com/forgerock/course?courseId=CES422";
      //var UOP_CLASS_API_URI = "https://dy4rpew5va.execute-api.us-east-1.amazonaws.com/forgerock/course?emailId=".concat(email);
    /*
     * END SCRIPT CONFIGURATION
     */

    var request = new org.forgerock.http.protocol.Request();
    request.setMethod('GET');
    request.setUri(UOP_CLASS_API_URI);

    var response = httpClient.send(request).get();
    var UOPClassID = response.getEntity().getString();
    logger.warning("UOP Get Course ID: API call result: Course ID=".concat(UOPClassID));

    /* Sample API response
    CES421
    */

    if (UOPClassID) {
        outcome = "has classes";

        // preserve result in shared state
        sharedState.put("uopCurrentClassID", UOPClassID);
    } 
    else if (UOPClassID === "") {
        outcome = "no classes";
    }
    else {
        outcome = "error";
    }

} else {
    logger.error("UOP Get Course ID: no classes!");
}

logger.warning("UOP Get Course ID: End (outcome=".concat(outcome).concat(")"));"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./UOP-Get-Course-ID.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "6ad22934-5d12-43a6-96a7-a2fba8d999bf": {
      "_id": "6ad22934-5d12-43a6-96a7-a2fba8d999bf",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Call out to University of Phoenix Course Registration System and get current course.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "UOP Get Course ID",
      "script": "file://UOP-Get-Course-ID.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./VKontakte-Profile-Normalization.script.groovy 1`] = `
"/*
 * Copyright 2020 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

import static org.forgerock.json.JsonValue.field
import static org.forgerock.json.JsonValue.json
import static org.forgerock.json.JsonValue.object

return json(object(
        field("id", rawProfile.id),
        field("displayName", rawProfile.first_name),
        field("givenName", rawProfile.first_name),
        field("familyName", rawProfile.last_name),
        field("photoUrl", rawProfile.photo_50),
        field("email", rawProfile.email),
        field("username", rawProfile.email)))"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./VKontakte-Profile-Normalization.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "403cf226-6051-4368-8b72-9ba14f9a5140": {
      "_id": "403cf226-6051-4368-8b72-9ba14f9a5140",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from VKontakte",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "VKontakte Profile Normalization",
      "script": "file://VKontakte-Profile-Normalization.script.groovy",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./WeChat-Profile-Normalization.script.groovy 1`] = `
"/*
 * Copyright 2020 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

import static org.forgerock.json.JsonValue.field
import static org.forgerock.json.JsonValue.json
import static org.forgerock.json.JsonValue.object

return json(object(
        field("id", rawProfile.openid),
        field("displayName", rawProfile.nickname),
        field("photoUrl", rawProfile.headimgurl),
        field("username", rawProfile.nickname)))"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./WeChat-Profile-Normalization.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "472534ec-a25f-468d-a606-3fb1935190df": {
      "_id": "472534ec-a25f-468d-a606-3fb1935190df",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from WeChat",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "WeChat Profile Normalization",
      "script": "file://WeChat-Profile-Normalization.script.groovy",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./WordPress-Profile-Normalization.script.groovy 1`] = `
"/*
 * Copyright 2020 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

import static org.forgerock.json.JsonValue.field
import static org.forgerock.json.JsonValue.json
import static org.forgerock.json.JsonValue.object

return json(object(
        field("id", rawProfile.username),
        field("displayName", rawProfile.display_name),
        field("photoUrl", rawProfile.avatar_URL),
        field("email", rawProfile.email),
        field("username", rawProfile.username)))"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./WordPress-Profile-Normalization.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "91d197de-5916-4dca-83b5-9a4df26e7159": {
      "_id": "91d197de-5916-4dca-83b5-9a4df26e7159",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from WordPress",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "WordPress Profile Normalization",
      "script": "file://WordPress-Profile-Normalization.script.groovy",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Yahoo-Profile-Normalization.script.groovy 1`] = `
"/*
 * Copyright 2020 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS.
 */

import static org.forgerock.json.JsonValue.field
import static org.forgerock.json.JsonValue.json
import static org.forgerock.json.JsonValue.object

return json(object(
        field("id", rawProfile.sub),
        field("displayName", rawProfile.name),
        field("givenName", rawProfile.given_name),
        field("familyName", rawProfile.family_name),
        field("photoUrl", rawProfile.picture),
        field("email", rawProfile.email),
        field("username", rawProfile.email),
        field("locale", rawProfile.locale)))"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./Yahoo-Profile-Normalization.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "424da748-82cc-4b54-be6f-82bd64d82a74": {
      "_id": "424da748-82cc-4b54-be6f-82bd64d82a74",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from Yahoo",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Yahoo Profile Normalization",
      "script": "file://Yahoo-Profile-Normalization.script.groovy",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./debug.script.js 1`] = `
"/* debug
 *
 * Author: volker.scheuber@forgerock.com
 * 
 * Display sharedState, transientState, and headers.
 * 
 * This script does not need to be parametrized. It will work properly as is.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - true
 */
var anchor = "anchor-".concat(generateNumericToken('xxx'));
var halign = "left";
var message = "<p><b>Shared State</b>:<br/>".concat(
      sharedState.toString()).concat("</p>").concat(
    "<p><b>Transient State</b>:<br/>").concat(
      transientState.toString()).concat("</p>").concat(
    "<p><b>Request Headers</b>:<br/>").concat(
      requestHeaders.toString()).concat("</p>")
var script = "Array.prototype.slice.call(\\n".concat(
  "document.getElementsByClassName('callback-component')).forEach(\\n").concat(
  "function (e) {\\n").concat(
  "  var message = e.firstElementChild;\\n").concat(
  "  if (message.firstChild && message.firstChild.nodeName == '#text' && message.firstChild.nodeValue.trim() == '").concat(anchor).concat("') {\\n").concat(
  "    message.className = \\"text-left\\";\\n").concat(
  "    message.align = \\"").concat(halign).concat("\\";\\n").concat(
  "    message.innerHTML = '").concat(message).concat("';\\n").concat(
  "  }\\n").concat(
  "})")
var fr = JavaImporter(
    org.forgerock.openam.auth.node.api.Action,
    javax.security.auth.callback.TextOutputCallback,
    com.sun.identity.authentication.callbacks.ScriptTextOutputCallback
)
if (message.length && callbacks.isEmpty()) {
    action = fr.Action.send(
        new fr.TextOutputCallback(
            fr.TextOutputCallback.INFORMATION,
            anchor
        ),
        new fr.ScriptTextOutputCallback(script)
    ).build()
}
else {
  action = fr.Action.goTo("true").build();
}

 /*
  * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.
  * 
  * Example:
  * 'xxxxx' produces '28535'
  * 'xxx-xxx' produces '432-521'
  */
function generateNumericToken(format) {
    return format.replace(/[x]/g, function(c) {
        var r = Math.random()*10|0;
        var v = r;
        return v.toString(10);
    });
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./debug.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "3cb43516-ae69-433a-8787-501d45db14e9": {
      "_id": "3cb43516-ae69-433a-8787-501d45db14e9",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Display sharedState, transientState, and headers.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "debug",
      "script": "file://debug.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./deviceprofile_to_attribute.script.js 1`] = `
"var objectAttributes = sharedState.get("objectAttributes");
var deviceHash = sharedState.get("deviceHash");

sharedState.put("frIndexedString1" , deviceHash );



if(objectAttributes === null || objectAttributes === undefined)
{


 objectAttributes = {
                        "userName" : "anon-".concat(deviceHash),
                     "givenName" : " ",
                     "sn" : " ",
                     "mail" : "anon-".concat(deviceHash).concat("@mytestrun.com"),
                     "frIndexedString1" : deviceHash
                    }
}
else
{

    objectAttributes.put("userName",  "anon-".concat(deviceHash));
    objectAttributes.put("givenName", " ");
    objectAttributes.put("sn", " ");
    objectAttributes.put("mail", "anon-".concat(deviceHash).concat("@mytestrun.com"));
    objectAttributes.put("frIndexedString1", deviceHash);
   
}


sharedState.put("objectAttributes",objectAttributes);
    
outcome = "true";"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./deviceprofile_to_attribute.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "123725a9-2119-4efd-a6b0-456f3ccd34b7": {
      "_id": "123725a9-2119-4efd-a6b0-456f3ccd34b7",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "deviceprofile_to_attribute",
      "script": "file://deviceprofile_to_attribute.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./display-country.script.js 1`] = `
"var fr = JavaImporter(
  org.forgerock.openam.auth.node.api,
  javax.security.auth.callback.TextOutputCallback
);
  
outcome = "true";

var country = "unknown";
if (transientState.get("ipstack")) {
    country = JSON.parse(transientState.get("ipstack")).country_code;
}
  
with (fr) {
  if (callbacks.isEmpty()) {
    var callback = new TextOutputCallback(TextOutputCallback.INFORMATION, "Country: ".concat(country));
    action = Action.send(callback).build();
  } else {
    action = Action.goTo("true").build();
  }
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./display-country.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "8bccfdd0-5556-4562-a1ca-6d725a449556": {
      "_id": "8bccfdd0-5556-4562-a1ca-6d725a449556",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "display country",
      "script": "file://display-country.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./hashdeviceProfile.script.js 1`] = `
"/*
  - Data made available by nodes that have already executed are available in the sharedState variable.
  - The script should set outcome to either "true" or "false".
 */

//<script type="text/javascript" src="http://www.myersdaily.org/joseph/javascript/md5.js" />

function hashCode(r){var e,h=0;for(e=0;e<r.length;e++)h=(h<<5)-h+r.charCodeAt(e),h|=0;return h>>>0}


var hashMe = sharedState.get("forgeRock.device.profile");
var hashMe = sharedState.put("forgeRock.device.profile","deleted in script - hashdeviceProfile");
//var hashMeStr = JSON.stringify(hashMe);
//logger.error("HashMeStr: " + hashMeStr);

sharedState.put("deviceHash",hashCode(escape(hashMe)).toString());
sharedState.put("frIndexedString1",hashCode(escape(hashMe)).toString());

outcome = "true";"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./hashdeviceProfile.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "e15a13ee-9168-40cf-934f-656a5f568a6a": {
      "_id": "e15a13ee-9168-40cf-934f-656a5f568a6a",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "hashdeviceProfile",
      "script": "file://hashdeviceProfile.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./iddataweb-Profile-Normalization.script.groovy 1`] = `
"/*/*
 * Copyright 2022 ForgeRock AS. All Rights Reserved
 *
 * Use of this code requires a commercial software license with ForgeRock AS.
 * or with one of its affiliates. All use shall be exclusively subject
 * to such license between the licensee and ForgeRock AS. Not for Production use. 
 * Modified by Stephen Payne
 */
/* Social Identity Provider Profile Transformation script for ID DataWeb */
import static org.forgerock.json.JsonValue.field
import static org.forgerock.json.JsonValue.json
import static org.forgerock.json.JsonValue.object

logger.error("iddataweb_Social Identity Provider Profile Transformation script: Start");
userName = sharedState.get("objectAttributes").get("mail");
logger.error("iddataweb_Social Identity Provider Profile Transformation script: userName" + userName );
username = userName;
sharedState.put("userName", userName);

return json(object(
        field("id", rawProfile.sub),
        field("displayName", rawProfile.acquiredAttributes_AcquiredFullName_fname.asString() + " " + rawProfile.acquiredAttributes_AcquiredFullName_lname.asString().toLowerCase().capitalize() ),
        field("givenName", rawProfile.acquiredAttributes_AcquiredFullName_fname.asString().toLowerCase().capitalize() ),
        field("familyName", rawProfile.acquiredAttributes_AcquiredFullName_lname.asString().toLowerCase().capitalize() ),
        field("postalAddress", rawProfile.acquiredAttributes_AcquiredAddress_address),
        field("addressLocality", rawProfile.acquiredAttributes_AcquiredAddress_locality),
        field("addressRegion", rawProfile.acquiredAttributes_AcquiredAddress_administrative_area_level_1),
        field("postalCode", rawProfile.acquiredAttributes_AcquiredAddress_postal_code),
        field("country", rawProfile.acquiredAttributes_AcquiredAddress_country),
        field("driversLicense", rawProfile.acquiredAttributes_AcquiredDriversLicenseNumber_acquiredDriversLicenseNumber),
        field("driversLicenseIssuer", rawProfile.acquiredAttributes_DriversLicenseIssuerCode_DriversLicenseIssuerCode),
          field("DOB", rawProfile.acquiredAttributes_AcquiredDOB_month.asString() + "/" + rawProfile.acquiredAttributes_AcquiredDOB_day.asString() + "/" + rawProfile.acquiredAttributes_AcquiredDOB_year.asString() ),

        field("IDWScore", rawProfile.acquiredAttributes_IDWScore),
        field("policyDecision", rawProfile.policyDecision_conclusion),
        field("phone", rawProfile.userAttributes_InternationalTelephone_dialCode.asString() + rawProfile.userAttributes_InternationalTelephone_telephone.asString()),
        field("username", userName )
       //field("username", rawProfile.acquiredAttributes_AcquiredFullName_fname.asString() + "." + rawProfile.acquiredAttributes_AcquiredFullName_lname.asString() )

   )
)
"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./iddataweb-Profile-Normalization.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "2997bd4d-14be-4dc6-8701-27f08d10b8b7": {
      "_id": "2997bd4d-14be-4dc6-8701-27f08d10b8b7",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Profile Normalization Script for idddataweb",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "iddataweb Profile Normalization",
      "script": "file://iddataweb-Profile-Normalization.script.groovy",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./ipstack.script.js 1`] = `
"logger.warning("ipstack: start");

outcome = "unknown";

var ip = getClientIPAddress();
logger.warning("ipstack: ip=".concat(ip));

if (ip) {

      // ipstack API Configuration
    var IPSTACK_ACCESS_KEY = "efc2f8d9796b9feff5f03359d6fbccc9";
    var IPSTACK_API_URI = "http://api.ipstack.com/".concat(ip).concat("?access_key=").concat(IPSTACK_ACCESS_KEY);    

    var request = new org.forgerock.http.protocol.Request();
    request.setMethod('GET');
    request.setUri(IPSTACK_API_URI);

    var response = httpClient.send(request).get();
    var result = JSON.parse(response.getEntity().getString());
    logger.warning("ipstack: JSON result: " + JSON.stringify(result));

      /*
    {
        "ip": "99.72.28.182",
        "type": "ipv4",
        "continent_code": "NA",
        "continent_name": "North America",
        "country_code": "US",
        "country_name": "United States",
        "region_code": "TX",
        "region_name": "Texas",
        "city": "Georgetown",
        "zip": "78626",
        "latitude": 30.592500686645508,
        "longitude": -97.66710662841797,
        "location": {
            "geoname_id": 4693342,
            "capital": "Washington D.C.",
            "languages": [
                {
                    "code": "en",
                    "name": "English",
                    "native": "English"
                }
            ],
            "country_flag": "http://assets.ipstack.com/flags/us.svg",
            "country_flag_emoji": "🇺🇸",
            "country_flag_emoji_unicode": "U+1F1FA U+1F1F8",
            "calling_code": "1",
            "is_eu": false
        }
    }
    */
  
      // preserve result in transient state
      transientState.put("ipstack", JSON.stringify(result));

    switch(result.country_code) {
      case "CA":
        outcome = result.country_code;
        break;
      case "UK":
        outcome = result.country_code;
        break;
      case "US":
        outcome = result.country_code;
        break;
      default:
        outcome = "other";
    }

} else {
      logger.error("ipstack: no client ip!");
}

logger.warning("ipstack: finish");

 /*
  * !!! ASSUMES ID CLOUD !!!
  *
  * Returns the client's IP address
  */
 function getClientIPAddress() {
    return requestHeaders.get("x-forwarded-for").get(0).split(',')[0];
 }"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./ipstack.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "87497360-d89c-412a-a99e-c8a9bec465cc": {
      "_id": "87497360-d89c-412a-a99e-c8a9bec465cc",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "ipstack",
      "script": "file://ipstack.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./level.script.js 1`] = `
"(function () {
  outcome = 'true';
  var level = nodeState.get('level').asInteger();
  sharedState.put('level' + level + 'Value', 'Level ' + level + ': This is a longer string value set at each level of the nested journeys. It contains an indicator in which level it was set.');
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./level.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "41c24257-d7fc-4654-8b46-c2666dc5b56d": {
      "_id": "41c24257-d7fc-4654-8b46-c2666dc5b56d",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "set per level shared state variable",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "level",
      "script": "file://level.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./mode.script.js 1`] = `
"/* mode
 *
 * Author: volker.scheuber@forgerock.com
 * 
 * Collect mode if not already set and set outcome to mode.
 * 
 * This script does not need to be parametrized. It will work properly as is.
 * 
 * The Scripted Decision Node needs the following outcomes defined:
 * - 'shared and level'
 * - 'shared only'
 * - 'level only'
 * - 'none'
 */
(function () {
  var mode = nodeState.get('mode');
  if (mode) {
    outcome = mode.asString();
    var level = nodeState.get('level').asInteger() + 1;
    logger.error('mode: mode=' + mode.asString() + ', level=' + level);
    sharedState.put('level', level);
  }
  else {
    var choices = ['shared and level', 'shared only', 'level only', 'none'];
  
    var fr = JavaImporter(
      org.forgerock.openam.auth.node.api.Action,
      javax.security.auth.callback.ChoiceCallback
    )

    if (callbacks.isEmpty()) {
      action = fr.Action.send([
        new fr.ChoiceCallback('Choose test mode', choices, 0, false)
      ]).build();
    } else {
      var choice = parseInt(callbacks.get(0).getSelectedIndexes()[0]);
      nodeState.putShared('mode', choices[choice]);
      nodeState.putShared('level', 0);
      action = fr.Action.goTo(choices[choice]).build();
    }
  }
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./mode.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "5bbdaeff-ddee-44b9-b608-8d413d7d65a6": {
      "_id": "5bbdaeff-ddee-44b9-b608-8d413d7d65a6",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Check if mode has already been set.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "mode",
      "script": "file://mode.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./shared.script.js 1`] = `
"(function () {
  outcome = 'true';
  var level = nodeState.get('level').asInteger();
  sharedState.put('sharedValue', 'Level ' + level + ': This is a longer string value shared across all nested journeys. It contains an indicator in which level it was last set.');
}());"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./shared.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "1b52a7e0-4019-40fa-958a-15a49870e901": {
      "_id": "1b52a7e0-4019-40fa-958a-15a49870e901",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "set the same shared state variable",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "shared",
      "script": "file://shared.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./shared-State-Printer.script.js 1`] = `
"var fr = JavaImporter(
  org.forgerock.openam.auth.node.api,
  javax.security.auth.callback.TextOutputCallback
);
outcome = "true";
with (fr) {
  if (callbacks.isEmpty()) {
    var callback = new TextOutputCallback(TextOutputCallback.INFORMATION, "sharedState: ".concat(sharedState.toString()));
    action = Action.send(callback).build();
  } else {
    action = Action.goTo("true").build();
  }
}"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./shared-State-Printer.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "b6fce769-cf21-4963-a8dc-7c5370a4d15b": {
      "_id": "b6fce769-cf21-4963-a8dc-7c5370a4d15b",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "shared State Printer",
      "script": "file://shared-State-Printer.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./temp.script.js 1`] = `
"/*
  - Data made available by nodes that have already executed are available in the sharedState variable.
  - The script should set outcome to either "true" or "false".
 */
outcome = "false";
if(sharedState.get("userName"))
{
var username = sharedState.get("userName")
var id = sharedState.get("_id")
var persona = existingSession.get('persona')

sharedState.put("debug",username);
sharedState.put("debug_id",id);
sharedState.put("persona",persona);

if(username!=='')
{
  outcome = "true";
}}
"
`;

exports[`frodo script export "frodo script export -Ax": should export all extracted scripts to separate files: ./temp.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "2aaa8076-5d0b-4433-9660-fec1ba51b608": {
      "_id": "2aaa8076-5d0b-4433-9660-fec1ba51b608",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "temp",
      "script": "file://temp.script.js",
    },
  },
}
`;

exports[`frodo script export "frodo script export -a --file my-allAlphaScripts.script.json": should export all scripts to a single file named my-allAlphaScripts.script.json 1`] = `""`;

exports[`frodo script export "frodo script export -a --file my-allAlphaScripts.script.json": should export all scripts to a single file named my-allAlphaScripts.script.json: ./my-allAlphaScripts.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "01e1a3c0-038b-4c16-956a-6c9d89328cff": {
      "_id": "01e1a3c0-038b-4c16-956a-6c9d89328cff",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Default global script for a scripted decision node",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Authentication Tree Decision Node Script",
      "script": [
        "/*",
        "  - Data made available by nodes that have already executed are available in the sharedState variable.",
        "  - The script should set outcome to either "true" or "false".",
        " */",
        "",
        "outcome = "true";",
      ],
    },
    "021e434f-89b6-45fb-9d67-5147bc1650c3": {
      "_id": "021e434f-89b6-45fb-9d67-5147bc1650c3",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Show Password Policy",
      "script": [
        "var output = true;",
        "var anchor = "anchor-".concat(generateNumericToken('xxx'));",
        "var halign = "left";",
        "var message = "<ul><li>Must be at least 8 characters long</li>".concat(",
        "    "<li>Must be less than 64 characters long</li>").concat(",
        "    "<li>Must not share characters with email, username, first name, last name</li>").concat(",
        "    "<li>Must have at least 1 lowercase letter(s)</li>").concat(",
        "    "<li>Must have at least 1 capital letter(s)</li>").concat(",
        "    "<li>Must have at least 1 number(s)</li>").concat(",
        "    "<li>Must have at least 1 symbol(s)</li></ul>")",
        "var script = "Array.prototype.slice.call(\\n".concat(",
        "  "document.getElementsByClassName('callback-component')).forEach(\\n").concat(",
        "  "function (e) {\\n").concat(",
        "  "  var message = e.firstElementChild;\\n").concat(",
        "  "  if (message.firstChild && message.firstChild.nodeName == '#text' && message.firstChild.nodeValue.trim() == '").concat(anchor).concat("') {\\n").concat(",
        "  "    message.className = \\"text-left\\";\\n").concat(",
        "  "    message.align = \\"").concat(halign).concat("\\";\\n").concat(",
        "  "    message.innerHTML = '").concat(message).concat("';\\n").concat(",
        "  "  }\\n").concat(",
        "  "})")",
        "var fr = JavaImporter(",
        "    org.forgerock.openam.auth.node.api.Action,",
        "    javax.security.auth.callback.TextOutputCallback,",
        "    com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        ")",
        "if (message.length && callbacks.isEmpty()) {",
        "    action = fr.Action.send(",
        "        new fr.TextOutputCallback(",
        "            fr.TextOutputCallback.INFORMATION,",
        "            anchor",
        "        ),",
        "        new fr.ScriptTextOutputCallback(script)",
        "    ).build()",
        "}",
        "else {",
        "  action = fr.Action.goTo("true").build();",
        "}",
        "",
        " /*",
        "  * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "  * ",
        "  * Example:",
        "  * 'xxxxx' produces '28535'",
        "  * 'xxx-xxx' produces '432-521'",
        "  */",
        "function generateNumericToken(format) {",
        "    return format.replace(/[x]/g, function(c) {",
        "        var r = Math.random()*10|0;",
        "        var v = r;",
        "        return v.toString(10);",
        "    });",
        "}",
      ],
    },
    "073a64d4-37c9-486d-8c59-6583494644b9": {
      "_id": "073a64d4-37c9-486d-8c59-6583494644b9",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "FRAAS-7955 Transient State Only",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "FRAAS-7955 Transient State Only",
      "script": [
        "outcome = "true";",
        "",
        "setTransientObjectAttribute("userName", "FRAAS-7955");",
        "setTransientObjectAttribute("givenName", "First-transient");",
        "setTransientObjectAttribute("sn", "Last-transient");",
        "setTransientObjectAttribute("mail", "first.last-transient@company.com");",
        "",
        "/*",
        " * Store attributes in transient state for use with the Create/Patch Object nodes.",
        " */",
        "function setTransientObjectAttribute(name, value) {",
        "    var transientStorage = transientState.get("objectAttributes");",
        "    if (transientStorage && value) {",
        "          if (transientStorage.put) {",
        "            transientStorage.put(name, value);",
        "        }",
        "          else {",
        "            transientStorage[name] = value;",
        "        }",
        "    }",
        "    else if (value) {",
        "    transientState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "    }",
        "}",
      ],
    },
    "0ab1dd57-eafd-4063-8e60-65bfac8108b7": {
      "_id": "0ab1dd57-eafd-4063-8e60-65bfac8108b7",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Check existing session and set username",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Check Existing Session",
      "script": [
        "if (typeof existingSession !== 'undefined')",
        "{",
        "  outcome = "hasSession";",
        "  sharedState.put("username", existingSession.get("UserId"));",
        "  sharedState.put("_id", existingSession.get("UserId"));",
        "  if (sharedState.get("objectAttributes")) {",
        "    sharedState.get("objectAttributes").put("userName", existingSession.get("UserId"));",
        "  }",
        "  else {",
        "    sharedState.put("objectAttributes", {userName: existingSession.get("UserId")});",
        "  }",
        "}",
        "else",
        "{",
        "  outcome = "noSession";",
        "}",
      ],
    },
    "0d471aff-81f3-41ce-8bf9-35c27cdc0a26": {
      "_id": "0d471aff-81f3-41ce-8bf9-35c27cdc0a26",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_CanBeInvited",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "(function() {",
        "  var fr = new JavaImporter(",
        "    org.forgerock.openam.auth.nodes,",
        "    org.forgerock.guice.core",
        "  );",
        "",
        "  with (fr) {",
        "    try {",
        "",
        "      outcome = 'False';",
        "",
        "      var realm = sharedState.get('realm');",
        "      var uuid = sharedState.get('username');",
        "      var identityProvider = InjectorHolder.getInstance(IdentityProvider);",
        "      var identity = identityProvider.getIdentity(uuid, realm);",
        "      var attrs = identity.getAttributes();",
        "",
        "      if (!attrs.containsKey('fr-idm-inviteDate')) {",
        "        logger.message('Admin cannot be invited: no invite date');",
        "        return;",
        "      }",
        "",
        "      if (attrs.containsKey('fr-idm-onboardDate')) {",
        "        logger.message('Admin cannot be invited: already onboarded');",
        "        return;",
        "      }",
        "",
        "      var email = attrs.get('mail').iterator().next();",
        "      var objAttrs = {",
        "        mail: email,",
        "        userName: email,",
        "      };",
        "      sharedState.put('objectAttributes', objAttrs);",
        "",
        "      logger.message('Admin can be invited');",
        "      outcome = 'True';",
        "",
        "    } catch (e) {",
        "",
        "      logger.error('Failed to determine if admin can be invited: {}', e);",
        "",
        "    }",
        "  }",
        "}());",
      ],
    },
    "123725a9-2119-4efd-a6b0-456f3ccd34b7": {
      "_id": "123725a9-2119-4efd-a6b0-456f3ccd34b7",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "deviceprofile_to_attribute",
      "script": [
        "var objectAttributes = sharedState.get("objectAttributes");",
        "var deviceHash = sharedState.get("deviceHash");",
        "",
        "sharedState.put("frIndexedString1" , deviceHash );",
        "",
        "",
        "",
        "if(objectAttributes === null || objectAttributes === undefined)",
        "{",
        "",
        "",
        " objectAttributes = {",
        "                        "userName" : "anon-".concat(deviceHash),",
        "                     "givenName" : " ",",
        "                     "sn" : " ",",
        "                     "mail" : "anon-".concat(deviceHash).concat("@mytestrun.com"),",
        "                     "frIndexedString1" : deviceHash",
        "                    }",
        "}",
        "else",
        "{",
        "",
        "    objectAttributes.put("userName",  "anon-".concat(deviceHash));",
        "    objectAttributes.put("givenName", " ");",
        "    objectAttributes.put("sn", " ");",
        "    objectAttributes.put("mail", "anon-".concat(deviceHash).concat("@mytestrun.com"));",
        "    objectAttributes.put("frIndexedString1", deviceHash);",
        "   ",
        "}",
        "",
        "",
        "sharedState.put("objectAttributes",objectAttributes);",
        "    ",
        "outcome = "true";",
      ],
    },
    "1244e639-4a31-401d-ab61-d75133d8dc9e": {
      "_id": "1244e639-4a31-401d-ab61-d75133d8dc9e",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from Instagram",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Instagram Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "return json(object(",
        "        field("id", rawProfile.id),",
        "        field("username", rawProfile.username)))",
      ],
    },
    "13b6a418-4ccc-41b6-86ce-0a13f352da22": {
      "_id": "13b6a418-4ccc-41b6-86ce-0a13f352da22",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_HasOnboarded",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "(function() {",
        "  var fr = new JavaImporter(",
        "    org.forgerock.openam.auth.nodes,",
        "    org.forgerock.guice.core",
        "  );",
        "",
        "  with (fr) {",
        "    try {",
        "",
        "      outcome = 'False';",
        "",
        "      var realm = sharedState.get('realm');",
        "      var uuid = sharedState.get('_id');",
        "      var identityProvider = InjectorHolder.getInstance(IdentityProvider);",
        "      var identity = identityProvider.getIdentity(uuid, realm);",
        "      var attrs = identity.getAttributes();",
        "",
        "      if (attrs.containsKey('fr-idm-onboardDate')) {",
        "        logger.message('Admin has onboard date');",
        "        outcome = 'True';",
        "      }",
        "",
        "    } catch (e) {",
        "",
        "      logger.error('Failed to determine if admin has onboarded: {}', e);",
        "      outcome = 'Error';",
        "",
        "    }",
        "  }",
        "}());",
      ],
    },
    "13cd3c60-a04b-4455-b028-fbfd01ed88b1": {
      "_id": "13cd3c60-a04b-4455-b028-fbfd01ed88b1",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Azure AD pass through authentication using Resource Owner Password Credential flow",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "AAD Passthru ROPC",
      "script": [
        "/* AAD Passthru ROPC",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Azure AD pass through authentication using Resource Owner Password Credential flow",
        " * ",
        " * This script needs to be parametrized. It will not work properly as is. ",
        " * It requires the Platform Username and Platform Password collector nodes",
        " * before it can operate.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - Valid",
        " * - Invalid",
        " * - Expired",
        " * - Disabled",
        " * - Error",
        " */",
        "logger.message("AAD Passthru ROPC: start");",
        "",
        "if (sharedState.get("username") && transientState.get("password")) {",
        "      /*",
        "     * BEGIN SCRIPT CONFIGURATION",
        "     *",
        "     * REPLACE WITH YOUR OWN AZURE AD SETTINGS",
        "     *",
        "     * AAD_TENANT_ID is your tenant ID: https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/active-directory-how-to-find-tenant",
        "     * AAD_CLIENT_ID is your registered app ID: https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-register-app",
        "     */",
        "    var AAD_TENANT_ID = "711ffa9c-5972-4713-ace3-688c9732614a";",
        "    var AAD_CLIENT_ID = "51f130ec-d29d-4419-a492-0011d09c1a16";",
        "    /*",
        "     * END SCRIPT CONFIGURATION",
        "     */",
        "      ",
        "    // Azure AD ROPC Configuration",
        "    var AAD_SCOPE = "profile";",
        "      var AAD_RESOURCE = "https://graph.microsoft.com/"",
        "    var AAD_OAUTH2_TOKEN_URI = "https://login.windows.net/".concat(AAD_TENANT_ID).concat("/oauth2/token");",
        "",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setMethod('POST');",
        "    request.setUri(AAD_OAUTH2_TOKEN_URI);",
        "    request.getHeaders().add("Content-Type", "application/x-www-form-urlencoded");",
        "    var params = request.getForm();",
        "    params.add("resource", AAD_RESOURCE);",
        "    params.add("client_id", AAD_CLIENT_ID);",
        "    params.add("grant_type", "password");",
        "    params.add("scope", AAD_SCOPE);",
        "    params.add("username", sharedState.get("username"));",
        "    params.add("password", transientState.get("password"));",
        "    request.getEntity().setString(params.toString());",
        "",
        "    var response = httpClient.send(request).get();",
        "    var result = JSON.parse(response.getEntity().getString());",
        "    //logger.message("AAD Passthru ROPC: JSON result: " + JSON.stringify(result));",
        "",
        "      if (response.getStatus().getCode() === 200) {",
        "          outcome = "Valid"",
        "        transientState.put("aadAccessToken", result.access_token);",
        "    } else {",
        "        /* Outcomes:",
        "         * - Valid",
        "         * - Invalid",
        "         * - Expired",
        "         * - Disabled",
        "         * - Error",
        "         *",
        "         * Expected Error Codes:",
        "         * 50126 - Error validating credentials due to invalid username or password.",
        "         * 50055 - The password is expired.",
        "         * 50057 - The user account is disabled.",
        "         * 50196 - The server terminated an operation because it encountered a client request loop. Please contact your app vendor.",
        "         */",
        "        if (result.error_codes.includes(50126)) {",
        "            outcome = "Invalid";",
        "        } else if (result.error_codes.includes(50055)) {",
        "            outcome = "Expired";",
        "        } else if (result.error_codes.includes(50057)) {",
        "            outcome = "Disabled";",
        "        } else {",
        "            outcome = "Error";",
        "        }",
        "        logger.message("AAD Passthru ROPC: error = ".concat(result.error));",
        "        logger.message("AAD Passthru ROPC: error_description = ".concat(result.error_description));",
        "        logger.message("AAD Passthru ROPC: error_codes = ".concat(result.error_codes));",
        "    }",
        "} else {",
        "      outcome = "Error";",
        "      logger.message("AAD Passthru ROPC: No user or password found in shared state! Use username and password collector nodes before this script to populate shared and transient states!'");",
        "}",
        "logger.message("AAD Passthru ROPC: End (outcome=".concat(outcome).concat(")"));",
      ],
    },
    "14f14ad3-f35f-455b-a7ba-d7cd939c6921": {
      "_id": "14f14ad3-f35f-455b-a7ba-d7cd939c6921",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Dropdown selector",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Choice inner1, inner2",
      "script": [
        "/* Choice inner1, inner2",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Render a dropdown selector",
        " * ",
        " * This script must be parametrized. It will not work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "(function () {",
        "  outcome = "true";",
        "  var choices = ["inner1", "inner2"];",
        "  ",
        "  var fr = JavaImporter(",
        "    org.forgerock.openam.auth.node.api.Action,",
        "    javax.security.auth.callback.ChoiceCallback",
        "  )",
        "",
        "  if (callbacks.isEmpty()) {",
        "    action = fr.Action.send([",
        "      new fr.ChoiceCallback("Select a journey", choices, 0, false)",
        "    ]).build();",
        "  } else {",
        "    var choice = parseInt(callbacks.get(0).getSelectedIndexes()[0]);",
        "    nodeState.putShared("nodeConfig", {tree: choices[choice]});",
        "    action = fr.Action.goTo(outcome).build();",
        "  }",
        "}());",
      ],
    },
    "157298c0-7d31-4059-a95b-eeb08473b7e5": {
      "_id": "157298c0-7d31-4059-a95b-eeb08473b7e5",
      "context": "AUTHENTICATION_CLIENT_SIDE",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Default global script for client side Device Id (Match) Authentication Module",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Device Id (Match) - Client Side",
      "script": [
        "var fontDetector = (function () {",
        "    /**",
        "     * JavaScript code to detect available availability of a",
        "     * particular font in a browser using JavaScript and CSS.",
        "     *",
        "     * Author : Lalit Patel",
        "     * Website: http://www.lalit.org/lab/javascript-css-font-detect/",
        "     * License: Apache Software License 2.0",
        "     *          http://www.apache.org/licenses/LICENSE-2.0",
        "     * Version: 0.15 (21 Sep 2009)",
        "     *          Changed comparision font to default from sans-default-default,",
        "     *          as in FF3.0 font of child element didn't fallback",
        "     *          to parent element if the font is missing.",
        "     * Version: 0.2 (04 Mar 2012)",
        "     *          Comparing font against all the 3 generic font families ie,",
        "     *          'monospace', 'sans-serif' and 'sans'. If it doesn't match all 3",
        "     *          then that font is 100% not available in the system",
        "     * Version: 0.3 (24 Mar 2012)",
        "     *          Replaced sans with serif in the list of baseFonts",
        "     */",
        "    /*",
        "     * Portions Copyrighted 2013 ForgeRock AS.",
        "     */",
        "    var detector = {}, baseFonts, testString, testSize, h, s, defaultWidth = {}, defaultHeight = {}, index;",
        "",
        "    // a font will be compared against all the three default fonts.",
        "    // and if it doesn't match all 3 then that font is not available.",
        "    baseFonts = ['monospace', 'sans-serif', 'serif'];",
        "",
        "    //we use m or w because these two characters take up the maximum width.",
        "    // And we use a LLi so that the same matching fonts can get separated",
        "    testString = "mmmmmmmmmmlli";",
        "",
        "    //we test using 72px font size, we may use any size. I guess larger the better.",
        "    testSize = '72px';",
        "",
        "    h = document.getElementsByTagName("body")[0];",
        "",
        "    // create a SPAN in the document to get the width of the text we use to test",
        "    s = document.createElement("span");",
        "    s.style.fontSize = testSize;",
        "    s.innerHTML = testString;",
        "    for (index in baseFonts) {",
        "        //get the default width for the three base fonts",
        "        s.style.fontFamily = baseFonts[index];",
        "        h.appendChild(s);",
        "        defaultWidth[baseFonts[index]] = s.offsetWidth; //width for the default font",
        "        defaultHeight[baseFonts[index]] = s.offsetHeight; //height for the defualt font",
        "        h.removeChild(s);",
        "    }",
        "",
        "    detector.detect = function(font) {",
        "        var detected = false, index, matched;",
        "        for (index in baseFonts) {",
        "            s.style.fontFamily = font + ',' + baseFonts[index]; // name of the font along with the base font for fallback.",
        "            h.appendChild(s);",
        "            matched = (s.offsetWidth !== defaultWidth[baseFonts[index]] || s.offsetHeight !== defaultHeight[baseFonts[index]]);",
        "            h.removeChild(s);",
        "            detected = detected || matched;",
        "        }",
        "        return detected;",
        "    };",
        "",
        "    return detector;",
        "}());",
        "/*",
        " * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS HEADER.",
        " *",
        " * Copyright (c) 2009 Sun Microsystems Inc. All Rights Reserved",
        " *",
        " * The contents of this file are subject to the terms",
        " * of the Common Development and Distribution License",
        " * (the License). You may not use this file except in",
        " * compliance with the License.",
        " *",
        " * You can obtain a copy of the License at",
        " * https://opensso.dev.java.net/public/CDDLv1.0.html or",
        " * opensso/legal/CDDLv1.0.txt",
        " * See the License for the specific language governing",
        " * permission and limitations under the License.",
        " *",
        " * When distributing Covered Code, include this CDDL",
        " * Header Notice in each file and include the License file",
        " * at opensso/legal/CDDLv1.0.txt.",
        " * If applicable, add the following below the CDDL Header,",
        " * with the fields enclosed by brackets [] replaced by",
        " * your own identifying information:",
        " * "Portions Copyrighted [year] [name of copyright owner]"",
        " *",
        " */",
        "/*",
        " * Portions Copyrighted 2013 Syntegrity.",
        " * Portions Copyrighted 2013-2014 ForgeRock AS.",
        " */",
        "",
        "var collectScreenInfo = function () {",
        "        var screenInfo = {};",
        "        if (screen) {",
        "            if (screen.width) {",
        "                screenInfo.screenWidth = screen.width;",
        "            }",
        "",
        "            if (screen.height) {",
        "                screenInfo.screenHeight = screen.height;",
        "            }",
        "",
        "            if (screen.pixelDepth) {",
        "                screenInfo.screenColourDepth = screen.pixelDepth;",
        "            }",
        "        } else {",
        "            console.warn("Cannot collect screen information. screen is not defined.");",
        "        }",
        "        return screenInfo;",
        "    },",
        "    collectTimezoneInfo = function () {",
        "        var timezoneInfo =  {}, offset = new Date().getTimezoneOffset();",
        "",
        "        if (offset) {",
        "            timezoneInfo.timezone = offset;",
        "        } else {",
        "            console.warn("Cannot collect timezone information. timezone is not defined.");",
        "        }",
        "",
        "        return timezoneInfo;",
        "    },",
        "    collectBrowserPluginsInfo = function () {",
        "",
        "        if (navigator && navigator.plugins) {",
        "            var pluginsInfo = {}, i, plugins = navigator.plugins;",
        "            pluginsInfo.installedPlugins = "";",
        "",
        "            for (i = 0; i < plugins.length; i++) {",
        "                pluginsInfo.installedPlugins = pluginsInfo.installedPlugins + plugins[i].filename + ";";",
        "            }",
        "",
        "            return pluginsInfo;",
        "        } else {",
        "            console.warn("Cannot collect browser plugin information. navigator.plugins is not defined.");",
        "            return {};",
        "        }",
        "",
        "    },",
        "// Getting geolocation takes some time and is done asynchronously, hence need a callback which is called once geolocation is retrieved.",
        "    collectGeolocationInfo = function (callback) {",
        "        var geolocationInfo = {},",
        "            successCallback = function(position) {",
        "                geolocationInfo.longitude = position.coords.longitude;",
        "                geolocationInfo.latitude = position.coords.latitude;",
        "                callback(geolocationInfo);",
        "            }, errorCallback = function(error) {",
        "                console.warn("Cannot collect geolocation information. " + error.code + ": " + error.message);",
        "                callback(geolocationInfo);",
        "            };",
        "        if (navigator && navigator.geolocation) {",
        "            // NB: If user chooses 'Not now' on Firefox neither callback gets called",
        "            //     https://bugzilla.mozilla.org/show_bug.cgi?id=675533",
        "            navigator.geolocation.getCurrentPosition(successCallback, errorCallback);",
        "        } else {",
        "            console.warn("Cannot collect geolocation information. navigator.geolocation is not defined.");",
        "            callback(geolocationInfo);",
        "        }",
        "    },",
        "    collectBrowserFontsInfo = function () {",
        "        var fontsInfo = {}, i, fontsList = ["cursive","monospace","serif","sans-serif","fantasy","default","Arial","Arial Black",",
        "            "Arial Narrow","Arial Rounded MT Bold","Bookman Old Style","Bradley Hand ITC","Century","Century Gothic",",
        "            "Comic Sans MS","Courier","Courier New","Georgia","Gentium","Impact","King","Lucida Console","Lalit",",
        "            "Modena","Monotype Corsiva","Papyrus","Tahoma","TeX","Times","Times New Roman","Trebuchet MS","Verdana",",
        "            "Verona"];",
        "        fontsInfo.installedFonts = "";",
        "",
        "        for (i = 0; i < fontsList.length; i++) {",
        "            if (fontDetector.detect(fontsList[i])) {",
        "                fontsInfo.installedFonts = fontsInfo.installedFonts + fontsList[i] + ";";",
        "            }",
        "        }",
        "        return fontsInfo;",
        "    },",
        "    devicePrint = {};",
        "",
        "devicePrint.screen = collectScreenInfo();",
        "devicePrint.timezone = collectTimezoneInfo();",
        "devicePrint.plugins = collectBrowserPluginsInfo();",
        "devicePrint.fonts = collectBrowserFontsInfo();",
        "",
        "if (navigator.userAgent) {",
        "    devicePrint.userAgent = navigator.userAgent;",
        "}",
        "if (navigator.appName) {",
        "    devicePrint.appName = navigator.appName;",
        "}",
        "if (navigator.appCodeName) {",
        "    devicePrint.appCodeName = navigator.appCodeName;",
        "}",
        "if (navigator.appVersion) {",
        "    devicePrint.appVersion = navigator.appVersion;",
        "}",
        "if (navigator.appMinorVersion) {",
        "    devicePrint.appMinorVersion = navigator.appMinorVersion;",
        "}",
        "if (navigator.buildID) {",
        "    devicePrint.buildID = navigator.buildID;",
        "}",
        "if (navigator.platform) {",
        "    devicePrint.platform = navigator.platform;",
        "}",
        "if (navigator.cpuClass) {",
        "    devicePrint.cpuClass = navigator.cpuClass;",
        "}",
        "if (navigator.oscpu) {",
        "    devicePrint.oscpu = navigator.oscpu;",
        "}",
        "if (navigator.product) {",
        "    devicePrint.product = navigator.product;",
        "}",
        "if (navigator.productSub) {",
        "    devicePrint.productSub = navigator.productSub;",
        "}",
        "if (navigator.vendor) {",
        "    devicePrint.vendor = navigator.vendor;",
        "}",
        "if (navigator.vendorSub) {",
        "    devicePrint.vendorSub = navigator.vendorSub;",
        "}",
        "if (navigator.language) {",
        "    devicePrint.language = navigator.language;",
        "}",
        "if (navigator.userLanguage) {",
        "    devicePrint.userLanguage = navigator.userLanguage;",
        "}",
        "if (navigator.browserLanguage) {",
        "    devicePrint.browserLanguage = navigator.browserLanguage;",
        "}",
        "if (navigator.systemLanguage) {",
        "    devicePrint.systemLanguage = navigator.systemLanguage;",
        "}",
        "",
        "// Attempt to collect geo-location information and return this with the data collected so far.",
        "// Otherwise, if geo-location fails or takes longer than 30 seconds, auto-submit the data collected so far.",
        "autoSubmitDelay = 30000;",
        "output.value = JSON.stringify(devicePrint);",
        "collectGeolocationInfo(function(geolocationInfo) {",
        "    devicePrint.geolocation = geolocationInfo;",
        "    output.value = JSON.stringify(devicePrint);",
        "    submit();",
        "});",
      ],
    },
    "158e500b-8180-4641-ad48-23577fe9d976": {
      "_id": "158e500b-8180-4641-ad48-23577fe9d976",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_MfaOptIn",
      "script": [
        "/*",
        "This creates the following callbacks:",
        "- TextOutputCallback: Display the step title and description",
        "- ConfirmationCallback: Display a list of buttons for choices",
        "- HiddenValueCallback: Captures the "skip" option, if selected",
        "- ScriptTextOutputCallback: Creates a "Skip for now" link button and positions it below the buttons ",
        "*/",
        "",
        "var token = generateNumericToken('xxx');",
        "var loadingMessage = 'Loading...';",
        "var linkButton = "<button id='skip-link-".concat(token).concat("' class='btn btn-block btn-link' type=submit>Skip for now</button>");",
        "var message = "<h2 class=h2>Set up 2-step verification</h2><div style='margin-bottom:1em'>Protect your account by adding a second step after entering your password to verify it's you signing in.</div>";",
        "var choices = ['Set up'];",
        "var defaultChoice = 0;",
        "var skipValue = 'Skip';",
        "",
        "// This will run recursively in the browser until references can be obtained to key DOM elements, at which point.",
        "// it will customize the DOM.  This is to avoid race conditions with the UI rendering callbacks.",
        "var setupPageScript =",
        "  'var setupPage = function() {'.concat(",
        "  '  var skipInputElem = document.getElementById("skip-input-').concat(token).concat('");').concat(",
        "  '  var messageElem;').concat(",
        "  '  document.getElementsByClassName("callback-component").forEach(').concat(",
        "  '    function (e) {').concat(",
        "  '      var m = e.firstElementChild;').concat(",
        "  '      if (m.firstChild && m.firstChild.nodeName == "#text" && m.firstChild.nodeValue.trim() == "').concat(loadingMessage).concat('") {').concat(",
        "  '        messageElem = m;').concat(",
        "  '      }').concat(",
        "  '    }').concat(",
        "  '  );').concat(",
        "  '  if (!skipInputElem || !messageElem) {').concat(",
        "  '    return setTimeout(setupPage, 50);').concat(",
        "  '  }').concat(",
        "  '  var skipContainer = document.createElement("div");').concat(",
        "  '  skipContainer.style = "width:100%";').concat(",
        "  '  skipContainer.innerHTML = "').concat(linkButton).concat('";').concat(",
        "  '  skipInputElem.parentNode.append(skipContainer);').concat(",
        "  '  messageElem.align = "center";').concat(",
        "  '  messageElem.innerHTML = "').concat(message).concat('";').concat(",
        "  '  var bindSkipLink = function() {').concat(",
        "  '    document.getElementById("skip-link-').concat(token).concat('").onclick = function() {').concat(",
        "  '      skipInputElem.value = "').concat(skipValue).concat('";').concat(",
        "  '      document.getElementById("loginButton_0").click();').concat(",
        "  '      return false;').concat(",
        "  '    };').concat(",
        "  '  };').concat(",
        "  '  setTimeout(bindSkipLink, 100);').concat(",
        "  '};').concat(",
        "  'setupPage();');",
        "",
        "var fr = JavaImporter(",
        "  org.forgerock.openam.auth.node.api.Action,",
        "  javax.security.auth.callback.ConfirmationCallback,",
        "  javax.security.auth.callback.TextOutputCallback,",
        "  com.sun.identity.authentication.callbacks.HiddenValueCallback,",
        "  com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        ")",
        "",
        "with (fr) {",
        "  if (callbacks.isEmpty()) {",
        "    action = Action.send(",
        "      new TextOutputCallback(",
        "          TextOutputCallback.INFORMATION,",
        "          loadingMessage",
        "      ),",
        "      new ConfirmationCallback(",
        "          ConfirmationCallback.INFORMATION,",
        "          choices,",
        "          defaultChoice",
        "      ),",
        "      new HiddenValueCallback('skip-input-'.concat(token), 'false'),",
        "      new ScriptTextOutputCallback(setupPageScript)",
        "    ).build()",
        "  } else {",
        "    if (callbacks.get(2).getValue() == skipValue) {",
        "      action = Action.goTo(skipValue).build();",
        "    } else {",
        "      action = Action.goTo(choices[callbacks.get(1).getSelectedIndex()]).build();",
        "    }",
        "  }",
        "}",
        "",
        " /*",
        "  * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "  * ",
        "  * Example:",
        "  * 'xxxxx' produces '28535'",
        "  * 'xxx-xxx' produces '432-521'",
        "  */",
        "function generateNumericToken(format) {",
        "  return format.replace(/[x]/g, function(c) {",
        "    var r = Math.random()*10|0;",
        "    var v = r;",
        "    return v.toString(10);",
        "  });",
        "}",
      ],
    },
    "164fe425-01e7-4b0b-9f60-fb41f6bf362b": {
      "_id": "164fe425-01e7-4b0b-9f60-fb41f6bf362b",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "FRAAS-7955 Display sharedState and transientState.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "FRAAS-7955 Display States",
      "script": [
        "/* debug",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Display sharedState and transientState.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "var output = true;",
        "",
        "var anchor = "anchor-".concat(generateNumericToken('xxx'));",
        "var halign = "left";",
        "var message = "<h4>Current State Values</h4>".concat(",
        "    "<p><b>Shared State</b>:<br/>").concat(",
        "      sharedState.toString()).concat("</p>").concat(",
        "    "<p><b>Transient State</b>:<br/>").concat(",
        "      transientState.toString()).concat("</p>")",
        "var script = "Array.prototype.slice.call(\\n".concat(",
        "  "document.getElementsByClassName('callback-component')).forEach(\\n").concat(",
        "  "function (e) {\\n").concat(",
        "  "  var message = e.firstElementChild;\\n").concat(",
        "  "  if (message.firstChild && message.firstChild.nodeName == '#text' && message.firstChild.nodeValue.trim() == '").concat(anchor).concat("') {\\n").concat(",
        "  "    message.className = \\"\\";\\n").concat(",
        "  "    message.style = \\"text-align: left; inline-size: 430px; overflow-wrap: break-word;\\";\\n").concat(",
        "  "    message.align = \\"").concat(halign).concat("\\";\\n").concat(",
        "  "    message.innerHTML = '").concat(message).concat("';\\n").concat(",
        "  "  }\\n").concat(",
        "  "})")",
        "var fr = JavaImporter(",
        "    org.forgerock.openam.auth.node.api.Action,",
        "    javax.security.auth.callback.TextOutputCallback,",
        "    com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        ")",
        "if (message.length && callbacks.isEmpty()) {",
        "    action = fr.Action.send(",
        "        new fr.TextOutputCallback(",
        "            fr.TextOutputCallback.INFORMATION,",
        "            anchor",
        "        ),",
        "        new fr.ScriptTextOutputCallback(script)",
        "    ).build()",
        "}",
        "else {",
        "  action = fr.Action.goTo("true").build();",
        "}",
        "",
        " /*",
        "  * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "  * ",
        "  * Example:",
        "  * 'xxxxx' produces '28535'",
        "  * 'xxx-xxx' produces '432-521'",
        "  */",
        "function generateNumericToken(format) {",
        "    return format.replace(/[x]/g, function(c) {",
        "        var r = Math.random()*10|0;",
        "        var v = r;",
        "        return v.toString(10);",
        "    });",
        "}",
      ],
    },
    "169150da-0bd1-4866-8095-eae0bbc269e4": {
      "_id": "169150da-0bd1-4866-8095-eae0bbc269e4",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Collect all the configuration items required for the Message Node to function properly.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Collect Message Node Config",
      "script": [
        "/* Collect Message Node Config",
        " * ",
        " * Collect all the configuration items required for the Message Node to function properly.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    outcome = "true";",
        "      var config = {",
        "        "message": {"en": "I believe I can fly!"},",
        "        "messageYes": {"en": "Glorious!"},",
        "        "messageNo": {"en": "Inconceivable!"}",
        "    };",
        "      var script = "";",
        "    script += "Array.prototype.slice.call(";",
        "    script += "    document.getElementsByTagName('input')";",
        "    script += ").forEach(";",
        "    script += "    function (input,i) {";",
        "    script += "        console.log('input '+i);"",
        "    script += "        var config = JSON.parse('"+JSON.stringify(config)+"');";",
        "    script += "        var keys = Object.keys(config);";",
        "    script += "        if (input.type === 'text') {";",
        "    script += "            input.setAttribute('value', config[keys[i]].en);";",
        "    script += "            input.dispatchEvent(new KeyboardEvent( 'input' , {'key':'Enter'} ));";",
        "    script += "        }";",
        "    script += "    }";",
        "    script += ");";",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "          javax.security.auth.callback.NameCallback,",
        "        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        "    )",
        "    if (callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "            new fr.NameCallback("message", config.message.en),",
        "            new fr.NameCallback("messageYes", config.messageYes.en),",
        "            new fr.NameCallback("messageNo", config.messageNo.en),",
        "              new fr.ScriptTextOutputCallback(script)",
        "        ).build();",
        "    }",
        "    else {",
        "          config[callbacks.get(0).getPrompt()].en = callbacks.get(0).getName();",
        "          config[callbacks.get(1).getPrompt()].en = callbacks.get(1).getName();",
        "          config[callbacks.get(2).getPrompt()].en = callbacks.get(2).getName();",
        "          nodeState.putShared("nodeConfig", config);",
        "        action = fr.Action.goTo(outcome).build();",
        "    }",
        "}());",
      ],
    },
    "199405e4-050e-4f2a-87d1-d9125f74a8df": {
      "_id": "199405e4-050e-4f2a-87d1-d9125f74a8df",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Reset theme to what's preserved in shared state variable "theme-id" or to default theme.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Reset Theme",
      "script": [
        "/* Reset Theme",
        " * ",
        " * Reset theme to what's preserved in shared state variable "themeId" or to default theme.",
        " * ",
        " * This script needs to be parametrized!",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "      /* Begin Script Configuration */",
        "      var defaultTheme = "Expanse";",
        "      /* End Script Configuration */",
        "      ",
        "      outcome = "true";",
        "      ",
        "      var theme = defaultTheme;",
        "      if (sharedState.get("themeId") && ""+sharedState.get("themeId") !== "") {",
        "          theme = sharedState.get("themeId");",
        "    }",
        "",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "        org.forgerock.openam.authentication.callbacks.PollingWaitCallback",
        "    )",
        "    if (callbacks.isEmpty()) {",
        "        var stage = "themeId="+theme;",
        "        action = fr.Action.send(",
        "              new fr.PollingWaitCallback("100", "Please wait ...")",
        "        ).withStage(stage).build();",
        "    } else {",
        "          action = fr.Action.goTo(outcome).build();",
        "    }",
        "}());",
      ],
    },
    "1acc5535-13e2-4ed8-83e1-f4fefd86d243": {
      "_id": "1acc5535-13e2-4ed8-83e1-f4fefd86d243",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Readiness probe response",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Ready Response",
      "script": [
        "/* Ready Response",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Return READY in a TextOutputCallback indicating that the journey layer is operational.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "outcome = "true";",
        "var fr = JavaImporter(",
        "    org.forgerock.openam.auth.node.api.Action,",
        "    javax.security.auth.callback.TextOutputCallback",
        ")",
        "if (callbacks.isEmpty()) {",
        "    action = fr.Action.send(",
        "        new fr.TextOutputCallback(",
        "            fr.TextOutputCallback.INFORMATION,",
        "            "READY"",
        "        )",
        "    ).build()",
        "}",
        "else {",
        "  action = fr.Action.goTo(outcome).build();",
        "}",
      ],
    },
    "1b52a7e0-4019-40fa-958a-15a49870e901": {
      "_id": "1b52a7e0-4019-40fa-958a-15a49870e901",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "set the same shared state variable",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "shared",
      "script": [
        "(function () {",
        "  outcome = 'true';",
        "  var level = nodeState.get('level').asInteger();",
        "  sharedState.put('sharedValue', 'Level ' + level + ': This is a longer string value shared across all nested journeys. It contains an indicator in which level it was last set.');",
        "}());",
      ],
    },
    "1c0c73e8-2be1-41ce-b042-3c39694346b5": {
      "_id": "1c0c73e8-2be1-41ce-b042-3c39694346b5",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Verify unknown caller by account number",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Twilio IVR: Verify Unknown Caller",
      "script": [
        "/* Twilio IVR: Verify Unknown Caller",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * ",
        " * Depending on the amount of data collected through callbacks and how many of the callParams",
        " * you activate below, you will need to change your authentication session from JWT to CTS or",
        " * Memory.",
        " */",
        "logger.warning("Twilio IVR: Verify Unknown Caller: start");",
        "outcome = "true";",
        "",
        "/* Begin Configuration",
        " */",
        "",
        "// Build out the verification prompt",
        "var prompt = "To lookup your account, please enter or say your account number.";",
        "",
        "/* End Configuration",
        " */",
        "",
        "var fr = JavaImporter(",
        "      org.forgerock.openam.auth.node.api,",
        "      javax.security.auth.callback.TextInputCallback",
        ");",
        "  ",
        "with (fr) {",
        "      if (callbacks.isEmpty()) {",
        "        var input = new TextInputCallback(prompt);",
        "        action = Action.send(input).build();",
        "      } ",
        "      else {",
        "          var answer = new String(callbacks.get(0).getText()).replace(/[^0-9]/g, "");",
        "        logger.warning("Twilio IVR: Verify Unknown Caller: callbacks received: answer=".concat(answer));",
        "          setSharedObjectAttribute("frIndexedInteger5", answer);",
        "        logger.warning("Twilio IVR: Verify Unknown Caller: finish [outcome=".concat(outcome).concat("]"));",
        "        action = Action.goTo(outcome).build();",
        "      }",
        "}",
        "",
        "/*",
        " * Store attributes in shared state for use with the Create/Patch Object nodes.",
        " */",
        "function setSharedObjectAttribute(name, value) {",
        "       var storage = sharedState.get("objectAttributes");",
        "    if (storage && value) {",
        "          if (storage.put) {",
        "              storage.put(name, value);",
        "        }",
        "          else {",
        "              storage[name] = value;",
        "        }",
        "    }",
        "    else if (value) {",
        "        sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "    }",
        "}",
      ],
    },
    "1d475815-72cb-42eb-aafd-4026989d28a7": {
      "_id": "1d475815-72cb-42eb-aafd-4026989d28a7",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Default global script for Social Identity Provider Profile Transformation",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Social Identity Provider Profile Transformation Script",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/* Default Social Identity Provider Profile Transformation script to use as a template for new scripts */",
      ],
    },
    "1e8175a2-6114-415f-9b72-9fe15bdf3661": {
      "_id": "1e8175a2-6114-415f-9b72-9fe15bdf3661",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_IsFederationEnforcedForUser",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "var fr = new JavaImporter(",
        "  org.forgerock.openam.auth.nodes,",
        "  org.forgerock.guice.core",
        ");",
        "",
        "with (fr) {",
        "  var enforcement = 'none';",
        "",
        "  function isSuperAdmin() {",
        "    var uuid = sharedState.get('_id');",
        "    var realm = sharedState.get('realm');",
        "    var identityProvider = InjectorHolder.getInstance(IdentityProvider);",
        "    var identity = identityProvider.getIdentity(uuid, realm);",
        "    var groups = identity.getAttribute('fr-attr-group').toArray();",
        "    for (var i = 0; i < groups.length; i++) {",
        "      if (groups[i] == 'super-admins') {",
        "        return true;",
        "      }",
        "    }",
        "    return false;",
        "  }",
        "",
        "  try {",
        "    switch (enforcement) {",
        "      case 'none':",
        "        outcome = 'False';",
        "        break;",
        "      case 'all':",
        "        outcome = 'True';",
        "        break;",
        "      default:",
        "        outcome = isSuperAdmin() ? 'False' : 'True';",
        "        break;",
        "    }",
        "  } catch (e) {",
        "    logger.error('Failed to determine if federation is enforced for user: {}', e);",
        "    outcome = 'Error';",
        "  }",
        "}",
      ],
    },
    "1f389a3d-21cf-417c-a6d3-42ea620071f0": {
      "_id": "1f389a3d-21cf-417c-a6d3-42ea620071f0",
      "context": "OIDC_CLAIMS",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Internal OIDC Claims script",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "ForgeRock Internal: OIDC Claims Script",
      "script": [
        "/*",
        " * Copyright 2014-2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        " * This script computes claim values returned in ID tokens and/or at the UserInfo Endpoint.",
        " * The claim values are computed for:",
        " * the claims derived from the requested scopes,",
        " * the claims provided by the authorization server,",
        " * and the claims requested by the client via the claims parameter.",
        " *",
        " * In the CONFIGURATION AND CUSTOMIZATION section, you can",
        " * define the scope-to-claims mapping, and",
        " * assign to each claim a resolver function that will compute the claim value.",
        " *",
        " * Defined variables (class references are provided below):",
        " * scopes - Set<String> (6).",
        " *          Always present, the requested scopes.",
        " * claims - Map<String, Object> (5).",
        " *          Always present, default server provided claims.",
        " * claimObjects - List<Claim> (7, 2).",
        " *                Always present, the default server provided claims.",
        " * requestedClaims - Map<String, Set<String>> (5).",
        " *                   Always present, not empty if the request contains the claims parameter and the server has enabled",
        " *                   claims_parameter_supported. A map of the requested claims to possible values, otherwise empty;",
        " *                   requested claims with no requested values will have a key but no value in the map. A key with",
        " *                   a single value in its Set (6) indicates that this is the only value that should be returned.",
        " * requestedTypedClaims - List<Claim> (7, 2).",
        " *                        Always present, the requested claims.",
        " *                        Requested claims with no requested values will have a claim with no values.",
        " *                        A claim with a single value indicates this is the only value that should be returned.",
        " * claimsLocales - List<String> (7).",
        " *                 The values from the 'claims_locales' parameter.",
        " *                 See https://openid.net/specs/openid-connect-core-1_0.html#ClaimsLanguagesAndScripts for the OIDC specification details.",
        " * requestProperties - Unmodifiable Map (5).",
        " *                     Always present, contains a map of request properties:",
        " *                     requestUri - The request URI.",
        " *                     realm - The realm that the request relates to.",
        " *                     requestParams - A map of the request params and/or posted data.",
        " *                                     Each value is a list of one or more properties.",
        " *                                     Please note that these should be handled in accordance with OWASP best practices:",
        " *                                     https://owasp.org/www-community/vulnerabilities/Unsafe_use_of_Reflection.",
        " * clientProperties - Unmodifiable Map (5).",
        " *                    Present if the client specified in the request was identified, contains a map of client properties:",
        " *                    clientId - The client's URI for the request locale.",
        " *                    allowedGrantTypes - List of the allowed grant types (org.forgerock.oauth2.core.GrantType) for the client.",
        " *                    allowedResponseTypes - List of the allowed response types for the client.",
        " *                    allowedScopes - List of the allowed scopes for the client.",
        " *                    customProperties - A map of the custom properties of the client.",
        " *                                       Lists or maps will be included as sub-maps; for example:",
        " *                                       customMap[Key1]=Value1 will be returned as customMap -> Key1 -> Value1.",
        " *                                       To add custom properties to a client, update the Custom Properties field",
        " *                                       in AM Console > Realm Name > Applications > OAuth 2.0 > Clients > Client ID > Advanced.",
        " * identity - AMIdentity (3).",
        " *            Always present, the identity of the resource owner.",
        " * session - SSOToken (4).",
        " *           Present if the request contains the session cookie, the user's session object.",
        " * scriptName - String (primitive).",
        " *              Always present, the display name of the script.",
        " * logger - Always present, the "OAuth2Provider" debug logger instance:",
        " *          https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.",
        " *          Corresponding files will be prefixed with: scripts.OIDC_CLAIMS.",
        " * httpClient - HTTP Client (8).",
        " *              Always present, the HTTP Client instance:",
        " *              https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-http-client.html#scripting-api-global-http-client.",
        " *              In order to use the client, you may need to add",
        " *              org.forgerock.http.Client,",
        " *              org.forgerock.http.protocol.*,",
        " *              and org.forgerock.util.promise.PromiseImpl",
        " *              to the allowed Java classes in the scripting engine configuration, as described in:",
        " *              https://backstage.forgerock.com/docs/am/7/scripting-guide/script-engine-security.html",
        " *",
        " * Return - a new UserInfoClaims(Map<String, Object> values, Map<String, List<String>> compositeScopes) (1) object.",
        " *          The result of the last statement in the script is returned to the server.",
        " *          Currently, the Immediately Invoked Function Expression (also known as Self-Executing Anonymous Function)",
        " *          is the last (and only) statement in this script, and its return value will become the script result.",
        " *          Do not use "return variable" statement outside of a function definition.",
        " *          See RESULTS section for additional details.",
        " *",
        " * Class reference:",
        " * (1) UserInfoClaims - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html.",
        " * (2) Claim - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html).",
        " *         An instance of org.forgerock.openidconnect.Claim has methods to access",
        " *         the claim name, requested values, locale, and whether the claim is essential.",
        " * (3) AMIdentity - https://backstage.forgerock.com/docs/am/7/apidocs/com/sun/identity/idm/AMIdentity.html.",
        " * (4) SSOToken - https://backstage.forgerock.com/docs/am/7/apidocs/com/iplanet/sso/SSOToken.html.",
        " * (5) Map - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashMap.html,",
        " *           or https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/LinkedHashMap.html.",
        " * (6) Set - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashSet.html.",
        " * (7) List - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/ArrayList.html.",
        " * (8) Client - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/http/Client.html.",
        "*/",
        "",
        "(function () {",
        "    // SETUP",
        "",
        "    /**",
        "     * Claim processing utilities.",
        "     * An object that contains reusable functions for processing claims.",
        "     * @see CLAIM PROCESSING UTILITIES section for details.",
        "     */",
        "    var utils = getUtils();",
        "",
        "    // CONFIGURATION AND CUSTOMIZATION",
        "",
        "    /**",
        "     * OAuth 2.0 scope values (scopes) can be used by the Client to request OIDC claims.",
        "     *",
        "     * Call this configuration method, and pass in as the first argument",
        "     * an object that maps a scope value to an array of claim names",
        "     * to specify which claims need to be processed and returned for the requested scopes.",
        "     * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#ScopeClaims}",
        "     * for the scope values that could be used to request claims as defined in the OIDC specification.",
        "     *",
        "     * Below, find a default configuration that is expected to work in the current environment.",
        "     *",
        "     * CUSTOMIZATION",
        "     * You can choose the claim names returned for a scope.",
        "     */",
        "    utils.setScopeClaimsMap({",
        "        profile: [",
        "            'name',",
        "            'family_name',",
        "            'given_name',",
        "            'zoneinfo',",
        "            'locale'",
        "        ],",
        "        email: ['email'],",
        "        address: ['address'],",
        "        phone: ['phone_number']",
        "    });",
        "",
        "    /**",
        "     * In this script, each claim",
        "     * derived from the requested scopes,",
        "     * provided by the authorization server, and",
        "     * requested by the client via the claims parameter",
        "     * will be processed by a function associated with the claim name.",
        "     *",
        "     * Call this configuration method, and pass in as the first argument",
        "     * an object that maps a claim name to a resolver function,",
        "     * which will be automatically executed for each claim processed by the script.",
        "     *",
        "     * The claim resolver function will receive the requested claim information",
        "     * in an instance of org.forgerock.openidconnect.Claim as the first argument.",
        "     * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html}",
        "     * for details on the Claim class.",
        "     *",
        "     * If the claim resolver function returns a value,",
        "     * other than undefined or null,",
        "     * the claim will be included in the script's results.",
        "     *",
        "     * The Claim instance provides methods to check",
        "     * what the name of the claim is,",
        "     * which values the claim request contains,",
        "     * whether the claim is essential, and",
        "     * which locale the claim is associated with.",
        "     * The resolver function can consider this information when computing and returning the claim value.",
        "     *",
        "     * Below, find a default configuration that is expected to work in the current environment.",
        "     * A reusable function, utils.getUserProfileClaimResolver(String attribute-name),",
        "     * is called to return a claim resolver function based on a user profile attribute.",
        "     * @see CLAIM RESOLVERS section for the implementation details and examples.",
        "     * For the address claim, an example of a claim resolver that uses another claim resolver is provided.",
        "     *",
        "     * CUSTOMIZATION",
        "     * You can reuse the predefined utils methods with your custom arguments.",
        "     * You can also specify a custom resolver function for a claim name,",
        "     * that will compute and return the claim value—as shown in the commented out example below.",
        "     */",
        "    utils.setClaimResolvers({",
        "        /*",
        "        // An example of a simple claim resolver function that is defined for a claim",
        "        // directly in the configuration object:",
        "        custom-claim-name: function (requestedClaim) {",
        "            // In this case, initially, the claim value comes straight from a user profile attribute value:",
        "            var claimValue = identity.getAttribute('custom-attribute-name').toArray()[0]",
        "",
        "            // Optionally, provide additional logic for processing (filtering, formatting, etc.) the claim value.",
        "            // You can use:",
        "            // requestedClaim.getName()",
        "            // requestedClaim.getValues()",
        "            // requestedClaim.getLocale()",
        "            // requestedClaim.isEssential()",
        "",
        "            return claimValue",
        "        },",
        "        */",
        "        /**",
        "         * The use of utils.getUserProfileClaimResolver shows how",
        "         * an argument passed to a function that returns a claim resolver",
        "         * becomes available to the resolver function (via its lexical context).",
        "         */",
        "        name: utils.getUserProfileClaimResolver('cn'),",
        "        family_name: utils.getUserProfileClaimResolver('sn'),",
        "        given_name: utils.getUserProfileClaimResolver('givenname'),",
        "        zoneinfo: utils.getUserProfileClaimResolver('preferredtimezone'),",
        "        locale: utils.getUserProfileClaimResolver('preferredlocale'),",
        "        email: utils.getUserProfileClaimResolver('mail'),",
        "        address: utils.getAddressClaimResolver(",
        "            /**",
        "             * The passed in user profile claim resolver function",
        "             * can be used by the address claim resolver function",
        "             * to obtain the claim value to be formatted as per the OIDC specification:",
        "             * @see https://openid.net/specs/openid-connect-core-1_0.html#AddressClaim.",
        "             */",
        "            utils.getUserProfileClaimResolver('postaladdress')",
        "        ),",
        "        phone_number: utils.getUserProfileClaimResolver('telephonenumber')",
        "    });",
        "",
        "    // CLAIM PROCESSING UTILITIES",
        "",
        "    /**",
        "     * @returns {object} An object that contains reusable claim processing utilities.",
        "     * @see PUBLIC METHODS section and the return statement for the list of exported functions.",
        "     */",
        "    function getUtils () {",
        "        // IMPORT JAVA",
        "",
        "        /**",
        "         * Provides Java scripting functionality.",
        "         * @see {@link https://developer.mozilla.org/en-US/docs/Mozilla/Projects/Rhino/Scripting_Java#javaimporter_constructor}.",
        "         */",
        "        var frJava = JavaImporter(",
        "            org.forgerock.oauth2.core.exceptions.InvalidRequestException,",
        "            org.forgerock.oauth2.core.UserInfoClaims,",
        "            org.forgerock.openidconnect.Claim,",
        "",
        "            java.util.LinkedHashMap,",
        "            java.util.ArrayList",
        "        );",
        "",
        "        // SET UP CONFIGURATION",
        "",
        "        /**",
        "         * Placeholder for a configuration option that contains",
        "         * an object that maps the supported scope values (scopes)",
        "         * and the corresponding claim names for each scope value.",
        "         */",
        "        var scopeClaimsMap;",
        "",
        "        /**",
        "         * Placeholder for a configuration option that contains",
        "         * an object that maps the supported claim names",
        "         * and the resolver functions returning the claim value.",
        "         */",
        "        var claimResolvers;",
        "",
        "        /**",
        "         * A (public) method that accepts an object that maps the supported scopes and the corresponding claim names,",
        "         * and assigns it to a (private) variable that serves as a configuration option.",
        "         * @param {object} params - An object that maps each supported scope value to an array of claim names,",
        "         * in order to specify which claims need to be processed for the requested scopes.",
        "         * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#ScopeClaims} for details.",
        "         * @param {string[]} [params.profile] - An array of claim names to be returned if the profile scope is requested.",
        "         * @param {string[]} [params.email] - An array of claim names to be returned if the email scope is requested.",
        "         * @param {string[]} [params.address] - An array of claim names to be returned if the address scope is requested.",
        "         * @param {string[]} [params.phone] - An array of claim names to be returned if the phone scope is requested.",
        "         * @returns {undefined}",
        "         */",
        "        function setScopeClaimsMap(params) {",
        "            scopeClaimsMap = params;",
        "        }",
        "",
        "        /**",
        "         * A (public) method that accepts an object that maps the supported claim names",
        "         * and the resolver functions returning the claim value,",
        "         * and assigns it to a (private) variable that serves as a configuration option.",
        "         * @param {object} params - An object that maps",
        "         * each supported claim name to a function that computes and returns the claim value.",
        "         */",
        "        function setClaimResolvers(params) {",
        "            claimResolvers = params;",
        "        }",
        "",
        "        // CLAIM RESOLVERS",
        "",
        "        /**",
        "         * Claim resolvers are functions that return a claim value.",
        "         * @param {*}",
        "         * @returns {*}",
        "         */",
        "",
        "        /**",
        "         * Defines a claim resolver based on a user profile attribute.",
        "         * @param {string} attributeName - Name of the user profile attribute.",
        "         * @returns {function} A function that will determine the claim value",
        "         * based on the user profile attribute and the (requested) claim properties.",
        "         */",
        "        function getUserProfileClaimResolver (attributeName) {",
        "            /**",
        "             * Resolves a claim with a user profile attribute value.",
        "             * Returns undefined if the identity attribute is not populated,",
        "             * OR if the claim has requested values that do not contain the identity attribute value.",
        "             * ATTENTION: the aforementioned comparison is case-sensitive.",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {string|HashSet|undefined}",
        "             */",
        "            function resolveClaim(claim) {",
        "                var userProfileValue;",
        "",
        "                if (identity) {",
        "                    userProfileValue = getClaimValueFromSet(claim, identity.getAttribute(attributeName));",
        "",
        "                    if (userProfileValue && !userProfileValue.isEmpty()) {",
        "                        if (!claim.getValues() || claim.getValues().isEmpty() || claim.getValues().contains(userProfileValue)) {",
        "                            return userProfileValue;",
        "                        }",
        "                    }",
        "                }",
        "            }",
        "",
        "            return resolveClaim;",
        "        }",
        "",
        "        /**",
        "         * Returns an address claim resolver based on a claim value obtained with another claim resolver.",
        "         * @param {function} resolveClaim - A function that returns a claim value.",
        "         * @returns {function} A function that will accept a claim as an argument,",
        "         * run the claim resolver function for the claim and obtain the claim value,",
        "         * and apply additional formatting to the value before returning it.",
        "         */",
        "        function getAddressClaimResolver (resolveClaim) {",
        "            /**",
        "             * Creates an address claim object from a value returned by a claim resolver,",
        "             * and returns the address claim object as the claim value.",
        "             * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#AddressClaim}.",
        "             * The claim value is obtained with a claim resolving function available from the closure.",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {java.util.LinkedHashMap|undefined} The address claim object created from a claim value.",
        "             */",
        "            function resolveAddressClaim(claim) {",
        "                var claimValue = resolveClaim(claim);",
        "                var addressObject;",
        "",
        "                if (isClaimValueValid(claimValue)) {",
        "                    addressObject = new frJava.LinkedHashMap();",
        "",
        "                    addressObject.put('formatted', claimValue);",
        "",
        "                    return addressObject;",
        "                }",
        "            }",
        "",
        "            return resolveAddressClaim;",
        "        }",
        "",
        "        /**",
        "         * Returns an essential claim resolver based on a claim value obtained with another claim resolver.",
        "         * @param {function} resolveClaim - A function that returns a claim value.",
        "         * @returns {function} A function that will accept a claim as an argument,",
        "         * run the claim resolver function for the claim and obtain the claim value,",
        "         * and apply additional logic for essential claims.",
        "         */",
        "        function getEssentialClaimResolver (resolveClaim) {",
        "            /**",
        "             * Returns a claim value or throws an error.",
        "             * The claim value is obtained with a claim resolving function available from the closure.",
        "             * Throws an exception if the claim is essential and no value is returned for the claim.",
        "             *",
        "             * Use of this resolver is optional.",
        "             * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#IndividualClaimsRequests} stating:",
        "             * "Note that even if the Claims are not available because the End-User did not authorize their release or they are not present,",
        "             * the Authorization Server MUST NOT generate an error when Claims are not returned, whether they are Essential or Voluntary,",
        "             * unless otherwise specified in the description of the specific claim."",
        "             *",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {*}",
        "             * @throws {org.forgerock.oauth2.core.exceptions.InvalidRequestException}",
        "             */",
        "            function resolveEssentialClaim(claim) {",
        "                var claimValue = resolveClaim(claim);",
        "",
        "                if (claim.isEssential() && !isClaimValueValid(claimValue)) {",
        "                    throw new frJava.InvalidRequestException('Could not provide value for essential claim: ' + claim.getName());",
        "                }",
        "",
        "                return claimValue;",
        "            }",
        "",
        "            return resolveEssentialClaim;",
        "        }",
        "",
        "        /**",
        "         * Provides default resolution for a claim.",
        "         * Use it if a claim-specific resolver is not defined in the configuration.",
        "         * @param {org.forgerock.openidconnect.Claim} claim",
        "         * An object that provides methods to obtain information/requirements associated with a claim.",
        "         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "         * @returns {*} A single value associated with this claim.",
        "         */",
        "        function resolveAnyClaim (claim) {",
        "            if (claim.getValues().size() === 1) {",
        "                return claim.getValues().toArray()[0];",
        "            }",
        "        }",
        "",
        "        // UTILITIES",
        "",
        "        /**",
        "         * Returns claim value from a set.",
        "         * If the set contains a single value, returns the value.",
        "         * If the set contains multiple values, returns the set.",
        "         * Otherwise, returns undefined.",
        "         *",
        "         * @param {org.forgerock.openidconnect.Claim} claim",
        "         * An object that provides methods to obtain information/requirements associated with a claim.",
        "         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "         * @param {java.util.HashSet} set The set—for example, a user profile attribute value.",
        "         * @returns {string|java.util.HashSet|undefined}",
        "         */",
        "        function getClaimValueFromSet (claim, set) {",
        "            if (set && set.size()) {",
        "                if (set.size() === 1) {",
        "                    return set.toArray()[0];",
        "                } else {",
        "                    return set;",
        "                }",
        "            } else if (logger.warningEnabled()) {",
        "                logger.warning('OIDC Claims script. Got an empty set for claim: ' + claim.getName());",
        "            }",
        "        }",
        "",
        "        function isClaimValueValid (claimValue) {",
        "            if (typeof claimValue === 'undefined' || claimValue === null) {",
        "                return false;",
        "            }",
        "",
        "            return true;",
        "        }",
        "",
        "        // CLAIM PROCESSING",
        "",
        "        /**",
        "         * Constructs and returns an object populated with the computed claim values",
        "         * and the requested scopes mapped to the claim names.",
        "         * @returns {org.forgerock.oauth2.core.UserInfoClaims} The object to be returned to the authorization server.",
        "         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html}.",
        "         * @see RESULTS section for the use of this function.",
        "         */",
        "        function getUserInfoClaims () {",
        "            return new frJava.UserInfoClaims(getComputedClaims(), getCompositeScopes());",
        "        }",
        "",
        "        /**",
        "         * Creates a map of (requested) claim names populated with the computed claim values.",
        "         * @returns {java.util.LinkedHashMap}",
        "         * A map of the requested claim names and the corresponding claim values.",
        "         */",
        "        function getComputedClaims () {",
        "            /**",
        "             * Creates a complete list of claim objects from:",
        "             * the claims derived from the scopes,",
        "             * the claims provided by the authorization server,",
        "             * and the claims requested by the client.",
        "             * @returns {java.util.ArrayList}",
        "             * Returns a complete list of org.forgerock.openidconnect.Claim objects available to the script.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for the claim object details.",
        "             */",
        "            function getClaims() {",
        "                /**",
        "                 * Returns a list of claim objects for the requested scopes.",
        "                 * Uses the scopeClaimsMap configuration option to derive the claim names;",
        "                 * no other properties of a claim derived from a scope are populated.",
        "                 * @returns {java.util.ArrayList}",
        "                 * A list of org.forgerock.openidconnect.Claim objects derived from the requested scopes.",
        "                 * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for the claim object details.",
        "                 */",
        "                function convertScopeToClaims() {",
        "                    var claims = new frJava.ArrayList();",
        "",
        "                    scopes.toArray().forEach(function (scope) {",
        "                        if (String(scope) !== 'openid' && scopeClaimsMap[scope]) {",
        "                            scopeClaimsMap[scope].forEach(function (claimName) {",
        "                                claims.add(new frJava.Claim(claimName));",
        "                            });",
        "                        }",
        "                    });",
        "",
        "                    return claims;",
        "                }",
        "",
        "                var claims = new frJava.ArrayList();",
        "",
        "                claims.addAll(convertScopeToClaims());",
        "                claims.addAll(claimObjects);",
        "                claims.addAll(requestedTypedClaims);",
        "",
        "                return claims;",
        "            }",
        "",
        "            /**",
        "             * Computes and returns a claim value.",
        "             * To obtain the claim value, uses the resolver function specified for the claim in the claimResolvers configuration object.",
        "             * @see claimResolvers",
        "             * If no resolver function is found, uses the default claim resolver function.",
        "             *",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {*} Claim value.",
        "             * @throws {org.forgerock.oauth2.core.exceptions.InvalidRequestException}",
        "             * Rethrows this exception if a claim resolver throws it.",
        "             * You can throw org.forgerock.oauth2.core.exceptions.InvalidRequestException from your custom claim resolver",
        "             * if you want to terminate the claim processing.",
        "             */",
        "            function computeClaim(claim) {",
        "                var resolveClaim;",
        "                var message;",
        "",
        "                try {",
        "                    resolveClaim = claimResolvers[claim.getName()] || resolveAnyClaim;",
        "",
        "                    return resolveClaim(claim);",
        "                } catch (e) {",
        "                    message = 'OIDC Claims script exception. Unable to resolve OIDC Claim. ' + e;",
        "",
        "                    if (String(e).indexOf('org.forgerock.oauth2.core.exceptions.InvalidRequestException') !== -1) {",
        "                        throw e;",
        "                    }",
        "",
        "                    if (logger.warningEnabled()) {",
        "                        logger.warning(message);",
        "                    }",
        "                }",
        "            }",
        "",
        "            var computedClaims = new frJava.LinkedHashMap();",
        "",
        "            getClaims().toArray().forEach(function (claim) {",
        "                var claimValue = computeClaim(claim);",
        "",
        "                if (isClaimValueValid(claimValue)) {",
        "                    computedClaims.put(claim.getName(), claimValue);",
        "                } else {",
        "                    /**",
        "                     * If a claim has been processed, but appears in the list again,",
        "                     * and its value cannot be computed under the new conditions,",
        "                     * the claim is removed from the final result.",
        "                     *",
        "                     * For example, a claim could be mapped to a scope and found in the user profile,",
        "                     * but also requested by the client with required values that don't match the computed one.",
        "                     * @see {link https://openid.net/specs/openid-connect-core-1_0.html#IndividualClaimsRequests}.",
        "                     * for the relevant OIDC specification details.",
        "                     */",
        "                    computedClaims.remove(claim.getName());",
        "                }",
        "            });",
        "",
        "            return computedClaims;",
        "        }",
        "",
        "        /**",
        "         * Creates a map of requested scopes and the corresponding claim names.",
        "         * @returns {java.util.LinkedHashMap}",
        "         */",
        "        function getCompositeScopes () {",
        "            var compositeScopes = new frJava.LinkedHashMap();",
        "",
        "            scopes.toArray().forEach(function (scope) {",
        "                var scopeClaims = new frJava.ArrayList();",
        "",
        "                if (scopeClaimsMap[scope]) {",
        "                    scopeClaimsMap[scope].forEach(function (claimName) {",
        "                        scopeClaims.add(claimName);",
        "                    });",
        "                }",
        "",
        "                if (scopeClaims.size()) {",
        "                    compositeScopes.put(scope, scopeClaims);",
        "                }",
        "            });",
        "",
        "            return compositeScopes;",
        "        }",
        "",
        "        // PUBLIC METHODS",
        "",
        "        return {",
        "            setScopeClaimsMap: setScopeClaimsMap,",
        "            setClaimResolvers: setClaimResolvers,",
        "            getUserProfileClaimResolver: getUserProfileClaimResolver,",
        "            getAddressClaimResolver: getAddressClaimResolver,",
        "            getEssentialClaimResolver: getEssentialClaimResolver,",
        "            getUserInfoClaims: getUserInfoClaims",
        "        };",
        "    }",
        "",
        "    // RESULTS",
        "",
        "    /**",
        "     * This script returns an instance of the org.forgerock.oauth2.core.UserInfoClaims class",
        "     * populated with the computed claim values and",
        "     * the requested scopes mapped to the claim names.",
        "     * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html}.",
        "     *",
        "     * Assigning it to a variable gives you an opportunity",
        "     * to log the content of the returned value during development.",
        "     */",
        "    var userInfoClaims = utils.getUserInfoClaims();",
        "",
        "    /*",
        "    logger.error(scriptName + ' results:')",
        "    logger.error('Values: ' + userInfoClaims.getValues())",
        "    logger.error('Scopes: ' + userInfoClaims.getCompositeScopes())",
        "    */",
        "",
        "    return userInfoClaims;",
        "}());",
        "",
      ],
    },
    "22ab12ac-d1d9-414b-ab51-cfae30de8c0a": {
      "_id": "22ab12ac-d1d9-414b-ab51-cfae30de8c0a",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Create a configuration object for the Email Template Node.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Configure Email Template Node",
      "script": [
        "/* Configure Email Template Node",
        " * ",
        " * Create a configuration object for the Email Template Node.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * - error",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "  try {",
        "  outcome = 'true';",
        "  var config = {",
        "    emailAttribute: 'mail',",
        "    emailTemplateName: 'welcome',",
        "    identityAttribute: 'userName'",
        "  };",
        "  nodeState.putShared('nodeConfig', config);",
        "  } catch (error) {",
        "      outcome = 'error';",
        "    nodeState.putShared('error', error.message);",
        "  }",
        "}());",
      ],
    },
    "23143919-6b78-40c3-b25e-beca19b229e0": {
      "_id": "23143919-6b78-40c3-b25e-beca19b229e0",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Normalizes raw profile data from GitHub",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "GitHub Profile Normalization (VS)",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "logger.warning("GitHub rawProfile: "+rawProfile)",
        "",
        "return json(object(",
        "        field("id", rawProfile.id),",
        "        field("displayName", rawProfile.name),",
        "        field("givenName", rawProfile.first_name),",
        "        field("familyName", rawProfile.last_name),",
        "        field("photoUrl", rawProfile.picture.data.url),",
        "        field("email", rawProfile.email),",
        "        field("username", rawProfile.email)))",
      ],
    },
    "27f1b5a3-9446-4e5c-b965-f195a99fa666": {
      "_id": "27f1b5a3-9446-4e5c-b965-f195a99fa666",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_PasswordFixEnd",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        "This restores sharedState.objectAttributes temporarily overwritten to fix an issue with password policy.",
        "*/",
        "",
        "//var password = '';",
        "//var objAttrs = sharedState.get('objectAttributes');",
        "//if (objAttrs && objAttrs.containsKey('password')) {",
        "//  password = objAttrs.get('password');",
        "//}",
        "",
        "// Restore original object attributes",
        "var origObjAttrs = sharedState.get('originalObjectAttributes');",
        "if (origObjAttrs) {",
        "//  if (password) {",
        "//    origObjAttrs.put('password', password);",
        "//  }",
        "  sharedState.put('objectAttributes', origObjAttrs);",
        "}",
        "",
        "outcome = 'True';",
        "",
      ],
    },
    "2997bd4d-14be-4dc6-8701-27f08d10b8b7": {
      "_id": "2997bd4d-14be-4dc6-8701-27f08d10b8b7",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Profile Normalization Script for idddataweb",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "iddataweb Profile Normalization",
      "script": [
        "/*/*",
        " * Copyright 2022 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS. Not for Production use. ",
        " * Modified by Stephen Payne",
        " */",
        "/* Social Identity Provider Profile Transformation script for ID DataWeb */",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "logger.error("iddataweb_Social Identity Provider Profile Transformation script: Start");",
        "userName = sharedState.get("objectAttributes").get("mail");",
        "logger.error("iddataweb_Social Identity Provider Profile Transformation script: userName" + userName );",
        "username = userName;",
        "sharedState.put("userName", userName);",
        "",
        "return json(object(",
        "        field("id", rawProfile.sub),",
        "        field("displayName", rawProfile.acquiredAttributes_AcquiredFullName_fname.asString() + " " + rawProfile.acquiredAttributes_AcquiredFullName_lname.asString().toLowerCase().capitalize() ),",
        "        field("givenName", rawProfile.acquiredAttributes_AcquiredFullName_fname.asString().toLowerCase().capitalize() ),",
        "        field("familyName", rawProfile.acquiredAttributes_AcquiredFullName_lname.asString().toLowerCase().capitalize() ),",
        "        field("postalAddress", rawProfile.acquiredAttributes_AcquiredAddress_address),",
        "        field("addressLocality", rawProfile.acquiredAttributes_AcquiredAddress_locality),",
        "        field("addressRegion", rawProfile.acquiredAttributes_AcquiredAddress_administrative_area_level_1),",
        "        field("postalCode", rawProfile.acquiredAttributes_AcquiredAddress_postal_code),",
        "        field("country", rawProfile.acquiredAttributes_AcquiredAddress_country),",
        "        field("driversLicense", rawProfile.acquiredAttributes_AcquiredDriversLicenseNumber_acquiredDriversLicenseNumber),",
        "        field("driversLicenseIssuer", rawProfile.acquiredAttributes_DriversLicenseIssuerCode_DriversLicenseIssuerCode),",
        "          field("DOB", rawProfile.acquiredAttributes_AcquiredDOB_month.asString() + "/" + rawProfile.acquiredAttributes_AcquiredDOB_day.asString() + "/" + rawProfile.acquiredAttributes_AcquiredDOB_year.asString() ),",
        "",
        "        field("IDWScore", rawProfile.acquiredAttributes_IDWScore),",
        "        field("policyDecision", rawProfile.policyDecision_conclusion),",
        "        field("phone", rawProfile.userAttributes_InternationalTelephone_dialCode.asString() + rawProfile.userAttributes_InternationalTelephone_telephone.asString()),",
        "        field("username", userName )",
        "       //field("username", rawProfile.acquiredAttributes_AcquiredFullName_fname.asString() + "." + rawProfile.acquiredAttributes_AcquiredFullName_lname.asString() )",
        "",
        "   )",
        ")",
        "",
      ],
    },
    "2a076e9e-75a9-46b5-b971-10ffafbdf652": {
      "_id": "2a076e9e-75a9-46b5-b971-10ffafbdf652",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Return true if a goto param has been specified, false otherwise.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Goto Specified Decision",
      "script": [
        "/* Goto Specified Decision",
        " * ",
        " * Return true if a goto param has been specified, false otherwise.",
        " * ",
        " * This script does not require configuration. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * - false",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    logger.message("Goto Specified Decision: start");",
        "      outcome = "false";",
        "      var referer = parseUrl(requestHeaders.get("referer").get(0));",
        "      if (referer.searchParam.goto) {",
        "          outcome = "true";",
        "    }",
        "    logger.message("Goto Specified Decision: end [outcome={}]", outcome);",
        "",
        "    /*",
        "     * Parse a URL into its components and make them easily accessible by name",
        "     *",
        "     * Use in a Scripte Decision Node Script as follows:",
        "     * var referer = parseUrl(requestHeaders.get("referer").get(0));",
        "     * var origin = referer.origin;",
        "     * ",
        "     * e.g.: https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/",
        "     * {",
        "     *     hash: '#/',",
        "     *     host: 'openam-volker-dev.forgeblocks.com',",
        "     *     hostname: 'openam-volker-dev.forgeblocks.com',",
        "     *     href: 'https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/',",
        "     *     origin: 'https://openam-volker-dev.forgeblocks.com',",
        "     *     pathname: '/am/XUI/',",
        "     *     port: '',",
        "     *     protocol: 'https',",
        "     *     search: '?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim',",
        "     *     username: '',",
        "     *     password: '',",
        "     *     searchParam: {",
        "     *         realm: '/bravo',",
        "     *         authIndexType: 'service',",
        "     *         authIndexValue: 'InitiateOwnerClaim'",
        "     *     }",
        "     * }",
        "     */",
        "    function parseUrl(href) {",
        "        var m = href.match(/^(([^:\\/?#]+):?(?:\\/\\/((?:([^\\/?#:]*):([^\\/?#:]*)@)?([^\\/?#:]*)(?::([^\\/?#:]*))?)))?([^?#]*)(\\?[^#]*)?(#.*)?$/),",
        "        r = {",
        "            hash: m[10] || "",                      // #/",
        "            host: m[3] || "",                       // openam-volker-dev.forgeblocks.com",
        "            hostname: m[6] || "",                   // openam-volker-dev.forgeblocks.com",
        "            href: m[0] || "",                       // https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/",
        "            origin: m[1] || "",                     // https://openam-volker-dev.forgeblocks.com",
        "            pathname: m[8] || (m[1] ? "/" : ""),    // /am/XUI/",
        "            port: m[7] || "",                       // ",
        "            protocol: m[2] || "",                   // https",
        "            search: m[9] || "",                     // ?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim",
        "            username: m[4] || "",                   // ",
        "            password: m[5] || "",                   // ",
        "            searchParam: {}                         // { realm: '/bravo',",
        "                                                    //   authIndexType: 'service',",
        "                                                    //   authIndexValue: 'InitiateOwnerClaim' }",
        "        };",
        "        if (r.protocol.length == 2) {",
        "            r.protocol = "file:///" + r.protocol.toUpperCase();",
        "            r.origin = r.protocol + "//" + r.host;",
        "        }",
        "        if (r.search.length > 2) {",
        "            var query = (r.search.indexOf('?') === 0) ? r.search.substr(1) : r.search;",
        "            var vars = query.split('&');",
        "            for (var i = 0; i < vars.length; i++) {",
        "            var pair = vars[i].split('=');",
        "            r.searchParam[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1]);",
        "            }",
        "        }",
        "        r.href = r.origin + r.pathname + r.search + r.hash;",
        "        return r;",
        "    };",
        "}());",
      ],
    },
    "2aaa8076-5d0b-4433-9660-fec1ba51b608": {
      "_id": "2aaa8076-5d0b-4433-9660-fec1ba51b608",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "temp",
      "script": [
        "/*",
        "  - Data made available by nodes that have already executed are available in the sharedState variable.",
        "  - The script should set outcome to either "true" or "false".",
        " */",
        "outcome = "false";",
        "if(sharedState.get("userName"))",
        "{",
        "var username = sharedState.get("userName")",
        "var id = sharedState.get("_id")",
        "var persona = existingSession.get('persona')",
        "",
        "sharedState.put("debug",username);",
        "sharedState.put("debug_id",id);",
        "sharedState.put("persona",persona);",
        "",
        "if(username!=='')",
        "{",
        "  outcome = "true";",
        "}}",
        "",
      ],
    },
    "2ada53cd-5d37-4592-9c7f-5711271229c2": {
      "_id": "2ada53cd-5d37-4592-9c7f-5711271229c2",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Has Profile Changed",
      "script": [
        "logger.error("Has Profile Changed: start");",
        "outcome = "unchanged";",
        "if (getObjectAttribute("old_givenName") ||",
        "    getObjectAttribute("old_sn") ||",
        "    getObjectAttribute("frUnindexedString5") ||",
        "    getObjectAttribute("old_telephoneNumber")) {",
        "  outcome = "changed";",
        "}",
        "logger.error("Has Profile Changed: end [outcome=".concat(outcome).concat("]"));",
        "",
        "/*",
        " * Get objectAttribute value",
        " */",
        "function getObjectAttribute(name) {",
        "    if (sharedState.get("objectAttributes") && sharedState.get("objectAttributes").get(name)) {",
        "        return sharedState.get("objectAttributes").get(name).toString();",
        "    }",
        "    else {",
        "        return null;",
        "    }",
        "}",
      ],
    },
    "2eb48a0c-24e0-4dac-acaf-02085c142ec5": {
      "_id": "2eb48a0c-24e0-4dac-acaf-02085c142ec5",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Integration to Okta Authentication API okta_url/api/v1/authn",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Okta API AuthN",
      "script": [
        "/* Okta Passthru Authentication",
        " *",
        " * Authors: chico.demettroff@forgerock.com, volker.scheuber@forgerock.com",
        " * ",
        " * Okta pass through authentication using Okta Authentication API.",
        " * ",
        " * This script needs to be parametrized. It will not work properly as is. ",
        " * It requires the Platform Username and Platform Password collector nodes",
        " * before it can operate.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - Success",
        " * - Failure",
        " * - Timeout",
        " * - Error",
        " */",
        "logger.message("Okta Passthru Authentication: start");",
        "",
        "if (sharedState.get("username") && transientState.get("password")) {",
        "      /*",
        "     * BEGIN SCRIPT CONFIGURATION",
        "     *",
        "     * REPLACE WITH YOUR OWN OKTA TENANT SETTINGS",
        "     *",
        "     */",
        "    var OKTA_API_URI = "https://dev-18030933.okta.com/api/v1/authn/";",
        "    /*",
        "     * END SCRIPT CONFIGURATION",
        "     */",
        "",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setMethod('POST');",
        "    request.setUri(OKTA_API_URI);",
        "    request.getHeaders().add("Content-Type", "application/json");",
        "      //var body =     "{\\"username\\":".concat(sharedState.get("username")).concat(",\\"password\\":").concat(transientState.get("password")).concat(",\\"options\\":{\\"multiOptionalFactorEnroll\\":true,\\"warnBeforePasswordExpired\\":true}}");",
        "    var body = {",
        "        "username": sharedState.get("username"),",
        "        "password": transientState.get("password"),",
        "        "options": {",
        "            "multiOptionalFactorEnroll": true,",
        "            "warnBeforePasswordExpired": true",
        "        }",
        "    }",
        "      request.getEntity().setJson(body);",
        "",
        "    var response = httpClient.send(request).get();",
        "    var result = JSON.parse(response.getEntity().getString());",
        "    logger.message("Okta Passthru Authentication: JSON result: " + JSON.stringify(result));",
        "",
        "      if (response.getStatus().getCode() === 200 && result.status === "SUCCESS") {",
        "          outcome = "Success"",
        "        transientState.put("oktaProfile", result._embedded.user.profile);",
        "    } else {",
        "        /* Outcomes:",
        "         * - Success",
        "         * - Failure",
        "         * - Timeout",
        "         * - Error",
        "         *",
        "         * Expected/known Error Codes:",
        "         * E0000004 - Authentication failed.",
        "         * E0000003 - The request body was not well-formed",
        "         */",
        "      ",
        "    /*",
        "{",
        "    "expiresAt": "2021-10-14T22:15:04.000Z",",
        "    "status": "SUCCESS",",
        "    "sessionToken": "20111FNVseT3WyCzBHFBi3dYtx980FHen46QKlWXRNTe1kRef3GQu1W",",
        "    "_embedded": {",
        "        "user": {",
        "            "id": "00u1xqw851dEqM1Y15d7",",
        "            "passwordChanged": "2021-09-21T18:26:25.000Z",",
        "            "profile": {",
        "                "login": "chico@crossfithighvoltage.com",",
        "                "firstName": "chico",",
        "                "lastName": "deme",",
        "                "locale": "en",",
        "                "timeZone": "America/Los_Angeles"",
        "            }",
        "        }",
        "    },",
        "    "_links": {",
        "        "cancel": {",
        "            "href": "https://dev-18030933.okta.com/api/v1/authn/cancel",",
        "            "hints": {",
        "                "allow": [",
        "                    "POST"",
        "                ]",
        "            }",
        "        }",
        "    }",
        "}",
        "*/",
        "",
        "  /*",
        "  FAILED",
        "  {",
        "    "errorCode": "E0000004",",
        "    "errorSummary": "Authentication failed",",
        "    "errorLink": "E0000004",",
        "    "errorId": "oae1Y3Kk_WvRAOBSDeG9qeyHQ",",
        "    "errorCauses": []",
        "}",
        "*/",
        "        transientState.put("oktaResult", result);",
        "        if (result.timed_out) {",
        "            outcome = "Timeout";",
        "        } else if (result.errorCode === "E0000004") {",
        "            outcome = "Failure";",
        "        } else {",
        "            outcome = "Error";",
        "        }",
        "        logger.message("Okta Passthru Authentication: errorCode = ".concat(result.errorCode));",
        "        logger.message("Okta Passthru Authentication: errorSummary = ".concat(result.errorSummary));",
        "        logger.message("Okta Passthru Authentication: errorId = ".concat(result.errorId));",
        "    }",
        "} else {",
        "      outcome = "Error";",
        "      logger.message("Okta Passthru Authentication: No user or password found in shared state! Use username and password collector nodes before this script to populate shared and transient states!'");",
        "}",
        "logger.message("Okta Passthru Authentication: End (outcome=".concat(outcome).concat(")"));",
      ],
    },
    "312e951f-70c5-49d2-a9ae-93aef909d5df": {
      "_id": "312e951f-70c5-49d2-a9ae-93aef909d5df",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from Salesforce",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Salesforce Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "return json(object(",
        "        field("id", rawProfile.user_id),",
        "        field("displayName", rawProfile.name),",
        "        field("givenName", rawProfile.given_name),",
        "        field("familyName", rawProfile.family_name),",
        "        field("photoUrl", rawProfile.picture),",
        "        field("email", rawProfile.email),",
        "        field("username", rawProfile.email),",
        "        field("locale", rawProfile.zoneInfo)))",
      ],
    },
    "3156d7e9-1589-4ffb-a659-37a1647ee03d": {
      "_id": "3156d7e9-1589-4ffb-a659-37a1647ee03d",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Converts a normalized social profile coming from ADFS into a managed user",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Normalized ADFS Profile to Managed User",
      "script": [
        "/*",
        " * Copyright 2022 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "import org.forgerock.json.JsonValue",
        "",
        "JsonValue managedUser = json(object(",
        "        field("givenName", normalizedProfile.givenName),",
        "        field("sn", normalizedProfile.familyName),",
        "        field("mail", normalizedProfile.email),",
        "        field("userName", normalizedProfile.username)))",
        "",
        "if (normalizedProfile.postalAddress.isNotNull()) managedUser.put("postalAddress", normalizedProfile.postalAddress)",
        "if (normalizedProfile.addressLocality.isNotNull()) managedUser.put("city", normalizedProfile.addressLocality)",
        "if (normalizedProfile.addressRegion.isNotNull()) managedUser.put("stateProvince", normalizedProfile.addressRegion)",
        "if (normalizedProfile.postalCode.isNotNull()) managedUser.put("postalCode", normalizedProfile.postalCode)",
        "if (normalizedProfile.country.isNotNull()) managedUser.put("country", normalizedProfile.country)",
        "if (normalizedProfile.phone.isNotNull()) managedUser.put("telephoneNumber", normalizedProfile.phone)",
        "managedUser.put("accountStatus", (normalizedProfile.roles.asString() == "fidc-volker-dev-admins") ? 'Active' : 'Inactive')",
        "",
        "// if the givenName and familyName is null or empty",
        "// then add a boolean flag to the shared state to indicate names are not present",
        "// this could be used elsewhere",
        "// for eg. this could be used in a scripted decision node to by-pass patching",
        "// the user object with blank values when givenName  and familyName is not present",
        "boolean noGivenName = normalizedProfile.givenName.isNull() || (!normalizedProfile.givenName.asString()?.trim())",
        "boolean noFamilyName = normalizedProfile.familyName.isNull() || (!normalizedProfile.familyName.asString()?.trim())",
        "sharedState.put("nameEmptyOrNull", noGivenName && noFamilyName)",
        "",
        "return managedUser",
        "",
      ],
    },
    "3369037a-7a49-4aed-a1dc-7aab7608812b": {
      "_id": "3369037a-7a49-4aed-a1dc-7aab7608812b",
      "context": "OAUTH2_ACCESS_TOKEN_MODIFICATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Service Account - Token Modification",
      "script": [
        "(function () {",
        "  var fr = JavaImporter(",
        "    java.lang.String,",
        "    java.security.MessageDigest,",
        "    java.util.Arrays,",
        "    javax.crypto.Cipher,",
        "    javax.crypto.spec.SecretKeySpec,",
        "    org.forgerock.http.protocol.Request,",
        "    org.forgerock.http.protocol.Response,",
        "    org.forgerock.util.encode.Base64",
        "  );",
        "  ",
        "  var secret = 'FuwwVKpPER9tPSMYUiIkY7IaPzv85aGU';",
        "  ",
        "  function encrypt(str) {",
        "    try {",
        "      var key = new fr.String(secret).getBytes('UTF-8');",
        "      var sha = fr.MessageDigest.getInstance('SHA-256');",
        "      key = sha.digest(key);",
        "      key = fr.Arrays.copyOf(key, 32);",
        "      var secretKey = new fr.SecretKeySpec(key, 'AES');",
        "      var cipher = fr.Cipher.getInstance('AES/ECB/PKCS5Padding');",
        "      cipher.init(fr.Cipher.ENCRYPT_MODE, secretKey);",
        "      var finalBytes = cipher.doFinal(new fr.String(str).getBytes('UTF-8'));",
        "      return fr.Base64.encode(finalBytes);",
        "    } catch (e) {",
        "      logger.error('{}: failed to encrypt: {}', scriptName, e);",
        "      throw e;",
        "    }",
        "  }",
        "",
        "  function hasAmScope(scope) {",
        "    if (!scope) return false;",
        "    for (var i = 0; i < scope.length; i++) {",
        "      if (scope[i].indexOf('fr:am:') > -1) return true;",
        "    }",
        "    return false;",
        "  }",
        "",
        "  try {",
        "    var uri = 'http://am.fr-platform:80/am/json/authenticate?authIndexType=service&authIndexValue=FRServiceAccountInternal';",
        "    var requestParams = requestProperties.get('requestParams');",
        "",
        "    var scope = requestParams.get('scope');",
        "    if (!hasAmScope(scope)) {",
        "      logger.message('AM scope not requested');",
        "      return null;",
        "    }",
        "",
        "    var jwts = requestParams.get('assertion');",
        "    if (!jwts || jwts.isEmpty()) {",
        "      logger.message('No jwt assertion');",
        "      return null;",
        "    }",
        "",
        "    var jwt = jwts[0];",
        "    var uuid = identity.getAttribute('_id').iterator().next();",
        "",
        "    var request = new fr.Request();",
        "    request.getHeaders().add('authorization', 'svcacct ' + uuid + ' ' + jwt);",
        "    request.getHeaders().add('content-type', 'application/json');",
        "    request",
        "      .setUri(uri)",
        "      .setMethod('POST')",
        "      .setEntity('{}');",
        "",
        "    var response = httpClient.send(request).getOrThrow();",
        "    if (response.getStatus() === org.forgerock.http.protocol.Status.OK) {",
        "      var result = JSON.parse(response.getEntity().getString());",
        "      var encryptedTokenId = encrypt(result.tokenId);",
        "      accessToken.setField('sessionToken', encryptedTokenId);",
        "    } else {",
        "      logger.message('Failed to get session from service account tree (status: ' + response.getStatus() + ')');",
        "    }",
        "  } catch (e) {",
        "    throw ('Failed to modify service account token: ' + e);",
        "  }",
        "}());",
        "",
      ],
    },
    "355a8b7c-9e3c-40c1-a873-68127e483adf": {
      "_id": "355a8b7c-9e3c-40c1-a873-68127e483adf",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Extract Username from request.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "KerberosLogin: Extract Username",
      "script": [
        "/* KerberosLogin: Extract Username",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * - false",
        " */",
        "",
        "logger.warning("KerberosLogin: Extract Username: start");",
        "outcome = "false";",
        "",
        "/*",
        " * BEGIN SCRIPT CONFIGURATION",
        " */",
        "var USERNAME_HEADER_NAME = "X-OpenAM-Username";",
        "/*",
        " * END SCRIPT CONFIGURATION",
        " */",
        "",
        "var username = getHeader(USERNAME_HEADER_NAME);",
        "if (username) {",
        "    ",
        "      outcome = "true";",
        "    sharedState.put("username", username);",
        "    setSharedObjectAttribute("userName", username);",
        "}",
        "",
        "logger.warning("KerberosLogin: Extract Username: finish [outcome=".concat(outcome).concat("]"));",
        "",
        "/*",
        " * Returns the value of the requested header",
        " */",
        "function getHeader(headerName) {",
        "      if (requestHeaders.get(headerName) && requestHeaders.get(headerName).get(0)) {",
        "        return requestHeaders.get(headerName).get(0).toString();",
        "    }",
        "      return null;",
        "}",
        "",
        "/*",
        " * Store attributes in shared state for use with the Create/Patch Object nodes.",
        " */",
        "function setSharedObjectAttribute(name, value) {",
        "       var storage = sharedState.get("objectAttributes");",
        "    if (storage && value) {",
        "          if (storage.put) {",
        "              storage.put(name, value);",
        "        }",
        "          else {",
        "              storage[name] = value;",
        "        }",
        "    }",
        "    else if (value) {",
        "        sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "    }",
        "}",
      ],
    },
    "36863ffb-40ec-48b9-94b1-9a99f71cc3b5": {
      "_id": "36863ffb-40ec-48b9-94b1-9a99f71cc3b5",
      "context": "OIDC_CLAIMS",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Default global script for OIDC claims",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "OIDC Claims Script",
      "script": [
        "/*",
        " * Copyright 2014-2021 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        " * This script computes claim values returned in ID tokens and/or at the UserInfo Endpoint.",
        " * The claim values are computed for:",
        " * the claims derived from the requested scopes,",
        " * the claims provided by the authorization server,",
        " * and the claims requested by the client via the claims parameter.",
        " *",
        " * In the CONFIGURATION AND CUSTOMIZATION section, you can",
        " * define the scope-to-claims mapping, and",
        " * assign to each claim a resolver function that will compute the claim value.",
        " *",
        " * Defined variables (class references are provided below):",
        " * scopes - Set<String> (6).",
        " *          Always present, the requested scopes.",
        " * claims - Map<String, Object> (5).",
        " *          Always present, default server provided claims.",
        " * claimObjects - List<Claim> (7, 2).",
        " *                Always present, the default server provided claims.",
        " * requestedClaims - Map<String, Set<String>> (5).",
        " *                   Always present, not empty if the request contains the claims parameter and the server has enabled",
        " *                   claims_parameter_supported. A map of the requested claims to possible values, otherwise empty;",
        " *                   requested claims with no requested values will have a key but no value in the map. A key with",
        " *                   a single value in its Set (6) indicates that this is the only value that should be returned.",
        " * requestedTypedClaims - List<Claim> (7, 2).",
        " *                        Always present, the requested claims.",
        " *                        Requested claims with no requested values will have a claim with no values.",
        " *                        A claim with a single value indicates this is the only value that should be returned.",
        " * claimsLocales - List<String> (7).",
        " *                 The values from the 'claims_locales' parameter.",
        " *                 See https://openid.net/specs/openid-connect-core-1_0.html#ClaimsLanguagesAndScripts for the OIDC specification details.",
        " * requestProperties - Unmodifiable Map (5).",
        " *                     Always present, contains a map of request properties:",
        " *                     requestUri - The request URI.",
        " *                     realm - The realm that the request relates to.",
        " *                     requestParams - A map of the request params and/or posted data.",
        " *                                     Each value is a list of one or more properties.",
        " *                                     Please note that these should be handled in accordance with OWASP best practices:",
        " *                                     https://owasp.org/www-community/vulnerabilities/Unsafe_use_of_Reflection.",
        " * clientProperties - Unmodifiable Map (5).",
        " *                    Present if the client specified in the request was identified, contains a map of client properties:",
        " *                    clientId - The client's URI for the request locale.",
        " *                    allowedGrantTypes - List of the allowed grant types (org.forgerock.oauth2.core.GrantType) for the client.",
        " *                    allowedResponseTypes - List of the allowed response types for the client.",
        " *                    allowedScopes - List of the allowed scopes for the client.",
        " *                    customProperties - A map of the custom properties of the client.",
        " *                                       Lists or maps will be included as sub-maps; for example:",
        " *                                       customMap[Key1]=Value1 will be returned as customMap -> Key1 -> Value1.",
        " *                                       To add custom properties to a client, update the Custom Properties field",
        " *                                       in AM Console > Realm Name > Applications > OAuth 2.0 > Clients > Client ID > Advanced.",
        " * identity - AMIdentity (3).",
        " *            Always present, the identity of the resource owner.",
        " * session - SSOToken (4).",
        " *           Present if the request contains the session cookie, the user's session object.",
        " * scriptName - String (primitive).",
        " *              Always present, the display name of the script.",
        " * logger - Always present, the "OAuth2Provider" debug logger instance:",
        " *          https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.",
        " *          Corresponding files will be prefixed with: scripts.OIDC_CLAIMS.",
        " * httpClient - HTTP Client (8).",
        " *              Always present, the HTTP Client instance:",
        " *              https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-http-client.html#scripting-api-global-http-client.",
        " *              In order to use the client, you may need to add",
        " *              org.forgerock.http.Client,",
        " *              org.forgerock.http.protocol.*,",
        " *              and org.forgerock.util.promise.PromiseImpl",
        " *              to the allowed Java classes in the scripting engine configuration, as described in:",
        " *              https://backstage.forgerock.com/docs/am/7/scripting-guide/script-engine-security.html",
        " *",
        " * Return - a new UserInfoClaims(Map<String, Object> values, Map<String, List<String>> compositeScopes) (1) object.",
        " *          The result of the last statement in the script is returned to the server.",
        " *          Currently, the Immediately Invoked Function Expression (also known as Self-Executing Anonymous Function)",
        " *          is the last (and only) statement in this script, and its return value will become the script result.",
        " *          Do not use "return variable" statement outside of a function definition.",
        " *          See RESULTS section for additional details.",
        " *",
        " * Class reference:",
        " * (1) UserInfoClaims - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html.",
        " * (2) Claim - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html).",
        " *         An instance of org.forgerock.openidconnect.Claim has methods to access",
        " *         the claim name, requested values, locale, and whether the claim is essential.",
        " * (3) AMIdentity - https://backstage.forgerock.com/docs/am/7/apidocs/com/sun/identity/idm/AMIdentity.html.",
        " * (4) SSOToken - https://backstage.forgerock.com/docs/am/7/apidocs/com/iplanet/sso/SSOToken.html.",
        " * (5) Map - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashMap.html,",
        " *           or https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/LinkedHashMap.html.",
        " * (6) Set - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashSet.html.",
        " * (7) List - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/ArrayList.html.",
        " * (8) Client - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/http/Client.html.",
        "*/",
        "",
        "(function () {",
        "    // SETUP",
        "",
        "    /**",
        "     * Claim processing utilities.",
        "     * An object that contains reusable functions for processing claims.",
        "     * @see CLAIM PROCESSING UTILITIES section for details.",
        "     */",
        "    var utils = getUtils();",
        "",
        "    // CONFIGURATION AND CUSTOMIZATION",
        "",
        "    /**",
        "     * OAuth 2.0 scope values (scopes) can be used by the Client to request OIDC claims.",
        "     *",
        "     * Call this configuration method, and pass in as the first argument",
        "     * an object that maps a scope value to an array of claim names",
        "     * to specify which claims need to be processed and returned for the requested scopes.",
        "     * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#ScopeClaims}",
        "     * for the scope values that could be used to request claims as defined in the OIDC specification.",
        "     *",
        "     * Below, find a default configuration that is expected to work in the current environment.",
        "     *",
        "     * CUSTOMIZATION",
        "     * You can choose the claim names returned for a scope.",
        "     */",
        "    utils.setScopeClaimsMap({",
        "        profile: [",
        "            'name',",
        "            'family_name',",
        "            'given_name',",
        "            'zoneinfo',",
        "            'locale'",
        "        ],",
        "        email: ['email'],",
        "        address: ['address'],",
        "        phone: ['phone_number']",
        "    });",
        "",
        "    /**",
        "     * In this script, each claim",
        "     * derived from the requested scopes,",
        "     * provided by the authorization server, and",
        "     * requested by the client via the claims parameter",
        "     * will be processed by a function associated with the claim name.",
        "     *",
        "     * Call this configuration method, and pass in as the first argument",
        "     * an object that maps a claim name to a resolver function,",
        "     * which will be automatically executed for each claim processed by the script.",
        "     *",
        "     * The claim resolver function will receive the requested claim information",
        "     * in an instance of org.forgerock.openidconnect.Claim as the first argument.",
        "     * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html}",
        "     * for details on the Claim class.",
        "     *",
        "     * If the claim resolver function returns a value,",
        "     * other than undefined or null,",
        "     * the claim will be included in the script's results.",
        "     *",
        "     * The Claim instance provides methods to check",
        "     * what the name of the claim is,",
        "     * which values the claim request contains,",
        "     * whether the claim is essential, and",
        "     * which locale the claim is associated with.",
        "     * The resolver function can consider this information when computing and returning the claim value.",
        "     *",
        "     * Below, find a default configuration that is expected to work in the current environment.",
        "     * A reusable function, utils.getUserProfileClaimResolver(String attribute-name),",
        "     * is called to return a claim resolver function based on a user profile attribute.",
        "     * @see CLAIM RESOLVERS section for the implementation details and examples.",
        "     * For the address claim, an example of a claim resolver that uses another claim resolver is provided.",
        "     *",
        "     * CUSTOMIZATION",
        "     * You can reuse the predefined utils methods with your custom arguments.",
        "     * You can also specify a custom resolver function for a claim name,",
        "     * that will compute and return the claim value—as shown in the commented out example below.",
        "     */",
        "    utils.setClaimResolvers({",
        "        /*",
        "        // An example of a simple claim resolver function that is defined for a claim",
        "        // directly in the configuration object:",
        "        custom-claim-name: function (requestedClaim) {",
        "            // In this case, initially, the claim value comes straight from a user profile attribute value:",
        "            var claimValue = identity.getAttribute('custom-attribute-name').toArray()[0]",
        "",
        "            // Optionally, provide additional logic for processing (filtering, formatting, etc.) the claim value.",
        "            // You can use:",
        "            // requestedClaim.getName()",
        "            // requestedClaim.getValues()",
        "            // requestedClaim.getLocale()",
        "            // requestedClaim.isEssential()",
        "",
        "            return claimValue",
        "        },",
        "        */",
        "        /**",
        "         * The use of utils.getUserProfileClaimResolver shows how",
        "         * an argument passed to a function that returns a claim resolver",
        "         * becomes available to the resolver function (via its lexical context).",
        "         */",
        "        name: utils.getUserProfileClaimResolver('cn'),",
        "        family_name: utils.getUserProfileClaimResolver('sn'),",
        "        given_name: utils.getUserProfileClaimResolver('givenname'),",
        "        zoneinfo: utils.getUserProfileClaimResolver('preferredtimezone'),",
        "        locale: utils.getUserProfileClaimResolver('preferredlocale'),",
        "        email: utils.getUserProfileClaimResolver('mail'),",
        "        address: utils.getAddressClaimResolver(",
        "            /**",
        "             * The passed in user profile claim resolver function",
        "             * can be used by the address claim resolver function",
        "             * to obtain the claim value to be formatted as per the OIDC specification:",
        "             * @see https://openid.net/specs/openid-connect-core-1_0.html#AddressClaim.",
        "             */",
        "            utils.getUserProfileClaimResolver('postaladdress')",
        "        ),",
        "        phone_number: utils.getUserProfileClaimResolver('telephonenumber')",
        "    });",
        "",
        "    // CLAIM PROCESSING UTILITIES",
        "",
        "    /**",
        "     * @returns {object} An object that contains reusable claim processing utilities.",
        "     * @see PUBLIC METHODS section and the return statement for the list of exported functions.",
        "     */",
        "    function getUtils () {",
        "        // IMPORT JAVA",
        "",
        "        /**",
        "         * Provides Java scripting functionality.",
        "         * @see {@link https://developer.mozilla.org/en-US/docs/Mozilla/Projects/Rhino/Scripting_Java#javaimporter_constructor}.",
        "         */",
        "        var frJava = JavaImporter(",
        "            org.forgerock.oauth2.core.exceptions.InvalidRequestException,",
        "            org.forgerock.oauth2.core.UserInfoClaims,",
        "            org.forgerock.openidconnect.Claim,",
        "",
        "            java.util.LinkedHashMap,",
        "            java.util.ArrayList",
        "        );",
        "",
        "        // SET UP CONFIGURATION",
        "",
        "        /**",
        "         * Placeholder for a configuration option that contains",
        "         * an object that maps the supported scope values (scopes)",
        "         * and the corresponding claim names for each scope value.",
        "         */",
        "        var scopeClaimsMap;",
        "",
        "        /**",
        "         * Placeholder for a configuration option that contains",
        "         * an object that maps the supported claim names",
        "         * and the resolver functions returning the claim value.",
        "         */",
        "        var claimResolvers;",
        "",
        "        /**",
        "         * A (public) method that accepts an object that maps the supported scopes and the corresponding claim names,",
        "         * and assigns it to a (private) variable that serves as a configuration option.",
        "         * @param {object} params - An object that maps each supported scope value to an array of claim names,",
        "         * in order to specify which claims need to be processed for the requested scopes.",
        "         * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#ScopeClaims} for details.",
        "         * @param {string[]} [params.profile] - An array of claim names to be returned if the profile scope is requested.",
        "         * @param {string[]} [params.email] - An array of claim names to be returned if the email scope is requested.",
        "         * @param {string[]} [params.address] - An array of claim names to be returned if the address scope is requested.",
        "         * @param {string[]} [params.phone] - An array of claim names to be returned if the phone scope is requested.",
        "         * @returns {undefined}",
        "         */",
        "        function setScopeClaimsMap(params) {",
        "            scopeClaimsMap = params;",
        "        }",
        "",
        "        /**",
        "         * A (public) method that accepts an object that maps the supported claim names",
        "         * and the resolver functions returning the claim value,",
        "         * and assigns it to a (private) variable that serves as a configuration option.",
        "         * @param {object} params - An object that maps",
        "         * each supported claim name to a function that computes and returns the claim value.",
        "         */",
        "        function setClaimResolvers(params) {",
        "            claimResolvers = params;",
        "        }",
        "",
        "        // CLAIM RESOLVERS",
        "",
        "        /**",
        "         * Claim resolvers are functions that return a claim value.",
        "         * @param {*}",
        "         * @returns {*}",
        "         */",
        "",
        "        /**",
        "         * Defines a claim resolver based on a user profile attribute.",
        "         * @param {string} attributeName - Name of the user profile attribute.",
        "         * @returns {function} A function that will determine the claim value",
        "         * based on the user profile attribute and the (requested) claim properties.",
        "         */",
        "        function getUserProfileClaimResolver (attributeName) {",
        "            /**",
        "             * Resolves a claim with a user profile attribute value.",
        "             * Returns undefined if the identity attribute is not populated,",
        "             * OR if the claim has requested values that do not contain the identity attribute value.",
        "             * ATTENTION: the aforementioned comparison is case-sensitive.",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {string|HashSet|undefined}",
        "             */",
        "            function resolveClaim(claim) {",
        "                var userProfileValue;",
        "",
        "                if (identity) {",
        "                    userProfileValue = getClaimValueFromSet(claim, identity.getAttribute(attributeName));",
        "",
        "                    if (userProfileValue && !userProfileValue.isEmpty()) {",
        "                        if (!claim.getValues() || claim.getValues().isEmpty() || claim.getValues().contains(userProfileValue)) {",
        "                            return userProfileValue;",
        "                        }",
        "                    }",
        "                }",
        "            }",
        "",
        "            return resolveClaim;",
        "        }",
        "",
        "        /**",
        "         * Returns an address claim resolver based on a claim value obtained with another claim resolver.",
        "         * @param {function} resolveClaim - A function that returns a claim value.",
        "         * @returns {function} A function that will accept a claim as an argument,",
        "         * run the claim resolver function for the claim and obtain the claim value,",
        "         * and apply additional formatting to the value before returning it.",
        "         */",
        "        function getAddressClaimResolver (resolveClaim) {",
        "            /**",
        "             * Creates an address claim object from a value returned by a claim resolver,",
        "             * and returns the address claim object as the claim value.",
        "             * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#AddressClaim}.",
        "             * The claim value is obtained with a claim resolving function available from the closure.",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {java.util.LinkedHashMap|undefined} The address claim object created from a claim value.",
        "             */",
        "            function resolveAddressClaim(claim) {",
        "                var claimValue = resolveClaim(claim);",
        "                var addressObject;",
        "",
        "                if (isClaimValueValid(claimValue)) {",
        "                    addressObject = new frJava.LinkedHashMap();",
        "",
        "                    addressObject.put('formatted', claimValue);",
        "",
        "                    return addressObject;",
        "                }",
        "            }",
        "",
        "            return resolveAddressClaim;",
        "        }",
        "",
        "        /**",
        "         * Returns an essential claim resolver based on a claim value obtained with another claim resolver.",
        "         * @param {function} resolveClaim - A function that returns a claim value.",
        "         * @returns {function} A function that will accept a claim as an argument,",
        "         * run the claim resolver function for the claim and obtain the claim value,",
        "         * and apply additional logic for essential claims.",
        "         */",
        "        function getEssentialClaimResolver (resolveClaim) {",
        "            /**",
        "             * Returns a claim value or throws an error.",
        "             * The claim value is obtained with a claim resolving function available from the closure.",
        "             * Throws an exception if the claim is essential and no value is returned for the claim.",
        "             *",
        "             * Use of this resolver is optional.",
        "             * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#IndividualClaimsRequests} stating:",
        "             * "Note that even if the Claims are not available because the End-User did not authorize their release or they are not present,",
        "             * the Authorization Server MUST NOT generate an error when Claims are not returned, whether they are Essential or Voluntary,",
        "             * unless otherwise specified in the description of the specific claim."",
        "             *",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {*}",
        "             * @throws {org.forgerock.oauth2.core.exceptions.InvalidRequestException}",
        "             */",
        "            function resolveEssentialClaim(claim) {",
        "                var claimValue = resolveClaim(claim);",
        "",
        "                if (claim.isEssential() && !isClaimValueValid(claimValue)) {",
        "                    throw new frJava.InvalidRequestException('Could not provide value for essential claim: ' + claim.getName());",
        "                }",
        "",
        "                return claimValue;",
        "            }",
        "",
        "            return resolveEssentialClaim;",
        "        }",
        "",
        "        /**",
        "         * Provides default resolution for a claim.",
        "         * Use it if a claim-specific resolver is not defined in the configuration.",
        "         * @param {org.forgerock.openidconnect.Claim} claim",
        "         * An object that provides methods to obtain information/requirements associated with a claim.",
        "         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "         * @returns {*} A single value associated with this claim.",
        "         */",
        "        function resolveAnyClaim (claim) {",
        "            if (claim.getValues().size() === 1) {",
        "                return claim.getValues().toArray()[0];",
        "            }",
        "        }",
        "",
        "        // UTILITIES",
        "",
        "        /**",
        "         * Returns claim value from a set.",
        "         * If the set contains a single value, returns the value.",
        "         * If the set contains multiple values, returns the set.",
        "         * Otherwise, returns undefined.",
        "         *",
        "         * @param {org.forgerock.openidconnect.Claim} claim",
        "         * An object that provides methods to obtain information/requirements associated with a claim.",
        "         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "         * @param {java.util.HashSet} set The set—for example, a user profile attribute value.",
        "         * @returns {string|java.util.HashSet|undefined}",
        "         */",
        "        function getClaimValueFromSet (claim, set) {",
        "            if (set && set.size()) {",
        "                if (set.size() === 1) {",
        "                    return set.toArray()[0];",
        "                } else {",
        "                    return set;",
        "                }",
        "            } else if (logger.warningEnabled()) {",
        "                logger.warning('OIDC Claims script. Got an empty set for claim: ' + claim.getName());",
        "            }",
        "        }",
        "",
        "        function isClaimValueValid (claimValue) {",
        "            if (typeof claimValue === 'undefined' || claimValue === null) {",
        "                return false;",
        "            }",
        "",
        "            return true;",
        "        }",
        "",
        "        // CLAIM PROCESSING",
        "",
        "        /**",
        "         * Constructs and returns an object populated with the computed claim values",
        "         * and the requested scopes mapped to the claim names.",
        "         * @returns {org.forgerock.oauth2.core.UserInfoClaims} The object to be returned to the authorization server.",
        "         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html}.",
        "         * @see RESULTS section for the use of this function.",
        "         */",
        "        function getUserInfoClaims () {",
        "            return new frJava.UserInfoClaims(getComputedClaims(), getCompositeScopes());",
        "        }",
        "",
        "        /**",
        "         * Creates a map of (requested) claim names populated with the computed claim values.",
        "         * @returns {java.util.LinkedHashMap}",
        "         * A map of the requested claim names and the corresponding claim values.",
        "         */",
        "        function getComputedClaims () {",
        "            /**",
        "             * Creates a complete list of claim objects from:",
        "             * the claims derived from the scopes,",
        "             * the claims provided by the authorization server,",
        "             * and the claims requested by the client.",
        "             * @returns {java.util.ArrayList}",
        "             * Returns a complete list of org.forgerock.openidconnect.Claim objects available to the script.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for the claim object details.",
        "             */",
        "            function getClaims() {",
        "                /**",
        "                 * Returns a list of claim objects for the requested scopes.",
        "                 * Uses the scopeClaimsMap configuration option to derive the claim names;",
        "                 * no other properties of a claim derived from a scope are populated.",
        "                 * @returns {java.util.ArrayList}",
        "                 * A list of org.forgerock.openidconnect.Claim objects derived from the requested scopes.",
        "                 * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for the claim object details.",
        "                 */",
        "                function convertScopeToClaims() {",
        "                    var claims = new frJava.ArrayList();",
        "",
        "                    scopes.toArray().forEach(function (scope) {",
        "                        if (String(scope) !== 'openid' && scopeClaimsMap[scope]) {",
        "                            scopeClaimsMap[scope].forEach(function (claimName) {",
        "                                claims.add(new frJava.Claim(claimName));",
        "                            });",
        "                        }",
        "                    });",
        "",
        "                    return claims;",
        "                }",
        "",
        "                var claims = new frJava.ArrayList();",
        "",
        "                claims.addAll(convertScopeToClaims());",
        "                claims.addAll(claimObjects);",
        "                claims.addAll(requestedTypedClaims);",
        "",
        "                return claims;",
        "            }",
        "",
        "            /**",
        "             * Computes and returns a claim value.",
        "             * To obtain the claim value, uses the resolver function specified for the claim in the claimResolvers configuration object.",
        "             * @see claimResolvers",
        "             * If no resolver function is found, uses the default claim resolver function.",
        "             *",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {*} Claim value.",
        "             * @throws {org.forgerock.oauth2.core.exceptions.InvalidRequestException}",
        "             * Rethrows this exception if a claim resolver throws it.",
        "             * You can throw org.forgerock.oauth2.core.exceptions.InvalidRequestException from your custom claim resolver",
        "             * if you want to terminate the claim processing.",
        "             */",
        "            function computeClaim(claim) {",
        "                var resolveClaim;",
        "                var message;",
        "",
        "                try {",
        "                    resolveClaim = claimResolvers[claim.getName()] || resolveAnyClaim;",
        "",
        "                    return resolveClaim(claim);",
        "                } catch (e) {",
        "                    message = 'OIDC Claims script exception. Unable to resolve OIDC Claim. ' + e;",
        "",
        "                    if (String(e).indexOf('org.forgerock.oauth2.core.exceptions.InvalidRequestException') !== -1) {",
        "                        throw e;",
        "                    }",
        "",
        "                    if (logger.warningEnabled()) {",
        "                        logger.warning(message);",
        "                    }",
        "                }",
        "            }",
        "",
        "            var computedClaims = new frJava.LinkedHashMap();",
        "",
        "            getClaims().toArray().forEach(function (claim) {",
        "                var claimValue = computeClaim(claim);",
        "",
        "                if (isClaimValueValid(claimValue)) {",
        "                    computedClaims.put(claim.getName(), claimValue);",
        "                } else {",
        "                    /**",
        "                     * If a claim has been processed, but appears in the list again,",
        "                     * and its value cannot be computed under the new conditions,",
        "                     * the claim is removed from the final result.",
        "                     *",
        "                     * For example, a claim could be mapped to a scope and found in the user profile,",
        "                     * but also requested by the client with required values that don't match the computed one.",
        "                     * @see {link https://openid.net/specs/openid-connect-core-1_0.html#IndividualClaimsRequests}.",
        "                     * for the relevant OIDC specification details.",
        "                     */",
        "                    computedClaims.remove(claim.getName());",
        "                }",
        "            });",
        "",
        "            return computedClaims;",
        "        }",
        "",
        "        /**",
        "         * Creates a map of requested scopes and the corresponding claim names.",
        "         * @returns {java.util.LinkedHashMap}",
        "         */",
        "        function getCompositeScopes () {",
        "            var compositeScopes = new frJava.LinkedHashMap();",
        "",
        "            scopes.toArray().forEach(function (scope) {",
        "                var scopeClaims = new frJava.ArrayList();",
        "",
        "                if (scopeClaimsMap[scope]) {",
        "                    scopeClaimsMap[scope].forEach(function (claimName) {",
        "                        scopeClaims.add(claimName);",
        "                    });",
        "                }",
        "",
        "                if (scopeClaims.size()) {",
        "                    compositeScopes.put(scope, scopeClaims);",
        "                }",
        "            });",
        "",
        "            return compositeScopes;",
        "        }",
        "",
        "        // PUBLIC METHODS",
        "",
        "        return {",
        "            setScopeClaimsMap: setScopeClaimsMap,",
        "            setClaimResolvers: setClaimResolvers,",
        "            getUserProfileClaimResolver: getUserProfileClaimResolver,",
        "            getAddressClaimResolver: getAddressClaimResolver,",
        "            getEssentialClaimResolver: getEssentialClaimResolver,",
        "            getUserInfoClaims: getUserInfoClaims",
        "        };",
        "    }",
        "",
        "    // RESULTS",
        "",
        "    /**",
        "     * This script returns an instance of the org.forgerock.oauth2.core.UserInfoClaims class",
        "     * populated with the computed claim values and",
        "     * the requested scopes mapped to the claim names.",
        "     * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html}.",
        "     *",
        "     * Assigning it to a variable gives you an opportunity",
        "     * to log the content of the returned value during development.",
        "     */",
        "    var userInfoClaims = utils.getUserInfoClaims();",
        "",
        "    /*",
        "    logger.error(scriptName + ' results:')",
        "    logger.error('Values: ' + userInfoClaims.getValues())",
        "    logger.error('Scopes: ' + userInfoClaims.getCompositeScopes())",
        "    */",
        "",
        "    return userInfoClaims;",
        "}());",
        "",
      ],
    },
    "37bf200a-158f-4a45-8ee5-81516e4593f8": {
      "_id": "37bf200a-158f-4a45-8ee5-81516e4593f8",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Display session info.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Display Session Info",
      "script": [
        "/* Display Session Info",
        " * ",
        " * Display Session Info.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    outcome = "true";",
        "",
        "    var anchor = "anchor-".concat(generateNumericToken('xxx'));",
        "    var halign = "left";",
        "",
        "    var choices = [];",
        "      var defaultChoice = 0;",
        "  ",
        "      var include = ["org","idp","saas","profileType","givenName","sn","mail","roles","userName","UserId","Locale","authInstant","AuthLevel","Host","Service"];",
        "    var message = "";",
        "    if (typeof existingSession !== "undefined") {",
        "          message = "<h4>Session Info</h4><p style=\\"font-family:courier;\\">";",
        "          include.forEach(function (key) {",
        "              message += "<b>" + key + "</b>: " + existingSession.get(key) + "<br/>";",
        "        });",
        "         message += "</p><p style=\\"font-size:70%;font-family:courier;\\">"",
        "          var entries = existingSession.keySet().toArray();",
        "        entries.forEach(function (key) {",
        "              if (include.indexOf(""+key)===-1) {",
        "                message += "<b>" + key + "</b>: " + existingSession.get(key) + "<br/>";",
        "            }",
        "        });",
        "         message += "</p>"",
        "          choices.push("Goto SAML App");",
        "          choices.push("Goto OIDC App");",
        "          if (""+existingSession.get("profileType") === "persistent") {",
        "              choices.push("Goto Profile Page");",
        "        }",
        "          choices.push("Logout");",
        "    } else {",
        "          message = "<h4>No Session!</h4><p>"",
        "          choices.push("Login");",
        "    }",
        "    var script = "Array.prototype.slice.call(\\n".concat(",
        "      "document.getElementsByClassName('callback-component')).forEach(\\n").concat(",
        "      "function (e) {\\n").concat(",
        "      "  var message = e.firstElementChild;\\n").concat(",
        "      "  if (message.firstChild && message.firstChild.nodeName == '#text' && message.firstChild.nodeValue.trim() == '").concat(anchor).concat("') {\\n").concat(",
        "      "    message.className = \\"\\";\\n").concat(",
        "      "    message.style = \\"text-align: left; inline-size: 430px; overflow-wrap: break-word;\\";\\n").concat(",
        "      "    message.align = \\"").concat(halign).concat("\\";\\n").concat(",
        "      "    message.innerHTML = '").concat(message).concat("';\\n").concat(",
        "      "  }\\n").concat(",
        "      "})")",
        "  ",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "        javax.security.auth.callback.TextOutputCallback,",
        "        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback,",
        "        javax.security.auth.callback.ConfirmationCallback",
        "    )",
        "    if (callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "            new fr.TextOutputCallback(",
        "                fr.TextOutputCallback.INFORMATION,",
        "                anchor",
        "            ),",
        "            new fr.ScriptTextOutputCallback(script),",
        "            new fr.ConfirmationCallback(",
        "                fr.ConfirmationCallback.INFORMATION,",
        "                choices,",
        "                defaultChoice",
        "            )",
        "        ).build()",
        "    }",
        "    else {",
        "      outcome = choices[callbacks.get(2).getSelectedIndex()];",
        "      action = fr.Action.goTo(outcome).build();",
        "    }",
        "",
        "     /*",
        "      * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "      * ",
        "      * Example:",
        "      * 'xxxxx' produces '28535'",
        "      * 'xxx-xxx' produces '432-521'",
        "      */",
        "    function generateNumericToken(format) {",
        "        return format.replace(/[x]/g, function(c) {",
        "            var r = Math.random()*10|0;",
        "            var v = r;",
        "            return v.toString(10);",
        "        });",
        "    }",
        "}());",
        "",
        "/*",
        "Locale: en_US",
        "authInstant: 2021-09-25T17:28:38Z",
        "Organization: o=alpha,ou=services,ou=am-config",
        "mail: volker@scheuber.name",
        "Principals: volker@scheuber.name",
        "UserProfile: Ignore",
        "CharSet: UTF-8",
        "FullLoginURL: /am/UI/Login?code=4%2F0AX4XfWjiEfbrfIstsFUKoaibPCQmTbuPonLfuhpYhjfj-N5QEe9u2P5Os9wNadGaPsQVBA&scope=email+profile+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.email+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.profile+openid&realm=%2Falpha&state=fykprtfmeclrgwszmomvqxnlirrehcs&hd=scheuber.name&prompt=none&authuser=2",
        "clientType: genericHTML",
        "goto: /am/XUI/?realm=/alpha&authIndexType=service&authIndexValue=SessionInfo&ForceAuth=true#/",
        "AMCtxId: d3188938-d07e-4134-95db-f1cc97fc6c40-503275",
        "loginURL: /am/UI/Login",
        "sn: Scheuber",
        "amlbcookie: 01",
        "HostName: 99.72.28.182",
        "UserToken: volker@scheuber.name",
        "givenName: Volker",
        "successURL: /am/XUI/?realm=/alpha&authIndexType=service&authIndexValue=SessionInfo&ForceAuth=true#/",
        "Service: Router",
        "Host: 99.72.28.182",
        "AuthLevel: 0",
        "idp: google",
        "UserId: volker@scheuber.name",
        "sun.am.UniversalIdentifier: id=volker@scheuber.name,ou=user,o=alpha,ou=services,ou=am-config",
        "OidcSid: ACuTQIObj0tajPYhLOjMlWc2urM",
        "Principal: id=volker@scheuber.name,ou=user,o=alpha,ou=services,ou=am-config",
        " */",
      ],
    },
    "3814d347-a2f2-4be9-a810-ab41a1e374bd": {
      "_id": "3814d347-a2f2-4be9-a810-ab41a1e374bd",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Hide buttons on the journey page.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Remove Button - imported (1)",
      "script": [
        "/* Remove Button",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Hide buttons on the journey page.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "(function () {",
        "    var script = "Array.prototype.slice.call(document.getElementsByTagName('button')).forEach(function (e) {e.style.display = 'none'})"",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "        javax.security.auth.callback.TextOutputCallback,",
        "        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        "    )",
        "    var message = " "",
        "    if (callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "            new fr.TextOutputCallback(",
        "                fr.TextOutputCallback.INFORMATION,",
        "                message",
        "            ),",
        "            new fr.ScriptTextOutputCallback(script)",
        "        ).build()",
        "    }",
        "}());",
      ],
    },
    "38f698de-fe11-43d2-8480-44e1312d121d": {
      "_id": "38f698de-fe11-43d2-8480-44e1312d121d",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "FRAAS-7955 Both States",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "FRAAS-7955 Both States",
      "script": [
        "outcome = "true";",
        "",
        "setSharedObjectAttribute("userName", "FRAAS-7955");",
        "setSharedObjectAttribute("givenName", "First-shared");",
        "setSharedObjectAttribute("sn", "Last-shared");",
        "setSharedObjectAttribute("mail", "first.last-shared@company.com");",
        "",
        "setTransientObjectAttribute("userName", "FRAAS-7955");",
        "setTransientObjectAttribute("givenName", "First-transient");",
        "setTransientObjectAttribute("sn", "Last-transient");",
        "setTransientObjectAttribute("mail", "first.last-transient@company.com");",
        "",
        "/*",
        " * Store attributes in shared state for use with the Create/Patch Object nodes.",
        " */",
        "function setSharedObjectAttribute(name, value) {",
        "       var storage = sharedState.get("objectAttributes");",
        "    if (storage && value) {",
        "          if (storage.put) {",
        "              storage.put(name, value);",
        "        }",
        "          else {",
        "              storage[name] = value;",
        "        }",
        "    }",
        "    else if (value) {",
        "        sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "    }",
        "}",
        "",
        "/*",
        " * Store attributes in transient state for use with the Create/Patch Object nodes.",
        " */",
        "function setTransientObjectAttribute(name, value) {",
        "    var transientStorage = transientState.get("objectAttributes");",
        "    if (transientStorage && value) {",
        "          if (transientStorage.put) {",
        "            transientStorage.put(name, value);",
        "        }",
        "          else {",
        "            transientStorage[name] = value;",
        "        }",
        "    }",
        "    else if (value) {",
        "    transientState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "    }",
        "}",
      ],
    },
    "39c08084-1238-43e8-857f-2e11005eac49": {
      "_id": "39c08084-1238-43e8-857f-2e11005eac49",
      "context": "OAUTH2_ACCESS_TOKEN_MODIFICATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Default alpha realm script for OAuth2 Access Token Modification",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Alpha OAuth2 Access Token Modification Script",
      "script": [
        "/*",
        " * Copyright 2019-2021 ForgeRock AS. All Rights Reserved.",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        " * This script lets you modify information associated with an OAuth2 access token",
        " * with methods provided by the AccessToken (1) interface.",
        " * The changes made to OAuth2 access tokens will directly impact the size of the CTS tokens,",
        " * and, similarly, the size of the JWTs if client-based OAuth2 tokens are utilized.",
        " * When adding/updating fields make sure that the token size remains within client/user-agent limits.",
        " *",
        " * Defined variables:",
        " * accessToken - AccessToken (1).",
        " *               The access token to be updated.",
        " *               Mutable object, all changes to the access token will be reflected.",
        " * scopes - Set<String> (6).",
        " *          Always present, the requested scopes.",
        " * requestProperties - Unmodifiable Map (5).",
        " *                     Always present, contains a map of request properties:",
        " *                     requestUri - The request URI.",
        " *                     realm - The realm that the request relates to.",
        " *                     requestParams - A map of the request params and/or posted data.",
        " *                                     Each value is a list of one or more properties.",
        " *                                     Please note that these should be handled in accordance with OWASP best practices:",
        " *                                     https://owasp.org/www-community/vulnerabilities/Unsafe_use_of_Reflection.",
        " * clientProperties - Unmodifiable Map (5).",
        " *                    Present if the client specified in the request was identified, contains a map of client properties:",
        " *                    clientId - The client's URI for the request locale.",
        " *                    allowedGrantTypes - List of the allowed grant types (org.forgerock.oauth2.core.GrantType) for the client.",
        " *                    allowedResponseTypes - List of the allowed response types for the client.",
        " *                    allowedScopes - List of the allowed scopes for the client.",
        " *                    customProperties - A map of the custom properties of the client.",
        " *                                       Lists or maps will be included as sub-maps; for example:",
        " *                                       customMap[Key1]=Value1 will be returned as customMap -> Key1 -> Value1.",
        " *                                       To add custom properties to a client, update the Custom Properties field",
        " *                                       in AM Console > Realm Name > Applications > OAuth 2.0 > Clients > Client ID > Advanced.",
        " * identity - AMIdentity (3).",
        " *            Always present, the identity of the resource owner.",
        " * session - SSOToken (4).",
        " *           Present if the request contains the session cookie, the user's session object.",
        " * scriptName - String (primitive).",
        " *              Always present, the display name of the script.",
        " * logger - Always present, the "OAuth2Provider" debug logger instance:",
        " *          https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.",
        " *          Corresponding log files will be prefixed with: scripts.OAUTH2_ACCESS_TOKEN_MODIFICATION.",
        " * httpClient - HTTP Client (8).",
        " *              Always present, the HTTP Client instance:",
        " *              https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-http-client.html#scripting-api-global-http-client.",
        " *",
        " * Return - no value is expected, changes shall be made to the accessToken parameter directly.",
        " *",
        " * Class reference:",
        " * (1) AccessToken - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/AccessToken.html.",
        " * (3) AMIdentity - https://backstage.forgerock.com/docs/am/7/apidocs/com/sun/identity/idm/AMIdentity.html.",
        " * (4) SSOToken - https://backstage.forgerock.com/docs/am/7/apidocs/com/iplanet/sso/SSOToken.html.",
        " * (5) Map - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashMap.html,",
        " *           or https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/LinkedHashMap.html.",
        " * (6) Set - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashSet.html.",
        " * (8) Client - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/http/Client.html.",
        " */",
        "",
        "/* EXAMPLE",
        "(function () {",
        "    var frJava = JavaImporter(",
        "        org.forgerock.http.protocol.Request,",
        "        org.forgerock.http.protocol.Response",
        "    );",
        "",
        "    // Always includes this field in the token.",
        "    accessToken.setField('key1', 'value1');",
        "",
        "    // Receives and adds to the access token additional values by performing a REST call to an external service.",
        "    // WARNING: Below, you will find a reference to a third-party site, which is provided only as an example.",
        "    var uri = 'https://jsonplaceholder.typicode.com/posts';",
        "",
        "    try {",
        "        var request = new frJava.Request();",
        "",
        "        // You can chain methods that return the request object.",
        "        request.setUri(uri)",
        "            .setMethod('POST')",
        "            .setEntity(JSON.stringify({",
        "                updatedFields: {",
        "                    key2: 'value2',",
        "                    key3: 'value3'",
        "                }",
        "            }));",
        "",
        "        // You can call a method when chaining is not possible.",
        "        request.getHeaders().add('Content-Type', 'application/json; charset=UTF-8');",
        "",
        "        // Sends the request and receives the response.",
        "        var response = httpClient.send(request).getOrThrow();",
        "",
        "        // Checks if the response status is as expected.",
        "        if (response.getStatus() === org.forgerock.http.protocol.Status.CREATED) {",
        "            var result = JSON.parse(response.getEntity().getString());",
        "",
        "            // Set multiple token fields at once.",
        "            accessToken.setFields(result.updatedFields);",
        "        } else {",
        "            logger.error('Unable to obtain access token modifications. Status: ' + response.getStatus() + '. Content: ' + response.getEntity().getString());",
        "        }",
        "    } catch (e) {",
        "        logger.error('The request processing was interrupted. ' + e);",
        "",
        "        // The access token request fails with the HTTP 500 error in this case.",
        "        throw ('Unable to obtain response from: ' + uri);",
        "    }",
        "",
        "    // Adds new fields containing identity attribute values to the access token.",
        "    accessToken.setField('mail', identity.getAttribute('mail'));",
        "    accessToken.setField('phone', identity.getAttribute('telephoneNumber').toArray()[0]);",
        "",
        "    // Adds new fields containing the session property values.",
        "    // NOTE: session may not be available for non-interactive authorization grants.",
        "    if (session) {",
        "        try {",
        "            accessToken.setField('ipAddress', session.getProperty('Host'));",
        "        } catch (e) {",
        "            logger.error('Unable to retrieve session property value. ' + e);",
        "        }",
        "    }",
        "",
        "    // Removes a native field from the token entry, that was set by AM.",
        "    // WARNING: removing native fields from the token may result in loss of functionality.",
        "    // accessToken.removeTokenName()",
        "",
        "    // No return value is expected. Let it be undefined.",
        "}());",
        "*/",
      ],
    },
    "3cb43516-ae69-433a-8787-501d45db14e9": {
      "_id": "3cb43516-ae69-433a-8787-501d45db14e9",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Display sharedState, transientState, and headers.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "debug",
      "script": [
        "/* debug",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Display sharedState, transientState, and headers.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "var anchor = "anchor-".concat(generateNumericToken('xxx'));",
        "var halign = "left";",
        "var message = "<p><b>Shared State</b>:<br/>".concat(",
        "      sharedState.toString()).concat("</p>").concat(",
        "    "<p><b>Transient State</b>:<br/>").concat(",
        "      transientState.toString()).concat("</p>").concat(",
        "    "<p><b>Request Headers</b>:<br/>").concat(",
        "      requestHeaders.toString()).concat("</p>")",
        "var script = "Array.prototype.slice.call(\\n".concat(",
        "  "document.getElementsByClassName('callback-component')).forEach(\\n").concat(",
        "  "function (e) {\\n").concat(",
        "  "  var message = e.firstElementChild;\\n").concat(",
        "  "  if (message.firstChild && message.firstChild.nodeName == '#text' && message.firstChild.nodeValue.trim() == '").concat(anchor).concat("') {\\n").concat(",
        "  "    message.className = \\"text-left\\";\\n").concat(",
        "  "    message.align = \\"").concat(halign).concat("\\";\\n").concat(",
        "  "    message.innerHTML = '").concat(message).concat("';\\n").concat(",
        "  "  }\\n").concat(",
        "  "})")",
        "var fr = JavaImporter(",
        "    org.forgerock.openam.auth.node.api.Action,",
        "    javax.security.auth.callback.TextOutputCallback,",
        "    com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        ")",
        "if (message.length && callbacks.isEmpty()) {",
        "    action = fr.Action.send(",
        "        new fr.TextOutputCallback(",
        "            fr.TextOutputCallback.INFORMATION,",
        "            anchor",
        "        ),",
        "        new fr.ScriptTextOutputCallback(script)",
        "    ).build()",
        "}",
        "else {",
        "  action = fr.Action.goTo("true").build();",
        "}",
        "",
        " /*",
        "  * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "  * ",
        "  * Example:",
        "  * 'xxxxx' produces '28535'",
        "  * 'xxx-xxx' produces '432-521'",
        "  */",
        "function generateNumericToken(format) {",
        "    return format.replace(/[x]/g, function(c) {",
        "        var r = Math.random()*10|0;",
        "        var v = r;",
        "        return v.toString(10);",
        "    });",
        "}",
      ],
    },
    "3d97c436-42c0-4dd0-a571-ea6f34f752b3": {
      "_id": "3d97c436-42c0-4dd0-a571-ea6f34f752b3",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from Itsme",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Itsme Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2020-2021 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "import org.forgerock.json.JsonValue",
        "",
        "JsonValue managedUser = json(object(",
        "        field("id", rawProfile.sub),",
        "        field("displayName", rawProfile.name),",
        "        field("givenName", rawProfile.given_name),",
        "        field("familyName", rawProfile.family_name),",
        "        field("username", rawProfile.email),",
        "        field("email", rawProfile.email)))",
        "return managedUser",
      ],
    },
    "403cf226-6051-4368-8b72-9ba14f9a5140": {
      "_id": "403cf226-6051-4368-8b72-9ba14f9a5140",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from VKontakte",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "VKontakte Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "return json(object(",
        "        field("id", rawProfile.id),",
        "        field("displayName", rawProfile.first_name),",
        "        field("givenName", rawProfile.first_name),",
        "        field("familyName", rawProfile.last_name),",
        "        field("photoUrl", rawProfile.photo_50),",
        "        field("email", rawProfile.email),",
        "        field("username", rawProfile.email)))",
      ],
    },
    "41c24257-d7fc-4654-8b46-c2666dc5b56d": {
      "_id": "41c24257-d7fc-4654-8b46-c2666dc5b56d",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "set per level shared state variable",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "level",
      "script": [
        "(function () {",
        "  outcome = 'true';",
        "  var level = nodeState.get('level').asInteger();",
        "  sharedState.put('level' + level + 'Value', 'Level ' + level + ': This is a longer string value set at each level of the nested journeys. It contains an indicator in which level it was set.');",
        "}());",
      ],
    },
    "424da748-82cc-4b54-be6f-82bd64d82a74": {
      "_id": "424da748-82cc-4b54-be6f-82bd64d82a74",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from Yahoo",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Yahoo Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "return json(object(",
        "        field("id", rawProfile.sub),",
        "        field("displayName", rawProfile.name),",
        "        field("givenName", rawProfile.given_name),",
        "        field("familyName", rawProfile.family_name),",
        "        field("photoUrl", rawProfile.picture),",
        "        field("email", rawProfile.email),",
        "        field("username", rawProfile.email),",
        "        field("locale", rawProfile.locale)))",
      ],
    },
    "452d73ee-c6f3-4f4e-9dae-e75bb3886cbd": {
      "_id": "452d73ee-c6f3-4f4e-9dae-e75bb3886cbd",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Copy sharedState to transientState",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Copy to transientState",
      "script": [
        "outcome = "true";",
        "if (sharedState.get("objectAttributes")) {",
        "    transientState.put("objectAttributes", sharedState.get("objectAttributes"))",
        "}",
        "if (sharedState.get("username")) {",
        "    transientState.put("username", sharedState.get("username"))",
        "}",
        "if (sharedState.get("_id")) {",
        "    transientState.put("_id", sharedState.get("_id"))",
        "}",
      ],
    },
    "472534ec-a25f-468d-a606-3fb1935190df": {
      "_id": "472534ec-a25f-468d-a606-3fb1935190df",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from WeChat",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "WeChat Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "return json(object(",
        "        field("id", rawProfile.openid),",
        "        field("displayName", rawProfile.nickname),",
        "        field("photoUrl", rawProfile.headimgurl),",
        "        field("username", rawProfile.nickname)))",
      ],
    },
    "484e6246-dbc6-4288-97e6-54e55431402e": {
      "_id": "484e6246-dbc6-4288-97e6-54e55431402e",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from Apple",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Apple Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2021-2022 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " *",
        " * In some common default configurations, the following keys are required to be not empty:",
        " * username, givenName, familyName, email.",
        " *",
        " * From RFC4517: A value of the Directory String syntax is a string of one or more",
        " * arbitrary characters from the Universal Character Set (UCS).",
        " * A zero-length character string is not permitted.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "String email = "change@me.com"",
        "String subjectId = rawProfile.sub",
        "String firstName = " "",
        "String lastName = " "",
        "String username = subjectId",
        "String name",
        "",
        "if (rawProfile.isDefined("email") && rawProfile.email.isNotNull()){ // User can elect to not share their email",
        "    email = rawProfile.email.asString()",
        "    username = email",
        "}",
        "if (rawProfile.isDefined("name") && rawProfile.name.isNotNull()) {",
        "    if (rawProfile.name.isDefined("firstName") && rawProfile.name.firstName.isNotNull()) {",
        "        firstName = rawProfile.name.firstName.asString()",
        "    }",
        "    if (rawProfile.name.isDefined("lastName") && rawProfile.name.lastName.isNotNull()) {",
        "        lastName = rawProfile.name.lastName.asString()",
        "    }",
        "}",
        "",
        "name = (firstName?.trim() ? firstName : "") + (lastName?.trim() ? ((firstName?.trim() ? " " : "") + lastName) : "")",
        "name =  (!name?.trim()) ? " " : name",
        "",
        "return json(object(",
        "        field("id", subjectId),",
        "        field("displayName", name),",
        "        field("email", email),",
        "        field("givenName", firstName),",
        "        field("familyName", lastName),",
        "        field("username", username)))",
      ],
    },
    "4855aac0-1efd-49c0-a153-3b9aadc911a6": {
      "_id": "4855aac0-1efd-49c0-a153-3b9aadc911a6",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Populate Username From Email",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Populate Username From Email",
      "script": [
        "outcome = "true";",
        "",
        "sharedState.put("username", getSharedObjectAttribute("mail"))",
        "setSharedObjectAttribute("userName", getSharedObjectAttribute("mail"))",
        "",
        "/*",
        " * Store attributes in shared state for use with the Create/Patch Object nodes.",
        " */",
        "function setSharedObjectAttribute(name, value) {",
        "       var storage = sharedState.get("objectAttributes");",
        "    if (storage && value) {",
        "          if (storage.put) {",
        "              storage.put(name, value);",
        "        }",
        "          else {",
        "              storage[name] = value;",
        "        }",
        "    }",
        "    else if (value) {",
        "        sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "    }",
        "}",
        "",
        "/*",
        " * Read attributes in shared state for use with the Create/Patch Object nodes.",
        " */",
        "function getSharedObjectAttribute(name) {",
        "    var storage = sharedState.get("objectAttributes");",
        "    if (storage) {",
        "          if (storage.get) {",
        "            return sharedState.get("objectAttributes").get(name);",
        "        }",
        "          else {",
        "              return storage.name;",
        "        }",
        "    }",
        "    return null;",
        "}",
      ],
    },
    "48f17202-039f-4d40-b7fc-4ce380f1b929": {
      "_id": "48f17202-039f-4d40-b7fc-4ce380f1b929",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Collect all the configuration items required for the SAML2 Node to function properly.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Collect SAML2 Node Config",
      "script": [
        "/* Collect SAML2 Node Config",
        " * ",
        " * Collect all the configuration items required for the SAML2 Node to function properly.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    outcome = "true";",
        "      var config = {",
        "        "metaAlias": "/iSPAzure",",
        "        "allowCreate": false,",
        "        "sloEnabled": false,",
        "        "authnContextClassRef": [],",
        "        "authnContextDeclRef": [],",
        "        "authComparison": "EXACT",",
        "        "nameIdFormat": "urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified",",
        "        "requestBinding": "HTTP_REDIRECT",",
        "        "binding": "HTTP_POST",",
        "        "forceAuthn": false,",
        "        "idpEntityId": "https://sts.windows.net/711ffa9c-5972-4713-ace3-688c9732614a/",",
        "        "isPassive": false,",
        "        "sloRelayState": """,
        "    };",
        "      var script = "";",
        "    script += "Array.prototype.slice.call(";",
        "    script += "    document.getElementsByTagName('input')";",
        "    script += ").forEach(";",
        "    script += "    function (input,i) {";",
        "    script += "        console.log('input '+i);"",
        "    script += "        var config = JSON.parse('"+JSON.stringify(config)+"');";",
        "    script += "        var keys = Object.keys(config);";",
        "    script += "        if (input.type === 'text') {";",
        "    script += "            input.setAttribute('value', config[keys[i]]);";",
        "    script += "            input.dispatchEvent(new KeyboardEvent( 'input' , {'key':'Enter'} ));";",
        "    script += "        }";",
        "    script += "    }";",
        "    script += ");";",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "          javax.security.auth.callback.NameCallback,",
        "        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        "    )",
        "    if (callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "            new fr.NameCallback("metaAlias"),",
        "            new fr.NameCallback("allowCreate"),",
        "            new fr.NameCallback("sloEnabled"),",
        "            new fr.NameCallback("authnContextClassRef"),",
        "            new fr.NameCallback("authnContextDeclRef"),",
        "            new fr.NameCallback("authComparison"),",
        "            new fr.NameCallback("nameIdFormat"),",
        "            new fr.NameCallback("requestBinding"),",
        "            new fr.NameCallback("binding"),",
        "            new fr.NameCallback("forceAuthn"),",
        "            new fr.NameCallback("idpEntityId"),",
        "            new fr.NameCallback("isPassive"),",
        "            new fr.NameCallback("sloRelayState"),",
        "              new fr.ScriptTextOutputCallback(script)",
        "        ).build();",
        "    }",
        "    else {",
        "          config[callbacks.get(0).getPrompt()] = callbacks.get(0).getName();",
        "          config[callbacks.get(1).getPrompt()] = (callbacks.get(1).getName() === 'true');",
        "          config[callbacks.get(2).getPrompt()] = (callbacks.get(2).getName() === 'true');",
        "          config[callbacks.get(3).getPrompt()] = [callbacks.get(3).getName()];",
        "          config[callbacks.get(4).getPrompt()] = [callbacks.get(4).getName()];",
        "          config[callbacks.get(5).getPrompt()] = callbacks.get(5).getName();",
        "          config[callbacks.get(6).getPrompt()] = callbacks.get(6).getName();",
        "          config[callbacks.get(7).getPrompt()] = callbacks.get(7).getName();",
        "          config[callbacks.get(8).getPrompt()] = callbacks.get(8).getName();",
        "          config[callbacks.get(9).getPrompt()] = (callbacks.get(9).getName() === 'true');",
        "          config[callbacks.get(10).getPrompt()] = callbacks.get(10).getName();",
        "          config[callbacks.get(11).getPrompt()] = (callbacks.get(11).getName() === 'true');",
        "          config[callbacks.get(12).getPrompt()] = callbacks.get(12).getName();",
        "          nodeState.putShared("nodeConfig", config);",
        "        action = fr.Action.goTo(outcome).build();",
        "    }",
        "}());",
      ],
    },
    "4a9aefc4-be0e-4625-95c3-ee8f354bce35": {
      "_id": "4a9aefc4-be0e-4625-95c3-ee8f354bce35",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_ClearCurrentYear",
      "script": [
        "if (sharedState.containsKey('objectAttributes')) {",
        "  sharedState.get('objectAttributes').remove('currentYear');",
        "}",
        "",
        "outcome = 'True';",
        "",
      ],
    },
    "4accb4d0-56ec-4a28-a769-5275dbac3147": {
      "_id": "4accb4d0-56ec-4a28-a769-5275dbac3147",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_PasswordFixStart",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        "This is a workaround that fixes an issue with password policy.",
        "",
        "The Platform Password node attempts to validate a password by calling IDM's validateProperty action, and it uses",
        "sharedState.objectAttributes as the \`object\` property of that request payload.  If the request is missing required properties",
        "or contains properties not in the object's schema, DS will error and IDM will swallow that error, returning an empty ",
        "list of failed policies instead.",
        "",
        "This workaround provides fake values for required properties. It also ensures first/last name is in objectAttributes so the",
        ""can't contain" policy can be evaluated. This workaround is cleaned up by Admin_PasswordFixEnd.js.",
        "*/",
        "",
        "// Capture existing object attributes so we can restore them later",
        "if (sharedState.containsKey('objectAttributes')) {",
        "  sharedState.put('originalObjectAttributes', sharedState.get('objectAttributes'));",
        "}",
        "",
        "// Define the object to use for policy evaluation",
        "var policyObject = {",
        "  givenName: '',",
        "  sn: '',",
        "  groups: ['fake'],",
        "  inviteDate: 'fake'",
        "};",
        "",
        "// If we've loaded the admin object, add first/last name to support",
        "// evaluation of the full policy",
        "if (sharedState.containsKey('adminObject')) {",
        "  var adminObject = sharedState.get('adminObject');",
        "  policyObject.givenName = adminObject.get('givenName');",
        "  policyObject.sn = adminObject.get('sn');",
        "}",
        "",
        "// Replace objectAttributes with our policy object",
        "sharedState.put('objectAttributes', policyObject);",
        "",
        "outcome = 'True';",
        "",
      ],
    },
    "4c7bb7bb-c5d6-47ac-92dc-256fb8121fa9": {
      "_id": "4c7bb7bb-c5d6-47ac-92dc-256fb8121fa9",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_MfaRequiredCheck",
      "script": [
        "if ("false" == "true") {",
        "  outcome = "Required";",
        "} else {",
        "  outcome = "Optional";",
        "}",
      ],
    },
    "4ee5b182-1b09-45cc-97a9-0e609f0a2915": {
      "_id": "4ee5b182-1b09-45cc-97a9-0e609f0a2915",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Resend OTP Option",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Resend OTP Option",
      "script": [
        "/* CResend OTP Option",
        " *",
        " * Author: jon.knight@forgerock.com, volker.scheuber@forgerock.com",
        " * ",
        " * Collect OTP and validate the collected OTP. Also offer a resend option.",
        " * Return "true" if collected OTP is valid, "false" if collected OTP is invalid, ",
        " * and resend if the user selected the resend button.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * - false",
        " * - resend",
        " */",
        "(function () {",
        "  // how long until the "resend" button becomes enabled.",
        "  DELAY=20;",
        "  ",
        "  // how long (in seconds) should the OTP be accepted as valid",
        "  OTP_TTL = 30;",
        "",
        "  var fr = JavaImporter(",
        "      org.forgerock.openam.auth.node.api.Action,",
        "      javax.security.auth.callback.NameCallback,",
        "      com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        "  )",
        "",
        "  function createScript() {",
        "      return String(" \\n\\",
        "          var COUNT = " + DELAY + "; \\n\\",
        "          function go(obs) { \\n\\",
        "              const p = document.querySelectorAll('input[data-vv-as=\\"One Time Passcode\\"]')[0]; \\n\\",
        "              if (p) { \\n\\",
        "                  var b = document.createElement('button'); \\n\\",
        "                  b.id = 'resendButton'; \\n\\",
        "                  b.classList.add(\\"btn\\", \\"mt-3\\", \\"btn-secondary\\", \\"btn-sm\\"); \\n\\",
        "                  b.onclick = function() { p.value='___RESEND___'; p.dispatchEvent(new Event('input')); }; \\n\\",
        "                  b.innerHTML = 'Resend Code ... ' + COUNT + 's'; \\n\\",
        "                  b.disabled = true; \\n\\",
        "                  p.parentNode.insertBefore(b, p.nextSibling); \\n\\",
        "                  var t = setInterval(function() { \\n\\",
        "                      if (COUNT == 1) { \\n\\",
        "                          clearInterval(t); \\n\\",
        "                          b.disabled = false; \\n\\",
        "                          b.innerHTML = 'Resend Code'; \\n\\",
        "                      } else { \\n\\",
        "                          COUNT--; \\n\\",
        "                          b.innerHTML = 'Resend Code ... ' + COUNT + 's'; \\n\\",
        "                      } \\n\\",
        "                  }, 1000 ); \\n\\",
        "                  if (obs) obs.disconnect(); \\n\\",
        "                  return; \\n\\",
        "              } \\n\\",
        "          } \\n\\",
        "          if (document.querySelectorAll('input[data-vv-as=\\"One Time Passcode\\"]')[0]) go(); \\n\\",
        "          else { \\n\\",
        "              const observer = new MutationObserver((mutations, obs) => { go(obs); }); \\n\\",
        "              observer.observe(document, { childList: true, subtree: true }); \\n\\",
        "          } \\n\\",
        "      ");",
        "  }",
        "",
        "  if (callbacks.isEmpty()) {",
        "      action = fr.Action.send(",
        "          new fr.ScriptTextOutputCallback(createScript()),",
        "          new fr.NameCallback("One Time Passcode")",
        "      ).build()",
        "  } else {",
        "      var otpTimestamp = Math.floor(new java.util.Date().getTime() / 1000);",
        "      var otp = callbacks.get(1).getName();",
        "      if (otp === "___RESEND___") {",
        "          action = fr.Action.goTo("resend").build();",
        "      } else {",
        "          var sentOtp = sharedState.get("oneTimePassword");",
        "          var sentOtpTimestamp = sharedState.get("oneTimePasswordTimestamp");",
        "          if (sentOtp == otp && otpTimestamp - OTP_TTL >= sentOtpTimestamp) {",
        "              action = fr.Action.goTo("true").build();",
        "            }",
        "          else {",
        "            action = fr.Action.goTo("false").build();",
        "          }",
        "      }",
        "  }",
        "}());",
      ],
    },
    "4f1273be-9c52-4879-bbe9-9a47068aeed9": {
      "_id": "4f1273be-9c52-4879-bbe9-9a47068aeed9",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Unverified caller message",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Twilio IVR: Unverified Caller Message",
      "script": [
        "/* Twilio IVR: Unverified Caller Message",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * ",
        " * Depending on the amount of data collected through callbacks and how many of the callParams",
        " * you activate below, you will need to change your authentication session from JWT to CTS or",
        " * Memory.",
        " */",
        "outcome = "true";",
        "",
        "/* Begin Configuration",
        " */",
        "",
        "// Build out the full message",
        "var message = "That doesn't match our records. Let us try this another way.";",
        "",
        "/* End Configuration",
        " */",
        "",
        "var fr = JavaImporter(",
        "      org.forgerock.openam.auth.node.api,",
        "      javax.security.auth.callback.TextOutputCallback",
        ");",
        "  ",
        "with (fr) {",
        "      if (callbacks.isEmpty()) {",
        "        var output = new TextOutputCallback(TextOutputCallback.INFORMATION, message);",
        "        action = Action.send(output).build();",
        "      } ",
        "      else {",
        "        action = Action.goTo(outcome).build();",
        "      }",
        "}",
      ],
    },
    "50cde102-d4b6-44c4-9ba7-8564af05ae08": {
      "_id": "50cde102-d4b6-44c4-9ba7-8564af05ae08",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Select and apply theme from query param in the request URL.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Select Theme from URL",
      "script": [
        "/* Select Theme from URL",
        " * ",
        " * Select and apply theme from query param in the request URL.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "      outcome = "true";",
        "      var theme = "";",
        "      if (requestParameters.get("themeId")) {",
        "          theme = requestParameters.get("themeId").get(0);",
        "    }",
        "",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "        org.forgerock.openam.authentication.callbacks.PollingWaitCallback",
        "    )",
        "    if (theme && callbacks.isEmpty()) {",
        "        var stage = "themeId="+theme;",
        "        action = fr.Action.send(",
        "              new fr.PollingWaitCallback("100", "Please wait ...")",
        "        ).withStage(stage).build();",
        "    } else {",
        "          action = fr.Action.goTo(outcome).build();",
        "    }",
        "}());",
      ],
    },
    "53c50dbd-5331-4739-bea1-4c5e9bf553f2": {
      "_id": "53c50dbd-5331-4739-bea1-4c5e9bf553f2",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Welcome message",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Twilio IVR: Welcome Message",
      "script": [
        "/* Twilio IVR: Welcome Message",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * ",
        " * Depending on the amount of data collected through callbacks and how many of the callParams",
        " * you activate below, you will need to change your authentication session from JWT to CTS or",
        " * Memory.",
        " */",
        "logger.warning("Twilio IVR: Welcome Message: start");",
        "outcome = "true";",
        "",
        "/* Begin Configuration",
        " */",
        "",
        "// Build out the full message",
        "var message = "Thank you for calling ForgeRock Identity Cloud!";",
        "",
        "/* End Configuration",
        " */",
        "",
        "var fr = JavaImporter(",
        "      org.forgerock.openam.auth.node.api,",
        "      javax.security.auth.callback.TextOutputCallback",
        ");",
        "  ",
        "with (fr) {",
        "      if (callbacks.isEmpty()) {",
        "        var output = new TextOutputCallback(TextOutputCallback.INFORMATION, message);",
        "        action = Action.send(output).build();",
        "      } ",
        "      else {",
        "        logger.warning("Twilio IVR: Welcome Message: finish [outcome=".concat(outcome).concat("]"));",
        "        action = Action.goTo(outcome).build();",
        "      }",
        "}",
      ],
    },
    "5561a45f-bf00-4ec5-bab4-f069bac9a38b": {
      "_id": "5561a45f-bf00-4ec5-bab4-f069bac9a38b",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Copy an OTP generated by the "HOTP Generator" node to the IDM profile shared state so it can be patched to the user profile.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "CopyOTPToObjectAttributes",
      "script": [
        "/* CopyOTPToObjectAttributes",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Copy an OTP generated by the "HOTP Generator" node to the IDM profile ",
        " * shared state so it can be patched to the user profile.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "if (sharedState.get("objectAttributes")) {",
        "    sharedState.get("objectAttributes").put("description", sharedState.get("oneTimePassword"))",
        "}",
        "else {",
        "    sharedState.put("objectAttributes", {description: sharedState.get("oneTimePassword")});",
        "}",
        "outcome = "true";",
      ],
    },
    "57807349-630f-496a-bccb-ea1011b8e945": {
      "_id": "57807349-630f-496a-bccb-ea1011b8e945",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Extract username, password, and OTP from request headers and put them in shared state for validation.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "MobileOTP: Extract Username, Password, OTP",
      "script": [
        "logger.warning("MobileOTP: Extract Username, Password, OTP: start");",
        "",
        "/*",
        " * BEGIN SCRIPT CONFIGURATION",
        " */",
        "var USERNAME_HEADER_NAME = "X-OpenAM-Username";",
        "var PASSWORD_HEADER_NAME = "X-OpenAM-Password";",
        "var OTP_HEADER_NAME = "X-OpenAM-MobileOTP";",
        "/*",
        " * END SCRIPT CONFIGURATION",
        " */",
        "",
        "outcome = "false";",
        "",
        "var username = getHeader(USERNAME_HEADER_NAME) || null;",
        "var password = getHeader(PASSWORD_HEADER_NAME) || null;",
        "var mobileOTP = getHeader(OTP_HEADER_NAME) || null;",
        "",
        "if (username && password && mobileOTP) {",
        "      sharedState.put("username", username);",
        "      transientState.put("password", password);",
        "      transientState.put("mobileOTP", mobileOTP);",
        "    outcome = "true";",
        "}",
        "",
        "logger.warning("MobileOTP: Extract Username, Password, OTP: finish [outcome=".concat(outcome).concat("]"));",
        "",
        "/*",
        " * Returns the value of the requested header",
        " */",
        "function getHeader(headerName) {",
        "      if (requestHeaders.get(headerName) && requestHeaders.get(headerName).get(0)) {",
        "        return requestHeaders.get(headerName).get(0).toString();",
        "    }",
        "      return null;",
        "}",
      ],
    },
    "58258c2d-46f3-4811-85c4-ea1476dd9cf4": {
      "_id": "58258c2d-46f3-4811-85c4-ea1476dd9cf4",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Service Account - Cluster Internal Requests Only",
      "script": [
        "",
        "try {",
        "  var clientIpAddresses = requestHeaders.get(new java.lang.String('x-forwarded-for'));",
        "  if (!clientIpAddresses) {",
        "    logger.message('No forwarded header; internal cluster request');",
        "    outcome = 'True'",
        "  } else {",
        "    logger.message('Forwarded header {}', clientIpAddresses);",
        "    outcome = 'False';",
        "  }",
        "} catch (e) {",
        "  logger.error('Service Account - Cluster Internal Requests Only - failed deducing header');",
        "  logger.error(e);",
        "  outcome = 'Error';",
        "}",
      ],
    },
    "58c824ae-84ed-4724-82cd-db128fc3f6c": {
      "_id": "58c824ae-84ed-4724-82cd-db128fc3f6c",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Converts a normalized social profile into a managed user",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Normalized Profile to Managed User",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "import org.forgerock.json.JsonValue",
        "",
        "JsonValue managedUser = json(object(",
        "        field("givenName", normalizedProfile.givenName),",
        "        field("sn", normalizedProfile.familyName),",
        "        field("mail", normalizedProfile.email),",
        "        field("userName", normalizedProfile.username)))",
        "",
        "if (normalizedProfile.postalAddress.isNotNull()) managedUser.put("postalAddress", normalizedProfile.postalAddress)",
        "if (normalizedProfile.addressLocality.isNotNull()) managedUser.put("city", normalizedProfile.addressLocality)",
        "if (normalizedProfile.addressRegion.isNotNull()) managedUser.put("stateProvince", normalizedProfile.addressRegion)",
        "if (normalizedProfile.postalCode.isNotNull()) managedUser.put("postalCode", normalizedProfile.postalCode)",
        "if (normalizedProfile.country.isNotNull()) managedUser.put("country", normalizedProfile.country)",
        "if (normalizedProfile.phone.isNotNull()) managedUser.put("telephoneNumber", normalizedProfile.phone)",
        "",
        "// if the givenName and familyName is null or empty",
        "// then add a boolean flag to the shared state to indicate names are not present",
        "// this could be used elsewhere",
        "// for eg. this could be used in a scripted decision node to by-pass patching",
        "// the user object with blank values when givenName  and familyName is not present",
        "boolean noGivenName = normalizedProfile.givenName.isNull() || (!normalizedProfile.givenName.asString()?.trim())",
        "boolean noFamilyName = normalizedProfile.familyName.isNull() || (!normalizedProfile.familyName.asString()?.trim())",
        "sharedState.put("nameEmptyOrNull", noGivenName && noFamilyName)",
        "",
        "return managedUser",
        "",
      ],
    },
    "58d29080-4563-480b-89bb-1e7719776a21": {
      "_id": "58d29080-4563-480b-89bb-1e7719776a21",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from Google",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Google Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "return json(object(",
        "        field("id", rawProfile.sub),",
        "        field("displayName", rawProfile.name),",
        "        field("givenName", rawProfile.given_name),",
        "        field("familyName", rawProfile.family_name),",
        "        field("photoUrl", rawProfile.picture),",
        "        field("email", rawProfile.email),",
        "        field("username", rawProfile.email),",
        "        field("locale", rawProfile.locale)))",
      ],
    },
    "5b29c5b7-b161-4a42-a41f-d6c85316b951": {
      "_id": "5b29c5b7-b161-4a42-a41f-d6c85316b951",
      "context": "SAML2_IDP_ADAPTER",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Saml2 IDP Adapter Script",
      "script": [
        "/*",
        " * Copyright 2021 ForgeRock AS. All Rights Reserved",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        " * The script has these top level functions that could be executed during a SAML2 flow.",
        " *      - preSingleSignOn",
        " *      - preAuthentication",
        " *      - preSendResponse",
        " *      - preSignResponse",
        " *      - preSendFailureResponse",
        " *",
        " * Please see the javadoc for the interface definition and more information about these methods.",
        " * https://backstage.forgerock.com/docs/am/7.2/apidocs/com/sun/identity/saml2/plugins/SAML2IdentityProviderAdapter.html",
        " * Note that the initialize method is not supported in the scripts.",
        " *",
        " * Defined variables. Check the documentation on the respective functions for the variables available to it.",
        " *",
        " * hostedEntityId - String",
        " *     Entity ID for the hosted IDP",
        " * realm - String",
        " *     Realm of the hosted IDP",
        " * idpAdapterScriptHelper - IdpAdapterScriptHelper (1)",
        " *     An instance of IdpAdapterScriptHelper containing helper methods. See Javadoc for more details.",
        " * request - HttpServletRequest (2)",
        " *     Servlet request object",
        " * response - HttpServletResponse (3)",
        " *     Servlet response object",
        " * authnRequest - AuthnRequest (4)",
        " *     The original authentication request sent from SP",
        " * reqId - String",
        " *     The id to use for continuation of processing if the adapter redirects",
        " * res - Response (5)",
        " *     The SAML Response",
        " * session - SSOToken (6)",
        " *     The single sign-on session. The reference type of this is Object and would need to be casted to SSOToken.",
        " * relayState - String",
        " *     The relayState that will be used in the redirect",
        " * faultCode - String",
        " *     the fault code that will be returned in the SAML response",
        " * faultDetail - String",
        " *     the fault detail that will be returned in the SAML response",
        " * logger - Logger instance",
        " *     https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.",
        " *     Corresponding log files will be prefixed with: scripts.<script name>",
        " *",
        " * Throws SAML2Exception (7):",
        " *     for any exceptions occurring in the adapter. The federation process will continue",
        " *",
        " * Class reference:",
        " * (1) idpAdapterScriptHelper - https://backstage.forgerock.com/docs/am/7.2/apidocs/com/sun/identity/saml2/plugins/scripted/IdpAdapterScriptHelper.html.",
        " * (2) HttpServletRequest - https://tomcat.apache.org/tomcat-7.0-doc/servletapi/javax/servlet/http/HttpServletRequest.html.",
        " * (3) HttpServletResponse - https://tomcat.apache.org/tomcat-7.0-doc/servletapi/javax/servlet/http/HttpServletResponse.html.",
        " * (4) AuthnRequest - https://backstage.forgerock.com/docs/am/7.2/apidocs/com/sun/identity/saml2/protocol/AuthnRequest.html.",
        " * (5) Response - https://backstage.forgerock.com/docs/am/7.2/apidocs/com/sun/identity/saml2/protocol/Response.html.",
        " * (6) SSOToken - https://backstage.forgerock.com/docs/am/7.2/apidocs/com/iplanet/sso/SSOToken.html.",
        " * (7) SAML2Exception - https://backstage.forgerock.com/docs/am/7.2/apidocs/com/sun/identity/saml2/common/SAML2Exception.html.",
        " */",
        "",
        "/*",
        " * Template/default script for SAML2 IDP Adapter scripted plugin.",
        " */",
        "",
        "/*",
        " * Available variables for preSingleSignOn:",
        " *     hostedEntityId",
        " *     realm",
        " *     idpAdapterScriptHelper",
        " *     request",
        " *     authnRequest",
        " *     response",
        " *     reqId",
        " *     logger",
        " *",
        " * Return - true if browser redirection is happening after processing, false otherwise. Default to false.",
        " */",
        "function preSingleSignOn () {",
        "    return false;",
        "}",
        "",
        "/*",
        " * Available variables for preAuthentication:",
        " *     hostedEntityId",
        " *     realm",
        " *     idpAdapterScriptHelper",
        " *     request",
        " *     authnRequest",
        " *     response",
        " *     reqId",
        " *     session",
        " *     relayState",
        " *     logger",
        " *",
        " * Return - true if browser redirection is happening after processing, false otherwise. Default to false.",
        " */",
        "function preAuthentication () {",
        "    return false;",
        "}",
        "",
        "/*",
        " * Available variables for preSendResponse:",
        " *     hostedEntityId",
        " *     realm",
        " *     idpAdapterScriptHelper",
        " *     request",
        " *     authnRequest",
        " *     response",
        " *     reqId",
        " *     session",
        " *     relayState",
        " *     logger",
        " *",
        " * Return - true if browser redirection happened after processing, false otherwise. Default to false.",
        " */",
        "function preSendResponse () {",
        "    return false;",
        "}",
        "",
        "/*",
        " * Available variables for preSignResponse:",
        " *     hostedEntityId",
        " *     realm",
        " *     idpAdapterScriptHelper",
        " *     request",
        " *     authnRequest",
        " *     session",
        " *     relayState",
        " *     res",
        " *     logger",
        " */",
        "function preSignResponse () {",
        "}",
        "",
        "/*",
        " * Available variables for preSendFailureResponse:",
        " *     hostedEntityId",
        " *     realm",
        " *     idpAdapterScriptHelper",
        " *     request",
        " *     response",
        " *     faultCode",
        " *     faultDetail",
        " *     logger",
        " */",
        "function preSendFailureResponse () {",
        "}",
      ],
    },
    "5b3b2c47-0248-46f4-8a1c-8a495d249037": {
      "_id": "5b3b2c47-0248-46f4-8a1c-8a495d249037",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Save/restore perpetrator",
      "script": [
        "outcome = "true";",
        "if (sharedState.get("perpetrator"))",
        "{",
        "  sharedState.put("username", sharedState.get("perpetrator"));",
        "//  if (sharedState.get("objectAttributes")) {",
        "//    sharedState.remove("objectAttributes");",
        "//  }",
        "  sharedState.put("objectAttributes", {});",
        "}",
        "else",
        "{",
        "  sharedState.put("perpetrator", sharedState.get("username"));",
        "  if (sharedState.get("objectAttributes") && ",
        "      sharedState.get("objectAttributes").get("userName")) {",
        "    sharedState.get("objectAttributes").remove("userName");",
        "  }",
        "}",
      ],
    },
    "5b553f58-16bd-42b7-a782-4a981a66dbd4": {
      "_id": "5b553f58-16bd-42b7-a782-4a981a66dbd4",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Branch based on the IDP setting.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Routed IDP Persist Decision",
      "script": [
        "/* Routed IDP Persist Decision",
        " * ",
        " * Branch based on the IDP setting.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * - false",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "      logger.message("Routed IDP Persist Decision: Start");",
        "      outcome = "false";",
        "      var routedIDP = sharedState.get("routedIDPs").get(0);",
        "      if (routedIDP) {",
        "        outcome = "".concat(routedIDP.get("idpPersist"));",
        "    }",
        "      logger.message("Routed IDP Persist Decision: Done [outcome={}]", outcome);",
        "}());",
      ],
    },
    "5bbdaeff-ddee-44b9-b608-8d413d7d65a6": {
      "_id": "5bbdaeff-ddee-44b9-b608-8d413d7d65a6",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Check if mode has already been set.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "mode",
      "script": [
        "/* mode",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Collect mode if not already set and set outcome to mode.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - 'shared and level'",
        " * - 'shared only'",
        " * - 'level only'",
        " * - 'none'",
        " */",
        "(function () {",
        "  var mode = nodeState.get('mode');",
        "  if (mode) {",
        "    outcome = mode.asString();",
        "    var level = nodeState.get('level').asInteger() + 1;",
        "    logger.error('mode: mode=' + mode.asString() + ', level=' + level);",
        "    sharedState.put('level', level);",
        "  }",
        "  else {",
        "    var choices = ['shared and level', 'shared only', 'level only', 'none'];",
        "  ",
        "    var fr = JavaImporter(",
        "      org.forgerock.openam.auth.node.api.Action,",
        "      javax.security.auth.callback.ChoiceCallback",
        "    )",
        "",
        "    if (callbacks.isEmpty()) {",
        "      action = fr.Action.send([",
        "        new fr.ChoiceCallback('Choose test mode', choices, 0, false)",
        "      ]).build();",
        "    } else {",
        "      var choice = parseInt(callbacks.get(0).getSelectedIndexes()[0]);",
        "      nodeState.putShared('mode', choices[choice]);",
        "      nodeState.putShared('level', 0);",
        "      action = fr.Action.goTo(choices[choice]).build();",
        "    }",
        "  }",
        "}());",
      ],
    },
    "5dbd53c6-67ff-4a43-84c3-90c5cf5da35a": {
      "_id": "5dbd53c6-67ff-4a43-84c3-90c5cf5da35a",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Return TextOutputCallback indicating the provided OTP was valid.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "OTP Valid",
      "script": [
        "/* OTP Valid",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Return TextOutputCallback indicating the provided OTP was valid.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "outcome = "true";",
        "var fr = JavaImporter(",
        "    org.forgerock.openam.auth.node.api.Action,",
        "    javax.security.auth.callback.TextOutputCallback",
        ")",
        "if (callbacks.isEmpty()) {",
        "    action = fr.Action.send(",
        "        new fr.TextOutputCallback(",
        "            fr.TextOutputCallback.INFORMATION,",
        "            "VALID"",
        "        )",
        "    ).build()",
        "}",
        "else {",
        "  action = fr.Action.goTo(outcome).build();",
        "}",
      ],
    },
    "5e68fee3-047d-4fff-8e99-89fb5908f068": {
      "_id": "5e68fee3-047d-4fff-8e99-89fb5908f068",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_ForgotUsernameMailCheck",
      "script": [
        "var fr = new JavaImporter(",
        "  org.forgerock.openam.auth.nodes,",
        "  org.forgerock.guice.core,",
        "  java.util.HashMap",
        ");",
        "",
        "// This confirms the Identify Existing User node was able to find the",
        "// admin, otherwise we remove the mail attribute so no email can be sent",
        "with (fr) {",
        "  try {",
        "",
        "    var objAttrs = sharedState.get('objectAttributes') || new HashMap();",
        "    var username = objAttrs.get('userName');",
        "    outcome = username ? 'Valid' : 'Invalid';",
        "    if (username) {",
        "      outcome = 'Valid';",
        "    } else {",
        "      objAttrs.remove('mail');",
        "      sharedState.put('objectAttributes', objAttrs);",
        "      outcome = 'Invalid';",
        "    }",
        "",
        "    logger.message('Admin_ForgotUsernameMailCheck: ' + outcome);",
        "",
        "  } catch (e) {",
        "",
        "    logger.error('Admin_ForgotUsernameMailCheck: Failed to determine mail validity');",
        "    logger.error(e);",
        "    outcome = 'Error';",
        "",
        "  }",
        "}",
      ],
    },
    "5e854779-6ec1-4c39-aeba-0477e0986646": {
      "_id": "5e854779-6ec1-4c39-aeba-0477e0986646",
      "context": "CONFIG_PROVIDER_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Default global script for Config Provider",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Config Provider",
      "script": [
        "/*",
        " * Copyright 2021 ForgeRock AS. All Rights Reserved",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/**",
        " * The following script is a simplified template for understanding how to build",
        " * up a config Map object with custom values. The Config Provider Node will then",
        " * provide this config Map to the desired node type. It is important that the Map",
        " * you build here is named 'config'.",
        " *",
        " * Defined variables:",
        " *",
        " * nodeState - Node State (1)",
        " *           Always present, this represents the current values stored in the node state.",
        " *",
        " * idRepository - Profile Data (2)",
        " *           Always present, a repository to retrieve user information.",
        " *",
        " * secrets - Credentials and Secrets (3)",
        " *           Always present, an interface to access the Secrets API from a scripting context.",
        " *",
        " * requestHeaders (4) - Map (5)",
        " *           Always present, an object that provides methods for accessing headers in the login request.",
        " *",
        " * logger - Debug Logging (6)",
        " *          Always present, the debug logger instance.",
        " *",
        " * httpClient - HTTP Client (7)",
        " *          Always present, the HTTP client that can be used to make external HTTP requests.",
        " *",
        " * realm - String (primitive).",
        " *          Always present, the name of the realm the user is authenticating to.",
        " *",
        " * existingSession - Map<String, String> (5)",
        " *          Present if the request contains the session cookie, the user's session object. The returned map from",
        " *          SSOToken.getProperties() (8)",
        " *",
        " * requestParameters - Map (5)",
        " *          Always present, the object that contains the authentication request parameters.",
        " *",
        " *",
        " * Outputs:",
        " *",
        " * config - Map (5)",
        " *           Define and fill a Map object named 'config' with custom values, this will define the configuration for the",
        " *           associated node selected in the ConfigProviderNode.",
        " *",
        " * Reference:",
        " * (1) Node State - https://backstage.forgerock.com/docs/idcloud-am/latest/authentication-guide/scripting-api-node.html#scripting-api-node-nodeState",
        " * (2) Profile Data - https://backstage.forgerock.com/docs/am/7.1/authentication-guide/scripting-api-node.html#scripting-api-node-id-repo",
        " * (3) Credentials and Secrets - https://backstage.forgerock.com/docs/am/7.1/authentication-guide/scripting-api-node.html#scripting-api-authn-secrets",
        " * (4) Request Headers - https://backstage.forgerock.com/docs/am/7/authentication-guide/scripting-api-node.html#scripting-api-node-requestHeaders.",
        " * (5) Map - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/Map.html",
        " * (6) Debug Logging - https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.",
        " * (7) HTTP Client - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/http/Client.html.",
        " * (8) SSOToken - https://backstage.forgerock.com/docs/am/7/apidocs/com/iplanet/sso/SSOToken.html.",
        " */",
        "",
        "config = nodeState.get('nodeConfig').asMap();",
      ],
    },
    "6325cf19-a49b-471e-8d26-7e4df76df0e2": {
      "_id": "6325cf19-a49b-471e-8d26-7e4df76df0e2",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Normalizes raw profile data from GitHub",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Okta Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2022 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "logger.warning("Okta rawProfile: "+rawProfile)",
        "",
        "return json(object(",
        "        field("id", rawProfile.id),",
        "        field("displayName", rawProfile.name),",
        "        field("givenName", rawProfile.first_name),",
        "        field("familyName", rawProfile.last_name),",
        "        field("photoUrl", rawProfile.picture.data.url),",
        "        field("email", rawProfile.email),",
        "        field("username", rawProfile.preferred_username)))",
      ],
    },
    "638c865e-d393-4503-a517-535b9c74e010": {
      "_id": "638c865e-d393-4503-a517-535b9c74e010",
      "context": "CONFIG_PROVIDER_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "CP-InnerTreeEvaluator-static-inner1",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "CP-ITE-static-inner1",
      "script": [
        "/*",
        " * Copyright 2021 ForgeRock AS. All Rights Reserved",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/**",
        " * The following script is a simplified template for understanding how to build",
        " * up a config Map object with custom values. The Config Provider Node will then",
        " * provide this config Map to the desired node type. It is important that the Map",
        " * you build here is named 'config'.",
        " *",
        " * Defined variables:",
        " *",
        " * nodeState - Node State (1)",
        " *           Always present, this represents the current values stored in the node state.",
        " *",
        " * idRepository - Profile Data (2)",
        " *           Always present, a repository to retrieve user information.",
        " *",
        " * secrets - Credentials and Secrets (3)",
        " *           Always present, an interface to access the Secrets API from a scripting context.",
        " *",
        " * requestHeaders (4) - Map (5)",
        " *           Always present, an object that provides methods for accessing headers in the login request.",
        " *",
        " * logger - Debug Logging (6)",
        " *          Always present, the debug logger instance.",
        " *",
        " * httpClient - HTTP Client (7)",
        " *          Always present, the HTTP client that can be used to make external HTTP requests.",
        " *",
        " * realm - String (primitive).",
        " *          Always present, the name of the realm the user is authenticating to.",
        " *",
        " * existingSession - Map<String, String> (5)",
        " *          Present if the request contains the session cookie, the user's session object. The returned map from",
        " *          SSOToken.getProperties() (8)",
        " *",
        " * requestParameters - Map (5)",
        " *          Always present, the object that contains the authentication request parameters.",
        " *",
        " *",
        " * Outputs:",
        " *",
        " * config - Map (5)",
        " *           Define and fill a Map object named 'config' with custom values, this will define the configuration for the",
        " *           associated node selected in the ConfigProviderNode.",
        " *",
        " * Reference:",
        " * (1) Node State - https://backstage.forgerock.com/docs/idcloud-am/latest/authentication-guide/scripting-api-node.html#scripting-api-node-nodeState",
        " * (2) Profile Data - https://backstage.forgerock.com/docs/am/7.1/authentication-guide/scripting-api-node.html#scripting-api-node-id-repo",
        " * (3) Credentials and Secrets - https://backstage.forgerock.com/docs/am/7.1/authentication-guide/scripting-api-node.html#scripting-api-authn-secrets",
        " * (4) Request Headers - https://backstage.forgerock.com/docs/am/7/authentication-guide/scripting-api-node.html#scripting-api-node-requestHeaders.",
        " * (5) Map - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/Map.html",
        " * (6) Debug Logging - https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.",
        " * (7) HTTP Client - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/http/Client.html.",
        " * (8) SSOToken - https://backstage.forgerock.com/docs/am/7/apidocs/com/iplanet/sso/SSOToken.html.",
        " */",
        "",
        "config = {",
        "  tree: 'inner1'",
        "};",
      ],
    },
    "653b70b0-a23d-403a-933b-911371cf84c0": {
      "_id": "653b70b0-a23d-403a-933b-911371cf84c0",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Returns privacy policy collection",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_PrivacyPolicy",
      "script": [
        "var jurisdictions = [",
        "  {",
        "    name: 'Australia',",
        "    url: 'https://backstage.forgerock.com/knowledge/identity-cloud/article/a92472578'",
        "  },",
        "  {",
        "    name: 'Brazil',",
        "    url: 'https://www.forgerock.com/privacy-policy'",
        "  },",
        "  {",
        "    name: 'California',",
        "    url: 'https://backstage.forgerock.com/knowledge/identity-cloud/article/a67552843'",
        "  },",
        "  {",
        "    name: 'Canada',",
        "    url: 'https://backstage.forgerock.com/knowledge/identity-cloud/article/a92472578'",
        "  },",
        "  {",
        "    name: 'European Union',",
        "    url: 'https://backstage.forgerock.com/knowledge/identity-cloud/article/a28580828'",
        "  },",
        "  {",
        "    name: 'Hong Kong',",
        "    url: 'https://www.forgerock.com/resources/view/109827462/overview/identity-cloud-privacy.pdf'",
        "  },",
        "  {",
        "    name: 'Indonesia',",
        "    url: 'https://www.forgerock.com/resources/view/109827462/overview/identity-cloud-privacy.pdf'",
        "  },",
        "  {",
        "    name: 'New Zealand',",
        "    url: 'https://backstage.forgerock.com/knowledge/identity-cloud/article/a92472578'",
        "  },",
        "  {",
        "    name: 'Singapore',",
        "    url: 'https://backstage.forgerock.com/knowledge/identity-cloud/article/a92472578'",
        "  },",
        "  {",
        "    name: 'United Kingdom',",
        "    url: 'https://backstage.forgerock.com/knowledge/identity-cloud/article/a28580828'",
        "  },",
        "  {",
        "    name: 'United States',",
        "    url: 'https://www.forgerock.com/privacy-policy'",
        "  },",
        "  {",
        "    name: 'Rest of the World',",
        "    url: 'https://www.forgerock.com/privacy-policy'",
        "  }",
        "];",
        "",
        "var token = generateNumericToken('xxx');",
        "var inputId = 'jurisdiction-input-'.concat(token);",
        "var selectId = 'jurisdiction-select-'.concat(token);",
        "",
        "// Build the header and instructions",
        "var message = "<h2 class='h2'>Accept Privacy Policy</h2><div style='margin-bottom:1em'>Select your region of residence to review the applicable privacy policy.</div>";",
        "",
        "// Build the jurisdiction dropdown",
        "var dropdown = "<select id='".concat(selectId).concat("' class='custom-select' onchange='document._onJurisdictionChange()'><option value=''>Region of residence</option>");",
        "for (var i = 0; i < jurisdictions.length; i++) {",
        "  var j = jurisdictions[i];",
        "  dropdown = dropdown.concat("<option value='").concat(j.name).concat("' data-url='").concat(j.url).concat("'>").concat(j.name).concat("</option>");",
        "}",
        "dropdown = dropdown.concat("</select>");",
        "",
        "// Build the confirmation checkbox with policy link",
        "var confirm = "<div id='confirm-wrapper' class='custom-control custom-checkbox' style='padding:1rem;visibility:hidden'>".concat(",
        "  "<input id='confirm-check' type='checkbox' class='custom-control-input' onchange='document._setNextButton()'>").concat(",
        "  "<label class='custom-control-label' for='confirm-check'>").concat(",
        "  "I agree to ForgeRock's <a id='policy-link' target=_blank href='" + jurisdictions[0].url + "'>Privacy Policy</a>").concat(",
        "  "</label>").concat(",
        ""</div>");",
        "",
        "var html = message + dropdown + confirm;",
        "",
        "var script =",
        "  'document._onJurisdictionChange = function() {'.concat(",
        "  '  var jurisdiction = getJurisdiction();').concat(",
        "  '  console.log(jurisdiction);').concat(",
        "  '  if (jurisdiction) {').concat(",
        "  '    setPolicyLink(jurisdiction.url);').concat(",
        "  '    setJurisdiction(jurisdiction.name);').concat(",
        "  '    setConfirmVisibility(true);').concat(",
        "  '  } else {').concat(",
        "  '    setJurisdiction("");').concat(",
        "  '    setConfirmVisibility(false);').concat(",
        "  '  }').concat(",
        "  '  document._setNextButton();').concat(",
        "  '};').concat(",
        "    ",
        "  'document._setNextButton = function() {').concat(",
        "  '  var jurisdiction = getJurisdiction();').concat(",
        "  '  var cb = getCheckbox();').concat(",
        "  '  loginHelpers.disableNextButton(!jurisdiction || !cb.checked);').concat(",
        "  '};').concat(",
        "    ",
        "  'var getJurisdiction = function() {').concat(",
        "  '  var sel = document.getElementById("').concat(selectId).concat('");').concat(",
        "  '  var opt = sel.options[sel.selectedIndex];').concat(",
        "  '  return opt.value ? { name: opt.value, url: opt.getAttribute("data-url") } : null;').concat(",
        "  '};').concat(",
        "    ",
        "  'var getCheckbox = function() {').concat(",
        "  '  return document.getElementById("confirm-check");').concat(",
        "  '};').concat(",
        "    ",
        "  'var setConfirmVisibility = function(show) {').concat(",
        "  '  var el = document.getElementById("confirm-wrapper");').concat(",
        "  '  el.style.visibility = show ? "visible" : "hidden";').concat(",
        "  '};').concat(",
        "    ",
        "  'var setPolicyLink = function(url) {').concat(",
        "  '  document.getElementById("policy-link").setAttribute("href", url);').concat(",
        "  '};').concat(",
        "",
        "  'var setJurisdiction = function(name) {').concat(",
        "  '  loginHelpers.setHiddenCallback("').concat(inputId).concat('", name);').concat(",
        "  '};').concat(",
        "    ",
        "  'var isPageReady = function() {').concat(",
        "  '  return document.getElementById("callback_0") != null;').concat(",
        "  '};').concat(",
        "    ",
        "  'var setupPage = function() {').concat(",
        "  '  if (!isPageReady()) {').concat(",
        "  '    return setTimeout(setupPage, 100);').concat(",
        "  '  }').concat(",
        "  '  loginHelpers.disableNextButton(true);').concat(",
        "  '  var container = document.getElementById("callback_0");').concat(",
        "  '  container.insertAdjacentHTML("beforeend", "').concat(html).concat('");').concat(",
        "  '};').concat(",
        "    ",
        "  'setupPage();');",
        "",
        "function isValidJurisdiction(name) {",
        "  for (var i = 0; i < jurisdictions.length; i++) {",
        "    if (jurisdictions[i].name == name) {",
        "      return true;",
        "    }",
        "  }",
        "  return false;",
        "}",
        "",
        "var fr = JavaImporter(",
        "  org.forgerock.openam.auth.node.api.Action,",
        "  com.sun.identity.authentication.callbacks.HiddenValueCallback,",
        "  com.sun.identity.authentication.callbacks.ScriptTextOutputCallback,",
        "  java.util.HashMap",
        ")",
        "",
        "with (fr) {",
        "  if (callbacks.isEmpty() || !isValidJurisdiction(callbacks.get(0).getValue())) {",
        "    action = Action.send(",
        "      new HiddenValueCallback(inputId, ''),",
        "      new ScriptTextOutputCallback(script)",
        "    ).build();",
        "  } else {",
        "    var OBJ_ATTRS = 'objectAttributes';",
        "    var attrs = sharedState.containsKey(OBJ_ATTRS) ? sharedState.get(OBJ_ATTRS) : new HashMap();",
        "    attrs.put('jurisdiction', callbacks.get(0).getValue());",
        "    sharedState.put(OBJ_ATTRS, attrs);",
        "    action = Action.goTo('True').build();",
        "  }",
        "}",
        "",
        " /*",
        "  * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "  * ",
        "  * Example:",
        "  * 'xxxxx' produces '28535'",
        "  * 'xxx-xxx' produces '432-521'",
        "  */",
        "function generateNumericToken(format) {",
        "  return format.replace(/[x]/g, function(c) {",
        "    var r = Math.random()*10|0;",
        "    var v = r;",
        "    return v.toString(10);",
        "  });",
        "}",
      ],
    },
    "68d5a8e7-fcc9-4215-9e63-a01afe8fa849": {
      "_id": "68d5a8e7-fcc9-4215-9e63-a01afe8fa849",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Perform IDP lookup based on email domain. Set users' external IDP in shared state or continue to local authentication.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "IDP Lookup",
      "script": [
        "/* IDP Lookup",
        " * ",
        " * Perform IDP lookup based on email domain. Set users' external IDP in shared state or continue to local authentication.",
        " * ",
        " * This script requires parametrization. Make sure you carefully review the configuration parameters.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - one",
        " * - multiple",
        " * - none",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    logger.message("IDP Lookup: start");",
        "      outcome = "none";",
        "      var username = sharedState.get("username");",
        "      var domain = username.substr(username.lastIndexOf("@")+1);",
        "      var referer = parseUrl(requestHeaders.get("referer").get(0));",
        "",
        "      /* Begin Configuration */",
        "  ",
        "    // long-lived token",
        "    var IDM_API_TOKEN = systemEnv.getProperty("esv.admin.token");",
        "  ",
        "    // IDM API Configuration",
        "    var IDM_API_URI = referer.origin + "/openidm/managed/alpha_organization?_queryFilter=idpDomains+co+'" + domain + "'&_fields=name,description,idpName,idpType,idpDomains,idpJourney,idpTheme,idpPersist,samlConfig";",
        "",
        "      /* End Configuration */",
        "",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setMethod('GET');",
        "    request.setUri(IDM_API_URI);",
        "    request.getHeaders().add("Content-Type", "application/json; charset=UTF-8");",
        "    request.getHeaders().add("Authorization", "Bearer " + IDM_API_TOKEN);",
        "",
        "    var response = httpClient.send(request).get();",
        "    var result = JSON.parse(response.getEntity().getString());",
        "    logger.message("IDP Lookup: JSON result: " + JSON.stringify(result));",
        "    ",
        "      var routedIDPs = result.result.length ? result.result : [{}];",
        "      // stringify the samlConfig property",
        "      routedIDPs.forEach(function (routedIDP, index) {",
        "          routedIDPs[index].samlConfig = JSON.stringify(routedIDP.samlConfig);",
        "    });",
        "      sharedState.put("routedIDPs", routedIDPs);",
        "    if (result.resultCount === 1) {",
        "        logger.message("IDP Lookup: Found exactly 1 IDP");",
        "        outcome = "one";",
        "    }",
        "      else if (result.resultCount > 1) {",
        "        logger.message("IDP Lookup: Found {} IDPs", result.resultCount);",
        "        outcome = "multiple";",
        "    }",
        "      else {",
        "        logger.message("IDP Lookup: Found no IDPs");",
        "    }",
        "    logger.message("IDP Lookup: end [outcome={}]", outcome);",
        "",
        "    /*",
        "     * Parse a URL into its components and make them easily accessible by name",
        "     *",
        "     * Use in a Scripte Decision Node Script as follows:",
        "     * var referer = parseUrl(requestHeaders.get("referer").get(0));",
        "     * var origin = referer.origin;",
        "     * ",
        "     * e.g.: https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/",
        "     * {",
        "     *     hash: '#/',",
        "     *     host: 'openam-volker-dev.forgeblocks.com',",
        "     *     hostname: 'openam-volker-dev.forgeblocks.com',",
        "     *     href: 'https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/',",
        "     *     origin: 'https://openam-volker-dev.forgeblocks.com',",
        "     *     pathname: '/am/XUI/',",
        "     *     port: '',",
        "     *     protocol: 'https',",
        "     *     search: '?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim',",
        "     *     username: '',",
        "     *     password: '',",
        "     *     searchParam: {",
        "     *         realm: '/bravo',",
        "     *         authIndexType: 'service',",
        "     *         authIndexValue: 'InitiateOwnerClaim'",
        "     *     }",
        "     * }",
        "     */",
        "    function parseUrl(href) {",
        "        var m = href.match(/^(([^:\\/?#]+):?(?:\\/\\/((?:([^\\/?#:]*):([^\\/?#:]*)@)?([^\\/?#:]*)(?::([^\\/?#:]*))?)))?([^?#]*)(\\?[^#]*)?(#.*)?$/),",
        "        r = {",
        "            hash: m[10] || "",                      // #/",
        "            host: m[3] || "",                       // openam-volker-dev.forgeblocks.com",
        "            hostname: m[6] || "",                   // openam-volker-dev.forgeblocks.com",
        "            href: m[0] || "",                       // https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/",
        "            origin: m[1] || "",                     // https://openam-volker-dev.forgeblocks.com",
        "            pathname: m[8] || (m[1] ? "/" : ""),    // /am/XUI/",
        "            port: m[7] || "",                       // ",
        "            protocol: m[2] || "",                   // https",
        "            search: m[9] || "",                     // ?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim",
        "            username: m[4] || "",                   // ",
        "            password: m[5] || "",                   // ",
        "            searchParam: {}                         // { realm: '/bravo',",
        "                                                    //   authIndexType: 'service',",
        "                                                    //   authIndexValue: 'InitiateOwnerClaim' }",
        "        };",
        "        if (r.protocol.length == 2) {",
        "            r.protocol = "file:///" + r.protocol.toUpperCase();",
        "            r.origin = r.protocol + "//" + r.host;",
        "        }",
        "        if (r.search.length > 2) {",
        "            var query = (r.search.indexOf('?') === 0) ? r.search.substr(1) : r.search;",
        "            var vars = query.split('&');",
        "            for (var i = 0; i < vars.length; i++) {",
        "            var pair = vars[i].split('=');",
        "            r.searchParam[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1]);",
        "            }",
        "        }",
        "        r.href = r.origin + r.pathname + r.search + r.hash;",
        "        return r;",
        "    };",
        "}());",
      ],
    },
    "6963d84e-e2f0-4db1-a746-116604189602": {
      "_id": "6963d84e-e2f0-4db1-a746-116604189602",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_SetCurrentYear",
      "script": [
        "var currentYear = new Date().getFullYear().toString();",
        "",
        "var objAttrs = sharedState.get('objectAttributes') || new java.util.HashMap();",
        "objAttrs.put('currentYear', currentYear);",
        "sharedState.put('objectAttributes', objAttrs);",
        "",
        "outcome = 'True';",
        "",
      ],
    },
    "6ad22934-5d12-43a6-96a7-a2fba8d999bf": {
      "_id": "6ad22934-5d12-43a6-96a7-a2fba8d999bf",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Call out to University of Phoenix Course Registration System and get current course.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "UOP Get Course ID",
      "script": [
        "/* UOP Get Course ID",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Call out to University of Phoenix Course Registration System and get current class.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is. ",
        " * It requires the Identify Existing User node before it is being called.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - has classes",
        " * - no classes",
        " * - error",
        " */",
        "logger.warning("UOP Get Course ID: start now");",
        "",
        "outcome = "error";",
        "",
        "if (sharedState.get("_id") && idRepository.getAttribute(sharedState.get("_id"), "mail").iterator().hasNext()) {",
        "",
        "       /* BEGIN SCRIPT CONFIGURATION",
        "     *",
        "     * REPLACE WITH YOUR OWN API SETTINGS",
        "     */",
        "      var email = idRepository.getAttribute(sharedState.get("_id"), "mail").iterator().next();",
        "    var UOP_CLASS_API_URI = "https://dy4rpew5va.execute-api.us-east-1.amazonaws.com/forgerock/course?courseId=CES422";",
        "      //var UOP_CLASS_API_URI = "https://dy4rpew5va.execute-api.us-east-1.amazonaws.com/forgerock/course?emailId=".concat(email);",
        "    /*",
        "     * END SCRIPT CONFIGURATION",
        "     */",
        "",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setMethod('GET');",
        "    request.setUri(UOP_CLASS_API_URI);",
        "",
        "    var response = httpClient.send(request).get();",
        "    var UOPClassID = response.getEntity().getString();",
        "    logger.warning("UOP Get Course ID: API call result: Course ID=".concat(UOPClassID));",
        "",
        "    /* Sample API response",
        "    CES421",
        "    */",
        "",
        "    if (UOPClassID) {",
        "        outcome = "has classes";",
        "",
        "        // preserve result in shared state",
        "        sharedState.put("uopCurrentClassID", UOPClassID);",
        "    } ",
        "    else if (UOPClassID === "") {",
        "        outcome = "no classes";",
        "    }",
        "    else {",
        "        outcome = "error";",
        "    }",
        "",
        "} else {",
        "    logger.error("UOP Get Course ID: no classes!");",
        "}",
        "",
        "logger.warning("UOP Get Course ID: End (outcome=".concat(outcome).concat(")"));",
      ],
    },
    "6b3cfd48-62d3-48ff-a96f-fe8f3a22ab30": {
      "_id": "6b3cfd48-62d3-48ff-a96f-fe8f3a22ab30",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from Amazon",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Amazon Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "return json(object(",
        "        field("id", rawProfile.user_id),",
        "        field("displayName", rawProfile.name),",
        "        field("email", rawProfile.email),",
        "        field("username", rawProfile.email)))",
      ],
    },
    "6d6c2202-725b-4196-9436-92ec11a0b385": {
      "_id": "6d6c2202-725b-4196-9436-92ec11a0b385",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Display sharedState and transientState.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Display States - imported (2)",
      "script": [
        "/* Display States",
        " * ",
        " * Display sharedState and transientState.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    outcome = "true";",
        "",
        "    var anchor = "anchor-".concat(generateNumericToken('xxx'));",
        "    var halign = "left";",
        "    var message = "<h4>Current State Values</h4>".concat(",
        "        "<p><b>Shared State</b>:<br/>").concat(",
        "        sharedState.toString()).concat("</p>").concat(",
        "        "<p><b>Transient State</b>:<br/>").concat(",
        "        transientState.toString()).concat("</p>")",
        "    var script = "Array.prototype.slice.call(\\n".concat(",
        "      "document.getElementsByClassName('callback-component')).forEach(\\n").concat(",
        "      "function (e) {\\n").concat(",
        "      "  var message = e.firstElementChild;\\n").concat(",
        "      "  if (message.firstChild && message.firstChild.nodeName == '#text' && message.firstChild.nodeValue.trim() == '").concat(anchor).concat("') {\\n").concat(",
        "      "    message.className = \\"\\";\\n").concat(",
        "      "    message.style = \\"text-align: left; inline-size: 430px; overflow-wrap: break-word;\\";\\n").concat(",
        "      "    message.align = \\"").concat(halign).concat("\\";\\n").concat(",
        "      "    message.innerHTML = '").concat(message).concat("';\\n").concat(",
        "      "  }\\n").concat(",
        "      "})")",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "        javax.security.auth.callback.TextOutputCallback,",
        "        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        "    )",
        "    if (message.length && callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "            new fr.TextOutputCallback(",
        "                fr.TextOutputCallback.INFORMATION,",
        "                anchor",
        "            ),",
        "            new fr.ScriptTextOutputCallback(script)",
        "        ).build()",
        "    }",
        "    else {",
        "      action = fr.Action.goTo(outcome).build();",
        "    }",
        "",
        "     /*",
        "      * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "      * ",
        "      * Example:",
        "      * 'xxxxx' produces '28535'",
        "      * 'xxx-xxx' produces '432-521'",
        "      */",
        "    function generateNumericToken(format) {",
        "        return format.replace(/[x]/g, function(c) {",
        "            var r = Math.random()*10|0;",
        "            var v = r;",
        "            return v.toString(10);",
        "        });",
        "    }",
        "}());",
      ],
    },
    "6dfc6de4-64cb-4d47-8269-6c5ced44344d": {
      "_id": "6dfc6de4-64cb-4d47-8269-6c5ced44344d",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_IsInvited",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "if (sharedState.get('invited') == true) {",
        "  outcome = 'True';",
        "} else {",
        "  outcome = 'False';",
        "}",
      ],
    },
    "703dab1a-1921-4981-98dd-b8e5349d8548": {
      "_id": "703dab1a-1921-4981-98dd-b8e5349d8548",
      "context": "AUTHENTICATION_SERVER_SIDE",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Default global script for server side Device Id (Match) Authentication Module",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Device Id (Match) - Server Side",
      "script": [
        "/*",
        " * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS HEADER.",
        " *",
        " * Copyright (c) 2009 Sun Microsystems Inc. All Rights Reserved",
        " *",
        " * The contents of this file are subject to the terms",
        " * of the Common Development and Distribution License",
        " * (the License). You may not use this file except in",
        " * compliance with the License.",
        " *",
        " * You can obtain a copy of the License at",
        " * https://opensso.dev.java.net/public/CDDLv1.0.html or",
        " * opensso/legal/CDDLv1.0.txt",
        " * See the License for the specific language governing",
        " * permission and limitations under the License.",
        " *",
        " * When distributing Covered Code, include this CDDL",
        " * Header Notice in each file and include the License file",
        " * at opensso/legal/CDDLv1.0.txt.",
        " * If applicable, add the following below the CDDL Header,",
        " * with the fields enclosed by brackets [] replaced by",
        " * your own identifying information:",
        " * "Portions Copyrighted [year] [name of copyright owner]"",
        " *",
        " */",
        "/*",
        " * Portions Copyrighted 2013 Syntegrity.",
        " * Portions Copyrighted 2013-2018 ForgeRock AS.",
        " */",
        "",
        "var ScalarComparator = {}, ScreenComparator = {}, MultiValueComparator = {}, UserAgentComparator = {}, GeolocationComparator = {};",
        "",
        "var config = {",
        "    profileExpiration: 30,              //in days",
        "    maxProfilesAllowed: 5,",
        "    maxPenaltyPoints: 0,",
        "    attributes: {",
        "        screen: {",
        "            required: true,",
        "            comparator: ScreenComparator,",
        "            args: {",
        "                penaltyPoints: 50",
        "            }",
        "        },",
        "        plugins: {",
        "            installedPlugins: {",
        "                required: false,",
        "                comparator: MultiValueComparator,",
        "                args: {",
        "                    maxPercentageDifference: 10,",
        "                    maxDifferences: 5,",
        "                    penaltyPoints: 100",
        "                }",
        "            }",
        "        },",
        "        fonts: {",
        "            installedFonts: {",
        "                required: false,",
        "                comparator: MultiValueComparator,",
        "                args: {",
        "                    maxPercentageDifference: 10,",
        "                    maxDifferences: 5,",
        "                    penaltyPoints: 100",
        "                }",
        "            }",
        "        },",
        "        timezone: {",
        "            timezone: {",
        "                required: false,",
        "                comparator: ScalarComparator,",
        "                args: {",
        "                    penaltyPoints: 100",
        "                }",
        "            }",
        "        },",
        "        userAgent: {",
        "            required: true,",
        "            comparator: UserAgentComparator,",
        "            args: {",
        "                ignoreVersion: true,",
        "                penaltyPoints: 100",
        "            }",
        "        },",
        "        geolocation: {",
        "            required: false,",
        "            comparator: GeolocationComparator,",
        "            args: {",
        "                allowedRange: 100,            //in miles",
        "                penaltyPoints: 100",
        "            }",
        "        }",
        "    }",
        "};",
        "",
        "//---------------------------------------------------------------------------//",
        "//                           Comparator functions                            //",
        "//---------------------------------------------------------------------------//",
        "",
        "var all, any, calculateDistance, calculateIntersection, calculatePercentage, nullOrUndefined, splitAndTrim,",
        "    undefinedLocation;",
        "",
        "// ComparisonResult",
        "",
        "/**",
        " * Constructs an instance of a ComparisonResult with the given penalty points.",
        " *",
        " * @param penaltyPoints (Number) The penalty points for the comparison (defaults to 0).",
        " * @param additionalInfoInCurrentValue (boolean) Whether the current value contains more information",
        " *                                               than the stored value (defaults to false).",
        " */",
        "function ComparisonResult() {",
        "",
        "    var penaltyPoints = 0,",
        "        additionalInfoInCurrentValue = false;",
        "",
        "    if (arguments[0] !== undefined && arguments[1] !== undefined) {",
        "        penaltyPoints = arguments[0];",
        "        additionalInfoInCurrentValue = arguments[1];",
        "    }",
        "",
        "    if (arguments[0] !== undefined && arguments[1] === undefined) {",
        "        if (typeof(arguments[0]) === "boolean") {",
        "            additionalInfoInCurrentValue = arguments[0];",
        "        } else {",
        "            penaltyPoints = arguments[0];",
        "        }",
        "    }",
        "",
        "    this.penaltyPoints = penaltyPoints;",
        "    this.additionalInfoInCurrentValue = additionalInfoInCurrentValue;",
        "",
        "}",
        "",
        "ComparisonResult.ZERO_PENALTY_POINTS = new ComparisonResult(0);",
        "",
        "/**",
        " * Static method for functional programming.",
        " *",
        " * @return boolean true if comparisonResult.isSuccessful().",
        " */",
        "ComparisonResult.isSuccessful =  function(comparisonResult) {",
        "    return comparisonResult.isSuccessful();",
        "};",
        "",
        "",
        "/**",
        " * Static method for functional programming.",
        " *",
        " * @return boolean true if comparisonResult.additionalInfoInCurrentValue.",
        " */",
        "ComparisonResult.additionalInfoInCurrentValue =  function(comparisonResult) {",
        "    return comparisonResult.additionalInfoInCurrentValue;",
        "};",
        "",
        "/**",
        " * Comparison function that can be provided as an argument to array.sort",
        " */",
        "ComparisonResult.compare = function(first, second) {",
        "    if (nullOrUndefined(first) && nullOrUndefined(second)) {",
        "        return 0;",
        "    } else if (nullOrUndefined(first)) {",
        "        return -1;",
        "    } else if (nullOrUndefined(second)) {",
        "        return 1;",
        "    } else {",
        "        if (first.penaltyPoints !== second.penaltyPoints) {",
        "            return first.penaltyPoints - second.penaltyPoints;",
        "        } else {",
        "            return (first.additionalInfoInCurrentValue ? 1 : 0) - (second.additionalInfoInCurrentValue ? 1 : 0);",
        "        }",
        "    }",
        "};",
        "",
        "/**",
        " * Amalgamates the given ComparisonResult into this ComparisonResult.",
        " *",
        " * @param comparisonResult The ComparisonResult to include.",
        " */",
        "ComparisonResult.prototype.addComparisonResult = function(comparisonResult) {",
        "    this.penaltyPoints += comparisonResult.penaltyPoints;",
        "    if (comparisonResult.additionalInfoInCurrentValue) {",
        "        this.additionalInfoInCurrentValue = comparisonResult.additionalInfoInCurrentValue;",
        "    }",
        "};",
        "",
        "/**",
        " * Returns true if no penalty points have been assigned for the comparison.",
        " *",
        " * @return boolean true if the comparison was successful.",
        " */",
        "ComparisonResult.prototype.isSuccessful = function() {",
        "    return nullOrUndefined(this.penaltyPoints) || this.penaltyPoints === 0;",
        "};",
        "",
        "/**",
        " * Compares two simple objects (String|Number) and if they are equal then returns a ComparisonResult with zero",
        " * penalty points assigned, otherwise returns a ComparisonResult with the given number of penalty points assigned.",
        " *",
        " * @param currentValue (String|Number) The current value.",
        " * @param storedValue (String|Number) The stored value.",
        " * @param config: {",
        " *            "penaltyPoints": (Number) The number of penalty points.",
        " *        }",
        " * @return ComparisonResult.",
        " */",
        "ScalarComparator.compare = function (currentValue, storedValue, config) {",
        "    if (logger.messageEnabled()) {",
        "        logger.message("StringComparator.compare:currentValue: " + JSON.stringify(currentValue));",
        "        logger.message("StringComparator.compare:storedValue: " + JSON.stringify(storedValue));",
        "        logger.message("StringComparator.compare:config: " + JSON.stringify(config));",
        "    }",
        "    if (config.penaltyPoints === 0) {",
        "        return ComparisonResult.ZERO_PENALTY_POINTS;",
        "    }",
        "",
        "    if (!nullOrUndefined(storedValue)) {",
        "        if (nullOrUndefined(currentValue) || currentValue !== storedValue) {",
        "            return new ComparisonResult(config.penaltyPoints);",
        "        }",
        "    } else if (!nullOrUndefined(currentValue)) {",
        "        return new ComparisonResult(true);",
        "    }",
        "",
        "    return ComparisonResult.ZERO_PENALTY_POINTS;",
        "};",
        "",
        "/**",
        " * Compares two screens and if they are equal then returns a ComparisonResult with zero penalty points assigned,",
        " * otherwise returns a ComparisonResult with the given number of penalty points assigned.",
        " *",
        " * @param currentValue: {",
        " *            "screenWidth": (Number) The current client screen width.",
        " *            "screenHeight": (Number) The current client screen height.",
        " *            "screenColourDepth": (Number) The current client screen colour depth.",
        " *        }",
        " * @param storedValue: {",
        " *            "screenWidth": (Number) The stored client screen width.",
        " *            "screenHeight": (Number) The stored client screen height.",
        " *            "screenColourDepth": (Number) The stored client screen colour depth.",
        " *        }",
        " * @param config: {",
        " *            "penaltyPoints": (Number) The number of penalty points.",
        " *        }",
        " * @return ComparisonResult",
        " */",
        "ScreenComparator.compare = function (currentValue, storedValue, config) {",
        "    if (logger.messageEnabled()) {",
        "        logger.message("ScreenComparator.compare:currentValue: " + JSON.stringify(currentValue));",
        "        logger.message("ScreenComparator.compare:storedValue: " + JSON.stringify(storedValue));",
        "        logger.message("ScreenComparator.compare:config: " + JSON.stringify(config));",
        "    }",
        "",
        "    if (nullOrUndefined(currentValue)) {",
        "        currentValue = {screenWidth: null, screenHeight: null, screenColourDepth: null};",
        "    }",
        "    if (nullOrUndefined(storedValue)) {",
        "        storedValue = {screenWidth: null, screenHeight: null, screenColourDepth: null};",
        "    }",
        "",
        "    var comparisonResults = [",
        "        ScalarComparator.compare(currentValue.screenWidth, storedValue.screenWidth, config),",
        "        ScalarComparator.compare(currentValue.screenHeight, storedValue.screenHeight, config),",
        "        ScalarComparator.compare(currentValue.screenColourDepth, storedValue.screenColourDepth, config)];",
        "",
        "    if (all(comparisonResults, ComparisonResult.isSuccessful)) {",
        "        return new ComparisonResult(any(comparisonResults, ComparisonResult.additionalInfoInCurrentValue));",
        "    } else {",
        "        return new ComparisonResult(config.penaltyPoints);",
        "    }",
        "};",
        "",
        "/**",
        " * Splits both values using delimiter, trims every value and compares collections of values.",
        " * Returns zero-result for same multi-value attributes.",
        " *",
        " * If collections are not same checks if number of differences is less or equal maxDifferences or",
        " * percentage of difference is less or equal maxPercentageDifference.",
        " *",
        " * If yes then returns zero-result with additional info, else returns penaltyPoints-result.",
        " *",
        " * @param currentValue: (String) The current value.",
        " * @param storedValue: (String) The stored value.",
        " * @param config: {",
        " *            "maxPercentageDifference": (Number) The max difference percentage in the values,",
        " *                                                before the penalty is assigned.",
        " *            "maxDifferences": (Number) The max number of differences in the values,",
        " *                                       before the penalty points are assigned.",
        " *            "penaltyPoints": (Number) The number of penalty points.",
        "  *        }",
        " * @return ComparisonResult",
        " */",
        "MultiValueComparator.compare = function (currentValue, storedValue, config) {",
        "    if (logger.messageEnabled()) {",
        "        logger.message("MultiValueComparator.compare:currentValue: " + JSON.stringify(currentValue));",
        "        logger.message("MultiValueComparator.compare:storedValue: " + JSON.stringify(storedValue));",
        "        logger.message("MultiValueComparator.compare:config: " + JSON.stringify(config));",
        "    }",
        "",
        "    var delimiter = ";",",
        "        currentValues = splitAndTrim(currentValue, delimiter),",
        "        storedValues = splitAndTrim(storedValue, delimiter),",
        "        maxNumberOfElements = Math.max(currentValues.length, storedValues.length),",
        "        numberOfTheSameElements = calculateIntersection(currentValues, storedValues).length,",
        "        numberOfDifferences = maxNumberOfElements - numberOfTheSameElements,",
        "        percentageOfDifferences = calculatePercentage(numberOfDifferences, maxNumberOfElements);",
        "",
        "    if (nullOrUndefined(storedValue) && !nullOrUndefined(currentValue)) {",
        "        return new ComparisonResult(true);",
        "    }",
        "",
        "    if (logger.messageEnabled()) {",
        "        logger.message(numberOfTheSameElements + " of " + maxNumberOfElements + " are same");",
        "    }",
        "",
        "    if (maxNumberOfElements === 0) {",
        "        logger.message("Ignored because no attributes found in both profiles");",
        "        return ComparisonResult.ZERO_PENALTY_POINTS;",
        "    }",
        "",
        "    if (numberOfTheSameElements === maxNumberOfElements) {",
        "        logger.message("Ignored because all attributes are same");",
        "        return ComparisonResult.ZERO_PENALTY_POINTS;",
        "    }",
        "",
        "    if (numberOfDifferences > config.maxDifferences) {",
        "        if (logger.messageEnabled()) {",
        "            logger.message("Would be ignored if not more than " + config.maxDifferences + " differences");",
        "        }",
        "        return new ComparisonResult(config.penaltyPoints);",
        "    }",
        "",
        "    if (percentageOfDifferences > config.maxPercentageDifference) {",
        "        if (logger.messageEnabled()) {",
        "            logger.message(percentageOfDifferences + " percents are different");",
        "            logger.message("Would be ignored if not more than " + config.maxPercentageDifference + " percent");",
        "        }",
        "        return new ComparisonResult(config.penaltyPoints);",
        "    }",
        "",
        "    if (logger.messageEnabled()) {",
        "        logger.message("Ignored because number of differences(" + numberOfDifferences + ") not more than "",
        "            + config.maxDifferences);",
        "        logger.message(percentageOfDifferences + " percents are different");",
        "        logger.message("Ignored because not more than " + config.maxPercentageDifference + " percent");",
        "    }",
        "    return new ComparisonResult(true);",
        "};",
        "",
        "/**",
        " * Compares two User Agent Strings and if they are equal then returns a ComparisonResult with zero penalty",
        " * points assigned, otherwise returns a ComparisonResult with the given number of penalty points assigned.",
        " *",
        " * @param currentValue (String) The current value.",
        " * @param storedValue (String) The stored value.",
        " * @param config: {",
        " *            "ignoreVersion": (boolean) If the version numbers in the User Agent Strings should be ignore",
        " *                                       in the comparison.",
        " *            "penaltyPoints": (Number) The number of penalty points.",
        " *        }",
        " * @return A ComparisonResult.",
        " */",
        "UserAgentComparator.compare = function (currentValue, storedValue, config) {",
        "    if (logger.messageEnabled()) {",
        "        logger.message("UserAgentComparator.compare:currentValue: " + JSON.stringify(currentValue));",
        "        logger.message("UserAgentComparator.compare:storedValue: " + JSON.stringify(storedValue));",
        "        logger.message("UserAgentComparator.compare:config: " + JSON.stringify(config));",
        "    }",
        "",
        "    if (config.ignoreVersion) {",
        "        // remove version number",
        "        currentValue = nullOrUndefined(currentValue) ? null : currentValue.replace(/[\\d\\.]+/g, "").trim();",
        "        storedValue = nullOrUndefined(storedValue) ? null : storedValue.replace(/[\\d\\.]+/g, "").trim();",
        "    }",
        "",
        "    return ScalarComparator.compare(currentValue, storedValue, config);",
        "};",
        "",
        "/**",
        " * Compares two locations, taking into account a degree of difference.",
        " *",
        " * @param currentValue: {",
        " *            "latitude": (Number) The current latitude.",
        " *            "longitude": (Number) The current longitude.",
        " *        }",
        " * @param storedValue: {",
        " *            "latitude": (Number) The stored latitude.",
        " *            "longitude": (Number) The stored longitude.",
        " *        }",
        " * @param config: {",
        " *            "allowedRange": (Number) The max difference allowed in the two locations, before the penalty is assigned.",
        " *            "penaltyPoints": (Number) The number of penalty points.",
        "*         }",
        " * @return ComparisonResult",
        " */",
        "GeolocationComparator.compare = function (currentValue, storedValue, config) {",
        "    if (logger.messageEnabled()) {",
        "        logger.message("GeolocationComparator.compare:currentValue: " + JSON.stringify(currentValue));",
        "        logger.message("GeolocationComparator.compare:storedValue: " + JSON.stringify(storedValue));",
        "        logger.message("GeolocationComparator.compare:config: " + JSON.stringify(config));",
        "    }",
        "",
        "    // Check for undefined stored or current locations",
        "",
        "    if (undefinedLocation(currentValue) && undefinedLocation(storedValue)) {",
        "        return ComparisonResult.ZERO_PENALTY_POINTS;",
        "    }",
        "    if (undefinedLocation(currentValue) && !undefinedLocation(storedValue)) {",
        "        return new ComparisonResult(config.penaltyPoints);",
        "    }",
        "    if (!undefinedLocation(currentValue) && undefinedLocation(storedValue)) {",
        "        return new ComparisonResult(true);",
        "    }",
        "",
        "    // Both locations defined, therefore perform comparison",
        "",
        "    var distance = calculateDistance(currentValue, storedValue);",
        "",
        "    if (logger.messageEnabled()) {",
        "        logger.message("Distance between (" + currentValue.latitude + "," + currentValue.longitude + ") and (" +",
        "            storedValue.latitude + "," + storedValue.longitude + ") is " + distance + " miles");",
        "    }",
        "",
        "    if (parseFloat(distance.toPrecision(5)) === 0) {",
        "        logger.message("Location is the same");",
        "        return ComparisonResult.ZERO_PENALTY_POINTS;",
        "    }",
        "",
        "    if (distance <= config.allowedRange) {",
        "        if (logger.messageEnabled()) {",
        "            logger.message("Tolerated because distance not more then " + config.allowedRange);",
        "        }",
        "        return new ComparisonResult(true);",
        "    } else {",
        "        if (logger.messageEnabled()) {",
        "            logger.message("Would be ignored if distance not more then " + config.allowedRange);",
        "        }",
        "        return new ComparisonResult(config.penaltyPoints);",
        "    }",
        "};",
        "",
        "",
        "//---------------------------------------------------------------------------//",
        "//                    Device Print Logic - DO NOT MODIFY                     //",
        "//---------------------------------------------------------------------------//",
        "",
        "// Utility functions",
        "",
        "/**",
        " * Returns true if evaluating function f on each element of the Array a returns true.",
        " *",
        " * @param a: (Array) The array of elements to evaluate",
        " * @param f: (Function) A single argument function for mapping elements of the array to boolean.",
        " * @return boolean.",
        " */",
        "all = function(a, f) {",
        "    var i;",
        "    for (i = 0; i < a.length; i++) {",
        "        if (f(a[i]) === false) {",
        "            return false;",
        "        }",
        "    }",
        "    return true;",
        "};",
        "",
        "/**",
        " * Returns true if evaluating function f on any element of the Array a returns true.",
        " *",
        " * @param a: (Array) The array of elements to evaluate",
        " * @param f: (Function) A single argument function for mapping elements of the array to boolean.",
        " * @return boolean.",
        " */",
        "any = function(a, f) {",
        "    var i;",
        "    for (i = 0; i < a.length; i++) {",
        "        if (f(a[i]) === true) {",
        "            return true;",
        "        }",
        "    }",
        "    return false;",
        "};",
        "",
        "/**",
        " * Returns true if the provided location is null or has undefined longitude or latitude values.",
        " *",
        " * @param location: {",
        " *            "latitude": (Number) The latitude.",
        " *            "longitude": (Number) The longitude.",
        " *        }",
        " * @return boolean",
        " */",
        "undefinedLocation = function(location) {",
        "    return nullOrUndefined(location) || nullOrUndefined(location.latitude) || nullOrUndefined(location.longitude);",
        "};",
        "",
        "/**",
        " * Returns true if the provided value is null or undefined.",
        " *",
        " * @param value: a value of any type",
        " * @return boolean",
        " */",
        "nullOrUndefined = function(value) {",
        "    return value === null || value === undefined;",
        "};",
        "",
        "/**",
        " * Calculates the distances between the two locations.",
        " *",
        " * @param first: {",
        " *            "latitude": (Number) The first latitude.",
        " *            "longitude": (Number) The first longitude.",
        " *        }",
        " * @param second: {",
        " *            "latitude": (Number) The second latitude.",
        " *            "longitude": (Number) The second longitude.",
        " *        }",
        " * @return Number The distance between the two locations.",
        " */",
        "calculateDistance = function(first, second) {",
        "    var factor = (Math.PI / 180),",
        "        theta,",
        "        dist;",
        "    function degreesToRadians(degrees) {",
        "        return degrees * factor;",
        "    }",
        "    function radiansToDegrees(radians) {",
        "        return radians / factor;",
        "    }",
        "    theta = first.longitude - second.longitude;",
        "    dist = Math.sin(degreesToRadians(first.latitude)) * Math.sin(degreesToRadians(second.latitude))",
        "        + Math.cos(degreesToRadians(first.latitude)) * Math.cos(degreesToRadians(second.latitude))",
        "        * Math.cos(degreesToRadians(theta));",
        "    dist = Math.acos(dist);",
        "    dist = radiansToDegrees(dist);",
        "    dist = dist * 60 * 1.1515;",
        "    return dist;",
        "};",
        "",
        "/**",
        " * Converts a String holding a delimited sequence of values into an array.",
        " *",
        " * @param text (String) The String representation of a delimited sequence of values.",
        " * @param delimiter (String) The character delimiting values within the text String.",
        " * @return (Array) The comma separated values.",
        " */",
        "splitAndTrim = function(text, delimiter) {",
        "",
        "    var results = [],",
        "        i,",
        "        values,",
        "        value;",
        "    if (text === null) {",
        "        return results;",
        "    }",
        "",
        "    values = text.split(delimiter);",
        "    for (i = 0; i < values.length; i++) {",
        "        value = values[i].trim();",
        "        if (value !== "") {",
        "            results.push(value);",
        "        }",
        "    }",
        "",
        "    return results;",
        "};",
        "",
        "/**",
        " * Converts value to a percentage of range.",
        " *",
        " * @param value (Number) The actual number to be converted to a percentage.",
        " * @param range (Number) The total number of values (i.e. represents 100%).",
        " * @return (Number) The percentage.",
        " */",
        "calculatePercentage = function(value, range) {",
        "    if (range === 0) {",
        "        return 0;",
        "    }",
        "    return parseFloat((value / range).toPrecision(2)) * 100;",
        "};",
        "",
        "/**",
        " * Creates a new array containing only those elements found in both arrays received as arguments.",
        " *",
        " * @param first (Array) The first array.",
        " * @param second (Array) The second array.",
        " * @return (Array) The elements that found in first and second.",
        " */",
        "calculateIntersection = function(first, second) {",
        "    return first.filter(function(element) {",
        "        return second.indexOf(element) !== -1;",
        "    });",
        "};",
        "",
        "function getValue(obj, attributePath) {",
        "    var value = obj,",
        "        i;",
        "    for (i = 0; i < attributePath.length; i++) {",
        "        if (value === undefined) {",
        "            return null;",
        "        }",
        "        value = value[attributePath[i]];",
        "    }",
        "    return value;",
        "}",
        "",
        "",
        "function isLeafNode(attributeConfig) {",
        "    return attributeConfig.comparator !== undefined;",
        "}",
        "",
        "function getAttributePaths(attributeConfig, attributePath) {",
        "",
        "    var attributePaths = [],",
        "        attributeName,",
        "        attrPaths,",
        "        attrPath,",
        "        i;",
        "",
        "    for (attributeName in attributeConfig) {",
        "        if (attributeConfig.hasOwnProperty(attributeName)) {",
        "",
        "            if (isLeafNode(attributeConfig[attributeName])) {",
        "                attrPath = attributePath.slice();",
        "                attrPath.push(attributeName);",
        "                attributePaths.push(attrPath);",
        "            } else {",
        "                attrPath = attributePath.slice();",
        "                attrPath.push(attributeName);",
        "                attrPaths = getAttributePaths(attributeConfig[attributeName], attrPath);",
        "                for (i = 0; i < attrPaths.length; i++) {",
        "                    attributePaths.push(attrPaths[i]);",
        "                }",
        "            }",
        "        }",
        "    }",
        "",
        "    return attributePaths;",
        "}",
        "",
        "function getDevicePrintAttributePaths(attributeConfig) {",
        "    return getAttributePaths(attributeConfig, []);",
        "}",
        "",
        "function hasRequiredAttributes(devicePrint, attributeConfig) {",
        "",
        "    var attributePaths = getDevicePrintAttributePaths(attributeConfig),",
        "        i,",
        "        attrValue,",
        "        attrConfig;",
        "",
        "    for (i = 0; i < attributePaths.length; i++) {",
        "",
        "        attrValue = getValue(devicePrint, attributePaths[i]);",
        "        attrConfig = getValue(attributeConfig, attributePaths[i]);",
        "",
        "        if (attrConfig.required && attrValue === undefined) {",
        "            logger.warning("Device Print profile missing required attribute, " + attributePaths[i]);",
        "            return false;",
        "        }",
        "    }",
        "",
        "    logger.message("device print has required attributes");",
        "    return true;",
        "}",
        "",
        "function compareDevicePrintProfiles(attributeConfig, devicePrint, devicePrintProfiles, maxPenaltyPoints) {",
        "",
        "    var attributePaths = getDevicePrintAttributePaths(attributeConfig),",
        "        dao = sharedState.get('_DeviceIdDao'),",
        "        results,",
        "        j,",
        "        aggregatedComparisonResult,",
        "        i,",
        "        currentValue,",
        "        storedValue,",
        "        attrConfig,",
        "        comparisonResult,",
        "        selectedComparisonResult,",
        "        selectedProfile,",
        "        curDevicePrintProfile,",
        "        vals;",
        "",
        "    results = [];",
        "    for (j = 0; j < devicePrintProfiles.length; j++) {",
        "        curDevicePrintProfile = JSON.parse(org.forgerock.json.JsonValue.json(devicePrintProfiles[j]));",
        "        aggregatedComparisonResult = new ComparisonResult();",
        "        for (i = 0; i < attributePaths.length; i++) {",
        "",
        "            currentValue = getValue(devicePrint, attributePaths[i]);",
        "            storedValue = getValue(curDevicePrintProfile.devicePrint, attributePaths[i]);",
        "            attrConfig = getValue(attributeConfig, attributePaths[i]);",
        "",
        "            if (storedValue === null) {",
        "                comparisonResult = new ComparisonResult(attrConfig.penaltyPoints);",
        "            } else {",
        "                comparisonResult = attrConfig.comparator.compare(currentValue, storedValue, attrConfig.args);",
        "            }",
        "",
        "            if (logger.messageEnabled()) {",
        "                logger.message("Comparing attribute path: " + attributePaths[i]",
        "                    + ", Comparison result: successful=" + comparisonResult.isSuccessful() + ", penaltyPoints="",
        "                    + comparisonResult.penaltyPoints + ", additionalInfoInCurrentValue="",
        "                    + comparisonResult.additionalInfoInCurrentValue);",
        "            }",
        "            aggregatedComparisonResult.addComparisonResult(comparisonResult);",
        "        }",
        "        if (logger.messageEnabled()) {",
        "            logger.message("Aggregated comparison result: successful="",
        "                + aggregatedComparisonResult.isSuccessful() + ", penaltyPoints="",
        "                + aggregatedComparisonResult.penaltyPoints + ", additionalInfoInCurrentValue="",
        "                + aggregatedComparisonResult.additionalInfoInCurrentValue);",
        "        }",
        "",
        "        results.push({",
        "            key: aggregatedComparisonResult,",
        "            value: devicePrintProfiles[j]",
        "        });",
        "    }",
        "",
        "    if (results.length === 0) {",
        "        return null;",
        "    }",
        "",
        "    results.sort(function(a, b) {",
        "        return ComparisonResult.compare(a.key, b.key);",
        "    });",
        "    selectedComparisonResult = results[0].key;",
        "    if (logger.messageEnabled()) {",
        "        logger.message("Selected comparison result: successful=" + selectedComparisonResult.isSuccessful()",
        "            + ", penaltyPoints=" + selectedComparisonResult.penaltyPoints + ", additionalInfoInCurrentValue="",
        "            + selectedComparisonResult.additionalInfoInCurrentValue);",
        "    }",
        "",
        "    selectedProfile = null;",
        "    if (selectedComparisonResult.penaltyPoints <= maxPenaltyPoints) {",
        "        selectedProfile = results[0].value;",
        "        if (logger.messageEnabled()) {",
        "            logger.message("Selected profile: " + selectedProfile +",
        "                " with " + selectedComparisonResult.penaltyPoints + " penalty points");",
        "        }",
        "    }",
        "",
        "    if (selectedProfile === null) {",
        "        return false;",
        "    }",
        "",
        "    /* update profile */",
        "    selectedProfile.put("selectionCounter",",
        "        java.lang.Integer.valueOf(parseInt(selectedProfile.get("selectionCounter"), 10) + 1));",
        "    selectedProfile.put("lastSelectedDate", java.lang.Long.valueOf(new Date().getTime()));",
        "    selectedProfile.put("devicePrint", devicePrint);",
        "",
        "    vals = [];",
        "    for (i = 0; i < devicePrintProfiles.length; i++) {",
        "        vals.push(org.forgerock.json.JsonValue.json(devicePrintProfiles[i]));",
        "    }",
        "",
        "    dao.saveDeviceProfiles(username, realm, vals);",
        "",
        "    return true;",
        "}",
        "",
        "function matchDevicePrint() {",
        "",
        "    if (!username) {",
        "        logger.error("Username not set. Cannot compare user's device print profiles.");",
        "        authState = FAILED;",
        "    } else {",
        "",
        "        if (logger.messageEnabled()) {",
        "            logger.message("client devicePrint: " + clientScriptOutputData);",
        "        }",
        "",
        "        var getProfiles = function () {",
        "",
        "                function isExpiredProfile(devicePrintProfile) {",
        "                    var expirationDate = new Date(),",
        "                        lastSelectedDate;",
        "                    expirationDate.setDate(expirationDate.getDate() - config.profileExpiration);",
        "",
        "                    lastSelectedDate = new Date(devicePrintProfile.lastSelectedDate);",
        "",
        "                    return lastSelectedDate < expirationDate;",
        "                }",
        "",
        "                function getNotExpiredProfiles() {",
        "                    var profile,",
        "                        dao = sharedState.get('_DeviceIdDao'),",
        "                        results = [],",
        "                        profiles,",
        "                        iter;",
        "",
        "                    profiles = dao.getDeviceProfiles(username, realm);",
        "",
        "                    if (profiles) {",
        "                        iter = profiles.iterator();",
        "",
        "                        while (iter.hasNext()) {",
        "                            profile = iter.next().getObject();",
        "                            if (!isExpiredProfile(profile)) {",
        "                                results.push(profile);",
        "                            }",
        "                        }",
        "                    }",
        "                    if (logger.messageEnabled()) {",
        "                        logger.message("stored non-expired profiles: " + results);",
        "                    }",
        "                    return results;",
        "                }",
        "",
        "                return getNotExpiredProfiles();",
        "            },",
        "            devicePrint = JSON.parse(clientScriptOutputData),",
        "            devicePrintProfiles = getProfiles();",
        "",
        "        if (!hasRequiredAttributes(devicePrint, config.attributes)) {",
        "            logger.message("devicePrint.hasRequiredAttributes: false");",
        "            // Will fail this module but fall-through to next module. Which should be OTP.",
        "            authState = FAILED;",
        "        } else if (compareDevicePrintProfiles(config.attributes, devicePrint, devicePrintProfiles, config.maxPenaltyPoints)) {",
        "            logger.message("devicePrint.hasValidProfile: true");",
        "            authState = SUCCESS;",
        "        } else {",
        "            logger.message("devicePrint.hasValidProfile: false");",
        "            sharedState.put('devicePrintProfile', JSON.stringify(devicePrint));",
        "            // Will fail this module but fall-through to next module. Which should be OTP.",
        "            authState = FAILED;",
        "        }",
        "    }",
        "}",
        "",
        "matchDevicePrint();",
      ],
    },
    "71545db5-ce01-46b1-b79f-d41af36bd548": {
      "_id": "71545db5-ce01-46b1-b79f-d41af36bd548",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Capture Evidence",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Onfido-CaptureEvidence",
      "script": [
        "logger.error("Onfido-CaptureEvidence: Start");",
        "/*",
        " * !!! Extend your authentication session time so your identity proofing flows don't time out !!!",
        " *",
        " * Authentication > Settings > Trees > Max Duration (Minutes)",
        " *",
        " * Set to 15 minutes.",
        " *",
        " */",
        "",
        "/*",
        " * BEGIN SCRIPT CONFIGURATION",
        " */",
        "var onfido_auth_token = String(sharedState.get("onfidoAuthToken"));",
        "var onfido_dialog_title = "Join the Expanse family!";",
        "var onfido_dialog_msg1 = "To open an Expanse account, we will need to verify your identity.";",
        "var onfido_dialog_msg2 = "It will only take a couple of minutes.";",
        "var onfido_country_code = "US";",
        "/*",
        " * END SCRIPT CONFIGURATION",
        " */",
        "",
        "var mobile = idRepository.getAttribute(sharedState.get("_id"), "telephoneNumber");",
        "var smsNumber = "";",
        "if (mobile && mobile.iterator().hasNext()) {",
        "    smsNumber = String(mobile.iterator().next().toString());",
        "}",
        "",
        "// Inject Onfido SDK into login page",
        "onfidoScript = String("var body=document.body;\\n" +",
        "    "var script = document.createElement('script');\\n" +",
        "    "document.getElementById('callbacksPanel').style.display = 'none';\\n" +",
        "    "var onfido_div = document.createElement(\\"div\\");\\n" +",
        "    "onfido_div.id=\\"onfido-mount\\";\\n" +",
        "    "script.src = 'https://assets.onfido.com/web-sdk-releases/5.2.1/onfido.min.js';\\n" +",
        "    "var head = document.head; \\n " +",
        "    "var link = document.createElement(\\"link\\");  \\n" +",
        "    "     link.type = \\"text/css\\"; \\n " +",
        "    "     link.rel = \\"stylesheet\\"; \\n " +",
        "    "     link.href = 'https://assets.onfido.com/web-sdk-releases/5.2.1/style.css'; \\n " +",
        "    "    head.appendChild(link); \\n " +",
        "    ";\\n" +",
        "    "var onfido = {};\\n" +",
        "    "script.onload=function() {\\n" +",
        "    "    onfido=Onfido.init({\\n" +",
        "    "       token: '" + onfido_auth_token + "', \\n" +",
        "    "       useModal: true, \\n" +",
        "    "       isModalOpen: true, \\n" +",
        "    "       smsNumberCountryCode: '" + onfido_country_code + "', \\n" +",
        "    "       userDetails: { \\n" +",
        "    "           smsNumber: '" + smsNumber + "' \\n" +",
        "    "       }, \\n" +",
        "    "       steps: [\\n" +",
        "    "           {\\n" +",
        "    "               type:'welcome',\\n" +",
        "    "               options:{\\n" +",
        "    "                   title:'" + onfido_dialog_title + "',\\n" +",
        "    "                   descriptions:[\\n" +",
        "    "                       '" + onfido_dialog_msg1 + "',\\n" +",
        "    "                       '" + onfido_dialog_msg2 + "',\\n" +",
        "    "                   ]\\n" +",
        "    "               }\\n" +",
        "    "          },\\n" +",
        "    "          'document',\\n" +",
        "    "          'face',\\n" +",
        "    "          'complete',\\n" +",
        "    "       ],\\n" +",
        "    "       onComplete: function(data){ console.log('DONE'); onfido.setOptions({ isModalOpen:false }); document.getElementById('loginButton_0').click(); } \\n" +",
        "    "    })\\n" +",
        "    "};\\n" +",
        "    "document.body.appendChild(script);\\n");",
        "",
        "var fr = JavaImporter(",
        "    org.forgerock.openam.auth.node.api,",
        "    javax.security.auth.callback.NameCallback,",
        "    com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        ");",
        "",
        "with (fr) {",
        "    if (callbacks.isEmpty()) {",
        "        logger.error("Onfido-CaptureEvidence: Sending callbacks");",
        "        action = Action.send(new ScriptTextOutputCallback(onfidoScript)).build();",
        "    } else {",
        "        logger.error("Onfido-CaptureEvidence: End (outcome=true)");",
        "        action = Action.goTo("true").build();",
        "    }",
        "}",
      ],
    },
    "71b3c70b-920c-464b-a918-4c86eaaddccd": {
      "_id": "71b3c70b-920c-464b-a918-4c86eaaddccd",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Render a dropdown",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Dropdown",
      "script": [
        "/* Dropdown",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Render a dropdown selector",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "(function () {",
        "  outcome = "true";",
        "  var choices = [" ", "Red pill", "Blue pill", "Steak", "Rabbit hole"];",
        "  ",
        "  var fr = JavaImporter(",
        "    org.forgerock.openam.auth.node.api.Action,",
        "    javax.security.auth.callback.ChoiceCallback",
        "  )",
        "",
        "  if (callbacks.isEmpty()) {",
        "    action = fr.Action.send([",
        "      new fr.ChoiceCallback("Make your choice", choices, 0, false)",
        "    ]).build();",
        "  } else {",
        "    var choice = parseInt(callbacks.get(0).getSelectedIndexes()[0]);",
        "    nodeState.putShared("choice", choices[choice]);",
        "    action = fr.Action.goTo(outcome).build();",
        "  }",
        "}());",
      ],
    },
    "71e3b4ae-52c1-49d6-98fd-c279f43ea3ce": {
      "_id": "71e3b4ae-52c1-49d6-98fd-c279f43ea3ce",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "AAcustomLogic",
      "script": [
        "/*",
        "  - Data made available by nodes that have already executed are available in the sharedState variable.",
        "  - The script should set outcome to either "true" or "false".",
        " */",
        "outcome = "false";",
        "var predictionResult = sharedState.get("predictionResult");",
        "var predictionResultString = predictionResult.toString();",
        "",
        "var is_impossible_travel = 0;",
        "var is_credential_stuffing = 0;",
        "var is_automated_user_agent = 0;",
        "var is_brute_force = 0;",
        "var is_suspicious_ip = 0;",
        "",
        "var signal_count = 0;",
        "var position = 0;",
        "",
        "position = predictionResultString.search("is_impossible_travel=false");",
        "if(position<0)",
        "{",
        "  signal_count++;",
        "  is_impossible_travel=1;",
        "}",
        "position = predictionResultString.search("is_credential_stuffing=false");",
        "if(position<0)",
        "{",
        "  signal_count++;",
        "  is_credential_stuffing=1;",
        "}",
        "position = predictionResultString.search("is_automated_user_agent=false");",
        "if(position<0)",
        "{",
        "  signal_count++;",
        "  is_automated_user_agent=1;",
        "}",
        "position = predictionResultString.search("is_brute_force=false");",
        "if(position<0)",
        "{",
        "  signal_count++;",
        "  is_brute_force=1;",
        "}",
        "position = predictionResultString.search("is_suspicious_ip=false");",
        "if(position<0)",
        "{",
        "  signal_count++;",
        "  is_suspicious_ip=1;",
        "}",
        "",
        "sharedState.put("debug-signal-count",signal_count);",
        "if(signal_count>1)",
        "{",
        "     outcome="true"; ",
        "}",
        "",
        "",
        "",
      ],
    },
    "739bdc48-fd24-4c52-b353-88706d75558a": {
      "_id": "739bdc48-fd24-4c52-b353-88706d75558a",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Check if username has already been collected.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Check Username",
      "script": [
        "/* Check Username",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Check if username has already been collected.",
        " * Return "known" if yes, "unknown" otherwise.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - known",
        " * - unknown",
        " */",
        "(function () {",
        "    if (null != sharedState.get("username")) {",
        "        outcome = "known";",
        "    }",
        "    else {",
        "        outcome = "unknown";",
        "    }",
        "}());",
      ],
    },
    "73cecbfc-dad0-4395-be6a-6858ee3a80e5": {
      "_id": "73cecbfc-dad0-4395-be6a-6858ee3a80e5",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from Microsoft",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Microsoft Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        "{",
        "    "@odata.context": "https://graph.microsoft.com/v1.0/$metadata#users/$entity",",
        "    "@odata.id": "https://graph.microsoft.com/v2/711ffa9c-5972-4713-ace3-688c9732614a/directoryObjects/7d7759e2-36d8-4e64-b173-3f890d7d46d6/Microsoft.DirectoryServices.User",",
        "    "businessPhones": [",
        "        "18014735451"",
        "    ],",
        "    "displayName": "Volker Scheuber",",
        "    "givenName": "Volker",",
        "    "jobTitle": null,",
        "    "mail": "vscheuber@vscheuber.onmicrosoft.com",",
        "    "mobilePhone": null,",
        "    "officeLocation": null,",
        "    "preferredLanguage": null,",
        "    "surname": "Scheuber",",
        "    "userPrincipalName": "vscheuber@vscheuber.onmicrosoft.com",",
        "    "id": "7d7759e2-36d8-4e64-b173-3f890d7d46d6"",
        "}",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "logger.message("Kauai Microsoft Profile Normalization: rawProfile={}", rawProfile)",
        "",
        "return json(object(",
        "        field("id", rawProfile.id),",
        "        field("displayName", rawProfile.displayName),",
        "        field("givenName", rawProfile.givenName),",
        "        field("familyName", rawProfile.surname),",
        "        field("email", rawProfile.userPrincipalName),",
        "        field("username", rawProfile.userPrincipalName),",
        "        field("groups", rawProfile.groups)))",
      ],
    },
    "740cf6fa-a173-4e9d-b17c-44758e9b19ec": {
      "_id": "740cf6fa-a173-4e9d-b17c-44758e9b19ec",
      "context": "CONFIG_PROVIDER_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "CP-InnerTreeEvaluator-static-inner2",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "CP-ITE-static-inner2",
      "script": [
        "/*",
        " * Copyright 2021 ForgeRock AS. All Rights Reserved",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/**",
        " * The following script is a simplified template for understanding how to build",
        " * up a config Map object with custom values. The Config Provider Node will then",
        " * provide this config Map to the desired node type. It is important that the Map",
        " * you build here is named 'config'.",
        " *",
        " * Defined variables:",
        " *",
        " * nodeState - Node State (1)",
        " *           Always present, this represents the current values stored in the node state.",
        " *",
        " * idRepository - Profile Data (2)",
        " *           Always present, a repository to retrieve user information.",
        " *",
        " * secrets - Credentials and Secrets (3)",
        " *           Always present, an interface to access the Secrets API from a scripting context.",
        " *",
        " * requestHeaders (4) - Map (5)",
        " *           Always present, an object that provides methods for accessing headers in the login request.",
        " *",
        " * logger - Debug Logging (6)",
        " *          Always present, the debug logger instance.",
        " *",
        " * httpClient - HTTP Client (7)",
        " *          Always present, the HTTP client that can be used to make external HTTP requests.",
        " *",
        " * realm - String (primitive).",
        " *          Always present, the name of the realm the user is authenticating to.",
        " *",
        " * existingSession - Map<String, String> (5)",
        " *          Present if the request contains the session cookie, the user's session object. The returned map from",
        " *          SSOToken.getProperties() (8)",
        " *",
        " * requestParameters - Map (5)",
        " *          Always present, the object that contains the authentication request parameters.",
        " *",
        " *",
        " * Outputs:",
        " *",
        " * config - Map (5)",
        " *           Define and fill a Map object named 'config' with custom values, this will define the configuration for the",
        " *           associated node selected in the ConfigProviderNode.",
        " *",
        " * Reference:",
        " * (1) Node State - https://backstage.forgerock.com/docs/idcloud-am/latest/authentication-guide/scripting-api-node.html#scripting-api-node-nodeState",
        " * (2) Profile Data - https://backstage.forgerock.com/docs/am/7.1/authentication-guide/scripting-api-node.html#scripting-api-node-id-repo",
        " * (3) Credentials and Secrets - https://backstage.forgerock.com/docs/am/7.1/authentication-guide/scripting-api-node.html#scripting-api-authn-secrets",
        " * (4) Request Headers - https://backstage.forgerock.com/docs/am/7/authentication-guide/scripting-api-node.html#scripting-api-node-requestHeaders.",
        " * (5) Map - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/Map.html",
        " * (6) Debug Logging - https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.",
        " * (7) HTTP Client - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/http/Client.html.",
        " * (8) SSOToken - https://backstage.forgerock.com/docs/am/7/apidocs/com/iplanet/sso/SSOToken.html.",
        " */",
        "",
        "config = {",
        "  tree: 'inner2'",
        "};",
      ],
    },
    "743351b3-001a-4ec8-b3ac-a674ddb8de22": {
      "_id": "743351b3-001a-4ec8-b3ac-a674ddb8de22",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Enrich user session with UOP class ID.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "UOP Enrich Session",
      "script": [
        "/* UOP Enrich Session",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Add current class ID to user session.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is. ",
        " * It requires the Identify Existing User node before it is being called.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * - false",
        " */",
        "logger.warning("UOP Enrich Session: start");",
        "outcome = "false";",
        "",
        "if (sharedState.get("uopCurrentClassID")) {",
        "    outcome = "true";",
        "    logger.warning("UOP Enrich Session: going to enrich session with class id: ".concat(sharedState.get("uopCurrentClassID")));",
        "  ",
        "    var fr = JavaImporter(",
        "      org.forgerock.openam.auth.node.api",
        "    );",
        "",
        "    with (fr) {",
        "        logger.warning("UOP Enrich Session: End (outcome=".concat(outcome).concat(")"));",
        "        action = Action.goTo(outcome).putSessionProperty("UOPClassID", sharedState.get("uopCurrentClassID")).build();",
        "    }",
        "  ",
        "} else {",
        "    logger.error("UOP Enrich Session: no classes!");",
        "    logger.warning("UOP Enrich Session: End (outcome=".concat(outcome).concat(")"));",
        "}",
      ],
    },
    "76421cb0-0550-43e7-89f8-51ad1d95d306": {
      "_id": "76421cb0-0550-43e7-89f8-51ad1d95d306",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Detect and preserve currently active theme before setting the new theme.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Set Theme",
      "script": [
        "/* Set Theme",
        " * ",
        " * Detect and preserve currently active theme before setting the new theme.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "      outcome = "true";",
        "      ",
        "      var theme = "Expanse_MFA";",
        "",
        "    // do not change, must be a random identifier",
        "    var anchor = generateNumericToken('xxx');",
        "  ",
        "      var script = "";",
        "    script += "document.getElementById(\\"theme-id-"+anchor+"\\").value = localStorage.getItem('theme-id');";",
        "    script += "console.log('theme-id='+document.getElementById(\\"theme-id-"+anchor+"\\").value);";",
        "      script += "document.getElementById(\\"loginButton_0\\").click();";",
        "",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "          org.forgerock.openam.authentication.callbacks.PollingWaitCallback,",
        "        com.sun.identity.authentication.callbacks.HiddenValueCallback,",
        "        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        "    )",
        "    // discover active theme from UI",
        "    if (callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "            new fr.HiddenValueCallback("theme-id-"+anchor, "false"),",
        "            new fr.ScriptTextOutputCallback(script)",
        "        ).build();",
        "    }",
        "      // get active theme from callback and set new theme",
        "      else if (callbacks.size() === 2) {",
        "        // did we get the id of the currently active theme?",
        "        if (callbacks.get(0).getValue() !== "theme-id-"+anchor) {",
        "              sharedState.put("themeId", callbacks.get(0).getValue());",
        "        }",
        "        // set new theme",
        "        var stage = "themeId="+theme;",
        "        action = fr.Action.send(",
        "              new fr.PollingWaitCallback("100", "Please wait ...")",
        "        ).withStage(stage).build();",
        "    }",
        "      else {",
        "        // continue",
        "        action = fr.Action.goTo(outcome).build();",
        "    }",
        "",
        "     /*",
        "      * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "      * ",
        "      * Example:",
        "      * 'xxxxx' produces '28535'",
        "      * 'xxx-xxx' produces '432-521'",
        "      */",
        "    function generateNumericToken(format) {",
        "        return format.replace(/[x]/g, function(c) {",
        "            var r = Math.random()*10|0;",
        "            var v = r;",
        "            return v.toString(10);",
        "        });",
        "    }",
        "}());",
      ],
    },
    "766ed2a6-29dd-4bd7-a60d-9eabbd63545c": {
      "_id": "766ed2a6-29dd-4bd7-a60d-9eabbd63545c",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Service Account - Verify JWT",
      "script": [
        "var fr = JavaImporter(",
        "  org.forgerock.util.Options,",
        "  org.forgerock.json.jose.jwk.JWKSet,",
        "  org.forgerock.json.jose.jws.SigningManager,",
        "  org.forgerock.json.jose.builders.JwtBuilderFactory,",
        "  org.forgerock.json.jose.jws.SignedJwt",
        ");",
        "",
        "var sm = new fr.SigningManager();",
        "",
        "function getJWKs(svcAcctId) {",
        "  var svcAcct = idRepository.getIdentity(svcAcctId);",
        "  if (svcAcct == null) {",
        "    logger.message('No service account found for {}', svcAcctId);",
        "    return null;",
        "  }",
        "  var jwksAttrs = svcAcct.getAttributeValues('fr-attr-jwks');",
        "  if (!jwksAttrs || jwksAttrs.length === 0) {",
        "    logger.message('No jwks attributes in issuer');",
        "    return null;",
        "  }",
        "  var jwkSet = jwksAttrs[0];",
        "  if (!jwkSet) {",
        "    logger.message('No jwk set in jwks attribute in issuer');",
        "    return null;",
        "  }",
        "  return fr.JWKSet.parse(jwkSet).getJWKsAsList();",
        "}",
        "",
        "outcome = (function () {",
        "  var authz = requestHeaders.get('authorization');",
        "  if (authz === null || authz.length === 0 || authz[0].indexOf('svcacct') !== 0) {",
        "    logger.message('No authorization header');",
        "    return 'False';",
        "  }",
        "",
        "  authz = authz[0].split(' ');",
        "  if (authz.length !== 3) {",
        "    logger.message('Bad authorization header length {}', authz.length);",
        "    return 'False';",
        "  }",
        "  var svcAcctId = authz[1];",
        "  var jwt = authz[2];",
        "  var signedJwt = new fr.JwtBuilderFactory().reconstruct(jwt, fr.SignedJwt);",
        "",
        "  var jwks = getJWKs(svcAcctId);",
        "  for (var i = 0; i < jwks.size(); i++) {",
        "    var verifier = sm.newVerificationHandler(jwks.get(i))",
        "    if (signedJwt.verify(verifier)) {",
        "      nodeState.putShared("username", svcAcctId);",
        "      return 'True';",
        "    }",
        "  }",
        "",
        "  logger.message('Could not verify jwt');",
        "  return 'False';",
        "})();",
      ],
    },
    "779bb956-676d-4e44-b828-b9efa3c866d4": {
      "_id": "779bb956-676d-4e44-b828-b9efa3c866d4",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "ForgeRockVpnOnly",
      "script": [
        "/*",
        "  - Data made available by nodes that have already executed are available in the sharedState variable.",
        "  - The script should set outcome to either "true" or "false".",
        " */",
        "",
        "var validIpAddresses = [",
        "  "37.71.148.92", // FR Grenoble",
        "  "84.214.156.50", // FR Oslo",
        "  "180.255.64.26", // FR Singapore",
        "  "128.106.105.136", // FR Singapore Sales",
        "  "188.39.235.130", // FR Bristol",
        "  "78.33.22.162", // FR Bristol Marsh Street",
        "  "65.113.98.10", // FR San Francisco",
        "  "24.155.146.18" // FR Austin",
        "];",
        "",
        "try {",
        "  outcome = function() {",
        "    logger.message(requestHeaders);",
        "    var vpnBypassSecret = systemEnv.getProperty('esv.amadmin.vpn.bypass.secret', '') + '';",
        "    var bypassHeader = requestHeaders.get(new java.lang.String('x-forgerock-tests-bearer'));",
        "    logger.message("checking for VPN bypass - header {} to match secret {}", bypassHeader, vpnBypassSecret);",
        "    if (vpnBypassSecret && bypassHeader && bypassHeader.size() === 1) {",
        "      logger.message("bypass header is present");",
        "      if (bypassHeader.get(0) + '' === vpnBypassSecret + '') {",
        "        logger.warning("bypassing VPN check - request from tests authorized");",
        "        return 'True';",
        "      }",
        "    }",
        "    var clientIpAddresses = requestHeaders.get(new java.lang.String('x-forwarded-for'));",
        "    logger.message(clientIpAddresses);",
        "    if (!clientIpAddresses) {",
        "      logger.message("No forwarded header - internal cluster request");",
        "      return 'True';",
        "    }",
        "    for (var i = 0; i < clientIpAddresses.size(); i++) {",
        "      var clientIpHeader = clientIpAddresses.get(i);",
        "      var ipAddresses = clientIpHeader.split(',');",
        "      for (var j = 0; j < ipAddresses.length; j++) {",
        "        var clientIp = ipAddresses[j].trim();",
        "        logger.message('Checking client IP ' + clientIp);",
        "        for (var k = 0; k < validIpAddresses.length; k++) {",
        "          if (clientIp + '' === validIpAddresses[k]) {",
        "            logger.warning("request from ForgeRock VPN authorized");",
        "            return 'True';",
        "          }",
        "        }",
        "      }",
        "    }",
        "    logger.warning("request from outside the cluster and not from ForgeRock VPN rejected");",
        "    return 'False';",
        "  }();",
        "",
        "} catch (e) {",
        "",
        "  logger.error('ForgeRockVpnOnly failed to check IP');",
        "  logger.error(e);",
        "  outcome = 'Error';",
        "",
        "}",
        "",
      ],
    },
    "790045fa-a325-4e3e-96f8-d4a91b32e9de": {
      "_id": "790045fa-a325-4e3e-96f8-d4a91b32e9de",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Use Have I Been Pwned Password to check if password has been breached.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "HIBP Password Breach Analysis",
      "script": [
        "/* HIBP Password Breach Analysis",
        " *",
        " * Authors: jon.knight@forgerock.com, volker.scheuber@forgerock.com",
        " * ",
        " * Use Have I Been Pwned Password to check if password has been breached.",
        " * Calls HIBP API to retrieve the count of matching passwords in breached ",
        " * password database",
        " * ",
        " * This script needs to be parametrized. It will not work properly as is. ",
        " * It requires the Password or Platform Password collector nodes before",
        " * it can operate.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - clear",
        " *   The number of breaches for password was either zero or less than the ",
        " *   value of THRESHOLD",
        " * - breached ",
        " *   The number of incidents of the password in the breached password ",
        " *   database exceeds THRESHOLD",
        " * - failed",
        " *   The API call was rejected.",
        " */",
        "(function () {",
        "    var USER_AGENT="ForgeRock";",
        "    var HIBP_API_KEY=systemEnv.getProperty("esv.hibp.api.key");",
        "    var THRESHOLD=0;",
        "",
        "    function toHexString(byteArray) {",
        "        var s = '';",
        "        byteArray.forEach(function(byte) {",
        "            s += ('0' + (byte & 0xFF).toString(16)).slice(-2);",
        "        });",
        "        return s;",
        "    }",
        "",
        "    outcome = "failed";",
        "",
        "    var md = java.security.MessageDigest.getInstance('SHA-1');",
        "      var password = nodeState.get("password").asString();",
        "//      var password = new java.lang.String("");",
        "//      if (nodeState.get("password")) {",
        "//      password = nodeState.get("password").asString();",
        "//    }",
        "    var byteArray = password.getBytes("UTF-8");",
        "    md.update(byteArray);",
        "    var digest = md.digest();",
        "    var hex = String(toHexString(digest)).toUpperCase();",
        "",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setMethod('GET');",
        "    request.setUri('https://api.pwnedpasswords.com/range/' + hex.substring(0,5));",
        "    request.getHeaders().add("Accept","*/*");",
        "    request.getHeaders().add("Content-Type","application/json");",
        "    request.getHeaders().add("User-Agent", USER_AGENT);",
        "    request.getHeaders().add("hibp-api-key", HIBP_API_KEY);",
        "",
        "    var response = httpClient.send(request).get();",
        "",
        "    if (response.getStatus().getCode() === 200) {",
        "        var max = 0;",
        "        outcome = "clear";",
        "        var result = response.getEntity().getString();",
        "        var lines = result.split('\\n');",
        "        for (i=0; i<lines.length; i++) {",
        "            var prefix = lines[i].split(':')[0];",
        "            if (String(hex.substring(0,5) + prefix) == hex) {",
        "                var count = lines[i].split(':')[1];",
        "                if (count > max) max = count;",
        "            }",
        "        }",
        "        if (max > THRESHOLD) outcome = "breached";",
        "        sharedState.put("hibp_password_count", max);",
        "    }",
        "}());",
      ],
    },
    "7dce8f07-d9fe-4752-94b9-ff99dfd0433b": {
      "_id": "7dce8f07-d9fe-4752-94b9-ff99dfd0433b",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Parse parameters of the incoming call.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Twilio IVR: Parse Call Parameters",
      "script": [
        "/* Twilio IVR Integration",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * - false",
        " * ",
        " * Depending on the amount of data collected through callbacks and how many of the callParams",
        " * you activate below, you will need to change your authentication session from JWT to CTS or",
        " * Memory.",
        " */",
        "",
        "logger.warning("Twilio IVR: Parse Call Parameters: start");",
        "outcome = "false";",
        "",
        "/* Begin Twilio IVR Configuration Parameters",
        " *",
        " * These are used to protect this journey so it is only being executed by your Twilio account.",
        " */",
        "var TWILIO_ACCOUNT_SID = "AC750415e3163a2e57b7aeea7eed82d944";",
        "var TWILIO_PHONE_NUMBER = "+13176443107";",
        "",
        "// keep the params to a minimum to minimize authentication session size",
        "var callParams = {",
        "  //"CallSid" : decodeURIComponent(requestParameters.get("CallSid").get(0)),",
        "  "AccountSid" : decodeURIComponent(requestParameters.get("AccountSid").get(0)),",
        "  "From" : decodeURIComponent(requestParameters.get("From").get(0)),",
        "  "To" : decodeURIComponent(requestParameters.get("To").get(0)),",
        "  //"CallStatus" : decodeURIComponent(requestParameters.get("CallStatus").get(0)),",
        "  //"ApiVersion" : decodeURIComponent(requestParameters.get("ApiVersion").get(0)),",
        "  //"Direction" : decodeURIComponent(requestParameters.get("Direction").get(0)),",
        "  //"ForwardedFrom" : decodeURIComponent(requestParameters.get("ForwardedFrom").get(0)),",
        "  //"CallerName" : decodeURIComponent(requestParameters.get("CallerNameCallerName").get(0)),",
        "  //"ParentCallSid" : decodeURIComponent(requestParameters.get("ParentCallSid").get(0)),",
        "  //"FromCity" : decodeURIComponent(requestParameters.get("FromCity").get(0)),",
        "  //"FromState" : decodeURIComponent(requestParameters.get("FromState").get(0)),",
        "  //"FromZip" : decodeURIComponent(requestParameters.get("FromZip").get(0)),",
        "  //"FromCountry" : decodeURIComponent(requestParameters.get("FromCountry").get(0)),",
        "  //"ToCity" : decodeURIComponent(requestParameters.get("ToCity").get(0)),",
        "  //"ToState" : decodeURIComponent(requestParameters.get("ToState").get(0)),",
        "  //"ToZip" : decodeURIComponent(requestParameters.get("ToZip").get(0)),",
        "  //"ToCountry" : decodeURIComponent(requestParameters.get("ToCountry").get(0)),",
        "};",
        "",
        "/* End Twilio IVR Configuration Parameters ",
        " */",
        "",
        "if (callParams.AccountSid == TWILIO_ACCOUNT_SID &&",
        "    callParams.To == TWILIO_PHONE_NUMBER) ",
        "{",
        "      outcome = "true";",
        "    sharedState.put("TwilioIVRCallParams", callParams);",
        "    setSharedObjectAttribute("telephoneNumber", callParams.From);",
        "}",
        "",
        "logger.warning("Twilio IVR: Parse Call Parameters: finish [outcome=".concat(outcome).concat("]"));",
        "",
        "/*",
        " * Store attributes in shared state for use with the Create/Patch Object nodes.",
        " */",
        "function setSharedObjectAttribute(name, value) {",
        "       var storage = sharedState.get("objectAttributes");",
        "    if (storage && value) {",
        "          if (storage.put) {",
        "              storage.put(name, value);",
        "        }",
        "          else {",
        "              storage[name] = value;",
        "        }",
        "    }",
        "    else if (value) {",
        "        sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "    }",
        "}",
      ],
    },
    "7dd80834-e7b2-4737-85a7-40434bb19dde": {
      "_id": "7dd80834-e7b2-4737-85a7-40434bb19dde",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Store the impersontor and impersonatee profile information in session properties.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Impersonate: Update Session Properties",
      "script": [
        "/* Impersonate: Update Session Properties",
        " * ",
        " * Store the impersontor and impersonatee profile information in session properties.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: jake.feasel@forgerock.com, volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "      logger.message("Impersonate: Update Session Properties: start");",
        "      outcome = "true";",
        "  ",
        "    var goTo = org.forgerock.openam.auth.node.api.Action.goTo;",
        "    myGoto = goTo(outcome);",
        "    myGoto.putSessionProperty("userName", sharedState.get("username"));",
        "    myGoto.putSessionProperty("impersonator", sharedState.get("impersonator"));",
        "",
        "      logger.message("Impersonate: Update Session Properties: done [outcome={}]", outcome);",
        "    action = myGoto.build();",
        "}());",
      ],
    },
    "7e3d7067-d50f-4674-8c76-a3e13a810c33": {
      "_id": "7e3d7067-d50f-4674-8c76-a3e13a810c33",
      "context": "AUTHENTICATION_SERVER_SIDE",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Default global script for server side Scripted Authentication Module",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Scripted Module - Server Side",
      "script": [
        "/*",
        " * Copyright 2015-2017 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "var START_TIME = 9;  // 9am",
        "var END_TIME   = 17; // 5pm",
        "var longitude, latitude;",
        "var localTime;",
        "",
        "logger.message("Starting scripted authentication");",
        "logger.message("User: " + username);",
        "",
        "var userPostalAddress = getUserPostalAddress();",
        "logger.message("User address: " + userPostalAddress);",
        "",
        "getLongitudeLatitudeFromUserPostalAddress();",
        "getLocalTime();",
        "",
        "logger.message("Current time at the users location: " + localTime.getHours());",
        "if (localTime.getHours() < START_TIME || localTime.getHours() > END_TIME) {",
        "    logger.error("Login forbidden outside work hours!");",
        "    authState = FAILED;",
        "} else {",
        "    logger.message("Authentication allowed!");",
        "    authState = SUCCESS;",
        "}",
        "",
        "function getLongitudeLatitudeFromUserPostalAddress() {",
        "",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setUri("http://maps.googleapis.com/maps/api/geocode/json?address=" + encodeURIComponent(userPostalAddress));",
        "      request.setMethod("GET");",
        "      //the above URI has to be extended with an API_KEY if used in a frequent manner",
        "      //see documentation: https://developers.google.com/maps/documentation/geocoding/intro",
        "",
        "    var response = httpClient.send(request).get();",
        "    logResponse(response);",
        "",
        "    var geocode = JSON.parse(response.getEntity().getString());",
        "    var i;",
        "    for (i = 0; i < geocode.results.length; i++) {",
        "        var result = geocode.results[i];",
        "        latitude = result.geometry.location.lat;",
        "        longitude = result.geometry.location.lng;",
        "      ",
        "           logger.message("latitude:" + latitude + " longitude:" + longitude);",
        "    }",
        "}",
        "",
        "function getLocalTime() {",
        "",
        "    var now = new Date().getTime() / 1000;",
        "    var location = "location=" + latitude + "," + longitude;",
        "    var timestamp = "timestamp=" + now;",
        "        ",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setUri("https://maps.googleapis.com/maps/api/timezone/json?" + location + "&" + timestamp);",
        "      request.setMethod("GET");",
        "      //the above URI has to be extended with an API_KEY if used in a frequent manner",
        "      //see documentation: https://developers.google.com/maps/documentation/timezone/intro",
        "",
        "    var response = httpClient.send(request).get();",
        "    logResponse(response);",
        "",
        "    var timezone = JSON.parse(response.getEntity().getString());",
        "    var localTimestamp = parseInt(now) + parseInt(timezone.dstOffset) + parseInt(timezone.rawOffset);",
        "    localTime = new Date(localTimestamp*1000);",
        "}",
        "",
        "function getUserPostalAddress() {",
        "    var userAddressSet = idRepository.getAttribute(username, "postalAddress");",
        "    if (userAddressSet == null || userAddressSet.isEmpty()) {",
        "        logger.warning("No address specified for user: " + username);",
        "        return false;",
        "    }",
        "    return userAddressSet.iterator().next()",
        "}",
        "",
        "function logResponse(response) {",
        "    logger.message("User REST Call. Status: " + response.getStatus() + ", Body: " + response.getEntity().getString());",
        "}",
      ],
    },
    "7fb962a5-9f20-41d3-a077-b424a29c1198": {
      "_id": "7fb962a5-9f20-41d3-a077-b424a29c1198",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Evaluate IPv4 CIDR access rules from "esv-ipv4-cidr-access-rules".",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "IPv4 CIDR Rules Engine",
      "script": [
        "/* IPv4 CIDR Rules Engine",
        " *",
        " * Author: volker.scheuber@forgerock.com, justin.chin@forgerock.com",
        " * ",
        " * Evaluate IPv4 CIDR access rules from "esv-ipv4-cidr-access-rules". ",
        " * Access rules must have the following format:",
        " * {",
        " *   "allow": [",
        " *     "140.118.0.0/16",",
        " *     "110.35.0.0/16",",
        " *     "131.26.0.0/16",",
        " *     "92.61.21.153/32"",
        " *   ]",
        " * }",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - allow",
        " * - deny",
        " */",
        "(function () {",
        "  outcome = "deny";",
        "  ",
        "  var rules = JSON.parse(systemEnv.getProperty("esv.ipv4.cidr.access.rules"));",
        "  var allow = rules['allow'];",
        "",
        "  /*",
        "   * Returns the value of the requested header",
        "   */",
        "  function getHeader(headerName) {",
        "    return requestHeaders.get(headerName).get(0);",
        "  }",
        "",
        "  /*",
        "   * Returns the client's IP address",
        "   */",
        "  function getClientIPAddress() {",
        "    return getHeader("x-forwarded-for").split(',')[0];",
        "  }",
        "",
        "  function IPnumber(IPaddress) {",
        "    var ip = IPaddress.match(/^(\\d+)\\.(\\d+)\\.(\\d+)\\.(\\d+)$/);",
        "    if (ip) {",
        "      return (+ip[1] << 24) + (+ip[2] << 16) + (+ip[3] << 8) + +ip[4];",
        "    }",
        "    // else ... ?",
        "    return null;",
        "  }",
        "",
        "  function IPmask(maskSize) {",
        "    return -1 << (32 - maskSize);",
        "  }",
        "",
        "  function isAllowed(ip) {",
        "    var allowed = false;",
        "    allow.forEach((cidr) => {",
        "      if (",
        "        (IPnumber(ip) & IPmask(cidr.split('/')[1])) ==",
        "        IPnumber(cidr.split('/')[0])",
        "      ) {",
        "        allowed = true;",
        "      }",
        "    });",
        "    return allowed;",
        "  }",
        "  ",
        "  if (isAllowed(getClientIPAddress())) {",
        "    outcome = "allow";",
        "  }",
        "}());",
      ],
    },
    "809330cf-874c-4d57-a8f1-5882c6dd855b": {
      "_id": "809330cf-874c-4d57-a8f1-5882c6dd855b",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Converts a normalized social profile for iddataweb into a Managed user",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Normalized idddataweb Profile to Managed User",
      "script": [
        "/* Normalized idddataweb Profile to Managed User",
        " * Copyright 2022 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS. Not for production use.",
        " * Modified by Stephen Payne, 2021-Mar-30",
        " */",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "import org.forgerock.json.JsonValue",
        "logger.error("Normalized_Profile_IDDataWeb: Start " + normalizedProfile);",
        "",
        "JsonValue managedUser = json(object(",
        "        field("givenName", normalizedProfile.givenName),",
        "        field("sn", normalizedProfile.familyName),",
        "        field("userName", normalizedProfile.username)))",
        "if (normalizedProfile.postalAddress.isNotNull()) managedUser.put("postalAddress", normalizedProfile.postalAddress)",
        "if (normalizedProfile.addressLocality.isNotNull()) managedUser.put("city", normalizedProfile.addressLocality)",
        "if (normalizedProfile.addressRegion.isNotNull()) managedUser.put("stateProvince", normalizedProfile.addressRegion)",
        "if (normalizedProfile.postalCode.isNotNull()) managedUser.put("postalCode", normalizedProfile.postalCode)",
        "if (normalizedProfile.country.isNotNull()) managedUser.put("country", normalizedProfile.country)",
        "if (normalizedProfile.phone.isNotNull()) managedUser.put("telephoneNumber", normalizedProfile.phone)",
        "if (normalizedProfile.DOB.isNotNull()) managedUser.put("frIndexedString2", normalizedProfile.DOB)",
        "",
        "return managedUser",
        "",
      ],
    },
    "80c3e733-ae51-4851-a01d-1cbf193c80e9": {
      "_id": "80c3e733-ae51-4851-a01d-1cbf193c80e9",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Activates the admin's account",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_SetOnboardingAttributes",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "function utcNow() {",
        "  return new Date().toISOString();",
        "}",
        "",
        "try {",
        "  ",
        "  var OBJECT_ATTRS = 'objectAttributes';",
        "",
        "  // Start by getting object attributes from shared state",
        "  var sharedObjAttrs = sharedState.get(OBJECT_ATTRS);",
        "  sharedObjAttrs.put('accountStatus', 'Active');",
        "  sharedObjAttrs.put('onboardDate', utcNow());",
        "  ",
        "  // Copy attributes from transient state",
        "  var transientObjAttrs = nodeState.get(OBJECT_ATTRS);",
        "  var attrs = ['aliasList', 'givenName', 'password', 'sn'];",
        "  for (var i = 0; i < attrs.length; i++) {",
        "    var val = transientObjAttrs.get(attrs[i]);",
        "    if (val.isNotNull()) {",
        "      sharedObjAttrs.put(attrs[i], val);",
        "    }",
        "  }",
        "  ",
        "  // Ensure object attributes match in both shared and transient state",
        "  nodeState.putTransient(OBJECT_ATTRS, sharedObjAttrs);",
        "  sharedState.put(OBJECT_ATTRS, sharedObjAttrs);",
        "  outcome = 'Success';",
        "",
        "} catch (e) {",
        "",
        "  logger.error('Failed to set attributes to complete onboarding: {}', e);",
        "  outcome = 'Error';",
        "",
        "}",
        "",
      ],
    },
    "847aab1b-c739-4d64-b26c-180f96cba02b": {
      "_id": "847aab1b-c739-4d64-b26c-180f96cba02b",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Select and apply theme from based on the browser language in the request.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Select Theme by Browser Language",
      "script": [
        "/* Select Theme by Browser Language",
        " * ",
        " * Select and apply theme from based on the browser language in the request.",
        " * ",
        " * This script needs to be parametrized!",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    /******************************/",
        "    /* Begin Script Configuration */",
        "",
        "    // the script expects the themes to be named <baseTheme>_<language>, e.g. "Zardoz_en"",
        "    var baseTheme = "Zardoz";",
        "",
        "    // add all the language codes you want to support",
        "    var supportedLanguages = ["de", "en", "fr"];",
        "",
        "    // specify the default language to fall back on if the browser language is not a supported language",
        "    var defaultLanguage = "en";",
        "",
        "    /* End Script Configuration   */",
        "    /******************************/",
        "",
        "    outcome = "true";",
        "    var theme = getThemeByLanguage(baseTheme);",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "        org.forgerock.openam.authentication.callbacks.PollingWaitCallback",
        "    )",
        "    if (theme && callbacks.isEmpty()) {",
        "        var stage = "themeId=" + theme;",
        "        action = fr.Action.send(",
        "            new fr.PollingWaitCallback("100", "Please wait ...")",
        "        ).withStage(stage).build();",
        "    } else {",
        "        action = fr.Action.goTo(outcome).build();",
        "    }",
        "",
        "    /*",
        "     * Returns the name of the theme to select based on browser language",
        "     */",
        "    function getThemeByLanguage(theme) {",
        "        var languageHeader = getHeader("accept-language");",
        "        var language = languageHeader.split(';')[0].split(',')[0].split('-')[0];",
        "        if (supportedLanguages.indexOf(language) < 0) {",
        "            language = defaultLanguage;",
        "        }",
        "        return theme + "_" + language;",
        "    }",
        "",
        "    /*",
        "     * Returns the value of the requested header",
        "     */",
        "    function getHeader(headerName) {",
        "        return requestHeaders.get(headerName).get(0) + "";",
        "    }",
        "}());",
      ],
    },
    "849ef5f3-7481-4607-a668-f0b5bf47db4c": {
      "_id": "849ef5f3-7481-4607-a668-f0b5bf47db4c",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Goodbye Message",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Twilio IVR: Goodbye Message",
      "script": [
        "/* Twilio IVR: Goodbye Message",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * ",
        " * Depending on the amount of data collected through callbacks and how many of the callParams",
        " * you activate below, you will need to change your authentication session from JWT to CTS or",
        " * Memory.",
        " */",
        "logger.warning("Twilio IVR: Goodbye Message: start");",
        "outcome = "true";",
        "",
        "/* Begin Configuration",
        " */",
        "",
        "// Build out the full message",
        "var message = "Thank you for calling ForgeRock Identity Cloud. Goodbye!";",
        "",
        "/* End Configuration",
        " */",
        "",
        "var fr = JavaImporter(",
        "      org.forgerock.openam.auth.node.api,",
        "      javax.security.auth.callback.TextOutputCallback",
        ");",
        "  ",
        "with (fr) {",
        "      if (callbacks.isEmpty()) {",
        "        var output = new TextOutputCallback(TextOutputCallback.INFORMATION, message);",
        "        action = Action.send(output).build();",
        "      } ",
        "      else {",
        "        logger.warning("Twilio IVR: Goodbye Message: finish [outcome=".concat(outcome).concat("]"));",
        "        action = Action.goTo(outcome).build();",
        "      }",
        "}",
      ],
    },
    "8508a00e-ad45-4310-b3c7-c6871b6a41a9": {
      "_id": "8508a00e-ad45-4310-b3c7-c6871b6a41a9",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Browser Language Decision",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Browser Language Decision",
      "script": [
        "/* Browser Language Decision",
        " * ",
        " * Detect the browser language in the request and branch out to its named exit (e.g.: "de" or "en" or "fr") ",
        " * if it is part of the supportedLanguages array, otherwise take the "other" exit.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - other",
        " * - <all of the items in the supportedLanguages array>",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "      /******************************/",
        "      /* Begin Script Configuration */",
        "      ",
        "      // add all the language codes you want to support",
        "      var supportedLanguages = ["de","en","fr"];",
        "      ",
        "      /* End Script Configuration   */",
        "      /******************************/",
        "  ",
        "      outcome = getBrowserLanguage();",
        "      ",
        "    /*",
        "     * Returns the supported browser language or "other"",
        "     */",
        "    function getBrowserLanguage() {",
        "          var languageHeader = getHeader("accept-language");",
        "          var language = languageHeader.split(';')[0].split(',')[0].split('-')[0];",
        "          if (supportedLanguages.indexOf(language) < 0) {",
        "              return "other";",
        "        }",
        "        return language;",
        "    }",
        "",
        "    /*",
        "     * Returns the value of the requested header",
        "     */",
        "    function getHeader(headerName) {",
        "        return requestHeaders.get(headerName).get(0)+"";",
        "    }",
        "}());",
      ],
    },
    "85523e71-2d77-4577-b078-6f9674cc54e2": {
      "_id": "85523e71-2d77-4577-b078-6f9674cc54e2",
      "context": "SAML2_IDP_ADAPTER",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Always redirect browser pre-auth",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Saml2 IDP Adapter Always Auth",
      "script": [
        "/*",
        " * Copyright 2021-2022 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        " * The script has these top level functions that could be executed during a SAML2 flow.",
        " *      - preSingleSignOn",
        " *      - preAuthentication",
        " *      - preSendResponse",
        " *      - preSignResponse",
        " *      - preSendFailureResponse",
        " *",
        " * Please see the javadoc for the interface definition and more information about these methods.",
        " * https://backstage.forgerock.com/docs/am/7.2/apidocs/com/sun/identity/saml2/plugins/SAML2IdentityProviderAdapter.html",
        " * Note that the initialize method is not supported in the scripts.",
        " *",
        " * Defined variables. Check the documentation on the respective functions for the variables available to it.",
        " *",
        " * hostedEntityId - String",
        " *     Entity ID for the hosted IDP",
        " * realm - String",
        " *     Realm of the hosted IDP",
        " * idpAdapterScriptHelper - IdpAdapterScriptHelper (1)",
        " *     An instance of IdpAdapterScriptHelper containing helper methods. See Javadoc for more details.",
        " * request - HttpServletRequest (2)",
        " *     Servlet request object",
        " * response - HttpServletResponse (3)",
        " *     Servlet response object",
        " * authnRequest - AuthnRequest (4)",
        " *     The original authentication request sent from SP",
        " * reqId - String",
        " *     The id to use for continuation of processing if the adapter redirects",
        " * res - Response (5)",
        " *     The SAML Response",
        " * session - SSOToken (6)",
        " *     The single sign-on session. The reference type of this is Object and would need to be casted to SSOToken.",
        " * relayState - String",
        " *     The relayState that will be used in the redirect",
        " * faultCode - String",
        " *     the fault code that will be returned in the SAML response",
        " * faultDetail - String",
        " *     the fault detail that will be returned in the SAML response",
        " * logger - Logger instance",
        " *     https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.",
        " *     Corresponding log files will be prefixed with: scripts.<script name>",
        " *",
        " * Throws SAML2Exception (7):",
        " *     for any exceptions occurring in the adapter. The federation process will continue",
        " *",
        " * Class reference:",
        " * (1) idpAdapterScriptHelper - https://backstage.forgerock.com/docs/am/7.2/apidocs/com/sun/identity/saml2/plugins/scripted/IdpAdapterScriptHelper.html.",
        " * (2) HttpServletRequest - https://tomcat.apache.org/tomcat-7.0-doc/servletapi/javax/servlet/http/HttpServletRequest.html.",
        " * (3) HttpServletResponse - https://tomcat.apache.org/tomcat-7.0-doc/servletapi/javax/servlet/http/HttpServletResponse.html.",
        " * (4) AuthnRequest - https://backstage.forgerock.com/docs/am/7.2/apidocs/com/sun/identity/saml2/protocol/AuthnRequest.html.",
        " * (5) Response - https://backstage.forgerock.com/docs/am/7.2/apidocs/com/sun/identity/saml2/protocol/Response.html.",
        " * (6) SSOToken - https://backstage.forgerock.com/docs/am/7.2/apidocs/com/iplanet/sso/SSOToken.html.",
        " * (7) SAML2Exception - https://backstage.forgerock.com/docs/am/7.2/apidocs/com/sun/identity/saml2/common/SAML2Exception.html.",
        " */",
        "",
        "/*",
        " * Template/default script for SAML2 IDP Adapter scripted plugin.",
        " */",
        "",
        "/*",
        " * Available variables for preSingleSignOn:",
        " *     hostedEntityId",
        " *     realm",
        " *     idpAdapterScriptHelper",
        " *     request",
        " *     authnRequest",
        " *     response",
        " *     reqId",
        " *     logger",
        " *",
        " * Return - true if browser redirection is happening after processing, false otherwise. Default to false.",
        " */",
        "function preSingleSignOn () {",
        "      logger.error("Chicago: preSingleSignOn");",
        "    return true;",
        "}",
        "",
        "/*",
        " * Available variables for preAuthentication:",
        " *     hostedEntityId",
        " *     realm",
        " *     idpAdapterScriptHelper",
        " *     request",
        " *     authnRequest",
        " *     response",
        " *     reqId",
        " *     session",
        " *     relayState",
        " *     logger",
        " *",
        " * Return - true if browser redirection is happening after processing, false otherwise. Default to false.",
        " */",
        "function preAuthentication () {",
        "      logger.error("Chicago: preAuthentication");",
        "    return true;",
        "}",
        "",
        "/*",
        " * Available variables for preSendResponse:",
        " *     hostedEntityId",
        " *     realm",
        " *     idpAdapterScriptHelper",
        " *     request",
        " *     authnRequest",
        " *     response",
        " *     reqId",
        " *     session",
        " *     relayState",
        " *     logger",
        " *",
        " * Return - true if browser redirection happened after processing, false otherwise. Default to false.",
        " */",
        "function preSendResponse () {",
        "      logger.error("Chicago: preSendResponse");",
        "      logger.error("Chicago: authnRequest: "+authnRequest);",
        "      response.sendRedirect("https://idc.scheuber.io/am/XUI/?realm=alpha&authIndexType=service&authIndexValue=Dispatcher&ForceAuth=true&goto="+relayState);",
        "    return true;",
        "}",
        "",
        "/*",
        " * Available variables for preSignResponse:",
        " *     hostedEntityId",
        " *     realm",
        " *     idpAdapterScriptHelper",
        " *     request",
        " *     authnRequest",
        " *     session",
        " *     relayState",
        " *     res",
        " *     logger",
        " */",
        "function preSignResponse () {",
        "      logger.error("Chicago: preSignResponse");",
        "}",
        "",
        "/*",
        " * Available variables for preSendFailureResponse:",
        " *     hostedEntityId",
        " *     realm",
        " *     idpAdapterScriptHelper",
        " *     request",
        " *     response",
        " *     faultCode",
        " *     faultDetail",
        " *     logger",
        " */",
        "function preSendFailureResponse () {",
        "      logger.error("Chicago: preSendFailureResponse");",
        "}",
      ],
    },
    "87497360-d89c-412a-a99e-c8a9bec465cc": {
      "_id": "87497360-d89c-412a-a99e-c8a9bec465cc",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "ipstack",
      "script": [
        "logger.warning("ipstack: start");",
        "",
        "outcome = "unknown";",
        "",
        "var ip = getClientIPAddress();",
        "logger.warning("ipstack: ip=".concat(ip));",
        "",
        "if (ip) {",
        "",
        "      // ipstack API Configuration",
        "    var IPSTACK_ACCESS_KEY = "efc2f8d9796b9feff5f03359d6fbccc9";",
        "    var IPSTACK_API_URI = "http://api.ipstack.com/".concat(ip).concat("?access_key=").concat(IPSTACK_ACCESS_KEY);    ",
        "",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setMethod('GET');",
        "    request.setUri(IPSTACK_API_URI);",
        "",
        "    var response = httpClient.send(request).get();",
        "    var result = JSON.parse(response.getEntity().getString());",
        "    logger.warning("ipstack: JSON result: " + JSON.stringify(result));",
        "",
        "      /*",
        "    {",
        "        "ip": "99.72.28.182",",
        "        "type": "ipv4",",
        "        "continent_code": "NA",",
        "        "continent_name": "North America",",
        "        "country_code": "US",",
        "        "country_name": "United States",",
        "        "region_code": "TX",",
        "        "region_name": "Texas",",
        "        "city": "Georgetown",",
        "        "zip": "78626",",
        "        "latitude": 30.592500686645508,",
        "        "longitude": -97.66710662841797,",
        "        "location": {",
        "            "geoname_id": 4693342,",
        "            "capital": "Washington D.C.",",
        "            "languages": [",
        "                {",
        "                    "code": "en",",
        "                    "name": "English",",
        "                    "native": "English"",
        "                }",
        "            ],",
        "            "country_flag": "http://assets.ipstack.com/flags/us.svg",",
        "            "country_flag_emoji": "🇺🇸",",
        "            "country_flag_emoji_unicode": "U+1F1FA U+1F1F8",",
        "            "calling_code": "1",",
        "            "is_eu": false",
        "        }",
        "    }",
        "    */",
        "  ",
        "      // preserve result in transient state",
        "      transientState.put("ipstack", JSON.stringify(result));",
        "",
        "    switch(result.country_code) {",
        "      case "CA":",
        "        outcome = result.country_code;",
        "        break;",
        "      case "UK":",
        "        outcome = result.country_code;",
        "        break;",
        "      case "US":",
        "        outcome = result.country_code;",
        "        break;",
        "      default:",
        "        outcome = "other";",
        "    }",
        "",
        "} else {",
        "      logger.error("ipstack: no client ip!");",
        "}",
        "",
        "logger.warning("ipstack: finish");",
        "",
        " /*",
        "  * !!! ASSUMES ID CLOUD !!!",
        "  *",
        "  * Returns the client's IP address",
        "  */",
        " function getClientIPAddress() {",
        "    return requestHeaders.get("x-forwarded-for").get(0).split(',')[0];",
        " }",
      ],
    },
    "878816b3-2bb4-4b43-8001-10f926ddefff": {
      "_id": "878816b3-2bb4-4b43-8001-10f926ddefff",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Switch Actors And Become Impersonatee.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Impersonate: Switch Actors And Become Impersonatee",
      "script": [
        "/* Impersonate: Switch Actors And Become Impersonatee",
        " *",
        " * Switch Actors And Become Impersonatee.",
        " *",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * - false",
        " */",
        "",
        "(function () {",
        "    logger.warning("Impersonate: Switch Actors: start");",
        "    outcome = "false";",
        "",
        "    var impersonatee = sharedState.get("impersonatee");",
        "    var impersonator = sharedState.get("impersonator");",
        "    if (impersonatee && impersonator) {",
        "        outcome = "true";",
        "        sharedState.put("username", impersonatee);",
        "        setSharedObjectAttribute("userName", impersonatee);",
        "    }",
        "",
        "    logger.warning("Impersonate: Switch Actors: finish [outcome=".concat(outcome).concat("]"));",
        "  ",
        "    /*",
        "     * Store attributes in shared state for use with the Create/Patch Object nodes.",
        "     */",
        "    function setSharedObjectAttribute(name, value) {",
        "         var storage = sharedState.get("objectAttributes");",
        "        if (storage && value) {",
        "            if (storage.put) {",
        "                  storage.put(name, value);",
        "            }",
        "            else {",
        "                storage[name] = value;",
        "            }",
        "        }",
        "        else if (value) {",
        "            sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "        }",
        "    }",
        "}());",
      ],
    },
    "8862ca8f-7770-4af5-a888-ac0df0947f36": {
      "_id": "8862ca8f-7770-4af5-a888-ac0df0947f36",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from LinkedIn",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "LinkedIn Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "return json(object(",
        "        field("id", rawProfile.id),",
        "        field("givenName", rawProfile.firstName.localized.get(0)),",
        "        field("familyName", rawProfile.lastName.localized.get(0)),",
        "        field("photoUrl", rawProfile.profilePicture.displayImage),",
        "        field("email", rawProfile.elements.get(0).get("handle~").emailAddress),",
        "        field("username", rawProfile.elements.get(0).get("handle~").emailAddress)))",
      ],
    },
    "89eff37a-2e1e-47c2-8d62-5f7417fbb6b4": {
      "_id": "89eff37a-2e1e-47c2-8d62-5f7417fbb6b4",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Return TextOutputCallback indicating the provided OTP was invalid.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "OTP Invalid",
      "script": [
        "/* OTP Invalid",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Return TextOutputCallback indicating the provided OTP was invalid.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "outcome = "true";",
        "var fr = JavaImporter(",
        "    org.forgerock.openam.auth.node.api.Action,",
        "    javax.security.auth.callback.TextOutputCallback",
        ")",
        "if (callbacks.isEmpty()) {",
        "    action = fr.Action.send(",
        "        new fr.TextOutputCallback(",
        "            fr.TextOutputCallback.INFORMATION,",
        "            "INVALID"",
        "        )",
        "    ).build()",
        "}",
        "else {",
        "  action = fr.Action.goTo(outcome).build();",
        "}",
      ],
    },
    "8a768bb3-01cd-46b8-881c-b77f5a26c283": {
      "_id": "8a768bb3-01cd-46b8-881c-b77f5a26c283",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Write Onfido HTML Meta Tags",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Onfido-Meta-Tags",
      "script": [
        "/* Write HTML Meta Tags",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * This script writes meta tags to the header.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "(function () {",
        "  var fr = JavaImporter(",
        "      org.forgerock.openam.auth.node.api.Action,",
        "      com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        "  )",
        "",
        "  function createScript() {",
        "    return String("\\n\\",
        "    Array.prototype.slice.call(\\n\\",
        "      document.getElementsByTagName('head')\\n\\",
        "    ).forEach(\\n\\",
        "      function (e) {\\n\\",
        "        var meta = document.createElement('meta'); \\n\\",
        "        meta.name = \\"author\\"; \\n\\",
        "        meta.content = \\"John Doe\\"; \\n\\",
        "        document.getElementsByTagName('head')[0].appendChild(meta); \\n\\",
        "      }\\n\\",
        "    )");",
        "  }",
        "",
        "  if (callbacks.isEmpty()) {",
        "      action = fr.Action.send(",
        "          new fr.ScriptTextOutputCallback(createScript())",
        "      ).build()",
        "  } else {",
        "      action = fr.Action.goTo("true").build();",
        "  }",
        "}());",
      ],
    },
    "8bccfdd0-5556-4562-a1ca-6d725a449556": {
      "_id": "8bccfdd0-5556-4562-a1ca-6d725a449556",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "display country",
      "script": [
        "var fr = JavaImporter(",
        "  org.forgerock.openam.auth.node.api,",
        "  javax.security.auth.callback.TextOutputCallback",
        ");",
        "  ",
        "outcome = "true";",
        "",
        "var country = "unknown";",
        "if (transientState.get("ipstack")) {",
        "    country = JSON.parse(transientState.get("ipstack")).country_code;",
        "}",
        "  ",
        "with (fr) {",
        "  if (callbacks.isEmpty()) {",
        "    var callback = new TextOutputCallback(TextOutputCallback.INFORMATION, "Country: ".concat(country));",
        "    action = Action.send(callback).build();",
        "  } else {",
        "    action = Action.goTo("true").build();",
        "  }",
        "}",
      ],
    },
    "8e03eb43-ed5d-4c12-9e15-2051cc9be578": {
      "_id": "8e03eb43-ed5d-4c12-9e15-2051cc9be578",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Copy SAML Data To ObjectAttributes",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "CopySAMLDataToObjectAttributes",
      "script": [
        "/* CopySAMLDataToObjectAttributes",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Copy SAML Data To ObjectAttributes.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "outcome = "true";",
        "if (sharedState.get("userInfo")) {",
        "    if (sharedState.get("objectAttributes")) {",
        "          sharedState.remove("objectAttributes");",
        "    }",
        "    var userName=null,givenName=null,sn=null,mail=null,telephoneNumber=null,roles=null;",
        "",
        "    try { userName=sharedState.get("userInfo").get("userNames").get("uid").get(0).toString(); } catch (e) {}",
        "    try { givenName=sharedState.get("userInfo").get("attributes").get("givenName").get(0).toString(); } catch (e) {}",
        "    try { sn=sharedState.get("userInfo").get("attributes").get("sn").get(0).toString(); } catch (e) {}",
        "    try { mail=sharedState.get("userInfo").get("attributes").get("mail").get(0).toString(); } catch (e) {}",
        "    try { telephoneNumber=sharedState.get("userInfo").get("attributes").get("telephoneNumber").get(0).toString(); } catch (e) {}",
        "    //try { roles=sharedState.get("userInfo").get("attributes").get("roles").get(0).toString(); } catch (e) {}",
        "    try { roles=sharedState.get("userInfo").get("attributes").get("roles").toArray().join("|"); } catch (e) {}",
        "",
        "    sharedState.put("objectAttributes", {"userName":userName,"givenName":givenName,"sn":sn,"mail":mail,"telephoneNumber":telephoneNumber,"roles":roles});",
        "}",
      ],
    },
    "8e298710-b55e-4085-a464-88a375a4004b": {
      "_id": "8e298710-b55e-4085-a464-88a375a4004b",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from Twitter",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Twitter Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "return json(object(",
        "        field("id", rawProfile.id_str),",
        "        field("displayName", rawProfile.name),",
        "        field("photoUrl", rawProfile.profile_image_url),",
        "        field("email", rawProfile.email),",
        "        field("username", rawProfile.screen_name)))",
      ],
    },
    "90c4eca5-05f0-42f5-b9bf-88b693eabbbd": {
      "_id": "90c4eca5-05f0-42f5-b9bf-88b693eabbbd",
      "context": "SAML2_IDP_ATTRIBUTE_MAPPER",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Saml2 IDP Attribute Mapper Script",
      "script": [
        "/*",
        " * Copyright 2021 ForgeRock AS. All Rights Reserved",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        " * This script returns a list of SAML Attribute objects for the IDP framework to insert into the generated Assertion.",
        " *",
        " * Defined variables:",
        " * session - SSOToken (1)",
        " *           The single sign-on session.",
        " * hostedEntityId - String (primitive).",
        " *                  The hosted entity ID.",
        " * remoteEntityId - String (primitive).",
        " *                  The remote entity ID.",
        " * realm - String (primitive).",
        " *         The name of the realm the user is authenticating to.",
        " * logger - Always present, the debug logger instance:",
        " *          https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.",
        " *          Corresponding log files will be prefixed with: scripts.SAML2_IDP_ATTRIBUTE_MAPPER",
        " * idpAttributeMapperScriptHelper - IdpAttributeMapperScriptHelper (2)",
        " *                                - An IdpAttributeMapperScriptHelper instance containing methods used for IDP attribute mapping.",
        " *",
        " * Throws SAML2Exception:",
        " *      - on failing to map the IDP attributes.",
        " *",
        " * Return - a list of SAML Attribute (3) objects.",
        " *",
        " * Class reference:",
        " * (1) SSOToken - https://backstage.forgerock.com/docs/am/7/apidocs/com/iplanet/sso/SSOToken.html.",
        " * (2) IdpAttributeMapperScriptHelper - https://backstage.forgerock.com/docs/am/7/apidocs/com/sun/identity/saml2/plugins/scripted/IdpAttributeMapperScriptHelper.html.",
        " * (3) Attribute - https://backstage.forgerock.com/docs/am/7/apidocs/com/sun/identity/saml2/assertion/Attribute.html.",
        " */",
        "",
        "/**",
        " * Default SAML2 IDP Attribute Mapper.",
        " */",
        "function getAttributes() {",
        "    var frJava = JavaImporter(",
        "        com.sun.identity.saml2.common.SAML2Exception",
        "    );",
        "",
        "    const debugMethod = "ScriptedIDPAttributeMapper.getAttributes:: ";",
        "",
        "    try {",
        "",
        "        if (!idpAttributeMapperScriptHelper.isSessionValid(session)) {",
        "            logger.error(debugMethod + "Invalid session.");",
        "            return null;",
        "        }",
        "",
        "        var configMap = idpAttributeMapperScriptHelper.getRemoteSPConfigAttributeMap(realm, remoteEntityId);",
        "        logger.message(debugMethod + "Remote SP attribute map = {}", configMap);",
        "        if (configMap == null || configMap.isEmpty()) {",
        "            configMap = idpAttributeMapperScriptHelper.getHostedIDPConfigAttributeMap(realm, hostedEntityId);",
        "            if (configMap == null || configMap.isEmpty()) {",
        "                logger.message(debugMethod + "Configuration map is not defined.");",
        "                return null;",
        "            }",
        "            logger.message(debugMethod + "Hosted IDP attribute map = {}", configMap);",
        "        }",
        "",
        "        var attributes = new java.util.ArrayList();",
        "        var stringValueMap = new java.util.HashSet();",
        "        var binaryValueMap;",
        "        var localAttribute;",
        "",
        "        // Don't try to read the attributes from the datastore if the ignored profile is enabled in this realm.",
        "        if (!idpAttributeMapperScriptHelper.isIgnoredProfile(session, realm)) {",
        "            try {",
        "                // Resolve attributes to be read from the datastore.",
        "                var stringAttributes = new java.util.HashSet();",
        "                var binaryAttributes = new java.util.HashSet();",
        "                var keyIter = configMap.keySet().iterator();",
        "                while (keyIter.hasNext()) {",
        "                    var key = keyIter.next();",
        "                    localAttribute = configMap.get(key);",
        "                    if (!idpAttributeMapperScriptHelper.isStaticAttribute(localAttribute)) {",
        "                        if (idpAttributeMapperScriptHelper.isBinaryAttribute(localAttribute)) {",
        "                            // add it to the list of attributes to treat as being binary",
        "                            binaryAttributes.add(idpAttributeMapperScriptHelper.removeBinaryAttributeFlag(localAttribute));",
        "                        } else {",
        "                            stringAttributes.add(localAttribute);",
        "                        }",
        "                    }",
        "                }",
        "",
        "                if (!stringAttributes.isEmpty()) {",
        "                    stringValueMap = idpAttributeMapperScriptHelper.getAttributes(session, stringAttributes);",
        "                }",
        "                if (!binaryAttributes.isEmpty()) {",
        "                    binaryValueMap = idpAttributeMapperScriptHelper.getBinaryAttributes(session, binaryAttributes);",
        "                }",
        "            } catch (error) {",
        "                logger.error(debugMethod + "Error accessing the datastore. " + error);",
        "                //continue to check in ssotoken.",
        "            }",
        "        }",
        "",
        "        var keyIter = configMap.keySet().iterator();",
        "        while (keyIter.hasNext()) {",
        "            var key = keyIter.next()",
        "            var nameFormat = null;",
        "            var samlAttribute = key;",
        "            localAttribute = configMap.get(key);",
        "            // check if samlAttribute has format nameFormat|samlAttribute",
        "            var samlAttributes = String(new java.lang.String(samlAttribute));",
        "            var tokens = samlAttributes.split('|');",
        "",
        "            if (tokens.length > 1) {",
        "                nameFormat = tokens[0];",
        "                samlAttribute = tokens[1];",
        "            }",
        "",
        "            var attributeValues = new java.util.HashSet();",
        "            if (idpAttributeMapperScriptHelper.isStaticAttribute(localAttribute)) {",
        "                // Remove the static flag before using it as the static value",
        "                localAttribute = idpAttributeMapperScriptHelper.removeStaticAttributeFlag(localAttribute);",
        "                attributeValues = new java.util.HashSet([localAttribute]);",
        "                logger.message(debugMethod + "Adding static value {} for attribute named {}", localAttribute, samlAttribute);",
        "            } else {",
        "                if (idpAttributeMapperScriptHelper.isBinaryAttribute(localAttribute)) {",
        "                    // Remove the flag as not used for lookup",
        "                    localAttribute = idpAttributeMapperScriptHelper.removeBinaryAttributeFlag(localAttribute);",
        "                    attributeValues = idpAttributeMapperScriptHelper.getBinaryAttributeValues(samlAttribute, localAttribute,",
        "                        binaryValueMap);",
        "                } else {",
        "                    if (stringValueMap != null && !stringValueMap.isEmpty()) {",
        "                        attributeValues = stringValueMap.get(localAttribute);",
        "                    } else {",
        "                        logger.message(debugMethod + "{} string value map was empty or null.", localAttribute);",
        "                    }",
        "                }",
        "",
        "                // If all else fails, try to get the value from the users ssoToken",
        "                if (attributeValues == null || attributeValues.isEmpty()) {",
        "                    logger.message(debugMethod + "User profile does not have value for {}, checking SSOToken.", localAttribute);",
        "                    attributeValues = new java.util.HashSet(idpAttributeMapperScriptHelper.getPropertySet(session, localAttribute));",
        "                }",
        "            }",
        "",
        "            if (attributeValues == null || attributeValues.isEmpty()) {",
        "                logger.message(debugMethod + "{} not found in user profile or SSOToken.", localAttribute);",
        "            } else {",
        "                attributes.add(idpAttributeMapperScriptHelper.createSAMLAttribute(samlAttribute, nameFormat, attributeValues));",
        "            }",
        "        }",
        "",
        "        return attributes;",
        "",
        "    } catch (error) {",
        "        logger.error(debugMethod + "Error mapping IDP attributes. " + error);",
        "        throw new frJava.SAML2Exception(error);",
        "    }",
        "}",
        "",
        "getAttributes();",
      ],
    },
    "91554b10-79a5-4aa8-aca1-59481a734c19": {
      "_id": "91554b10-79a5-4aa8-aca1-59481a734c19",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Twilio SMS OTP Sender",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Twilio SMS OTP Sender",
      "script": [
        "/* Twilio SMS OTP Sender",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * This script will send an SMS containing the OTP to the phone number in the user's profile.",
        " * ",
        " * This script needs to be parametrized. It will not work properly as is. ",
        " * It requires the Identify Existing User node and HOTP Generator node before it is being called.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - sent",
        " * - failed",
        " */",
        "logger.warning("Twilio SMS OTP Sender: start");",
        "",
        "if (sharedState.get("_id") && idRepository.getAttribute(sharedState.get("_id"), "telephoneNumber").iterator().hasNext()) {",
        "    var Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(input){var output="";var chr1,chr2,chr3,enc1,enc2,enc3,enc4;var i=0;input=Base64._utf8_encode(input);while(i<input.length){chr1=input.charCodeAt(i++);chr2=input.charCodeAt(i++);chr3=input.charCodeAt(i++);enc1=chr1>>2;enc2=(chr1&3)<<4|chr2>>4;enc3=(chr2&15)<<2|chr3>>6;enc4=chr3&63;if(isNaN(chr2)){enc3=enc4=64}else if(isNaN(chr3)){enc4=64}output=output+this._keyStr.charAt(enc1)+this._keyStr.charAt(enc2)+this._keyStr.charAt(enc3)+this._keyStr.charAt(enc4)}return output},decode:function(input){var output="";var chr1,chr2,chr3;var enc1,enc2,enc3,enc4;var i=0;input=input.replace(/[^A-Za-z0-9\\+\\/\\=]/g,"");while(i<input.length){enc1=this._keyStr.indexOf(input.charAt(i++));enc2=this._keyStr.indexOf(input.charAt(i++));enc3=this._keyStr.indexOf(input.charAt(i++));enc4=this._keyStr.indexOf(input.charAt(i++));chr1=enc1<<2|enc2>>4;chr2=(enc2&15)<<4|enc3>>2;chr3=(enc3&3)<<6|enc4;output=output+String.fromCharCode(chr1);if(enc3!=64){output=output+String.fromCharCode(chr2)}if(enc4!=64){output=output+String.fromCharCode(chr3)}}output=Base64._utf8_decode(output);return output},_utf8_encode:function(string){string=string.replace(/\\r\\n/g,"\\n");var utftext="";for(var n=0;n<string.length;n++){var c=string.charCodeAt(n);if(c<128){utftext+=String.fromCharCode(c)}else if(c>127&&c<2048){utftext+=String.fromCharCode(c>>6|192);utftext+=String.fromCharCode(c&63|128)}else{utftext+=String.fromCharCode(c>>12|224);utftext+=String.fromCharCode(c>>6&63|128);utftext+=String.fromCharCode(c&63|128)}}return utftext},_utf8_decode:function(utftext){var string="";var i=0;var c=c1=c2=0;while(i<utftext.length){c=utftext.charCodeAt(i);if(c<128){string+=String.fromCharCode(c);i++}else if(c>191&&c<224){c2=utftext.charCodeAt(i+1);string+=String.fromCharCode((c&31)<<6|c2&63);i+=2}else{c2=utftext.charCodeAt(i+1);c3=utftext.charCodeAt(i+2);string+=String.fromCharCode((c&15)<<12|(c2&63)<<6|c3&63);i+=3}}return string}};",
        "",
        "       /* BEGIN SCRIPT CONFIGURATION",
        "     *",
        "     * REPLACE WITH YOUR OWN AZURE AD SETTINGS",
        "     */",
        "    var TWILIO_API_SID = "AC750415e3163a2e57b7aeea7eed82d944";",
        "    var TWILIO_API_TOKEN = "d36a719c94b4be08592d69ec4f80a5bb";",
        "    var TWILIO_API_FROM = "+13176443107";",
        "    /*",
        "     * END SCRIPT CONFIGURATION",
        "     */",
        "  ",
        "    // Twilio SMS Message API Configuration",
        "    var TWILIO_API_URI = "https://api.twilio.com/2010-04-01/Accounts/".concat(TWILIO_API_SID).concat("/Messages.json");    ",
        "    var TWILIO_API_TO = idRepository.getAttribute(sharedState.get("_id"), "telephoneNumber").iterator().next();",
        "    var TWILIO_API_BODY = "OTP for account ".concat(sharedState.get("username")).concat(": ").concat(sharedState.get("oneTimePassword"));",
        "    //logger.warning("Twilio SMS OTP Sender: To: ".concat(TWILIO_API_TO));",
        "    //logger.warning("Twilio SMS OTP Sender: Message: ".concat(TWILIO_API_BODY));",
        "",
        "    var AUTHZ = "Basic ".concat(Base64.encode(TWILIO_API_SID.concat(':').concat(TWILIO_API_TOKEN)));",
        "    //logger.warning("Twilio SMS OTP Sender: AUTHZ - ".concat(AUTHZ));",
        "",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setMethod('POST');",
        "    request.setUri(TWILIO_API_URI);",
        "    request.getHeaders().add("Content-Type", "application/x-www-form-urlencoded");",
        "    request.getHeaders().add("Authorization", AUTHZ);",
        "    var params = request.getForm();",
        "    params.add("From", TWILIO_API_FROM);",
        "    params.add("Body", TWILIO_API_BODY);",
        "    params.add("To", TWILIO_API_TO);",
        "    request.getEntity().setString(params.toString());",
        "",
        "    var response = httpClient.send(request).get();",
        "    var result = JSON.parse(response.getEntity().getString());",
        "    //logger.warning("Twilio SMS OTP Sender: JSON result: " + JSON.stringify(result));",
        "",
        "    if (result["error_code"]) {",
        "        outcome = "failed";",
        "        logger.error("Twilio SMS OTP Sender: error_code = ".concat(result["error_code"]));",
        "        logger.error("Twilio SMS OTP Sender: error_message = ".concat(result["error_message"]));",
        "        logger.error("Twilio SMS OTP Sender: outcome = failed");",
        "    } else if (result["code"]) {",
        "        outcome = "failed";",
        "        logger.error("Twilio SMS OTP Sender: code = ".concat(result["code"]));",
        "        logger.error("Twilio SMS OTP Sender: message = ".concat(result["message"]));",
        "    } else {",
        "        outcome = "sent";",
        "        logger.warning("Twilio SMS OTP Sender: outcome = sent");",
        "    }",
        "} else {",
        "      outcome = "failed";",
        "      logger.error("Twilio SMS OTP Sender: No user or phone number found! Use 'Identify Existing User node before this script to populate the user's _id in shared state!'");",
        "      logger.error("Twilio SMS OTP Sender: outcome = failed");",
        "}",
      ],
    },
    "91d197de-5916-4dca-83b5-9a4df26e7159": {
      "_id": "91d197de-5916-4dca-83b5-9a4df26e7159",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from WordPress",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "WordPress Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "return json(object(",
        "        field("id", rawProfile.username),",
        "        field("displayName", rawProfile.display_name),",
        "        field("photoUrl", rawProfile.avatar_URL),",
        "        field("email", rawProfile.email),",
        "        field("username", rawProfile.username)))",
      ],
    },
    "92edf2c7-0bab-412c-a0da-82ad4f04505b": {
      "_id": "92edf2c7-0bab-412c-a0da-82ad4f04505b",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Collect Extra Fields",
      "script": [
        "/* Collect Extra Fields",
        " * ",
        " * Collect extra fields not part of the user profile.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    outcome = 'true';",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "          javax.security.auth.callback.NameCallback",
        "    )",
        "    if (callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "            new fr.NameCallback('modality'),",
        "            new fr.NameCallback('jwtToken')",
        "        ).build();",
        "    }",
        "    else {",
        "          var modality = callbacks.get(0).getName();",
        "          var jwtToken = callbacks.get(1).getName();",
        "          nodeState.putShared('modality', modality);",
        "          nodeState.putShared('jwtToken', jwtToken);",
        "        action = fr.Action.goTo(outcome).build();",
        "    }",
        "}());",
      ],
    },
    "9399ac8b-3a6e-423b-95a2-6e0fd07262b1": {
      "_id": "9399ac8b-3a6e-423b-95a2-6e0fd07262b1",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "APIProtection: Get Key And Secret",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "APIProtection: Get Key And Secret",
      "script": [
        "logger.warning("APIProtection: Get Key And Secret: start");",
        "",
        "/*",
        " * BEGIN SCRIPT CONFIGURATION",
        " */",
        "var KEY_HEADER_NAME = "x-api-key";",
        "var SECRET_HEADER_NAME = "x-api-secret";",
        "var USERNAME_HEADER_NAME = "X-OpenAM-Username";",
        "var PASSWORD_HEADER_NAME = "X-OpenAM-Password";",
        "/*",
        " * END SCRIPT CONFIGURATION",
        " */",
        "",
        "outcome = "false";",
        "",
        "var key = getHeader(KEY_HEADER_NAME) || readValue(KEY_HEADER_NAME) || null;",
        "var secret = getHeader(SECRET_HEADER_NAME) || readTransientValue(SECRET_HEADER_NAME) || null;",
        "",
        "var username = sharedState.get("username") || null;",
        "var password = transientState.get("password") || null;",
        "",
        "if (key && secret) {",
        "    logger.warning("APIProtection: Get Key And Secret: key=".concat(key));",
        "  ",
        "      storeValue(KEY_HEADER_NAME, key);",
        "      storeValue("username", username);",
        "      sharedState.put("username", key);",
        "      ",
        "      storeTransientValue(SECRET_HEADER_NAME, secret);",
        "      storeTransientValue("password", password);",
        "      transientState.put("password", secret);",
        "  ",
        "    outcome = "true";",
        "}",
        "",
        "logger.warning("APIProtection: Get Key And Secret: finish [outcome=".concat(outcome).concat("]"));",
        "",
        "/*",
        " * Returns the value of the requested header",
        " */",
        "function getHeader(headerName) {",
        "      if (requestHeaders.get(headerName) && requestHeaders.get(headerName).get(0)) {",
        "        return requestHeaders.get(headerName).get(0).toString();",
        "    }",
        "      return null;",
        "}",
        "",
        "/*",
        " * Store value for APIProtection script use",
        " */",
        "function storeValue(name, value) {",
        "      var storage = sharedState.get("APIProtection");",
        "    if (storage && value) {",
        "          if (storage.put) {",
        "            storage.put(name, value);",
        "        }",
        "          else {",
        "              storage[name] = value;",
        "        }",
        "    }",
        "    else if (value) {",
        "        sharedState.put("APIProtection", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "    }",
        "}",
        "",
        "/*",
        " * Read value from storage for APIProtection script use",
        " */",
        "function readValue(name) {",
        "      var storage = sharedState.get("APIProtection");",
        "    if (storage) {",
        "          if (storage.get) {",
        "            return sharedState.get("APIProtection").get(name);",
        "        }",
        "          else {",
        "              return storage.name;",
        "        }",
        "    }",
        "      return null;",
        "}",
        "",
        "/*",
        " * Store transient value for APIProtection script use",
        " */",
        "function storeTransientValue(name, value) {",
        "    var transientStorage = transientState.get("APIProtection");",
        "    if (transientStorage && value) {",
        "          if (transientStorage.put) {",
        "            transientStorage.put(name, value);",
        "        }",
        "          else {",
        "              transientStorage[name] = value;",
        "        }",
        "    }",
        "    else if (value) {",
        "        transientState.put("APIProtection", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "    }",
        "}",
        "",
        "/*",
        " * Read transient value from storage for APIProtection script use",
        " */",
        "function readTransientValue(name) {",
        "      var transientStorage = transientState.get("APIProtection");",
        "    if (transientStorage) {",
        "          if (transientStorage.get) {",
        "            return transientState.get("APIProtection").get(name);",
        "        }",
        "          else {",
        "              return transientStorage.name;",
        "        }",
        "    }",
        "      return null;",
        "}",
      ],
    },
    "9535446c-0ff6-4a76-8576-616599119d64": {
      "_id": "9535446c-0ff6-4a76-8576-616599119d64",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Remove button from page.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Remove Button",
      "script": [
        "/* Remove Button",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Hide buttons on the journey page.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "(function () {",
        "    var script = "Array.prototype.slice.call(document.getElementsByTagName('button')).forEach(function (e) {e.style.display = 'none'})"",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "        javax.security.auth.callback.TextOutputCallback,",
        "        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        "    )",
        "    var message = " "",
        "    if (callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "            new fr.TextOutputCallback(",
        "                fr.TextOutputCallback.INFORMATION,",
        "                message",
        "            ),",
        "            new fr.ScriptTextOutputCallback(script)",
        "        ).build()",
        "    }",
        "}());",
      ],
    },
    "988c10fa-98da-4bf7-8ac9-a558d2fef1fd": {
      "_id": "988c10fa-98da-4bf7-8ac9-a558d2fef1fd",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Protection from malicious IDPs. Only allow white-listed email domains (usernames are email addresses).",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "IDP Integrity Check",
      "script": [
        "/* IDP Integrity Check",
        " * ",
        " * Protection from malicious IDPs. Only allow white-listed email domains (usernames are email addresses).",
        " * ",
        " * This script does not require cofiguration. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * - false",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    outcome = "false";",
        "      var routedIDP = sharedState.get("routedIDPs").get(0);",
        "      var validDomains = [];",
        "      if (routedIDP) {",
        "          validDomains = routedIDP.get("idpDomains");",
        "    }",
        "      ",
        "      var username = sharedState.get("username");",
        "      var domain = username.substr(username.lastIndexOf("@")+1);",
        "      if (validDomains.indexOf(domain) > -1) {",
        "          outcome = "true";",
        "    }",
        "}());",
      ],
    },
    "9de3eb62-f131-4fac-a294-7bd170fd4acb": {
      "_id": "9de3eb62-f131-4fac-a294-7bd170fd4acb",
      "context": "POLICY_CONDITION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Default global script for Scripted Policy Conditions",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Scripted Policy Condition",
      "script": [
        "/*",
        " * Copyright 2015-2017 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "/**",
        " * This is a Policy Condition example script. It demonstrates how to access a user's information,",
        " * use that information in external HTTP calls and make a policy decision based on the outcome.",
        " */",
        "",
        "var userAddress, userIP, resourceHost;",
        "",
        "if (validateAndInitializeParameters()) {",
        "",
        "    var countryFromUserAddress = getCountryFromUserAddress();",
        "    logger.message("Country retrieved from user's address: " + countryFromUserAddress);",
        "    var countryFromUserIP = getCountryFromUserIP();",
        "    logger.message("Country retrieved from user's IP: " + countryFromUserIP);",
        "    var countryFromResourceURI = getCountryFromResourceURI();",
        "    logger.message("Country retrieved from resource URI: " + countryFromResourceURI);",
        "",
        "    if (countryFromUserAddress === countryFromUserIP && countryFromUserAddress === countryFromResourceURI) {",
        "        logger.message("Authorization Succeeded");",
        "        responseAttributes.put("countryOfOrigin", [countryFromUserAddress]);",
        "        authorized = true;",
        "    } else {",
        "        logger.message("Authorization Failed");",
        "        authorized = false;",
        "    }",
        "",
        "} else {",
        "    logger.message("Required parameters not found. Authorization Failed.");",
        "    authorized = false;",
        "}",
        "",
        "/**",
        " * Use the user's address to lookup their country of residence.",
        " *",
        " * @returns {*} The user's country of residence.",
        " */",
        "function getCountryFromUserAddress() {",
        "",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setUri("http://maps.googleapis.com/maps/api/geocode/json?address=" + encodeURIComponent(userAddress));",
        "      request.setMethod("GET");",
        "",
        "    var response = httpClient.send(request).get();",
        "    logResponse(response);",
        "",
        "    var geocode = JSON.parse(response.getEntity().getString());",
        "    var i;",
        "    for (i = 0; i < geocode.results.length; i++) {",
        "        var result = geocode.results[i];",
        "        var j;",
        "        for (j = 0; j < result.address_components.length; i++) {",
        "            if (result.address_components[i].types[0] == "country") {",
        "                return result.address_components[i].long_name;",
        "            }",
        "        }",
        "    }",
        "}",
        "",
        "/**",
        " * Use the user's IP to lookup the country from which the request originated.",
        " *",
        " * @returns {*} The country from which the request originated.",
        " */",
        "function getCountryFromUserIP() {",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setUri("http://ip-api.com/json/" + userIP);",
        "      request.setMethod("GET");",
        "",
        "    var response = httpClient.send(request).get();",
        "    logResponse(response);",
        "",
        "    var result = JSON.parse(response.getEntity().getString());",
        "    if (result) {",
        "        return result.country;",
        "    }",
        "}",
        "",
        "/**",
        " * Use the requested resource's host name to lookup the country where the resource is hosted.",
        " *",
        " * @returns {*} The country in which the resource is hosted.",
        " */",
        "function getCountryFromResourceURI() {",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setUri("http://ip-api.com/json/" + encodeURIComponent(resourceHost));",
        "      request.setMethod("GET");",
        "",
        "    var response = httpClient.send(request).get();",
        "    logResponse(response);",
        "",
        "    var result = JSON.parse(response.getEntity().getString());",
        "    if (result) {",
        "        return result.country;",
        "    }",
        "}",
        "",
        "/**",
        " * Retrieve and validate the variables required to make the external HTTP calls.",
        " *",
        " * @returns {boolean} Will be true if validation was successful.",
        " */",
        "function validateAndInitializeParameters() {",
        "    var userAddressSet = identity.getAttribute("postalAddress");",
        "    if (userAddressSet == null || userAddressSet.isEmpty()) {",
        "        logger.warning("No address specified for user: " + username);",
        "        return false;",
        "    }",
        "    userAddress = userAddressSet.iterator().next();",
        "    logger.message("User address: " + userAddress);",
        "",
        "    if (!environment) {",
        "        logger.warning("No environment parameters specified in the evaluation request.");",
        "        return false;",
        "    }",
        "",
        "    var ipSet = environment.get("IP");",
        "    if (ipSet == null || ipSet.isEmpty()) {",
        "        logger.warning("No IP specified in the evaluation request environment parameters.");",
        "        return false;",
        "    }",
        "    userIP = ipSet.iterator().next();",
        "    logger.message("User IP: " + userIP);",
        "",
        "    if (!resourceURI) {",
        "        logger.warning("No resource URI specified.");",
        "        return false;",
        "    }",
        "    resourceHost = resourceURI.match(/^(.*:\\/\\/)(www\\.)?([A-Za-z0-9\\-\\.]+)(:[0-9]+)?(.*)$/)[3];",
        "    logger.message("Resource host: " + resourceHost);",
        "",
        "    return true;",
        "}",
        "",
        "function logResponse(response) {",
        "    logger.message("User REST Call. Status: " + response.getStatus() + ", Body: " + response.getEntity().getString());",
        "}",
      ],
    },
    "9e9c6c4d-5d9d-4990-9f05-d8b2b25ad52b": {
      "_id": "9e9c6c4d-5d9d-4990-9f05-d8b2b25ad52b",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Custom risk policy engine combining Autonomous Access signals with external signals.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "AA Custom Policy Engine",
      "script": [
        "/* AA Custom Policy Engine",
        " *",
        " * Author: marcin.zimny@forgerock.com",
        " * Adaptations: volker.scheuber@forgerock.com",
        " * ",
        " * Custom policy engine combining the Autonomous Access risk engine output with external systems and custom policy output:",
        " * ",
        " * - use multiple risk scoring policies (currently it's part of risk config file and used across all evaluations)",
        " * - deliver custom logic of delivering outcome (we can sum the signals instead of returning the highest)",
        " * - use custom signals as part of the (single) risk node (for example anonymisation detection)",
        " * - exceptions/overrides (i.e. if we have to allow a flow with high risk for whatever reason) ",
        " * ",
        " * This script needs to be parametrized. It will NOT work properly as is!",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - low",
        " * - medium",
        " * - high",
        " * - failed",
        " */",
        "(function () {",
        "  /* ",
        "   * MUST CONFIGURE THIS SECTION",
        "   * Custom signals parameters",
        "   */",
        "  ",
        "  // IPQualityScore API",
        "  var USER_AGENT = "ForgeRock"",
        "  var API_KEY = systemEnv.getProperty("esv.ipqs.api.key");",
        "  ",
        "  /*",
        "   * END MANDATORY CONFIGURATION",
        "   */",
        "  ",
        "  outcome = "failed"; //default outcome",
        "  /*",
        "    Risk Policy - Signal Scores",
        "  */",
        "  var aa_impossible_travel_score = 21;",
        "  var aa_credential_stuffing_score = 100;",
        "  var aa_automated_user_agent_score = 25;",
        "  var aa_brute_force_score = 100;",
        "  var aa_suspicious_ip_score = 35;",
        "  /*",
        "    Risk Policy - Custom Signals",
        "  */",
        "  var aa_use_anonymizer_detection = 1;",
        "  var custom_aa_tor_detected_score = 50;",
        "  var custom_aa_vpn_detected_score = 20;",
        "  var custom_aa_proxy_detected_score = 20;",
        "  /*",
        "    Risk Policy - Thresholds And Extra Features",
        "  */",
        "  var aa_medium_risk_threshold = 30;",
        "  var aa_high_risk_threshold = 75;",
        "  var aa_max_signal_count_high_risk_override = 99;",
        "  /*",
        "    Risk Policy - Method",
        "      0 - highest score out of all triggered signals",
        "      1 - summary of all triggered signals",
        "  */",
        "  var aa_risk_method=1;",
        "  /*",
        "    Risk Policy - UEBA method",
        "      0 - highest score out of 3 models",
        "      1 - average score out of 3 models",
        "  */",
        "  var aa_ueba_method=0;",
        "  /*",
        "    Risk Policy - Overrides",
        "",
        "    Whitelist - false positive control",
        "    Blacklist - preventative block",
        "    Example - ip_whitelist or ip_blacklist = ["62.21.63.30-62.21.63.30","82.21.168.1-82.21.168.255"];",
        "  */",
        "  var ip_whitelist = [];",
        "  var ip_blacklist = [];",
        "  ",
        "  /********************************************************",
        "    The engine *",
        "  */",
        "  //Define variables",
        "  var signal_count = 0;",
        "  var pos = 0;",
        "  var arr_scores = [];",
        "  var arr_scores_models = [];",
        "  var score = 0;",
        "  var predictionResultChopped;",
        "  var predictionResultChoppedVal;",
        "  //Define signal variables and assign defaults (negative)",
        "  var is_impossible_travel = 0;",
        "  var is_credential_stuffing = 0;",
        "  var is_automated_user_agent = 0;",
        "  var is_brute_force = 0;",
        "  var is_suspicious_ip = 0;",
        "  var model1_score = 0;",
        "  var model2_score = 0;",
        "  var model3_score = 0;",
        "  var isAnonymizedResult;",
        "  //Get risk data",
        "  var predictionResultRaw = sharedState.get("predictionResult");",
        "  var predictionResultString = predictionResultRaw.toString();",
        "",
        "  var result;",
        "",
        "  function inet_aton (ip)",
        "  {",
        "      return ip.split(".").reduce((int, v) => int * 256 + +v);",
        "  }",
        "",
        "",
        "  function isAnonymized()",
        "  {",
        "    var payload = sharedState.get("IPQualityScore")",
        "",
        "    if (payload)",
        "    {",
        "      var jsonResult = JSON.parse(payload);",
        "    }",
        "    else",
        "    {",
        "      var ipaddress = requestHeaders.get("X-FORWARDED-FOR").get(0).split(",")[0].trim();",
        "",
        "      var request = new org.forgerock.http.protocol.Request();",
        "      request.setMethod("GET");",
        "      request.setUri("https://ipqualityscore.com/api/json/ip/" + API_KEY + "/" + ipaddress + "?strictness=0&allow_public_access_points=false&fast=false&lighter_penalties=false&mobile=false");",
        "      request.getHeaders().add("Accept","application/json");",
        "      request.getHeaders().add("User-Agent", USER_AGENT);",
        "",
        "      var response = httpClient.send(request).get();",
        "      if (response.getStatus().getCode() === 200) {",
        "        var payload = response.getEntity().getString();",
        "        var jsonResult = JSON.parse(payload)",
        "          if (jsonResult.success === true) {",
        "          sharedState.put("Debug-IPQualityScore", payload);",
        "        }",
        "      }",
        "    }",
        "",
        "    if (jsonResult) {",
        "      if (jsonResult.tor === true) {",
        "        isAnonymizedResult = "tor";",
        "      } else if (jsonResult.vpn === true) {",
        "        isAnonymizedResult= "vpn";",
        "      } else if (jsonResult.proxy === true) {",
        "        isAnonymizedResult = "proxy";",
        "      } else {",
        "        isAnonymizedResult = "not_detected";",
        "      }",
        "    }",
        "  }",
        "",
        "",
        "  if(aa_use_anonymizer_detection==1)",
        "  {",
        "    isAnonymized();",
        "    sharedState.put("custom_aa_isAnonymized",isAnonymizedResult);",
        "    if(isAnonymizedResult=="vpn")",
        "    {",
        "      arr_scores.push(custom_aa_vpn_detected_score);",
        "    }",
        "    else if(isAnonymizedResult=="proxy")",
        "    {",
        "      arr_scores.push(custom_aa_proxy_detected_score);",
        "    }",
        "    else if(isAnonymizedResult=="tor")",
        "    {",
        "      arr_scores.push(custom_aa_tor_detected_score);",
        "    }",
        "    else",
        "    {",
        "      arr_scores.push(0);",
        "    }",
        "  }",
        "",
        "  if(predictionResultString.search("risk_score_data")>=0)",
        "  {",
        "    outcome = "low"; //default if there's data from risk API",
        "  }",
        "",
        "  //Check if we're assessing impossible travel and assign result",
        "  pos = predictionResultString.search("impossibleTravellerCheck=true");",
        "  if(pos>0)",
        "  {",
        "    pos = predictionResultString.search("is_impossible_travel=false");",
        "    if(pos<0)",
        "    {",
        "      signal_count++;",
        "      is_impossible_travel=1;",
        "      arr_scores.push(aa_impossible_travel_score);",
        "    }",
        "  }",
        "  //Check if we're assessing credential stuffing and assign result",
        "  pos = predictionResultString.search("credentialStuffing=true");",
        "  if(pos>0)",
        "  {",
        "    pos = predictionResultString.search("is_credential_stuffing=false");",
        "    if(pos<0)",
        "    {",
        "      signal_count++;",
        "      is_credential_stuffing=1;",
        "      arr_scores.push(aa_credential_stuffing_score);",
        "    }",
        "  }",
        "  //Check if we're assessing automated user angent (antibot) and assign result",
        "  pos = predictionResultString.search("automatedUserAgentsFilter=true");",
        "  if(pos>0)",
        "  {",
        "    pos = predictionResultString.search("is_automated_user_agent=false");",
        "    if(pos<0)",
        "    {",
        "      signal_count++;",
        "      is_automated_user_agent=1;",
        "      arr_scores.push(aa_automated_user_agent_score);",
        "    }",
        "  }",
        "  //Check if we're assessing brute-force and assign result",
        "  pos = predictionResultString.search("bruteForcePreventionCheck=true");",
        "  if(pos>0)",
        "  {",
        "    pos = predictionResultString.search("is_brute_force=false");",
        "    if(pos<0)",
        "    {",
        "      signal_count++;",
        "      is_brute_force=1;",
        "      arr_scores.push(aa_brute_force_score);",
        "    }",
        "  }",
        "  //Check if we're assessing suspicious IP and assign result",
        "  pos = predictionResultString.search("suspiciousIPCheck=true");",
        "  if(pos>0)",
        "  {",
        "    pos = predictionResultString.search("is_suspicious_ip=false");",
        "    if(pos<0)",
        "    {",
        "      signal_count++;",
        "      is_suspicious_ip=1;",
        "      arr_scores.push(aa_suspicious_ip_score);",
        "    }",
        "  }",
        "  //Check if we're assessing UEBA and assign result",
        "  pos = predictionResultString.search("anomalyDetection=true");",
        "  if(pos>0)",
        "  {",
        "    pos = predictionResultString.search("clustering_result=");",
        "    if(pos>0)",
        "    {",
        "        predictionResultChopped=predictionResultString.substring(pos);",
        "        predictionResultChopped=predictionResultChopped.substring(predictionResultChopped.search("risk_score="));",
        "        predictionResultChoppedVal=predictionResultChopped.substring(11,predictionResultChopped.search(","));",
        "        predictionResultChopped=predictionResultChopped.substring(11);",
        "        model1score=parseInt(predictionResultChoppedVal,10);",
        "",
        "        predictionResultChopped=predictionResultChopped.substring(predictionResultChopped.search("risk_score="));",
        "        predictionResultChoppedVal=predictionResultChopped.substring(11,predictionResultChopped.search(","));",
        "        predictionResultChopped=predictionResultChopped.substring(11);",
        "        model2score=parseInt(predictionResultChoppedVal,10);",
        "",
        "        predictionResultChopped=predictionResultChopped.substring(predictionResultChopped.search("risk_score="));",
        "        predictionResultChoppedVal=predictionResultChopped.substring(11,predictionResultChopped.search(","));",
        "        predictionResultChopped=predictionResultChopped.substring(11);",
        "        model3score=parseInt(predictionResultChoppedVal,10);",
        "",
        "        arr_scores_models.push(model1score,model2score,model3score);",
        "    }",
        "  }",
        "",
        "  //Deliver risk score",
        "  if(aa_ueba_method==0)",
        "  {",
        "    score = Math.max.apply(null, arr_scores_models);",
        "  }",
        "  else if(aa_ueba_method==1)",
        "  {",
        "    score = arr_scores_models.reduce((a, b) => a + b, 0)/arr_scores_models.length;",
        "  }",
        "  arr_scores.push(score);",
        "",
        "",
        "  if(aa_risk_method==0)",
        "  {",
        "    score = Math.max.apply(null, arr_scores);",
        "  }",
        "  else if (aa_risk_method===1)",
        "  {",
        "    score = arr_scores.reduce((a, b) => a + b, 0);",
        "  }",
        "  //Deliver risk outcome",
        "  if(score>aa_medium_risk_threshold)",
        "  {",
        "    outcome="medium";",
        "  }",
        "  if(score>aa_high_risk_threshold)",
        "  {",
        "    outcome="high";",
        "  }",
        "  if(signal_count>=aa_max_signal_count_high_risk_override && outcome=="medium")",
        "  {",
        "    outcome="high";",
        "    sharedState.put("debug-signal-count-override","true");",
        "  }",
        "",
        "  //process the blacklist and whitelist",
        "  var src_ipaddress;",
        "  var src_ipaddress_dec;",
        "  var list_first_ipaddress_dec;",
        "  var list_last_ipaddress_dec;",
        "  var list_entry;",
        "  var logmessage;",
        "  src_ipaddress = requestHeaders.get("X-FORWARDED-FOR").get(0).split(",")[0].trim();",
        "  src_ipaddress_dec = inet_aton(src_ipaddress);",
        "",
        "  if(ip_blacklist.length>0)",
        "  {",
        "    for (var i = 0; i < ip_blacklist.length; i++)",
        "    {",
        "      list_entry = ip_blacklist[i].split("-");",
        "      list_first_ipaddress_dec=inet_aton(list_entry[0]);",
        "      list_last_ipaddress_dec=inet_aton(list_entry[1]);",
        "",
        "      if(src_ipaddress_dec>=list_first_ipaddress_dec && src_ipaddress_dec<=list_last_ipaddress_dec)",
        "      {",
        "          sharedState.put("debug-blacklist","condition met for: " + src_ipaddress + ", " + outcome + "->high");",
        "           outcome="high";",
        "      }",
        "    }",
        "  }",
        "  if(ip_whitelist.length>0)",
        "  {",
        "    for (var i = 0; i < ip_whitelist.length; i++)",
        "    {",
        "      //list_entry = ip_whitelist[i].split("-");",
        "      list_entry = ip_whitelist[i].split("-");",
        "      list_first_ipaddress_dec=inet_aton(list_entry[0]);",
        "      list_last_ipaddress_dec=inet_aton(list_entry[1]);",
        "      if(src_ipaddress_dec>=list_first_ipaddress_dec && src_ipaddress_dec<=list_last_ipaddress_dec)",
        "      {",
        "        sharedState.put("debug-whitelist","condition met for: " + src_ipaddress + ", " + outcome + "->low");",
        "        outcome = "low";",
        "      }",
        "    }",
        "  }",
        "",
        "",
        "",
        "  sharedState.put('debug-score',score.toString());",
        "  sharedState.put('debug-signal-count',signal_count.toString());",
        "  sharedState.put('debug-outcome',outcome);",
        "}());",
      ],
    },
    "a064f7b7-29c5-480b-ac09-d3d122829278": {
      "_id": "a064f7b7-29c5-480b-ac09-d3d122829278",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Sanitize objectAttributes",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Sanitize objectAttributes",
      "script": [
        "/*",
        "{",
        "    "userName": "sholmes",",
        "    "givenName": "Sherlock",",
        "    "sn": "Holmes",",
        "    "mail": "info918@06152alerts.security.org",",
        "    "telephoneNumber": ,",
        "    "postalAddress": "221B Baker Street",",
        "    "city": "London",",
        "    "stateProvince": ,",
        "    "postalCode": "NW1",",
        "    "country": "United States",",
        "    "preferences": {",
        "        "marketing": false,",
        "        "updates": true",
        "    }",
        "}",
        "*/",
        "logger.error("Sanitize objectAttributes: start");",
        "outcome = "true";",
        "var attrs = sharedState.get("objectAttributes");",
        "if (attrs) {",
        "  var keys = [",
        "    "userName",",
        "    "givenName",",
        "    "sn",",
        "    "mail",",
        "    "telephoneNumber",",
        "    "postalAddress",",
        "    "city",",
        "    "stateProvince",",
        "    "postalCode",",
        "    "country",",
        "    "frIndexedString2"",
        "  ]",
        "  keys.forEach(function (key) {",
        "    if (attrs.get(key) && attrs.get(key).toString() == "") {",
        "      logger.error("Sanitize objectAttributes: remove ".concat(key));",
        "      attrs.remove(key);",
        "    }",
        "  })",
        "}",
        "if (transientState.get("objectAttributes") && transientState.get("objectAttributes").get("password").toString() !== "") {",
        "  logger.error("Sanitize objectAttributes: preserve password in shared state");",
        "  setSharedObjectAttribute("password", transientState.get("objectAttributes").get("password").toString());",
        "}",
        "logger.error("Sanitize objectAttributes: end");",
        "",
        "/*",
        " * Properly set attributes in shared state for use with the Create/Patch Object nodes.",
        " */",
        "function setSharedObjectAttribute(name, value) {",
        "    if (sharedState.get("objectAttributes")) {",
        "        sharedState.get("objectAttributes").put(name, value);",
        "    }",
        "    else {",
        "        sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":"+value+"}"));",
        "    }",
        "}",
      ],
    },
    "a316aedd-8b3b-4f68-b6e8-65859f1e87be": {
      "_id": "a316aedd-8b3b-4f68-b6e8-65859f1e87be",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_LocalRegistrationPrep",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        "When an admin managed object is created at the time of invitation, the email address",
        "is used to populate the required first/last names.  This script clears those attributes",
        "(if set to the email address) so the UI doesn't display the email address in the first/last",
        "name input fields.",
        "",
        "It also populates other required attributes with fake values to ensure password policy",
        "validation works correctly when AM calls IDM.",
        "*/",
        "",
        "var objAttrs = sharedState.get('objectAttributes') || new java.util.HashMap();",
        "objAttrs.put('givenName', '');",
        "objAttrs.put('sn', '');",
        "objAttrs.put('groups', ['fake']);",
        "objAttrs.put('inviteDate', 'fake');",
        "sharedState.put('objectAttributes', objAttrs);",
        "",
        "outcome = 'True';",
        "",
      ],
    },
    "a31a1796-8410-46b8-82ca-eb0c6e901775": {
      "_id": "a31a1796-8410-46b8-82ca-eb0c6e901775",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Collect all the configuration items required for the Set Custom Cookie node to function properly.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Collect Set Custom Cookie Node Config",
      "script": [
        "/* Collect Set Custom Cookie Node Config",
        " * ",
        " * Collect all the configuration items required for the Set Custom Cookie node to function properly.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    outcome = "true";",
        "      var config = {",
        "        "name": "oreo",",
        "        "value": "original",",
        "        "domain": ".scheuber.io",",
        "        "path": "/",",
        "        "maxAge": 3600,",
        "        "useHttpOnlyCookie": true,",
        "        "useSecureCookie": true,",
        "        "sameSite": "NONE"",
        "    };",
        "  ",
        "      var script = "";",
        "    script += "Array.prototype.slice.call(";",
        "    script += "    document.getElementsByTagName('input')";",
        "    script += ").forEach(";",
        "    script += "    function (input,i) {";",
        "    script += "        console.log('input '+i);"",
        "    script += "        var config = JSON.parse('"+JSON.stringify(config)+"');";",
        "    script += "        var keys = Object.keys(config);";",
        "    script += "        if (input.type === 'text') {";",
        "    script += "            input.setAttribute('value', config[keys[i]]);";",
        "    script += "            input.dispatchEvent(new KeyboardEvent( 'input' , {'key':'Enter'} ));";",
        "    script += "        }";",
        "    script += "    }";",
        "    script += ");";",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "          javax.security.auth.callback.NameCallback,",
        "        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        "    )",
        "    if (callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "            new fr.NameCallback("name"),",
        "            new fr.NameCallback("value"),",
        "            new fr.NameCallback("domain"),",
        "            new fr.NameCallback("path"),",
        "            new fr.NameCallback("maxAge"),",
        "            new fr.NameCallback("useHttpOnlyCookie"),",
        "            new fr.NameCallback("useSecureCookie"),",
        "            new fr.NameCallback("sameSite"),",
        "              new fr.ScriptTextOutputCallback(script)",
        "        ).build();",
        "    }",
        "    else {",
        "          config[callbacks.get(0).getPrompt()] = callbacks.get(0).getName();",
        "          config[callbacks.get(1).getPrompt()] = callbacks.get(1).getName();",
        "          config[callbacks.get(2).getPrompt()] = callbacks.get(2).getName();",
        "          config[callbacks.get(3).getPrompt()] = callbacks.get(3).getName();",
        "          config[callbacks.get(4).getPrompt()] = parseInt(callbacks.get(4).getName(), 10).toFixed();",
        "          config[callbacks.get(5).getPrompt()] = (""+callbacks.get(5).getName() === 'true');",
        "          config[callbacks.get(6).getPrompt()] = (""+callbacks.get(6).getName() === 'true');",
        "          config[callbacks.get(7).getPrompt()] = callbacks.get(7).getName();",
        "          nodeState.putShared("nodeConfig", config);",
        "        action = fr.Action.goTo(outcome).build();",
        "    }",
        "}());",
      ],
    },
    "a7a78773-445b-4eca-bb93-409e86bced81": {
      "_id": "a7a78773-445b-4eca-bb93-409e86bced81",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from GitHub",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "GitHub Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2022 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "return json(object(",
        "        field("id", rawProfile.id),",
        "        field("displayName", rawProfile.name),",
        "        field("username", rawProfile.login)))",
      ],
    },
    "a873fcd8-8f17-4675-9dd6-54ab1c11e2df": {
      "_id": "a873fcd8-8f17-4675-9dd6-54ab1c11e2df",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Record that MFA has been performed for this journey and no longer needs to be performed. This allows journeys and inner journeys to check that flag before performing MFA multiple times.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Record MFA",
      "script": [
        "/* MFA Status",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Record that MFA has been performed for this journey and no longer needs ",
        " * to be performed. This allows journeys and inner journeys to check that ",
        " * flag before performing MFA multiple times.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "outcome = "true";",
        "sharedState.put("mfaPerformed", "true");",
      ],
    },
    "a8f10e93-3f6c-4d6c-b6a3-a8453e3d6b3a": {
      "_id": "a8f10e93-3f6c-4d6c-b6a3-a8453e3d6b3a",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Reset the attributes holding replay credentials for the IG replay use case.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "ResetPasswordReplayCredentials",
      "script": [
        "/* ResetPasswordReplayCredentials",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Reset the attributes holding replay credentials for the IG replay use case.",
        " * ",
        " * This script needs to be parametrized for your env.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "(function () {",
        "  outcome = "true";",
        "  var REPLAY_USERNAME_IDM_ATTR = "frUnindexedString1";",
        "  var REPLAY_PASSWORD_IDM_ATTR = "frUnindexedString2";",
        "  ",
        "  sharedState.get("objectAttributes").put(REPLAY_USERNAME_IDM_ATTR, null);",
        "  sharedState.get("objectAttributes").put(REPLAY_PASSWORD_IDM_ATTR, null);",
        "}());",
      ],
    },
    "aa2dabff-f5c4-4dc5-b4ac-5909e88a3a8f": {
      "_id": "aa2dabff-f5c4-4dc5-b4ac-5909e88a3a8f",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Verify known caller by first name",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Twilio IVR: Verify Known Caller",
      "script": [
        "/* Twilio IVR: Verify Known Caller",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * - false",
        " * ",
        " * Depending on the amount of data collected through callbacks and how many of the callParams",
        " * you activate below, you will need to change your authentication session from JWT to CTS or",
        " * Memory.",
        " */",
        "logger.warning("Twilio IVR: Verify Known Caller: start");",
        "outcome = "false";",
        "",
        "/* Begin Configuration",
        " */",
        "",
        "// For ID Cloud use "_id", for classic deployments use "username"",
        "var userid = sharedState.get("_id")",
        "",
        "// Retrieve the known caller's first name",
        "var firstName = idRepository.getAttribute(userid, "givenName").iterator().next().replaceAll("[^a-zA-Z ]", "").toLowerCase();",
        "",
        "// Build out the full message",
        "var message = "I see we have a profile associated with your phone number!";",
        "",
        "// Build out the verification prompt",
        "var prompt = "To verify I have the right account, please say your first name.";",
        "",
        "/* End Configuration",
        " */",
        "",
        "var fr = JavaImporter(",
        "      org.forgerock.openam.auth.node.api,",
        "      javax.security.auth.callback.TextOutputCallback,",
        "      javax.security.auth.callback.TextInputCallback",
        ");",
        "  ",
        "with (fr) {",
        "      if (callbacks.isEmpty()) {",
        "        var output = new TextOutputCallback(TextOutputCallback.INFORMATION, message);",
        "        var input = new TextInputCallback(prompt);",
        "        action = Action.send(output, input).build();",
        "      } ",
        "      else {",
        "          var answer = callbacks.get(1).getText().replaceAll("[^a-zA-Z ]", "").toLowerCase();",
        "        logger.warning("Twilio IVR: Verify Known Caller: callbacks received: answer=".concat(answer).concat(" [firstName=").concat(firstName).concat("]"));",
        "        if (answer == firstName) {",
        "              outcome = "true";",
        "        }",
        "          else if (answer.length == 0) {",
        "              outcome = "no input";",
        "        }",
        "        logger.warning("Twilio IVR: Verify Known Caller: finish [outcome=".concat(outcome).concat("]"));",
        "        action = Action.goTo(outcome).build();",
        "      }",
        "}",
      ],
    },
    "ab78dcb5-85cb-41a6-813e-e07a77761376": {
      "_id": "ab78dcb5-85cb-41a6-813e-e07a77761376",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_ProfileToManagedObject",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "function setIfValidString(managedData, managedKey, profileKey) {",
        "  var normalizedValue = normalizedProfile.get(profileKey);",
        "  if (normalizedValue && !normalizedValue.isNull() && normalizedValue.asString() != '') {",
        "    managedData.put(managedKey, normalizedValue);",
        "  }",
        "}",
        "",
        "(function () {",
        "  var frJava = JavaImporter(",
        "    org.forgerock.json.JsonValue,",
        "    java.util.HashMap",
        "  );",
        "",
        "  var OBJ_ATTR = 'objectAttributes';",
        "",
        "  // We should have objectAttributes during onboarding because the user is established earlier in",
        "  // the journey.  We won't have objectAttributes during login, though.",
        "  var objAttrs = sharedState.containsKey(OBJ_ATTR) ? sharedState.get(OBJ_ATTR) : new frJava.HashMap();",
        "",
        "  // If this flow requires email matching, confirm the IdP user email address matches the FR email address",
        "  if (sharedState.checkEmailClaim == true) {",
        "    var idpEmail = normalizedProfile.get('email').asString();",
        "    var frEmail = objAttrs.get('mail');",
        "    if (idpEmail != frEmail) {",
        "      throw 'Email claim from IDP does not match identity mail attribute';",
        "    }",
        "  }",
        "",
        "  // Update user with first/last name from IDP, if available",
        "  var managedUserData = frJava.JsonValue.json(frJava.JsonValue.object());",
        "  setIfValidString(managedUserData, 'givenName', 'givenName');",
        "  setIfValidString(managedUserData, 'sn', 'familyName');",
        "  ",
        "  // For login: Ensure the mail attribute is set in case we have to look up the admin using",
        "  // their email.  This will occur when an existing admin is federating for the first time.",
        "  if (!objAttrs.containsKey('mail')) {",
        "    managedUserData.put('mail', normalizedProfile.get('email').asString());",
        "  }",
        "",
        "  if (!normalizedProfile.get('groups').isNull()) {",
        "    managedUserData.put('groups', normalizedProfile.get('groups').asList());",
        "  }",
        "  ",
        "  // Merge anything we've put into \`managedUserData\` into sharedState.objectAttributes because",
        "  // \`managedUserData\` goes into transient state, which isn't used by our downstream nodes",
        "  var keys = managedUserData.keys().toArray();",
        "  for (var i = 0; i < keys.length; i++) {",
        "    objAttrs.put(keys[i], managedUserData.get(keys[i]));",
        "  }",
        "  sharedState.put(OBJ_ATTR, objAttrs);",
        "",
        "  return managedUserData;",
        "}());",
      ],
    },
    "ab917dad-6fdb-46c2-8c8c-42f094ebeea1": {
      "_id": "ab917dad-6fdb-46c2-8c8c-42f094ebeea1",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Perform IDP re-lookup based on the Organization ID from the initial lookup. Set users' external IDP in shared state for further processing.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "IDP Re-Lookup",
      "script": [
        "/* IDP Re-Lookup",
        " * ",
        " * Perform IDP re-lookup based on the Organization ID from the initial lookup. ",
        " * Set users' external IDP in shared state for further processing.",
        " * ",
        " * This script requires parametrization. Make sure you carefully review the configuration parameters.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * - false",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    logger.message("IDP Re-Lookup: start");",
        "      outcome = "false";",
        "      var referer = parseUrl(requestHeaders.get("referer").get(0));",
        "      var orgId = referer.searchParam.o;",
        "      sharedState.put("username", referer.searchParam.u);",
        "",
        "      /* Begin Configuration */",
        "  ",
        "    // long-lived token, expires: Friday, January 16, 2032 9:45:14 PM GMT-06:00",
        "    var IDM_API_TOKEN = "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJlMWE1YzU5OC04MGUyLTRhZGMtYjM0NS0zMWQwMmUyOThjNGIiLCJjdHMiOiJPQVVUSDJfR1JBTlRfU0VUIiwiYXV0aF9sZXZlbCI6MCwiYXVkaXRUcmFja2luZ0lkIjoiNGYzMDkxYTktZjU0Ni00MDdiLTkzNjMtM2RiZGJiZjYzMDc0LTM1NzcwOSIsInN1Ym5hbWUiOiJlMWE1YzU5OC04MGUyLTRhZGMtYjM0NS0zMWQwMmUyOThjNGIiLCJpc3MiOiJodHRwczovL29wZW5hbS12b2xrZXItZGV2LmZvcmdlYmxvY2tzLmNvbTo0NDMvYW0vb2F1dGgyL2FscGhhIiwidG9rZW5OYW1lIjoiYWNjZXNzX3Rva2VuIiwidG9rZW5fdHlwZSI6IkJlYXJlciIsImF1dGhHcmFudElkIjoiLUIxQlRUM3FqNi04Zkd3a2d6bzgzNzlSRjVJLjA4NkNJdTFyOUNCNlROcEIwV3Q5OFEyNTJYcyIsImF1ZCI6IjY5ZDA1YzExLWU4ZmUtNGFlNS1hN2M5LTIyNTJhNGQ4NWRmNCIsIm5iZiI6MTY0MjU2MzkxNCwiZ3JhbnRfdHlwZSI6InBhc3N3b3JkIiwic2NvcGUiOlsiZnI6aWRtOioiXSwiYXV0aF90aW1lIjoxNjQyNTYzOTE0LCJyZWFsbSI6Ii9hbHBoYSIsImV4cCI6MTk1NzkyMzkxNCwiaWF0IjoxNjQyNTYzOTE0LCJleHBpcmVzX2luIjozMTUzNjAwMDAsImp0aSI6Ii1CMUJUVDNxajYtOGZHd2tnem84Mzc5UkY1SS5CSHFZNVp3c0lGNVpMbEtvcGNvUlVGVHNLUjAiLCJtYXlfYWN0Ijp7ImNsaWVudF9pZCI6WyI2OWQwNWMxMS1lOGZlLTRhZTUtYTdjOS0yMjUyYTRkODVkZjQiXX19.f2NmwHVtekH93jO7-jM6mkFRcuvEN3WzcKsH-RAPnlc";",
        "",
        "    // IDM API Configuration",
        "    var IDM_API_URI = referer.origin + "/openidm/managed/alpha_organization/"+ orgId + "?_fields=name,description,idpName,idpType,idpDomains,idpJourney,idpTheme,idpPersist";",
        "",
        "      /* End Configuration */",
        "",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setMethod('GET');",
        "    request.setUri(IDM_API_URI);",
        "    request.getHeaders().add("Content-Type", "application/json; charset=UTF-8");",
        "    request.getHeaders().add("Authorization", "Bearer " + IDM_API_TOKEN);",
        "",
        "    var response = httpClient.send(request).get();",
        "    var result = JSON.parse(response.getEntity().getString());",
        "    logger.message("IDP Re-Lookup: JSON result: " + JSON.stringify(result));",
        "    ",
        "      if (result) {",
        "          outcome = "true";",
        "        var routedIDPs = [result];",
        "        sharedState.put("routedIDPs", routedIDPs);",
        "        logger.message("IDP Re-Lookup: Found IDP");",
        "    }",
        "    logger.message("IDP Re-Lookup: end [outcome={}]", outcome);",
        "",
        "    /*",
        "     * Parse a URL into its components and make them easily accessible by name",
        "     *",
        "     * Use in a Scripte Decision Node Script as follows:",
        "     * var referer = parseUrl(requestHeaders.get("referer").get(0));",
        "     * var origin = referer.origin;",
        "     * ",
        "     * e.g.: https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/",
        "     * {",
        "     *     hash: '#/',",
        "     *     host: 'openam-volker-dev.forgeblocks.com',",
        "     *     hostname: 'openam-volker-dev.forgeblocks.com',",
        "     *     href: 'https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/',",
        "     *     origin: 'https://openam-volker-dev.forgeblocks.com',",
        "     *     pathname: '/am/XUI/',",
        "     *     port: '',",
        "     *     protocol: 'https',",
        "     *     search: '?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim',",
        "     *     username: '',",
        "     *     password: '',",
        "     *     searchParam: {",
        "     *         realm: '/bravo',",
        "     *         authIndexType: 'service',",
        "     *         authIndexValue: 'InitiateOwnerClaim'",
        "     *     }",
        "     * }",
        "     */",
        "    function parseUrl(href) {",
        "        var m = href.match(/^(([^:\\/?#]+):?(?:\\/\\/((?:([^\\/?#:]*):([^\\/?#:]*)@)?([^\\/?#:]*)(?::([^\\/?#:]*))?)))?([^?#]*)(\\?[^#]*)?(#.*)?$/),",
        "        r = {",
        "            hash: m[10] || "",                      // #/",
        "            host: m[3] || "",                       // openam-volker-dev.forgeblocks.com",
        "            hostname: m[6] || "",                   // openam-volker-dev.forgeblocks.com",
        "            href: m[0] || "",                       // https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/",
        "            origin: m[1] || "",                     // https://openam-volker-dev.forgeblocks.com",
        "            pathname: m[8] || (m[1] ? "/" : ""),    // /am/XUI/",
        "            port: m[7] || "",                       // ",
        "            protocol: m[2] || "",                   // https",
        "            search: m[9] || "",                     // ?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim",
        "            username: m[4] || "",                   // ",
        "            password: m[5] || "",                   // ",
        "            searchParam: {}                         // { realm: '/bravo',",
        "                                                    //   authIndexType: 'service',",
        "                                                    //   authIndexValue: 'InitiateOwnerClaim' }",
        "        };",
        "        if (r.protocol.length == 2) {",
        "            r.protocol = "file:///" + r.protocol.toUpperCase();",
        "            r.origin = r.protocol + "//" + r.host;",
        "        }",
        "        if (r.search.length > 2) {",
        "            var query = (r.search.indexOf('?') === 0) ? r.search.substr(1) : r.search;",
        "            var vars = query.split('&');",
        "            for (var i = 0; i < vars.length; i++) {",
        "            var pair = vars[i].split('=');",
        "            r.searchParam[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1]);",
        "            }",
        "        }",
        "        r.href = r.origin + r.pathname + r.search + r.hash;",
        "        return r;",
        "    };",
        "}());",
      ],
    },
    "ac9fc25e-3ad9-4f80-a796-2d9093795439": {
      "_id": "ac9fc25e-3ad9-4f80-a796-2d9093795439",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Check if MFA has already been performed for this journey. This allows journeys and inner journeys not to perform MFA multiple times.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "MFA Status",
      "script": [
        "/* MFA Status",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Check if MFA has already been performed for this journey. ",
        " * This allows journeys and inner journeys not to perform MFA multiple times.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * - false",
        " */",
        "outcome = "false";",
        "if (sharedState.get("mfaPerformed")=="true") {",
        "      outcome = "true";",
        "}",
      ],
    },
    "aef262d0-7a42-4a34-9826-e7dbc2ea6eb9": {
      "_id": "aef262d0-7a42-4a34-9826-e7dbc2ea6eb9",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Route users to their organization's IDP of type saml, oidc, local, or custom and apply the organization's theme, if specified",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "IDP Router",
      "script": [
        "/* IDP Router",
        " * ",
        " * Route users to their organization's IDP of type saml, oidc, local, ",
        " * or custom and apply the organization's theme, if specified.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - saml",
        " * - oidc",
        " * - local",
        " * - custom",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "      logger.message("IDP Router: Start");",
        "    outcome = "local";",
        "      var referer = parseUrl(requestHeaders.get("referer").get(0));",
        "      var routedIDP = sharedState.get("routedIDPs").get(0);",
        "      if (routedIDP) {",
        "        outcome = routedIDP.get("idpType");",
        "        logger.message("IDP Router: Routed IDP: " + routedIDP);",
        "          sharedState.put("selectedIdp", routedIDP.get("idpName"));",
        "        var nodeConfig = {};",
        "          // load samlConfig",
        "          if (routedIDP.get("samlConfig")) {",
        "              nodeConfig = JSON.parse(routedIDP.get("samlConfig"));",
        "        }",
        "          // route to a custom journey",
        "        if (routedIDP.get("idpJourney")) {",
        "            logger.message("IDP Router: Route to custom IDP {}, journey: {}", routedIDP.get("idpName"), routedIDP.get("idpJourney"));",
        "              nodeConfig.tree = routedIDP.get("idpJourney");",
        "              outcome = "custom";",
        "        }",
        "          sharedState.put("nodeConfig", nodeConfig);",
        "          // only send callback if the org/idp requires a custom theme",
        "        if (routedIDP.get("idpTheme") && callbacks.isEmpty()) {",
        "            var stage = "themeId="+routedIDP.get("idpTheme");",
        "            var fr = JavaImporter(",
        "                org.forgerock.openam.auth.node.api.Action,",
        "                org.forgerock.openam.authentication.callbacks.PollingWaitCallback",
        "            )",
        "              action = fr.Action.send(",
        "                  new fr.PollingWaitCallback("0", "Please wait ...")",
        "            ).withStage(stage).build();",
        "          }",
        "    }",
        "      logger.message("IDP Router: Done [outcome={}]", outcome);",
        "",
        "    /*",
        "     * Parse a URL into its components and make them easily accessible by name",
        "     *",
        "     * Use in a Scripte Decision Node Script as follows:",
        "     * var referer = parseUrl(requestHeaders.get("referer").get(0));",
        "     * var origin = referer.origin;",
        "     * ",
        "     * e.g.: https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/",
        "     * {",
        "     *     hash: '#/',",
        "     *     host: 'openam-volker-dev.forgeblocks.com',",
        "     *     hostname: 'openam-volker-dev.forgeblocks.com',",
        "     *     href: 'https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/',",
        "     *     origin: 'https://openam-volker-dev.forgeblocks.com',",
        "     *     pathname: '/am/XUI/',",
        "     *     port: '',",
        "     *     protocol: 'https',",
        "     *     search: '?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim',",
        "     *     username: '',",
        "     *     password: '',",
        "     *     searchParam: {",
        "     *         realm: '/bravo',",
        "     *         authIndexType: 'service',",
        "     *         authIndexValue: 'InitiateOwnerClaim'",
        "     *     }",
        "     * }",
        "     */",
        "    function parseUrl(href) {",
        "        var m = href.match(/^(([^:\\/?#]+):?(?:\\/\\/((?:([^\\/?#:]*):([^\\/?#:]*)@)?([^\\/?#:]*)(?::([^\\/?#:]*))?)))?([^?#]*)(\\?[^#]*)?(#.*)?$/),",
        "        r = {",
        "            hash: m[10] || "",                      // #/",
        "            host: m[3] || "",                       // openam-volker-dev.forgeblocks.com",
        "            hostname: m[6] || "",                   // openam-volker-dev.forgeblocks.com",
        "            href: m[0] || "",                       // https://openam-volker-dev.forgeblocks.com/am/XUI/?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim#/",
        "            origin: m[1] || "",                     // https://openam-volker-dev.forgeblocks.com",
        "            pathname: m[8] || (m[1] ? "/" : ""),    // /am/XUI/",
        "            port: m[7] || "",                       // ",
        "            protocol: m[2] || "",                   // https",
        "            search: m[9] || "",                     // ?realm=/bravo&authIndexType=service&authIndexValue=InitiateOwnerClaim",
        "            username: m[4] || "",                   // ",
        "            password: m[5] || "",                   // ",
        "            searchParam: {}                         // { realm: '/bravo',",
        "                                                    //   authIndexType: 'service',",
        "                                                    //   authIndexValue: 'InitiateOwnerClaim' }",
        "        };",
        "        if (r.protocol.length == 2) {",
        "            r.protocol = "file:///" + r.protocol.toUpperCase();",
        "            r.origin = r.protocol + "//" + r.host;",
        "        }",
        "        if (r.search.length > 2) {",
        "            var query = (r.search.indexOf('?') === 0) ? r.search.substr(1) : r.search;",
        "            var vars = query.split('&');",
        "            for (var i = 0; i < vars.length; i++) {",
        "            var pair = vars[i].split('=');",
        "            r.searchParam[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1]);",
        "            }",
        "        }",
        "        r.href = r.origin + r.pathname + r.search + r.hash;",
        "        return r;",
        "    };",
        "}());",
      ],
    },
    "b3824c66-2dff-4613-9e54-4a7577fdb765": {
      "_id": "b3824c66-2dff-4613-9e54-4a7577fdb765",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Places a timestamp in the frIndexedMultivalued1 attribute",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "TimeStamp_Login",
      "script": [
        "/*",
        "  - Data made available by nodes that have already executed are available in the sharedState variable.",
        "  - The script should set outcome to either "true" or "false".",
        " */",
        "",
        "",
        "//var timestamps = sharedState.get("objectAttributes").get("frIndexedMultivalued1");",
        "",
        "",
        "var lastLogin = new Date();",
        "/*",
        "var datetime = ""+ currentdate.getDate() + "/"",
        "                + (currentdate.getMonth()+1)  + "/" ",
        "                + currentdate.getFullYear() + " @ "  ",
        "                + currentdate.getHours() + ":"  ",
        "                + currentdate.getMinutes() + ":" ",
        "                + currentdate.getSeconds();",
        "*/",
        "",
        "var objectAttributes = sharedState.get("objectAttributes");",
        "",
        "",
        "sharedState.put("last Login",lastLogin.toString());",
        "",
        "",
        "",
        "",
        "",
        "objectAttributes.put("frUnindexedString1",lastLogin.toString());",
        "",
        "",
        "sharedState.put("objectAttributes",objectAttributes);",
        "",
        "",
        "outcome = "true";",
      ],
    },
    "b63981d8-cb73-4e47-8749-e58654dcaa31": {
      "_id": "b63981d8-cb73-4e47-8749-e58654dcaa31",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "This script uses phonevalidator.com to determine the type of phone number stored in the user profile.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Phone Validator - Line Type",
      "script": [
        "/* Phone Validator - Line Type",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * This script uses phonevalidator.com to determine the type of phone number stored in the user profile.",
        " * Get your own API Key at https://www.phonevalidator.com",
        " * ",
        " * This script needs to be parametrized. It will not work properly as is. ",
        " * It requires the Identify Existing User node before it is being called.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - CELL PHONE",
        " * - LANDLINE",
        " * - VOIP",
        " * - TOLL-FREE",
        " * - UNKNOWN",
        " * - failed",
        " */",
        "logger.warning("Phone Validator - Line Type: start");",
        "",
        "if (getSharedObjectAttribute("telephoneNumber") || (sharedState.get("_id") && idRepository.getAttribute(sharedState.get("_id"), "telephoneNumber").iterator().hasNext())) {",
        "",
        "    /* BEGIN SCRIPT CONFIGURATION",
        "     *",
        "     * REPLACE WITH YOUR OWN AZURE AD SETTINGS",
        "     *",
        "       * Phone Validator - Line Type API Configuration",
        "       * Get your own API Key at https://www.phonevalidator.com",
        "     */",
        "    var PV_API_KEY = "849d564a-594d-4bde-b691-afe5ddadd547";",
        "    /*",
        "     * END SCRIPT CONFIGURATION",
        "     */",
        "",
        "      var PV_API_TYPE = "basic";",
        "    var PV_API_PHONE = getSharedObjectAttribute("telephoneNumber") || idRepository.getAttribute(sharedState.get("_id"), "telephoneNumber").iterator().next();",
        "    var PV_API_URI = "https://www.phonevalidator.com/api/v2/phonesearch?apikey=".concat(PV_API_KEY).concat("&phone=").concat(PV_API_PHONE).concat("&type=").concat(PV_API_TYPE);    ",
        "",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setMethod('GET');",
        "    request.setUri(PV_API_URI);",
        "",
        "    var response = httpClient.send(request).get();",
        "    var result = JSON.parse(response.getEntity().getString());",
        "",
        "    if (result["StatusCode"]=="200") {",
        "        outcome = result["PhoneBasic"]["LineType"];",
        "    } else {",
        "        outcome = "failed";",
        "    }",
        "    logger.error("Phone Validator - Line Type: StatusCode = ".concat(result["StatusCode"]));",
        "    logger.error("Phone Validator - Line Type: StatusMessage = ".concat(result["StatusMessage"]));",
        "    logger.error("Phone Validator - Line Type: outcome = ".concat(outcome));",
        "} else {",
        "      outcome = "failed";",
        "      logger.error("Phone Validator - Line Type: No user or phone number found! Use 'Identify Existing User node before this script to populate the user's _id in shared state or put a valid cell phone number into sharedState.objectAttributes.telephoneNumber!'");",
        "    logger.error("Phone Validator - Line Type: outcome = ".concat(outcome));",
        "}",
        "",
        "/*",
        " * Read attributes in shared state for use with the Create/Patch Object nodes.",
        " */",
        "function getSharedObjectAttribute(name) {",
        "    var storage = sharedState.get("objectAttributes");",
        "    if (storage) {",
        "          if (storage.get) {",
        "            return sharedState.get("objectAttributes").get(name);",
        "        }",
        "          else {",
        "            return storage.name;",
        "        }",
        "    }",
        "    return null;",
        "}",
      ],
    },
    "b6fce769-cf21-4963-a8dc-7c5370a4d15b": {
      "_id": "b6fce769-cf21-4963-a8dc-7c5370a4d15b",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "shared State Printer",
      "script": [
        "var fr = JavaImporter(",
        "  org.forgerock.openam.auth.node.api,",
        "  javax.security.auth.callback.TextOutputCallback",
        ");",
        "outcome = "true";",
        "with (fr) {",
        "  if (callbacks.isEmpty()) {",
        "    var callback = new TextOutputCallback(TextOutputCallback.INFORMATION, "sharedState: ".concat(sharedState.toString()));",
        "    action = Action.send(callback).build();",
        "  } else {",
        "    action = Action.goTo("true").build();",
        "  }",
        "}",
      ],
    },
    "b703581a-e112-42b9-bc24-6db8bced5a13": {
      "_id": "b703581a-e112-42b9-bc24-6db8bced5a13",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Display sharedState and transientState.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Display States",
      "script": [
        "/* Display States",
        " * ",
        " * Display sharedState and transientState.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    outcome = "true";",
        "",
        "    var anchor = "anchor-".concat(generateNumericToken('xxx'));",
        "    var halign = "left";",
        "    var message = "<h4>Current State Values</h4>".concat(",
        "        "<p><b>Shared State</b>:<br/>").concat(",
        "        sharedState.toString()).concat("</p>").concat(",
        "        "<p><b>Transient State</b>:<br/>").concat(",
        "        transientState.toString()).concat("</p>").concat(",
        "        "<p><b>Request Headers</b>:<br/>").concat(",
        "        requestHeaders.toString()).concat("</p>")",
        "    var script = "Array.prototype.slice.call(\\n".concat(",
        "      "document.getElementsByClassName('callback-component')).forEach(\\n").concat(",
        "      "function (e) {\\n").concat(",
        "      "  var message = e.firstElementChild;\\n").concat(",
        "      "  if (message.firstChild && message.firstChild.nodeName == '#text' && message.firstChild.nodeValue.trim() == '").concat(anchor).concat("') {\\n").concat(",
        "      "    message.className = \\"\\";\\n").concat(",
        "      "    message.style = \\"text-align: left; inline-size: 430px; overflow-wrap: break-word;\\";\\n").concat(",
        "      "    message.align = \\"").concat(halign).concat("\\";\\n").concat(",
        "      "    message.innerHTML = '").concat(message).concat("';\\n").concat(",
        "      "  }\\n").concat(",
        "      "})")",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "        javax.security.auth.callback.TextOutputCallback,",
        "        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        "    )",
        "    if (message.length && callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "            new fr.TextOutputCallback(",
        "                fr.TextOutputCallback.INFORMATION,",
        "                anchor",
        "            ),",
        "            new fr.ScriptTextOutputCallback(script)",
        "        ).build()",
        "    }",
        "    else {",
        "      action = fr.Action.goTo(outcome).build();",
        "    }",
        "",
        "     /*",
        "      * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "      * ",
        "      * Example:",
        "      * 'xxxxx' produces '28535'",
        "      * 'xxx-xxx' produces '432-521'",
        "      */",
        "    function generateNumericToken(format) {",
        "        return format.replace(/[x]/g, function(c) {",
        "            var r = Math.random()*10|0;",
        "            var v = r;",
        "            return v.toString(10);",
        "        });",
        "    }",
        "}());",
      ],
    },
    "b7ce17a1-e41d-42b0-bedc-f88a4d5e1c3a": {
      "_id": "b7ce17a1-e41d-42b0-bedc-f88a4d5e1c3a",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Prepares onboarding check if not amadmin",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_AmadminCheck",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "var fr = new JavaImporter(",
        "  java.util.HashMap",
        ");",
        "",
        "with (fr) {",
        "  try {",
        "    ",
        "    if (sharedState.get('username').toLowerCase() == 'amadmin') {",
        "      outcome = 'True';",
        "    } else {",
        "      outcome = 'False';",
        "    }",
        "    ",
        "  } catch (e) {",
        "",
        "    logger.error('Failed to determine if user is amadmin: {}', e);",
        "    outcome = 'Error';",
        "",
        "  }",
        "}",
      ],
    },
    "b88ce1fe-2480-4fd5-8062-2bd1f4659e2e": {
      "_id": "b88ce1fe-2480-4fd5-8062-2bd1f4659e2e",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_LoadObjectByID",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        " * This is a utility script to simplify access to admin identity properties. It",
        " * requires that \`sharedState._id\` be populated, which can be loaded using an",
        " * Identify Existing User node.",
        " */",
        "",
        "function val(attrs, name) {",
        "  if (attrs.containsKey(name)) {",
        "    return attrs.get(name).iterator().next();",
        "  }",
        "  return '';",
        "}",
        "",
        "(function() {",
        "  var fr = new JavaImporter(",
        "    org.forgerock.openam.auth.nodes,",
        "    org.forgerock.guice.core",
        "  );",
        "",
        "  with (fr) {",
        "    try {",
        "",
        "      outcome = 'False';",
        "",
        "      if (!sharedState.containsKey('_id')) {",
        "        throw 'Required sharedState property _id is missing';",
        "      }      ",
        "      ",
        "      var realm = sharedState.get('realm');",
        "      var uuid = sharedState.get('_id');",
        "      ",
        "      var identityProvider = InjectorHolder.getInstance(IdentityProvider);",
        "      var identity = identityProvider.getIdentity(uuid, realm);",
        "      var attrs = identity.getAttributes();",
        "      ",
        "      sharedState.put('adminObject', {",
        "        givenName: val(attrs, 'givenName'),        ",
        "        sn: val(attrs, 'sn'),",
        "        mail: val(attrs, 'mail'),",
        "        inviteDate: val(attrs, 'fr-idm-inviteDate'),",
        "        onboardDate: val(attrs, 'fr-idm-onboardDate')        ",
        "      });",
        "",
        "      logger.message('Loaded admin object for id: {}', uuid);",
        "",
        "      outcome = 'True';",
        "",
        "    } catch (e) {",
        "      logger.error('Failed to load admin object: {}', e);",
        "    }",
        "  }",
        "}());",
      ],
    },
    "bae1d54a-e97d-4997-aa5d-c027f21af82c": {
      "_id": "bae1d54a-e97d-4997-aa5d-c027f21af82c",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from Facebook",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Facebook Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2020 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "return json(object(",
        "        field("id", rawProfile.id),",
        "        field("displayName", rawProfile.name),",
        "        field("givenName", rawProfile.first_name),",
        "        field("familyName", rawProfile.last_name),",
        "        field("photoUrl", rawProfile.picture.data.url),",
        "        field("email", rawProfile.email),",
        "        field("username", rawProfile.email)))",
      ],
    },
    "be6f1f2c-30ee-41fb-9e1e-8da72267fad3": {
      "_id": "be6f1f2c-30ee-41fb-9e1e-8da72267fad3",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Greet verified caller",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Twilio IVR: Greet Verified Caller",
      "script": [
        "/* Twilio IVR: Greet Verified Caller",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * ",
        " * Depending on the amount of data collected through callbacks and how many of the callParams",
        " * you activate below, you will need to change your authentication session from JWT to CTS or",
        " * Memory.",
        " */",
        "outcome = "true";",
        "",
        "/* Begin Configuration",
        " */",
        "",
        "// For ID Cloud use "_id", for classic deployments use "username"",
        "var userid = sharedState.get("_id")",
        "",
        "// Configure how you would like to address the verified caller. The default is the full name.",
        "var name = [idRepository.getAttribute(userid, "givenName").iterator().next(), idRepository.getAttribute(userid, "sn").iterator().next()].join(" ");",
        "",
        "// Build out the full message",
        "var message = ["Hello", name, "! How can I help you today?"].join(" ");",
        "",
        "/* End Configuration",
        " */",
        "",
        "var fr = JavaImporter(",
        "      org.forgerock.openam.auth.node.api,",
        "      javax.security.auth.callback.TextOutputCallback",
        ");",
        "  ",
        "with (fr) {",
        "      if (callbacks.isEmpty()) {",
        "        var output = new TextOutputCallback(TextOutputCallback.INFORMATION, message);",
        "        action = Action.send(output).build();",
        "      } ",
        "      else {",
        "        action = Action.goTo(outcome).build();",
        "      }",
        "}",
      ],
    },
    "c234ba0b-58a1-4cfd-9567-09edde980745": {
      "_id": "c234ba0b-58a1-4cfd-9567-09edde980745",
      "context": "OAUTH2_ACCESS_TOKEN_MODIFICATION",
      "createdBy": "null",
      "creationDate": 1433147666269,
      "default": true,
      "description": "Internal token modification script",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "ForgeRock Internal: OAuth2 Access Token Modification Script",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "// Script is intentionally empty",
        "",
      ],
    },
    "c253a7ac-ebc9-4268-9e62-89f38f98e4ab": {
      "_id": "c253a7ac-ebc9-4268-9e62-89f38f98e4ab",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "CopyIDToObjectAttributes",
      "script": [
        "/*",
        "  - Data made available by nodes that have already executed are available in the sharedState variable.",
        "  - The script should set outcome to either "true" or "false".",
        " */",
        "",
        "sharedState.get("objectAttributes").put("_id", sharedState.get("_id"));",
        "",
        "outcome = "true";",
      ],
    },
    "c827d2b4-3608-4693-868e-bbcf86bd87c7": {
      "_id": "c827d2b4-3608-4693-868e-bbcf86bd87c7",
      "context": "AUTHENTICATION_CLIENT_SIDE",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Default global script for client side Scripted Authentication Module",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Scripted Module - Client Side",
      "script": [
        "/*",
        " * Copyright 2016-2017 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "/* Default Authentication client side script to use as a template for new scripts */",
      ],
    },
    "c9fa3899-c3ce-4833-af83-64d709202600": {
      "_id": "c9fa3899-c3ce-4833-af83-64d709202600",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Verify security PIN",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Twilio IVR: Verify Security PIN",
      "script": [
        "/* Twilio IVR: Verify Security PIN",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * - false",
        " * ",
        " * Depending on the amount of data collected through callbacks and how many of the callParams",
        " * you activate below, you will need to change your authentication session from JWT to CTS or",
        " * Memory.",
        " */",
        "logger.warning("Twilio IVR: Verify Security PIN: start");",
        "outcome = "false";",
        "",
        "/* Begin Configuration",
        " */",
        "",
        "// For ID Cloud use "_id", for classic deployments use "username"",
        "var userid = sharedState.get("_id")",
        "",
        "// Retrieve the identified caller's PIN (in IDM: frUnindexedInteger5, in AM: fr-attr-int5)",
        "var securityPIN = idRepository.getAttribute(userid, "fr-attr-int5").iterator().next();",
        "",
        "// Build out the verification prompt",
        "var prompt = "To verify I have the right account, please enter your 4-digit security PIN.";",
        "",
        "/* End Configuration",
        " */",
        "",
        "var fr = JavaImporter(",
        "      org.forgerock.openam.auth.node.api,",
        "      javax.security.auth.callback.TextInputCallback",
        ");",
        "  ",
        "with (fr) {",
        "      if (callbacks.isEmpty()) {",
        "        var input = new TextInputCallback(prompt);",
        "        action = Action.send(input).build();",
        "      } ",
        "      else {",
        "          var answer = new String(callbacks.get(0).getText()).replace(/[^0-9]/g, "");",
        "        logger.warning("Twilio IVR: Verify Security PIN: callbacks received");",
        "        if (answer == securityPIN) {",
        "              outcome = "true";",
        "        }",
        "        logger.warning("Twilio IVR: Verify Security PIN: finish [outcome=".concat(outcome).concat("]"));",
        "        action = Action.goTo(outcome).build();",
        "      }",
        "}",
      ],
    },
    "cdea92a1-d2bf-4364-a525-fde8b7a95792": {
      "_id": "cdea92a1-d2bf-4364-a525-fde8b7a95792",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Get Lockout Status",
      "script": [
        "outcome = "true";",
        "",
        "var username = sharedState.get("_id")",
        "var lockoutDataAttr = "sunAMAuthInvalidAttemptsData"",
        "var accountStatusAttr = "inetUserStatus"",
        "",
        "var lockoutData = idRepository.getAttribute(username, lockoutDataAttr)",
        "var accountStatus = idRepository.getAttribute(username, accountStatusAttr)",
        "",
        "transientState.put("lockoutData", lockoutData)",
        "transientState.put("accountStatus", accountStatus)",
        "",
        "logger.error(lockoutData.toString())",
      ],
    },
    "ce6fbbcf-5d9a-471b-bcc1-448758a6374a": {
      "_id": "ce6fbbcf-5d9a-471b-bcc1-448758a6374a",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Validate OTP in profile attribute",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "MobileOTP: Validate OTP In Profile Attribute",
      "script": [
        "/*",
        " * Validate OTP in user profile attribute against OTP in shared state",
        " */",
        "outcome = "false";",
        "var OTP_LENGTH = 8;",
        "",
        "if (sharedState.get("mobileOTP")) {",
        "      var profileOTP = idRepository.getAttribute(username, "fr-attr-int5");",
        "}",
        "",
        "function checkPassword(profileOTP, password) {",
        "    var oneTimePassword = profileOTP.substring(0,7);",
        "    var passwordTimestamp = Number(profileOTP.substring(8));",
        "",
        "    var passwordMatches = oneTimePassword",
        "        && (oneTimePassword == password)",
        "        && passwordTimestamp != null",
        "        && isWithinExpiryTime(passwordTimestamp);",
        "    return passwordMatches;",
        "}",
        "",
        "function isWithinExpiryTime(passwordTimestamp) {",
        "        Instant previous = Instant.ofEpochSecond(passwordTimestamp);",
        "        Duration passwordExpiry = Duration.ofMinutes(config.passwordExpiryTime());",
        "        Instant now = Time.getClock().instant();",
        "        logger.debug("previous {} \\n passwordExpiry {} \\n now {}", previous, passwordExpiry, now);",
        "        boolean withinExpiryTime = Duration.between(previous.plus(passwordExpiry), now).isNegative();",
        "        logger.debug("withinExpiryTime {}", withinExpiryTime);",
        "        return withinExpiryTime;",
        "}",
        "",
        "/*",
        "    private Action checkPassword(TreeContext context, String password) {",
        "        JsonValue oneTimePassword = context.getState(ONE_TIME_PASSWORD);",
        "        JsonValue passwordTimestamp = context.getState(ONE_TIME_PASSWORD_TIMESTAMP);",
        "",
        "        boolean passwordMatches = oneTimePassword != null && oneTimePassword.isString()",
        "                && oneTimePassword.asString().equals(password)",
        "                && passwordTimestamp != null && passwordTimestamp.isNumber()",
        "                && isWithinExpiryTime(passwordTimestamp.asLong());",
        "        logger.debug("passwordMatches {}", passwordMatches);",
        "        return goTo(passwordMatches).build();",
        "    }",
        "",
        "    private boolean isWithinExpiryTime(long passwordTimestamp) {",
        "        Instant previous = Instant.ofEpochSecond(passwordTimestamp);",
        "        Duration passwordExpiry = Duration.ofMinutes(config.passwordExpiryTime());",
        "        Instant now = Time.getClock().instant();",
        "        logger.debug("previous {} \\n passwordExpiry {} \\n now {}", previous, passwordExpiry, now);",
        "        boolean withinExpiryTime = Duration.between(previous.plus(passwordExpiry), now).isNegative();",
        "        logger.debug("withinExpiryTime {}", withinExpiryTime);",
        "        return withinExpiryTime;",
        "    }",
        "    */",
      ],
    },
    "cf3515f0-8278-4ee3-a530-1bad7424c416": {
      "_id": "cf3515f0-8278-4ee3-a530-1bad7424c416",
      "context": "OIDC_CLAIMS",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Default alpha realm script for OIDC claims",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Alpha OIDC Claims Script",
      "script": [
        "/*",
        " * Copyright 2014-2021 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        " * This script computes claim values returned in ID tokens and/or at the UserInfo Endpoint.",
        " * The claim values are computed for:",
        " * the claims derived from the requested scopes,",
        " * the claims provided by the authorization server,",
        " * and the claims requested by the client via the claims parameter.",
        " *",
        " * In the CONFIGURATION AND CUSTOMIZATION section, you can",
        " * define the scope-to-claims mapping, and",
        " * assign to each claim a resolver function that will compute the claim value.",
        " *",
        " * Defined variables (class references are provided below):",
        " * scopes - Set<String> (6).",
        " *          Always present, the requested scopes.",
        " * claims - Map<String, Object> (5).",
        " *          Always present, default server provided claims.",
        " * claimObjects - List<Claim> (7, 2).",
        " *                Always present, the default server provided claims.",
        " * requestedClaims - Map<String, Set<String>> (5).",
        " *                   Always present, not empty if the request contains the claims parameter and the server has enabled",
        " *                   claims_parameter_supported. A map of the requested claims to possible values, otherwise empty;",
        " *                   requested claims with no requested values will have a key but no value in the map. A key with",
        " *                   a single value in its Set (6) indicates that this is the only value that should be returned.",
        " * requestedTypedClaims - List<Claim> (7, 2).",
        " *                        Always present, the requested claims.",
        " *                        Requested claims with no requested values will have a claim with no values.",
        " *                        A claim with a single value indicates this is the only value that should be returned.",
        " * claimsLocales - List<String> (7).",
        " *                 The values from the 'claims_locales' parameter.",
        " *                 See https://openid.net/specs/openid-connect-core-1_0.html#ClaimsLanguagesAndScripts for the OIDC specification details.",
        " * requestProperties - Unmodifiable Map (5).",
        " *                     Always present, contains a map of request properties:",
        " *                     requestUri - The request URI.",
        " *                     realm - The realm that the request relates to.",
        " *                     requestParams - A map of the request params and/or posted data.",
        " *                                     Each value is a list of one or more properties.",
        " *                                     Please note that these should be handled in accordance with OWASP best practices:",
        " *                                     https://owasp.org/www-community/vulnerabilities/Unsafe_use_of_Reflection.",
        " * clientProperties - Unmodifiable Map (5).",
        " *                    Present if the client specified in the request was identified, contains a map of client properties:",
        " *                    clientId - The client's URI for the request locale.",
        " *                    allowedGrantTypes - List of the allowed grant types (org.forgerock.oauth2.core.GrantType) for the client.",
        " *                    allowedResponseTypes - List of the allowed response types for the client.",
        " *                    allowedScopes - List of the allowed scopes for the client.",
        " *                    customProperties - A map of the custom properties of the client.",
        " *                                       Lists or maps will be included as sub-maps; for example:",
        " *                                       customMap[Key1]=Value1 will be returned as customMap -> Key1 -> Value1.",
        " *                                       To add custom properties to a client, update the Custom Properties field",
        " *                                       in AM Console > Realm Name > Applications > OAuth 2.0 > Clients > Client ID > Advanced.",
        " * identity - AMIdentity (3).",
        " *            Always present, the identity of the resource owner.",
        " * session - SSOToken (4).",
        " *           Present if the request contains the session cookie, the user's session object.",
        " * scriptName - String (primitive).",
        " *              Always present, the display name of the script.",
        " * logger - Always present, the "OAuth2Provider" debug logger instance:",
        " *          https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.",
        " *          Corresponding files will be prefixed with: scripts.OIDC_CLAIMS.",
        " * httpClient - HTTP Client (8).",
        " *              Always present, the HTTP Client instance:",
        " *              https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-http-client.html#scripting-api-global-http-client.",
        " *              In order to use the client, you may need to add",
        " *              org.forgerock.http.Client,",
        " *              org.forgerock.http.protocol.*,",
        " *              and org.forgerock.util.promise.PromiseImpl",
        " *              to the allowed Java classes in the scripting engine configuration, as described in:",
        " *              https://backstage.forgerock.com/docs/am/7/scripting-guide/script-engine-security.html",
        " *",
        " * Return - a new UserInfoClaims(Map<String, Object> values, Map<String, List<String>> compositeScopes) (1) object.",
        " *          The result of the last statement in the script is returned to the server.",
        " *          Currently, the Immediately Invoked Function Expression (also known as Self-Executing Anonymous Function)",
        " *          is the last (and only) statement in this script, and its return value will become the script result.",
        " *          Do not use "return variable" statement outside of a function definition.",
        " *          See RESULTS section for additional details.",
        " *",
        " * Class reference:",
        " * (1) UserInfoClaims - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html.",
        " * (2) Claim - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html).",
        " *         An instance of org.forgerock.openidconnect.Claim has methods to access",
        " *         the claim name, requested values, locale, and whether the claim is essential.",
        " * (3) AMIdentity - https://backstage.forgerock.com/docs/am/7/apidocs/com/sun/identity/idm/AMIdentity.html.",
        " * (4) SSOToken - https://backstage.forgerock.com/docs/am/7/apidocs/com/iplanet/sso/SSOToken.html.",
        " * (5) Map - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashMap.html,",
        " *           or https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/LinkedHashMap.html.",
        " * (6) Set - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashSet.html.",
        " * (7) List - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/ArrayList.html.",
        " * (8) Client - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/http/Client.html.",
        "*/",
        "",
        "(function () {",
        "    // SETUP",
        "",
        "    /**",
        "     * Claim processing utilities.",
        "     * An object that contains reusable functions for processing claims.",
        "     * @see CLAIM PROCESSING UTILITIES section for details.",
        "     */",
        "    var utils = getUtils();",
        "",
        "    // CONFIGURATION AND CUSTOMIZATION",
        "",
        "    /**",
        "     * OAuth 2.0 scope values (scopes) can be used by the Client to request OIDC claims.",
        "     *",
        "     * Call this configuration method, and pass in as the first argument",
        "     * an object that maps a scope value to an array of claim names",
        "     * to specify which claims need to be processed and returned for the requested scopes.",
        "     * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#ScopeClaims}",
        "     * for the scope values that could be used to request claims as defined in the OIDC specification.",
        "     *",
        "     * Below, find a default configuration that is expected to work in the current environment.",
        "     *",
        "     * CUSTOMIZATION",
        "     * You can choose the claim names returned for a scope.",
        "     */",
        "    utils.setScopeClaimsMap({",
        "        profile: [",
        "            'name',",
        "            'family_name',",
        "            'given_name',",
        "            'zoneinfo',",
        "            'locale'",
        "        ],",
        "        email: ['email'],",
        "        address: ['address'],",
        "        phone: ['phone_number']",
        "    });",
        "",
        "    /**",
        "     * In this script, each claim",
        "     * derived from the requested scopes,",
        "     * provided by the authorization server, and",
        "     * requested by the client via the claims parameter",
        "     * will be processed by a function associated with the claim name.",
        "     *",
        "     * Call this configuration method, and pass in as the first argument",
        "     * an object that maps a claim name to a resolver function,",
        "     * which will be automatically executed for each claim processed by the script.",
        "     *",
        "     * The claim resolver function will receive the requested claim information",
        "     * in an instance of org.forgerock.openidconnect.Claim as the first argument.",
        "     * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html}",
        "     * for details on the Claim class.",
        "     *",
        "     * If the claim resolver function returns a value,",
        "     * other than undefined or null,",
        "     * the claim will be included in the script's results.",
        "     *",
        "     * The Claim instance provides methods to check",
        "     * what the name of the claim is,",
        "     * which values the claim request contains,",
        "     * whether the claim is essential, and",
        "     * which locale the claim is associated with.",
        "     * The resolver function can consider this information when computing and returning the claim value.",
        "     *",
        "     * Below, find a default configuration that is expected to work in the current environment.",
        "     * A reusable function, utils.getUserProfileClaimResolver(String attribute-name),",
        "     * is called to return a claim resolver function based on a user profile attribute.",
        "     * @see CLAIM RESOLVERS section for the implementation details and examples.",
        "     * For the address claim, an example of a claim resolver that uses another claim resolver is provided.",
        "     *",
        "     * CUSTOMIZATION",
        "     * You can reuse the predefined utils methods with your custom arguments.",
        "     * You can also specify a custom resolver function for a claim name,",
        "     * that will compute and return the claim value—as shown in the commented out example below.",
        "     */",
        "    utils.setClaimResolvers({",
        "        /*",
        "        // An example of a simple claim resolver function that is defined for a claim",
        "        // directly in the configuration object:",
        "        custom-claim-name: function (requestedClaim) {",
        "            // In this case, initially, the claim value comes straight from a user profile attribute value:",
        "            var claimValue = identity.getAttribute('custom-attribute-name').toArray()[0]",
        "",
        "            // Optionally, provide additional logic for processing (filtering, formatting, etc.) the claim value.",
        "            // You can use:",
        "            // requestedClaim.getName()",
        "            // requestedClaim.getValues()",
        "            // requestedClaim.getLocale()",
        "            // requestedClaim.isEssential()",
        "",
        "            return claimValue",
        "        },",
        "        */",
        "        /**",
        "         * The use of utils.getUserProfileClaimResolver shows how",
        "         * an argument passed to a function that returns a claim resolver",
        "         * becomes available to the resolver function (via its lexical context).",
        "         */",
        "        name: utils.getUserProfileClaimResolver('cn'),",
        "        family_name: utils.getUserProfileClaimResolver('sn'),",
        "        given_name: utils.getUserProfileClaimResolver('givenname'),",
        "        zoneinfo: utils.getUserProfileClaimResolver('preferredtimezone'),",
        "        locale: utils.getUserProfileClaimResolver('preferredlocale'),",
        "        email: utils.getUserProfileClaimResolver('mail'),",
        "        address: utils.getAddressClaimResolver(",
        "            /**",
        "             * The passed in user profile claim resolver function",
        "             * can be used by the address claim resolver function",
        "             * to obtain the claim value to be formatted as per the OIDC specification:",
        "             * @see https://openid.net/specs/openid-connect-core-1_0.html#AddressClaim.",
        "             */",
        "            utils.getUserProfileClaimResolver('postaladdress')",
        "        ),",
        "        phone_number: utils.getUserProfileClaimResolver('telephonenumber')",
        "    });",
        "",
        "    // CLAIM PROCESSING UTILITIES",
        "",
        "    /**",
        "     * @returns {object} An object that contains reusable claim processing utilities.",
        "     * @see PUBLIC METHODS section and the return statement for the list of exported functions.",
        "     */",
        "    function getUtils () {",
        "        // IMPORT JAVA",
        "",
        "        /**",
        "         * Provides Java scripting functionality.",
        "         * @see {@link https://developer.mozilla.org/en-US/docs/Mozilla/Projects/Rhino/Scripting_Java#javaimporter_constructor}.",
        "         */",
        "        var frJava = JavaImporter(",
        "            org.forgerock.oauth2.core.exceptions.InvalidRequestException,",
        "            org.forgerock.oauth2.core.UserInfoClaims,",
        "            org.forgerock.openidconnect.Claim,",
        "",
        "            java.util.LinkedHashMap,",
        "            java.util.ArrayList",
        "        );",
        "",
        "        // SET UP CONFIGURATION",
        "",
        "        /**",
        "         * Placeholder for a configuration option that contains",
        "         * an object that maps the supported scope values (scopes)",
        "         * and the corresponding claim names for each scope value.",
        "         */",
        "        var scopeClaimsMap;",
        "",
        "        /**",
        "         * Placeholder for a configuration option that contains",
        "         * an object that maps the supported claim names",
        "         * and the resolver functions returning the claim value.",
        "         */",
        "        var claimResolvers;",
        "",
        "        /**",
        "         * A (public) method that accepts an object that maps the supported scopes and the corresponding claim names,",
        "         * and assigns it to a (private) variable that serves as a configuration option.",
        "         * @param {object} params - An object that maps each supported scope value to an array of claim names,",
        "         * in order to specify which claims need to be processed for the requested scopes.",
        "         * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#ScopeClaims} for details.",
        "         * @param {string[]} [params.profile] - An array of claim names to be returned if the profile scope is requested.",
        "         * @param {string[]} [params.email] - An array of claim names to be returned if the email scope is requested.",
        "         * @param {string[]} [params.address] - An array of claim names to be returned if the address scope is requested.",
        "         * @param {string[]} [params.phone] - An array of claim names to be returned if the phone scope is requested.",
        "         * @returns {undefined}",
        "         */",
        "        function setScopeClaimsMap(params) {",
        "            scopeClaimsMap = params;",
        "        }",
        "",
        "        /**",
        "         * A (public) method that accepts an object that maps the supported claim names",
        "         * and the resolver functions returning the claim value,",
        "         * and assigns it to a (private) variable that serves as a configuration option.",
        "         * @param {object} params - An object that maps",
        "         * each supported claim name to a function that computes and returns the claim value.",
        "         */",
        "        function setClaimResolvers(params) {",
        "            claimResolvers = params;",
        "        }",
        "",
        "        // CLAIM RESOLVERS",
        "",
        "        /**",
        "         * Claim resolvers are functions that return a claim value.",
        "         * @param {*}",
        "         * @returns {*}",
        "         */",
        "",
        "        /**",
        "         * Defines a claim resolver based on a user profile attribute.",
        "         * @param {string} attributeName - Name of the user profile attribute.",
        "         * @returns {function} A function that will determine the claim value",
        "         * based on the user profile attribute and the (requested) claim properties.",
        "         */",
        "        function getUserProfileClaimResolver (attributeName) {",
        "            /**",
        "             * Resolves a claim with a user profile attribute value.",
        "             * Returns undefined if the identity attribute is not populated,",
        "             * OR if the claim has requested values that do not contain the identity attribute value.",
        "             * ATTENTION: the aforementioned comparison is case-sensitive.",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {string|HashSet|undefined}",
        "             */",
        "            function resolveClaim(claim) {",
        "                var userProfileValue;",
        "",
        "                if (identity) {",
        "                    userProfileValue = getClaimValueFromSet(claim, identity.getAttribute(attributeName));",
        "",
        "                    if (userProfileValue && !userProfileValue.isEmpty()) {",
        "                        if (!claim.getValues() || claim.getValues().isEmpty() || claim.getValues().contains(userProfileValue)) {",
        "                            return userProfileValue;",
        "                        }",
        "                    }",
        "                }",
        "            }",
        "",
        "            return resolveClaim;",
        "        }",
        "",
        "        /**",
        "         * Returns an address claim resolver based on a claim value obtained with another claim resolver.",
        "         * @param {function} resolveClaim - A function that returns a claim value.",
        "         * @returns {function} A function that will accept a claim as an argument,",
        "         * run the claim resolver function for the claim and obtain the claim value,",
        "         * and apply additional formatting to the value before returning it.",
        "         */",
        "        function getAddressClaimResolver (resolveClaim) {",
        "            /**",
        "             * Creates an address claim object from a value returned by a claim resolver,",
        "             * and returns the address claim object as the claim value.",
        "             * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#AddressClaim}.",
        "             * The claim value is obtained with a claim resolving function available from the closure.",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {java.util.LinkedHashMap|undefined} The address claim object created from a claim value.",
        "             */",
        "            function resolveAddressClaim(claim) {",
        "                var claimValue = resolveClaim(claim);",
        "                var addressObject;",
        "",
        "                if (isClaimValueValid(claimValue)) {",
        "                    addressObject = new frJava.LinkedHashMap();",
        "",
        "                    addressObject.put('formatted', claimValue);",
        "",
        "                    return addressObject;",
        "                }",
        "            }",
        "",
        "            return resolveAddressClaim;",
        "        }",
        "",
        "        /**",
        "         * Returns an essential claim resolver based on a claim value obtained with another claim resolver.",
        "         * @param {function} resolveClaim - A function that returns a claim value.",
        "         * @returns {function} A function that will accept a claim as an argument,",
        "         * run the claim resolver function for the claim and obtain the claim value,",
        "         * and apply additional logic for essential claims.",
        "         */",
        "        function getEssentialClaimResolver (resolveClaim) {",
        "            /**",
        "             * Returns a claim value or throws an error.",
        "             * The claim value is obtained with a claim resolving function available from the closure.",
        "             * Throws an exception if the claim is essential and no value is returned for the claim.",
        "             *",
        "             * Use of this resolver is optional.",
        "             * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#IndividualClaimsRequests} stating:",
        "             * "Note that even if the Claims are not available because the End-User did not authorize their release or they are not present,",
        "             * the Authorization Server MUST NOT generate an error when Claims are not returned, whether they are Essential or Voluntary,",
        "             * unless otherwise specified in the description of the specific claim."",
        "             *",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {*}",
        "             * @throws {org.forgerock.oauth2.core.exceptions.InvalidRequestException}",
        "             */",
        "            function resolveEssentialClaim(claim) {",
        "                var claimValue = resolveClaim(claim);",
        "",
        "                if (claim.isEssential() && !isClaimValueValid(claimValue)) {",
        "                    throw new frJava.InvalidRequestException('Could not provide value for essential claim: ' + claim.getName());",
        "                }",
        "",
        "                return claimValue;",
        "            }",
        "",
        "            return resolveEssentialClaim;",
        "        }",
        "",
        "        /**",
        "         * Provides default resolution for a claim.",
        "         * Use it if a claim-specific resolver is not defined in the configuration.",
        "         * @param {org.forgerock.openidconnect.Claim} claim",
        "         * An object that provides methods to obtain information/requirements associated with a claim.",
        "         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "         * @returns {*} A single value associated with this claim.",
        "         */",
        "        function resolveAnyClaim (claim) {",
        "            if (claim.getValues().size() === 1) {",
        "                return claim.getValues().toArray()[0];",
        "            }",
        "        }",
        "",
        "        // UTILITIES",
        "",
        "        /**",
        "         * Returns claim value from a set.",
        "         * If the set contains a single value, returns the value.",
        "         * If the set contains multiple values, returns the set.",
        "         * Otherwise, returns undefined.",
        "         *",
        "         * @param {org.forgerock.openidconnect.Claim} claim",
        "         * An object that provides methods to obtain information/requirements associated with a claim.",
        "         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "         * @param {java.util.HashSet} set The set—for example, a user profile attribute value.",
        "         * @returns {string|java.util.HashSet|undefined}",
        "         */",
        "        function getClaimValueFromSet (claim, set) {",
        "            if (set && set.size()) {",
        "                if (set.size() === 1) {",
        "                    return set.toArray()[0];",
        "                } else {",
        "                    return set;",
        "                }",
        "            } else if (logger.warningEnabled()) {",
        "                logger.warning('OIDC Claims script. Got an empty set for claim: ' + claim.getName());",
        "            }",
        "        }",
        "",
        "        function isClaimValueValid (claimValue) {",
        "            if (typeof claimValue === 'undefined' || claimValue === null) {",
        "                return false;",
        "            }",
        "",
        "            return true;",
        "        }",
        "",
        "        // CLAIM PROCESSING",
        "",
        "        /**",
        "         * Constructs and returns an object populated with the computed claim values",
        "         * and the requested scopes mapped to the claim names.",
        "         * @returns {org.forgerock.oauth2.core.UserInfoClaims} The object to be returned to the authorization server.",
        "         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html}.",
        "         * @see RESULTS section for the use of this function.",
        "         */",
        "        function getUserInfoClaims () {",
        "            return new frJava.UserInfoClaims(getComputedClaims(), getCompositeScopes());",
        "        }",
        "",
        "        /**",
        "         * Creates a map of (requested) claim names populated with the computed claim values.",
        "         * @returns {java.util.LinkedHashMap}",
        "         * A map of the requested claim names and the corresponding claim values.",
        "         */",
        "        function getComputedClaims () {",
        "            /**",
        "             * Creates a complete list of claim objects from:",
        "             * the claims derived from the scopes,",
        "             * the claims provided by the authorization server,",
        "             * and the claims requested by the client.",
        "             * @returns {java.util.ArrayList}",
        "             * Returns a complete list of org.forgerock.openidconnect.Claim objects available to the script.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for the claim object details.",
        "             */",
        "            function getClaims() {",
        "                /**",
        "                 * Returns a list of claim objects for the requested scopes.",
        "                 * Uses the scopeClaimsMap configuration option to derive the claim names;",
        "                 * no other properties of a claim derived from a scope are populated.",
        "                 * @returns {java.util.ArrayList}",
        "                 * A list of org.forgerock.openidconnect.Claim objects derived from the requested scopes.",
        "                 * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for the claim object details.",
        "                 */",
        "                function convertScopeToClaims() {",
        "                    var claims = new frJava.ArrayList();",
        "",
        "                    scopes.toArray().forEach(function (scope) {",
        "                        if (String(scope) !== 'openid' && scopeClaimsMap[scope]) {",
        "                            scopeClaimsMap[scope].forEach(function (claimName) {",
        "                                claims.add(new frJava.Claim(claimName));",
        "                            });",
        "                        }",
        "                    });",
        "",
        "                    return claims;",
        "                }",
        "",
        "                var claims = new frJava.ArrayList();",
        "",
        "                claims.addAll(convertScopeToClaims());",
        "                claims.addAll(claimObjects);",
        "                claims.addAll(requestedTypedClaims);",
        "",
        "                return claims;",
        "            }",
        "",
        "            /**",
        "             * Computes and returns a claim value.",
        "             * To obtain the claim value, uses the resolver function specified for the claim in the claimResolvers configuration object.",
        "             * @see claimResolvers",
        "             * If no resolver function is found, uses the default claim resolver function.",
        "             *",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {*} Claim value.",
        "             * @throws {org.forgerock.oauth2.core.exceptions.InvalidRequestException}",
        "             * Rethrows this exception if a claim resolver throws it.",
        "             * You can throw org.forgerock.oauth2.core.exceptions.InvalidRequestException from your custom claim resolver",
        "             * if you want to terminate the claim processing.",
        "             */",
        "            function computeClaim(claim) {",
        "                var resolveClaim;",
        "                var message;",
        "",
        "                try {",
        "                    resolveClaim = claimResolvers[claim.getName()] || resolveAnyClaim;",
        "",
        "                    return resolveClaim(claim);",
        "                } catch (e) {",
        "                    message = 'OIDC Claims script exception. Unable to resolve OIDC Claim. ' + e;",
        "",
        "                    if (String(e).indexOf('org.forgerock.oauth2.core.exceptions.InvalidRequestException') !== -1) {",
        "                        throw e;",
        "                    }",
        "",
        "                    if (logger.warningEnabled()) {",
        "                        logger.warning(message);",
        "                    }",
        "                }",
        "            }",
        "",
        "            var computedClaims = new frJava.LinkedHashMap();",
        "",
        "            getClaims().toArray().forEach(function (claim) {",
        "                var claimValue = computeClaim(claim);",
        "",
        "                if (isClaimValueValid(claimValue)) {",
        "                    computedClaims.put(claim.getName(), claimValue);",
        "                } else {",
        "                    /**",
        "                     * If a claim has been processed, but appears in the list again,",
        "                     * and its value cannot be computed under the new conditions,",
        "                     * the claim is removed from the final result.",
        "                     *",
        "                     * For example, a claim could be mapped to a scope and found in the user profile,",
        "                     * but also requested by the client with required values that don't match the computed one.",
        "                     * @see {link https://openid.net/specs/openid-connect-core-1_0.html#IndividualClaimsRequests}.",
        "                     * for the relevant OIDC specification details.",
        "                     */",
        "                    computedClaims.remove(claim.getName());",
        "                }",
        "            });",
        "",
        "            return computedClaims;",
        "        }",
        "",
        "        /**",
        "         * Creates a map of requested scopes and the corresponding claim names.",
        "         * @returns {java.util.LinkedHashMap}",
        "         */",
        "        function getCompositeScopes () {",
        "            var compositeScopes = new frJava.LinkedHashMap();",
        "",
        "            scopes.toArray().forEach(function (scope) {",
        "                var scopeClaims = new frJava.ArrayList();",
        "",
        "                if (scopeClaimsMap[scope]) {",
        "                    scopeClaimsMap[scope].forEach(function (claimName) {",
        "                        scopeClaims.add(claimName);",
        "                    });",
        "                }",
        "",
        "                if (scopeClaims.size()) {",
        "                    compositeScopes.put(scope, scopeClaims);",
        "                }",
        "            });",
        "",
        "            return compositeScopes;",
        "        }",
        "",
        "        // PUBLIC METHODS",
        "",
        "        return {",
        "            setScopeClaimsMap: setScopeClaimsMap,",
        "            setClaimResolvers: setClaimResolvers,",
        "            getUserProfileClaimResolver: getUserProfileClaimResolver,",
        "            getAddressClaimResolver: getAddressClaimResolver,",
        "            getEssentialClaimResolver: getEssentialClaimResolver,",
        "            getUserInfoClaims: getUserInfoClaims",
        "        };",
        "    }",
        "",
        "    // RESULTS",
        "",
        "    /**",
        "     * This script returns an instance of the org.forgerock.oauth2.core.UserInfoClaims class",
        "     * populated with the computed claim values and",
        "     * the requested scopes mapped to the claim names.",
        "     * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html}.",
        "     *",
        "     * Assigning it to a variable gives you an opportunity",
        "     * to log the content of the returned value during development.",
        "     */",
        "    var userInfoClaims = utils.getUserInfoClaims();",
        "",
        "    /*",
        "    logger.error(scriptName + ' results:')",
        "    logger.error('Values: ' + userInfoClaims.getValues())",
        "    logger.error('Scopes: ' + userInfoClaims.getCompositeScopes())",
        "    */",
        "",
        "    return userInfoClaims;",
        "}());",
      ],
    },
    "cfb208d8-241c-4953-b87b-bf59d1ab3d05": {
      "_id": "cfb208d8-241c-4953-b87b-bf59d1ab3d05",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_EnableEmailClaimCheck",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "nodeState.putShared('checkEmailClaim', true);",
        "",
        "outcome = 'True';",
      ],
    },
    "d22f9a0c-426a-4466-b95e-d0f125b0d5fa": {
      "_id": "d22f9a0c-426a-4466-b95e-d0f125b0d5fa",
      "context": "OAUTH2_ACCESS_TOKEN_MODIFICATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Default global script for OAuth2 Access Token Modification",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "OAuth2 Access Token Modification Script",
      "script": [
        "/*",
        " * Copyright 2019-2021 ForgeRock AS. All Rights Reserved.",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        " * This script lets you modify information associated with an OAuth2 access token",
        " * with methods provided by the AccessToken (1) interface.",
        " * The changes made to OAuth2 access tokens will directly impact the size of the CTS tokens,",
        " * and, similarly, the size of the JWTs if client-based OAuth2 tokens are utilized.",
        " * When adding/updating fields make sure that the token size remains within client/user-agent limits.",
        " *",
        " * Defined variables:",
        " * accessToken - AccessToken (1).",
        " *               The access token to be updated.",
        " *               Mutable object, all changes to the access token will be reflected.",
        " * scopes - Set<String> (6).",
        " *          Always present, the requested scopes.",
        " * requestProperties - Unmodifiable Map (5).",
        " *                     Always present, contains a map of request properties:",
        " *                     requestUri - The request URI.",
        " *                     realm - The realm that the request relates to.",
        " *                     requestParams - A map of the request params and/or posted data.",
        " *                                     Each value is a list of one or more properties.",
        " *                                     Please note that these should be handled in accordance with OWASP best practices:",
        " *                                     https://owasp.org/www-community/vulnerabilities/Unsafe_use_of_Reflection.",
        " * clientProperties - Unmodifiable Map (5).",
        " *                    Present if the client specified in the request was identified, contains a map of client properties:",
        " *                    clientId - The client's URI for the request locale.",
        " *                    allowedGrantTypes - List of the allowed grant types (org.forgerock.oauth2.core.GrantType) for the client.",
        " *                    allowedResponseTypes - List of the allowed response types for the client.",
        " *                    allowedScopes - List of the allowed scopes for the client.",
        " *                    customProperties - A map of the custom properties of the client.",
        " *                                       Lists or maps will be included as sub-maps; for example:",
        " *                                       customMap[Key1]=Value1 will be returned as customMap -> Key1 -> Value1.",
        " *                                       To add custom properties to a client, update the Custom Properties field",
        " *                                       in AM Console > Realm Name > Applications > OAuth 2.0 > Clients > Client ID > Advanced.",
        " * identity - AMIdentity (3).",
        " *            Always present, the identity of the resource owner.",
        " * session - SSOToken (4).",
        " *           Present if the request contains the session cookie, the user's session object.",
        " * scriptName - String (primitive).",
        " *              Always present, the display name of the script.",
        " * logger - Always present, the "OAuth2Provider" debug logger instance:",
        " *          https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.",
        " *          Corresponding log files will be prefixed with: scripts.OAUTH2_ACCESS_TOKEN_MODIFICATION.",
        " * httpClient - HTTP Client (8).",
        " *              Always present, the HTTP Client instance:",
        " *              https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-http-client.html#scripting-api-global-http-client.",
        " *",
        " * Return - no value is expected, changes shall be made to the accessToken parameter directly.",
        " *",
        " * Class reference:",
        " * (1) AccessToken - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/AccessToken.html.",
        " * (3) AMIdentity - https://backstage.forgerock.com/docs/am/7/apidocs/com/sun/identity/idm/AMIdentity.html.",
        " * (4) SSOToken - https://backstage.forgerock.com/docs/am/7/apidocs/com/iplanet/sso/SSOToken.html.",
        " * (5) Map - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashMap.html,",
        " *           or https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/LinkedHashMap.html.",
        " * (6) Set - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashSet.html.",
        " * (8) Client - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/http/Client.html.",
        " */",
        "",
        "(function () {",
        "  // Adds new fields containing the session property values.",
        "  // NOTE: session may not be available for non-interactive authorization grants.",
        "  if (session) {",
        "    try {",
        "      accessToken.setField('ip_address', session.getProperty('Host'));",
        "    } catch (e) {",
        "      logger.error('Unable to retrieve session property value. ' + e);",
        "    }",
        "  }",
        "}());",
        "",
        "/* EXAMPLE",
        "(function () {",
        "    var frJava = JavaImporter(",
        "        org.forgerock.http.protocol.Request,",
        "        org.forgerock.http.protocol.Response",
        "    );",
        "",
        "    // Always includes this field in the token.",
        "    accessToken.setField('key1', 'value1');",
        "",
        "    // Receives and adds to the access token additional values by performing a REST call to an external service.",
        "    // WARNING: Below, you will find a reference to a third-party site, which is provided only as an example.",
        "    var uri = 'https://jsonplaceholder.typicode.com/posts';",
        "",
        "    try {",
        "        var request = new frJava.Request();",
        "",
        "        // You can chain methods that return the request object.",
        "        request.setUri(uri)",
        "            .setMethod('POST')",
        "            .setEntity(JSON.stringify({",
        "                updatedFields: {",
        "                    key2: 'value2',",
        "                    key3: 'value3'",
        "                }",
        "            }));",
        "",
        "        // You can call a method when chaining is not possible.",
        "        request.getHeaders().add('Content-Type', 'application/json; charset=UTF-8');",
        "",
        "        // Sends the request and receives the response.",
        "        var response = httpClient.send(request).getOrThrow();",
        "",
        "        // Checks if the response status is as expected.",
        "        if (response.getStatus() === org.forgerock.http.protocol.Status.CREATED) {",
        "            var result = JSON.parse(response.getEntity().getString());",
        "",
        "            // Set multiple token fields at once.",
        "            accessToken.setFields(result.updatedFields);",
        "        } else {",
        "            logger.error('Unable to obtain access token modifications. Status: ' + response.getStatus() + '. Content: ' + response.getEntity().getString());",
        "        }",
        "    } catch (e) {",
        "        logger.error('The request processing was interrupted. ' + e);",
        "",
        "        // The access token request fails with the HTTP 500 error in this case.",
        "        throw ('Unable to obtain response from: ' + uri);",
        "    }",
        "",
        "    // Adds new fields containing identity attribute values to the access token.",
        "    accessToken.setField('mail', identity.getAttribute('mail'));",
        "    accessToken.setField('phone', identity.getAttribute('telephoneNumber').toArray()[0]);",
        "",
        "    // Adds new fields containing the session property values.",
        "    // NOTE: session may not be available for non-interactive authorization grants.",
        "    if (session) {",
        "        try {",
        "            accessToken.setField('ipAddress', session.getProperty('Host'));",
        "        } catch (e) {",
        "            logger.error('Unable to retrieve session property value. ' + e);",
        "        }",
        "    }",
        "",
        "    // Removes a native field from the token entry, that was set by AM.",
        "    // WARNING: removing native fields from the token may result in loss of functionality.",
        "    // accessToken.removeTokenName()",
        "",
        "    // No return value is expected. Let it be undefined.",
        "}());",
        "*/",
      ],
    },
    "d25a1315-8beb-4a0c-84bf-534214fed087": {
      "_id": "d25a1315-8beb-4a0c-84bf-534214fed087",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Prepare Reset Of OTP Profile Attribute",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "MobileOTP: Prepare Reset Of OTP Profile Attribute",
      "script": [
        "/*",
        " * Reset OTP profile attribute in ObjectAttributes so it can be patched to the user profile.",
        " */",
        "outcome = "true";",
        "",
        "setSharedObjectAttribute("fr-attr-int5", "0");",
        "",
        "/*",
        " * Store attributes in shared state for use with the Create/Patch Object nodes.",
        " */",
        "function setSharedObjectAttribute(name, value) {",
        "      var storage = sharedState.get("objectAttributes");",
        "    if (storage && value) {",
        "          if (storage.put) {",
        "              storage.put(name, value);",
        "        }",
        "          else {",
        "              storage[name] = value;",
        "        }",
        "    }",
        "    else if (value) {",
        "        sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "    }",
        "}",
      ],
    },
    "d2a41d85-d33a-42d9-a7dd-50dfbc9fa7c0": {
      "_id": "d2a41d85-d33a-42d9-a7dd-50dfbc9fa7c0",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Check Applicant",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Onfido-CheckApplicant",
      "script": [
        "logger.error("Onfido-CheckApplicant: Start");",
        "",
        "/*",
        " * !!! Extend your authentication session time so your identity proofing flows don't time out !!!",
        " *",
        " * Authentication > Settings > Trees > Max Duration (Minutes)",
        " *",
        " * Set to 15 minutes.",
        " *",
        " */",
        "",
        "/*",
        " * BEGIN SCRIPT CONFIGURATION",
        " *",
        " * REPLACE WITH YOUR OWN ONFIDO API TOKEN",
        " */",
        "//var ONFIDO_API_TOKEN = "api_live.StUdfxdiCFb.YrzbadxB_R2-qG5lFUc3lWg6JAc3Cnq-"",
        "var ONFIDO_API_TOKEN = "api_live.H5ysRusAomY.nbbkimoWc91cDZAWJZkJt0Tkqdjm1Rjr";",
        "/*",
        " * END SCRIPT CONFIGURATION",
        " */",
        "",
        "var requestBodyJson = {",
        "    "applicant_id": String(sharedState.get("onfidoApplicantID")),",
        "    "report_names": ["document", "facial_similarity_photo"]",
        "}",
        "// var requestBodyJson = {",
        "//     "applicant_id": String(sharedState.get("onfidoApplicantID")),",
        "//     "report_names": ["document"]",
        "// }",
        "",
        "var failure = true",
        "",
        "var fr = JavaImporter(",
        "    org.forgerock.http.protocol.Request",
        ")",
        "",
        "var request = new fr.Request()",
        "request.setUri("https://api.onfido.com/v3/checks")",
        "request.setMethod("POST")",
        "request.getHeaders().add("Content-Type", "application/json; charset=UTF-8")",
        "request.getHeaders().add("Authorization", "Token token=" + ONFIDO_API_TOKEN)",
        "request.getEntity().setString(JSON.stringify(requestBodyJson))",
        "",
        "var response = httpClient.send(request).get()",
        "logger.error("Onfido-CheckApplicant: Initiate checks response: ".concat(response.getEntity().getString()));",
        "",
        "if (response.getStatus().getCode() === 200) {",
        "    var id = JSON.parse(response.getEntity().getString()).id",
        "    failure = !id",
        "    if (!failure) sharedState.put("onfidoAuthToken", id);",
        "} else {",
        "    failure = true",
        "}",
        "",
        "outcome = failure ? "false" : "true";",
        "logger.error("Onfido-CheckApplicant: End (outcome=".concat(outcome).concat(")"));",
      ],
    },
    "d2cf4f18-651a-4a3c-9b04-ee4fc896d0c3": {
      "_id": "d2cf4f18-651a-4a3c-9b04-ee4fc896d0c3",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Social Identity Provider Profile Transformation for ForgeRock OIDC Providers",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "ST_healthcare-idc-social-transformation",
      "script": [
        "/*",
        " * Copyright 2022 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock. Not for production use.",
        " * Modified by Stephen Payne",
        " */",
        "/* Social Identity Provider Profile Transformation script for Healthcare ID Cloud */",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "logger.error("ST_healthcare-idc-social-transformation Healthcare ID Cloud Identity Provider Profile Transformation script: Start");",
        "",
        "logger.error("ST_healthcare-idc-social-transformation Profile Transformation script: Start");",
        "logger.error("ST_healthcare-idc-social-transformationy: givenName " + rawProfile.givenName);",
        "logger.error("ST_healthcare-idc-social-transformation: sn: " +rawProfile.familyName);",
        "logger.error("ST_healthcare-idc-social-transformation: id: " +rawProfile.id);",
        "logger.error("ST_healthcare-idc-social-transformation: mail: " + rawProfile.email);",
        "logger.error("ST_healthcare-idc-social-transformation: cn: " + rawProfile.displayName);",
        "logger.error("ST_healthcare-idc-social-transformation: userName: " + rawProfile.username);",
        "logger.error("ST_healthcare-idc-social-transformation: id: " + rawProfile.id.asString());",
        "//logger.error("ST_healthcare-idc-social-transformation: iplanet-am-user-alias-list: " + selectedIdp + '-' + rawProfile.id.asString() );",
        "//logger.error("ST_healthcare-idc-social-transformation: selectedIdp: " + selectedIdp);",
        "if (rawProfile.fhirUser.isNotNull()) logger.error("ST_healthcare-idc-social-transformation: fhirUser: " + rawProfile.fhirUser);",
        "if (rawProfile.IAL.isNotNull()) logger.error("ST_healthcare-idc-social-transformatio: IAL: " + rawProfile.IAL);",
        "",
        "",
        "",
        "",
        "return json(object(",
        "        field("id", rawProfile.sub),",
        "        field("displayName", rawProfile.name),",
        "        field("givenName", rawProfile.given_name),",
        "        field("familyName", rawProfile.family_name),",
        "        field("email", rawProfile.email),",
        "        field("username", rawProfile.email),",
        "        field("IAL", rawProfile.IAL),  ",
        "        field("telephoneNumber", rawProfile.phone_number),",
        "        field("fhirUser", rawProfile.fhirUser),",
        "        field("userType", rawProfile.userType),",
        "        )",
        ")",
      ],
    },
    "d3405f9c-d338-4dc2-b00d-7aacf77b731d": {
      "_id": "d3405f9c-d338-4dc2-b00d-7aacf77b731d",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Return the generated OTP using a TextOutputCallback",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Return OTP",
      "script": [
        "/* Return OTP",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Return the generated OTP using a TextOutputCallback.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "outcome = "true";",
        "var fr = JavaImporter(",
        "    org.forgerock.openam.auth.node.api.Action,",
        "    javax.security.auth.callback.TextOutputCallback",
        ")",
        "if (callbacks.isEmpty()) {",
        "    action = fr.Action.send(",
        "        new fr.TextOutputCallback(",
        "            fr.TextOutputCallback.INFORMATION,",
        "            nodeState.get("oneTimePassword").asString()",
        "        )",
        "    ).build()",
        "}",
        "else {",
        "  action = fr.Action.goTo(outcome).build();",
        "}",
      ],
    },
    "d6469639-249f-4df1-9e03-335cd3e37b3d": {
      "_id": "d6469639-249f-4df1-9e03-335cd3e37b3d",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Get Email",
      "script": [
        "logger.error("Get Email: start");",
        "outcome = "true";",
        "if (getProfileAttribute("mail")) {",
        "  setSharedObjectAttribute("mail", getProfileAttribute("mail"));",
        "}",
        "logger.error("Get Email: end");",
        "",
        "/*",
        " * Get profile attribute",
        " */",
        "function getProfileAttribute(name) {",
        "    return idRepository.getAttribute(sharedState.get("_id"), name).iterator().next();",
        "}",
        "",
        "/*",
        " * Properly set attributes in shared state for use with the Create/Patch Object nodes.",
        " */",
        "function setSharedObjectAttribute(name, value) {",
        "    if (sharedState.get("objectAttributes")) {",
        "        sharedState.get("objectAttributes").put(name, value);",
        "    }",
        "    else {",
        "        sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":"+value+"}"));",
        "    }",
        "}",
      ],
    },
    "d6f3befb-c73a-437e-b02a-66d9b4c93f8b": {
      "_id": "d6f3befb-c73a-437e-b02a-66d9b4c93f8b",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Extract impersonatee and impersonator from headers and become impersonator.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Impersonate: Extract Actors And Become Impersonator",
      "script": [
        "/* Impersonate: Extract Actors And Become Impersonator",
        " *",
        " * Extract impersonatee and impersonator from headers and become impersonatee.",
        " *",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * - false",
        " */",
        "",
        "(function () {",
        "    logger.warning("Impersonate: Extract Actors: start");",
        "    outcome = "false";",
        "",
        "    /*",
        "     * BEGIN SCRIPT CONFIGURATION",
        "     */",
        "    var IMPERSONATEE_HEADER_NAME = "X-Impersonatee";",
        "    var IMPERSONATOR_HEADER_NAME = "X-Impersonator";",
        "    /*",
        "     * END SCRIPT CONFIGURATION",
        "     */",
        "",
        "    var impersonatee = getHeader(IMPERSONATEE_HEADER_NAME);",
        "    var impersonator = getHeader(IMPERSONATOR_HEADER_NAME);",
        "    if (impersonatee && impersonator) {",
        "        outcome = "true";",
        "        sharedState.put("impersonatee", impersonatee);",
        "        sharedState.put("impersonator", impersonator);",
        "        sharedState.put("username", impersonator);",
        "        setSharedObjectAttribute("userName", impersonator);",
        "    }",
        "",
        "    logger.warning("Impersonate: Extract Actors: finish [outcome=".concat(outcome).concat("]"));",
        "",
        "    /*",
        "     * Returns the value of the requested header",
        "     */",
        "    function getHeader(headerName) {",
        "        if (requestHeaders.get(headerName) && requestHeaders.get(headerName).get(0)) {",
        "            return requestHeaders.get(headerName).get(0).toString();",
        "        }",
        "        return null;",
        "    }",
        "",
        "    /*",
        "     * Store attributes in shared state for use with the Create/Patch Object nodes.",
        "     */",
        "    function setSharedObjectAttribute(name, value) {",
        "         var storage = sharedState.get("objectAttributes");",
        "        if (storage && value) {",
        "            if (storage.put) {",
        "                  storage.put(name, value);",
        "            }",
        "            else {",
        "                storage[name] = value;",
        "            }",
        "        }",
        "        else if (value) {",
        "            sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "        }",
        "    }",
        "}());",
      ],
    },
    "d70df7a8-6390-409d-b821-166272a9a9c8": {
      "_id": "d70df7a8-6390-409d-b821-166272a9a9c8",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Collect all the configuration items required for the Inner Tree Evaluator to function properly.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Collect Inner Tree Evaluator Config",
      "script": [
        "/* Collect Inner Tree Evaluator Config",
        " * ",
        " * Collect all the configuration items required for the Inner Tree Evaluator to function properly.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    outcome = "true";",
        "      var config = {",
        "        "tree": "Login",",
        "    };",
        "      var script = "";",
        "    script += "Array.prototype.slice.call(";",
        "    script += "    document.getElementsByTagName('input')";",
        "    script += ").forEach(";",
        "    script += "    function (input,i) {";",
        "    script += "        console.log('input '+i);"",
        "    script += "        var config = JSON.parse('"+JSON.stringify(config)+"');";",
        "    script += "        var keys = Object.keys(config);";",
        "    script += "        if (input.type === 'text') {";",
        "    script += "            input.setAttribute('value', config[keys[i]]);";",
        "    script += "            input.dispatchEvent(new KeyboardEvent( 'input' , {'key':'Enter'} ));";",
        "    script += "        }";",
        "    script += "    }";",
        "    script += ");";",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "          javax.security.auth.callback.NameCallback,",
        "        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        "    )",
        "    if (callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "            new fr.NameCallback("tree", config.tree),",
        "              new fr.ScriptTextOutputCallback(script)",
        "        ).build();",
        "    }",
        "    else {",
        "          config[callbacks.get(0).getPrompt()] = callbacks.get(0).getName();",
        "          nodeState.putShared("nodeConfig", config);",
        "        action = fr.Action.goTo(outcome).build();",
        "    }",
        "}());",
      ],
    },
    "d82a4ad6-cd8a-437b-af55-7373e50d685b": {
      "_id": "d82a4ad6-cd8a-437b-af55-7373e50d685b",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Collect Replay Password (frUnindexedString2).",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Collect Replay Password (frUnindexedString2)",
      "script": [
        "/* Collect And Encrypt Custom Password",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " * ",
        " * See copyright notices, conditions, and disclaimers at the bottom of this script.",
        " * ",
        " * volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    "use strict";var sjcl={cipher:{},hash:{},keyexchange:{},mode:{},misc:{},codec:{},exception:{corrupt:function(message){this.toString=function(){return"CORRUPT: "+this.message};this.message=message},invalid:function(message){this.toString=function(){return"INVALID: "+this.message};this.message=message},bug:function(message){this.toString=function(){return"BUG: "+this.message};this.message=message},notReady:function(message){this.toString=function(){return"NOT READY: "+this.message};this.message=message}}};sjcl.cipher.aes=function(key){if(!this._tables[0][0][0]){this._precompute()}var i,j,tmp,encKey,decKey,sbox=this._tables[0][4],decTable=this._tables[1],keyLen=key.length,rcon=1;if(keyLen!==4&&keyLen!==6&&keyLen!==8){throw new sjcl.exception.invalid("invalid aes key size")}this._key=[encKey=key.slice(0),decKey=[]];for(i=keyLen;i<4*keyLen+28;i++){tmp=encKey[i-1];if(i%keyLen===0||keyLen===8&&i%keyLen===4){tmp=sbox[tmp>>>24]<<24^sbox[tmp>>16&255]<<16^sbox[tmp>>8&255]<<8^sbox[tmp&255];if(i%keyLen===0){tmp=tmp<<8^tmp>>>24^rcon<<24;rcon=rcon<<1^(rcon>>7)*283}}encKey[i]=encKey[i-keyLen]^tmp}for(j=0;i;j++,i--){tmp=encKey[j&3?i:i-4];if(i<=4||j<4){decKey[j]=tmp}else{decKey[j]=decTable[0][sbox[tmp>>>24]]^decTable[1][sbox[tmp>>16&255]]^decTable[2][sbox[tmp>>8&255]]^decTable[3][sbox[tmp&255]]}}};sjcl.cipher.aes.prototype={encrypt:function(data){return this._crypt(data,0)},decrypt:function(data){return this._crypt(data,1)},_tables:[[[],[],[],[],[]],[[],[],[],[],[]]],_precompute:function(){var encTable=this._tables[0],decTable=this._tables[1],sbox=encTable[4],sboxInv=decTable[4],i,x,xInv,d=[],th=[],x2,x4,x8,s,tEnc,tDec;for(i=0;i<256;i++){th[(d[i]=i<<1^(i>>7)*283)^i]=i}for(x=xInv=0;!sbox[x];x^=x2||1,xInv=th[xInv]||1){s=xInv^xInv<<1^xInv<<2^xInv<<3^xInv<<4;s=s>>8^s&255^99;sbox[x]=s;sboxInv[s]=x;x8=d[x4=d[x2=d[x]]];tDec=x8*16843009^x4*65537^x2*257^x*16843008;tEnc=d[s]*257^s*16843008;for(i=0;i<4;i++){encTable[i][x]=tEnc=tEnc<<24^tEnc>>>8;decTable[i][s]=tDec=tDec<<24^tDec>>>8}}for(i=0;i<5;i++){encTable[i]=encTable[i].slice(0);decTable[i]=decTable[i].slice(0)}},_crypt:function(input,dir){if(input.length!==4){throw new sjcl.exception.invalid("invalid aes block size")}var key=this._key[dir],a=input[0]^key[0],b=input[dir?3:1]^key[1],c=input[2]^key[2],d=input[dir?1:3]^key[3],a2,b2,c2,nInnerRounds=key.length/4-2,i,kIndex=4,out=[0,0,0,0],table=this._tables[dir],t0=table[0],t1=table[1],t2=table[2],t3=table[3],sbox=table[4];for(i=0;i<nInnerRounds;i++){a2=t0[a>>>24]^t1[b>>16&255]^t2[c>>8&255]^t3[d&255]^key[kIndex];b2=t0[b>>>24]^t1[c>>16&255]^t2[d>>8&255]^t3[a&255]^key[kIndex+1];c2=t0[c>>>24]^t1[d>>16&255]^t2[a>>8&255]^t3[b&255]^key[kIndex+2];d=t0[d>>>24]^t1[a>>16&255]^t2[b>>8&255]^t3[c&255]^key[kIndex+3];kIndex+=4;a=a2;b=b2;c=c2}for(i=0;i<4;i++){out[dir?3&-i:i]=sbox[a>>>24]<<24^sbox[b>>16&255]<<16^sbox[c>>8&255]<<8^sbox[d&255]^key[kIndex++];a2=a;a=b;b=c;c=d;d=a2}return out}};sjcl.bitArray={bitSlice:function(a,bstart,bend){a=sjcl.bitArray._shiftRight(a.slice(bstart/32),32-(bstart&31)).slice(1);return bend===undefined?a:sjcl.bitArray.clamp(a,bend-bstart)},extract:function(a,bstart,blength){var x,sh=Math.floor(-bstart-blength&31);if((bstart+blength-1^bstart)&-32){x=a[bstart/32|0]<<32-sh^a[bstart/32+1|0]>>>sh}else{x=a[bstart/32|0]>>>sh}return x&(1<<blength)-1},concat:function(a1,a2){if(a1.length===0||a2.length===0){return a1.concat(a2)}var last=a1[a1.length-1],shift=sjcl.bitArray.getPartial(last);if(shift===32){return a1.concat(a2)}else{return sjcl.bitArray._shiftRight(a2,shift,last|0,a1.slice(0,a1.length-1))}},bitLength:function(a){var l=a.length,x;if(l===0){return 0}x=a[l-1];return(l-1)*32+sjcl.bitArray.getPartial(x)},clamp:function(a,len){if(a.length*32<len){return a}a=a.slice(0,Math.ceil(len/32));var l=a.length;len=len&31;if(l>0&&len){a[l-1]=sjcl.bitArray.partial(len,a[l-1]&2147483648>>len-1,1)}return a},partial:function(len,x,_end){if(len===32){return x}return(_end?x|0:x<<32-len)+len*1099511627776},getPartial:function(x){return Math.round(x/1099511627776)||32},equal:function(a,b){if(sjcl.bitArray.bitLength(a)!==sjcl.bitArray.bitLength(b)){return false}var x=0,i;for(i=0;i<a.length;i++){x|=a[i]^b[i]}return x===0},_shiftRight:function(a,shift,carry,out){var i,last2=0,shift2;if(out===undefined){out=[]}for(;shift>=32;shift-=32){out.push(carry);carry=0}if(shift===0){return out.concat(a)}for(i=0;i<a.length;i++){out.push(carry|a[i]>>>shift);carry=a[i]<<32-shift}last2=a.length?a[a.length-1]:0;shift2=sjcl.bitArray.getPartial(last2);out.push(sjcl.bitArray.partial(shift+shift2&31,shift+shift2>32?carry:out.pop(),1));return out},_xor4:function(x,y){return[x[0]^y[0],x[1]^y[1],x[2]^y[2],x[3]^y[3]]},byteswapM:function(a){var i,v,m=65280;for(i=0;i<a.length;++i){v=a[i];a[i]=v>>>24|v>>>8&m|(v&m)<<8|v<<24}return a}};sjcl.codec.utf8String={fromBits:function(arr){var out="",bl=sjcl.bitArray.bitLength(arr),i,tmp;for(i=0;i<bl/8;i++){if((i&3)===0){tmp=arr[i/4]}out+=String.fromCharCode(tmp>>>8>>>8>>>8);tmp<<=8}return decodeURIComponent(escape(out))},toBits:function(str){str=unescape(encodeURIComponent(str));var out=[],i,tmp=0;for(i=0;i<str.length;i++){tmp=tmp<<8|str.charCodeAt(i);if((i&3)===3){out.push(tmp);tmp=0}}if(i&3){out.push(sjcl.bitArray.partial(8*(i&3),tmp))}return out}};sjcl.codec.base64={_chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",fromBits:function(arr,_noEquals,_url){var out="",i,bits=0,c=sjcl.codec.base64._chars,ta=0,bl=sjcl.bitArray.bitLength(arr);if(_url){c=c.substr(0,62)+"-_"}for(i=0;out.length*6<bl;){out+=c.charAt((ta^arr[i]>>>bits)>>>26);if(bits<6){ta=arr[i]<<6-bits;bits+=26;i++}else{ta<<=6;bits-=6}}while(out.length&3&&!_noEquals){out+="="}return out},toBits:function(str,_url){str=str.replace(/\\s|=/g,"");var out=[],i,bits=0,c=sjcl.codec.base64._chars,ta=0,x;if(_url){c=c.substr(0,62)+"-_"}for(i=0;i<str.length;i++){x=c.indexOf(str.charAt(i));if(x<0){throw new sjcl.exception.invalid("this isn't base64!")}if(bits>26){bits-=26;out.push(ta^x>>>bits);ta=x<<32-bits}else{bits+=6;ta^=x<<32-bits}}if(bits&56){out.push(sjcl.bitArray.partial(bits&56,ta,1))}return out}};sjcl.codec.base64url={fromBits:function(arr){return sjcl.codec.base64.fromBits(arr,1,1)},toBits:function(str){return sjcl.codec.base64.toBits(str,1)}};sjcl.hash.sha256=function(hash){if(!this._key[0]){this._precompute()}if(hash){this._h=hash._h.slice(0);this._buffer=hash._buffer.slice(0);this._length=hash._length}else{this.reset()}};sjcl.hash.sha256.hash=function(data){return(new sjcl.hash.sha256).update(data).finalize()};sjcl.hash.sha256.prototype={blockSize:512,reset:function(){this._h=this._init.slice(0);this._buffer=[];this._length=0;return this},update:function(data){if(typeof data==="string"){data=sjcl.codec.utf8String.toBits(data)}var i,b=this._buffer=sjcl.bitArray.concat(this._buffer,data),ol=this._length,nl=this._length=ol+sjcl.bitArray.bitLength(data);if(nl>9007199254740991){throw new sjcl.exception.invalid("Cannot hash more than 2^53 - 1 bits")}if(typeof Uint32Array!=="undefined"){var c=new Uint32Array(b);var j=0;for(i=512+ol-(512+ol&511);i<=nl;i+=512){this._block(c.subarray(16*j,16*(j+1)));j+=1}b.splice(0,16*j)}else{for(i=512+ol-(512+ol&511);i<=nl;i+=512){this._block(b.splice(0,16))}}return this},finalize:function(){var i,b=this._buffer,h=this._h;b=sjcl.bitArray.concat(b,[sjcl.bitArray.partial(1,1)]);for(i=b.length+2;i&15;i++){b.push(0)}b.push(Math.floor(this._length/4294967296));b.push(this._length|0);while(b.length){this._block(b.splice(0,16))}this.reset();return h},_init:[],_key:[],_precompute:function(){var i=0,prime=2,factor,isPrime;function frac(x){return(x-Math.floor(x))*4294967296|0}for(;i<64;prime++){isPrime=true;for(factor=2;factor*factor<=prime;factor++){if(prime%factor===0){isPrime=false;break}}if(isPrime){if(i<8){this._init[i]=frac(Math.pow(prime,1/2))}this._key[i]=frac(Math.pow(prime,1/3));i++}}},_block:function(w){var i,tmp,a,b,h=this._h,k=this._key,h0=h[0],h1=h[1],h2=h[2],h3=h[3],h4=h[4],h5=h[5],h6=h[6],h7=h[7];for(i=0;i<64;i++){if(i<16){tmp=w[i]}else{a=w[i+1&15];b=w[i+14&15];tmp=w[i&15]=(a>>>7^a>>>18^a>>>3^a<<25^a<<14)+(b>>>17^b>>>19^b>>>10^b<<15^b<<13)+w[i&15]+w[i+9&15]|0}tmp=tmp+h7+(h4>>>6^h4>>>11^h4>>>25^h4<<26^h4<<21^h4<<7)+(h6^h4&(h5^h6))+k[i];h7=h6;h6=h5;h5=h4;h4=h3+tmp|0;h3=h2;h2=h1;h1=h0;h0=tmp+(h1&h2^h3&(h1^h2))+(h1>>>2^h1>>>13^h1>>>22^h1<<30^h1<<19^h1<<10)|0}h[0]=h[0]+h0|0;h[1]=h[1]+h1|0;h[2]=h[2]+h2|0;h[3]=h[3]+h3|0;h[4]=h[4]+h4|0;h[5]=h[5]+h5|0;h[6]=h[6]+h6|0;h[7]=h[7]+h7|0}};sjcl.mode.ccm={name:"ccm",_progressListeners:[],listenProgress:function(cb){sjcl.mode.ccm._progressListeners.push(cb)},unListenProgress:function(cb){var index=sjcl.mode.ccm._progressListeners.indexOf(cb);if(index>-1){sjcl.mode.ccm._progressListeners.splice(index,1)}},_callProgressListener:function(val){var p=sjcl.mode.ccm._progressListeners.slice(),i;for(i=0;i<p.length;i+=1){p[i](val)}},encrypt:function(prf,plaintext,iv,adata,tlen){var L,out=plaintext.slice(0),tag,w=sjcl.bitArray,ivl=w.bitLength(iv)/8,ol=w.bitLength(out)/8;tlen=tlen||64;adata=adata||[];if(ivl<7){throw new sjcl.exception.invalid("ccm: iv must be at least 7 bytes")}for(L=2;L<4&&ol>>>8*L;L++){}if(L<15-ivl){L=15-ivl}iv=w.clamp(iv,8*(15-L));tag=sjcl.mode.ccm._computeTag(prf,plaintext,iv,adata,tlen,L);out=sjcl.mode.ccm._ctrMode(prf,out,iv,tag,tlen,L);return w.concat(out.data,out.tag)},decrypt:function(prf,ciphertext,iv,adata,tlen){tlen=tlen||64;adata=adata||[];var L,w=sjcl.bitArray,ivl=w.bitLength(iv)/8,ol=w.bitLength(ciphertext),out=w.clamp(ciphertext,ol-tlen),tag=w.bitSlice(ciphertext,ol-tlen),tag2;ol=(ol-tlen)/8;if(ivl<7){throw new sjcl.exception.invalid("ccm: iv must be at least 7 bytes")}for(L=2;L<4&&ol>>>8*L;L++){}if(L<15-ivl){L=15-ivl}iv=w.clamp(iv,8*(15-L));out=sjcl.mode.ccm._ctrMode(prf,out,iv,tag,tlen,L);tag2=sjcl.mode.ccm._computeTag(prf,out.data,iv,adata,tlen,L);if(!w.equal(out.tag,tag2)){throw new sjcl.exception.corrupt("ccm: tag doesn't match")}return out.data},_macAdditionalData:function(prf,adata,iv,tlen,ol,L){var mac,tmp,i,macData=[],w=sjcl.bitArray,xor=w._xor4;mac=[w.partial(8,(adata.length?1<<6:0)|tlen-2<<2|L-1)];mac=w.concat(mac,iv);mac[3]|=ol;mac=prf.encrypt(mac);if(adata.length){tmp=w.bitLength(adata)/8;if(tmp<=65279){macData=[w.partial(16,tmp)]}else if(tmp<=4294967295){macData=w.concat([w.partial(16,65534)],[tmp])}macData=w.concat(macData,adata);for(i=0;i<macData.length;i+=4){mac=prf.encrypt(xor(mac,macData.slice(i,i+4).concat([0,0,0])))}}return mac},_computeTag:function(prf,plaintext,iv,adata,tlen,L){var mac,i,w=sjcl.bitArray,xor=w._xor4;tlen/=8;if(tlen%2||tlen<4||tlen>16){throw new sjcl.exception.invalid("ccm: invalid tag length")}if(adata.length>4294967295||plaintext.length>4294967295){throw new sjcl.exception.bug("ccm: can't deal with 4GiB or more data")}mac=sjcl.mode.ccm._macAdditionalData(prf,adata,iv,tlen,w.bitLength(plaintext)/8,L);for(i=0;i<plaintext.length;i+=4){mac=prf.encrypt(xor(mac,plaintext.slice(i,i+4).concat([0,0,0])))}return w.clamp(mac,tlen*8)},_ctrMode:function(prf,data,iv,tag,tlen,L){var enc,i,w=sjcl.bitArray,xor=w._xor4,ctr,l=data.length,bl=w.bitLength(data),n=l/50,p=n;ctr=w.concat([w.partial(8,L-1)],iv).concat([0,0,0]).slice(0,4);tag=w.bitSlice(xor(tag,prf.encrypt(ctr)),0,tlen);if(!l){return{tag:tag,data:[]}}for(i=0;i<l;i+=4){if(i>n){sjcl.mode.ccm._callProgressListener(i/l);n+=p}ctr[3]++;enc=prf.encrypt(ctr);data[i]^=enc[0];data[i+1]^=enc[1];data[i+2]^=enc[2];data[i+3]^=enc[3]}return{tag:tag,data:w.clamp(data,bl)}}};sjcl.misc.hmac=function(key,Hash){this._hash=Hash=Hash||sjcl.hash.sha256;var exKey=[[],[]],i,bs=Hash.prototype.blockSize/32;this._baseHash=[new Hash,new Hash];if(key.length>bs){key=Hash.hash(key)}for(i=0;i<bs;i++){exKey[0][i]=key[i]^909522486;exKey[1][i]=key[i]^1549556828}this._baseHash[0].update(exKey[0]);this._baseHash[1].update(exKey[1]);this._resultHash=new Hash(this._baseHash[0])};sjcl.misc.hmac.prototype.encrypt=sjcl.misc.hmac.prototype.mac=function(data){if(!this._updated){this.update(data);return this.digest(data)}else{throw new sjcl.exception.invalid("encrypt on already updated hmac called!")}};sjcl.misc.hmac.prototype.reset=function(){this._resultHash=new this._hash(this._baseHash[0]);this._updated=false};sjcl.misc.hmac.prototype.update=function(data){this._updated=true;this._resultHash.update(data)};sjcl.misc.hmac.prototype.digest=function(){var w=this._resultHash.finalize(),result=new this._hash(this._baseHash[1]).update(w).finalize();this.reset();return result};sjcl.misc.pbkdf2=function(password,salt,count,length,Prff){count=count||1e4;if(length<0||count<0){throw new sjcl.exception.invalid("invalid params to pbkdf2")}if(typeof password==="string"){password=sjcl.codec.utf8String.toBits(password)}if(typeof salt==="string"){salt=sjcl.codec.utf8String.toBits(salt)}Prff=Prff||sjcl.misc.hmac;var prf=new Prff(password),u,ui,i,j,k,out=[],b=sjcl.bitArray;for(k=1;32*out.length<(length||1);k++){u=ui=prf.encrypt(b.concat(salt,[k]));for(i=1;i<count;i++){ui=prf.encrypt(ui);for(j=0;j<ui.length;j++){u[j]^=ui[j]}}out=out.concat(u)}if(length){out=b.clamp(out,length)}return out};sjcl.prng=function(defaultParanoia){this._pools=[new sjcl.hash.sha256];this._poolEntropy=[0];this._reseedCount=0;this._robins={};this._eventId=0;this._collectorIds={};this._collectorIdNext=0;this._strength=0;this._poolStrength=0;this._nextReseed=0;this._key=[0,0,0,0,0,0,0,0];this._counter=[0,0,0,0];this._cipher=undefined;this._defaultParanoia=defaultParanoia;this._collectorsStarted=false;this._callbacks={progress:{},seeded:{}};this._callbackI=0;this._NOT_READY=0;this._READY=1;this._REQUIRES_RESEED=2;this._MAX_WORDS_PER_BURST=65536;this._PARANOIA_LEVELS=[0,48,64,96,128,192,256,384,512,768,1024];this._MILLISECONDS_PER_RESEED=3e4;this._BITS_PER_RESEED=80};sjcl.prng.prototype={randomWords:function(nwords,paranoia){var out=[],i,readiness=this.isReady(paranoia),g;if(readiness===this._NOT_READY){throw new sjcl.exception.notReady("generator isn't seeded")}else if(readiness&this._REQUIRES_RESEED){this._reseedFromPools(!(readiness&this._READY))}for(i=0;i<nwords;i+=4){if((i+1)%this._MAX_WORDS_PER_BURST===0){this._gate()}g=this._gen4words();out.push(g[0],g[1],g[2],g[3])}this._gate();return out.slice(0,nwords)},setDefaultParanoia:function(paranoia,allowZeroParanoia){if(paranoia===0&&allowZeroParanoia!=="Setting paranoia=0 will ruin your security; use it only for testing"){throw new sjcl.exception.invalid("Setting paranoia=0 will ruin your security; use it only for testing")}this._defaultParanoia=paranoia},addEntropy:function(data,estimatedEntropy,source){source=source||"user";var id,i,tmp,t=(new Date).valueOf(),robin=this._robins[source],oldReady=this.isReady(),err=0,objName;id=this._collectorIds[source];if(id===undefined){id=this._collectorIds[source]=this._collectorIdNext++}if(robin===undefined){robin=this._robins[source]=0}this._robins[source]=(this._robins[source]+1)%this._pools.length;switch(typeof data){case"number":if(estimatedEntropy===undefined){estimatedEntropy=1}this._pools[robin].update([id,this._eventId++,1,estimatedEntropy,t,1,data|0]);break;case"object":objName=Object.prototype.toString.call(data);if(objName==="[object Uint32Array]"){tmp=[];for(i=0;i<data.length;i++){tmp.push(data[i])}data=tmp}else{if(objName!=="[object Array]"){err=1}for(i=0;i<data.length&&!err;i++){if(typeof data[i]!=="number"){err=1}}}if(!err){if(estimatedEntropy===undefined){estimatedEntropy=0;for(i=0;i<data.length;i++){tmp=data[i];while(tmp>0){estimatedEntropy++;tmp=tmp>>>1}}}this._pools[robin].update([id,this._eventId++,2,estimatedEntropy,t,data.length].concat(data))}break;case"string":if(estimatedEntropy===undefined){estimatedEntropy=data.length}this._pools[robin].update([id,this._eventId++,3,estimatedEntropy,t,data.length]);this._pools[robin].update(data);break;default:err=1}if(err){throw new sjcl.exception.bug("random: addEntropy only supports number, array of numbers or string")}this._poolEntropy[robin]+=estimatedEntropy;this._poolStrength+=estimatedEntropy;if(oldReady===this._NOT_READY){if(this.isReady()!==this._NOT_READY){this._fireEvent("seeded",Math.max(this._strength,this._poolStrength))}this._fireEvent("progress",this.getProgress())}},isReady:function(paranoia){var entropyRequired=this._PARANOIA_LEVELS[paranoia!==undefined?paranoia:this._defaultParanoia];if(this._strength&&this._strength>=entropyRequired){return this._poolEntropy[0]>this._BITS_PER_RESEED&&(new Date).valueOf()>this._nextReseed?this._REQUIRES_RESEED|this._READY:this._READY}else{return this._poolStrength>=entropyRequired?this._REQUIRES_RESEED|this._NOT_READY:this._NOT_READY}},getProgress:function(paranoia){var entropyRequired=this._PARANOIA_LEVELS[paranoia?paranoia:this._defaultParanoia];if(this._strength>=entropyRequired){return 1}else{return this._poolStrength>entropyRequired?1:this._poolStrength/entropyRequired}},startCollectors:function(){if(this._collectorsStarted){return}this._eventListener={loadTimeCollector:this._bind(this._loadTimeCollector),mouseCollector:this._bind(this._mouseCollector),keyboardCollector:this._bind(this._keyboardCollector),accelerometerCollector:this._bind(this._accelerometerCollector),touchCollector:this._bind(this._touchCollector)};if(window.addEventListener){window.addEventListener("load",this._eventListener.loadTimeCollector,false);window.addEventListener("mousemove",this._eventListener.mouseCollector,false);window.addEventListener("keypress",this._eventListener.keyboardCollector,false);window.addEventListener("devicemotion",this._eventListener.accelerometerCollector,false);window.addEventListener("touchmove",this._eventListener.touchCollector,false)}else if(document.attachEvent){document.attachEvent("onload",this._eventListener.loadTimeCollector);document.attachEvent("onmousemove",this._eventListener.mouseCollector);document.attachEvent("keypress",this._eventListener.keyboardCollector)}else{throw new sjcl.exception.bug("can't attach event")}this._collectorsStarted=true},stopCollectors:function(){if(!this._collectorsStarted){return}if(window.removeEventListener){window.removeEventListener("load",this._eventListener.loadTimeCollector,false);window.removeEventListener("mousemove",this._eventListener.mouseCollector,false);window.removeEventListener("keypress",this._eventListener.keyboardCollector,false);window.removeEventListener("devicemotion",this._eventListener.accelerometerCollector,false);window.removeEventListener("touchmove",this._eventListener.touchCollector,false)}else if(document.detachEvent){document.detachEvent("onload",this._eventListener.loadTimeCollector);document.detachEvent("onmousemove",this._eventListener.mouseCollector);document.detachEvent("keypress",this._eventListener.keyboardCollector)}this._collectorsStarted=false},addEventListener:function(name,callback){this._callbacks[name][this._callbackI++]=callback},removeEventListener:function(name,cb){var i,j,cbs=this._callbacks[name],jsTemp=[];for(j in cbs){if(cbs.hasOwnProperty(j)&&cbs[j]===cb){jsTemp.push(j)}}for(i=0;i<jsTemp.length;i++){j=jsTemp[i];delete cbs[j]}},_bind:function(func){var that=this;return function(){func.apply(that,arguments)}},_gen4words:function(){for(var i=0;i<4;i++){this._counter[i]=this._counter[i]+1|0;if(this._counter[i]){break}}return this._cipher.encrypt(this._counter)},_gate:function(){this._key=this._gen4words().concat(this._gen4words());this._cipher=new sjcl.cipher.aes(this._key)},_reseed:function(seedWords){this._key=sjcl.hash.sha256.hash(this._key.concat(seedWords));this._cipher=new sjcl.cipher.aes(this._key);for(var i=0;i<4;i++){this._counter[i]=this._counter[i]+1|0;if(this._counter[i]){break}}},_reseedFromPools:function(full){var reseedData=[],strength=0,i;this._nextReseed=reseedData[0]=(new Date).valueOf()+this._MILLISECONDS_PER_RESEED;for(i=0;i<16;i++){reseedData.push(Math.random()*4294967296|0)}for(i=0;i<this._pools.length;i++){reseedData=reseedData.concat(this._pools[i].finalize());strength+=this._poolEntropy[i];this._poolEntropy[i]=0;if(!full&&this._reseedCount&1<<i){break}}if(this._reseedCount>=1<<this._pools.length){this._pools.push(new sjcl.hash.sha256);this._poolEntropy.push(0)}this._poolStrength-=strength;if(strength>this._strength){this._strength=strength}this._reseedCount++;this._reseed(reseedData)},_keyboardCollector:function(){this._addCurrentTimeToEntropy(1)},_mouseCollector:function(ev){var x,y;try{x=ev.x||ev.clientX||ev.offsetX||0;y=ev.y||ev.clientY||ev.offsetY||0}catch(err){x=0;y=0}if(x!=0&&y!=0){this.addEntropy([x,y],2,"mouse")}this._addCurrentTimeToEntropy(0)},_touchCollector:function(ev){var touch=ev.touches[0]||ev.changedTouches[0];var x=touch.pageX||touch.clientX,y=touch.pageY||touch.clientY;this.addEntropy([x,y],1,"touch");this._addCurrentTimeToEntropy(0)},_loadTimeCollector:function(){this._addCurrentTimeToEntropy(2)},_addCurrentTimeToEntropy:function(estimatedEntropy){if(typeof window!=="undefined"&&window.performance&&typeof window.performance.now==="function"){this.addEntropy(window.performance.now(),estimatedEntropy,"loadtime")}else{this.addEntropy((new Date).valueOf(),estimatedEntropy,"loadtime")}},_accelerometerCollector:function(ev){var ac=ev.accelerationIncludingGravity.x||ev.accelerationIncludingGravity.y||ev.accelerationIncludingGravity.z;if(window.orientation){var or=window.orientation;if(typeof or==="number"){this.addEntropy(or,1,"accelerometer")}}if(ac){this.addEntropy(ac,2,"accelerometer")}this._addCurrentTimeToEntropy(0)},_fireEvent:function(name,arg){var j,cbs=sjcl.random._callbacks[name],cbsTemp=[];for(j in cbs){if(cbs.hasOwnProperty(j)){cbsTemp.push(cbs[j])}}for(j=0;j<cbsTemp.length;j++){cbsTemp[j](arg)}}};sjcl.random=new sjcl.prng(6);(function(){function getCryptoModule(){try{return require("crypto")}catch(e){return null}}try{var buf,crypt,ab;if(typeof module!=="undefined"&&module.exports&&(crypt=getCryptoModule())&&crypt.randomBytes){buf=crypt.randomBytes(1024/8);buf=new Uint32Array(new Uint8Array(buf).buffer);sjcl.random.addEntropy(buf,1024,"crypto.randomBytes")}else if(typeof window!=="undefined"&&typeof Uint32Array!=="undefined"){ab=new Uint32Array(32);if(window.crypto&&window.crypto.getRandomValues){window.crypto.getRandomValues(ab)}else if(window.msCrypto&&window.msCrypto.getRandomValues){window.msCrypto.getRandomValues(ab)}else{return}sjcl.random.addEntropy(ab,1024,"crypto.getRandomValues")}else{}}catch(e){if(typeof window!=="undefined"&&window.console){console.log("There was an error collecting entropy from the browser:");console.log(e)}}})();sjcl.json={defaults:{v:1,iter:1e4,ks:128,ts:64,mode:"ccm",adata:"",cipher:"aes"},_encrypt:function(password,plaintext,params,rp){params=params||{};rp=rp||{};var j=sjcl.json,p=j._add({iv:sjcl.random.randomWords(4,0)},j.defaults),tmp,prp,adata;j._add(p,params);adata=p.adata;if(typeof p.salt==="string"){p.salt=sjcl.codec.base64.toBits(p.salt)}if(typeof p.iv==="string"){p.iv=sjcl.codec.base64.toBits(p.iv)}if(!sjcl.mode[p.mode]||!sjcl.cipher[p.cipher]||typeof password==="string"&&p.iter<=100||p.ts!==64&&p.ts!==96&&p.ts!==128||p.ks!==128&&p.ks!==192&&p.ks!==256||(p.iv.length<2||p.iv.length>4)){throw new sjcl.exception.invalid("json encrypt: invalid parameters")}if(typeof password==="string"){tmp=sjcl.misc.cachedPbkdf2(password,p);password=tmp.key.slice(0,p.ks/32);p.salt=tmp.salt}else if(sjcl.ecc&&password instanceof sjcl.ecc.elGamal.publicKey){tmp=password.kem();p.kemtag=tmp.tag;password=tmp.key.slice(0,p.ks/32)}if(typeof plaintext==="string"){plaintext=sjcl.codec.utf8String.toBits(plaintext)}if(typeof adata==="string"){p.adata=adata=sjcl.codec.utf8String.toBits(adata)}prp=new sjcl.cipher[p.cipher](password);j._add(rp,p);rp.key=password;if(p.mode==="ccm"&&sjcl.arrayBuffer&&sjcl.arrayBuffer.ccm&&plaintext instanceof ArrayBuffer){p.ct=sjcl.arrayBuffer.ccm.encrypt(prp,plaintext,p.iv,adata,p.ts)}else{p.ct=sjcl.mode[p.mode].encrypt(prp,plaintext,p.iv,adata,p.ts)}return p},encrypt:function(password,plaintext,params,rp){var j=sjcl.json,p=j._encrypt.apply(j,arguments);return j.encode(p)},_decrypt:function(password,ciphertext,params,rp){params=params||{};rp=rp||{};var j=sjcl.json,p=j._add(j._add(j._add({},j.defaults),ciphertext),params,true),ct,tmp,prp,adata=p.adata;if(typeof p.salt==="string"){p.salt=sjcl.codec.base64.toBits(p.salt)}if(typeof p.iv==="string"){p.iv=sjcl.codec.base64.toBits(p.iv)}if(!sjcl.mode[p.mode]||!sjcl.cipher[p.cipher]||typeof password==="string"&&p.iter<=100||p.ts!==64&&p.ts!==96&&p.ts!==128||p.ks!==128&&p.ks!==192&&p.ks!==256||!p.iv||(p.iv.length<2||p.iv.length>4)){throw new sjcl.exception.invalid("json decrypt: invalid parameters")}if(typeof password==="string"){tmp=sjcl.misc.cachedPbkdf2(password,p);password=tmp.key.slice(0,p.ks/32);p.salt=tmp.salt}else if(sjcl.ecc&&password instanceof sjcl.ecc.elGamal.secretKey){password=password.unkem(sjcl.codec.base64.toBits(p.kemtag)).slice(0,p.ks/32)}if(typeof adata==="string"){adata=sjcl.codec.utf8String.toBits(adata)}prp=new sjcl.cipher[p.cipher](password);if(p.mode==="ccm"&&sjcl.arrayBuffer&&sjcl.arrayBuffer.ccm&&p.ct instanceof ArrayBuffer){ct=sjcl.arrayBuffer.ccm.decrypt(prp,p.ct,p.iv,p.tag,adata,p.ts)}else{ct=sjcl.mode[p.mode].decrypt(prp,p.ct,p.iv,adata,p.ts)}j._add(rp,p);rp.key=password;if(params.raw===1){return ct}else{return sjcl.codec.utf8String.fromBits(ct)}},decrypt:function(password,ciphertext,params,rp){var j=sjcl.json;return j._decrypt(password,j.decode(ciphertext),params,rp)},encode:function(obj){var i,out="{",comma="";for(i in obj){if(obj.hasOwnProperty(i)){if(!i.match(/^[a-z0-9]+$/i)){throw new sjcl.exception.invalid("json encode: invalid property name")}out+=comma+'"'+i+'":';comma=",";switch(typeof obj[i]){case"number":case"boolean":out+=obj[i];break;case"string":out+='"'+escape(obj[i])+'"';break;case"object":out+='"'+sjcl.codec.base64.fromBits(obj[i],0)+'"';break;default:throw new sjcl.exception.bug("json encode: unsupported type")}}}return out+"}"},decode:function(str){str=str.replace(/\\s/g,"");if(!str.match(/^\\{.*}$/)){throw new sjcl.exception.invalid("json decode: this isn't json!")}var a=str.replace(/^\\{|}$/g,"").split(/,/),out={},i,m;for(i=0;i<a.length;i++){if(!(m=a[i].match(/^\\s*(?:(["']?)([a-z][a-z0-9]*)\\1)\\s*:\\s*(?:(-?\\d+)|"([a-z0-9+\\/%*_.@=\\-]*)"|(true|false))$/i))){throw new sjcl.exception.invalid("json decode: this isn't json!")}if(m[3]!=null){out[m[2]]=parseInt(m[3],10)}else if(m[4]!=null){out[m[2]]=m[2].match(/^(ct|adata|salt|iv)$/)?sjcl.codec.base64.toBits(m[4]):unescape(m[4])}else if(m[5]!=null){out[m[2]]=m[5]==="true"}}return out},_add:function(target,src,requireSame){if(target===undefined){target={}}if(src===undefined){return target}var i;for(i in src){if(src.hasOwnProperty(i)){if(requireSame&&target[i]!==undefined&&target[i]!==src[i]){throw new sjcl.exception.invalid("required parameter overridden")}target[i]=src[i]}}return target},_subtract:function(plus,minus){var out={},i;for(i in plus){if(plus.hasOwnProperty(i)&&plus[i]!==minus[i]){out[i]=plus[i]}}return out},_filter:function(src,filter){var out={},i;for(i=0;i<filter.length;i++){if(src[filter[i]]!==undefined){out[filter[i]]=src[filter[i]]}}return out}};sjcl.encrypt=sjcl.json.encrypt;sjcl.decrypt=sjcl.json.decrypt;sjcl.misc._pbkdf2Cache={};sjcl.misc.cachedPbkdf2=function(password,obj){var cache=sjcl.misc._pbkdf2Cache,c,cp,str,salt,iter;obj=obj||{};iter=obj.iter||1e3;cp=cache[password]=cache[password]||{};c=cp[iter]=cp[iter]||{firstSalt:obj.salt&&obj.salt.length?obj.salt.slice(0):sjcl.random.randomWords(2,0)};salt=obj.salt===undefined?c.firstSalt:obj.salt;c[salt]=c[salt]||sjcl.misc.pbkdf2(password,salt,obj.iter);return{key:c[salt].slice(0),salt:salt.slice(0)}};if(typeof module!=="undefined"&&module.exports){module.exports=sjcl}if(typeof define==="function"){define([],function(){return sjcl})}",
        "    var Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(input){var output="";var chr1,chr2,chr3,enc1,enc2,enc3,enc4;var i=0;input=Base64._utf8_encode(input);while(i<input.length){chr1=input.charCodeAt(i++);chr2=input.charCodeAt(i++);chr3=input.charCodeAt(i++);enc1=chr1>>2;enc2=(chr1&3)<<4|chr2>>4;enc3=(chr2&15)<<2|chr3>>6;enc4=chr3&63;if(isNaN(chr2)){enc3=enc4=64}else if(isNaN(chr3)){enc4=64}output=output+this._keyStr.charAt(enc1)+this._keyStr.charAt(enc2)+this._keyStr.charAt(enc3)+this._keyStr.charAt(enc4)}return output},decode:function(input){var output="";var chr1,chr2,chr3;var enc1,enc2,enc3,enc4;var i=0;input=input.replace(/[^A-Za-z0-9\\+\\/\\=]/g,"");while(i<input.length){enc1=this._keyStr.indexOf(input.charAt(i++));enc2=this._keyStr.indexOf(input.charAt(i++));enc3=this._keyStr.indexOf(input.charAt(i++));enc4=this._keyStr.indexOf(input.charAt(i++));chr1=enc1<<2|enc2>>4;chr2=(enc2&15)<<4|enc3>>2;chr3=(enc3&3)<<6|enc4;output=output+String.fromCharCode(chr1);if(enc3!=64){output=output+String.fromCharCode(chr2)}if(enc4!=64){output=output+String.fromCharCode(chr3)}}output=Base64._utf8_decode(output);return output},_utf8_encode:function(string){string=string.replace(/\\r\\n/g,"\\n");var utftext="";for(var n=0;n<string.length;n++){var c=string.charCodeAt(n);if(c<128){utftext+=String.fromCharCode(c)}else if(c>127&&c<2048){utftext+=String.fromCharCode(c>>6|192);utftext+=String.fromCharCode(c&63|128)}else{utftext+=String.fromCharCode(c>>12|224);utftext+=String.fromCharCode(c>>6&63|128);utftext+=String.fromCharCode(c&63|128)}}return utftext},_utf8_decode:function(utftext){var string="";var i=0;var c=c1=c2=0;while(i<utftext.length){c=utftext.charCodeAt(i);if(c<128){string+=String.fromCharCode(c);i++}else if(c>191&&c<224){c2=utftext.charCodeAt(i+1);string+=String.fromCharCode((c&31)<<6|c2&63);i+=2}else{c2=utftext.charCodeAt(i+1);c3=utftext.charCodeAt(i+2);string+=String.fromCharCode((c&15)<<12|(c2&63)<<6|c3&63);i+=3}}return string}};",
        "",
        "      logger.message("Collect And Encrypt Custom Password: start");",
        "    outcome = "true";",
        "  ",
        "    /* Begin Configuration */",
        "      ",
        "      // Attribute name",
        "      var idmAttrName = "frUnindexedString2"; // AM: "fr-attr-str2"",
        "      ",
        "      // Pick a shared secret to use for encryption and decryption",
        "    var sharedSecret = "RainbowPoniesHaveNoStripes";",
        "",
        "      // Fine-tune encryption settings. Default iterations are 10k, to speed up the process, it's reduced to 1k here.",
        "      var encryptionParameters = { "iter" : 1000 };",
        "      ",
        "    // Build out the password prompt",
        "    var prompt = "Replay Password";",
        "",
        "    /* End Configuration */",
        "  ",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "        javax.security.auth.callback.PasswordCallback,",
        "          java.lang.String",
        "    )",
        "    ",
        "    if (callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "          new fr.PasswordCallback(prompt, false)",
        "        ).build();",
        "    } ",
        "    else {",
        "          // PasswordCallback returns the password as a char[], which is not the same as a JS char array. It must be converted to a proper string using the java.lang.Sting.valueOf(char[]) method.",
        "        var password = new String(fr.String.valueOf(callbacks.get(0).getPassword()));",
        "        logger.message("Collect And Encrypt Custom Password: callbacks received");",
        "",
        "          /*",
        "        var cipherPasswordJson = sjcl.encrypt(sharedSecret, password, encryptionParameters);",
        "        //setSharedObjectAttribute(idmAttrName, Base64.encode(JSON.stringify(cipherPasswordJson)));",
        "        setSharedObjectAttribute(idmAttrName, JSON.stringify(cipherPasswordJson));",
        "        logger.message("Collect And Encrypt Custom Password: cipherPasswordJson="+JSON.stringify(cipherPasswordJson));",
        "        */",
        "      ",
        "        logger.message("Collect And Encrypt Custom Password: password="+Base64.encode(password));",
        "        setSharedObjectAttribute(idmAttrName, Base64.encode(password));",
        "",
        "        logger.message("Collect And Encrypt Custom Password: finish [outcome=".concat(outcome).concat("]"));",
        "        action = fr.Action.goTo(outcome).build();",
        "    }",
        "",
        "    /*",
        "     * Store attributes in shared state for use with the Create/Patch Object nodes.",
        "     */",
        "    function setSharedObjectAttribute(name, value) {",
        "        var storage = sharedState.get("objectAttributes");",
        "        if (storage && value) {",
        "            if (storage.put) {",
        "                  storage.put(name, value);",
        "            }",
        "            else {",
        "                storage[name] = value;",
        "            }",
        "        }",
        "        else if (value) {",
        "              var object = {",
        "                  name: value",
        "            };",
        "            sharedState.put("objectAttributes", object);",
        "            //sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "        }",
        "    }",
        "}());",
        "/* SJCL is open. You can use, modify and redistribute it under a BSD",
        "license or under the GNU GPL, version 2.0.",
        "",
        "---------------------------------------------------------------------",
        "",
        "http://opensource.org/licenses/BSD-2-Clause",
        "",
        "Copyright (c) 2009-2015, Emily Stark, Mike Hamburg and Dan Boneh at",
        "Stanford University. All rights reserved.",
        "",
        "Redistribution and use in source and binary forms, with or without",
        "modification, are permitted provided that the following conditions are",
        "met:",
        "",
        "1. Redistributions of source code must retain the above copyright",
        "notice, this list of conditions and the following disclaimer.",
        "",
        "2. Redistributions in binary form must reproduce the above copyright",
        "notice, this list of conditions and the following disclaimer in the",
        "documentation and/or other materials provided with the distribution.",
        "",
        "THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS",
        "IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED",
        "TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A",
        "PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT",
        "HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,",
        "SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED",
        "TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR",
        "PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF",
        "LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING",
        "NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS",
        "SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.",
        "",
        "---------------------------------------------------------------------",
        "",
        "http://opensource.org/licenses/GPL-2.0",
        "",
        "The Stanford Javascript Crypto Library (hosted here on GitHub) is a",
        "project by the Stanford Computer Security Lab to build a secure,",
        "powerful, fast, small, easy-to-use, cross-browser library for",
        "cryptography in Javascript.",
        "",
        "Copyright (c) 2009-2015, Emily Stark, Mike Hamburg and Dan Boneh at",
        "Stanford University.",
        "",
        "This program is free software; you can redistribute it and/or modify it",
        "under the terms of the GNU General Public License as published by the",
        "Free Software Foundation; either version 2 of the License, or (at your",
        "option) any later version.",
        "",
        "This program is distributed in the hope that it will be useful, but",
        "WITHOUT ANY WARRANTY; without even the implied warranty of",
        "MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General",
        "Public License for more details.",
        "",
        "You should have received a copy of the GNU General Public License along",
        "with this program; if not, write to the Free Software Foundation, Inc.,",
        "59 Temple Place, Suite 330, Boston, MA 02111-1307 USA */",
        "",
        "/*",
        " * Base64 encode / decode",
        " *  http://www.webtoolkit.info/",
        " * ",
        " * Example:",
        " * Base64.encode('some string')",
        " * Base64.decode('some encoded string')",
        " */",
      ],
    },
    "db854830-a069-471f-875a-8dc67d45ea2d": {
      "_id": "db854830-a069-471f-875a-8dc67d45ea2d",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_SetInviteMailVars",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "var objAttrs = sharedState.get('objectAttributes') || new HashMap();",
        "objAttrs.put('currentYear', new Date().getFullYear().toString());",
        "sharedState.put('objectAttributes', objAttrs);",
        "",
        "outcome = 'True';",
        "",
      ],
    },
    "dbe0bf9a-72aa-49d5-8483-9db147985a47": {
      "_id": "dbe0bf9a-72aa-49d5-8483-9db147985a47",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Normalizes raw profile data from ADFS",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "ADFS Profile Normalization (JS)",
      "script": [
        "/*",
        " * Copyright 2022 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        " * This script returns the social identity profile information for the authenticating user",
        " * in a standard form expected by the Social Provider Handler Node.",
        " *",
        " * Defined variables:",
        " * rawProfile - The social identity provider profile information for the authenticating user.",
        " *              JsonValue (1).",
        " * logger - The debug logger instance:",
        " *          https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.",
        " * realm - String (primitive).",
        " *         The name of the realm the user is authenticating to.",
        " * requestHeaders - TreeMap (2).",
        " *                  The object that provides methods for accessing headers in the login request:",
        " *                  https://backstage.forgerock.com/docs/am/7/authentication-guide/scripting-api-node.html#scripting-api-node-requestHeaders.",
        " * requestParameters - TreeMap (2).",
        " *                     The object that contains the authentication request parameters.",
        " * selectedIdp - String (primitive).",
        " *               The social identity provider name. For example: google.",
        " * sharedState - LinkedHashMap (3).",
        " *               The object that holds the state of the authentication tree and allows data exchange between the stateless nodes:",
        " *               https://backstage.forgerock.com/docs/am/7/auth-nodes/core-action.html#accessing-tree-state.",
        " * transientState - LinkedHashMap (3).",
        " *                  The object for storing sensitive information that must not leave the server unencrypted,",
        " *                  and that may not need to persist between authentication requests during the authentication session:",
        " *                  https://backstage.forgerock.com/docs/am/7/auth-nodes/core-action.html#accessing-tree-state.",
        " *",
        " * Return - a JsonValue (1).",
        " *          The result of the last statement in the script is returned to the server.",
        " *          Currently, the Immediately Invoked Function Expression (also known as Self-Executing Anonymous Function)",
        " *          is the last (and only) statement in this script, and its return value will become the script result.",
        " *          Do not use "return variable" statement outside of a function definition.",
        " *",
        " *          This script's last statement should result in a JsonValue (1) with the following keys:",
        " *          {",
        " *              {"displayName": "corresponding-social-identity-provider-value"},",
        " *              {"email": "corresponding-social-identity-provider-value"},",
        " *              {"familyName": "corresponding-social-identity-provider-value"},",
        " *              {"givenName": "corresponding-social-identity-provider-value"},",
        " *              {"id": "corresponding-social-identity-provider-value"},",
        " *              {"locale": "corresponding-social-identity-provider-value"},",
        " *              {"photoUrl": "corresponding-social-identity-provider-value"},",
        " *              {"username": "corresponding-social-identity-provider-value"}",
        " *          }",
        " *",
        " *          The consumer of this data defines which keys are required and which are optional.",
        " *          For example, the script associated with the Social Provider Handler Node and,",
        " *          ultimately, the managed object created/updated with this data",
        " *          will expect certain keys to be populated.",
        " *          In some common default configurations, the following keys are required to be not empty:",
        " *          username, givenName, familyName, email.",
        " *",
        " *          From RFC4517: A value of the Directory String syntax is a string of one or more",
        " *          arbitrary characters from the Universal Character Set (UCS).",
        " *          A zero-length character string is not permitted.",
        " *",
        " * (1) JsonValue - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/json/JsonValue.html.",
        " * (2) TreeMap - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/TreeMap.html.",
        " * (3) LinkedHashMap - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/LinkedHashMap.html.",
        " */",
        "",
        "(function () {",
        "    var frJava = JavaImporter(",
        "        org.forgerock.json.JsonValue",
        "    );",
        "",
        "    var normalizedProfileData = frJava.JsonValue.json(frJava.JsonValue.object());",
        "  ",
        "      //logger.message('Seguin rawProfile: '+rawProfile);",
        "",
        "    normalizedProfileData.put('id', rawProfile.get('sub').asString());",
        "    normalizedProfileData.put('displayName', rawProfile.get('givenName').asString() + ' ' + rawProfile.get('sn').asString());",
        "    normalizedProfileData.put('email', rawProfile.get('mail').asString());",
        "    normalizedProfileData.put('givenName', rawProfile.get('givenName').asString());",
        "    normalizedProfileData.put('familyName', rawProfile.get('sn').asString());",
        "    normalizedProfileData.put('username', rawProfile.get('upn').asString());",
        "    normalizedProfileData.put('roles', rawProfile.get('roles').asString());",
        "  ",
        "      //logger.message('Seguin normalizedProfileData: '+normalizedProfileData);",
        "",
        "    return normalizedProfileData;",
        "}());",
      ],
    },
    "dc0c9905-4a58-4f61-8562-337514e610a7": {
      "_id": "dc0c9905-4a58-4f61-8562-337514e610a7",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_IdPNormalization",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        " * This script maps token claim values to managed object attributes. It uses a "claim map" that defines",
        " * several common claim names for a given attribute so that this same script can be used for all IdPs.",
        " * For example, the attribute \`familyName\` can be populated from claims \`familyName\`, \`family_name\`, or \`sn\`.",
        " * ",
        " * Also, if custom IdP config exists in shared state and defines IdP-to-IDC group membership mappings,",
        " * those will be applied/enforced by this script. ",
        " */",
        "",
        "var SHARED_STATE_KEY = 'idpCustomConfig';",
        "",
        "// Helper to avoid strict comparison of string objects",
        "function containsGroup(jsArray, javaString) {",
        "  for (var i = 0; i < jsArray.length; i++) {",
        "    if (jsArray[i] == javaString) {",
        "      return true;",
        "    }",
        "  }",
        "  return false;",
        "}",
        "",
        "(function () {",
        "  var fr = JavaImporter(",
        "    java.lang.String,",
        "    java.util.ArrayList,",
        "    org.forgerock.json.JsonValue",
        "  );",
        "  ",
        "  var normalizedProfileData = fr.JsonValue.json(fr.JsonValue.object());",
        "  var idpConfig = sharedState.get(SHARED_STATE_KEY);",
        "",
        "  // If we have config that defines a groups claim map for this IdP, ensure the claim value matches one that's in the map",
        "  if (idpConfig && idpConfig.groups) {",
        "",
        "    logger.message('enforcing groups claim config');",
        "",
        "    // Get the groups claim from the IdP profile",
        "    var groupsClaim = rawProfile.get(idpConfig.groups.claim);",
        "    if (groupsClaim.isNull()) {",
        "      logger.error('groups claim map was enabled for "{}", but claim "{}" was not found in the raw profile', selectedIdp, idpConfig.groups.claim);",
        "      throw 'Required groups claim is missing from raw profile';",
        "    }",
        "",
        "    logger.message('received group claim value {}', groupsClaim);",
        "",
        "    // Validate the claim type and convert strings to single-value collection",
        "    var groupsClaimList;",
        "    if (groupsClaim.isCollection()) {",
        "      groupsClaimList = groupsClaim;",
        "    } else if (groupsClaim.isString()) {",
        "      groupsClaimList = new fr.ArrayList();",
        "      groupsClaimList.add(groupsClaim);",
        "    } else {",
        "      throw 'Groups claim was not a string or collection';",
        "    }",
        "    ",
        "    // Assert the claim contains at least one group",
        "    var groupsClaimLen = groupsClaimList.size();",
        "    if (groupsClaimLen < 1) {",
        "      throw 'An empty groups claim was found in raw profile';",
        "    }",
        "",
        "    // Loop through each IDC group name in the map. If the raw profile groups claim contains",
        "    // a value that matches the map for that IDC group, add that IDC group to the list for this admin.",
        "    var groups = [];",
        "    for (var idcGroupName in idpConfig.groups.mappings) {",
        "      for (var i = 0; i < groupsClaimLen; i++) {",
        "        var claimGroupId = groupsClaimList.get(i).asString();",
        "",
        "        logger.message('checking if mapping for IDC group "{}" contains claim value "{}"', idcGroupName, claimGroupId);",
        "",
        "        if (containsGroup(idpConfig.groups.mappings[idcGroupName], claimGroupId)) {",
        "          groups.push(idcGroupName);",
        "        }",
        "      }",
        "    }",
        "",
        "    // Assert at least one group was mapped to the claim",
        "    if (groups.length == 0) {",
        "      logger.error('groups claim map was enabled for "{}", but the value of claim "{}" did not match a group mapping', selectedIdp, idpConfig.groups.claim);",
        "      throw 'Raw profile groups claim value does not match a configured mapping';",
        "    }",
        "",
        "    normalizedProfileData.put('groups', groups);",
        "    sharedState.put('groups', groups);",
        "  } else {",
        "    logger.message('no enabled groups claim config to enforce');",
        "  }",
        "",
        "  // Maps normalized profile keys to the possible raw profile keys that values can come from",
        "  var claimMap = {",
        "    email: ['email', 'mail'],",
        "    familyName: ['familyName', 'family_name', 'sn'],",
        "    givenName: ['givenName', 'given_name']",
        "  };",
        "",
        "  // Try to populate each normalized profile property",
        "  var keys = Object.keys(claimMap);",
        "  for (var i = 0; i < keys.length; i++) {",
        "    var normalizedProp = keys[i];",
        "    // Try each mapped raw profile key until a value is found",
        "    for (var j = 0; j < claimMap[normalizedProp].length; j++) {",
        "      var rawProp = claimMap[normalizedProp][j];",
        "      if (!rawProfile.get(rawProp).isNull()) {",
        "        normalizedProfileData.put(normalizedProp, rawProfile.get(rawProp));",
        "        break;",
        "      }",
        "    }",
        "  }",
        "",
        "  return normalizedProfileData;",
        "}());",
      ],
    },
    "dedbc9f6-7fc9-4332-a330-55f7aeb95e78": {
      "_id": "dedbc9f6-7fc9-4332-a330-55f7aeb95e78",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "FRAAS-7955 Shared State Only",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "FRAAS-7955 Shared State Only",
      "script": [
        "outcome = "true";",
        "",
        "setSharedObjectAttribute("userName", "FRAAS-7955");",
        "setSharedObjectAttribute("givenName", "First-shared");",
        "setSharedObjectAttribute("sn", "Last-shared");",
        "setSharedObjectAttribute("mail", "first.last-shared@company.com");",
        "",
        "/*",
        " * Store attributes in shared state for use with the Create/Patch Object nodes.",
        " */",
        "function setSharedObjectAttribute(name, value) {",
        "       var storage = sharedState.get("objectAttributes");",
        "    if (storage && value) {",
        "          if (storage.put) {",
        "              storage.put(name, value);",
        "        }",
        "          else {",
        "              storage[name] = value;",
        "        }",
        "    }",
        "    else if (value) {",
        "        sharedState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "    }",
        "}",
      ],
    },
    "e0666b8b-f625-4047-89d8-e7e91151027f": {
      "_id": "e0666b8b-f625-4047-89d8-e7e91151027f",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Twilio Voice OTP Sender",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Twilio Voice OTP Sender",
      "script": [
        "/* Twilio Voice OTP Sender",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * This script will deliver the OTP via voice to the phone number in the user's profile.",
        " * ",
        " * This script needs to be parametrized. It will not work properly as is. ",
        " * It requires the Identify Existing User node and HOTP Generator node before it is being called.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - sent",
        " * - failed",
        " */",
        "logger.warning("Twilio Voice OTP Sender: start");",
        "",
        "if (sharedState.get("_id") && idRepository.getAttribute(sharedState.get("_id"), "telephoneNumber").iterator().hasNext()) {",
        "    var Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(input){var output="";var chr1,chr2,chr3,enc1,enc2,enc3,enc4;var i=0;input=Base64._utf8_encode(input);while(i<input.length){chr1=input.charCodeAt(i++);chr2=input.charCodeAt(i++);chr3=input.charCodeAt(i++);enc1=chr1>>2;enc2=(chr1&3)<<4|chr2>>4;enc3=(chr2&15)<<2|chr3>>6;enc4=chr3&63;if(isNaN(chr2)){enc3=enc4=64}else if(isNaN(chr3)){enc4=64}output=output+this._keyStr.charAt(enc1)+this._keyStr.charAt(enc2)+this._keyStr.charAt(enc3)+this._keyStr.charAt(enc4)}return output},decode:function(input){var output="";var chr1,chr2,chr3;var enc1,enc2,enc3,enc4;var i=0;input=input.replace(/[^A-Za-z0-9\\+\\/\\=]/g,"");while(i<input.length){enc1=this._keyStr.indexOf(input.charAt(i++));enc2=this._keyStr.indexOf(input.charAt(i++));enc3=this._keyStr.indexOf(input.charAt(i++));enc4=this._keyStr.indexOf(input.charAt(i++));chr1=enc1<<2|enc2>>4;chr2=(enc2&15)<<4|enc3>>2;chr3=(enc3&3)<<6|enc4;output=output+String.fromCharCode(chr1);if(enc3!=64){output=output+String.fromCharCode(chr2)}if(enc4!=64){output=output+String.fromCharCode(chr3)}}output=Base64._utf8_decode(output);return output},_utf8_encode:function(string){string=string.replace(/\\r\\n/g,"\\n");var utftext="";for(var n=0;n<string.length;n++){var c=string.charCodeAt(n);if(c<128){utftext+=String.fromCharCode(c)}else if(c>127&&c<2048){utftext+=String.fromCharCode(c>>6|192);utftext+=String.fromCharCode(c&63|128)}else{utftext+=String.fromCharCode(c>>12|224);utftext+=String.fromCharCode(c>>6&63|128);utftext+=String.fromCharCode(c&63|128)}}return utftext},_utf8_decode:function(utftext){var string="";var i=0;var c=c1=c2=0;while(i<utftext.length){c=utftext.charCodeAt(i);if(c<128){string+=String.fromCharCode(c);i++}else if(c>191&&c<224){c2=utftext.charCodeAt(i+1);string+=String.fromCharCode((c&31)<<6|c2&63);i+=2}else{c2=utftext.charCodeAt(i+1);c3=utftext.charCodeAt(i+2);string+=String.fromCharCode((c&15)<<12|(c2&63)<<6|c3&63);i+=3}}return string}};",
        "",
        "    /* BEGIN SCRIPT CONFIGURATION",
        "     *",
        "     * REPLACE WITH YOUR OWN AZURE AD SETTINGS",
        "     */",
        "    var TWILIO_API_SID = "AC750415e3163a2e57b7aeea7eed82d944";",
        "    var TWILIO_API_TOKEN = "d36a719c94b4be08592d69ec4f80a5bb";",
        "    var TWILIO_API_FROM = "+13176443107";",
        "    /*",
        "     * END SCRIPT CONFIGURATION",
        "     */",
        "  ",
        "    // Twilio SMS Message API Configuration",
        "    var TWILIO_API_URI = "https://api.twilio.com/2010-04-01/Accounts/".concat(TWILIO_API_SID).concat("/Calls.json");    ",
        "    var TWILIO_API_TO = idRepository.getAttribute(sharedState.get("_id"), "telephoneNumber").iterator().next();",
        "      var OTP = sharedState.get("oneTimePassword").split("").join("; ");",
        "    var TWILIO_API_TWIML = "<Response><Pause length='1'/><Say voice='alice'>Your one-time password is ".concat(OTP).concat("</Say><Pause length='1'/><Say>Your one-time password is ").concat(OTP).concat("</Say><Pause length='1'/><Say>Goodbye</Say></Response>");",
        "    //logger.warning("Twilio Voice OTP Sender: To: ".concat(TWILIO_API_TO));",
        "    //logger.warning("Twilio Voice OTP Sender: Twiml: ".concat(TWILIO_API_TWIML));",
        "",
        "    var AUTHZ = "Basic ".concat(Base64.encode(TWILIO_API_SID.concat(':').concat(TWILIO_API_TOKEN)));",
        "    //logger.warning("Twilio SMS OTP Sender: AUTHZ - ".concat(AUTHZ));",
        "",
        "    var request = new org.forgerock.http.protocol.Request();",
        "    request.setMethod('POST');",
        "    request.setUri(TWILIO_API_URI);",
        "    request.getHeaders().add("Content-Type", "application/x-www-form-urlencoded");",
        "    request.getHeaders().add("Authorization", AUTHZ);",
        "    var params = request.getForm();",
        "    params.add("From", TWILIO_API_FROM);",
        "    params.add("Twiml", TWILIO_API_TWIML);",
        "    params.add("To", TWILIO_API_TO);",
        "    request.getEntity().setString(params.toString());",
        "",
        "    var response = httpClient.send(request).get();",
        "    var result = JSON.parse(response.getEntity().getString());",
        "    //logger.warning("Twilio SMS OTP Sender: JSON result: " + JSON.stringify(result));",
        "",
        "    if (result["status"]=="queued") {",
        "        outcome = result["status"];",
        "        logger.error("Twilio Voice OTP Sender: status = ".concat(result["status"]));",
        "        logger.error("Twilio Voice OTP Sender: subresource_uris = ".concat(result["subresource_uris"]));",
        "        logger.error("Twilio Voice OTP Sender: outcome = ".concat(outcome));",
        "    } else {",
        "        outcome = "failed";",
        "        logger.error("Twilio Voice OTP Sender: status = ".concat(result["status"]));",
        "        logger.error("Twilio Voice OTP Sender: code = ".concat(result["code"]));",
        "        logger.error("Twilio Voice OTP Sender: more_info = ".concat(result["more_info"]));",
        "        logger.error("Twilio Voice OTP Sender: message = ".concat(result["message"]));",
        "        logger.error("Twilio Voice OTP Sender: outcome = ".concat(outcome));",
        "    }",
        "} else {",
        "      outcome = "failed";",
        "      logger.error("Twilio Voice OTP Sender: No user or phone number found! Use 'Identify Existing User node before this script to populate the user's _id in shared state!'");",
        "    logger.error("Twilio Voice OTP Sender: outcome = ".concat(outcome));",
        "}",
      ],
    },
    "e0ba741b-c952-4062-9899-0b1c19237ee4": {
      "_id": "e0ba741b-c952-4062-9899-0b1c19237ee4",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "FRAAS-7955 Workaround: Copy sharedState to transientState",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "FRAAS-7955 Workaround",
      "script": [
        "outcome = "true";",
        "var attrs = sharedState.get("objectAttributes");",
        "if (attrs) {",
        "      setTransientObjectAttribute("givenName", attrs.get("givenName").concat("-workaround"));",
        "      setTransientObjectAttribute("sn", attrs.get("sn").concat("-workaround"));",
        "      setTransientObjectAttribute("mail", attrs.get("mail").concat("-workaround"));",
        "}",
        "",
        "/*",
        " * Store attributes in transient state for use with the Create/Patch Object nodes.",
        " */",
        "function setTransientObjectAttribute(name, value) {",
        "    var transientStorage = transientState.get("objectAttributes");",
        "    if (transientStorage && value) {",
        "          if (transientStorage.put) {",
        "            transientStorage.put(name, value);",
        "        }",
        "          else {",
        "            transientStorage[name] = value;",
        "        }",
        "    }",
        "    else if (value) {",
        "    transientState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "    }",
        "}",
      ],
    },
    "e15a13ee-9168-40cf-934f-656a5f568a6a": {
      "_id": "e15a13ee-9168-40cf-934f-656a5f568a6a",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "hashdeviceProfile",
      "script": [
        "/*",
        "  - Data made available by nodes that have already executed are available in the sharedState variable.",
        "  - The script should set outcome to either "true" or "false".",
        " */",
        "",
        "//<script type="text/javascript" src="http://www.myersdaily.org/joseph/javascript/md5.js" />",
        "",
        "function hashCode(r){var e,h=0;for(e=0;e<r.length;e++)h=(h<<5)-h+r.charCodeAt(e),h|=0;return h>>>0}",
        "",
        "",
        "var hashMe = sharedState.get("forgeRock.device.profile");",
        "var hashMe = sharedState.put("forgeRock.device.profile","deleted in script - hashdeviceProfile");",
        "//var hashMeStr = JSON.stringify(hashMe);",
        "//logger.error("HashMeStr: " + hashMeStr);",
        "",
        "sharedState.put("deviceHash",hashCode(escape(hashMe)).toString());",
        "sharedState.put("frIndexedString1",hashCode(escape(hashMe)).toString());",
        "",
        "outcome = "true";",
      ],
    },
    "e1db8a0a-0329-4962-a5bf-ecffaca376ae": {
      "_id": "e1db8a0a-0329-4962-a5bf-ecffaca376ae",
      "context": "OIDC_CLAIMS",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Used by endUserUIClient",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Alpha endUserUIClient OIDC Claims Script",
      "script": [
        "/*",
        " * Copyright 2014-2021 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        " * This script computes claim values returned in ID tokens and/or at the UserInfo Endpoint.",
        " * The claim values are computed for:",
        " * the claims derived from the requested scopes,",
        " * the claims provided by the authorization server,",
        " * and the claims requested by the client via the claims parameter.",
        " *",
        " * In the CONFIGURATION AND CUSTOMIZATION section, you can",
        " * define the scope-to-claims mapping, and",
        " * assign to each claim a resolver function that will compute the claim value.",
        " *",
        " * Defined variables (class references are provided below):",
        " * scopes - Set<String> (6).",
        " *          Always present, the requested scopes.",
        " * claims - Map<String, Object> (5).",
        " *          Always present, default server provided claims.",
        " * claimObjects - List<Claim> (7, 2).",
        " *                Always present, the default server provided claims.",
        " * requestedClaims - Map<String, Set<String>> (5).",
        " *                   Always present, not empty if the request contains the claims parameter and the server has enabled",
        " *                   claims_parameter_supported. A map of the requested claims to possible values, otherwise empty;",
        " *                   requested claims with no requested values will have a key but no value in the map. A key with",
        " *                   a single value in its Set (6) indicates that this is the only value that should be returned.",
        " * requestedTypedClaims - List<Claim> (7, 2).",
        " *                        Always present, the requested claims.",
        " *                        Requested claims with no requested values will have a claim with no values.",
        " *                        A claim with a single value indicates this is the only value that should be returned.",
        " * claimsLocales - List<String> (7).",
        " *                 The values from the 'claims_locales' parameter.",
        " *                 See https://openid.net/specs/openid-connect-core-1_0.html#ClaimsLanguagesAndScripts for the OIDC specification details.",
        " * requestProperties - Unmodifiable Map (5).",
        " *                     Always present, contains a map of request properties:",
        " *                     requestUri - The request URI.",
        " *                     realm - The realm that the request relates to.",
        " *                     requestParams - A map of the request params and/or posted data.",
        " *                                     Each value is a list of one or more properties.",
        " *                                     Please note that these should be handled in accordance with OWASP best practices:",
        " *                                     https://owasp.org/www-community/vulnerabilities/Unsafe_use_of_Reflection.",
        " * clientProperties - Unmodifiable Map (5).",
        " *                    Present if the client specified in the request was identified, contains a map of client properties:",
        " *                    clientId - The client's URI for the request locale.",
        " *                    allowedGrantTypes - List of the allowed grant types (org.forgerock.oauth2.core.GrantType) for the client.",
        " *                    allowedResponseTypes - List of the allowed response types for the client.",
        " *                    allowedScopes - List of the allowed scopes for the client.",
        " *                    customProperties - A map of the custom properties of the client.",
        " *                                       Lists or maps will be included as sub-maps; for example:",
        " *                                       customMap[Key1]=Value1 will be returned as customMap -> Key1 -> Value1.",
        " *                                       To add custom properties to a client, update the Custom Properties field",
        " *                                       in AM Console > Realm Name > Applications > OAuth 2.0 > Clients > Client ID > Advanced.",
        " * identity - AMIdentity (3).",
        " *            Always present, the identity of the resource owner.",
        " * session - SSOToken (4).",
        " *           Present if the request contains the session cookie, the user's session object.",
        " * scriptName - String (primitive).",
        " *              Always present, the display name of the script.",
        " * logger - Always present, the "OAuth2Provider" debug logger instance:",
        " *          https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-logger.html#scripting-api-global-logger.",
        " *          Corresponding files will be prefixed with: scripts.OIDC_CLAIMS.",
        " * httpClient - HTTP Client (8).",
        " *              Always present, the HTTP Client instance:",
        " *              https://backstage.forgerock.com/docs/am/7/scripting-guide/scripting-api-global-http-client.html#scripting-api-global-http-client.",
        " *              In order to use the client, you may need to add",
        " *              org.forgerock.http.Client,",
        " *              org.forgerock.http.protocol.*,",
        " *              and org.forgerock.util.promise.PromiseImpl",
        " *              to the allowed Java classes in the scripting engine configuration, as described in:",
        " *              https://backstage.forgerock.com/docs/am/7/scripting-guide/script-engine-security.html",
        " *",
        " * Return - a new UserInfoClaims(Map<String, Object> values, Map<String, List<String>> compositeScopes) (1) object.",
        " *          The result of the last statement in the script is returned to the server.",
        " *          Currently, the Immediately Invoked Function Expression (also known as Self-Executing Anonymous Function)",
        " *          is the last (and only) statement in this script, and its return value will become the script result.",
        " *          Do not use "return variable" statement outside of a function definition.",
        " *          See RESULTS section for additional details.",
        " *",
        " * Class reference:",
        " * (1) UserInfoClaims - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html.",
        " * (2) Claim - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html).",
        " *         An instance of org.forgerock.openidconnect.Claim has methods to access",
        " *         the claim name, requested values, locale, and whether the claim is essential.",
        " * (3) AMIdentity - https://backstage.forgerock.com/docs/am/7/apidocs/com/sun/identity/idm/AMIdentity.html.",
        " * (4) SSOToken - https://backstage.forgerock.com/docs/am/7/apidocs/com/iplanet/sso/SSOToken.html.",
        " * (5) Map - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashMap.html,",
        " *           or https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/LinkedHashMap.html.",
        " * (6) Set - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/HashSet.html.",
        " * (7) List - https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/ArrayList.html.",
        " * (8) Client - https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/http/Client.html.",
        "*/",
        "",
        "(function () {",
        "    // SETUP",
        "",
        "    /**",
        "     * Claim processing utilities.",
        "     * An object that contains reusable functions for processing claims.",
        "     * @see CLAIM PROCESSING UTILITIES section for details.",
        "     */",
        "    var utils = getUtils();",
        "",
        "    // CONFIGURATION AND CUSTOMIZATION",
        "",
        "    /**",
        "     * OAuth 2.0 scope values (scopes) can be used by the Client to request OIDC claims.",
        "     *",
        "     * Call this configuration method, and pass in as the first argument",
        "     * an object that maps a scope value to an array of claim names",
        "     * to specify which claims need to be processed and returned for the requested scopes.",
        "     * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#ScopeClaims}",
        "     * for the scope values that could be used to request claims as defined in the OIDC specification.",
        "     *",
        "     * Below, find a default configuration that is expected to work in the current environment.",
        "     *",
        "     * CUSTOMIZATION",
        "     * You can choose the claim names returned for a scope.",
        "     */",
        "    utils.setScopeClaimsMap({",
        "        profile: [",
        "            'name',",
        "            'family_name',",
        "            'given_name',",
        "            'zoneinfo',",
        "            'locale'",
        "        ],",
        "        email: ['email'],",
        "        address: ['address'],",
        "        phone: ['phone_number']",
        "    });",
        "",
        "    /**",
        "     * In this script, each claim",
        "     * derived from the requested scopes,",
        "     * provided by the authorization server, and",
        "     * requested by the client via the claims parameter",
        "     * will be processed by a function associated with the claim name.",
        "     *",
        "     * Call this configuration method, and pass in as the first argument",
        "     * an object that maps a claim name to a resolver function,",
        "     * which will be automatically executed for each claim processed by the script.",
        "     *",
        "     * The claim resolver function will receive the requested claim information",
        "     * in an instance of org.forgerock.openidconnect.Claim as the first argument.",
        "     * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html}",
        "     * for details on the Claim class.",
        "     *",
        "     * If the claim resolver function returns a value,",
        "     * other than undefined or null,",
        "     * the claim will be included in the script's results.",
        "     *",
        "     * The Claim instance provides methods to check",
        "     * what the name of the claim is,",
        "     * which values the claim request contains,",
        "     * whether the claim is essential, and",
        "     * which locale the claim is associated with.",
        "     * The resolver function can consider this information when computing and returning the claim value.",
        "     *",
        "     * Below, find a default configuration that is expected to work in the current environment.",
        "     * A reusable function, utils.getUserProfileClaimResolver(String attribute-name),",
        "     * is called to return a claim resolver function based on a user profile attribute.",
        "     * @see CLAIM RESOLVERS section for the implementation details and examples.",
        "     * For the address claim, an example of a claim resolver that uses another claim resolver is provided.",
        "     *",
        "     * CUSTOMIZATION",
        "     * You can reuse the predefined utils methods with your custom arguments.",
        "     * You can also specify a custom resolver function for a claim name,",
        "     * that will compute and return the claim value—as shown in the commented out example below.",
        "     */",
        "    utils.setClaimResolvers({",
        "        /*",
        "        // An example of a simple claim resolver function that is defined for a claim",
        "        // directly in the configuration object:",
        "        custom-claim-name: function (requestedClaim) {",
        "            // In this case, initially, the claim value comes straight from a user profile attribute value:",
        "            var claimValue = identity.getAttribute('custom-attribute-name').toArray()[0]",
        "",
        "            // Optionally, provide additional logic for processing (filtering, formatting, etc.) the claim value.",
        "            // You can use:",
        "            // requestedClaim.getName()",
        "            // requestedClaim.getValues()",
        "            // requestedClaim.getLocale()",
        "            // requestedClaim.isEssential()",
        "",
        "            return claimValue",
        "        },",
        "        */",
        "        /**",
        "         * The use of utils.getUserProfileClaimResolver shows how",
        "         * an argument passed to a function that returns a claim resolver",
        "         * becomes available to the resolver function (via its lexical context).",
        "         */",
        "        name: utils.getUserProfileClaimResolver('cn'),",
        "        family_name: utils.getUserProfileClaimResolver('sn'),",
        "        given_name: utils.getUserProfileClaimResolver('givenname'),",
        "        zoneinfo: utils.getUserProfileClaimResolver('preferredtimezone'),",
        "        locale: utils.getUserProfileClaimResolver('preferredlocale'),",
        "        email: utils.getUserProfileClaimResolver('mail'),",
        "        address: utils.getAddressClaimResolver(",
        "            /**",
        "             * The passed in user profile claim resolver function",
        "             * can be used by the address claim resolver function",
        "             * to obtain the claim value to be formatted as per the OIDC specification:",
        "             * @see https://openid.net/specs/openid-connect-core-1_0.html#AddressClaim.",
        "             */",
        "            utils.getUserProfileClaimResolver('postaladdress')",
        "        ),",
        "        phone_number: utils.getUserProfileClaimResolver('telephonenumber')",
        "    });",
        "",
        "    // CLAIM PROCESSING UTILITIES",
        "",
        "    /**",
        "     * @returns {object} An object that contains reusable claim processing utilities.",
        "     * @see PUBLIC METHODS section and the return statement for the list of exported functions.",
        "     */",
        "    function getUtils () {",
        "        // IMPORT JAVA",
        "",
        "        /**",
        "         * Provides Java scripting functionality.",
        "         * @see {@link https://developer.mozilla.org/en-US/docs/Mozilla/Projects/Rhino/Scripting_Java#javaimporter_constructor}.",
        "         */",
        "        var frJava = JavaImporter(",
        "            org.forgerock.oauth2.core.exceptions.InvalidRequestException,",
        "            org.forgerock.oauth2.core.UserInfoClaims,",
        "            org.forgerock.openidconnect.Claim,",
        "",
        "            java.util.LinkedHashMap,",
        "            java.util.ArrayList",
        "        );",
        "",
        "        // SET UP CONFIGURATION",
        "",
        "        /**",
        "         * Placeholder for a configuration option that contains",
        "         * an object that maps the supported scope values (scopes)",
        "         * and the corresponding claim names for each scope value.",
        "         */",
        "        var scopeClaimsMap;",
        "",
        "        /**",
        "         * Placeholder for a configuration option that contains",
        "         * an object that maps the supported claim names",
        "         * and the resolver functions returning the claim value.",
        "         */",
        "        var claimResolvers;",
        "",
        "        /**",
        "         * A (public) method that accepts an object that maps the supported scopes and the corresponding claim names,",
        "         * and assigns it to a (private) variable that serves as a configuration option.",
        "         * @param {object} params - An object that maps each supported scope value to an array of claim names,",
        "         * in order to specify which claims need to be processed for the requested scopes.",
        "         * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#ScopeClaims} for details.",
        "         * @param {string[]} [params.profile] - An array of claim names to be returned if the profile scope is requested.",
        "         * @param {string[]} [params.email] - An array of claim names to be returned if the email scope is requested.",
        "         * @param {string[]} [params.address] - An array of claim names to be returned if the address scope is requested.",
        "         * @param {string[]} [params.phone] - An array of claim names to be returned if the phone scope is requested.",
        "         * @returns {undefined}",
        "         */",
        "        function setScopeClaimsMap(params) {",
        "            scopeClaimsMap = params;",
        "        }",
        "",
        "        /**",
        "         * A (public) method that accepts an object that maps the supported claim names",
        "         * and the resolver functions returning the claim value,",
        "         * and assigns it to a (private) variable that serves as a configuration option.",
        "         * @param {object} params - An object that maps",
        "         * each supported claim name to a function that computes and returns the claim value.",
        "         */",
        "        function setClaimResolvers(params) {",
        "            claimResolvers = params;",
        "        }",
        "",
        "        // CLAIM RESOLVERS",
        "",
        "        /**",
        "         * Claim resolvers are functions that return a claim value.",
        "         * @param {*}",
        "         * @returns {*}",
        "         */",
        "",
        "        /**",
        "         * Defines a claim resolver based on a user profile attribute.",
        "         * @param {string} attributeName - Name of the user profile attribute.",
        "         * @returns {function} A function that will determine the claim value",
        "         * based on the user profile attribute and the (requested) claim properties.",
        "         */",
        "        function getUserProfileClaimResolver (attributeName) {",
        "            /**",
        "             * Resolves a claim with a user profile attribute value.",
        "             * Returns undefined if the identity attribute is not populated,",
        "             * OR if the claim has requested values that do not contain the identity attribute value.",
        "             * ATTENTION: the aforementioned comparison is case-sensitive.",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {string|HashSet|undefined}",
        "             */",
        "            function resolveClaim(claim) {",
        "                var userProfileValue;",
        "",
        "                if (identity) {",
        "                    userProfileValue = getClaimValueFromSet(claim, identity.getAttribute(attributeName));",
        "",
        "                    if (userProfileValue && !userProfileValue.isEmpty()) {",
        "                        if (!claim.getValues() || claim.getValues().isEmpty() || claim.getValues().contains(userProfileValue)) {",
        "                            return userProfileValue;",
        "                        }",
        "                    }",
        "                }",
        "            }",
        "",
        "            return resolveClaim;",
        "        }",
        "",
        "        /**",
        "         * Returns an address claim resolver based on a claim value obtained with another claim resolver.",
        "         * @param {function} resolveClaim - A function that returns a claim value.",
        "         * @returns {function} A function that will accept a claim as an argument,",
        "         * run the claim resolver function for the claim and obtain the claim value,",
        "         * and apply additional formatting to the value before returning it.",
        "         */",
        "        function getAddressClaimResolver (resolveClaim) {",
        "            /**",
        "             * Creates an address claim object from a value returned by a claim resolver,",
        "             * and returns the address claim object as the claim value.",
        "             * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#AddressClaim}.",
        "             * The claim value is obtained with a claim resolving function available from the closure.",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {java.util.LinkedHashMap|undefined} The address claim object created from a claim value.",
        "             */",
        "            function resolveAddressClaim(claim) {",
        "                var claimValue = resolveClaim(claim);",
        "                var addressObject;",
        "",
        "                if (isClaimValueValid(claimValue)) {",
        "                    addressObject = new frJava.LinkedHashMap();",
        "",
        "                    addressObject.put('formatted', claimValue);",
        "",
        "                    return addressObject;",
        "                }",
        "            }",
        "",
        "            return resolveAddressClaim;",
        "        }",
        "",
        "        /**",
        "         * Returns an essential claim resolver based on a claim value obtained with another claim resolver.",
        "         * @param {function} resolveClaim - A function that returns a claim value.",
        "         * @returns {function} A function that will accept a claim as an argument,",
        "         * run the claim resolver function for the claim and obtain the claim value,",
        "         * and apply additional logic for essential claims.",
        "         */",
        "        function getEssentialClaimResolver (resolveClaim) {",
        "            /**",
        "             * Returns a claim value or throws an error.",
        "             * The claim value is obtained with a claim resolving function available from the closure.",
        "             * Throws an exception if the claim is essential and no value is returned for the claim.",
        "             *",
        "             * Use of this resolver is optional.",
        "             * @see {@link https://openid.net/specs/openid-connect-core-1_0.html#IndividualClaimsRequests} stating:",
        "             * "Note that even if the Claims are not available because the End-User did not authorize their release or they are not present,",
        "             * the Authorization Server MUST NOT generate an error when Claims are not returned, whether they are Essential or Voluntary,",
        "             * unless otherwise specified in the description of the specific claim."",
        "             *",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {*}",
        "             * @throws {org.forgerock.oauth2.core.exceptions.InvalidRequestException}",
        "             */",
        "            function resolveEssentialClaim(claim) {",
        "                var claimValue = resolveClaim(claim);",
        "",
        "                if (claim.isEssential() && !isClaimValueValid(claimValue)) {",
        "                    throw new frJava.InvalidRequestException('Could not provide value for essential claim: ' + claim.getName());",
        "                }",
        "",
        "                return claimValue;",
        "            }",
        "",
        "            return resolveEssentialClaim;",
        "        }",
        "",
        "        /**",
        "         * Provides default resolution for a claim.",
        "         * Use it if a claim-specific resolver is not defined in the configuration.",
        "         * @param {org.forgerock.openidconnect.Claim} claim",
        "         * An object that provides methods to obtain information/requirements associated with a claim.",
        "         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "         * @returns {*} A single value associated with this claim.",
        "         */",
        "        function resolveAnyClaim (claim) {",
        "            if (claim.getValues().size() === 1) {",
        "                return claim.getValues().toArray()[0];",
        "            }",
        "        }",
        "",
        "        // UTILITIES",
        "",
        "        /**",
        "         * Returns claim value from a set.",
        "         * If the set contains a single value, returns the value.",
        "         * If the set contains multiple values, returns the set.",
        "         * Otherwise, returns undefined.",
        "         *",
        "         * @param {org.forgerock.openidconnect.Claim} claim",
        "         * An object that provides methods to obtain information/requirements associated with a claim.",
        "         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "         * @param {java.util.HashSet} set The set—for example, a user profile attribute value.",
        "         * @returns {string|java.util.HashSet|undefined}",
        "         */",
        "        function getClaimValueFromSet (claim, set) {",
        "            if (set && set.size()) {",
        "                if (set.size() === 1) {",
        "                    return set.toArray()[0];",
        "                } else {",
        "                    return set;",
        "                }",
        "            } else if (logger.warningEnabled()) {",
        "                logger.warning('OIDC Claims script. Got an empty set for claim: ' + claim.getName());",
        "            }",
        "        }",
        "",
        "        function isClaimValueValid (claimValue) {",
        "            if (typeof claimValue === 'undefined' || claimValue === null) {",
        "                return false;",
        "            }",
        "",
        "            return true;",
        "        }",
        "",
        "        // CLAIM PROCESSING",
        "",
        "        /**",
        "         * Constructs and returns an object populated with the computed claim values",
        "         * and the requested scopes mapped to the claim names.",
        "         * @returns {org.forgerock.oauth2.core.UserInfoClaims} The object to be returned to the authorization server.",
        "         * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html}.",
        "         * @see RESULTS section for the use of this function.",
        "         */",
        "        function getUserInfoClaims () {",
        "            return new frJava.UserInfoClaims(getComputedClaims(), getCompositeScopes());",
        "        }",
        "",
        "        /**",
        "         * Creates a map of (requested) claim names populated with the computed claim values.",
        "         * @returns {java.util.LinkedHashMap}",
        "         * A map of the requested claim names and the corresponding claim values.",
        "         */",
        "        function getComputedClaims () {",
        "            /**",
        "             * Creates a complete list of claim objects from:",
        "             * the claims derived from the scopes,",
        "             * the claims provided by the authorization server,",
        "             * and the claims requested by the client.",
        "             * @returns {java.util.ArrayList}",
        "             * Returns a complete list of org.forgerock.openidconnect.Claim objects available to the script.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for the claim object details.",
        "             */",
        "            function getClaims() {",
        "                /**",
        "                 * Returns a list of claim objects for the requested scopes.",
        "                 * Uses the scopeClaimsMap configuration option to derive the claim names;",
        "                 * no other properties of a claim derived from a scope are populated.",
        "                 * @returns {java.util.ArrayList}",
        "                 * A list of org.forgerock.openidconnect.Claim objects derived from the requested scopes.",
        "                 * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for the claim object details.",
        "                 */",
        "                function convertScopeToClaims() {",
        "                    var claims = new frJava.ArrayList();",
        "",
        "                    scopes.toArray().forEach(function (scope) {",
        "                        if (String(scope) !== 'openid' && scopeClaimsMap[scope]) {",
        "                            scopeClaimsMap[scope].forEach(function (claimName) {",
        "                                claims.add(new frJava.Claim(claimName));",
        "                            });",
        "                        }",
        "                    });",
        "",
        "                    return claims;",
        "                }",
        "",
        "                var claims = new frJava.ArrayList();",
        "",
        "                claims.addAll(convertScopeToClaims());",
        "                claims.addAll(claimObjects);",
        "                claims.addAll(requestedTypedClaims);",
        "",
        "                return claims;",
        "            }",
        "",
        "            /**",
        "             * Computes and returns a claim value.",
        "             * To obtain the claim value, uses the resolver function specified for the claim in the claimResolvers configuration object.",
        "             * @see claimResolvers",
        "             * If no resolver function is found, uses the default claim resolver function.",
        "             *",
        "             * @param {org.forgerock.openidconnect.Claim} claim",
        "             * An object that provides methods to obtain information/requirements associated with a claim.",
        "             * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/openidconnect/Claim.html} for details.",
        "             * @returns {*} Claim value.",
        "             * @throws {org.forgerock.oauth2.core.exceptions.InvalidRequestException}",
        "             * Rethrows this exception if a claim resolver throws it.",
        "             * You can throw org.forgerock.oauth2.core.exceptions.InvalidRequestException from your custom claim resolver",
        "             * if you want to terminate the claim processing.",
        "             */",
        "            function computeClaim(claim) {",
        "                var resolveClaim;",
        "                var message;",
        "",
        "                try {",
        "                    resolveClaim = claimResolvers[claim.getName()] || resolveAnyClaim;",
        "",
        "                    return resolveClaim(claim);",
        "                } catch (e) {",
        "                    message = 'OIDC Claims script exception. Unable to resolve OIDC Claim. ' + e;",
        "",
        "                    if (String(e).indexOf('org.forgerock.oauth2.core.exceptions.InvalidRequestException') !== -1) {",
        "                        throw e;",
        "                    }",
        "",
        "                    if (logger.warningEnabled()) {",
        "                        logger.warning(message);",
        "                    }",
        "                }",
        "            }",
        "",
        "            var computedClaims = new frJava.LinkedHashMap();",
        "",
        "            getClaims().toArray().forEach(function (claim) {",
        "                var claimValue = computeClaim(claim);",
        "",
        "                if (isClaimValueValid(claimValue)) {",
        "                    computedClaims.put(claim.getName(), claimValue);",
        "                } else {",
        "                    /**",
        "                     * If a claim has been processed, but appears in the list again,",
        "                     * and its value cannot be computed under the new conditions,",
        "                     * the claim is removed from the final result.",
        "                     *",
        "                     * For example, a claim could be mapped to a scope and found in the user profile,",
        "                     * but also requested by the client with required values that don't match the computed one.",
        "                     * @see {link https://openid.net/specs/openid-connect-core-1_0.html#IndividualClaimsRequests}.",
        "                     * for the relevant OIDC specification details.",
        "                     */",
        "                    computedClaims.remove(claim.getName());",
        "                }",
        "            });",
        "",
        "            return computedClaims;",
        "        }",
        "",
        "        /**",
        "         * Creates a map of requested scopes and the corresponding claim names.",
        "         * @returns {java.util.LinkedHashMap}",
        "         */",
        "        function getCompositeScopes () {",
        "            var compositeScopes = new frJava.LinkedHashMap();",
        "",
        "            scopes.toArray().forEach(function (scope) {",
        "                var scopeClaims = new frJava.ArrayList();",
        "",
        "                if (scopeClaimsMap[scope]) {",
        "                    scopeClaimsMap[scope].forEach(function (claimName) {",
        "                        scopeClaims.add(claimName);",
        "                    });",
        "                }",
        "",
        "                if (scopeClaims.size()) {",
        "                    compositeScopes.put(scope, scopeClaims);",
        "                }",
        "            });",
        "",
        "            return compositeScopes;",
        "        }",
        "",
        "        // PUBLIC METHODS",
        "",
        "        return {",
        "            setScopeClaimsMap: setScopeClaimsMap,",
        "            setClaimResolvers: setClaimResolvers,",
        "            getUserProfileClaimResolver: getUserProfileClaimResolver,",
        "            getAddressClaimResolver: getAddressClaimResolver,",
        "            getEssentialClaimResolver: getEssentialClaimResolver,",
        "            getUserInfoClaims: getUserInfoClaims",
        "        };",
        "    }",
        "",
        "    // RESULTS",
        "",
        "    /**",
        "     * This script returns an instance of the org.forgerock.oauth2.core.UserInfoClaims class",
        "     * populated with the computed claim values and",
        "     * the requested scopes mapped to the claim names.",
        "     * @see {@link https://backstage.forgerock.com/docs/am/7/apidocs/org/forgerock/oauth2/core/UserInfoClaims.html}.",
        "     *",
        "     * Assigning it to a variable gives you an opportunity",
        "     * to log the content of the returned value during development.",
        "     */",
        "    var userInfoClaims = utils.getUserInfoClaims();",
        "",
        "    /*",
        "    logger.error(scriptName + ' results:')",
        "    logger.error('Values: ' + userInfoClaims.getValues())",
        "    logger.error('Scopes: ' + userInfoClaims.getCompositeScopes())",
        "    */",
        "",
        "    return userInfoClaims;",
        "}());",
      ],
    },
    "e232cff3-2460-47cd-80b2-36c86c0d0f06": {
      "_id": "e232cff3-2460-47cd-80b2-36c86c0d0f06",
      "context": "OAUTH2_ACCESS_TOKEN_MODIFICATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Used by endUserUIClient",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Alpha endUserUIClient OAuth2 Access Token Modification Script",
      "script": [
        "(function () {",
        "  if (scopes.contains('fr:autoaccess:*') || scopes.contains('fr:iga:*')) {",
        "    var fr = JavaImporter(",
        "      com.sun.identity.idm.IdType",
        "    );",
        "    var groups = [];",
        "    identity.getMemberships(fr.IdType.GROUP).toArray().forEach(function (group) {",
        "      groups.push(group.getAttribute('cn').toArray()[0]);",
        "    });",
        "    accessToken.setField('groups', groups);",
        "  }",
        "}());",
        "",
      ],
    },
    "e4417108-4dc9-4ffc-9995-3cd490adf2ed": {
      "_id": "e4417108-4dc9-4ffc-9995-3cd490adf2ed",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Collect PIN",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Collect PIN",
      "script": [
        "/* Collect PIN",
        " * ",
        " * Collect PIN using password callback and store in user profile.",
        " * ",
        " * This script must be parametrized. It may not work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "  ",
        "  /*** BEGIN PARAMETRIZATION ***/",
        "  var pinAttrName = 'frUnindexedString3';",
        "  var pinPrompt = 'New PIN';",
        "  /**** END PARAMETRIZATION ****/",
        "  ",
        "  outcome = 'true';",
        "  var fr = JavaImporter(",
        "    org.forgerock.openam.auth.node.api.Action,",
        "      javax.security.auth.callback.PasswordCallback",
        "  )",
        "  if (callbacks.isEmpty()) {",
        "    action = fr.Action.send(",
        "      new fr.PasswordCallback(pinPrompt, false)",
        "    ).build();",
        "  }",
        "  else {",
        "      var pin = new java.lang.String(callbacks.get(0).getPassword());",
        "    setTransientObjectAttribute(pinAttrName, pin);",
        "    action = fr.Action.goTo(outcome).build();",
        "  }",
        "",
        "  /*",
        "   * Store attributes in transient state for use with the Create/Patch Object nodes.",
        "   */",
        "  function setTransientObjectAttribute(name, value) {",
        "    var transientStorage = transientState.get("objectAttributes");",
        "    if (transientStorage && value) {",
        "      if (transientStorage.put) {",
        "        transientStorage.put(name, value);",
        "      }",
        "      else {",
        "        transientStorage[name] = value;",
        "      }",
        "    }",
        "    else if (value) {",
        "      transientState.put("objectAttributes", JSON.parse("{\\""+name+"\\":\\""+value+"\\"}"));",
        "    }",
        "  }",
        "}());",
      ],
    },
    "e49225eb-e7ad-4699-bf2a-d57689f9cd6e": {
      "_id": "e49225eb-e7ad-4699-bf2a-d57689f9cd6e",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Display sharedState and transientState.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Display States - imported (1)",
      "script": [
        "/* Display States",
        " * ",
        " * Display sharedState and transientState.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "    outcome = "true";",
        "",
        "    var anchor = "anchor-".concat(generateNumericToken('xxx'));",
        "    var halign = "left";",
        "    var message = "<h4>Current State Values</h4>".concat(",
        "        "<p><b>Shared State</b>:<br/>").concat(",
        "        sharedState.toString()).concat("</p>").concat(",
        "        "<p><b>Transient State</b>:<br/>").concat(",
        "        transientState.toString()).concat("</p>").concat(",
        "        "<p><b>Request Headers</b>:<br/>").concat(",
        "        requestHeaders.toString()).concat("</p>")",
        "    var script = "Array.prototype.slice.call(\\n".concat(",
        "      "document.getElementsByClassName('callback-component')).forEach(\\n").concat(",
        "      "function (e) {\\n").concat(",
        "      "  var message = e.firstElementChild;\\n").concat(",
        "      "  if (message.firstChild && message.firstChild.nodeName == '#text' && message.firstChild.nodeValue.trim() == '").concat(anchor).concat("') {\\n").concat(",
        "      "    message.className = \\"\\";\\n").concat(",
        "      "    message.style = \\"text-align: left; inline-size: 430px; overflow-wrap: break-word;\\";\\n").concat(",
        "      "    message.align = \\"").concat(halign).concat("\\";\\n").concat(",
        "      "    message.innerHTML = '").concat(message).concat("';\\n").concat(",
        "      "  }\\n").concat(",
        "      "})")",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "        javax.security.auth.callback.TextOutputCallback,",
        "        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        "    )",
        "    if (message.length && callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "            new fr.TextOutputCallback(",
        "                fr.TextOutputCallback.INFORMATION,",
        "                anchor",
        "            ),",
        "            new fr.ScriptTextOutputCallback(script)",
        "        ).build()",
        "    }",
        "    else {",
        "      action = fr.Action.goTo(outcome).build();",
        "    }",
        "",
        "     /*",
        "      * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "      * ",
        "      * Example:",
        "      * 'xxxxx' produces '28535'",
        "      * 'xxx-xxx' produces '432-521'",
        "      */",
        "    function generateNumericToken(format) {",
        "        return format.replace(/[x]/g, function(c) {",
        "            var r = Math.random()*10|0;",
        "            var v = r;",
        "            return v.toString(10);",
        "        });",
        "    }",
        "}());",
      ],
    },
    "e9c9d940-30d9-4a0c-a834-7de69a0600cf": {
      "_id": "e9c9d940-30d9-4a0c-a834-7de69a0600cf",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_CollectUsernameOrEmail",
      "script": [
        "var fr = JavaImporter(",
        "  org.forgerock.json.JsonValue,",
        "  org.forgerock.openam.auth.node.api.Action,",
        "  javax.security.auth.callback.NameCallback,",
        "  java.util.HashMap",
        ");",
        "",
        "with (fr) {",
        "  try {",
        "    ",
        "    if (callbacks.isEmpty()) {",
        "      ",
        "      action = Action.send(new NameCallback('Username or email address')).build();",
        "      ",
        "    } else {",
        "",
        "      // If a value is provided, store it as username and an object attribute",
        "      var callback = callbacks.iterator().next();",
        "      var name = callback.getName().trim();",
        "      if (name) {",
        "        var objAttrs = sharedState.get('objectAttributes') || new HashMap();",
        "        objAttrs.put('mail', name);",
        "        sharedState.put('username', name);",
        "        sharedState.put('objectAttributes', objAttrs);",
        "",
        "        action = Action.goTo('Collected').build();",
        "      }",
        "      ",
        "    }",
        "    ",
        "  } catch (e) {",
        "    ",
        "    logger.error('Admin_CollectUsernameOrEmail: {}', e);",
        "    action = Action.goTo('Error').build();",
        "    ",
        "  }",
        "}",
      ],
    },
    "ec8b314c-8e11-4364-93b9-a3e82d2a074a": {
      "_id": "ec8b314c-8e11-4364-93b9-a3e82d2a074a",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Display Password from nodeState",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Display Password",
      "script": [
        "/* Display Password",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Display Password collected via Platform Password node.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "var password = "unable to retrieve!";",
        "if (nodeState.get("password")) {",
        "  password = nodeState.get("password").asString();",
        "}",
        "var fr = JavaImporter(",
        "    org.forgerock.openam.auth.node.api.Action,",
        "    javax.security.auth.callback.TextOutputCallback",
        ")",
        "if (callbacks.isEmpty()) {",
        "    action = fr.Action.send(",
        "        new fr.TextOutputCallback(",
        "            fr.TextOutputCallback.INFORMATION,",
        "            password",
        "        )",
        "    ).build()",
        "}",
        "else {",
        "  action = fr.Action.goTo("true").build();",
        "}",
      ],
    },
    "ed685f9f-5909-4726-86e8-22bd38b47663": {
      "_id": "ed685f9f-5909-4726-86e8-22bd38b47663",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Converts a normalized social profile into an Identity",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Normalized Profile to Identity",
      "script": [
        "/*",
        " * Copyright 2021 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "import org.forgerock.json.JsonValue",
        "",
        "JsonValue identity = json(object(",
        "        field("givenName", normalizedProfile.givenName),",
        "        field("sn", normalizedProfile.familyName),",
        "        field("mail", normalizedProfile.email),",
        "        field("cn", normalizedProfile.displayName),",
        "        field("userName", normalizedProfile.username),",
        "        field("iplanet-am-user-alias-list", selectedIdp + '-' + normalizedProfile.id.asString())))",
        "",
        "return identity",
      ],
    },
    "f1a2764b-d05a-4480-8f5f-78fda7814227": {
      "_id": "f1a2764b-d05a-4480-8f5f-78fda7814227",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "APIProtection: Reset State",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "APIProtection: Reset States",
      "script": [
        "logger.warning("APIProtection: Reset States: start");",
        "",
        "/*",
        " * BEGIN SCRIPT CONFIGURATION",
        " *",
        " * Outcomes:",
        " * - "true"",
        " */",
        "var KEY_HEADER_NAME = "x-api-key";",
        "var SECRET_HEADER_NAME = "x-api-secret";",
        "/*",
        " * END SCRIPT CONFIGURATION",
        " */",
        "",
        "outcome = "true";",
        "",
        "if (sharedState.get("username") == readValue(KEY_HEADER_NAME)) {",
        "    logger.warning("APIProtection: Reset States: resetting username to:".concat(readValue("username")));",
        "      sharedState.put("username", readValue("username"));",
        "}",
        "",
        "if (transientState.get("password") == readTransientValue(SECRET_HEADER_NAME)) {",
        "    logger.warning("APIProtection: Reset States: resetting password");",
        "      transientState.put("password", readTransientValue("password"));",
        "}",
        "",
        "logger.warning("APIProtection: Reset States: finish [outcome=".concat(outcome).concat("]"));",
        "",
        "/*",
        " * Read value from storage for APIProtection script use",
        " */",
        "function readValue(name) {",
        "      var storage = sharedState.get("APIProtection");",
        "    if (storage) {",
        "          if (storage.get) {",
        "            return sharedState.get("APIProtection").get(name);",
        "        }",
        "          else {",
        "              return storage.name;",
        "        }",
        "    }",
        "      return null;",
        "}",
        "",
        "/*",
        " * Read transient value from storage for APIProtection script use",
        " */",
        "function readTransientValue(name) {",
        "      var transientStorage = transientState.get("APIProtection");",
        "    if (transientStorage) {",
        "          if (transientStorage.get) {",
        "            return transientState.get("APIProtection").get(name);",
        "        }",
        "          else {",
        "              return transientStorage.name;",
        "        }",
        "    }",
        "      return null;",
        "}",
      ],
    },
    "f2107949-22f8-46c4-865d-ae1d1110a9cb": {
      "_id": "f2107949-22f8-46c4-865d-ae1d1110a9cb",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Detect and preserve currently active theme before setting the new theme.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Set OATH Theme",
      "script": [
        "/* Set OATH Theme",
        " * ",
        " * Detect and preserve currently active theme before setting the new theme.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " */",
        "(function () {",
        "      outcome = "true";",
        "      ",
        "      var theme = "Expanse_OATH";",
        "",
        "    // do not change, must be a random identifier",
        "    var anchor = generateNumericToken('xxx');",
        "  ",
        "      var script = "";",
        "    script += "document.getElementById(\\"theme-id-"+anchor+"\\").value = localStorage.getItem('theme-id');";",
        "    script += "console.log('theme-id='+document.getElementById(\\"theme-id-"+anchor+"\\").value);";",
        "      script += "document.getElementById(\\"loginButton_0\\").click();";",
        "",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "          org.forgerock.openam.authentication.callbacks.PollingWaitCallback,",
        "        com.sun.identity.authentication.callbacks.HiddenValueCallback,",
        "        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        "    )",
        "    // discover active theme from UI",
        "    if (callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "            new fr.HiddenValueCallback("theme-id-"+anchor, "false"),",
        "            new fr.ScriptTextOutputCallback(script)",
        "        ).build();",
        "    }",
        "      // get active theme from callback and set new theme",
        "      else if (callbacks.size() === 2) {",
        "        // did we get the id of the currently active theme?",
        "        if (callbacks.get(0).getValue() !== "theme-id-"+anchor) {",
        "              sharedState.put("themeId", callbacks.get(0).getValue());",
        "        }",
        "        // set new theme",
        "        var stage = "themeId="+theme;",
        "        action = fr.Action.send(",
        "              new fr.PollingWaitCallback("0", "Please wait ...")",
        "        ).withStage(stage).build();",
        "    }",
        "      else {",
        "        // continue",
        "        action = fr.Action.goTo(outcome).build();",
        "    }",
        "",
        "     /*",
        "      * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "      * ",
        "      * Example:",
        "      * 'xxxxx' produces '28535'",
        "      * 'xxx-xxx' produces '432-521'",
        "      */",
        "    function generateNumericToken(format) {",
        "        return format.replace(/[x]/g, function(c) {",
        "            var r = Math.random()*10|0;",
        "            var v = r;",
        "            return v.toString(10);",
        "        });",
        "    }",
        "}());",
      ],
    },
    "f26cc0de-ee31-4114-8a32-27799bb49357": {
      "_id": "f26cc0de-ee31-4114-8a32-27799bb49357",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Setup MFA Choice",
      "script": [
        "/*",
        " * Adapt the configuration values below",
        " */",
        "",
        "// do not change, must be a random identifier",
        "var anchor = generateNumericToken('xxx');",
        "",
        "// specify the horizontal alignment of the message: left, center, right",
        "var halign = "center";",
        "",
        "// specify the style to apply to the button in the message to make it look like a link",
        "var linkButtonStyle = "border: 0; color: #109CF1; text-decoration: none; background-color: transparent;";",
        "",
        "// specify the link button HTML element. only modify the text between the <button> and </button> tags.",
        "var linkButton = "<button id=\\"skip-link-".concat(anchor).concat("\\" type=\\"submit\\" style=\\"").concat(linkButtonStyle).concat("\\">skip for now.</button>");",
        "",
        "// specify the message you want to display and place the linkButton anywhere",
        "var message = "Please select your prefered factor or".concat(linkButton);",
        "",
        "// specify the choices you want to offer the user.",
        "var choices = ["SMS","Fido","Push"];",
        "",
        "// specify the default choice. this setting must be a valid 0-based index of the choices array above.",
        "var defaultChoice = 0;",
        "",
        "/*",
        " * All the configuration values are above this comment.",
        " *",
        " * DO NOT MAKE ANY CHANGES BELOW!",
        " */",
        "",
        "// find the TextOutputCallback with the message_anchor",
        "// and replace the message_anchor with the message",
        "var displayMessageScript = "".concat(",
        "  "Array.prototype.slice.call(\\n").concat(",
        "  "  document.getElementsByClassName('callback-component')\\n").concat(",
        "  ").forEach(\\n").concat(",
        "  "  function (e) {\\n").concat(",
        "  "    var message = e.firstElementChild;\\n").concat(",
        "  "    if (message.firstChild && message.firstChild.nodeName == '#text' && message.firstChild.nodeValue.trim() == 'message-").concat(anchor).concat("') {\\n").concat(",
        "  "      message.align = \\"").concat(halign).concat("\\";\\n").concat(",
        "  "      message.innerHTML = '").concat(message).concat("';\\n").concat(",
        "  "    }\\n").concat(",
        "  "  }\\n").concat(",
        "  ")")",
        "",
        "// hijack the link button in the message and:",
        "// - find the HiddenValueCallback and set its value to "Skip"",
        "// - then simulate a login button click",
        "var skipOptionScript = "".concat(",
        "  "document.getElementById(\\"skip-link-").concat(anchor).concat("\\").onclick = function(){\\n").concat(",
        "  "  document.getElementById(\\"skip-input-").concat(anchor).concat("\\").value = \\"Skip\\";\\n").concat(",
        "  "  document.getElementById(\\"loginButton_0\\").click();\\n").concat(",
        "  "  return false;\\n").concat(",
        "  "}")",
        "",
        "var fr = JavaImporter(",
        "    org.forgerock.openam.auth.node.api.Action,",
        "    javax.security.auth.callback.ConfirmationCallback,",
        "    javax.security.auth.callback.TextOutputCallback,",
        "    com.sun.identity.authentication.callbacks.HiddenValueCallback,",
        "    com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        ")",
        "",
        "if (callbacks.isEmpty()) {",
        "    action = fr.Action.send(",
        "        new fr.TextOutputCallback(",
        "            fr.TextOutputCallback.INFORMATION,",
        "            "message-".concat(anchor)",
        "        ),",
        "        new fr.ConfirmationCallback(",
        "            fr.ConfirmationCallback.INFORMATION,",
        "            choices,",
        "            defaultChoice",
        "        ),",
        "        new fr.HiddenValueCallback("skip-input-".concat(anchor), "false"),",
        "        new fr.ScriptTextOutputCallback(displayMessageScript),",
        "        new fr.ScriptTextOutputCallback(skipOptionScript)",
        "    ).build()",
        "}",
        "else {",
        "  // did the user skip?",
        "  if (callbacks.get(2).getValue() == "Skip") {",
        "    action = fr.Action.goTo("Skip").build();",
        "  }",
        "  // user didn't skip, pick the right outcome",
        "  else {",
        "    action = fr.Action.goTo(choices[callbacks.get(1).getSelectedIndex()]).build();",
        "  }",
        "}",
        "",
        " /*",
        "  * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "  * ",
        "  * Example:",
        "  * 'xxxxx' produces '28535'",
        "  * 'xxx-xxx' produces '432-521'",
        "  */",
        "function generateNumericToken(format) {",
        "    return format.replace(/[x]/g, function(c) {",
        "        var r = Math.random()*10|0;",
        "        var v = r;",
        "        return v.toString(10);",
        "    });",
        "}",
      ],
    },
    "fbc563cb-eced-4e1b-9cd4-022680347668": {
      "_id": "fbc563cb-eced-4e1b-9cd4-022680347668",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "FRAAS-7955 Show Object Values",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "FRAAS-7955 Show Object Values",
      "script": [
        "var outcome = true;",
        "",
        "// Requires Identify Existing User auth node to retrieve real user ID from IDM",
        "var userid = sharedState.get("_id");",
        "",
        "// Retrieve user profile attributes",
        "var userName = idRepository.getAttribute(userid, "uid").iterator().next().toString();",
        "var firstName = idRepository.getAttribute(userid, "givenName").iterator().next().toString();",
        "var lastName = idRepository.getAttribute(userid, "sn").iterator().next().toString();",
        "var email = idRepository.getAttribute(userid, "mail").iterator().next().toString();",
        "",
        "var anchor = "anchor-".concat(generateNumericToken('xxx'));",
        "var halign = "left";",
        "var message = "<h4>Object Values</h4>".concat(",
        "    "<p><b>Username</b>: ").concat(userName).concat("</p>").concat(",
        "    "<p><b>First Name</b>: ").concat(firstName).concat("</p>").concat(",
        "    "<p><b>Last Name</b>: ").concat(lastName).concat("</p>").concat(",
        "    "<p><b>Email</b>: ").concat(email).concat("</p>")",
        "var script = "Array.prototype.slice.call(\\n".concat(",
        "  "document.getElementsByClassName('callback-component')).forEach(\\n").concat(",
        "  "function (e) {\\n").concat(",
        "  "  var message = e.firstElementChild;\\n").concat(",
        "  "  if (message.firstChild && message.firstChild.nodeName == '#text' && message.firstChild.nodeValue.trim() == '").concat(anchor).concat("') {\\n").concat(",
        "  "    message.className = \\"text-left\\";\\n").concat(",
        "  "    message.align = \\"").concat(halign).concat("\\";\\n").concat(",
        "  "    message.innerHTML = '").concat(message).concat("';\\n").concat(",
        "  "  }\\n").concat(",
        "  "})")",
        "var fr = JavaImporter(",
        "    org.forgerock.openam.auth.node.api.Action,",
        "    javax.security.auth.callback.TextOutputCallback,",
        "    com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        ")",
        "if (message.length && callbacks.isEmpty()) {",
        "    action = fr.Action.send(",
        "        new fr.TextOutputCallback(",
        "            fr.TextOutputCallback.INFORMATION,",
        "            anchor",
        "        ),",
        "        new fr.ScriptTextOutputCallback(script)",
        "    ).build()",
        "}",
        "else {",
        "  action = fr.Action.goTo(outcome).build();",
        "}",
        "",
        " /*",
        "  * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "  * ",
        "  * Example:",
        "  * 'xxxxx' produces '28535'",
        "  * 'xxx-xxx' produces '432-521'",
        "  */",
        "function generateNumericToken(format) {",
        "    return format.replace(/[x]/g, function(c) {",
        "        var r = Math.random()*10|0;",
        "        var v = r;",
        "        return v.toString(10);",
        "    });",
        "}",
      ],
    },
    "fd536b1f-6ee4-4505-b148-71160414ddcc": {
      "_id": "fd536b1f-6ee4-4505-b148-71160414ddcc",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_AttributeCollectionWorkaroundCleanup",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        "This is the second part of a workaround began in Admin_AttributeCollectionWorkaround.",
        "*/",
        "",
        "var objAttrs = sharedState.get('objectAttributes') || new HashMap();",
        "",
        "if (objAttrs.containsKey('groups')) {",
        "  var groups = objAttrs.get('groups');",
        "  if (groups.length == 1 && groups[0] == 'fake') {",
        "    objAttrs.remove('groups');",
        "  }",
        "}",
        "",
        "if (objAttrs.containsKey('inviteDate') && objAttrs.get('inviteDate') == 'fake') {",
        "   objAttrs.remove('inviteDate');",
        "}",
        "",
        "sharedState.put('objectAttributes', objAttrs);",
        "",
        "outcome = 'True';",
      ],
    },
    "fd560219-00ad-4763-9a29-f65aa9ecf776": {
      "_id": "fd560219-00ad-4763-9a29-f65aa9ecf776",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_GetIdPGroupsClaimConfig",
      "script": [
        "/*",
        " * Copyright 2023 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "/*",
        " * This script is used to retrieve optional custom IdP configuration from IDM as an admin",
        " * completes a login journey. This needs to happen after an IdP has been selected so that",
        " * the \`selectedIdp\` exists in shared state. The result will be stored in a shared state",
        " * key of \`idpCustomConfig\`. The value will be \`null\` if no config was found in IDM.",
        " */",
        "",
        "var AM_INTERNAL_URL = 'http://am.fr-platform:80/am';",
        "var IDM_INTERNAL_URL = 'http://idm.fr-platform:80/openidm';",
        "var RSFILTER_PROVISIONING_CLIENT_ID = 'idm-provisioning';",
        "var RSFILTER_PROVISIONING_SECRET = 'DKNK5K2m5Q98tBTt0yei';",
        "",
        "var SHARED_STATE_KEY = 'idpCustomConfig';",
        "var TXN_ID_HEADER = 'x-forgerock-transactionid';",
        "",
        "// Helper for returning the request transaction ID",
        "function getTransId() {",
        "  var transIds = requestHeaders.get(TXN_ID_HEADER);",
        "  if (transIds) {",
        "    return java.lang.String(transIds.get(0));",
        "  }",
        "  return null;",
        "}",
        "",
        "// Retrieves an access token using a client credentials grant",
        "function getAccessToken(txnId, clientId, clientSecret, scope) {",
        "  var fr = JavaImporter(",
        "    java.lang.String,",
        "    org.forgerock.http.protocol.Request,",
        "    org.forgerock.http.protocol.Response,",
        "    org.forgerock.util.encode.Base64",
        "  );",
        "",
        "  var basicAuthCreds = fr.Base64.encode(new fr.String(clientId + ':' + clientSecret).getBytes('UTF-8'));",
        "",
        "  var request = new fr.Request();",
        "  request.getHeaders().add('authorization', 'Basic ' + basicAuthCreds);",
        "  request.getHeaders().add('content-type', 'application/x-www-form-urlencoded');",
        "  if (txnId) {",
        "    request.getHeaders().add(TXN_ID_HEADER, txnId);",
        "  }",
        "  request",
        "    .setEntity('grant_type=client_credentials&scope=' + scope)",
        "    .setMethod('POST')",
        "    .setUri(AM_INTERNAL_URL + '/oauth2/access_token');",
        "",
        "  var response = httpClient.send(request).getOrThrow();",
        "  if (response.getStatus() === org.forgerock.http.protocol.Status.OK) {",
        "    var result = JSON.parse(response.getEntity().getString());",
        "    logger.message('got access token for client {}', clientId);",
        "    return result.access_token;",
        "  }",
        "  ",
        "  logger.error('failed to get access token for client {}; received status {}', clientId, response.getStatus());",
        "  throw 'failed to get access token';",
        "}",
        "",
        "// Retrieves the IdP custom configuration from IDM",
        "function getConfigFromIDM(txnId, accessToken, idp) {",
        "  var fr = JavaImporter(",
        "    org.forgerock.http.protocol.Request,",
        "    org.forgerock.http.protocol.Response,",
        "    org.forgerock.json.JsonValue,",
        "    org.forgerock.openam.placeholder.substitution.PlaceholderSubstitution,",
        "    org.forgerock.guice.core.InjectorHolder",
        "  );",
        "",
        "  var request = new fr.Request();",
        "  request.getHeaders().add('authorization', 'Bearer ' + accessToken);",
        "  if (txnId) {",
        "    request.getHeaders().add(TXN_ID_HEADER, txnId);",
        "  }",
        "  request",
        "    .setMethod('GET')",
        "    .setUri(IDM_INTERNAL_URL + '/config/fidc/federation-' + idp);",
        "",
        "  var response = httpClient.send(request).getOrThrow();",
        "  if (response.getStatus() === org.forgerock.http.protocol.Status.OK) {",
        "    var rawConfig = JSON.parse(response.getEntity().getString());",
        "    var placeholder = fr.InjectorHolder.getInstance(fr.PlaceholderSubstitution);",
        "    var finalConfig = JSON.parse(placeholder.substitute(fr.JsonValue.json(rawConfig)));",
        "    return finalConfig;",
        "  } else if (response.getStatus() === org.forgerock.http.protocol.Status.NOT_FOUND) {",
        "    return null;",
        "  }",
        "  ",
        "  logger.error('failed to get groups claim config for IdP {}; received status {}', idp, response.getStatus());",
        "  throw 'failed to get groups claim config';",
        "}",
        "",
        "(function () {",
        "  try {",
        "    var idp = nodeState.get('selectedIdp');",
        "    if (!idp.isString()) {",
        "      throw 'selectedIdp not found in shared state';",
        "    }",
        "",
        "    var txnId = getTransId();",
        "    var accessToken = getAccessToken(txnId, RSFILTER_PROVISIONING_CLIENT_ID, RSFILTER_PROVISIONING_SECRET, 'fr:idm:*');",
        "",
        "    var config = getConfigFromIDM(txnId, accessToken, idp.asString())",
        "    if (config) {",
        "      nodeState.putShared(SHARED_STATE_KEY, config);",
        "      logger.message('found groups claim config for IdP {}', idp.asString());",
        "    } else {",
        "      logger.message('no groups claim config found for IdP {}', idp.asString());",
        "    }",
        " ",
        "    outcome = 'Success';",
        "  } catch (e) {",
        "    logger.error('failed to get federation config from IDM: {}', e);",
        "    outcome = 'Error';",
        "  }",
        "}());",
      ],
    },
    "fe35a8fb-31b1-441c-bb9b-27932565061c": {
      "_id": "fe35a8fb-31b1-441c-bb9b-27932565061c",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Admin_MfaGetApp",
      "script": [
        "/*",
        "This creates the following callbacks:",
        "- TextOutputCallback: Display the step title and description",
        "- ConfirmationCallback: Display the "Next" button",
        "- HiddenValueCallback: Captures the "Get app" option, if selected",
        "- ScriptTextOutputCallback: Creates a "Download the app" link button and positions it below the "Next" button",
        "*/",
        "",
        "var token = generateNumericToken('xxx');",
        "var loadingMessage = 'Loading...';",
        "var linkButton = "<button id='getapp-link-".concat(token).concat("' class='btn btn-block btn-link' type='submit'>Download the app</button>");",
        "var message = "<h2 class='h2'>Set up the ForgeRock Authenticator</h2><div style='margin-bottom:1em'>To get started, you need to register your device using the ForgeRock Authenticator app.</div>";",
        "var choices = ['Next'];",
        "var defaultChoice = 0;",
        "var getAppValue = 'Get app';",
        "var getAppInputId = 'getapp-input-'.concat(token);",
        "",
        "var setupPageScript =",
        "  'var setupPage = function() {'.concat(",
        "  '  var getAppInputElem = document.getElementById("').concat(getAppInputId).concat('");').concat(",
        "  '  var messageElem;').concat(",
        "  '  document.getElementsByClassName("callback-component").forEach(').concat(",
        "  '    function (e) {').concat(",
        "  '      var m = e.firstElementChild;').concat(",
        "  '      if (m.firstChild && m.firstChild.nodeName == "#text" && m.firstChild.nodeValue.trim() == "').concat(loadingMessage).concat('") {').concat(",
        "  '        messageElem = m;').concat(",
        "  '      }').concat(",
        "  '    }').concat(",
        "  '  );').concat(",
        "  '  if (!getAppInputElem || !messageElem) {').concat(",
        "  '    return setTimeout(setupPage, 50);').concat(",
        "  '  }').concat(",
        "  '  var skipContainer = document.createElement("div");').concat(",
        "  '  skipContainer.style = "width:100%";').concat(",
        "  '  skipContainer.innerHTML = "').concat(linkButton).concat('";').concat(",
        "  '  getAppInputElem.parentNode.append(skipContainer);').concat(",
        "  '  messageElem.align = "center";').concat(",
        "  '  messageElem.innerHTML = "').concat(message).concat('";').concat(",
        "  '  var bindGetAppLink = function() {').concat(",
        "  '    document.getElementById("getapp-link-').concat(token).concat('").onclick = function() {').concat(",
        "  '      getAppInputElem.value = "').concat(getAppValue).concat('";').concat(",
        "  '      document.getElementById("loginButton_0").click();').concat(",
        "  '      return false;').concat(",
        "  '    };').concat(",
        "  '  };').concat(",
        "  '  setTimeout(bindGetAppLink, 100);').concat(",
        "  '};').concat(",
        "  'setupPage();');",
        "",
        "var fr = JavaImporter(",
        "  org.forgerock.openam.auth.node.api.Action,",
        "  javax.security.auth.callback.ConfirmationCallback,",
        "  javax.security.auth.callback.TextOutputCallback,",
        "  com.sun.identity.authentication.callbacks.HiddenValueCallback,",
        "  com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        ")",
        "",
        "with (fr) {",
        "  if (callbacks.isEmpty()) {",
        "    action = Action.send(",
        "      new TextOutputCallback(",
        "          TextOutputCallback.INFORMATION,",
        "          loadingMessage",
        "      ),",
        "      new ConfirmationCallback(",
        "          ConfirmationCallback.INFORMATION,",
        "          choices,",
        "          defaultChoice",
        "      ),",
        "      new HiddenValueCallback(getAppInputId, 'false'),",
        "      new ScriptTextOutputCallback(setupPageScript)",
        "    ).build()",
        "  } else {",
        "    if (callbacks.get(2).getValue() == getAppValue) {",
        "      action = Action.goTo(getAppValue).build();",
        "    } else {",
        "      action = Action.goTo(choices[callbacks.get(1).getSelectedIndex()]).build();",
        "    }",
        "  }",
        "}",
        "",
        " /*",
        "  * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "  * ",
        "  * Example:",
        "  * 'xxxxx' produces '28535'",
        "  * 'xxx-xxx' produces '432-521'",
        "  */",
        "function generateNumericToken(format) {",
        "  return format.replace(/[x]/g, function(c) {",
        "    var r = Math.random()*10|0;",
        "    var v = r;",
        "    return v.toString(10);",
        "  });",
        "}",
      ],
    },
    "fe5e303b-9ed7-4853-84fe-0ae43e2254d5": {
      "_id": "fe5e303b-9ed7-4853-84fe-0ae43e2254d5",
      "context": "AUTHENTICATION_TREE_DECISION_NODE",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "Display the username in an HTML dialog.",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Display Username",
      "script": [
        "/* Display Username",
        " *",
        " * Author: volker.scheuber@forgerock.com",
        " * ",
        " * Display the username.",
        " * ",
        " * This script does not need to be parametrized. It will work properly as is.",
        " * ",
        " * The Scripted Decision Node needs the following outcomes defined:",
        " * - true",
        " */",
        "(function () {",
        "  try {",
        "    var outcome = 'true';",
        "    var username = nodeState.get('username').asString();",
        "",
        "    // Specify the message you want to display. You may use HTML for formatting. Avoid line breaks! Use <br> instead.",
        "    var message = '<h5>'+username+'</h5>';",
        "",
        "    var anchor = 'anchor-'+generateNumericToken('xxx');",
        "    var script = "Array.prototype.slice.call(\\n \\",
        "      document.getElementsByClassName('callback-component')).forEach(\\n \\",
        "      function (e) {\\n \\",
        "        var message = e.firstElementChild;\\n \\",
        "        if (message.firstChild && message.firstChild.nodeName == '#text' && message.firstChild.nodeValue.trim() == '"+anchor+"') {\\n \\",
        "          message.innerHTML = '"+message+"';\\n \\",
        "        }\\n \\",
        "      })";",
        "    var fr = JavaImporter(",
        "        org.forgerock.openam.auth.node.api.Action,",
        "        javax.security.auth.callback.TextOutputCallback,",
        "        com.sun.identity.authentication.callbacks.ScriptTextOutputCallback",
        "    )",
        "    if (message.length && callbacks.isEmpty()) {",
        "        action = fr.Action.send(",
        "            new fr.TextOutputCallback(",
        "                fr.TextOutputCallback.INFORMATION,",
        "                anchor",
        "            ),",
        "            new fr.ScriptTextOutputCallback(script)",
        "        ).build()",
        "    }",
        "    else {",
        "      action = fr.Action.goTo(outcome).build();",
        "    }",
        "  } catch (error) {",
        "    logger.error('Error: ' + error);",
        "    nodeState.putShared('error', error.message);",
        "  }",
        "",
        "   /*",
        "    * Generate a token in the desired format. All 'x' characters will be replaced with a random number 0-9.",
        "    * ",
        "    * Example:",
        "    * 'xxxxx' produces '28535'",
        "    * 'xxx-xxx' produces '432-521'",
        "    */",
        "  function generateNumericToken(format) {",
        "      return format.replace(/[x]/g, function(c) {",
        "          var r = Math.random()*10|0;",
        "          var v = r;",
        "          return v.toString(10);",
        "      });",
        "  }",
        "}());",
      ],
    },
    "fff76556-2882-4109-a9a6-c42d546cfe57": {
      "_id": "fff76556-2882-4109-a9a6-c42d546cfe57",
      "context": "OAUTH2_SCRIPTED_JWT_ISSUER",
      "createdBy": "null",
      "creationDate": 0,
      "default": false,
      "description": "null",
      "language": "JAVASCRIPT",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "Service Account - JWT Issuers",
      "script": [
        "(function () {",
        "  var frJava = JavaImporter(",
        "    org.forgerock.oauth2.core.TrustedJwtIssuerConfig,",
        "    java.util.HashSet",
        "  );",
        "",
        "  with (frJava) {",
        "    var iss = idRepository.getIdentity(issuer);",
        "    if (iss == null) {",
        "      logger.message('No issuer found for: ' + issuer);",
        "      return null;",
        "    }",
        "    logger.message('Found issuer: ' + iss);",
        "",
        "    var accountStatus = iss.getAttributeValues('inetUserStatus');",
        "    if (!accountStatus || accountStatus.length === 0) {",
        "      logger.message('No inetUserStatus attribute in issuer');",
        "      return null;",
        "    } else if (accountStatus[0].toLowerCase() != 'active') {",
        "      logger.message('Issuer is not active');",
        "      return null;",
        "    }",
        "",
        "    var jwksAttrs = iss.getAttributeValues('fr-attr-jwks');",
        "    if (!jwksAttrs || jwksAttrs.length === 0) {",
        "      logger.message('No jwks attributes in issuer');",
        "      return null;",
        "    }",
        "",
        "    var jwkSet = jwksAttrs[0];",
        "    if (!jwkSet) {",
        "      logger.message('No jwk set in issuer');",
        "      return null;",
        "    }",
        "",
        "    var config = new TrustedJwtIssuerConfig(",
        "      issuer,",
        "      'sub',",
        "      'scope',",
        "      new HashSet([issuer]),",
        "      jwkSet,",
        "      null, null, null",
        "    );",
        "",
        "    return config;",
        "  }",
        "}());",
      ],
    },
  },
}
`;

exports[`frodo script export "frodo script export -n 'GitHub Profile Normalization' -f my-GitHub-Profile-Normalization.script.json": should export the script named "GitHub Profile Normalization" into file named my-GitHub-Profile-Normalization.script.json 1`] = `""`;

exports[`frodo script export "frodo script export -n 'GitHub Profile Normalization' -f my-GitHub-Profile-Normalization.script.json": should export the script named "GitHub Profile Normalization" into file named my-GitHub-Profile-Normalization.script.json: ./my-GitHub-Profile-Normalization.script.json 1`] = `
{
  "meta": Any<Object>,
  "script": {
    "a7a78773-445b-4eca-bb93-409e86bced81": {
      "_id": "a7a78773-445b-4eca-bb93-409e86bced81",
      "context": "SOCIAL_IDP_PROFILE_TRANSFORMATION",
      "createdBy": "null",
      "creationDate": 0,
      "default": true,
      "description": "Normalizes raw profile data from GitHub",
      "language": "GROOVY",
      "lastModifiedBy": "null",
      "lastModifiedDate": 0,
      "name": "GitHub Profile Normalization",
      "script": [
        "/*",
        " * Copyright 2022 ForgeRock AS. All Rights Reserved",
        " *",
        " * Use of this code requires a commercial software license with ForgeRock AS.",
        " * or with one of its affiliates. All use shall be exclusively subject",
        " * to such license between the licensee and ForgeRock AS.",
        " */",
        "",
        "import static org.forgerock.json.JsonValue.field",
        "import static org.forgerock.json.JsonValue.json",
        "import static org.forgerock.json.JsonValue.object",
        "",
        "return json(object(",
        "        field("id", rawProfile.id),",
        "        field("displayName", rawProfile.name),",
        "        field("username", rawProfile.login)))",
      ],
    },
  },
}
`;
